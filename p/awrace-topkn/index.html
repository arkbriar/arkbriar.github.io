<!DOCTYPE html>
<html lang="zh-cn">
    <head><meta charset='utf-8'>
<meta name='viewport' content='width=device-width, initial-scale=1'><meta name='description' content='ä»Šå¹´é˜¿é‡Œä¸­é—´ä»¶æ¯”èµ›çš„æ—¶å€™ä¸å·§åšä¸»å¿ƒæƒ…ä¸å¥½ï¼Œå¤–åŠ è¦å‡†å¤‡æœŸæœ«è€ƒè¯•ï¼Œå¹¶æ²¡æœ‰å‚åŠ ï¼Œéå¸¸é—æ†¾ã€‚ä¸è¿‡å¥½åœ¨å¥½åŸºå‹ Eric Fu å‚åŠ å¹¶è·å¾—äº†å† å†›ï¼ä»Šå¹´çš„ä¸»é¢˜æ˜¯åˆ†å¸ƒå¼æ•°æ®åº“ï¼Œå¦‚æœæƒ³äº†è§£è¯¦æƒ…åŠå¤èµ›çš„è§£é¢˜æ€è·¯è¯·è¯»è€…å‰å¾€ Eric çš„åšå®¢ã€‚
åšä¸»æ²¡æœ‰å‚åŠ ç”šæ˜¯é—æ†¾ï¼Œå¤–åŠ çœ‹åˆ°é¢˜ç›®æ‰‹ç—’éš¾è€ï¼Œé‚é—®åŸºå‹è®¨äº†æœ€åçš„24hæå®¢èµ›æ¥ç©ä¸€ç©ã€‚
24h TOPKN é¢˜ç›®æ˜¯åˆ†å¸ƒå¼æ•°æ®åº“ä¸Šçš„åˆ†é¡µæ’åºï¼Œå¯¹åº”çš„SQLæ‰§è¡Œä¸º order by id limit kï¼Œnï¼›ä¸»è¦çš„æŠ€æœ¯æŒ‘æˆ˜ä¸º&amp;quot;åˆ†å¸ƒå¼&amp;quot;çš„ç­–ç•¥ï¼Œèµ›é¢˜ä¸­ä½¿ç”¨å¤šä¸ªæ–‡ä»¶æ¨¡æ‹Ÿå¤šä¸ªæ•°æ®åˆ†ç‰‡ã€‚
ç®€ç§° top(k, n)ã€‚
'><title>2017 Alibaba Middleware 24h Final (Just for Fun ğŸ˜€)</title>

<link rel='canonical' href='https://blog.crazyark.xyz/p/awrace-topkn/'>

<link rel="stylesheet" href="/scss/style.min.css"><meta property='og:title' content='2017 Alibaba Middleware 24h Final (Just for Fun ğŸ˜€)'>
<meta property='og:description' content='ä»Šå¹´é˜¿é‡Œä¸­é—´ä»¶æ¯”èµ›çš„æ—¶å€™ä¸å·§åšä¸»å¿ƒæƒ…ä¸å¥½ï¼Œå¤–åŠ è¦å‡†å¤‡æœŸæœ«è€ƒè¯•ï¼Œå¹¶æ²¡æœ‰å‚åŠ ï¼Œéå¸¸é—æ†¾ã€‚ä¸è¿‡å¥½åœ¨å¥½åŸºå‹ Eric Fu å‚åŠ å¹¶è·å¾—äº†å† å†›ï¼ä»Šå¹´çš„ä¸»é¢˜æ˜¯åˆ†å¸ƒå¼æ•°æ®åº“ï¼Œå¦‚æœæƒ³äº†è§£è¯¦æƒ…åŠå¤èµ›çš„è§£é¢˜æ€è·¯è¯·è¯»è€…å‰å¾€ Eric çš„åšå®¢ã€‚
åšä¸»æ²¡æœ‰å‚åŠ ç”šæ˜¯é—æ†¾ï¼Œå¤–åŠ çœ‹åˆ°é¢˜ç›®æ‰‹ç—’éš¾è€ï¼Œé‚é—®åŸºå‹è®¨äº†æœ€åçš„24hæå®¢èµ›æ¥ç©ä¸€ç©ã€‚
24h TOPKN é¢˜ç›®æ˜¯åˆ†å¸ƒå¼æ•°æ®åº“ä¸Šçš„åˆ†é¡µæ’åºï¼Œå¯¹åº”çš„SQLæ‰§è¡Œä¸º order by id limit kï¼Œnï¼›ä¸»è¦çš„æŠ€æœ¯æŒ‘æˆ˜ä¸º&amp;quot;åˆ†å¸ƒå¼&amp;quot;çš„ç­–ç•¥ï¼Œèµ›é¢˜ä¸­ä½¿ç”¨å¤šä¸ªæ–‡ä»¶æ¨¡æ‹Ÿå¤šä¸ªæ•°æ®åˆ†ç‰‡ã€‚
ç®€ç§° top(k, n)ã€‚
'>
<meta property='og:url' content='https://blog.crazyark.xyz/p/awrace-topkn/'>
<meta property='og:site_name' content='çŸ³æ²‰æºªæ´ -- Ark&#39;s Blog'>
<meta property='og:type' content='article'><meta property='article:section' content='Post' /><meta property='article:tag' content='java' /><meta property='article:tag' content='distributed system' /><meta property='article:tag' content='parallel computing' /><meta property='article:published_time' content='2017-07-26T16:59:26&#43;08:00'/><meta property='article:modified_time' content='2017-07-26T16:59:26&#43;08:00'/>
<meta name="twitter:site" content="@ImperiusDs">
    <meta name="twitter:creator" content="@ImperiusDs"><meta name="twitter:title" content="2017 Alibaba Middleware 24h Final (Just for Fun ğŸ˜€)">
<meta name="twitter:description" content="ä»Šå¹´é˜¿é‡Œä¸­é—´ä»¶æ¯”èµ›çš„æ—¶å€™ä¸å·§åšä¸»å¿ƒæƒ…ä¸å¥½ï¼Œå¤–åŠ è¦å‡†å¤‡æœŸæœ«è€ƒè¯•ï¼Œå¹¶æ²¡æœ‰å‚åŠ ï¼Œéå¸¸é—æ†¾ã€‚ä¸è¿‡å¥½åœ¨å¥½åŸºå‹ Eric Fu å‚åŠ å¹¶è·å¾—äº†å† å†›ï¼ä»Šå¹´çš„ä¸»é¢˜æ˜¯åˆ†å¸ƒå¼æ•°æ®åº“ï¼Œå¦‚æœæƒ³äº†è§£è¯¦æƒ…åŠå¤èµ›çš„è§£é¢˜æ€è·¯è¯·è¯»è€…å‰å¾€ Eric çš„åšå®¢ã€‚
åšä¸»æ²¡æœ‰å‚åŠ ç”šæ˜¯é—æ†¾ï¼Œå¤–åŠ çœ‹åˆ°é¢˜ç›®æ‰‹ç—’éš¾è€ï¼Œé‚é—®åŸºå‹è®¨äº†æœ€åçš„24hæå®¢èµ›æ¥ç©ä¸€ç©ã€‚
24h TOPKN é¢˜ç›®æ˜¯åˆ†å¸ƒå¼æ•°æ®åº“ä¸Šçš„åˆ†é¡µæ’åºï¼Œå¯¹åº”çš„SQLæ‰§è¡Œä¸º order by id limit kï¼Œnï¼›ä¸»è¦çš„æŠ€æœ¯æŒ‘æˆ˜ä¸º&amp;quot;åˆ†å¸ƒå¼&amp;quot;çš„ç­–ç•¥ï¼Œèµ›é¢˜ä¸­ä½¿ç”¨å¤šä¸ªæ–‡ä»¶æ¨¡æ‹Ÿå¤šä¸ªæ•°æ®åˆ†ç‰‡ã€‚
ç®€ç§° top(k, n)ã€‚
">
    </head>
    <body class="
    article-page has-toc
">
    <script>
        (function() {
            const colorSchemeKey = 'StackColorScheme';
            if(!localStorage.getItem(colorSchemeKey)){
                localStorage.setItem(colorSchemeKey, "auto");
            }
        })();
    </script><script>
    (function() {
        const colorSchemeKey = 'StackColorScheme';
        const colorSchemeItem = localStorage.getItem(colorSchemeKey);
        const supportDarkMode = window.matchMedia('(prefers-color-scheme: dark)').matches === true;

        if (colorSchemeItem == 'dark' || colorSchemeItem === 'auto' && supportDarkMode) {
            

            document.documentElement.dataset.scheme = 'dark';
        } else {
            document.documentElement.dataset.scheme = 'light';
        }
    })();
</script>
<div class="container main-container flex 
    
        extended
    
">
    
        <div id="article-toolbar">
            <a href="https://blog.crazyark.xyz" class="back-home">
                <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-chevron-left" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <polyline points="15 6 9 12 15 18" />
</svg>



                <span>è¿”å›</span>
            </a>
        </div>
    
<main class="main full-width">
    <article class="main-article">
    <header class="article-header">

    <div class="article-details">
    
    <header class="article-category">
        
            <a href="/categories/tianchi/" >
                Tianchi
            </a>
        
            <a href="/categories/contest/" >
                Contest
            </a>
        
    </header>
    

    <h2 class="article-title">
        <a href="/p/awrace-topkn/">2017 Alibaba Middleware 24h Final (Just for Fun ğŸ˜€)</a>
    </h2>

    

    
    <footer class="article-time">
        
            <div>
                <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-calendar-time" width="56" height="56" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <path d="M11.795 21h-6.795a2 2 0 0 1 -2 -2v-12a2 2 0 0 1 2 -2h12a2 2 0 0 1 2 2v4" />
  <circle cx="18" cy="18" r="4" />
  <path d="M15 3v4" />
  <path d="M7 3v4" />
  <path d="M3 11h16" />
  <path d="M18 16.496v1.504l1 1" />
</svg>
                <time class="article-time--published">Jul 26, 2017</time>
            </div>
        

        
            <div>
                <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-clock" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="12" cy="12" r="9" />
  <polyline points="12 7 12 12 15 15" />
</svg>



                <time class="article-time--reading">
                    é˜…è¯»æ—¶é•¿: 8 åˆ†é’Ÿ
                </time>
            </div>
        
    </footer>
    
</div>
</header>

    <section class="article-content">
    <p>ä»Šå¹´é˜¿é‡Œä¸­é—´ä»¶æ¯”èµ›çš„æ—¶å€™ä¸å·§åšä¸»å¿ƒæƒ…ä¸å¥½ï¼Œå¤–åŠ è¦å‡†å¤‡æœŸæœ«è€ƒè¯•ï¼Œå¹¶æ²¡æœ‰å‚åŠ ï¼Œéå¸¸é—æ†¾ã€‚ä¸è¿‡å¥½åœ¨å¥½åŸºå‹ <a class="link" href="https://ericfu.me"  target="_blank" rel="noopener"
    >Eric Fu</a> å‚åŠ å¹¶è·å¾—äº†å† å†›ï¼ä»Šå¹´çš„ä¸»é¢˜æ˜¯åˆ†å¸ƒå¼æ•°æ®åº“ï¼Œå¦‚æœæƒ³äº†è§£è¯¦æƒ…åŠå¤èµ›çš„è§£é¢˜æ€è·¯è¯·è¯»è€…å‰å¾€ Eric çš„åšå®¢ã€‚</p>
<p>åšä¸»æ²¡æœ‰å‚åŠ ç”šæ˜¯é—æ†¾ï¼Œå¤–åŠ çœ‹åˆ°é¢˜ç›®æ‰‹ç—’éš¾è€ï¼Œé‚é—®åŸºå‹è®¨äº†æœ€åçš„24hæå®¢èµ›æ¥ç©ä¸€ç©ã€‚</p>
<h2 id="24h-topkn">24h TOPKN</h2>
<p>é¢˜ç›®æ˜¯åˆ†å¸ƒå¼æ•°æ®åº“ä¸Šçš„åˆ†é¡µæ’åºï¼Œå¯¹åº”çš„SQLæ‰§è¡Œä¸º order by id limit kï¼Œnï¼›ä¸»è¦çš„æŠ€æœ¯æŒ‘æˆ˜ä¸º&quot;åˆ†å¸ƒå¼&quot;çš„ç­–ç•¥ï¼Œèµ›é¢˜ä¸­ä½¿ç”¨å¤šä¸ªæ–‡ä»¶æ¨¡æ‹Ÿå¤šä¸ªæ•°æ®åˆ†ç‰‡ã€‚</p>
<p>ç®€ç§° top(k, n)ã€‚</p>
<blockquote>
<p>ç»™å®šä¸€æ‰¹æ•°æ®ï¼Œæ±‚è§£æŒ‰é¡ºåºä»å°åˆ°å¤§ï¼Œé¡ºåºæ’åä»ç¬¬kä¸‹æ ‡åºå·ä¹‹åè¿ç»­çš„nä¸ªæ•°æ® (ç±»ä¼¼äºæ•°æ®åº“çš„order by asc + limit k,nè¯­ä¹‰)</p>
</blockquote>
<blockquote>
<p>top(k,3)ä»£è¡¨è·å–æ’ååºå·ä¸ºk+1,k+2,k+3çš„å†…å®¹,ä¾‹:top(10,3)ä»£è¡¨åºå·ä¸º11ã€12ã€13çš„å†…å®¹,top(0,3)ä»£è¡¨åºå·ä¸º1ã€2ã€3çš„å†…å®¹
éœ€è¦è€ƒè™‘kå€¼å‡ ç§æƒ…å†µï¼Œkå€¼æ¯”è¾ƒå°æˆ–è€…ç‰¹åˆ«å¤§çš„æƒ…å†µï¼Œæ¯”å¦‚k=1,000,000,000
å¯¹åº”k,nå–å€¼èŒƒå›´ï¼š 0 &lt;= k &lt; 2^63 å’Œ 0 &lt; n &lt; 100
æ•°æ®å…¨éƒ¨æ˜¯æ–‡æœ¬å’Œæ•°å­—ç»“åˆçš„æ•°æ®ï¼Œæ’åºçš„æ—¶å€™æŒ‰ç…§æ•´ä¸ªå­—ç¬¦ä¸²çš„é•¿åº¦æ¥æ’åºã€‚ä¾‹å¦‚ä¸€ä¸ªæœ‰åºçš„æ’åºå¦‚ä¸‹(ç›¸åŒé•¿åº¦æƒ…å†µä¸‹asciiç å°çš„æ’åœ¨å‰é¢)ï¼š
ä¾‹ï¼š a ab abc def abc123</p>
</blockquote>
<blockquote>
<p>ä¾‹å¦‚ç»™å®šçš„k,nä¸º(2,2)ï¼Œåˆ™ä¸Šé¢çš„æ•°æ®éœ€è¦çš„ç­”æ¡ˆä¸º: abc def</p>
</blockquote>
<p>åŸé¢˜ç›®åœ¨ <a class="link" href="https://code.aliyun.com/wanshao/topkn_final"  target="_blank" rel="noopener"
    >https://code.aliyun.com/wanshao/topkn_final</a>ã€‚</p>
<p>è¦æ±‚åœ¨24å°æ—¶å†…å®Œæˆï¼Œç„¶è€Œ &hellip;</p>
<p>Codes æ‰˜ç®¡åœ¨ github ä¸Š <a class="link" href="https://github.com/arkbriar/topKN"  target="_blank" rel="noopener"
    >https://github.com/arkbriar/topKN</a>ï¼Œè¿™ä¸ªç‰ˆæœ¬ä»åŸºå‹çš„ç‰ˆæœ¬è½»åº¦ä¿®æ”¹è€Œæ¥ &hellip;</p>
<h2 id="è§£é¢˜è¿‡ç¨‹">è§£é¢˜è¿‡ç¨‹</h2>
<table>
<thead>
<tr>
<th style="text-align:left"><strong>ä¸»è¦æ¡ä»¶</strong></th>
<th style="text-align:center"></th>
<th style="text-align:left"><strong>ä¸»è¦é™åˆ¶</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">1. 3å°æœºå™¨: 2å°workerï¼Œ1å°master <!-- raw HTML omitted --> 2. è¾“å‡ºåœ¨masterä¸Š</td>
<td style="text-align:center"></td>
<td style="text-align:left">1. Timeout: 5min <!-- raw HTML omitted --> 2. JVM heap size: 3G <!-- raw HTML omitted --> 3. ä¸å…è®¸ä½¿ç”¨å †å¤–å†…å­˜(FileChannel)</td>
</tr>
</tbody>
</table>
<!-- raw HTML omitted -->
<p>å¦‚æœè¦å¯¹160000000æ¡æ•°æ®å…¨æ’åºJVMï¼Œç¬¬ä¸€å†…å­˜å¤ªå°ï¼Œç¬¬äºŒæ—¶é—´ä¸å¤Ÿã€‚å¯¹ 10000000 æ¡æ•°æ®è¿›è¡Œæ’åºå¤§çº¦è€—æ—¶ä¸º 1min13sï¼Œå‚è€ƒè‡ª <a class="link" href="https://codereview.stackexchange.com/questions/67387/quicksort-implementation-seems-too-slow-with-large-data"  target="_blank" rel="noopener"
    >https://codereview.stackexchange.com/questions/67387/quicksort-implementation-seems-too-slow-with-large-data</a>ï¼›å¦‚æœè¦è¿›è¡Œå¤–æ’åºï¼Œç£ç›˜è¯»å†™å¯¼è‡´è€—æ—¶æ›´é•¿ï¼›ä»¥åŠè¿˜æœ‰æœ€åè¦è¾“å‡ºåˆ°masterä¸Šï¼Œè¿˜æœ‰ç½‘ç»œå¼€é”€ã€‚</p>
<p>ç¨å¾®äº†è§£ä¸€äº›æ•°æ®åº“çš„åŒå­¦éƒ½çŸ¥é“ï¼Œæ•°æ®åº“é‡Œæœ‰ä¸ªå«ç´¢å¼•(Index)çš„ä¸œè¥¿ï¼Œæ˜¯ç”¨æ¥åŠ é€ŸæŸ¥è¯¢çš„ã€‚é‚£æˆ‘ä»¬é¦–å…ˆæ¥çœ‹ä¸€ä¸‹ MySQL çš„ç´¢å¼•ã€‚</p>
<h3 id="mysql-çš„ç´¢å¼•">MySQL çš„ç´¢å¼•</h3>
<p>ç´¢å¼•å¯¹æŸ¥è¯¢çš„é€Ÿåº¦æœ‰è‡³å…³é‡è¦çš„å½±å“ï¼Œç†è§£ç´¢å¼•ä¹Ÿæ˜¯è¿›è¡Œæ•°æ®åº“æ€§èƒ½è°ƒä¼˜çš„èµ·ç‚¹ã€‚å‡è®¾æ•°æ®åº“ä¸­ä¸€ä¸ªè¡¨æœ‰100000æ¡è®°å½•ï¼ŒDBMSçš„é¡µé¢å¤§å°ä¸º4Kï¼Œå¹¶å­˜å‚¨100æ¡è®°å½•ã€‚å¦‚æœæ²¡æœ‰ç´¢å¼•ï¼ŒæŸ¥è¯¢å°†å¯¹æ•´ä¸ªè¡¨è¿›è¡Œæ‰«æï¼Œæœ€åçš„æƒ…å†µä¸‹ï¼Œå¦‚æœæ‰€æœ‰æ•°æ®é¡µéƒ½ä¸åœ¨å†…å­˜ï¼Œéœ€è¦è¯»å–10000ä¸ªé¡µé¢ï¼Œå¦‚æœè¿™10000ä¸ªé¡µé¢åœ¨ç£ç›˜ä¸Šéšæœºåˆ†å¸ƒï¼Œéœ€è¦è¿›è¡Œ10000æ¬¡I/Oï¼Œå‡è®¾ç£ç›˜æ¯æ¬¡I/Oæ—¶é—´ä¸º10msï¼Œåˆ™æ€»å…±éœ€è¦100s(å®é™…è¿œä¸æ­¢)ã€‚ä½†æ˜¯å¦‚æœå»ºç«‹ B+ æ ‘ç´¢å¼•ï¼Œåˆ™åªéœ€è¦è¿›è¡Œ $log_{100}1000000 = 3$ æ¬¡é¡µé¢è¯»å–ï¼Œæœ€åæƒ…å†µä¸‹è€—æ—¶30msï¼Œè¿™å°±æ˜¯ç´¢å¼•å¸¦æ¥çš„æ•ˆæœã€‚</p>
<p>MySQL æœ‰ä¸¤ç§ç´¢å¼•çš„ç±»å‹ï¼šB+æ ‘å’ŒHashç´¢å¼•ã€‚</p>
<p>å‚è€ƒè‡ª <a class="link" href="http://www.cnblogs.com/hustcat/archive/2009/10/28/1591648.html"  target="_blank" rel="noopener"
    >http://www.cnblogs.com/hustcat/archive/2009/10/28/1591648.html</a></p>
<h3 id="bb-æ ‘">B/B+ æ ‘</h3>
<p>æˆ‘ä»¬éƒ½çŸ¥é“RB-Treeå’ŒAVL-Treeæ˜¯éƒ½æ˜¯è‡ªå¹³è¡¡çš„äºŒå‰æŸ¥æ‰¾æ ‘ï¼Œåœ¨è¿™æ ·çš„æ ‘ä¸Šè¿›è¡Œæ’å…¥ï¼Œåˆ é™¤å’ŒæŸ¥è¯¢æ“ä½œæœ€åæƒ…å†µéƒ½èƒ½åœ¨ $O(log_{2}n)$ çš„æ—¶é—´å†…å®Œæˆã€‚</p>
<p>Bæ ‘æ˜¯1972å¹´ç”± Rudolf Bayer å’Œ Edward M.McCreight æå‡ºçš„ï¼Œå®ƒæ˜¯ä¸€ç§æ³›åŒ–çš„è‡ªå¹³è¡¡æ ‘ï¼Œæ¯ä¸ªèŠ‚ç‚¹å¯ä»¥æœ‰å¤šäºä¸¤ä¸ªçš„å­èŠ‚ç‚¹ã€‚ä¸è‡ªå¹³è¡¡äºŒå‰æŸ¥æ‰¾æ ‘ä¸åŒçš„æ˜¯ï¼ŒBæ ‘ä¸ºç³»ç»Ÿå¤§å—æ•°æ®çš„è¯»å†™æ“ä½œåšäº†ä¼˜åŒ–ã€‚Bæ ‘å‡å°‘å®šä½è®°å½•æ—¶æ‰€ç»å†çš„ä¸­é—´è¿‡ç¨‹ï¼Œä»è€ŒåŠ å¿«å­˜å–é€Ÿåº¦ã€‚æ‰€ä»¥Bæ ‘å¸¸è¢«åº”ç”¨äºæ•°æ®åº“å’Œæ–‡ä»¶ç³»ç»Ÿçš„å®ç°ã€‚</p>
<p>å‡è®¾Bæ ‘æ¯ä¸ªèŠ‚ç‚¹ä¸‹æœ‰bä¸ªå­èŠ‚ç‚¹(bä¸ªåˆ†å—)ï¼Œé‚£ä¹ˆæŸ¥æ‰¾å¯ä»¥åœ¨çº¦ä¸ºlogbNçš„ç£ç›˜è¯»å–å¼€é”€ä¸‹å®Œæˆã€‚</p>
<p>å…³äº B/B+ æ ‘çš„å…¶ä»–ç‰¹å¾åœ¨ç»´åŸºå’Œå…¶ä»–èµ„æ–™ä¸Šæœ‰è¯¦ç»†è®²è§£ï¼Œåœ¨æ­¤ä¸å†èµ˜è¿°ã€‚</p>
<p>ç”±äºæ—¶é—´é™å®šçš„ç¼˜æ•…ï¼Œå®ç° B/B+ æ ‘çš„ç´¢å¼•æ˜¾å¾—ä¸å¤ªç°å®ï¼Œæ‰€ä»¥æˆ‘ä»¬å°†è€ƒè™‘ä¸€ç§é€€åŒ–çš„æ–¹å¼ â€”â€” æ¡¶æ’åºã€‚</p>
<p>å‚è€ƒè‡ª</p>
<ol>
<li><a class="link" href="https://zh.wikipedia.org/wiki/B%E6%A0%91"  target="_blank" rel="noopener"
    >https://zh.wikipedia.org/wiki/B%E6%A0%91</a></li>
<li><a class="link" href="https://zh.wikipedia.org/wiki/B%2B%E6%A0%91"  target="_blank" rel="noopener"
    >https://zh.wikipedia.org/wiki/B%2B%E6%A0%91</a></li>
</ol>
<h3 id="æ¡¶æ’åº">æ¡¶æ’åº</h3>
<p>å…ˆæ¥çœ‹ä¸€ä¸‹æ•°æ®çš„åˆ†å¸ƒæƒ…å†µï¼š</p>
<blockquote>
<p>æ¯ä¸€è¡Œå­—ç¬¦ä¸²çš„é•¿åº¦ä¸º [1,128] ï¼ˆæ•°å­—åœ¨Longå€¼èŒƒå›´å†…å‡åŒ€åˆ†å¸ƒï¼‰</p>
</blockquote>
<p>æ˜¾ç„¶ä»¥å­—ç¬¦ä¸²é•¿æ¥æ ‡è¯†æ¡¶æ˜¯å¯è¡Œçš„ï¼Œä½†æ˜¯æˆ‘ä»¬æœ‰160000000æ¡å­—ç¬¦ä¸²ï¼Œ128ä¸ªæ¡¶æ¯ä¸ªæ¡¶è¿˜æ˜¯æœ‰1250000æ¡ï¼Œè¿™æ ·çš„æ¡¶ç²’åº¦è¿˜æ˜¯å¤ªç²—ã€‚</p>
<p>ç”±äºæˆ‘ä»¬æ‰‹é‡Œæ²¡æœ‰å…¶ä»–åˆ†å¸ƒæƒ…å†µï¼Œä»¥åŠå­—ç¬¦ä¸²å¤§å°åœ¨åŒé•¿åº¦ä¸‹æ˜¯å­—å…¸åºï¼Œæ‰€ä»¥ä»¥å­—ç¬¦ä¸²é•¿åº¦+å‰2-3ä¸ªå­—ç¬¦ä½œä¸ºæ¡¶çš„æ ‡è¯†å°±å¯ä»¥äº†ã€‚</p>
<p>åœ¨æœ¬é¢˜ä¸­ï¼Œç”±äºåªè¿›è¡Œ5è½®queryï¼Œå¹¶ä¸”å†™å¼€é”€éå¸¸å¤§ï¼Œæ•…ä»…å¯¹æ¡¶å†…å­—ç¬¦ä¸²çš„æ•°ç›®è¿›è¡Œç»Ÿè®¡ã€‚</p>
<h3 id="åŸºæœ¬æ€è·¯">åŸºæœ¬æ€è·¯</h3>
<ol>
<li>Worker åˆ†åˆ«æ‰«æå¹¶å»ºç«‹æ‰€æœ‰æ¡¶çš„è®¡æ•°</li>
<li>Master æ±‡æ€»æ‰€æœ‰æ¡¶ï¼Œå¹¶å»ºç«‹å…¨å±€æ¡¶</li>
<li>Master é€šè¿‡äºŒåˆ†æŸ¥æ‰¾ï¼Œæ‰¾åˆ°(k, n)æ‰€åœ¨çš„å‡ ä¸ªæ¡¶</li>
<li>Master å‘ Worker è¯·æ±‚è·å¾—è¿™äº›æ¡¶å†…çš„æ‰€æœ‰å­—ç¬¦ä¸²</li>
<li>Master å¯¹è¿™äº›å­—ç¬¦ä¸²è¿›è¡Œæ’åºï¼Œå¹¶è¾“å‡ºæœ€ç»ˆç»“æœ</li>
</ol>
<h2 id="å®ç°è¿‡ç¨‹">å®ç°è¿‡ç¨‹</h2>
<p>æœ¬é¢˜å®ç°çš„æœ€å¤§éš¾ç‚¹åœ¨äº I/O å’Œ GC è°ƒä¼˜ï¼Œè¿˜æœ‰å……åˆ†è°ƒåŠ¨ CPUã€‚</p>
<ol>
<li>GC è°ƒä¼˜æˆ‘ä»¬é€šè¿‡ä½¿ç”¨å›ºå®šçš„ buffer æ¥è¿›è¡Œæ“ä½œï¼ŒåŸºæœ¬é¿å…å‡ºç° GCã€‚</li>
<li>é€šè¿‡å¤šçº¿ç¨‹å¤„ç†æ¥ä¿è¯ CPU è°ƒåŠ¨ã€‚</li>
<li>ç½‘ç»œå¼€é”€åœ¨ä¸Šè¿°ç®—æ³•ä¸‹åŸºæœ¬å¿½ç•¥äº†</li>
</ol>
<p>ç„¶è€Œï¼Œå‰©ä¸‹çš„ I/O è°ƒä¼˜è®©äººéå¸¸å¤´å¤§ï¼Œå¹¶ä¼´éšç€å¯èƒ½å­˜åœ¨çš„åŒæ­¥é—®é¢˜ (è¯»å’Œå¤„ç†)</p>
<p>æˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹ç¡¬ä»¶æ¡ä»¶ï¼š</p>
<ol>
<li>CPU: 24 core, 2.2GHz</li>
<li>å†…å­˜: 3G heap memory</li>
<li>æ•°æ®ç£ç›˜ï¼šå†…å­˜æ–‡ä»¶ç³»ç»Ÿ</li>
<li>ä¸´æ—¶ã€ç»“æœç£ç›˜ï¼šSSD</li>
</ol>
<h3 id="top-1-çš„æœ€ç»ˆç»“æœ">Top 1 çš„æœ€ç»ˆç»“æœ</h3>
<p>ä»åŸºå‹é‚£å¾—çŸ¥ï¼Œtop 1 çš„å®ç°5è½®æ€»è€—æ—¶(JVMå¯åŠ¨ã€æš‚åœï¼Œä»¥åŠè®¡ç®—)å…±11så¤šï¼Œç”¨æ¥æ¨ç®—è‡ªå·±ç¦»æœ€ä¼˜è¿˜æœ‰å¤šè¿œã€‚</p>
<p>(æˆ‘å®åœ¨æ²¡æƒ³é€šç¬¬ä¸€åæ€ä¹ˆè·‘åˆ°11sçš„ï¼Œå¤§æ¦‚æ˜¯æˆ‘å†…å­˜æ–‡ä»¶ç³»ç»Ÿå¼€çš„ä¸å¯¹ï¼Ÿ)</p>
<h3 id="ä¸ç¨³å®šçš„ioå®ç°">ä¸ç¨³å®šçš„I/Oå®ç°</h3>
<p>æ¯ä¸ªæ–‡ä»¶å•çº¿ç¨‹è¯»ï¼Œå›ºå®š4çº¿ç¨‹å¤„ç†ï¼Œé€šè¿‡é¢„å…ˆåˆ†é…çš„ buffer é¿å…å‡ºç° GCã€‚</p>
<p>å°è£…æ–‡ä»¶æ“ä½œå¹¶è¡Œï¼Œ5ä¸ªæ–‡ä»¶å¹¶è¡Œæ€»å…±å ç”¨ 25 coreã€‚</p>
<p>å®ç°ä¸‹æ¥ç”±äºè¯»å’Œæ“ä½œæ— æ³•æœ‰æ•ˆå¹³è¡¡ï¼Œå¾ˆéš¾åšåˆ°è¯»å®Œå°±æ“ä½œï¼Œå¤§é‡æ—¶é—´èŠ±è´¹åœ¨ç­‰å¾…è¯»çº¿ç¨‹æ–°äº§å‡ºä¸€ä¸ªbufferæˆ–æ˜¯å¤„ç†çº¿ç¨‹å¤„ç†å®Œä¸€ä¸ªbufferã€‚</p>
<p>åœ¨æ¸…ç†ç³»ç»Ÿcacheçš„æƒ…å†µä¸‹ï¼Œå¤§çº¦8så¤„ç†å®Œæ‰€æœ‰å­—ç¬¦ä¸²ï¼Œä¸æ¸…ç†å¤§çº¦ä¸º4sã€‚</p>
<p>è¿™ç§å®ç°æ— æ³•è°ƒä¼˜ï¼Œç­‰å¾…çš„æ—¶é—´å®Œå…¨çœ‹ OS å¿ƒæƒ…ã€‚</p>
<h3 id="ç¨³å®šçš„ioå®ç°">ç¨³å®šçš„I/Oå®ç°</h3>
<p>å…¶å®ä¹‹å‰æåˆ°è¿‡ï¼Œå•çº¿ç¨‹è¯»å¹¶ä¸æ˜¯ä¸€ä¸ªå¾ˆå¥½çš„æ€è·¯ï¼Œè€Œä¸”ä¸Šè¿°çš„å¤„ç†æ¶æ„å­˜åœ¨ç€ä¸ç¨³å®šçš„ç­‰å¾…é—®é¢˜ã€‚</p>
<p>é‚£ä¹ˆå¦‚ä½•ä½¿å¾—åœ¨ä¿æŒå¤šçº¿ç¨‹è¯»çš„åŒæ—¶èƒ½å¤Ÿå¤šçº¿ç¨‹å¤„ç†ï¼Œå¹¶ä¸”ä¸æµªè´¹æ—¶é—´åœ¨ç­‰å¾…ä¸Šå‘¢ï¼Ÿ</p>
<p>ç­”æ¡ˆæ˜¯<strong>æ¯ä¸€ä¸ªçº¿ç¨‹åœ¨è¯»å®Œä¸€ä»½æ•°æ®åï¼Œç›´æ¥è¿›è¡Œå¤„ç†ï¼Œç„¶åè¯»å–ä¸‹ä¸€ä»½</strong>ã€‚</p>
<p>ä½†æ˜¯å¦‚ä½•å®‰æ’æ¯ä¸€ä¸ªçº¿ç¨‹çš„é‚£ä»½æ•°æ®ï¼Œä¿è¯çº¿ç¨‹ä¹‹é—´ä¸ä¼šæœ‰é‡å¤è¯»å–ï¼Œä¹Ÿä¸ä¼šæœ‰æ¼è¯»çš„æ•°æ®å—ï¼Ÿ</p>
<p>è¿™é‡Œé‡‡ç”¨ Eric åœ¨å¤èµ›é‡Œçš„å®ç°: FileSegment, é€šè¿‡å°†ä¸€ä¸ªæ–‡ä»¶åˆ†å‰²ä¸ºä¸€ä¸ªä¸€ä¸ª Segmentï¼Œè®©æ¯ä¸€ä¸ªçº¿ç¨‹è‡ªå·±è¯·æ±‚ä¸‹ä¸€ä¸ª Segmentï¼Œå¹¶é€šè¿‡ RandomAccessFile è¿›è¡Œè¯»å–ã€‚(ç”±äºä¸è®¸ç”¨ FileChannel)</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">FileSegment</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="n">File</span> <span class="n">file</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="kt">long</span> <span class="n">offset</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="kt">long</span> <span class="n">size</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">...</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">abstract</span> <span class="kd">class</span> <span class="nc">BufferedFileSegmentReadProcessor</span> <span class="kd">implements</span> <span class="n">Runnable</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">bufferMargin</span> <span class="o">=</span> <span class="mi">1024</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="n">FileSegmentLoader</span> <span class="n">fileSegmentLoader</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="kt">int</span> <span class="n">bufferSize</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="kt">byte</span><span class="o">[]</span> <span class="n">readBuffer</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// Here bufferSize must be greater than segments&#39; size got from fileSegmentLoader, 
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// otherwise segment will not be fully read/processed!
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kd">public</span> <span class="nf">BufferedFileSegmentReadProcessor</span><span class="o">(</span><span class="n">FileSegmentLoader</span> <span class="n">fileSegmentLoader</span><span class="o">,</span> <span class="kt">int</span> <span class="n">bufferSize</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">this</span><span class="o">.</span><span class="na">bufferSize</span> <span class="o">=</span> <span class="n">bufferSize</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">this</span><span class="o">.</span><span class="na">fileSegmentLoader</span> <span class="o">=</span> <span class="n">fileSegmentLoader</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="kt">int</span> <span class="nf">readSegment</span><span class="o">(</span><span class="n">FileSegment</span> <span class="n">segment</span><span class="o">,</span> <span class="kt">byte</span><span class="o">[]</span> <span class="n">readBuffer</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">IOException</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="kt">int</span> <span class="n">limit</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">try</span> <span class="o">(</span><span class="n">RandomAccessFile</span> <span class="n">randomAccessFile</span> <span class="o">=</span> <span class="k">new</span> <span class="n">RandomAccessFile</span><span class="o">(</span><span class="n">segment</span><span class="o">.</span><span class="na">getFile</span><span class="o">(),</span> <span class="s">&#34;r&#34;</span><span class="o">))</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">randomAccessFile</span><span class="o">.</span><span class="na">seek</span><span class="o">(</span><span class="n">segment</span><span class="o">.</span><span class="na">getOffset</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">            <span class="n">limit</span> <span class="o">=</span> <span class="n">randomAccessFile</span><span class="o">.</span><span class="na">read</span><span class="o">(</span><span class="n">readBuffer</span><span class="o">,</span> <span class="mi">0</span><span class="o">,</span> <span class="n">readBuffer</span><span class="o">.</span><span class="na">length</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">limit</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">protected</span> <span class="kd">abstract</span> <span class="kt">void</span> <span class="nf">processSegment</span><span class="o">(</span><span class="n">FileSegment</span> <span class="n">segment</span><span class="o">,</span> <span class="kt">byte</span><span class="o">[]</span> <span class="n">readBuffer</span><span class="o">,</span> <span class="kt">int</span> <span class="n">limit</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">readBuffer</span> <span class="o">=</span> <span class="k">new</span> <span class="kt">byte</span><span class="o">[</span><span class="n">bufferSize</span> <span class="o">+</span> <span class="n">bufferMargin</span><span class="o">];</span>
</span></span><span class="line"><span class="cl">        <span class="k">try</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">FileSegment</span> <span class="n">segment</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">            <span class="k">while</span> <span class="o">((</span><span class="n">segment</span> <span class="o">=</span> <span class="n">fileSegmentLoader</span><span class="o">.</span><span class="na">nextFileSegment</span><span class="o">())</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="kt">int</span> <span class="n">limit</span> <span class="o">=</span> <span class="n">readSegment</span><span class="o">(</span><span class="n">segment</span><span class="o">,</span> <span class="n">readBuffer</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">                <span class="n">processSegment</span><span class="o">(</span><span class="n">segment</span><span class="o">,</span> <span class="n">readBuffer</span><span class="o">,</span> <span class="n">limit</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">IOException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></div><p>è¿™æ ·æ¯ä¸€ä¸ªçº¿ç¨‹éƒ½åœ¨è¯»å’Œå¤„ç†ä¹‹é—´å¾ªç¯ï¼Œå…ˆå®Œæˆçš„çº¿ç¨‹ä¼šè¯·æ±‚ä¸‹ä¸€ä¸ª Segmentï¼Œä¿è¯ä»¥æœ€çŸ­çš„æ—¶é—´å®Œæˆè°ƒç”¨æ‰€æœ‰ Core è¿›è¡Œä¸€éæ•°æ®å¤„ç†ã€‚</p>
<p>è¿™ä¸ªæ–¹æ³•ä¿è¯èƒ½å¤Ÿååˆ†ç¨³å®šçš„è¿›è¡Œè¯»å–å’Œå¤„ç†ï¼Œå¹¶ä¸”ä¸éœ€è¦ç­‰å¾… Reader å’Œ Processor é€šä¿¡ï¼Œåœ¨æˆ‘çš„å®éªŒç¯å¢ƒä¸­åŸºæœ¬å­˜ç€cache 3-4sèƒ½æ‰«æä¸€éï¼Œæ¸…ç†cacheä¹Ÿåœ¨ 7-8sã€‚</p>
<p>å…¶å®åˆ°è¿™é‡Œæœ¬é¢˜å·²ç»å·®ä¸å¤šäº†ï¼Œæˆ‘è®°å¾— Eric åœ¨è¿™ç§å¤„ç†ä¸‹æ¯”èµ›çš„æœ€ç»ˆç»“æœæ˜¯ 14s å¤šã€‚</p>
<h3 id="top-1-çš„ä¼˜åŒ–">Top 1 çš„ä¼˜åŒ–</h3>
<ol>
<li>åœ¨å»ºç«‹æ¡¶çš„æ—¶å€™ï¼ŒåŒæ—¶å°†æ¯ä¸ªæ–‡ä»¶ä¸Šç¬¬iæ¡å­—ç¬¦ä¸²å¯¹åº”çš„offsetã€æ¡¶åºå·å­˜å…¥ä¸¤ä¸ªæ•°ç»„ï¼Œå¹¶å°†æ¡¶ä¿¡æ¯ä»¥åŠè¿™ä¸¤ä¸ªæ•°ç»„ä¸€èµ·å­˜å‚¨åˆ°æœ¬åœ°ï¼Œè¿™æ ·æ„æˆäº†ä¸€ä¸ªå¯ä»¥å¿«é€ŸæŸ¥è¯¢æ¡¶å†…æ‰€æœ‰å­—ç¬¦ä¸²çš„ç´¢å¼•</li>
<li>è¿™äº›ä¿¡æ¯æ€»è®¡å¤§çº¦ 1G å·¦å³ï¼Œé€šè¿‡å»ºç«‹è¿™æ ·çš„ç´¢å¼•ï¼Œæ¯æ¬¡ä»…è®²ç´¢å¼•ä¿¡æ¯è¯»å…¥ï¼Œå¹¶è¿›è¡Œæœ‰é™æ¬¡çš„è¯»å–ï¼Œå°±å¯ä»¥è·å–åˆ°æ‰€æœ‰éœ€è¦çš„å­—ç¬¦ä¸²</li>
</ol>
<p>å¯¹æ¯”ä¹‹ä¸‹ï¼Œä¹‹å‰çš„æ–¹å¼æ˜¯ä»å†…å­˜æ–‡ä»¶ç³»ç»Ÿè¯»å–5Gçš„æ–‡ä»¶ï¼Œç°åœ¨æ˜¯ä»SSDè¯»å–1Gå·¦å³æ–‡ä»¶ï¼Œåªè¦å¹¶å‘è¯»é€Ÿåº¦å·®è·ä¸åœ¨5å€ä»¥ä¸Šï¼Œè¿™æ ·çš„ä¼˜åŒ–æ˜¯èƒ½èŠ‚çœä¸å°‘æ—¶é—´ï¼</p>
<h2 id="æµ‹è¯•">æµ‹è¯•</h2>
<p>ä»…æµ‹è¯•äº†å»º Index</p>
<h3 id="æ¸…ç†-cache">æ¸…ç† cache</h3>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">$ sysctl -w vm.drop_caches<span class="o">=</span><span class="m">3</span>
</span></span><span class="line"><span class="cl">vm.drop_caches <span class="o">=</span> <span class="m">3</span>
</span></span><span class="line"><span class="cl">$ <span class="nb">time</span> java <span class="si">${</span><span class="nv">JAVA_OPTS</span><span class="si">}</span> -cp /exp/topkn/topkn.jar com.alibaba.middleware.topkn.TopknWorker localhost <span class="m">5527</span> .
</span></span><span class="line"><span class="cl"><span class="o">[</span>2017-07-27 14:24:27.512<span class="o">]</span> INFO com.alibaba.middleware.topkn.TopknWorker Connecting to master at localhost:5527
</span></span><span class="line"><span class="cl"><span class="o">[</span>2017-07-27 14:24:27.519<span class="o">]</span> INFO com.alibaba.middleware.topkn.TopknWorker Building index ...
</span></span><span class="line"><span class="cl">0.673: <span class="o">[</span>GC <span class="o">(</span>Allocation Failure<span class="o">)</span> 0.673: <span class="o">[</span>ParNew: 809135K-&gt;99738K<span class="o">(</span>943744K<span class="o">)</span>, 0.1759305 secs<span class="o">]</span> 809135K-&gt;542134K<span class="o">(</span>3040896K<span class="o">)</span>, 0.1761763 secs<span class="o">]</span> <span class="o">[</span>Times: <span class="nv">user</span><span class="o">=</span>3.15 <span class="nv">sys</span><span class="o">=</span>0.69, <span class="nv">real</span><span class="o">=</span>0.17 secs<span class="o">]</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>2017-07-27 14:24:32.330<span class="o">]</span> INFO com.alibaba.middleware.topkn.TopknWorker Index built.
</span></span><span class="line"><span class="cl">Heap
</span></span><span class="line"><span class="cl"> par new generation   total 943744K, used 903716K <span class="o">[</span>0x0000000700000000, 0x0000000740000000, 0x0000000740000000<span class="o">)</span>
</span></span><span class="line"><span class="cl">  eden space 838912K,  95% used <span class="o">[</span>0x0000000700000000, 0x00000007311225e0, 0x0000000733340000<span class="o">)</span>
</span></span><span class="line"><span class="cl">  from space 104832K,  95% used <span class="o">[</span>0x00000007399a0000, 0x000000073fb06b38, 0x0000000740000000<span class="o">)</span>
</span></span><span class="line"><span class="cl">  to   space 104832K,   0% used <span class="o">[</span>0x0000000733340000, 0x0000000733340000, 0x00000007399a0000<span class="o">)</span>
</span></span><span class="line"><span class="cl"> concurrent mark-sweep generation total 2097152K, used 442395K <span class="o">[</span>0x0000000740000000, 0x00000007c0000000, 0x00000007c0000000<span class="o">)</span>
</span></span><span class="line"><span class="cl"> Metaspace       used 3980K, capacity 4638K, committed 4864K, reserved 1056768K
</span></span><span class="line"><span class="cl">  class space    used 434K, capacity 462K, committed 512K, reserved 1048576K
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">real    0m5.238s
</span></span><span class="line"><span class="cl">user    1m11.980s
</span></span><span class="line"><span class="cl">sys     0m26.324s
</span></span></code></pre></div><h3 id="ä¸æ¸…ç†-cache">ä¸æ¸…ç† cache</h3>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">$ <span class="nb">time</span> java <span class="si">${</span><span class="nv">JAVA_OPTS</span><span class="si">}</span> -cp /exp/topkn/topkn.jar com.alibaba.middleware.topkn.TopknWorker localhost <span class="m">5527</span> .
</span></span><span class="line"><span class="cl"><span class="o">[</span>2017-07-27 14:25:39.986<span class="o">]</span> INFO com.alibaba.middleware.topkn.TopknWorker Connecting to master at localhost:5527
</span></span><span class="line"><span class="cl"><span class="o">[</span>2017-07-27 14:25:39.992<span class="o">]</span> INFO com.alibaba.middleware.topkn.TopknWorker Building index ...
</span></span><span class="line"><span class="cl">0.590: <span class="o">[</span>GC <span class="o">(</span>Allocation Failure<span class="o">)</span> 0.590: <span class="o">[</span>ParNew: 838912K-&gt;99751K<span class="o">(</span>943744K<span class="o">)</span>, 0.1851592 secs<span class="o">]</span> 838912K-&gt;591302K<span class="o">(</span>3040896K<span class="o">)</span>, 0.1855308 secs<span class="o">]</span> <span class="o">[</span>Times: <span class="nv">user</span><span class="o">=</span>3.03 <span class="nv">sys</span><span class="o">=</span>0.88, <span class="nv">real</span><span class="o">=</span>0.19 secs<span class="o">]</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>2017-07-27 14:25:44.449<span class="o">]</span> INFO com.alibaba.middleware.topkn.TopknWorker Index built.
</span></span><span class="line"><span class="cl">Heap
</span></span><span class="line"><span class="cl"> par new generation   total 943744K, used 863664K <span class="o">[</span>0x0000000700000000, 0x0000000740000000, 0x0000000740000000<span class="o">)</span>
</span></span><span class="line"><span class="cl">  eden space 838912K,  91% used <span class="o">[</span>0x0000000700000000, 0x000000072ea02318, 0x0000000733340000<span class="o">)</span>
</span></span><span class="line"><span class="cl">  from space 104832K,  95% used <span class="o">[</span>0x00000007399a0000, 0x000000073fb09e00, 0x0000000740000000<span class="o">)</span>
</span></span><span class="line"><span class="cl">  to   space 104832K,   0% used <span class="o">[</span>0x0000000733340000, 0x0000000733340000, 0x00000007399a0000<span class="o">)</span>
</span></span><span class="line"><span class="cl"> concurrent mark-sweep generation total 2097152K, used 491550K <span class="o">[</span>0x0000000740000000, 0x00000007c0000000, 0x00000007c0000000<span class="o">)</span>
</span></span><span class="line"><span class="cl"> Metaspace       used 3980K, capacity 4638K, committed 4864K, reserved 1056768K
</span></span><span class="line"><span class="cl">  class space    used 434K, capacity 462K, committed 512K, reserved 1048576K
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">real    0m4.754s
</span></span><span class="line"><span class="cl">user    0m57.144s
</span></span><span class="line"><span class="cl">sys     0m30.568s
</span></span></code></pre></div><p><strong>UPDATE</strong></p>
<p>åœ¨æˆ‘çš„8æ ¸å°ç‰©ç†æœºä¸Šï¼Œè·‘ä¸€è¾¹å†…å­˜æ–‡ä»¶ç³»ç»Ÿé‡Œçš„æ•°æ®ä¸è¦1s&hellip; çœ‹æ¥æ˜¯æœºå™¨çš„é—®é¢˜ï¼Œäº‘æœåŠ¡å™¨è¿˜æ˜¯ä¸ç»™åŠ›å•Š ğŸ¤£</p>
<h2 id="æ€»ç»“">æ€»ç»“</h2>
<p>ä»Šå¹´çš„ä¸­é—´ä»¶æ¯”èµ›æ˜¯åœ¨å¾ˆæœ‰æ„æ€ï¼Œè¿™ä¸ªé¢˜ç›®å¯¹å‚èµ›é€‰æ‰‹æœ‰æ¯”è¾ƒé«˜çš„è¦æ±‚ï¼Œè§£é¢˜ä¸­æ¶‰åŠåˆ°å¤šçº¿ç¨‹å¹¶å‘è¯»å†™ã€åˆ†å¸ƒå¼æ’åºã€ç´¢å¼•ã€Socketç¼–ç¨‹ã€JVM è°ƒä¼˜ç­‰å¤šä¸ªæ–¹é¢ï¼Œæˆ‘è¿™ç§ä¸Šæ¥ç›´æ¥æŒ‘çš„æœæ–­æŒ‚äº†ä¸¤ä¸ªç‰ˆæœ¬çš„ä»£ç ï¼Œä¸œçœ‹è¥¿çœ‹å·¦é—®å³é—®ç»ˆäºæŠŠæœ€ç»ˆå½¢å¼ç»™å¼„æ¸…æ¥šäº†ã€‚</p>
<p>è¯´æ˜¯æˆ‘åšçš„ä¸å¦‚è¯´æ˜¯æˆ‘åœ¨å­¦å¦‚ä½•åšï¼Œåœ¨æ­¤è¿‡ç¨‹ä¸­å‘ç°äº†å¾ˆå¤šæœ‰æ„ä¹‰çš„æŠ€æœ¯ç‚¹ï¼Œæ­£å‡†å¤‡æ¥ä¸‹æ¥ç»§ç»­å­¦ä¹ ã€‚</p>
</section>


    <footer class="article-footer">
    
    <section class="article-tags">
        
            <a href="/tags/java/">java</a>
        
            <a href="/tags/distributed-system/">distributed system</a>
        
            <a href="/tags/parallel-computing/">parallel computing</a>
        
    </section>


    
    <section class="article-copyright">
        <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-copyright" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="12" cy="12" r="9" />
  <path d="M14.5 9a3.5 4 0 1 0 0 6" />
</svg>



        <span>Licensed under CC BY-NC-SA 4.0</span>
    </section>
    </footer>


    
</article>

    <aside class="related-contents--wrapper">
    
    
        <h2 class="section-title">ç›¸å…³æ–‡ç« </h2>
        <div class="related-contents">
            <div class="flex article-list--tile">
                
                    
<article class="">
    <a href="/p/awrace-2018/">
        
        

        <div class="article-details">
            <h2 class="article-title">ç¬¬å››å±Šå¤©æ± ä¸­é—´ä»¶æ€§èƒ½æŒ‘æˆ˜èµ›æ„Ÿæƒ³</h2>
        </div>
    </a>
</article>
                
            </div>
        </div>
    
</aside>

     
     
        
    <script src="https://beaudar.lipk.org/client.js"
        repo="arkbriar/blog"
        issue-term="pathname"
        
        label="comments"
        
        comment-order="desc"
        input-position="top"
        crossorigin="anonymous"
        async
        >
</script>

<style>
    .beaudar {
        max-width: unset;
    }
</style>

<script>
    function setUtterancesTheme(theme) {
        let beaudar = document.querySelector('.beaudar iframe');
        if (beaudar) {
            beaudar.contentWindow.postMessage(
                {
                    type: 'set-theme',
                    theme: `github-${theme}`
                },
                'https://beaudar.lipk.org'
            );
        }
    }

    addEventListener('message', event => {
        if (event.origin !== 'https://beaudar.lipk.org') return;
        setUtterancesTheme(document.documentElement.dataset.scheme)
    });

    window.addEventListener('onColorSchemeChange', (e) => {
        setUtterancesTheme(e.detail)
    })
</script>


    

    <footer class="site-footer">
    <section class="copyright">
        &copy; 
        
            2018 - 
        
        2023 çŸ³æ²‰æºªæ´ -- Ark&#39;s Blog
    </section>
    
    <section class="powerby">
        Built with <a href="https://gohugo.io/" target="_blank" rel="noopener">Hugo</a> <br />
        Theme <b><a href="https://github.com/CaiJimmy/hugo-theme-stack" target="_blank" rel="noopener" data-version="3.2.0">Stack</a></b> designed by <a href="https://jimmycai.com" target="_blank" rel="noopener">Jimmy</a>
    </section>
</footer>


    
<div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">

    
    <div class="pswp__bg"></div>

    
    <div class="pswp__scroll-wrap">

        
        <div class="pswp__container">
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
        </div>

        
        <div class="pswp__ui pswp__ui--hidden">

            <div class="pswp__top-bar">

                

                <div class="pswp__counter"></div>

                <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>

                <button class="pswp__button pswp__button--share" title="Share"></button>

                <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>

                <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>

                
                
                <div class="pswp__preloader">
                    <div class="pswp__preloader__icn">
                        <div class="pswp__preloader__cut">
                            <div class="pswp__preloader__donut"></div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
                <div class="pswp__share-tooltip"></div>
            </div>

            <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
            </button>

            <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
            </button>

            <div class="pswp__caption">
                <div class="pswp__caption__center"></div>
            </div>

        </div>

    </div>

</div><script 
                src="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.js"integrity="sha256-ePwmChbbvXbsO02lbM3HoHbSHTHFAeChekF1xKJdleo="crossorigin="anonymous"
                defer="true"
                >
            </script><script 
                src="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe-ui-default.min.js"integrity="sha256-UKkzOn/w1mBxRmLLGrSeyB4e1xbrp4xylgAWb3M42pU="crossorigin="anonymous"
                defer="true"
                >
            </script><link 
                rel="stylesheet" 
                href="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/default-skin/default-skin.css"integrity="sha256-c0uckgykQ9v5k&#43;IqViZOZKc47Jn7KQil4/MP3ySA3F8="crossorigin="anonymous"
            ><link 
                rel="stylesheet" 
                href="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.css"integrity="sha256-SBLU4vv6CA6lHsZ1XyTdhyjJxCjPif/TRkjnsyGAGnE="crossorigin="anonymous"
            >

            </main>
    
        <aside class="sidebar right-sidebar sticky">
            <section class="widget archives">
                <div class="widget-icon">
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-hash" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <line x1="5" y1="9" x2="19" y2="9" />
  <line x1="5" y1="15" x2="19" y2="15" />
  <line x1="11" y1="4" x2="7" y2="20" />
  <line x1="17" y1="4" x2="13" y2="20" />
</svg>



                </div>
                <h2 class="widget-title section-title">ç›®å½•</h2>
                
                <div class="widget--toc">
                    <nav id="TableOfContents">
  <ol>
    <li><a href="#24h-topkn">24h TOPKN</a></li>
    <li><a href="#è§£é¢˜è¿‡ç¨‹">è§£é¢˜è¿‡ç¨‹</a>
      <ol>
        <li><a href="#mysql-çš„ç´¢å¼•">MySQL çš„ç´¢å¼•</a></li>
        <li><a href="#bb-æ ‘">B/B+ æ ‘</a></li>
        <li><a href="#æ¡¶æ’åº">æ¡¶æ’åº</a></li>
        <li><a href="#åŸºæœ¬æ€è·¯">åŸºæœ¬æ€è·¯</a></li>
      </ol>
    </li>
    <li><a href="#å®ç°è¿‡ç¨‹">å®ç°è¿‡ç¨‹</a>
      <ol>
        <li><a href="#top-1-çš„æœ€ç»ˆç»“æœ">Top 1 çš„æœ€ç»ˆç»“æœ</a></li>
        <li><a href="#ä¸ç¨³å®šçš„ioå®ç°">ä¸ç¨³å®šçš„I/Oå®ç°</a></li>
        <li><a href="#ç¨³å®šçš„ioå®ç°">ç¨³å®šçš„I/Oå®ç°</a></li>
        <li><a href="#top-1-çš„ä¼˜åŒ–">Top 1 çš„ä¼˜åŒ–</a></li>
      </ol>
    </li>
    <li><a href="#æµ‹è¯•">æµ‹è¯•</a>
      <ol>
        <li><a href="#æ¸…ç†-cache">æ¸…ç† cache</a></li>
        <li><a href="#ä¸æ¸…ç†-cache">ä¸æ¸…ç† cache</a></li>
      </ol>
    </li>
    <li><a href="#æ€»ç»“">æ€»ç»“</a></li>
  </ol>
</nav>
                </div>
            </section>
        </aside>
    

        </div>
        <script 
                src="https://cdn.jsdelivr.net/npm/node-vibrant@3.1.5/dist/vibrant.min.js"integrity="sha256-5NovOZc4iwiAWTYIFiIM7DxKUXKWvpVEuMEPLzcm5/g="crossorigin="anonymous"
                defer="false"
                >
            </script><script type="text/javascript" src="/ts/main.js" defer></script>
<script>
    (function () {
        const customFont = document.createElement('link');
        customFont.href = "https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&display=swap";

        customFont.type = "text/css";
        customFont.rel = "stylesheet";

        document.head.appendChild(customFont);
    }());
</script>

    </body>
</html>
