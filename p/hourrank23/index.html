<!DOCTYPE html>
<html lang="zh-cn">
    <head><meta charset='utf-8'>
<meta name='viewport' content='width=device-width, initial-scale=1'><meta name='description' content='ä¸åˆ·é¢˜ä¸çŸ¥é“è‡ªå·±èœï¼Œè¶Šåˆ·é¢˜è¶Šå‘ç°è‡ªå·±ğŸ™„ â€”â€” è®° HourRank23 è¢«è™ã€‚
'><title>ç¨€ç–è¡¨å’Œå¹¶è¡ŒäºŒåˆ†æŸ¥æ‰¾ (Sparse Table &amp; Parallel Binary Search)</title>

<link rel='canonical' href='https://blog.crazyark.xyz/p/hourrank23/'>

<link rel="stylesheet" href="/scss/style.min.css"><meta property='og:title' content='ç¨€ç–è¡¨å’Œå¹¶è¡ŒäºŒåˆ†æŸ¥æ‰¾ (Sparse Table &amp; Parallel Binary Search)'>
<meta property='og:description' content='ä¸åˆ·é¢˜ä¸çŸ¥é“è‡ªå·±èœï¼Œè¶Šåˆ·é¢˜è¶Šå‘ç°è‡ªå·±ğŸ™„ â€”â€” è®° HourRank23 è¢«è™ã€‚
'>
<meta property='og:url' content='https://blog.crazyark.xyz/p/hourrank23/'>
<meta property='og:site_name' content='çŸ³æ²‰æºªæ´ -- Ark&#39;s Blog'>
<meta property='og:type' content='article'><meta property='article:section' content='Post' /><meta property='article:tag' content='sparse table' /><meta property='article:tag' content='parallel binary search' /><meta property='article:tag' content='algorithm' /><meta property='article:published_time' content='2017-09-10T01:06:11&#43;08:00'/><meta property='article:modified_time' content='2017-09-10T01:06:11&#43;08:00'/>
<meta name="twitter:site" content="@ImperiusDs">
    <meta name="twitter:creator" content="@ImperiusDs"><meta name="twitter:title" content="ç¨€ç–è¡¨å’Œå¹¶è¡ŒäºŒåˆ†æŸ¥æ‰¾ (Sparse Table &amp; Parallel Binary Search)">
<meta name="twitter:description" content="ä¸åˆ·é¢˜ä¸çŸ¥é“è‡ªå·±èœï¼Œè¶Šåˆ·é¢˜è¶Šå‘ç°è‡ªå·±ğŸ™„ â€”â€” è®° HourRank23 è¢«è™ã€‚
">
    </head>
    <body class="
    article-page has-toc
">
    <script>
        (function() {
            const colorSchemeKey = 'StackColorScheme';
            if(!localStorage.getItem(colorSchemeKey)){
                localStorage.setItem(colorSchemeKey, "auto");
            }
        })();
    </script><script>
    (function() {
        const colorSchemeKey = 'StackColorScheme';
        const colorSchemeItem = localStorage.getItem(colorSchemeKey);
        const supportDarkMode = window.matchMedia('(prefers-color-scheme: dark)').matches === true;

        if (colorSchemeItem == 'dark' || colorSchemeItem === 'auto' && supportDarkMode) {
            

            document.documentElement.dataset.scheme = 'dark';
        } else {
            document.documentElement.dataset.scheme = 'light';
        }
    })();
</script>
<div class="container main-container flex 
    
        extended
    
">
    
        <div id="article-toolbar">
            <a href="https://blog.crazyark.xyz" class="back-home">
                <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-chevron-left" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <polyline points="15 6 9 12 15 18" />
</svg>



                <span>è¿”å›</span>
            </a>
        </div>
    
<main class="main full-width">
    <article class="main-article">
    <header class="article-header">

    <div class="article-details">
    
    <header class="article-category">
        
            <a href="/categories/algorithm/" >
                Algorithm
            </a>
        
    </header>
    

    <h2 class="article-title">
        <a href="/p/hourrank23/">ç¨€ç–è¡¨å’Œå¹¶è¡ŒäºŒåˆ†æŸ¥æ‰¾ (Sparse Table &amp; Parallel Binary Search)</a>
    </h2>

    

    
    <footer class="article-time">
        
            <div>
                <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-calendar-time" width="56" height="56" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <path d="M11.795 21h-6.795a2 2 0 0 1 -2 -2v-12a2 2 0 0 1 2 -2h12a2 2 0 0 1 2 2v4" />
  <circle cx="18" cy="18" r="4" />
  <path d="M15 3v4" />
  <path d="M7 3v4" />
  <path d="M3 11h16" />
  <path d="M18 16.496v1.504l1 1" />
</svg>
                <time class="article-time--published">Sep 10, 2017</time>
            </div>
        

        
            <div>
                <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-clock" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="12" cy="12" r="9" />
  <polyline points="12 7 12 12 15 15" />
</svg>



                <time class="article-time--reading">
                    é˜…è¯»æ—¶é•¿: 12 åˆ†é’Ÿ
                </time>
            </div>
        
    </footer>
    
</div>
</header>

    <section class="article-content">
    <p>ä¸åˆ·é¢˜ä¸çŸ¥é“è‡ªå·±èœï¼Œè¶Šåˆ·é¢˜è¶Šå‘ç°è‡ªå·±ğŸ™„ â€”â€” è®° HourRank23 è¢«è™ã€‚</p>
<h3 id="sparse-table">Sparse Table</h3>
<p>è¿˜è®°å¾—ä¸Šä¸¤ç¯‡çº¿æ®µæ ‘å’ŒBITéƒ½è®²åˆ°äº†åŒºé—´æŸ¥æ‰¾çš„é—®é¢˜ï¼Œæˆ‘ä»¬æ¥å›å¿†ä¸€ä¸‹ã€‚</p>
<p>çº¿æ®µæ ‘ç©ºé—´æ”¯æŒå„ç§å‡½æ•°(Associativeï¼Œéœ€è¦æ»¡è¶³ç»“åˆå¾‹)çš„åŒºé—´æ›´æ–°å’ŒåŒºé—´æŸ¥è¯¢ï¼Œç©ºé—´å¤æ‚åº¦æ˜¯ O(nlgn)ï¼Œæ›´æ–°å’ŒæŸ¥è¯¢çš„æ—¶é—´å¤æ‚åº¦éƒ½æ˜¯ O(lgn)ã€‚</p>
<p>BIT æ”¯æŒä»»æ„ç¾¤ä¸Šè¿ç®—çš„å•ç‚¹æ›´æ–°/åŒºé—´æŸ¥è¯¢ã€åŒºé—´æ›´æ–°/å•ç‚¹æŸ¥è¯¢ï¼Œç©ºé—´å¤æ‚åº¦æ˜¯ O(n)ï¼Œæ›´æ–°å’ŒæŸ¥è¯¢çš„æ—¶é—´å¤æ‚åº¦ä¹Ÿéƒ½æ˜¯ O(lgn) (å…¶å®å–å†³äºé€†å…ƒæ„é€ é€Ÿåº¦)ã€‚BIT çš„åŒºé—´æ›´æ–°/åŒºé—´æŸ¥è¯¢æ³›åŒ–éœ€è¦æ›´å¤šæ€§è´¨ï¼Œåæ­£ä¸»è¦æ˜¯ç”¨äºæ•´æ•°åŸŸä¸Šçš„å’Œè¿ç®—ã€‚</p>
<p>è€Œè¿™é‡Œæ‰€è¦è®²çš„ Sparse Table æ˜¯å¦ä¸€ç§æ”¯æŒåŒºé—´æŸ¥è¯¢çš„æ•°æ®ç»“æ„ï¼Œé’ˆå¯¹çš„æ˜¯<strong>ä¸å˜çš„ï¼ˆimmutableï¼‰çš„æ•°ç»„</strong>ï¼Œå…¶ç©ºé—´å¤æ‚åº¦ä¸º O(nlgn)ã€‚</p>
<p>Sparse Table åŒæ ·æ”¯æŒå„ç§å‡½æ•°ï¼Œåªè¦æ˜¯æ»¡è¶³ç»“åˆå¾‹çš„å‡½æ•°ä¸€å¾‹éƒ½æ˜¯æ”¯æŒçš„ï¼Œå¯¹æ‰€æœ‰è¿™æ ·çš„å‡½æ•°ï¼Œå…¶æ—¶é—´å¤æ‚åº¦ä¸º O(nlgn)ï¼Œè€Œä¸”æ€æƒ³å’Œç¼–ç éƒ½éå¸¸ç®€å•æ˜“æ‡‚ã€‚</p>
<p>æ›´è¿›ä¸€æ­¥åœ°ï¼Œå¦‚æœ<strong>å‡½æ•°æ˜¯å¹‚ç­‰ (Idemponent) çš„ï¼ŒSparse Tableå¯ä»¥åœ¨O(1)å†…å¾—åˆ°åŒºé—´æŸ¥è¯¢çš„ç»“æœ</strong>ã€‚</p>
<h4 id="æ ¸å¿ƒåŸç†">æ ¸å¿ƒåŸç†</h4>
<p>å‡è®¾æœ‰ä¸€ä¸ªé•¿åº¦ä¸º $N$ çš„æ•°ç»„ ${a_0, &hellip;, a_{N - 1}}$ï¼Œå¹¶æœ‰ä¸€ä¸ªäºŒå…ƒå‡½æ•° $f$ï¼Œæ»¡è¶³ç»“åˆå¾‹ $f(a, f(b, c)) = f(f(a, b), c)$ã€‚</p>
<p>æˆ‘ä»¬ç®€è®°åŒºé—´ $[i, j]$ ä¸Šå¯¹å‡½æ•° $f$ çš„æŸ¥è¯¢ä¸º $f(a[i..j])$ã€‚</p>
<p>é‚£ä¹ˆ Sparse Table å°†ç”Ÿæˆè¿™æ ·ä¸€ä¸ªäºŒç»´æ•°ç»„ï¼Œè¿™ä¸ªäºŒç»´æ•°ç»„çš„å¤§å°ä¸º $N(\lfloor\log N\rfloor + 1)$ã€‚æ•°ç»„çš„ç¬¬ $(i, j)$ é¡¹ä»£è¡¨äº†åŒºé—´ç»“æœ $f(a[i..i + 2^j - 1])$ï¼Œè®°ä¸º $b_{i,j}$ã€‚</p>
<p>ç”Ÿæˆä¸€ä¸ªè¿™æ ·çš„äºŒç»´æ•°ç»„æ˜¯å¾ˆç®€å•çš„ï¼Œå› ä¸º $f(a[i..i + 2^j - 1]) = f(f(a[i..i+2^{j-1} - 1]), f(a[i + 2^{j-1}..i + 2^j - 1]))$ï¼Œè€Œåé¢è¿™ä¸¤ä¸ªåˆ†åˆ«æ˜¯ç¬¬ $(i, j - 1)$ é¡¹å’Œç¬¬ $(i + 2^{j - 1}, j - 1)$ `é¡¹ï¼Œå¹¶ä¸” $f([i..i]) = a_i$ï¼Œæ‰€ä»¥æˆ‘ä»¬ä¸€å±‚å±‚é€’æ¨å°±è¡Œï¼Œè¿‡ç¨‹å¦‚ä¸‹</p>
<pre tabindex="0"><code class="language-pascal" data-lang="pascal">// assuming Arr is indexed from 0
for i=0..N-1: 
  Table[i][0] = Arr[i]
  
// assuming N &lt; 2^(k+1)
for j=1..k: 
  for i=0..N-2^j:
    Table[i][j] = F(Table[i][j - 1], Table[i + 2^(j - 1)][j - 1])
</code></pre><p>é‚£ä¹ˆæˆ‘ä»¬å¦‚ä½•è¿›è¡ŒæŸ¥è¯¢å‘¢ï¼Ÿå› ä¸ºå¯¹äºä¸€ä¸ªåŒºé—´ $[i, j]$ æ¥è¯´ï¼ŒåŒºé—´é•¿åº¦ $L = j - i + 1 \le N$ æ’æˆç«‹ï¼Œæ‰€ä»¥å¦‚æœæˆ‘ä»¬å°† $L$ è¡¨ç¤ºæˆäºŒè¿›åˆ¶å½¢å¼ï¼Œ$L = 2^{q_k} + 2^{q_{k - 1}} + &hellip; + 2^{q_0}$ï¼Œ
é‚£ä¹ˆæœ‰</p>
<p>$j = (\cdots((i + 2^{q_k} - 1) + 2^{q_{k - 1}} - 1) + &hellip; + 2^{q_0}) - 1$ï¼Œè¿™ä¸ªè¡¨ç¤ºå½¢å¼æ˜¯ä¸æ˜¯æé†’ä½ äº†å‘¢ï¼Ÿ</p>
<p>æ‰€ä»¥ç”¨ä»¥ä¸‹è¿‡ç¨‹æˆ‘ä»¬å¯ä»¥åœ¨ O(lgN) æ—¶é—´å†…å¾—åˆ°å‡†ç¡®ç»“æœ:</p>
<pre tabindex="0"><code class="language-pascal" data-lang="pascal">answer = ZERO 
Lâ€™ = L
for i=k..0:
  if Lâ€™ + 2^i - 1 &lt;= R:
    // F is associative, so this operation is meaningful
    answer = F(answer, Table[Lâ€™][i]) 
    Lâ€™ += 2^i
</code></pre><p>å‡è®¾æˆ‘ä»¬çš„å‡½æ•° $f$ åŒæ—¶æ˜¯å¹‚ç­‰çš„ï¼Œä¹Ÿå°±æ˜¯è¯´ $f(x, x) = x$ å¯¹æ‰€æœ‰å®šä¹‰åŸŸå†…çš„æ•°éƒ½æˆç«‹ï¼Œé‚£ä¹ˆæˆ‘ä»¬é©¬ä¸Šå°±èƒ½å¾—åˆ°</p>
<p>$f(a[i..j]) = f(f(a[i..s],f(a[t..j])), i \le t, s \le j, t \le s + 1$ã€‚</p>
<p><strong>è¿™æ¡æ€§è´¨å…è®¸æˆ‘ä»¬ä¸ç”¨ç²¾ç¡®åœ°åªè¦†ç›–è¯¥åŒºåŸŸä¸€æ¬¡ï¼Œè¿™æ˜¯åŠ é€Ÿåˆ° O(1) çš„å…³é”®ã€‚</strong></p>
<p>ä»¤ $t$ æ˜¯æ»¡è¶³ $2^t \le (j - i + 1)$ çš„æœ€å¤§çš„ $t$ï¼Œä¹Ÿå°±æ˜¯ $2^{t + 1} &gt; (j - i + 1)$ã€‚é‚£ä¹ˆæ˜¾ç„¶ $i + 2^t - 1 \le j$ï¼Œ$j - 2^t + 1 \ge i$ï¼Œå¹¶ä¸”æœ‰ $j - 2^t + 1 \le (i + 2^t - 1) + 1$ æ’æˆç«‹ã€‚</p>
<p>æ‰€ä»¥ $f(a[i..j]) = f(f(i..i + 2^t - 1), f(j - 2^t + 1..j))$ï¼Œåé¢ä¸¤é¡¹å°±æ˜¯ $b_{i, t}$ å’Œ $b_{j - 2^t, t}$ã€‚</p>
<p>è‡³æ­¤åŸç†ä»‹ç»å®Œæ¯•ï¼Œå®ç°çš„ä»£ç åœ¨æœ€å Appendix ä¸­ã€‚</p>
<h4 id="st--lca">ST &amp; LCA</h4>
<p>Sparse Table ä¸ä»…å¯ä»¥ç”¨äºè®¡ç®—å„ç§åŒºé—´æŸ¥è¯¢ï¼Œè¿˜å¯ä»¥ç”¨äºè®¡ç®—æ ‘ä¸Šä¸¤ä¸ªèŠ‚ç‚¹çš„æœ€è¿‘å…¬å…±ç¥–å…ˆã€‚ä½¿ç”¨STå¯ä»¥åœ¨ O(2lgH) çš„æ—¶é—´å†…è®¡ç®—å‡ºä»»æ„ä¸¤ä¸ªå‡ ç‚¹çš„æœ€è¿‘å…¬å…±ç¥–å…ˆï¼Œç©ºé—´å¤æ‚åº¦è¿˜æ˜¯ O(NlgN)ï¼Œè¿™é‡Œ N æ˜¯æ ‘ä¸ŠèŠ‚ç‚¹æ•°ï¼ŒH æ˜¯æ ‘é«˜åº¦ã€‚</p>
<p>å…¶ä¸»è¦æ€æƒ³æ˜¯ç”¨æ•°ç»„å­˜æ”¾èŠ‚ç‚¹ i çš„ç¬¬ 2^j ä¸ªç¥–å…ˆï¼Œç„¶åæœç´¢ï¼Œå…·ä½“ç»†èŠ‚æœ‰å…´è¶£çš„åŒå­¦å¯ä»¥å‚è€ƒ topcoder ä¸Šå…³äºRMQå’ŒLCAçš„é‚£ç¯‡æ–‡ç« ï¼Œé“¾æ¥åœ¨å¼•ç”¨ä¸­ï¼Œè¿™é‡Œä¸å†èµ˜è¿°ã€‚</p>
<h3 id="parallel-binary-search">Parallel Binary Search</h3>
<p>Parallel Binary Searchï¼Œä¸­æ–‡å«<strong>æ•´ä½“äºŒåˆ†</strong>ï¼Œæˆ‘ä»¬å…ˆç”¨ä¸€ä¸ªspojä¸Šçš„é¢˜ç›®æ¥ä»‹ç»è¿™ä¸ªæ–¹æ³•ï¼Œç„¶åå†æ¥çœ‹ä¸€ä¸‹hourrankä¸Šçš„å¦ä¸€ä¸ªä¸å¤ªä¸€æ ·çš„é¢˜ç›®ã€‚</p>
<p>æ¥ä¸‹æ¥çš„ä¸¤ä¸ªå°èŠ‚å¤§é‡å‚è€ƒäº†codeforcesä¸Šçš„åšå®¢ï¼ŒåŸæ–‡é“¾æ¥åœ¨æ–‡ç« çš„æœ«å°¾ï¼Œæœ‰å…´è¶£çš„åŒå­¦å¯ä»¥å‰å»å­¦ä¹ ã€‚</p>
<h4 id="motivation-problem">Motivation Problem</h4>
<p>SPOJä¸Šæœ‰è¿™æ ·ä¸€ä¸ªé¢˜ç›®ï¼š<a class="link" href="http://www.spoj.com/problems/METEORS/"  target="_blank" rel="noopener"
    >Meteors</a>ï¼Œåœ¨è¿™é‡Œæˆ‘ç®€å•æè¿°ä¸€ä¸‹ï¼š</p>
<blockquote>
<p>æœ‰ N ä¸ªå›½å®¶ï¼Œæœ‰ä¸€å—åœ†å½¢çš„åœ°æ–¹ï¼Œç­‰åˆ†æˆ M ä¸ªæ‰‡å½¢åŒºåŸŸï¼Œæ¯ä¸ªåŒºåŸŸå±äºæŸä¸€ä¸ªå›½å®¶ã€‚ç°åœ¨é¢„æŠ¥æœ‰ Q é˜µæµæ˜Ÿé›¨ï¼Œæ¯ä¸€é’ˆé™è½åœ¨æŸä¸ªæ‰‡å½¢åŒºåŸŸ [L, R]ï¼Œæ¯ä¸ªæ‰‡å½¢éƒ½è·å¾—ç›¸åŒæ•°é‡ K çš„é™¨çŸ³ã€‚å·²çŸ¥æ¯ä¸ªå›½å®¶æœ‰ä¸€ä¸ªé™¨çŸ³æ”¶é›†ç›®æ ‡ reqd[i]ï¼Œè¯·é—®æ¯ä¸ªå›½å®¶åˆ†åˆ«æœ€å°‘åœ¨å¤šå°‘é˜µæµæ˜Ÿé›¨åæ‰èƒ½æ”¶é›†åˆ°ç›®æ ‡æ•°é‡çš„é™¨çŸ³ã€‚</p>
</blockquote>
<blockquote>
<p>1 &lt;= N, M, Q&lt;= 300000
1 &lt;= K &lt;= 1e9</p>
</blockquote>
<h4 id="solution">Solution</h4>
<p>å¦‚æœæˆ‘ä»¬è€ƒè™‘ä¸ä½¿ç”¨ä»»ä½•æ•°æ®ç»“æ„é€æ¬¡æ¨¡æ‹Ÿï¼Œç„¶åæ£€æŸ¥ç›®æ ‡æ˜¯å¦è¾¾åˆ°äº†ï¼Œæ›´æ–°ä»£ä»·æ˜¯O(M)ï¼Œæ£€æŸ¥çš„ä»£ä»·æ˜¯O(N + M)ï¼Œæ€»ä»£ä»· O((2M + N)Q) æ˜¯æ— æ³•æ‰¿å—çš„ã€‚</p>
<p>è€Œçœ‹åˆ°åŒºé—´æ›´æ–°ï¼Œç»“åˆBlogå¼€å¤´æ‰€è®²çš„å‡ ä¸ªæ•°æ®ç»“æ„ï¼Œé€‰æ‹©BITç”¨äºæ¨¡æ‹Ÿæ›´æ–°æ˜¯æœ€åˆé€‚ä¸è¿‡çš„äº†ï¼›è¿™æ ·æˆ‘ä»¬æ›´æ–°ä»£ä»·é™åˆ°äº† O(lgM)ï¼Œä½†æ˜¯æ£€æŸ¥çš„ä»£ä»·å˜ä¸ºäº† O(MlgM)ï¼Œå¦‚æœè¿˜æ˜¯é€æ¬¡æ¨¡æ‹Ÿï¼Œæ˜¾ç„¶ä¼šæ¯”ä¹‹å‰æ›´å·®ã€‚</p>
<p>åˆ°äº†è¿™é‡Œï¼Œèƒ½æƒ³åˆ°äº†ä»€ä¹ˆäº†å˜›ï¼Ÿå¯¹ï¼ŒäºŒåˆ†æŸ¥æ‰¾ï¼äºŒåˆ†æŸ¥æ‰¾ä¸å…³å¿ƒåºåˆ—ä¸­æ¯ä¸ªæ•°é•¿ä»€ä¹ˆæ ·å­ï¼Œåªéœ€è¦çŸ¥é“ï¼š</p>
<ol>
<li>åºåˆ—å•è°ƒ</li>
<li>å¯ä»¥é€šè¿‡æŸç§æ–¹å¼è·å–åˆ°åºåˆ—ä¸­æŒ‡å®šä½ç½®çš„å€¼</li>
</ol>
<p>ç„¶åï¼Œé€šè¿‡äºŒåˆ†æŸ¥æ‰¾ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨ O(lgN) çš„å€¼è·å–/æ£€æŸ¥å†…ï¼Œæ‰¾åˆ°æˆ‘ä»¬æƒ³è¦çš„ä½ç½®ã€‚</p>
<p>è¿™é‡Œçš„åºåˆ—æŒ‡ä¸€ä¸ªå›½å®¶çš„æ”¶é›†æ€»æ•°ï¼Œè€Œè¿™ä¸ªæ”¶é›†æ€»æ•°ç”±æ‰‡å½¢åŒºé—´æ‰€æ„æˆçš„åºåˆ—éšå¼åœ°ååº”ï¼Œé‚£ä¹ˆé€šè¿‡äºŒåˆ†æŸ¥æ‰¾ï¼Œå¯¹æ¯ä¸ªå›½å®¶æˆ‘ä»¬åªéœ€è¦è¿›è¡Œ O(lgQ) æ¬¡æ£€æŸ¥ï¼Œå°±èƒ½çŸ¥é“æ˜¯åœ¨é‚£ä¸ªæ—¶é—´ç‚¹æ»¡è¶³æ¡ä»¶ã€‚æ‰€ä»¥æ¯ä¸ªå›½å®¶çš„æ€»è®¡æ—¶é—´å¤æ‚åº¦ä¸ºå¤§çº¦ä¸º O(logQ * Q * logM)ï¼Œè¿™é‡Œæ¯æ¬¡æ£€æŸ¥çš„æ—¶é—´ç›¸æ¯”æ›´æ–°çš„æ—¶é—´å¾®ä¸è¶³é“æ‰€ä»¥ç•¥å»äº†ã€‚æœ€ç»ˆå¤æ‚åº¦ä¸º O(N * log Q * Q * logM)ã€‚</p>
<p>å¯ä»¥çœ‹åˆ°ï¼Œä¸Šé¢çš„å¤æ‚åº¦è¿˜æ˜¯å¤ªé«˜ï¼Œæ¯”ç›´æ¥æ¨¡æ‹Ÿè¿˜æ˜¯é«˜äº†å¾ˆå¤šï¼Œé‚£æ€ä¹ˆåŠå‘¢ï¼Ÿ</p>
<p>ç¨å¾®æƒ³ä¸€æƒ³ï¼Œæ¯æ¬¡æ¨¡æ‹Ÿçš„ä»£ä»·è™½ç„¶é™ä½äº†ï¼Œä½†æ˜¯æ¨¡æ‹Ÿçš„æ•°é‡ä¸Šå‡åˆ°äº† O(NlgQ) æ¬¡ï¼Œè™½ç„¶æ£€æŸ¥çš„æ¬¡æ•°ä¹Ÿé™ä½äº†ï¼Œä½†æ˜¯è·Ÿæ¨¡æ‹Ÿçš„è€—æ—¶ç›¸æ¯”ï¼Œä½çš„éƒ½è¢«ç•¥æ‰äº† &hellip; æ‰€ä»¥å½“åŠ¡ä¹‹æ€¥æ˜¯åŒæ—¶èƒ½é™ä½æ¨¡æ‹Ÿçš„å¼€é”€ã€‚</p>
<p>æ˜¯ä¸æ˜¯æ„Ÿè§‰æœ‰ç‚¹å¥¢ä¾ˆï¼Ÿæ¯æ¬¡æˆ‘å°±æ£€æŸ¥é‚£ä¹ˆä¸€ä¸‹ï¼Œå°±è¦æ¨¡æ‹Ÿä¸€æ•´è½®ï¼Œè™½ç„¶æˆ‘å¼€é”€å°ï¼Œä¹Ÿæ¶ä¸ä½ä½ çƒ§CPUç©å•Šã€‚</p>
<p>å…¶å®æ¯ä¸ªå›½å®¶çš„äºŒåˆ†æŸ¥æ‰¾ç»å†æ˜¯å¾ˆç±»ä¼¼çš„ï¼Œåœ¨æ•´ä¸ªæ¨¡æ‹Ÿå‡ºæ¥çš„åºåˆ—é‡Œé¢æ‰¾åˆ°é‚£ä¸€ç‰‡è¦çš„ï¼Œç„¶åæ£€æŸ¥ä¸€ä¸‹æˆ‘ä»¬å°±ä¸‹ä¸€è½®äº†ã€‚é‚£ä¹ˆï¼Œæ—¢ç„¶ä¸€æ•´è½®æ¨¡æ‹Ÿéƒ½åšå®Œäº†ï¼Œèƒ½ä¸èƒ½è®©æ¯ä¸ªå›½å®¶éƒ½æ£€æŸ¥å®Œï¼Œç„¶åæˆ‘ä»¬å†å¼€ä¸‹ä¸€è½®å¥½ä¸å¥½ï¼Ÿ</p>
<p>è¿™å°±æ˜¯ Parallel Binary Search çš„æ ¸å¿ƒæ€æƒ³ï¼š<strong>é€šè¿‡ä¸€è½®æ¨¡æ‹Ÿå®Œæˆæ‰€æœ‰å›½å®¶çš„è¿™ä¸€æ­¥æŸ¥æ‰¾</strong>ï¼Œä»è€Œå°†æ¨¡æ‹Ÿæ€»æ•°å‡å°‘åˆ°äº† O(lgQ) æ¬¡ï¼Œå·¨å¤§çš„è¿›æ­¥ï¼</p>
<p>å…·ä½“æ–¹æ³•æ˜¯ï¼Œå¼€ä¸¤ä¸ªé•¿åº¦ä¸ºNçš„æ•°ç»„ï¼Œå¯¹æ¯ä¸€ä¸ªå›½å®¶ï¼Œè®°å½•å®ƒå½“å‰çš„ L å’Œ Rï¼›å¯¹äºæ¯ä¸€ä¸ªè¦æ£€æŸ¥çš„ midï¼Œå¼€ä¸€ä¸ªé“¾è¡¨è®°å½•å½“å‰éœ€è¦æ£€æŸ¥ mid å€¼çš„å›½å®¶ï¼›å…¶ä½™è¿‡ç¨‹ç”¨ä¸‹åˆ—ä¼ªä»£ç æè¿°ï¼š</p>
<pre tabindex="0"><code>for all logQ steps:
    clear range tree and linked list check
    for all member states i:
        if L[i] != R[i]:
            mid = (L[i] + R[i]) / 2
            insert i in check[mid]
    for all queries q:
        apply(q)
        for all member states m in check[q]:
            if m has requirements fulfilled:
                R[m] = q
            else:
                L[m] = q + 1
</code></pre><p>ä¸Šè¿°è¿‡ç¨‹ä¸­ï¼Œ<code>apply()</code> å‡½æ•°çš„ä½œç”¨æ˜¯ï¼Œè¿›è¡Œæ¨¡æ‹Ÿï¼Œç„¶åæ£€æŸ¥éœ€è¦æ£€æŸ¥çš„å›½å®¶æ˜¯å¦æ»¡è¶³æ¡ä»¶äº†ã€‚</p>
<p>è¿™æ ·å­ï¼Œæ¨¡æ‹Ÿçš„ä»£ä»·æ€»è®¡ä¸º O(lgQ * Q * lgM)ï¼Œæ£€æŸ¥çš„ä»£ä»·æ€»è®¡ä¸º O(lgQ * (MlgM + N))ï¼Œæˆ‘ä»¬æˆåŠŸåœ°åŒæ—¶å°†æ¨¡æ‹Ÿå’Œæ£€æŸ¥çš„ä»£ä»·éƒ½å‡å°äº†ï¼è¿™æ ·çš„æ—¶é—´å¤æ‚åº¦æ€»å…±ä¸º O(lgQ * (Q + M) * lgM)ï¼Œè‡³äºå°‘çš„é‚£ä¸ªNï¼Œå¿½ç•¥ä¸è®¡~</p>
<p>åŒåŸæ–‡ä¸€æ ·ï¼Œè¿™é‡Œå¼•ä¸€å¥å¤§ä½¬çš„è¯è§£é‡Šè¿™ä¸ª Parallel Binary Searchï¼Œ</p>
<blockquote>
<p>&ldquo;A cool way to visualize this is to think of a binary search tree. Suppose we are doing standard binary search, and we reject the right interval â€” this can be thought of as moving left in the tree. Similarly, if we reject the left interval, we are moving right in the tree.
So what Parallel Binary Search does is move one step down in N binary search trees simultaneously in one &ldquo;sweep&rdquo;, taking O(Nâ€‰â€‰*â€‰â€‰X) time, where X is dependent on the problem and the data structures used in it. Since the height of each tree is LogN, the complexity is O(Nâ€‰â€‰*â€‰â€‰Xâ€‰â€‰*â€‰â€‰logN).&rdquo; â€” rekt_n00b</p>
</blockquote>
<h4 id="hourrank23----selective-additions">Hourrank23 &ndash; Selective Additions</h4>
<p>è¿™æ˜¯ä¸€é“è¢«è¯…å’’çš„é¢˜ç›®&hellip;æŠ±æ­‰å®åœ¨æ²¡å¿ä½ğŸ¤£</p>
<p>è¿™é“é¢˜ç›®æ˜¯è¿™æ ·çš„ï¼š</p>
<blockquote>
<p>æœ‰ä¸€ä¸ªæ•°ç»„ï¼Œé•¿åº¦ä¸ºNï¼Œç°åœ¨è¦è¿›è¡Œ M æ¬¡åŒºé—´æ›´æ–°ï¼Œéƒ½æ˜¯åŠ ä¸€ä¸ªæ­£æ•°ã€‚ä½†æ˜¯æˆ‘æœ‰ K ä¸ªå¾ˆå–œæ¬¢çš„æ•°å­—ï¼Œä¸€æ—¦æ•°ç»„ä¸­æŸä¸ªå…ƒç´ æˆä¸ºæˆ‘å–œæ¬¢çš„æ•°å­—ï¼Œå¯¹å®ƒçš„æ›´æ–°å°±æ— æ•ˆï¼Œå®ƒå°†ä¸€ç›´ä¿æŒé‚£ä¸ªæ•°å­—ã€‚
é—®æ¯è½®æ›´æ–°åçš„æ•°ç»„å’Œã€‚</p>
<p>1 &lt;= N, M &lt;= 1e5
1 &lt;= k &lt;= 5</p>
</blockquote>
<p>è¿™é“é¢˜å’Œä¸Šé“é¢˜ä¸å¤ªä¸€æ ·ï¼Œ<strong>æ£€æŸ¥çš„ä»£ä»·ä½ã€æ£€æŸ¥ç›®æ ‡å’ŒåŸåŒºé—´ç›¸åŒ</strong>ï¼Œè€Œä¸”ç›®æ ‡å˜æˆäº†å¤šä¸ªã€‚</p>
<p>ç›®æ ‡æ˜¯å¤šä¸ªå¯ä»¥è¿™æ ·è§£å†³ï¼šå¯¹å–œæ¬¢çš„æ•°æ’åºï¼Œå› ä¸ºæ°¸è¿œæ˜¯æ­£çš„æ›´æ–°ï¼Œæ‰€ä»¥å…ˆåˆ°è¾¾å‰ä¸€ä¸ªåä¸€ä¸ªå°±ä¸ç”¨æ£€æŸ¥äº†ã€‚</p>
<p>é‡‡ç”¨ä¸Šè¿°çš„ PBS çš„æ–¹æ³•ï¼Œè¿™é¢˜çš„å¤æ‚åº¦åœ¨ O(k(n + m)lognlogm)ï¼Œæ˜¯ä¸€ä¸ªå¾ˆå¥½çš„å¤æ‚åº¦äº†ã€‚</p>
<p>ä½†æ˜¯ï¼Œè¿™é‡Œä¸€å®šè¦æœ‰ä¸ªä½†æ˜¯ï¼Œå› ä¸ºæ£€æŸ¥çš„ä»£ä»·å¾ˆä½ï¼Œæ‰€ä»¥è¿™é¢˜çš„äºŒåˆ†æŸ¥æ‰¾ä¸æ˜¯å¿…é¡»çš„ï¼Œæˆ‘ç¿»é˜…äº†å¤§é‡å¤§ä½¬çš„ä»£ç å’Œeditorialï¼Œæœ‰ç”¨PBSçš„ï¼Œæœ‰æ¨¡æ‹Ÿæ—¶é—´åºåˆ—çš„ï¼Œæœ‰ç”¨Segment treeåŠ trickçš„ï¼Œå„ç§å„æ ·ï¼Œæˆ‘æ¥ä¸€ä¸ªä¸ªä»‹ç»ä¸€ä¸‹ï¼š</p>
<h4 id="pbs">PBS</h4>
<p>è¿™ä¸ªä¸å¤šè¯´äº†ï¼Œç¦»çº¿æ¨¡æ‹Ÿ logm éã€‚</p>
<h4 id="time-series-simulation">Time Series Simulation</h4>
<p>ä»£ç : <a class="link" href="https://www.hackerrank.com/rest/contests/hourrank-23/challenges/selective-additions/hackers/nuipqiun/download_solution"  target="_blank" rel="noopener"
    >https://www.hackerrank.com/rest/contests/hourrank-23/challenges/selective-additions/hackers/nuipqiun/download_solution</a></p>
<p>åŒæ ·æ˜¯ç¦»çº¿å¤„ç†ï¼Œä½†æ˜¯è¿™ä¸ªå¤§ä½¬çš„æ¨¡æ‹Ÿæ–¹å¼å¾ˆç‰¹åˆ«ï¼Œä»–æ˜¯åœ¨æ—¶é—´åºåˆ—ä¸Šæ¨¡æ‹Ÿæ•°ç»„å½“å‰é¡¹çš„å€¼ï¼Œæˆ‘è¿˜æ˜¯ç¬¬ä¸€æ¬¡è§ã€‚</p>
<p>é¦–å…ˆè¿˜è®°å¾— BIT çš„åŒºé—´æ›´æ–°æ–¹å¼ä¹ˆï¼Œåœ¨lå¤„åŠ deltaï¼Œr + 1å¤„å‡å»deltaã€‚å‡è®¾è€ƒè™‘åŒºé—´æ›´æ–°éƒ½æ˜¯ [l, n] çš„ï¼Œé‚£ä¹ˆåœ¨æ—¶é—´åºåˆ—ä¸Šæ¨¡æ‹Ÿ i-th æ•°ç»„é¡¹ çš„å€¼å°±å¾ˆå®¹æ˜“æƒ³åˆ°äº†ï¼šå¯¹äºåœ¨ i ä»¥åŠä¹‹å‰çš„æ›´æ–°(j, a, b, delta) (a &lt;= i), åœ¨æ—¶é—´åºåˆ—å¯¹åº”æ•°ç»„çš„ jå¤„åŠ deltaã€‚è¿™æ ·jæ—¶é—´ä¹‹åçš„æ•°éƒ½è¢«åŠ äº†deltaã€‚</p>
<p>æƒ³åˆ°è¿™é‡Œï¼Œæ—¶é—´åºåˆ—ä¸Šçš„æ¨¡æ‹Ÿå°±å‘¼ä¹‹æ¬²å‡ºäº†ï¼Œæ—¢ç„¶å¯¹åº”æœ‰åŠ ï¼Œè‚¯å®šå¯¹åº”æœ‰å‡ï¼šå¯¹äº i  ä»¥åŠ i ä¹‹å‰çš„æ‰€æœ‰æ›´æ–° (j, a, b, delta) (b &lt; i)ï¼Œåœ¨åºåˆ—ä¸ŠæŠµæ¶ˆæ‰ï¼Œä¹Ÿå³åœ¨æ—¶é—´åºåˆ—jå¤„å‡deltaï¼Œå› ä¸ºè¿™æ ·çš„æ›´æ–°ä¸åº”è¯¥å½±å“åˆ°æ•°ç»„é¡¹ i çš„æ—¶é—´åºåˆ—ï¼Œè€Œä¸”ä¸€å®šåœ¨ä¹‹å‰è¢«æ›´æ–°ä¸Šå»äº†ã€‚</p>
<p>æ‰€ä»¥å°±å˜æˆäº†è¿™æ ·ä¸€ç§æ–¹å¼ï¼š</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="n">rep</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">n</span><span class="p">){</span>
	<span class="k">for</span><span class="p">(</span><span class="kt">int</span> <span class="nl">j</span><span class="p">:</span><span class="n">ad</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="n">add</span><span class="p">(</span><span class="n">j</span><span class="p">,</span><span class="n">ads</span><span class="p">[</span><span class="n">j</span><span class="p">]);</span>
	<span class="k">for</span><span class="p">(</span><span class="kt">int</span> <span class="nl">j</span><span class="p">:</span><span class="n">rm</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="n">add</span><span class="p">(</span><span class="n">j</span><span class="p">,</span><span class="o">-</span><span class="n">ads</span><span class="p">[</span><span class="n">j</span><span class="p">]);</span>
	<span class="c1">// do you work
</span><span class="c1"></span><span class="p">}</span>
</code></pre></div><p>è¿™é‡Œï¼Œad[i] æ˜¯ [i, r] æ›´æ–°çš„ç´¢å¼•å·ï¼Œrm[i] æ˜¯ [l, i - 1] æ›´æ–°çš„ç´¢å¼•å·ï¼Œadd æ“ä½œæ˜¯fenwick treeçš„åŠ æ“ä½œï¼Œäºæ˜¯æˆ‘ä»¬å¯ä»¥ç”¨sum(j)è®¡ç®—å‡ºä»»ä¸€ä¸ªæ—¶é—´èŠ‚ç‚¹ä¸Ša[i]çš„å€¼ã€‚</p>
<p>åé¢å°±å¾ˆç®€å•äº†ï¼Œå¯¹æ¯ä¸ªiäºŒåˆ†æŸ¥æ‰¾ï¼Œæ‰¾åˆ°å°±è®°ä¸‹æ¥ã€‚æ€»è®¡æ—¶é—´å¤æ‚åº¦åº”è¯¥ä¸º O((kn + m)logm)ã€‚</p>
<p>è¿™é‡Œæ˜æ˜¾æ¯” PBS å¿«äº†ä¸€ç‚¹ï¼Œè¿™æ˜¯å› ä¸º<strong>æ£€æŸ¥åŒºé—´å’ŒåŸåŒºé—´ä¸€è‡´</strong>ã€‚è¿™ä»¶äº‹æƒ…å¾ˆé‡è¦ï¼Œç±»æ¯”åˆ° Meteorsï¼Œè™½ç„¶æˆ‘ä»¬ä¹Ÿèƒ½æ¨¡æ‹Ÿå‡ºä¸€ä¸ªåŒºé—´çš„æ—¶é—´åºåˆ—ï¼Œä½†æ˜¯ä¸€ä¸ªåŒºé—´å¯¹äºç›®æ ‡æ²¡æœ‰æ„ä¹‰ã€‚</p>
<h4 id="segment-tree">Segment Tree</h4>
<p>ä¸ä¸Šé¢ä¸¤ä¸ªä¸åŒçš„æ˜¯ï¼Œè¿™æ˜¯ä¸ªåœ¨çº¿ç®—æ³•ã€‚</p>
<p>æ—¶é—´å¤æ‚åº¦æ˜¯ O(klgm(n + m))ï¼Œä¸è¿‡ç”¨äº†çº¿æ®µæ ‘ï¼Œç©ºé—´å¤æ‚åº¦ä¸º O(kmlgm)ã€‚</p>
<p>è¿™é‡Œçº¿æ®µæ ‘ä¸­è®°å½•äº†ä¸‰ä¸ªå€¼ï¼šlazyåŸŸaddï¼ŒåŒºé—´æœ€å¤§å€¼maxiï¼Œå¯¹åº”çš„æ•°ç»„ç´¢å¼•idã€‚</p>
<p>ä¸€å…±kæ£µçº¿æ®µæ ‘ï¼Œæ¯é¢—çº¿æ®µæ ‘åˆå§‹åŒ–ä¸ºæ•°ç»„ {a_i - fav_j}ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œå¯¹åº”çš„å€¼å¦‚æœä¸ºæ­£æ•°ï¼Œæ‰æœ‰æ£€æŸ¥çš„å¿…è¦ï¼Œå¦‚æœä¸ºè´Ÿæ•°ï¼Œé‚£å‹æ ¹è¿˜æ²¡åˆ°æ£€æŸ¥çš„æ—¶å€™ã€‚</p>
<p>æ­£å·§ï¼Œåˆ©ç”¨çº¿æ®µæ ‘çš„ç»“æ„ï¼Œæˆ‘ä»¬æ£€æŸ¥çº¿æ®µæ ‘çš„rootèŠ‚ç‚¹å°±èƒ½çŸ¥é“è¿™æ£µæ ‘ä¸­å­˜ä¸å­˜åœ¨éœ€è¦æ£€æŸ¥çš„é¡¹ï¼Œè¿™ä¸ªæ“ä½œæ˜¯ O(1) çš„ã€‚è€Œå½“ä¸€ä¸ªæ•°ç»„é¡¹è¢«æ£€æŸ¥è¿‡åï¼Œå®ƒå°†è¢«èµ‹å€¼ä¸º -infï¼Œè¿™æ ·å®ƒæ°¸è¿œä¹Ÿä¸ä¼šè¢«å†æ¬¡æ£€æŸ¥ï¼Œçº¿æ®µæ ‘ä¹Ÿé¡ºåˆ©æ›´æ–°åˆ°ä¸‹ä¸€ä¸ªå¾…æ£€æŸ¥çŠ¶æ€ã€‚</p>
<p>ç”±äºæ¯ä¸ªæ•°ç»„é¡¹å¯¹äºæ¯ä¸ªfavoriteæœ€å¤šè¢«æ£€æŸ¥ä¸€æ¬¡ï¼Œæ‰€ä»¥æ€»è®¡æ£€æŸ¥å¤æ‚åº¦ä¸º O(knlgm)ã€‚</p>
<p>æ›´æ–°å¤æ‚åº¦æ˜¯ O(kmlgm)ï¼Œæ‰€ä»¥æ€»è®¡å¤æ‚åº¦ä¸º O(k(m + n)lgm)ã€‚</p>
<p>è¿™é‡Œåˆ©ç”¨Segment Treeçš„trickä¸€å¼€å§‹è®©æˆ‘ç™¾æ€ä¸å¾—å…¶è§£ï¼Œä¸ºä»€ä¹ˆmeteorsä¸è¡Œè€Œè¿™é‡Œå¯ä»¥ï¼Œæƒ³æ¥æƒ³å»ä¹Ÿæƒ³ä¸å‡ºç¬¬ä¸‰ç§æ–¹å¼ï¼ŒæŠŠmeteorsçš„æŸ¥è¯¢åŒºé—´æ˜ å°„åˆ°æ–¹ä¾¿ä¿®æ”¹çš„ç»“æ„ä¸Šï¼Œæ‰€ä»¥è¿˜æ˜¯å½’ç»“ä¸ºä¹‹å‰æ‰€è¿°çš„ä¸¤ä¸ªåŸå› ã€‚</p>
<h3 id="conclusion">Conclusion</h3>
<p>å¯¹äºæ›´æ–°/æŸ¥è¯¢çš„ä¸€ç³»åˆ—é—®é¢˜ï¼Œä¸šç•Œå¤§ä½¬ä»¬å·²ç»æä¾›äº†å„ç§å„æ ·æœ‰åŠ›çš„æ­¦å™¨ï¼š</p>
<ol>
<li>æ•°æ®ç»“æ„ Segment treeã€Fenwick treeã€Sparse tableï¼Œè¿˜æœ‰æœ€è¿‘æ‰ç ”ç©¶åˆ°çš„ Cartesian tree ç­‰ç­‰</li>
<li>äºŒåˆ†ã€æ•´ä½“äºŒåˆ†ã€è¿˜æ²¡çœ‹è¿‡çš„ CDQ åˆ†æ²»ç­‰ç­‰</li>
</ol>
<p>æŠŠè¿™é‡Œæ•´ç†è¿›è„‘å­é‡Œï¼Œå¤§æ¦‚ä¸‹æ¬¡åˆ·é¢˜çš„æ—¶å€™åº•æ°”ä¹Ÿä¼šè¶³ä¸€äº›ğŸº</p>
<h3 id="reference">Reference</h3>
<p>[1] <a class="link" href="https://www.hackerearth.com/practice/notes/sparse-table/"  target="_blank" rel="noopener"
    >https://www.hackerearth.com/practice/notes/sparse-table/</a></p>
<p>[2] <a class="link" href="https://www.topcoder.com/community/data-science/data-science-tutorials/range-minimum-query-and-lowest-common-ancestor/#Sparse_Table_%28ST%29_algorithm"  target="_blank" rel="noopener"
    >https://www.topcoder.com/community/data-science/data-science-tutorials/range-minimum-query-and-lowest-common-ancestor/#Sparse_Table_(ST)_algorithm</a></p>
<p>[3] <a class="link" href="http://codeforces.com/blog/entry/45578"  target="_blank" rel="noopener"
    >http://codeforces.com/blog/entry/45578</a></p>
<p>[4] <a class="link" href="https://ideone.com/tTO9bD"  target="_blank" rel="noopener"
    >https://ideone.com/tTO9bD</a></p>
<h3 id="appendix">Appendix</h3>
<h4 id="impl-stc">Impl ST/C++</h4>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="cp">#include</span> <span class="cpf">&lt;vector&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;cassert&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;cstring&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;iostream&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;limits&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;type_traits&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;random&gt;</span><span class="cp">
</span><span class="cp"></span><span class="k">using</span> <span class="k">namespace</span> <span class="n">std</span><span class="p">;</span>

<span class="k">namespace</span> <span class="n">st_impl</span> <span class="p">{</span>

<span class="k">template</span> <span class="o">&lt;</span><span class="k">class</span> <span class="nc">T</span><span class="p">,</span> <span class="k">class</span> <span class="nc">F</span><span class="o">&gt;</span>
<span class="k">class</span> <span class="nc">SparseTable</span> <span class="p">{</span>
<span class="k">public</span><span class="o">:</span>
    <span class="k">typedef</span> <span class="n">F</span> <span class="n">func_type</span><span class="p">;</span>
    <span class="k">typedef</span> <span class="kt">unsigned</span> <span class="n">size_type</span><span class="p">;</span>
    <span class="k">typedef</span> <span class="n">T</span> <span class="n">value_type</span><span class="p">;</span>

    <span class="n">SparseTable</span><span class="p">(</span><span class="k">const</span> <span class="n">vector</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;&amp;</span> <span class="n">init</span><span class="p">)</span> <span class="o">:</span> <span class="n">_size</span><span class="p">(</span><span class="n">init</span><span class="p">.</span><span class="n">size</span><span class="p">()),</span> <span class="n">_idx_size</span><span class="p">(</span><span class="n">flsl</span><span class="p">(</span><span class="n">_size</span><span class="p">))</span> <span class="p">{</span>
        <span class="n">table</span><span class="p">.</span><span class="n">resize</span><span class="p">(</span><span class="n">_size</span><span class="p">);</span>
        <span class="k">for</span> <span class="p">(</span><span class="k">auto</span><span class="o">&amp;</span> <span class="nl">row</span> <span class="p">:</span> <span class="n">table</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">row</span><span class="p">.</span><span class="n">resize</span><span class="p">(</span><span class="n">_idx_size</span><span class="p">,</span> <span class="n">func_type</span><span class="o">::</span><span class="n">default_value</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="c1">// initialize sparse table
</span><span class="c1"></span>        <span class="k">for</span> <span class="p">(</span><span class="n">size_type</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">_size</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">table</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">init</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
        <span class="p">}</span>
        <span class="k">for</span> <span class="p">(</span><span class="n">size_type</span> <span class="n">j</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">_idx_size</span><span class="p">;</span> <span class="o">++</span><span class="n">j</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">for</span> <span class="p">(</span><span class="n">size_type</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="n">_size</span> <span class="o">-</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">j</span><span class="p">);</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">table</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">f</span><span class="p">(</span><span class="n">table</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span> <span class="o">-</span> <span class="mi">1</span><span class="p">],</span> <span class="n">table</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">j</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))][</span><span class="n">j</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]);</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="n">SparseTable</span><span class="p">(</span><span class="k">const</span> <span class="n">initializer_list</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;&amp;</span> <span class="n">init</span><span class="p">)</span> <span class="o">:</span> <span class="n">SparseTable</span><span class="p">(</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="p">(</span><span class="n">init</span><span class="p">))</span> <span class="p">{}</span>

    <span class="n">SparseTable</span><span class="p">(</span><span class="k">const</span> <span class="n">vector</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;&amp;</span> <span class="n">init</span><span class="p">,</span> <span class="n">F</span> <span class="n">f</span><span class="p">)</span> <span class="o">:</span> <span class="n">SparseTable</span><span class="p">(</span><span class="n">init</span><span class="p">)</span> <span class="p">{</span> <span class="k">this</span><span class="o">-&gt;</span><span class="n">f</span> <span class="o">=</span> <span class="n">f</span><span class="p">;</span> <span class="p">}</span>
    <span class="n">SparseTable</span><span class="p">(</span><span class="k">const</span> <span class="n">initializer_list</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;&amp;</span> <span class="n">init</span><span class="p">,</span> <span class="n">F</span> <span class="n">f</span><span class="p">)</span> <span class="o">:</span> <span class="n">SparseTable</span><span class="p">(</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="p">(</span><span class="n">init</span><span class="p">),</span> <span class="n">f</span><span class="p">)</span> <span class="p">{}</span>

    <span class="n">T</span> <span class="nf">rangeQuery</span><span class="p">(</span><span class="n">size_type</span> <span class="n">l</span><span class="p">,</span> <span class="n">size_type</span> <span class="n">r</span><span class="p">)</span> <span class="k">const</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">l</span> <span class="o">&lt;=</span> <span class="n">r</span> <span class="o">&amp;&amp;</span> <span class="n">r</span> <span class="o">&lt;</span> <span class="n">_size</span><span class="p">))</span> <span class="p">{</span>
            <span class="k">throw</span> <span class="n">std</span><span class="o">::</span><span class="n">out_of_range</span><span class="p">(</span><span class="s">&#34;Bad query!&#34;</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="c1">// if the function is idempotent, which means f(x, x) = x holds for
</span><span class="c1"></span>        <span class="c1">// all x with definition, then we can deduce that
</span><span class="c1"></span>        <span class="c1">// f(range(l, s), range(t, r)) == f(range(l, r)) always
</span><span class="c1"></span>        <span class="c1">// holds for all l, s, t, r which satisfies l &lt;= t &amp;&amp; s &lt;= r &amp;&amp; t &lt;= s + 1
</span><span class="c1"></span>        <span class="c1">// then rangeQuery will be executed in O(1).
</span><span class="c1"></span>        <span class="c1">// otherwise it should be finished in O(lgN).
</span><span class="c1"></span>        <span class="k">if</span> <span class="p">(</span><span class="n">func_type</span><span class="o">::</span><span class="n">idempotent</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">size_type</span> <span class="n">idx</span> <span class="o">=</span> <span class="n">flsl</span><span class="p">(</span><span class="n">r</span> <span class="o">-</span> <span class="n">l</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
            <span class="k">return</span> <span class="n">f</span><span class="p">(</span><span class="n">table</span><span class="p">[</span><span class="n">l</span><span class="p">][</span><span class="n">idx</span><span class="p">],</span> <span class="n">table</span><span class="p">[</span><span class="n">r</span> <span class="o">-</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">idx</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">][</span><span class="n">idx</span><span class="p">]);</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="n">T</span> <span class="n">res</span> <span class="o">=</span> <span class="n">func_type</span><span class="o">::</span><span class="n">default_value</span><span class="p">;</span>
            <span class="k">for</span> <span class="p">(</span><span class="n">size_type</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">_idx_size</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">size_type</span> <span class="n">idx</span> <span class="o">=</span> <span class="n">_idx_size</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">i</span><span class="p">;</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">l</span> <span class="o">+</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">idx</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">&lt;=</span> <span class="n">r</span><span class="p">)</span> <span class="p">{</span>
                    <span class="n">res</span> <span class="o">=</span> <span class="n">f</span><span class="p">(</span><span class="n">res</span><span class="p">,</span> <span class="n">table</span><span class="p">[</span><span class="n">l</span><span class="p">][</span><span class="n">idx</span><span class="p">]);</span>
                    <span class="n">l</span> <span class="o">+=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">idx</span><span class="p">;</span>
                <span class="p">}</span>
            <span class="p">}</span>
            <span class="k">return</span> <span class="n">res</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>

<span class="k">private</span><span class="o">:</span>
    <span class="n">func_type</span> <span class="n">f</span><span class="p">;</span>

    <span class="n">size_type</span> <span class="n">_size</span><span class="p">;</span>
    <span class="n">size_type</span> <span class="n">_idx_size</span><span class="p">;</span>
    <span class="n">vector</span><span class="o">&lt;</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;&gt;</span> <span class="n">table</span><span class="p">;</span>
<span class="p">};</span>

<span class="p">}</span>  <span class="c1">// namespace st_impl
</span><span class="c1"></span>
<span class="k">template</span> <span class="o">&lt;</span><span class="k">class</span> <span class="nc">T</span><span class="p">,</span> <span class="n">T</span> <span class="n">v</span> <span class="o">=</span> <span class="n">T</span><span class="p">{}</span><span class="o">&gt;</span>
<span class="k">struct</span> <span class="nc">sum_f</span> <span class="p">{</span>
    <span class="k">static</span> <span class="k">constexpr</span> <span class="n">T</span> <span class="n">default_value</span> <span class="o">=</span> <span class="n">v</span><span class="p">;</span>
    <span class="k">static</span> <span class="k">constexpr</span> <span class="kt">bool</span> <span class="n">idempotent</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
    <span class="n">T</span> <span class="nf">operator</span><span class="p">()(</span><span class="k">const</span> <span class="n">T</span><span class="o">&amp;</span> <span class="n">a</span><span class="p">,</span> <span class="k">const</span> <span class="n">T</span><span class="o">&amp;</span> <span class="n">b</span><span class="p">)</span> <span class="k">const</span> <span class="p">{</span> <span class="k">return</span> <span class="n">a</span> <span class="o">+</span> <span class="n">b</span><span class="p">;</span> <span class="p">}</span>
<span class="p">};</span>
<span class="k">template</span> <span class="o">&lt;</span><span class="k">class</span> <span class="nc">T</span><span class="p">,</span> <span class="n">T</span> <span class="n">v</span><span class="o">&gt;</span>
<span class="k">constexpr</span> <span class="k">const</span> <span class="n">T</span> <span class="n">sum_f</span><span class="o">&lt;</span><span class="n">T</span><span class="p">,</span> <span class="n">v</span><span class="o">&gt;::</span><span class="n">default_value</span><span class="p">;</span>

<span class="k">template</span> <span class="o">&lt;</span><span class="k">class</span> <span class="nc">T</span><span class="p">,</span> <span class="n">T</span> <span class="n">v</span> <span class="o">=</span> <span class="n">numeric_limits</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;::</span><span class="n">min</span><span class="p">(),</span>
          <span class="k">typename</span> <span class="o">=</span> <span class="k">typename</span> <span class="n">enable_if</span><span class="o">&lt;</span><span class="n">numeric_limits</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;::</span><span class="n">is_specialized</span><span class="o">&gt;::</span><span class="n">type</span><span class="o">&gt;</span>
<span class="k">struct</span> <span class="nc">max_f</span> <span class="p">{</span>
    <span class="k">static</span> <span class="k">constexpr</span> <span class="n">T</span> <span class="n">default_value</span> <span class="o">=</span> <span class="n">v</span><span class="p">;</span>
    <span class="k">static</span> <span class="k">constexpr</span> <span class="kt">bool</span> <span class="n">idempotent</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
    <span class="n">T</span> <span class="nf">operator</span><span class="p">()(</span><span class="k">const</span> <span class="n">T</span><span class="o">&amp;</span> <span class="n">a</span><span class="p">,</span> <span class="k">const</span> <span class="n">T</span><span class="o">&amp;</span> <span class="n">b</span><span class="p">)</span> <span class="k">const</span> <span class="p">{</span> <span class="k">return</span> <span class="n">max</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">);</span> <span class="p">}</span>
<span class="p">};</span>
<span class="k">template</span> <span class="o">&lt;</span><span class="k">class</span> <span class="nc">T</span><span class="p">,</span> <span class="n">T</span> <span class="n">v</span><span class="p">,</span> <span class="k">typename</span> <span class="n">R</span><span class="o">&gt;</span>
<span class="k">constexpr</span> <span class="k">const</span> <span class="n">T</span> <span class="n">max_f</span><span class="o">&lt;</span><span class="n">T</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">R</span><span class="o">&gt;::</span><span class="n">default_value</span><span class="p">;</span>

<span class="k">template</span> <span class="o">&lt;</span><span class="k">class</span> <span class="nc">T</span><span class="p">,</span> <span class="n">T</span> <span class="n">v</span> <span class="o">=</span> <span class="n">numeric_limits</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;::</span><span class="n">max</span><span class="p">(),</span>
          <span class="k">typename</span> <span class="o">=</span> <span class="k">typename</span> <span class="n">enable_if</span><span class="o">&lt;</span><span class="n">numeric_limits</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;::</span><span class="n">is_specialized</span><span class="o">&gt;::</span><span class="n">type</span><span class="o">&gt;</span>
<span class="k">struct</span> <span class="nc">min_f</span> <span class="p">{</span>
    <span class="k">static</span> <span class="k">constexpr</span> <span class="n">T</span> <span class="n">default_value</span> <span class="o">=</span> <span class="n">v</span><span class="p">;</span>
    <span class="k">static</span> <span class="k">constexpr</span> <span class="kt">bool</span> <span class="n">idempotent</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
    <span class="n">T</span> <span class="nf">operator</span><span class="p">()(</span><span class="k">const</span> <span class="n">T</span><span class="o">&amp;</span> <span class="n">a</span><span class="p">,</span> <span class="k">const</span> <span class="n">T</span><span class="o">&amp;</span> <span class="n">b</span><span class="p">)</span> <span class="k">const</span> <span class="p">{</span> <span class="k">return</span> <span class="n">min</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">);</span> <span class="p">}</span>
<span class="p">};</span>
<span class="k">template</span> <span class="o">&lt;</span><span class="k">class</span> <span class="nc">T</span><span class="p">,</span> <span class="n">T</span> <span class="n">v</span><span class="p">,</span> <span class="k">typename</span> <span class="n">R</span><span class="o">&gt;</span>
<span class="k">constexpr</span> <span class="k">const</span> <span class="n">T</span> <span class="n">min_f</span><span class="o">&lt;</span><span class="n">T</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">R</span><span class="o">&gt;::</span><span class="n">default_value</span><span class="p">;</span>

<span class="kt">uint64_t</span> <span class="nf">gcd</span><span class="p">(</span><span class="kt">uint64_t</span> <span class="n">a</span><span class="p">,</span> <span class="kt">uint64_t</span> <span class="n">b</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">a</span> <span class="o">&lt;</span> <span class="n">b</span><span class="p">)</span> <span class="n">swap</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">);</span>
    <span class="k">while</span> <span class="p">(</span><span class="n">b</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">auto</span> <span class="n">t</span> <span class="o">=</span> <span class="n">b</span><span class="p">;</span>
        <span class="n">b</span> <span class="o">=</span> <span class="n">a</span> <span class="o">%</span> <span class="n">b</span><span class="p">;</span>
        <span class="n">a</span> <span class="o">=</span> <span class="n">t</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="n">a</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">template</span> <span class="o">&lt;</span><span class="k">class</span> <span class="nc">T</span><span class="p">,</span> <span class="n">T</span> <span class="n">v</span> <span class="o">=</span> <span class="n">T</span><span class="p">{},</span> <span class="k">typename</span> <span class="o">=</span> <span class="k">typename</span> <span class="n">enable_if</span><span class="o">&lt;</span><span class="n">numeric_limits</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;::</span><span class="n">is_integer</span><span class="o">&gt;::</span><span class="n">type</span><span class="o">&gt;</span>
<span class="k">struct</span> <span class="nc">gcd_f</span> <span class="p">{</span>
    <span class="k">static</span> <span class="k">constexpr</span> <span class="n">T</span> <span class="n">default_value</span> <span class="o">=</span> <span class="n">v</span><span class="p">;</span>
    <span class="k">static</span> <span class="k">constexpr</span> <span class="kt">bool</span> <span class="n">idempotent</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
    <span class="n">T</span> <span class="nf">operator</span><span class="p">()(</span><span class="k">const</span> <span class="n">T</span><span class="o">&amp;</span> <span class="n">a</span><span class="p">,</span> <span class="k">const</span> <span class="n">T</span><span class="o">&amp;</span> <span class="n">b</span><span class="p">)</span> <span class="k">const</span> <span class="p">{</span> <span class="k">return</span> <span class="n">gcd</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">);</span> <span class="p">}</span>
<span class="p">};</span>
<span class="k">template</span> <span class="o">&lt;</span><span class="k">class</span> <span class="nc">T</span><span class="p">,</span> <span class="n">T</span> <span class="n">v</span><span class="p">,</span> <span class="k">typename</span> <span class="n">R</span><span class="o">&gt;</span>
<span class="k">constexpr</span> <span class="k">const</span> <span class="n">T</span> <span class="n">gcd_f</span><span class="o">&lt;</span><span class="n">T</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">R</span><span class="o">&gt;::</span><span class="n">default_value</span><span class="p">;</span>

<span class="k">template</span> <span class="o">&lt;</span><span class="k">class</span> <span class="nc">T</span><span class="p">,</span> <span class="k">class</span> <span class="nc">F</span> <span class="o">=</span> <span class="n">max_f</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;&gt;</span>
<span class="k">using</span> <span class="n">SparseTable</span> <span class="o">=</span> <span class="n">st_impl</span><span class="o">::</span><span class="n">SparseTable</span><span class="o">&lt;</span><span class="n">T</span><span class="p">,</span> <span class="n">F</span><span class="o">&gt;</span><span class="p">;</span>

<span class="k">template</span> <span class="o">&lt;</span><span class="k">class</span> <span class="nc">F</span><span class="o">&gt;</span>
<span class="kt">void</span> <span class="n">random_test</span><span class="p">(</span><span class="n">string</span> <span class="n">target_func</span><span class="p">)</span> <span class="p">{</span>
    <span class="kt">int</span> <span class="n">n</span> <span class="o">=</span> <span class="mi">400</span><span class="p">;</span>
    <span class="n">vector</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;</span> <span class="n">test</span><span class="p">(</span><span class="n">n</span><span class="p">);</span>

    <span class="c1">// generate random numbers
</span><span class="c1"></span>    <span class="n">random_device</span> <span class="n">r</span><span class="p">;</span>
    <span class="n">default_random_engine</span> <span class="nf">eng</span><span class="p">(</span><span class="n">r</span><span class="p">());</span>
    <span class="n">uniform_int_distribution</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;</span> <span class="n">uniform_dist</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2000</span><span class="p">);</span>

    <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">n</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">test</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">uniform_dist</span><span class="p">(</span><span class="n">eng</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="c1">// query and verify
</span><span class="c1"></span>    <span class="n">F</span> <span class="n">f</span><span class="p">;</span>
    <span class="n">SparseTable</span><span class="o">&lt;</span><span class="kt">int</span><span class="p">,</span> <span class="n">F</span><span class="o">&gt;</span> <span class="n">st_test</span><span class="p">(</span><span class="n">test</span><span class="p">,</span> <span class="n">f</span><span class="p">);</span>

    <span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&#34;Begin random test on &#34;</span> <span class="o">&lt;&lt;</span> <span class="n">target_func</span> <span class="o">&lt;&lt;</span> <span class="s">&#34;!&#34;</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">t</span> <span class="o">=</span> <span class="mi">10</span><span class="p">;</span>
    <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">t</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
        <span class="kt">int</span> <span class="n">l</span> <span class="o">=</span> <span class="n">uniform_dist</span><span class="p">(</span><span class="n">eng</span><span class="p">)</span> <span class="o">%</span> <span class="n">n</span><span class="p">,</span> <span class="n">r</span> <span class="o">=</span> <span class="n">l</span> <span class="o">+</span> <span class="p">((</span><span class="n">uniform_dist</span><span class="p">(</span><span class="n">eng</span><span class="p">)</span> <span class="o">%</span> <span class="p">(</span><span class="n">n</span> <span class="o">-</span> <span class="n">l</span><span class="p">))</span> <span class="o">&gt;&gt;</span> <span class="p">(</span><span class="n">i</span> <span class="o">/</span> <span class="mi">2</span><span class="p">));</span>
        <span class="k">auto</span> <span class="n">to_verify</span> <span class="o">=</span> <span class="n">st_test</span><span class="p">.</span><span class="n">rangeQuery</span><span class="p">(</span><span class="n">l</span><span class="p">,</span> <span class="n">r</span><span class="p">);</span>
        <span class="k">auto</span> <span class="n">expected</span> <span class="o">=</span> <span class="k">decltype</span><span class="p">(</span><span class="n">f</span><span class="p">)</span><span class="o">::</span><span class="n">default_value</span><span class="p">;</span>

        <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">j</span> <span class="o">=</span> <span class="n">l</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;=</span> <span class="n">r</span><span class="p">;</span> <span class="o">++</span><span class="n">j</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">expected</span> <span class="o">=</span> <span class="n">f</span><span class="p">(</span><span class="n">expected</span><span class="p">,</span> <span class="n">test</span><span class="p">[</span><span class="n">j</span><span class="p">]);</span>
        <span class="p">}</span>
        <span class="n">assert</span><span class="p">(</span><span class="n">to_verify</span> <span class="o">==</span> <span class="n">expected</span><span class="p">);</span>
        <span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&#34; + query range(&#34;</span> <span class="o">&lt;&lt;</span> <span class="n">l</span> <span class="o">&lt;&lt;</span> <span class="s">&#34;,&#34;</span> <span class="o">&lt;&lt;</span> <span class="n">r</span> <span class="o">&lt;&lt;</span> <span class="s">&#34;)</span><span class="se">\t</span><span class="s">= &#34;</span> <span class="o">&lt;&lt;</span> <span class="n">to_verify</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&#34;Test passed!&#34;</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">regular_test</span><span class="p">()</span> <span class="p">{</span>
    <span class="n">SparseTable</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;</span> <span class="n">st_max</span><span class="p">({</span><span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">8</span><span class="p">});</span>

    <span class="n">assert</span><span class="p">(</span><span class="n">st_max</span><span class="p">.</span><span class="n">rangeQuery</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span> <span class="o">==</span> <span class="mi">3</span><span class="p">);</span>
    <span class="n">assert</span><span class="p">(</span><span class="n">st_max</span><span class="p">.</span><span class="n">rangeQuery</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">6</span><span class="p">)</span> <span class="o">==</span> <span class="mi">10</span><span class="p">);</span>
    <span class="n">assert</span><span class="p">(</span><span class="n">st_max</span><span class="p">.</span><span class="n">rangeQuery</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">6</span><span class="p">)</span> <span class="o">==</span> <span class="mi">10</span><span class="p">);</span>
    <span class="n">assert</span><span class="p">(</span><span class="n">st_max</span><span class="p">.</span><span class="n">rangeQuery</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span> <span class="o">==</span> <span class="mi">5</span><span class="p">);</span>

    <span class="n">SparseTable</span><span class="o">&lt;</span><span class="kt">int</span><span class="p">,</span> <span class="n">min_f</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;&gt;</span> <span class="n">st_min</span><span class="p">({</span><span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">8</span><span class="p">});</span>

    <span class="n">assert</span><span class="p">(</span><span class="n">st_min</span><span class="p">.</span><span class="n">rangeQuery</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">);</span>
    <span class="n">assert</span><span class="p">(</span><span class="n">st_min</span><span class="p">.</span><span class="n">rangeQuery</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">6</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">);</span>
    <span class="n">assert</span><span class="p">(</span><span class="n">st_min</span><span class="p">.</span><span class="n">rangeQuery</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">6</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">);</span>
    <span class="n">assert</span><span class="p">(</span><span class="n">st_min</span><span class="p">.</span><span class="n">rangeQuery</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">);</span>

    <span class="n">SparseTable</span><span class="o">&lt;</span><span class="kt">int</span><span class="p">,</span> <span class="n">sum_f</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;&gt;</span> <span class="n">st_sum</span><span class="p">({</span><span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">8</span><span class="p">});</span>

    <span class="n">assert</span><span class="p">(</span><span class="n">st_sum</span><span class="p">.</span><span class="n">rangeQuery</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span> <span class="o">==</span> <span class="mi">6</span><span class="p">);</span>
    <span class="n">assert</span><span class="p">(</span><span class="n">st_sum</span><span class="p">.</span><span class="n">rangeQuery</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">6</span><span class="p">)</span> <span class="o">==</span> <span class="mi">25</span><span class="p">);</span>
    <span class="n">assert</span><span class="p">(</span><span class="n">st_sum</span><span class="p">.</span><span class="n">rangeQuery</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">6</span><span class="p">)</span> <span class="o">==</span> <span class="mi">31</span><span class="p">);</span>
    <span class="n">assert</span><span class="p">(</span><span class="n">st_sum</span><span class="p">.</span><span class="n">rangeQuery</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span> <span class="o">==</span> <span class="mi">9</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
    <span class="n">regular_test</span><span class="p">();</span>

    <span class="n">random_test</span><span class="o">&lt;</span><span class="n">max_f</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;&gt;</span><span class="p">(</span><span class="s">&#34;max&#34;</span><span class="p">);</span>
    <span class="n">random_test</span><span class="o">&lt;</span><span class="n">min_f</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;&gt;</span><span class="p">(</span><span class="s">&#34;min&#34;</span><span class="p">);</span>
    <span class="n">random_test</span><span class="o">&lt;</span><span class="n">sum_f</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;&gt;</span><span class="p">(</span><span class="s">&#34;sum&#34;</span><span class="p">);</span>
    <span class="n">random_test</span><span class="o">&lt;</span><span class="n">gcd_f</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;&gt;</span><span class="p">(</span><span class="s">&#34;gcd&#34;</span><span class="p">);</span>

    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div><h4 id="selective-additions--pbs-c">Selective Additions / PBS C++</h4>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="cp">#include</span> <span class="cpf">&lt;iostream&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;cstdio&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;cstdlib&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;algorithm&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;vector&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;climits&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;utility&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;queue&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;map&gt;</span><span class="cp">
</span><span class="cp"></span>
<span class="k">using</span> <span class="k">namespace</span> <span class="n">std</span><span class="p">;</span>

<span class="cp">#define defv(alias, type) using v##alias = vector&lt;type&gt;
</span><span class="cp">#define defvv(alias, type) using vv##alias = vector&lt;vector&lt;type&gt;&gt;
</span><span class="cp"></span>
<span class="k">using</span> <span class="n">ii</span> <span class="o">=</span> <span class="n">pair</span><span class="o">&lt;</span><span class="kt">int</span><span class="p">,</span> <span class="kt">int</span><span class="o">&gt;</span><span class="p">;</span>
<span class="k">using</span> <span class="n">iii</span> <span class="o">=</span> <span class="n">pair</span><span class="o">&lt;</span><span class="kt">int</span><span class="p">,</span> <span class="n">ii</span><span class="o">&gt;</span><span class="p">;</span>

<span class="n">defv</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="kt">int</span><span class="p">);</span>
<span class="n">defvv</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="kt">int</span><span class="p">);</span>
<span class="n">defv</span><span class="p">(</span><span class="n">ii</span><span class="p">,</span> <span class="n">ii</span><span class="p">);</span>
<span class="n">defvv</span><span class="p">(</span><span class="n">ii</span><span class="p">,</span> <span class="n">ii</span><span class="p">);</span>

<span class="cp">#define forall(i, a, b) for (int i = int(a); i &lt; int(b); ++i)
</span><span class="cp">#define all(a) a.begin(), a.end()
</span><span class="cp">#define inf (IMAX_NT_MAX / 2)
</span><span class="cp">#define sz(a) int(a.size())
</span><span class="cp">#define mp(a, b) make_pair(a, b)
</span><span class="cp"></span>
<span class="k">const</span> <span class="kt">int</span> <span class="n">MAX_N</span> <span class="o">=</span> <span class="mf">1e5</span> <span class="o">+</span> <span class="mi">5</span><span class="p">;</span>

<span class="kt">long</span> <span class="n">a</span><span class="p">[</span><span class="n">MAX_N</span><span class="p">],</span> <span class="n">d</span><span class="p">[</span><span class="n">MAX_N</span><span class="p">];</span>
<span class="kt">int</span> <span class="n">l</span><span class="p">[</span><span class="n">MAX_N</span><span class="p">],</span> <span class="n">r</span><span class="p">[</span><span class="n">MAX_N</span><span class="p">];</span>
<span class="kt">long</span> <span class="n">f</span><span class="p">[</span><span class="mi">5</span><span class="p">];</span>

<span class="kt">int</span> <span class="n">n</span><span class="p">,</span> <span class="n">m</span><span class="p">,</span> <span class="n">k</span><span class="p">;</span>

<span class="kt">long</span> <span class="n">fen</span><span class="p">[</span><span class="n">MAX_N</span><span class="p">];</span>
<span class="kt">int</span> <span class="nf">lowbit</span><span class="p">(</span><span class="kt">int</span> <span class="n">x</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="n">x</span> <span class="o">&amp;</span> <span class="o">-</span><span class="n">x</span><span class="p">;</span> <span class="p">}</span>

<span class="kt">void</span> <span class="nf">fen_update</span><span class="p">(</span><span class="kt">long</span> <span class="o">*</span><span class="n">fen</span><span class="p">,</span> <span class="kt">int</span> <span class="n">idx</span><span class="p">,</span> <span class="kt">int</span> <span class="n">delta</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="n">idx</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">n</span><span class="p">;</span> <span class="n">i</span> <span class="o">+=</span> <span class="n">lowbit</span><span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span> <span class="p">{</span>
        <span class="n">fen</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+=</span> <span class="n">delta</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="kt">long</span> <span class="nf">__fen_get</span><span class="p">(</span><span class="kt">long</span> <span class="o">*</span><span class="n">fen</span><span class="p">,</span> <span class="kt">int</span> <span class="n">r</span><span class="p">)</span> <span class="p">{</span>
    <span class="kt">long</span> <span class="n">res</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="k">while</span> <span class="p">(</span><span class="n">r</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">res</span> <span class="o">+=</span> <span class="n">fen</span><span class="p">[</span><span class="n">r</span><span class="p">];</span>
        <span class="n">r</span> <span class="o">-=</span> <span class="n">lowbit</span><span class="p">(</span><span class="n">r</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="n">res</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">long</span> <span class="nf">fen_get</span><span class="p">(</span><span class="kt">long</span> <span class="o">*</span><span class="n">fen</span><span class="p">,</span> <span class="kt">int</span> <span class="n">l</span><span class="p">,</span> <span class="kt">int</span> <span class="n">r</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="n">__fen_get</span><span class="p">(</span><span class="n">fen</span><span class="p">,</span> <span class="n">r</span><span class="p">)</span> <span class="o">-</span> <span class="n">__fen_get</span><span class="p">(</span><span class="n">fen</span><span class="p">,</span> <span class="n">l</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span> <span class="p">}</span>

<span class="kt">void</span> <span class="nf">fen_range_update</span><span class="p">(</span><span class="kt">long</span> <span class="o">*</span><span class="n">fen</span><span class="p">,</span> <span class="kt">int</span> <span class="n">l</span><span class="p">,</span> <span class="kt">int</span> <span class="n">r</span><span class="p">,</span> <span class="kt">int</span> <span class="n">delta</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">fen_update</span><span class="p">(</span><span class="n">fen</span><span class="p">,</span> <span class="n">l</span><span class="p">,</span> <span class="n">delta</span><span class="p">);</span>
    <span class="n">fen_update</span><span class="p">(</span><span class="n">fen</span><span class="p">,</span> <span class="n">r</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="n">delta</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">long</span> <span class="nf">fen_point_get</span><span class="p">(</span><span class="kt">long</span> <span class="o">*</span><span class="n">fen</span><span class="p">,</span> <span class="kt">int</span> <span class="n">i</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="n">__fen_get</span><span class="p">(</span><span class="n">fen</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span> <span class="p">}</span>

<span class="kt">void</span> <span class="nf">fen_reset</span><span class="p">(</span><span class="kt">long</span> <span class="o">*</span><span class="n">fen</span><span class="p">)</span> <span class="p">{</span> <span class="n">forall</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span> <span class="n">fen</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="p">}</span>

<span class="kr">inline</span> <span class="kt">int</span> <span class="nf">fls</span><span class="p">(</span><span class="kt">int</span> <span class="n">x</span><span class="p">)</span> <span class="p">{</span>
    <span class="kt">int</span> <span class="n">r</span> <span class="o">=</span> <span class="mi">32</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">x</span><span class="p">)</span> <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">x</span> <span class="o">&amp;</span> <span class="mh">0xffff0000u</span><span class="p">))</span> <span class="p">{</span>
        <span class="n">x</span> <span class="o">&lt;&lt;=</span> <span class="mi">16</span><span class="p">;</span>
        <span class="n">r</span> <span class="o">-=</span> <span class="mi">16</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">x</span> <span class="o">&amp;</span> <span class="mh">0xff000000u</span><span class="p">))</span> <span class="p">{</span>
        <span class="n">x</span> <span class="o">&lt;&lt;=</span> <span class="mi">8</span><span class="p">;</span>
        <span class="n">r</span> <span class="o">-=</span> <span class="mi">8</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">x</span> <span class="o">&amp;</span> <span class="mh">0xf0000000u</span><span class="p">))</span> <span class="p">{</span>
        <span class="n">x</span> <span class="o">&lt;&lt;=</span> <span class="mi">4</span><span class="p">;</span>
        <span class="n">r</span> <span class="o">-=</span> <span class="mi">4</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">x</span> <span class="o">&amp;</span> <span class="mh">0xc0000000u</span><span class="p">))</span> <span class="p">{</span>
        <span class="n">x</span> <span class="o">&lt;&lt;=</span> <span class="mi">2</span><span class="p">;</span>
        <span class="n">r</span> <span class="o">-=</span> <span class="mi">2</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">x</span> <span class="o">&amp;</span> <span class="mh">0x80000000u</span><span class="p">))</span> <span class="p">{</span>
        <span class="n">x</span> <span class="o">&lt;&lt;=</span> <span class="mi">1</span><span class="p">;</span>
        <span class="n">r</span> <span class="o">-=</span> <span class="mi">1</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="n">r</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="n">t</span><span class="p">[</span><span class="n">MAX_N</span><span class="p">],</span> <span class="n">lb</span><span class="p">[</span><span class="n">MAX_N</span><span class="p">],</span> <span class="n">rb</span><span class="p">[</span><span class="n">MAX_N</span><span class="p">];</span>
<span class="n">vector</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;</span> <span class="n">to_check</span><span class="p">[</span><span class="n">MAX_N</span> <span class="o">+</span> <span class="mi">1</span><span class="p">];</span>
<span class="kt">void</span> <span class="nf">solve</span><span class="p">()</span> <span class="p">{</span>
    <span class="n">sort</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">f</span> <span class="o">+</span> <span class="n">k</span><span class="p">);</span>
    <span class="n">fill_n</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">);</span>
    <span class="n">forall</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span> <span class="n">forall</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">t</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">a</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="n">f</span><span class="p">[</span><span class="n">s</span><span class="p">])</span> <span class="n">t</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="c1">// Parallel Binary Search
</span><span class="c1"></span>    <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">s</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">s</span> <span class="o">&lt;</span> <span class="n">k</span><span class="p">;</span> <span class="o">++</span><span class="n">s</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">forall</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span> <span class="k">if</span> <span class="p">(</span><span class="n">t</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span> <span class="n">lb</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">rb</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">m</span><span class="p">;</span> <span class="p">}</span>
        <span class="n">forall</span><span class="p">(</span><span class="n">rnd</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">fls</span><span class="p">(</span><span class="n">m</span><span class="p">))</span> <span class="p">{</span>
            <span class="n">fen_reset</span><span class="p">(</span><span class="n">fen</span><span class="p">);</span>
            <span class="n">forall</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">m</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="n">to_check</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">clear</span><span class="p">();</span>
            <span class="n">forall</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">t</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="n">to_check</span><span class="p">[(</span><span class="n">lb</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="n">rb</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">].</span><span class="n">push_back</span><span class="p">(</span><span class="n">i</span><span class="p">);</span>
            <span class="p">}</span>
            <span class="n">forall</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">m</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">fen_range_update</span><span class="p">(</span><span class="n">fen</span><span class="p">,</span> <span class="n">l</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">r</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">d</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
                <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="nl">idx</span> <span class="p">:</span> <span class="n">to_check</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">])</span> <span class="p">{</span>
                    <span class="k">auto</span> <span class="n">now</span> <span class="o">=</span> <span class="n">fen_point_get</span><span class="p">(</span><span class="n">fen</span><span class="p">,</span> <span class="n">idx</span><span class="p">);</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">now</span> <span class="o">+</span> <span class="n">a</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">f</span><span class="p">[</span><span class="n">s</span><span class="p">])</span>
                        <span class="n">rb</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
                    <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">now</span> <span class="o">+</span> <span class="n">a</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">f</span><span class="p">[</span><span class="n">s</span><span class="p">])</span>
                        <span class="n">lb</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">2</span><span class="p">;</span>
                    <span class="k">else</span>
                        <span class="n">t</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
                <span class="p">}</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="c1">// reuse fen for counting invalid updates
</span><span class="c1"></span>    <span class="kt">long</span> <span class="n">sum</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">fen_reset</span><span class="p">(</span><span class="n">fen</span><span class="p">);</span>
    <span class="n">forall</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">m</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="n">to_check</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">clear</span><span class="p">();</span>
    <span class="n">forall</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">t</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
            <span class="n">fen_update</span><span class="p">(</span><span class="n">fen</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
        <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">t</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
            <span class="n">to_check</span><span class="p">[</span><span class="n">t</span><span class="p">[</span><span class="n">i</span><span class="p">]].</span><span class="n">push_back</span><span class="p">(</span><span class="n">i</span><span class="p">);</span>
        <span class="n">sum</span> <span class="o">+=</span> <span class="n">a</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
    <span class="p">}</span>

    <span class="n">forall</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">m</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">sum</span> <span class="o">+=</span> <span class="n">d</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">r</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-</span> <span class="n">l</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">fen_get</span><span class="p">(</span><span class="n">fen</span><span class="p">,</span> <span class="n">l</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">r</span><span class="p">[</span><span class="n">i</span><span class="p">]));</span>
        <span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="n">sum</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
        <span class="k">for</span> <span class="p">(</span><span class="k">auto</span> <span class="nl">idx</span> <span class="p">:</span> <span class="n">to_check</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">])</span> <span class="p">{</span>
            <span class="n">fen_update</span><span class="p">(</span><span class="n">fen</span><span class="p">,</span> <span class="n">idx</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
    <span class="n">cin</span> <span class="o">&gt;&gt;</span> <span class="n">n</span> <span class="o">&gt;&gt;</span> <span class="n">m</span> <span class="o">&gt;&gt;</span> <span class="n">k</span><span class="p">;</span>
    <span class="n">forall</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span> <span class="p">{</span> <span class="n">cin</span> <span class="o">&gt;&gt;</span> <span class="n">a</span><span class="p">[</span><span class="n">i</span><span class="p">];</span> <span class="p">}</span>
    <span class="n">forall</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span> <span class="p">{</span> <span class="n">cin</span> <span class="o">&gt;&gt;</span> <span class="n">f</span><span class="p">[</span><span class="n">i</span><span class="p">];</span> <span class="p">}</span>
    <span class="n">forall</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">m</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">cin</span> <span class="o">&gt;&gt;</span> <span class="n">l</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="n">r</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="n">d</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
        <span class="n">l</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">--</span><span class="p">,</span> <span class="n">r</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">--</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="n">solve</span><span class="p">();</span>

    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>
</section>


    <footer class="article-footer">
    
    <section class="article-tags">
        
            <a href="/tags/sparse-table/">sparse table</a>
        
            <a href="/tags/parallel-binary-search/">parallel binary search</a>
        
            <a href="/tags/algorithm/">algorithm</a>
        
    </section>


    
    <section class="article-copyright">
        <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-copyright" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="12" cy="12" r="9" />
  <path d="M14.5 9a3.5 4 0 1 0 0 6" />
</svg>



        <span>Licensed under CC BY-NC-SA 4.0</span>
    </section>
    </footer>


    
        <link 
                rel="stylesheet" 
                href="https://cdn.jsdelivr.net/npm/katex@0.13.13/dist/katex.min.css"integrity="sha384-RZU/ijkSsFbcmivfdRBQDtwuwVqK7GMOw6IMvKyeWL2K5UAlyp6WonmB8m7Jd0Hn"crossorigin="anonymous"
            ><script 
                src="https://cdn.jsdelivr.net/npm/katex@0.13.13/dist/katex.min.js"integrity="sha384-pK1WpvzWVBQiP0/GjnvRxV4mOb0oxFuyRxJlk6vVw146n3egcN5C925NCP7a7BY8"crossorigin="anonymous"
                defer="true"
                >
            </script><script 
                src="https://cdn.jsdelivr.net/npm/katex@0.13.13/dist/contrib/auto-render.min.js"integrity="sha384-vZTG03m&#43;2yp6N6BNi5iM4rW4oIwk5DfcNdFfxkk9ZWpDriOkXX8voJBFrAO7MpVl"crossorigin="anonymous"
                defer="true"
                >
            </script><script>
    window.addEventListener("DOMContentLoaded", () => {
        renderMathInElement(document.querySelector(`.article-content`), {
            delimiters: [
                { left: "$$", right: "$$", display: true },
                { left: "$", right: "$", display: false },
                { left: "\\(", right: "\\)", display: false },
                { left: "\\[", right: "\\]", display: true }
            ]
        });})
</script>
    
</article>

    <aside class="related-contents--wrapper">
    
    
        <h2 class="section-title">ç›¸å…³æ–‡ç« </h2>
        <div class="related-contents">
            <div class="flex article-list--tile">
                
                    
<article class="">
    <a href="/p/manachers-algorithm/">
        
        

        <div class="article-details">
            <h2 class="article-title">æœ€é•¿å›æ–‡å­ä¸² Manacher ç®—æ³• (Longest Palindromic Substring -- Manacher&#39;s Algorithm)</h2>
        </div>
    </a>
</article>
                
                    
<article class="">
    <a href="/p/binary-indexed-tree/">
        
        

        <div class="article-details">
            <h2 class="article-title">äºŒå‰ç´¢å¼•æ ‘/æ ‘çŠ¶æ•°ç»„ (Binary Indexed Tree)</h2>
        </div>
    </a>
</article>
                
                    
<article class="">
    <a href="/p/segment-tree/">
        
        

        <div class="article-details">
            <h2 class="article-title">çº¿æ®µæ ‘ (Segment Tree)</h2>
        </div>
    </a>
</article>
                
                    
<article class="">
    <a href="/p/longest-increasing-subsequence/">
        
        

        <div class="article-details">
            <h2 class="article-title">æœ€é•¿é€’å¢å­åºåˆ— (Longest Increasing Subsequence)</h2>
        </div>
    </a>
</article>
                
                    
<article class="">
    <a href="/p/stoer-wagner-algorithm/">
        
        

        <div class="article-details">
            <h2 class="article-title">æ— å‘å¸¦æƒå›¾å›¾å…¨å±€æœ€å°å‰² Stoer-Wagner ç®—æ³• (Stoer-Wagner Algorithm -- Global Min-Cut in Undirected Weighted Graphs)</h2>
        </div>
    </a>
</article>
                
            </div>
        </div>
    
</aside>

     
     
        
    <script src="https://beaudar.lipk.org/client.js"
        repo="arkbriar/blog"
        issue-term="pathname"
        
        label="comments"
        
        comment-order="desc"
        input-position="top"
        crossorigin="anonymous"
        async
        >
</script>

<style>
    .beaudar {
        max-width: unset;
    }
</style>

<script>
    function setUtterancesTheme(theme) {
        let beaudar = document.querySelector('.beaudar iframe');
        if (beaudar) {
            beaudar.contentWindow.postMessage(
                {
                    type: 'set-theme',
                    theme: `github-${theme}`
                },
                'https://beaudar.lipk.org'
            );
        }
    }

    addEventListener('message', event => {
        if (event.origin !== 'https://beaudar.lipk.org') return;
        setUtterancesTheme(document.documentElement.dataset.scheme)
    });

    window.addEventListener('onColorSchemeChange', (e) => {
        setUtterancesTheme(e.detail)
    })
</script>


    

    <footer class="site-footer">
    <section class="copyright">
        &copy; 
        
            2018 - 
        
        2021 çŸ³æ²‰æºªæ´ -- Ark&#39;s Blog
    </section>
    
    <section class="powerby">
        Built with <a href="https://gohugo.io/" target="_blank" rel="noopener">Hugo</a> <br />
        Theme <b><a href="https://github.com/CaiJimmy/hugo-theme-stack" target="_blank" rel="noopener" data-version="3.2.0">Stack</a></b> designed by <a href="https://jimmycai.com" target="_blank" rel="noopener">Jimmy</a>
    </section>
</footer>


    
<div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">

    
    <div class="pswp__bg"></div>

    
    <div class="pswp__scroll-wrap">

        
        <div class="pswp__container">
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
        </div>

        
        <div class="pswp__ui pswp__ui--hidden">

            <div class="pswp__top-bar">

                

                <div class="pswp__counter"></div>

                <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>

                <button class="pswp__button pswp__button--share" title="Share"></button>

                <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>

                <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>

                
                
                <div class="pswp__preloader">
                    <div class="pswp__preloader__icn">
                        <div class="pswp__preloader__cut">
                            <div class="pswp__preloader__donut"></div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
                <div class="pswp__share-tooltip"></div>
            </div>

            <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
            </button>

            <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
            </button>

            <div class="pswp__caption">
                <div class="pswp__caption__center"></div>
            </div>

        </div>

    </div>

</div><script 
                src="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.js"integrity="sha256-ePwmChbbvXbsO02lbM3HoHbSHTHFAeChekF1xKJdleo="crossorigin="anonymous"
                defer="true"
                >
            </script><script 
                src="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe-ui-default.min.js"integrity="sha256-UKkzOn/w1mBxRmLLGrSeyB4e1xbrp4xylgAWb3M42pU="crossorigin="anonymous"
                defer="true"
                >
            </script><link 
                rel="stylesheet" 
                href="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/default-skin/default-skin.css"integrity="sha256-c0uckgykQ9v5k&#43;IqViZOZKc47Jn7KQil4/MP3ySA3F8="crossorigin="anonymous"
            ><link 
                rel="stylesheet" 
                href="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.css"integrity="sha256-SBLU4vv6CA6lHsZ1XyTdhyjJxCjPif/TRkjnsyGAGnE="crossorigin="anonymous"
            >

            </main>
    
        <aside class="sidebar right-sidebar sticky">
            <section class="widget archives">
                <div class="widget-icon">
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-hash" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <line x1="5" y1="9" x2="19" y2="9" />
  <line x1="5" y1="15" x2="19" y2="15" />
  <line x1="11" y1="4" x2="7" y2="20" />
  <line x1="17" y1="4" x2="13" y2="20" />
</svg>



                </div>
                <h2 class="widget-title section-title">ç›®å½•</h2>
                
                <div class="widget--toc">
                    <nav id="TableOfContents">
  <ol>
    <li>
      <ol>
        <li><a href="#sparse-table">Sparse Table</a>
          <ol>
            <li><a href="#æ ¸å¿ƒåŸç†">æ ¸å¿ƒåŸç†</a></li>
            <li><a href="#st--lca">ST &amp; LCA</a></li>
          </ol>
        </li>
        <li><a href="#parallel-binary-search">Parallel Binary Search</a>
          <ol>
            <li><a href="#motivation-problem">Motivation Problem</a></li>
            <li><a href="#solution">Solution</a></li>
            <li><a href="#hourrank23----selective-additions">Hourrank23 &ndash; Selective Additions</a></li>
            <li><a href="#pbs">PBS</a></li>
            <li><a href="#time-series-simulation">Time Series Simulation</a></li>
            <li><a href="#segment-tree">Segment Tree</a></li>
          </ol>
        </li>
        <li><a href="#conclusion">Conclusion</a></li>
        <li><a href="#reference">Reference</a></li>
        <li><a href="#appendix">Appendix</a>
          <ol>
            <li><a href="#impl-stc">Impl ST/C++</a></li>
            <li><a href="#selective-additions--pbs-c">Selective Additions / PBS C++</a></li>
          </ol>
        </li>
      </ol>
    </li>
  </ol>
</nav>
                </div>
            </section>
        </aside>
    

        </div>
        <script 
                src="https://cdn.jsdelivr.net/npm/node-vibrant@3.1.5/dist/vibrant.min.js"integrity="sha256-5NovOZc4iwiAWTYIFiIM7DxKUXKWvpVEuMEPLzcm5/g="crossorigin="anonymous"
                defer="false"
                >
            </script><script type="text/javascript" src="/ts/main.js" defer></script>
<script>
    (function () {
        const customFont = document.createElement('link');
        customFont.href = "https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&display=swap";

        customFont.type = "text/css";
        customFont.rel = "stylesheet";

        document.head.appendChild(customFont);
    }());
</script>

    </body>
</html>
