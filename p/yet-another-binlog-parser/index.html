<!DOCTYPE html>
<html lang="zh-cn">
    <head><meta charset='utf-8'>
<meta name='viewport' content='width=device-width, initial-scale=1'><meta name='description' content='Although the article was originally written in Chinese, with the help of ChatGPT, I was able to provide an English translation. If you want to read the English version, please jump to here for reading. ä¸ºä»€ä¹ˆè¦å†é€ ä¸€ä¸ªè½®å­ï¼Ÿ é€ è½®å­æ˜¯ç¨‹åºå‘˜çš„æµªæ¼«ï¼ğŸ¥° åœ¨å‰ä¸œå®¶å·¥ä½œçš„æ—¶å€™ï¼Œæˆ‘è®¾'><title>åˆä¸€ä¸ª binlog è§£æå™¨ -- Yet Another Binlog Parser</title>

<link rel='canonical' href='https://blog.crazyark.me/p/yet-another-binlog-parser/'>

<link rel="stylesheet" href="/scss/style.min.css"><meta property='og:title' content='åˆä¸€ä¸ª binlog è§£æå™¨ -- Yet Another Binlog Parser'>
<meta property='og:description' content='Although the article was originally written in Chinese, with the help of ChatGPT, I was able to provide an English translation. If you want to read the English version, please jump to here for reading. ä¸ºä»€ä¹ˆè¦å†é€ ä¸€ä¸ªè½®å­ï¼Ÿ é€ è½®å­æ˜¯ç¨‹åºå‘˜çš„æµªæ¼«ï¼ğŸ¥° åœ¨å‰ä¸œå®¶å·¥ä½œçš„æ—¶å€™ï¼Œæˆ‘è®¾'>
<meta property='og:url' content='https://blog.crazyark.me/p/yet-another-binlog-parser/'>
<meta property='og:site_name' content='çŸ³æ²‰æºªæ´ -- Ark&#39;s Blog'>
<meta property='og:type' content='article'><meta property='article:section' content='Post' /><meta property='article:tag' content='binlog' /><meta property='article:published_time' content='2023-02-03T13:56:33&#43;08:00'/><meta property='article:modified_time' content='2023-02-03T13:56:33&#43;08:00'/><meta property='og:image' content='https://blog.crazyark.me/p/yet-another-binlog-parser/img/cover.png' />
<meta name="twitter:site" content="@ImperiusDs">
    <meta name="twitter:creator" content="@ImperiusDs"><meta name="twitter:title" content="åˆä¸€ä¸ª binlog è§£æå™¨ -- Yet Another Binlog Parser">
<meta name="twitter:description" content="Although the article was originally written in Chinese, with the help of ChatGPT, I was able to provide an English translation. If you want to read the English version, please jump to here for reading. ä¸ºä»€ä¹ˆè¦å†é€ ä¸€ä¸ªè½®å­ï¼Ÿ é€ è½®å­æ˜¯ç¨‹åºå‘˜çš„æµªæ¼«ï¼ğŸ¥° åœ¨å‰ä¸œå®¶å·¥ä½œçš„æ—¶å€™ï¼Œæˆ‘è®¾"><meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:image" content='https://blog.crazyark.me/p/yet-another-binlog-parser/img/cover.png' />
    </head>
    <body class="
    article-page has-toc
">
    <script>
        (function() {
            const colorSchemeKey = 'StackColorScheme';
            if(!localStorage.getItem(colorSchemeKey)){
                localStorage.setItem(colorSchemeKey, "auto");
            }
        })();
    </script><script>
    (function() {
        const colorSchemeKey = 'StackColorScheme';
        const colorSchemeItem = localStorage.getItem(colorSchemeKey);
        const supportDarkMode = window.matchMedia('(prefers-color-scheme: dark)').matches === true;

        if (colorSchemeItem == 'dark' || colorSchemeItem === 'auto' && supportDarkMode) {
            

            document.documentElement.dataset.scheme = 'dark';
        } else {
            document.documentElement.dataset.scheme = 'light';
        }
    })();
</script>
<div class="container main-container flex 
    
        extended
    
">
    
        <div id="article-toolbar">
            <a href="https://blog.crazyark.me" class="back-home">
                <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-chevron-left" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <polyline points="15 6 9 12 15 18" />
</svg>



                <span>è¿”å›</span>
            </a>
        </div>
    
<main class="main full-width">
    <article class="has-image main-article">
    <header class="article-header">
        <div class="article-image">
            <a href="/p/yet-another-binlog-parser/">
                <img src="/p/yet-another-binlog-parser/img/cover_hue5491a8376b6bfd0d21ba4cd4ca85181_362715_800x0_resize_box_3.png"
                        srcset="/p/yet-another-binlog-parser/img/cover_hue5491a8376b6bfd0d21ba4cd4ca85181_362715_800x0_resize_box_3.png 800w, /p/yet-another-binlog-parser/img/cover_hue5491a8376b6bfd0d21ba4cd4ca85181_362715_1600x0_resize_box_3.png 1600w"
                        width="800" 
                        height="412" 
                        loading="lazy"
                        alt="Featured image of post åˆä¸€ä¸ª binlog è§£æå™¨ -- Yet Another Binlog Parser" />
                
            </a>
        </div>
    

    <div class="article-details">
    
    <header class="article-category">
        
            <a href="/categories/golang/" >
                Golang
            </a>
        
            <a href="/categories/mysql/" >
                MySQL
            </a>
        
    </header>
    

    <h2 class="article-title">
        <a href="/p/yet-another-binlog-parser/">åˆä¸€ä¸ª binlog è§£æå™¨ -- Yet Another Binlog Parser</a>
    </h2>

    

    
    <footer class="article-time">
        
            <div>
                <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-calendar-time" width="56" height="56" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <path d="M11.795 21h-6.795a2 2 0 0 1 -2 -2v-12a2 2 0 0 1 2 -2h12a2 2 0 0 1 2 2v4" />
  <circle cx="18" cy="18" r="4" />
  <path d="M15 3v4" />
  <path d="M7 3v4" />
  <path d="M3 11h16" />
  <path d="M18 16.496v1.504l1 1" />
</svg>
                <time class="article-time--published">Feb 03, 2023</time>
            </div>
        

        
            <div>
                <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-clock" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="12" cy="12" r="9" />
  <polyline points="12 7 12 12 15 15" />
</svg>



                <time class="article-time--reading">
                    é˜…è¯»æ—¶é•¿: 9 åˆ†é’Ÿ
                </time>
            </div>
        
    </footer>
    
</div>
</header>

    <section class="article-content">
    <p>Although the article was originally written in Chinese, with the help of ChatGPT, I was able to provide an English translation. If you want to read the English version, please jump to <a class="link" href="#why-do-we-need-to-reinvent-the-wheel" >here</a> for reading.</p>
<h2 id="ä¸ºä»€ä¹ˆè¦å†é€ ä¸€ä¸ªè½®å­">ä¸ºä»€ä¹ˆè¦å†é€ ä¸€ä¸ªè½®å­ï¼Ÿ</h2>
<blockquote>
<p>é€ è½®å­æ˜¯ç¨‹åºå‘˜çš„æµªæ¼«ï¼ğŸ¥°</p>
</blockquote>
<p>åœ¨å‰ä¸œå®¶å·¥ä½œçš„æ—¶å€™ï¼Œæˆ‘è®¾è®¡äº†ä¸€ä¸ªåˆ†å¸ƒå¼åœºæ™¯ä¸‹çš„å¤‡ä»½æ¢å¤æ–¹æ¡ˆéœ€è¦è§£æå’Œæ“ä½œ binlogã€‚å½“æ—¶ï¼Œæˆ‘æ¯”è¾ƒæƒ³è¦ä¸€ä¸ªå¹²å‡€æ²¡æœ‰ä¾èµ–çš„å·¥å…·ï¼Œå› æ­¤æ²¡æœ‰é€‰æ‹©ç”¨æˆç†Ÿçš„ Java çš„åº“ï¼Œè€Œä½¿ç”¨ Go æ¥è¿›è¡Œäº†å®ç°ã€‚åœ¨å®ç°çš„è¿‡ç¨‹ä¸­ï¼Œæˆ‘å°è¯•äº†ä¸€äº›æ¯”è¾ƒæœ‰æ„æ€çš„æ–¹å¼ã€‚æœ€ç»ˆæ•ˆæœæ˜¯æˆ‘ç”¨ä¸€å‘¨æ—¶é—´ç³Šå®Œäº†æ•´ä¸ªè§£æéƒ¨åˆ†ï¼Œå¹¶ä¸”æ”¯æŒäº†åƒæ¨¡ç³Šæœç´¢ç­‰çš„ä¸€äº›æ¯”è¾ƒæœ‰æ„æ€çš„åŠŸèƒ½ï¼Œå ªå ªèµ¶åœ¨è·‘è·¯å‰å®Œæˆã€‚æœ¬æ–‡ä¸»è¦æ˜¯è®°å½•ä¸€ä¸‹å½“æ—¶çš„ä¸€äº›æƒ³æ³•å’Œå…¶ä¸­ä¸€äº›æœ‰è¶£çš„éƒ¨åˆ†ã€‚</p>
<p>æœ¬æ–‡çš„ä»£ç <a class="link" href="https://github.com/polardb/polardbx-operator/tree/main/pkg/binlogtool"  target="_blank" rel="noopener"
    >åœ¨ Github ä¸Š</a>ï¼Œæ„Ÿè°¢å‰å¸åŒäº‹ä»¬ç»§ç»­ç»´æŠ¤å¹¶æœ€ç»ˆå°†å®ƒå¼€æºã€‚</p>
<h2 id="ç®€å•ä»‹ç»-binlog">ç®€å•ä»‹ç» Binlog</h2>
<p>Binlog æ˜¯ binary log çš„ç¼©å†™ï¼Œé€šå¸¸æŒ‡ MySQL ä¸­å®ç°çš„äºŒè¿›åˆ¶æ—¥å¿—ã€‚Binlog åŒ…å«äº†ä¸€ç³»åˆ—çš„ç”¨æ¥æè¿°æ•°æ®åº“å˜æ›´æƒ…å†µçš„<strong>äº‹ä»¶</strong>ï¼Œä¾‹å¦‚å»ºè¡¨ã€åˆ è¡¨ã€å¢åˆ æ”¹æŸ¥ç­‰ç­‰ã€‚åœ¨ binlog ä¸­ï¼Œæ¯ä¸€ä¸ªäº‹ä»¶éƒ½è¢«ç¼–ç æˆä¸€æ®µè¿ç»­çš„äºŒè¿›åˆ¶å†…å®¹ï¼Œå…¶ä¸­åŒ…å«äº†ï¼š</p>
<ul>
<li>å›ºå®šçš„äº‹ä»¶å¤´ï¼ŒåŒ…å«äº†äº‹ä»¶ç±»å‹ã€æ—¶é—´æˆ³ã€äº‹ä»¶é•¿åº¦ç­‰ç­‰ï¼›</li>
<li>äº‹ä»¶ä½“ï¼Œå¯¹æ¯ä¸€ä¸ªä¸åŒçš„äº‹ä»¶ç±»å‹äº‹ä»¶ä½“çš„å†…å®¹å’Œç¼–ç æ–¹å¼éƒ½ä¸åŒï¼›</li>
</ul>
<p><figure 
	
		class="gallery-image" 
		style="
			flex-grow: 94; 
			flex-basis: 227px"
	>
	<a href="/p/yet-another-binlog-parser/img/binlog_event_header.png" data-size="340x358">
		<img src="/p/yet-another-binlog-parser/img/binlog_event_header.png"
			width="340"
			height="358"
			srcset="/p/yet-another-binlog-parser/img/binlog_event_header_hufa6fa0b91f889c0460e4f242276b284d_45436_480x0_resize_box_3.png 480w, /p/yet-another-binlog-parser/img/binlog_event_header_hufa6fa0b91f889c0460e4f242276b284d_45436_1024x0_resize_box_3.png 1024w"
			loading="lazy"
			alt="Binlog äº‹ä»¶å¤´">
	</a>
	
	<figcaption>Binlog äº‹ä»¶å¤´</figcaption>
	
</figure></p>
<p>Binlog è§£æå™¨çš„å·¥ä½œå°±æ˜¯æŠŠç¼–ç åçš„äº‹ä»¶è§£ææˆä¸€ä¸ªä¸ªå†…å­˜ä¸­ç¨‹åºå¯æ“ä½œçš„å¯¹è±¡ã€‚å€¼å¾—æ³¨æ„çš„æ˜¯ï¼Œåœ¨ binlog çš„è¡åŒ–è¿‡ç¨‹ä¸­ï¼Œå‡ºç°å‡ ä¸ªä¸åŒçš„ç‰ˆæœ¬ï¼Œå®ƒä»¬åˆ†åˆ«æ˜¯ v1, v3 å’Œ v4ã€‚å…¶ä¸­ v2 ä»æ¥æ²¡æœ‰æ­£å¼å‘å¸ƒè¿‡ï¼Œå› æ­¤å¯ä»¥å¿½ç•¥[1]ã€‚</p>
<p>å…³äº binlog çš„è¯¦ç»†ä»‹ç»ç½‘ä¸Šæœ‰å¾ˆå¤šèµ„æ–™ï¼Œè¿™é‡Œä¸å†èµ˜è¿°ã€‚ä½ å¯ä»¥å‚è€ƒ<a class="link" href="https://dev.mysql.com/doc/refman/8.0/en/binary-log.html"  target="_blank" rel="noopener"
    >å®˜æ–¹æ–‡æ¡£</a>æˆ–æ˜¯å…¶ä»–èµ„æ–™ã€‚</p>
<h2 id="ä¸€äº›æœ‰è¶£çš„å°è¯•">ä¸€äº›æœ‰è¶£çš„å°è¯•</h2>
<p>é€šå¸¸æ¥è¯´ï¼Œè§£æå™¨è¿™ç§ä¸œè¥¿éƒ½æ˜¯ä½“åŠ›æ´»ã€‚ç‰¹åˆ«æ˜¯é’ˆå¯¹ binlog è¿™ç§ç¼–ç æ–¹å¼ç¨³å®šã€äº‹ä»¶æ•°é‡å‡ ä¹å›ºå®šçš„æ—¥å¿—ï¼Œå®ç°ä¸€ä¸ªè§£æå™¨æœ€å¥½çš„åŠæ³•å°±æ˜¯å¯¹æ¯ä¸€ä¸ªäº‹ä»¶ç¡¬ç¼–ç ä¸€ä¸ªè§£æå‡½æ•°ï¼Œä¾‹å¦‚ <code>go-mysql</code> ä¸­å¯¹ <code>ROWS_EVENT</code> çš„<a class="link" href="https://github.com/go-mysql-org/go-mysql/blob/master/replication/row_event.go#L86-L145"  target="_blank" rel="noopener"
    >è§£ç å‡½æ•°</a>çš„å®ç°ã€‚è¿™æ ·çš„å®ç°æ–¹å¼æ€§èƒ½å¥½ï¼Œä½†æ˜¯é˜…è¯»èµ·æ¥éå¸¸è´¹åŠ²ã€‚åŒæ—¶ï¼Œå› ä¸º Go â€œå¤§é“è‡³ç®€â€çš„é”™è¯¯å¤„ç†æ–¹å¼ï¼Œç¼–å†™å‡ºæ¥çš„ä»£ç å¸¸å¸¸åˆ°å¤„éƒ½æ˜¯ <code>if err != nil</code>ã€‚è€Œä¸”äºŒè¿›åˆ¶ç¼–è§£ç çš„è°ƒè¯•å®åœ¨æ˜¯è´¹åŠ²ï¼Œæƒ³è¦å°½å¿«å®ç°è¿«ä½¿æˆ‘è€ƒè™‘ä¸€äº›å…¶ä»–çš„æ–¹æ³•ã€‚</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">func</span> <span class="p">(</span><span class="nx">e</span> <span class="o">*</span><span class="nx">TableMapEvent</span><span class="p">)</span> <span class="nf">Decode</span><span class="p">(</span><span class="nx">data</span> <span class="p">[]</span><span class="kt">byte</span><span class="p">)</span> <span class="kt">error</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// ...
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">	<span class="kd">var</span> <span class="nx">err</span> <span class="kt">error</span>
</span></span><span class="line"><span class="cl">	<span class="kd">var</span> <span class="nx">metaData</span> <span class="p">[]</span><span class="kt">byte</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">metaData</span><span class="p">,</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">n</span><span class="p">,</span> <span class="nx">err</span> <span class="p">=</span> <span class="nf">LengthEncodedString</span><span class="p">(</span><span class="nx">data</span><span class="p">[</span><span class="nx">pos</span><span class="p">:]);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="nx">errors</span><span class="p">.</span><span class="nf">Trace</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">err</span> <span class="p">=</span> <span class="nx">e</span><span class="p">.</span><span class="nf">decodeMeta</span><span class="p">(</span><span class="nx">metaData</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="nx">errors</span><span class="p">.</span><span class="nf">Trace</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="nx">pos</span> <span class="o">+=</span> <span class="nx">n</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// ...
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">err</span> <span class="p">=</span> <span class="nx">e</span><span class="p">.</span><span class="nf">decodeOptionalMeta</span><span class="p">(</span><span class="nx">data</span><span class="p">[</span><span class="nx">pos</span><span class="p">:]);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><h3 id="è¿­ä»£å™¨æ¥å£">è¿­ä»£å™¨æ¥å£</h3>
<p>ç›¸æ¯”äºå›è°ƒæ¥å£ï¼Œæˆ‘æ›´å–œæ¬¢è¿­ä»£å™¨å¼çš„æ¥å£ã€‚å› æ­¤ï¼Œåœ¨æˆ‘çš„å®ç°ä¸­ï¼Œæ¥å£æ˜¯è¿™æ ·çš„ï¼š</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">type</span> <span class="nx">LogEventScanner</span> <span class="kd">interface</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nf">Next</span><span class="p">()</span> <span class="p">(</span><span class="nx">EventOffset</span><span class="p">,</span> <span class="nx">event</span><span class="p">.</span><span class="nx">LogEvent</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><h3 id="å£°æ˜å¼çš„è§£æå™¨">å£°æ˜å¼çš„è§£æå™¨</h3>
<p>ç»è¿‡æˆ‘ä¸€ç•ªç ”ç©¶ä¹‹åï¼Œæˆ‘å‘ç°è™½ç„¶æ•´ä¸ªç¼–ç æ–¹å¼çœ‹èµ·æ¥å¾ˆå¤æ‚ï¼Œä½†å¤§éƒ¨åˆ†éƒ½æ˜¯ä¸€äº›å›ºå®šçš„ç»„åˆã€‚ä¾‹å¦‚ï¼Œå¯¹å„ç§æ•´æ•°çš„ç¼–ç é€šå¸¸éƒ½æ˜¯ä¸€æ ·çš„ç»å…¸ variable-length ç¼–ç ï¼Œè€Œå¯¹å­—ç¬¦ä¸²çš„ç¼–ç åˆ™å¤§æ¦‚ç‡æ˜¯ä¸‹é¢å‡ ç§æ–¹å¼çš„å…¶ä¸­ä¸€ä¸ªï¼š</p>
<ul>
<li>ä¸€ä¸ªç¼–ç åçš„æ•´æ•°ä»£è¡¨é•¿åº¦ï¼Œåé¢æ˜¯å¯¹åº”é•¿åº¦çš„å­—èŠ‚</li>
<li>NUL ç»“å°¾çš„å­—èŠ‚ä¸²</li>
<li>å’Œç¬¬ä¸€ç§æ–¹å¼ä¸€æ ·ï¼ŒåŒæ—¶ç»“å°¾æœ‰ NUL</li>
</ul>
<p>æ˜¾ç„¶è¿™äº›ç›¸åŒçš„ç¼–ç æ–¹å¼å¯ä»¥å˜æˆä¸€ä¸ªä¸ªå‡½æ•°æ¥è°ƒç”¨ã€‚ä½†æ˜¯ï¼Œä½¿ç”¨å‡½æ•°å¹¶ä¸èƒ½å¤Ÿé¿å…è¿ç»­è€Œç¹ççš„é”™è¯¯å¤„ç†ã€‚å®é™…ä¸Šï¼Œå½“æ—¶çš„æˆ‘å—åˆ° SwiftUI ç­‰æ¡†æ¶çš„å½±å“ï¼Œè„‘ä¸­æ—©å°±æƒ³åˆ°äº†ä¸€ä¸ªæ–¹æ³•ï¼šå®ƒéœ€è¦æŠŠäº‹ä»¶è§£ç æ–¹å¼çš„å£°æ˜å’Œè§£ç åŠ¨ä½œè§£è€¦ï¼Œè¿™æ ·æˆ‘å°±å¯ä»¥ä¸ç”¨åœ¨è°ƒæ•´äº‹ä»¶å¸ƒå±€çš„åŒæ—¶å…³æ³¨é”™è¯¯çš„å¤„ç†äº†ã€‚ç±»ä¼¼åœ°ï¼Œæˆ‘å°†è¿™ç§æ–¹å¼å®ç°çš„è§£æå™¨æˆä¸ºä¸€ä¸ªå£°æ˜å¼çš„è§£æå™¨ã€‚ä¸ SwiftUI ç­‰æ¡†æ¶ç›¸åŒï¼Œä½¿ç”¨è¿™ç§æ–¹å¼ç¼–å†™çš„ä»£ç åœ¨ç®€å•åœºæ™¯ä¸‹éå¸¸ç²¾ç®€ï¼Œä¸”æå¤§åœ°æé«˜äº†å¯è¯»æ€§ã€‚</p>
<p>åœ¨è¿™ç§æ–¹å¼ä¸­ï¼Œäº‹ä»¶çš„è§£æè¿‡ç¨‹ä½¿ç”¨ä¸€ä¸ª <code>Layout</code> å‡½æ•°æ¥å£°æ˜ï¼ˆå®šä¹‰ï¼‰ã€‚ä¹‹æ‰€ä»¥ç”¨å‡½æ•°è€Œä¸æ˜¯ <code>XxxLayout</code> ç»“æ„ä½“ï¼Œæ˜¯å› ä¸ºè¿™ç§æ–¹å¼å¹¶ä¸çµæ´»ã€‚ä½¿ç”¨é—­åŒ…å¯ä»¥å®Œç¾åœ°è§£å†³é—®é¢˜ï¼Œæˆ‘å¯ä»¥åœ¨é—­åŒ…ä¸­å¡å„ç§ä¸´æ—¶çŠ¶æ€ï¼Œå¹¶ä¸”åˆ©ç”¨é—­åŒ…çš„ç‰¹æ€§æŠŠå®ƒä»¬ä¼ åˆ°å„å¤„ã€‚ä»¥ä¸‹æ˜¯ <code>QueryEvent</code> çš„ä¾‹å­ï¼š</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">type</span> <span class="nx">QueryEvent</span> <span class="kd">struct</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">ThreadID</span>   <span class="kt">uint32</span>          <span class="s">`json:&#34;thread_id,omitempty&#34;`</span>
</span></span><span class="line"><span class="cl">	<span class="nx">ExecTime</span>   <span class="kt">uint32</span>          <span class="s">`json:&#34;exec_time&#34;`</span>
</span></span><span class="line"><span class="cl">	<span class="nx">ErrorCode</span>  <span class="kt">uint16</span>          <span class="s">`json:&#34;error_code&#34;`</span>
</span></span><span class="line"><span class="cl">	<span class="nx">Schema</span>     <span class="nx">str</span><span class="p">.</span><span class="nx">Str</span>         <span class="s">`json:&#34;schema&#34;`</span>
</span></span><span class="line"><span class="cl">	<span class="nx">Query</span>      <span class="nx">str</span><span class="p">.</span><span class="nx">Str</span>         <span class="s">`json:&#34;query&#34;`</span>
</span></span><span class="line"><span class="cl">	<span class="nx">StatusVars</span> <span class="nx">StatusVariables</span> <span class="s">`json:&#34;status_vars,omitempty&#34;`</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="p">(</span><span class="nx">d</span> <span class="o">*</span><span class="nx">QueryEvent</span><span class="p">)</span> <span class="nf">Layout</span><span class="p">(</span><span class="nx">version</span> <span class="kt">uint32</span><span class="p">,</span> <span class="nx">code</span> <span class="kt">byte</span><span class="p">,</span> <span class="nx">fde</span> <span class="o">*</span><span class="nx">FormatDescriptionEvent</span><span class="p">)</span> <span class="o">*</span><span class="nx">layout</span><span class="p">.</span><span class="nx">Layout</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="kd">var</span> <span class="nx">schemaLength</span> <span class="kt">uint8</span>
</span></span><span class="line"><span class="cl">	<span class="kd">var</span> <span class="nx">statusVarsLength</span> <span class="kt">uint16</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="nx">layout</span><span class="p">.</span><span class="nf">Decl</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">		<span class="c1">// Post header
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="nx">layout</span><span class="p">.</span><span class="nf">Number</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">d</span><span class="p">.</span><span class="nx">ThreadID</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">		<span class="nx">layout</span><span class="p">.</span><span class="nf">Number</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">d</span><span class="p">.</span><span class="nx">ExecTime</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">		<span class="nx">layout</span><span class="p">.</span><span class="nf">Number</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">schemaLength</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">		<span class="nx">layout</span><span class="p">.</span><span class="nf">Number</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">d</span><span class="p">.</span><span class="nx">ErrorCode</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">		<span class="nx">layout</span><span class="p">.</span><span class="nf">If</span><span class="p">(</span><span class="nx">version</span> <span class="o">==</span> <span class="nx">spec</span><span class="p">.</span><span class="nx">V4</span><span class="p">,</span> <span class="nx">layout</span><span class="p">.</span><span class="nf">Number</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">statusVarsLength</span><span class="p">)),</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="c1">// Payload
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="nx">layout</span><span class="p">.</span><span class="nf">If</span><span class="p">(</span><span class="nx">version</span> <span class="o">==</span> <span class="nx">spec</span><span class="p">.</span><span class="nx">V4</span><span class="p">,</span> <span class="nx">layout</span><span class="p">.</span><span class="nf">Area</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">statusVarsLength</span><span class="p">,</span> <span class="kd">func</span><span class="p">(</span><span class="nx">data</span> <span class="p">[]</span><span class="kt">byte</span><span class="p">)</span> <span class="p">(</span><span class="kt">int</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="nx">statusVarsLength</span><span class="p">),</span> <span class="nx">d</span><span class="p">.</span><span class="nx">StatusVars</span><span class="p">.</span><span class="nf">parseStatusVarsBlock</span><span class="p">(</span><span class="nx">data</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="p">})),</span>
</span></span><span class="line"><span class="cl">		<span class="nx">layout</span><span class="p">.</span><span class="nf">Bytes</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">schemaLength</span><span class="p">,</span> <span class="o">&amp;</span><span class="nx">d</span><span class="p">.</span><span class="nx">Schema</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">		<span class="nx">layout</span><span class="p">.</span><span class="nf">Null</span><span class="p">(),</span>
</span></span><span class="line"><span class="cl">		<span class="nx">layout</span><span class="p">.</span><span class="nf">Bytes</span><span class="p">(</span><span class="nx">layout</span><span class="p">.</span><span class="nf">Infinite</span><span class="p">(),</span> <span class="o">&amp;</span><span class="nx">d</span><span class="p">.</span><span class="nx">Query</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">	<span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>ç›¸ä¿¡å³ä½¿ä½ ç°åœ¨çœ‹ä¸æ‡‚ <code>layout.Number</code> ç­‰çš„æ˜¯ä»€ä¹ˆï¼Œä½ ä¹Ÿèƒ½å¾ˆå¿«ç†è§£è¿™å°±æ˜¯åœ¨è¯´ <code>QUERY_EVENT</code> ç¼–ç åçš„å¸ƒå±€æ˜¯è¿™æ ·çš„ï¼š</p>
<p><figure 
	
		class="gallery-image" 
		style="
			flex-grow: 101; 
			flex-basis: 244px"
	>
	<a href="/p/yet-another-binlog-parser/img/query_event_data.png" data-size="717x705">
		<img src="/p/yet-another-binlog-parser/img/query_event_data.png"
			width="717"
			height="705"
			srcset="/p/yet-another-binlog-parser/img/query_event_data_hu6be4374eb9dd29c1d8f6fc4befaf82c9_62677_480x0_resize_box_3.png 480w, /p/yet-another-binlog-parser/img/query_event_data_hu6be4374eb9dd29c1d8f6fc4befaf82c9_62677_1024x0_resize_box_3.png 1024w"
			loading="lazy"
			alt="QUERY EVENT DATA">
	</a>
	
	<figcaption>QUERY EVENT DATA</figcaption>
	
</figure></p>
<p>ä» <code>layout.Number</code> è°ƒç”¨æ–¹å¼ï¼Œæˆ‘ç›¸ä¿¡ä½ å·²ç»èƒ½çŒœå‡ºè¿™æ˜¯æ€ä¹ˆå®ç°çš„äº† &ndash; å®ƒå°±æ˜¯ä¸€ä¸ªç»‘å®šåˆ° <code>&amp;d.ThreadID</code> è¿™ä¸ª <code>int32</code> ç±»å‹çš„å˜é‡çš„ä¸€ä¸ªè§£ç å™¨ã€‚å¯¹äºä¸åŒçš„ç±»å‹ï¼Œæˆ‘åœ¨ <code>layout</code> åŒ…ä¸­å®ç°äº†ä¸åŒçš„è§£ç å™¨ï¼Œæˆ‘å°†å®ƒä»¬ç§°ä¸º <code>Field</code>ã€‚ä»¥ä¸‹æ˜¯ <code>Number</code> çš„å®ç°ï¼š</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">type</span> <span class="nx">NumberField</span><span class="p">[</span><span class="nx">N</span> <span class="nx">constraints</span><span class="p">.</span><span class="nx">Integer</span> <span class="p">|</span> <span class="nx">constraints</span><span class="p">.</span><span class="nx">Float</span><span class="p">]</span> <span class="kd">struct</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">r</span> <span class="o">*</span><span class="nx">N</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="p">(</span><span class="nx">f</span> <span class="nx">NumberField</span><span class="p">[</span><span class="nx">N</span><span class="p">])</span> <span class="nf">FromBlock</span><span class="p">(</span><span class="nx">data</span> <span class="p">[]</span><span class="kt">byte</span><span class="p">)</span> <span class="p">(</span><span class="kt">int</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nf">checkDataSize</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="nx">unsafe</span><span class="p">.</span><span class="nf">Sizeof</span><span class="p">(</span><span class="nf">N</span><span class="p">(</span><span class="mi">0</span><span class="p">))),</span> <span class="nx">data</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="nx">utils</span><span class="p">.</span><span class="nf">ReadNumberLittleEndianHack</span><span class="p">(</span><span class="nx">f</span><span class="p">.</span><span class="nx">r</span><span class="p">,</span> <span class="nx">data</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="nx">unsafe</span><span class="p">.</span><span class="nf">Sizeof</span><span class="p">(</span><span class="nf">N</span><span class="p">(</span><span class="mi">0</span><span class="p">))),</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="nx">Number</span><span class="p">[</span><span class="nx">N</span> <span class="nx">constraints</span><span class="p">.</span><span class="nx">Integer</span> <span class="p">|</span> <span class="nx">constraints</span><span class="p">.</span><span class="nx">Float</span><span class="p">](</span><span class="nx">r</span> <span class="o">*</span><span class="nx">N</span><span class="p">)</span> <span class="nx">NumberField</span><span class="p">[</span><span class="nx">N</span><span class="p">]</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="nx">NumberField</span><span class="p">[</span><span class="nx">N</span><span class="p">]{</span><span class="nx">r</span><span class="p">:</span> <span class="nx">r</span><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>æœ€åä¾æ ·ç”»è‘«èŠ¦æŠŠæ‰€æœ‰äº‹ä»¶ç±»å‹éƒ½æ”¯æŒäº†å°±è¡Œã€‚åœ¨è¿™ä¸ªè¿‡ç¨‹ä¸­ï¼Œç¹ççš„å‡½æ•°è°ƒç”¨å’Œé”™è¯¯å¤„ç†ä¸å†æ˜¯æˆ‘å†™ç çš„é˜»ç¢ï¼Œåè€Œæ˜¯ MySQL ä¸­æ¶å¿ƒçš„ç¼–ç æ–¹å¼å’Œä¸è¯¦ç»†çš„æ–‡æ¡£ä¸æ—¶é˜»ç¢ç€æˆ‘çš„æ­¥å­ &ndash; å¤§éƒ¨åˆ†æ—¶å€™ï¼Œæˆ‘å¿…é¡»è¦ç¿»ç€ MySQL çš„ä»£ç æ¥ç†è§£ä¸ºä»€ä¹ˆæ˜¯è¿™æ ·ç¼–ç çš„ã€‚</p>
<p>æœ‰ç»†å¿ƒçš„åŒå­¦å¯èƒ½ä¼šé—®äº†ï¼Œè¿™ç§æ–¹å¼ä¼šä¸ä¼šè§£ç æ¯ä¸€ä¸ªäº‹ä»¶éƒ½è¦ç”Ÿæˆä¸€å †çš„ <code>Field</code> å°å¯¹è±¡ï¼Œä¼šä¸ä¼šå¯¹æ€§èƒ½æœ‰å¾ˆå¤§å½±å“ï¼Ÿä½ æ˜¯å¯¹çš„ï¼Œç¡®å®å¾ˆå½±å“ï¼Œä½†ä¹Ÿä¸æ˜¯æ²¡æœ‰åŠæ³• ğŸ¥µã€‚ Binlog çš„ç‰¹æ€§å†³å®šäº†å®ƒçš„è§£æè¿‡ç¨‹ä¸€å®šæ˜¯ä¸€ä¸ªç¡®å®šæ€§çš„è¿‡ç¨‹ï¼Œæ„å‘³ç€åœ¨ç¡®å®šäº†è¦è§£æå“ªæ¡æ—¥å¿—åï¼Œä¸ç®¡æ˜¯æ—¥å¿—ä¸­çš„å“ªä¸ªäº‹ä»¶å®ƒçš„è§£ç è¿‡ç¨‹éƒ½æ˜¯ç¡®å®šçš„ &ndash; è¿™æç¤ºäº†å¯ä»¥å¯¹æ¯ä¸€ä¸ªäº‹ä»¶éƒ½ç¼“å­˜ <code>Layout</code> çš„ç»“æœã€‚åœ¨ç³Šå®Œäº†å¤§éƒ¨åˆ†äº‹ä»¶ä¹‹åï¼Œæˆ‘å°±å®ç°äº†è¿™æ ·çš„ä¸€ä¸ª cacheã€‚æƒ³è¦è¯¦ç»†äº†è§£çš„å¯ä»¥å‚è€ƒçš„ <a class="link" href="https://github.com/polardb/polardbx-operator/blob/main/pkg/binlogtool/binlog/cache.go"  target="_blank" rel="noopener"
    >binlog/cache.go</a> è¿™ä¸ªæ–‡ä»¶ã€‚</p>
<p>æœ€ç»ˆæµ‹è¯•åï¼Œå¤§çº¦æ€§èƒ½æ˜¯å•çº¿ç¨‹å…¨å­—æ®µè§£æçº¦ä¸º 200 MB/sï¼Œæµ‹è¯•ç¯å¢ƒæ˜¯ MacBook Pro 13&rsquo;&rsquo; 2019, Intelã€‚åœ¨æˆ‘çœ‹æ¥æ˜¯å®Œå…¨è¶³å¤Ÿçš„äº†ï¼Œæ¯•ç«Ÿè°å®¶çš„ binlog å†™çš„é€Ÿåº¦æœ‰ 200 MBï¼ˆä¸è€ƒè™‘å¤§äº‹åŠ¡ï¼‰ï¼Œè¿™ä¹ˆå¥½çš„ç£ç›˜è¯·ä¸€å®šé‚®å¯„ç»™æˆ‘æµ‹è¯•ä¸€ä¸‹ã€‚</p>
<h3 id="æ¨¡ç³Šæ¢æµ‹äº‹ä»¶å¤´">æ¨¡ç³Šæ¢æµ‹äº‹ä»¶å¤´</h3>
<p>æœ‰äº†è§£æå™¨ä¹‹åï¼Œæˆ‘å°±å¯ä»¥é€ æˆ‘è‡ªå·±çš„ CLI å·¥å…·äº†ï¼ˆå˜¿å˜¿å˜¿ ğŸ˜ƒï¼‰ã€‚å¦‚æœä½ ç”¨è¿‡ <code>mysqlbinlog</code> è¿™ä¸ªå·¥å…·æ¥æŸ¥çœ‹è¿‡ binlogï¼Œç›¸ä¿¡ä½ ä¸€å®šä¼šç”¨åˆ° <code>--start-position</code> è¿™ä¸ªå‚æ•°æ¥å¿«é€Ÿè·³è½¬åˆ°æŸä¸ªäº‹ä»¶çš„å¼€å¤´ã€‚ç„¶è€Œï¼Œç”±äº binlog æµå¼çš„ç‰¹å¾ï¼Œå¦‚æœä½ æŒ‡å®šçš„ä½ç½®ä¸æ˜¯äº‹ä»¶å¤´ï¼Œ<code>mysqlbinlog</code> å°±æ— æ³•ç»§ç»­è¯»ä¸‹å»äº†ï¼Œå®ƒéå¸¸å…‰æ£åœ°ç›´æ¥æŠ¥é”™äº† :) æ˜¯çš„ï¼Œè¿™å¾ˆè®©äººéš¾å—ã€‚è¿™æ„å‘³ç€æˆ‘å¿…é¡»å¦å¤–å¼€ä¸€ä¸ªè®¡ç®—å™¨å’”å’”ç®—å‡ºäº‹ä»¶ä½ç½®ï¼Œç„¶åå†ä¸¢ç»™ <code>mysqlbinlog</code>ã€‚æ¯å½“è¿™ä¸ªæ—¶å€™ï¼Œæˆ‘éƒ½åœ¨æƒ³å¦‚æœèƒ½éšä¾¿å¸®æˆ‘æ‰¾åˆ°ä¸‹ä¸€ä¸ªäº‹ä»¶è¾“å‡ºå°±å¥½ï¼Œè¿™æ ·æˆ‘å¾ˆå¿«å°±èƒ½äºŒåˆ†æ‰¾åˆ°æƒ³è¦çš„äº‹ä»¶ã€‚</p>
<p>ç†è®ºä¸Šæ¥è¯´ï¼Œä»æµé‡Œé¢æ¢æµ‹äº‹ä»¶çš„äº‹ä»¶å¤´æ˜¯æ²¡æ³•å®ç°çš„ã€‚ä½†å¹¸è¿çš„æ˜¯ï¼Œç°åœ¨çš„åœºæ™¯æ˜¯æ–‡ä»¶ï¼Œè€Œä¸”äº‹ä»¶å¤´é‡Œé¢æ°å¥½ï¼ˆä¸çŸ¥é“æ˜¯ä¸æ˜¯æ•…æ„åœ°ï¼‰ç•™ä¸‹äº†å†—ä½™ä¿¡æ¯ï¼š <code>event_length</code> å’Œ <code>next_position</code> è¿™ä¸¤ä¸ªå­—æ®µã€‚åœ¨è¯»å–æ–‡ä»¶çš„è¿‡ç¨‹ä¸­ï¼Œæˆ‘ä»¬å¾ˆå®¹æ˜“åœ°å°±èƒ½å¾—çŸ¥å½“å‰çš„ä½ç½®ï¼Œä¹Ÿå°±æ˜¯ <code>current_position</code>ã€‚é‚£ä¹ˆæ˜¾è€Œæ˜“è§ï¼Œ<code>current_position + event_length = next_position</code> å¿…é¡»æˆç«‹ã€‚è¿™æ˜¯ä¸€ä¸ªéå¸¸å¼ºçš„ç‰¹å¾ï¼Œå¦‚æœç¬¦åˆçš„è¯ï¼Œå¾ˆå¤§æ¦‚ç‡è¿™ä¸ªä½ç½®æ˜¯ä¸€ä¸ªåˆæ³•çš„äº‹ä»¶å¤´ã€‚å› æ­¤ï¼Œæ¢æµ‹çš„æ–¹å¼å°±å†³å®šæ˜¯å®ƒäº†ï¼å®ç°çš„ä»£ç å¯ä»¥<a class="link" href="https://github.com/polardb/polardbx-operator/blob/0c9db54f02e832b15dc9b163c9bcf1424b2cd32b/pkg/binlogtool/binlog/scan.go#LL122-L208C2"  target="_blank" rel="noopener"
    >çœ‹è¿™é‡Œ</a>ã€‚</p>
<p>é‡Œé¢ç”¨äº†ä¸€ä¸ª <code>ring buffer</code> çš„å°æŠ€å·§æ¥å‡å°‘å†…å­˜å¼€é”€ã€‚æœ€ç»ˆå®ç°çš„æ•ˆæœå°±æ˜¯ï¼Œéšä¾¿æŒ‡å®šä»€ä¹ˆå¼€å§‹ä½ç½®ï¼Œåªè¦ä¸‹ä¸€ä¸ªäº‹ä»¶åœ¨æ¢æµ‹é•¿åº¦å†…éƒ½èƒ½éå¸¸å¿«åœ°æ‰¾åˆ°ï¼</p>
<h2 id="å°¾å£°å’Œä¸‹é›†é¢„å‘Š">å°¾å£°å’Œä¸‹é›†é¢„å‘Š</h2>
<p>å½“ç„¶ï¼Œé€ è½®å­çš„äººæ°¸è¿œä¸ä¼šæ»¡è¶³ï¼Œä¸€äº›èŠ±é‡Œèƒ¡å“¨çš„åŠŸèƒ½ä¹Ÿå¿…ä¸å¯å°‘ï¼Œä¾‹å¦‚äº‹ä»¶è¿‡æ»¤ã€åŸå§‹äº‹ä»¶ã€ç»“æŸä½ç½®ã€äº‹ä»¶æ ¡éªŒã€JSON è¾“å‡ºç­‰ç­‰ã€‚åœ¨è§£æå™¨çš„åŸºç¡€ä¸Šï¼Œæˆ‘åŒæ—¶ç¼–å†™äº†ä¸€ä¸ª 2PC äº‹åŠ¡çš„åˆ†æå·¥å…·ï¼Œç”¨æ¥å®Œæˆæˆ‘ä¸€å¼€å§‹è®²çš„å¤‡ä»½æ¢å¤æ–¹æ¡ˆä¸­çš„ä¸€ä¸ªæ­¥éª¤ï¼ˆæ¯•ç«Ÿæˆ‘è¿˜æ˜¯è¦åƒé¥­çš„ï¼‰ã€‚æœ¬æ–‡ä¸»è¦æ˜¯ç®€å•è®°å½•äº†åœ¨å®ç°è¿™ä¸ªè§£æå™¨è¿‡ç¨‹ä¸­çš„ä¸€äº›æœ‰æ„æ€çš„æ€è€ƒå’Œå°è¯•ã€‚ä¸‹ä¸€ç¯‡åº”è¯¥ä¼šè®²è®²æˆ‘çš„åˆ†å¸ƒå¼å¤‡ä»½æ–¹æ¡ˆï¼Œå®Œå…¨æ— é”å“¦ï¼Œæ•¬è¯·æœŸå¾… ğŸ¥°ã€‚</p>
<p>P.S. æ–¹æ¡ˆä¸“åˆ©åº”è¯¥å¿«ä¸‹æ¥äº†å§ï¼Œè¯·ä¸è¦å‘Šæˆ‘&hellip;</p>
<h2 id="å‚è€ƒæ–‡çŒ®">å‚è€ƒæ–‡çŒ®</h2>
<p>[1] <a class="link" href="https://dev.mysql.com/doc/dev/mysql-server/latest/page_protocol_replication.html#sect_protocol_replication_binlog_version_v4"  target="_blank" rel="noopener"
    >https://dev.mysql.com/doc/dev/mysql-server/latest/page_protocol_replication.html#sect_protocol_replication_binlog_version_v4</a></p>
<p>[2] <a class="link" href="https://github.com/polardb/polardbx-operator/tree/main/pkg/binlogtool"  target="_blank" rel="noopener"
    >https://github.com/polardb/polardbx-operator/tree/main/pkg/binlogtool</a></p>
<blockquote>
<p>Below is the English version translated by the ChatGPT. Thanks for his great contribution!</p>
</blockquote>
<h2 id="why-do-we-need-to-reinvent-the-wheel">Why do we need to reinvent the wheel?</h2>
<blockquote>
<p>Building your own tools is the romance of programmers! ğŸ¥°</p>
</blockquote>
<p>When I was working for my previous employer, I designed a backup and recovery plan for distributed scenarios that required parsing and operating binlog. At the time, I wanted a clean tool without dependencies, so instead of using mature Java libraries, I implemented it in Go. During the implementation process, I tried some interesting approaches. In the end, it took me a week to complete the entire parsing part and support some interesting features such as fuzzy search just before leaving. This article mainly records some of my thoughts at that time and some interesting parts.</p>
<p>This article&rsquo;s code is available on Github (<a class="link" href="https://github.com/polardb/polardbx-operator/tree/main/pkg/binlogtool%29"  target="_blank" rel="noopener"
    >https://github.com/polardb/polardbx-operator/tree/main/pkg/binlogtool)</a>. Thanks to my former colleagues for continuing to maintain it and eventually open sourcing it.</p>
<h2 id="brief-introduction-to-binlog">Brief Introduction to Binlog</h2>
<p>Binlog is short for binary log, which usually refers to the binary logs implemented in MySQL. Binlog contains a series of <strong>events</strong> used to describe changes made to the database, such as creating tables, deleting tables, inserting/updating/deleting data and so on. In binlog, each event is encoded into a continuous segment of binary content that includes:</p>
<ul>
<li>Fixed event header, which includes the event type, timestamp, event length and so on;</li>
<li>Event body, the content and encoding method of which are different for each type of event.</li>
</ul>
<p><figure 
	
		class="gallery-image" 
		style="
			flex-grow: 94; 
			flex-basis: 227px"
	>
	<a href="/p/yet-another-binlog-parser/img/binlog_event_header.png" data-size="340x358">
		<img src="/p/yet-another-binlog-parser/img/binlog_event_header.png"
			width="340"
			height="358"
			srcset="/p/yet-another-binlog-parser/img/binlog_event_header_hufa6fa0b91f889c0460e4f242276b284d_45436_480x0_resize_box_3.png 480w, /p/yet-another-binlog-parser/img/binlog_event_header_hufa6fa0b91f889c0460e4f242276b284d_45436_1024x0_resize_box_3.png 1024w"
			loading="lazy"
			alt="Binlog Event Header">
	</a>
	
	<figcaption>Binlog Event Header</figcaption>
	
</figure></p>
<p>The job of the Binlog parser is to decode encoded events into objects that can be operated on in memory by a program. It&rsquo;s worth noting that during the evolution of binlogs, several different versions have emerged: v1, v3, and v4. Version 2 was never officially released and can therefore be ignored[1].</p>
<p>There are many resources online that provide detailed information about binlogs, so we won&rsquo;t go into further detail here. You can refer to the official documentation or other sources for more information.</p>
<h2 id="some-interesting-attempts">Some interesting attempts</h2>
<p>Generally speaking, a parser is a labor-intensive task. Especially for logs with stable encoding methods and almost fixed number of events like binlog, the best way to implement a parser is to hard-code a parsing function for each event, such as the implementation of the decoding function for <code>ROWS_EVENT</code> in <code>go-mysql</code>. This implementation has good performance but is very difficult to read. At the same time, because Go&rsquo;s error handling approach is &ldquo;simplest thing that could possibly work&rdquo;, code written often contains <code>if err != nil</code> everywhere. Debugging binary encoding and decoding can be quite challenging too. In order to implement it as soon as possible, I had to consider some other methods.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">func</span> <span class="p">(</span><span class="nx">e</span> <span class="o">*</span><span class="nx">TableMapEvent</span><span class="p">)</span> <span class="nf">Decode</span><span class="p">(</span><span class="nx">data</span> <span class="p">[]</span><span class="kt">byte</span><span class="p">)</span> <span class="kt">error</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// ...
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">	<span class="kd">var</span> <span class="nx">err</span> <span class="kt">error</span>
</span></span><span class="line"><span class="cl">	<span class="kd">var</span> <span class="nx">metaData</span> <span class="p">[]</span><span class="kt">byte</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">metaData</span><span class="p">,</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">n</span><span class="p">,</span> <span class="nx">err</span> <span class="p">=</span> <span class="nf">LengthEncodedString</span><span class="p">(</span><span class="nx">data</span><span class="p">[</span><span class="nx">pos</span><span class="p">:]);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="nx">errors</span><span class="p">.</span><span class="nf">Trace</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">err</span> <span class="p">=</span> <span class="nx">e</span><span class="p">.</span><span class="nf">decodeMeta</span><span class="p">(</span><span class="nx">metaData</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="nx">errors</span><span class="p">.</span><span class="nf">Trace</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="nx">pos</span> <span class="o">+=</span> <span class="nx">n</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// ...
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">err</span> <span class="p">=</span> <span class="nx">e</span><span class="p">.</span><span class="nf">decodeOptionalMeta</span><span class="p">(</span><span class="nx">data</span><span class="p">[</span><span class="nx">pos</span><span class="p">:]);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><h3 id="iterator-interface">Iterator Interface</h3>
<p>Compared to callback interfaces, I prefer iterator-style interfaces. Therefore, in my implementation, the interface looks like this:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">type</span> <span class="nx">LogEventScanner</span> <span class="kd">interface</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nf">Next</span><span class="p">()</span> <span class="p">(</span><span class="nx">EventOffset</span><span class="p">,</span> <span class="nx">event</span><span class="p">.</span><span class="nx">LogEvent</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><h3 id="declarative-parser">Declarative Parser</h3>
<p>After my research, I found that although the entire coding method looks very complicated, most of it is a combination of fixed patterns. For example, the encoding for various integers is usually the same classic variable-length encoding, while the encoding for strings is likely to be one of the following methods:</p>
<ul>
<li>
<p>An encoded integer represents its length, followed by corresponding bytes</p>
</li>
<li>
<p>A byte string terminated with NUL</p>
</li>
<li>
<p>Same as the first method but with a NUL termination</p>
</li>
</ul>
<p>Obviously, these similar encoding methods can be turned into individual functions to call. However, using functions cannot avoid continuous and tedious error handling. In fact, at that time I was influenced by frameworks such as SwiftUI and had already thought of a way in my mind: it needs to decouple the declaration of event decoding methods from their decoding actions so that I can focus on adjusting event layout without worrying about error handling at the same time. Similarly, I implemented this type of parser as a declarative parser. Like SwiftUI and other frameworks, code written using this approach is very concise in simple scenarios and greatly improves readability.</p>
<p>In this approach, an <code>Layout</code> function is used to declare (define) an event&rsquo;s parsing process. The reason why we use a function instead of an <code>XxxLayout</code> structure is because this approach isn&rsquo;t flexible enough. Using closures can perfectly solve this problem; I can stuff all kinds of temporary states into closures and use closure features to pass them around everywhere. Here&rsquo;s an example for <code>QueryEvent</code>:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">type</span> <span class="nx">QueryEvent</span> <span class="kd">struct</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">ThreadID</span>   <span class="kt">uint32</span>          <span class="s">`json:&#34;thread_id,omitempty&#34;`</span>
</span></span><span class="line"><span class="cl">	<span class="nx">ExecTime</span>   <span class="kt">uint32</span>          <span class="s">`json:&#34;exec_time&#34;`</span>
</span></span><span class="line"><span class="cl">	<span class="nx">ErrorCode</span>  <span class="kt">uint16</span>          <span class="s">`json:&#34;error_code&#34;`</span>
</span></span><span class="line"><span class="cl">	<span class="nx">Schema</span>     <span class="nx">str</span><span class="p">.</span><span class="nx">Str</span>         <span class="s">`json:&#34;schema&#34;`</span>
</span></span><span class="line"><span class="cl">	<span class="nx">Query</span>      <span class="nx">str</span><span class="p">.</span><span class="nx">Str</span>         <span class="s">`json:&#34;query&#34;`</span>
</span></span><span class="line"><span class="cl">	<span class="nx">StatusVars</span> <span class="nx">StatusVariables</span> <span class="s">`json:&#34;status_vars,omitempty&#34;`</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="p">(</span><span class="nx">d</span> <span class="o">*</span><span class="nx">QueryEvent</span><span class="p">)</span> <span class="nf">Layout</span><span class="p">(</span><span class="nx">version</span> <span class="kt">uint32</span><span class="p">,</span> <span class="nx">code</span> <span class="kt">byte</span><span class="p">,</span> <span class="nx">fde</span> <span class="o">*</span><span class="nx">FormatDescriptionEvent</span><span class="p">)</span> <span class="o">*</span><span class="nx">layout</span><span class="p">.</span><span class="nx">Layout</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="kd">var</span> <span class="nx">schemaLength</span> <span class="kt">uint8</span>
</span></span><span class="line"><span class="cl">	<span class="kd">var</span> <span class="nx">statusVarsLength</span> <span class="kt">uint16</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="nx">layout</span><span class="p">.</span><span class="nf">Decl</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">		<span class="c1">// Post header
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="nx">layout</span><span class="p">.</span><span class="nf">Number</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">d</span><span class="p">.</span><span class="nx">ThreadID</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">		<span class="nx">layout</span><span class="p">.</span><span class="nf">Number</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">d</span><span class="p">.</span><span class="nx">ExecTime</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">		<span class="nx">layout</span><span class="p">.</span><span class="nf">Number</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">schemaLength</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">		<span class="nx">layout</span><span class="p">.</span><span class="nf">Number</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">d</span><span class="p">.</span><span class="nx">ErrorCode</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">		<span class="nx">layout</span><span class="p">.</span><span class="nf">If</span><span class="p">(</span><span class="nx">version</span> <span class="o">==</span> <span class="nx">spec</span><span class="p">.</span><span class="nx">V4</span><span class="p">,</span> <span class="nx">layout</span><span class="p">.</span><span class="nf">Number</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">statusVarsLength</span><span class="p">)),</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="c1">// Payload
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="nx">layout</span><span class="p">.</span><span class="nf">If</span><span class="p">(</span><span class="nx">version</span> <span class="o">==</span> <span class="nx">spec</span><span class="p">.</span><span class="nx">V4</span><span class="p">,</span> <span class="nx">layout</span><span class="p">.</span><span class="nf">Area</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">statusVarsLength</span><span class="p">,</span> <span class="kd">func</span><span class="p">(</span><span class="nx">data</span> <span class="p">[]</span><span class="kt">byte</span><span class="p">)</span> <span class="p">(</span><span class="kt">int</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="nx">statusVarsLength</span><span class="p">),</span> <span class="nx">d</span><span class="p">.</span><span class="nx">StatusVars</span><span class="p">.</span><span class="nf">parseStatusVarsBlock</span><span class="p">(</span><span class="nx">data</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="p">})),</span>
</span></span><span class="line"><span class="cl">		<span class="nx">layout</span><span class="p">.</span><span class="nf">Bytes</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">schemaLength</span><span class="p">,</span> <span class="o">&amp;</span><span class="nx">d</span><span class="p">.</span><span class="nx">Schema</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">		<span class="nx">layout</span><span class="p">.</span><span class="nf">Null</span><span class="p">(),</span>
</span></span><span class="line"><span class="cl">		<span class="nx">layout</span><span class="p">.</span><span class="nf">Bytes</span><span class="p">(</span><span class="nx">layout</span><span class="p">.</span><span class="nf">Infinite</span><span class="p">(),</span> <span class="o">&amp;</span><span class="nx">d</span><span class="p">.</span><span class="nx">Query</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">	<span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>Believe that even if you don&rsquo;t understand what <code>layout.Number</code> means now, you will soon understand that it refers to the layout of the encoded <code>QUERY_EVENT</code>.</p>
<p><figure 
	
		class="gallery-image" 
		style="
			flex-grow: 101; 
			flex-basis: 244px"
	>
	<a href="/p/yet-another-binlog-parser/img/query_event_data.png" data-size="717x705">
		<img src="/p/yet-another-binlog-parser/img/query_event_data.png"
			width="717"
			height="705"
			srcset="/p/yet-another-binlog-parser/img/query_event_data_hu6be4374eb9dd29c1d8f6fc4befaf82c9_62677_480x0_resize_box_3.png 480w, /p/yet-another-binlog-parser/img/query_event_data_hu6be4374eb9dd29c1d8f6fc4befaf82c9_62677_1024x0_resize_box_3.png 1024w"
			loading="lazy"
			alt="QUERY EVENT DATA">
	</a>
	
	<figcaption>QUERY EVENT DATA</figcaption>
	
</figure></p>
<p>From the <code>layout.Number</code> calling method, I believe you can already guess how this is implemented - it is a decoder that is bound to the <code>int32</code> type variable <code>&amp;d.ThreadID</code>. For different types, I have implemented different decoders in the <code>layout</code> package, which I call <code>Field</code>. Here is the implementation of <code>Number</code>:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">type</span> <span class="nx">NumberField</span><span class="p">[</span><span class="nx">N</span> <span class="nx">constraints</span><span class="p">.</span><span class="nx">Integer</span> <span class="p">|</span> <span class="nx">constraints</span><span class="p">.</span><span class="nx">Float</span><span class="p">]</span> <span class="kd">struct</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">r</span> <span class="o">*</span><span class="nx">N</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="p">(</span><span class="nx">f</span> <span class="nx">NumberField</span><span class="p">[</span><span class="nx">N</span><span class="p">])</span> <span class="nf">FromBlock</span><span class="p">(</span><span class="nx">data</span> <span class="p">[]</span><span class="kt">byte</span><span class="p">)</span> <span class="p">(</span><span class="kt">int</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nf">checkDataSize</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="nx">unsafe</span><span class="p">.</span><span class="nf">Sizeof</span><span class="p">(</span><span class="nf">N</span><span class="p">(</span><span class="mi">0</span><span class="p">))),</span> <span class="nx">data</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="nx">utils</span><span class="p">.</span><span class="nf">ReadNumberLittleEndianHack</span><span class="p">(</span><span class="nx">f</span><span class="p">.</span><span class="nx">r</span><span class="p">,</span> <span class="nx">data</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="nx">unsafe</span><span class="p">.</span><span class="nf">Sizeof</span><span class="p">(</span><span class="nf">N</span><span class="p">(</span><span class="mi">0</span><span class="p">))),</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="nx">Number</span><span class="p">[</span><span class="nx">N</span> <span class="nx">constraints</span><span class="p">.</span><span class="nx">Integer</span> <span class="p">|</span> <span class="nx">constraints</span><span class="p">.</span><span class="nx">Float</span><span class="p">](</span><span class="nx">r</span> <span class="o">*</span><span class="nx">N</span><span class="p">)</span> <span class="nx">NumberField</span><span class="p">[</span><span class="nx">N</span><span class="p">]</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="nx">NumberField</span><span class="p">[</span><span class="nx">N</span><span class="p">]{</span><span class="nx">r</span><span class="p">:</span> <span class="nx">r</span><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>In the end, I just followed the same pattern to support all event types. In this process, tedious function calls and error handling were no longer obstacles to my coding, but rather MySQL&rsquo;s nasty encoding and lack of detailed documentation occasionally hindered my progress - most of the time, I had to flip through MySQL&rsquo;s code to understand why it was encoded that way.</p>
<p>Careful students may ask whether this approach will decode a bunch of <code>Field</code> objects for each event generated, which could have a significant impact on performance? You are right; it does affect performance. However, there is still a solution ğŸ¥µ. The nature of Binlog determines that its parsing process must be deterministic. This means that once you determine which log needs to be parsed, regardless of which event in the log needs decoding, the decoding process is always determined - this suggests caching the results for each event&rsquo;s <code>Layout</code>. After completing most events&rsquo; layout mapping work haphazardly (i.e., without much care), I implemented such a cache. For those who want more details about it can refer to <a class="link" href="https://github.com/polardb/polardbx-operator/blob/main/pkg/binlogtool/binlog/cache.go"  target="_blank" rel="noopener"
    >binlog/cache.go</a>.</p>
<p>After the final test, the performance of parsing all fields in a single thread is about 200 MB/s. The test environment was MacBook Pro 13&rsquo;&rsquo; 2019 with Intel processor. In my opinion, this is completely sufficient since no one&rsquo;s binlog can write at a speed of 200 MB (excluding large transactions). Please send me such a good disk for testing.</p>
<h3 id="fuzzy-probe-event-header">Fuzzy Probe Event Header</h3>
<p>With the parser, I can now create my own CLI tool (hehe ğŸ˜ƒ). If you have used <code>mysqlbinlog</code> to view binlogs before, you must have used the <code>--start-position</code> parameter to quickly jump to the beginning of an event. However, due to the streaming nature of binlogs, if you specify a position that is not an event header, <code>mysqlbinlog</code> cannot continue reading and will simply report an error :) Yes, it&rsquo;s very frustrating. This means that I have to use another calculator to calculate the event position and then pass it on to <code>mysqlbinlog</code>. Every time this happens, I wish there was something that could help me find the next output event easily so that I could quickly binary search for what I want.</p>
<p>In theory, it is impossible to detect an event header from within a stream. But fortunately, in this case we are dealing with files and there happens to be redundant information left in each event header (<code>event_length</code> and <code>next_position</code>). While reading through the file we can easily determine our current position (<code>current_position</code>). Therefore it follows logically that: <code>current_position + event_length = next_position</code>. This is a very strong feature; if these conditions are met then there is high probability that this location represents a valid event header. Thus we decided on using this method! You can see how it was implemented <a class="link" href="https://github.com/polardb/polardbx-operator/blob/0c9db54f02e832b15dc9b163c9bcf1424b2cd32b/pkg/binlogtool/binlog/scan.go#LL122-L208C2"  target="_blank" rel="noopener"
    >here</a>.</p>
<p>We also utilized some clever tricks like using ring buffers which helped reduce memory overheads significantly. Ultimately what we achieved was being able start searching from any arbitrary point - as long as there exists another subsequent valid events within our detection range!</p>
<h2 id="conclusion-and-preview-of-next-episode">Conclusion and Preview of Next Episode</h2>
<p>Of course, wheel makers will never be satisfied. Some fancy features are also essential, such as event filtering, raw events, end positions, event validation, JSON output and so on. Based on the parser, I also wrote an analysis tool for 2PC transactions to complete a step in the backup and recovery plan that I mentioned at the beginning (after all, I still need to eat). This article mainly records some interesting thoughts and attempts during the implementation of this parser. The next article should talk about my distributed backup plan which is completely lock-free. Stay tuned ğŸ¥°.</p>
<p>P.S. The patent for this plan should be coming soon. Please don&rsquo;t sue me&hellip;</p>
<h2 id="references">References</h2>
<p>[1] <a class="link" href="https://dev.mysql.com/doc/dev/mysql-server/latest/page_protocol_replication.html#sect_protocol_replication_binlog_version_v4"  target="_blank" rel="noopener"
    >https://dev.mysql.com/doc/dev/mysql-server/latest/page_protocol_replication.html#sect_protocol_replication_binlog_version_v4</a></p>
<p>[2] <a class="link" href="https://github.com/polardb/polardbx-operator/tree/main/pkg/binlogtool"  target="_blank" rel="noopener"
    >https://github.com/polardb/polardbx-operator/tree/main/pkg/binlogtool</a></p>

</section>


    <footer class="article-footer">
    
    <section class="article-tags">
        
            <a href="/tags/binlog/">binlog</a>
        
    </section>


    
    <section class="article-copyright">
        <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-copyright" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="12" cy="12" r="9" />
  <path d="M14.5 9a3.5 4 0 1 0 0 6" />
</svg>



        <span>Licensed under CC BY-NC-SA 4.0</span>
    </section>
    </footer>


    
</article>

    <aside class="related-contents--wrapper">
    
    
</aside>

     
     
        
    <script src="https://beaudar.lipk.org/client.js"
        repo="arkbriar/blog"
        issue-term="pathname"
        
        label="comments"
        
        comment-order="desc"
        input-position="top"
        crossorigin="anonymous"
        async
        >
</script>

<style>
    .beaudar {
        max-width: unset;
    }
</style>

<script>
    function setUtterancesTheme(theme) {
        let beaudar = document.querySelector('.beaudar iframe');
        if (beaudar) {
            beaudar.contentWindow.postMessage(
                {
                    type: 'set-theme',
                    theme: `github-${theme}`
                },
                'https://beaudar.lipk.org'
            );
        }
    }

    addEventListener('message', event => {
        if (event.origin !== 'https://beaudar.lipk.org') return;
        setUtterancesTheme(document.documentElement.dataset.scheme)
    });

    window.addEventListener('onColorSchemeChange', (e) => {
        setUtterancesTheme(e.detail)
    })
</script>


    

    <footer class="site-footer">
    <section class="copyright">
        &copy; 
        
            2018 - 
        
        2023 çŸ³æ²‰æºªæ´ -- Ark&#39;s Blog
    </section>
    
    <section class="powerby">
        Built with <a href="https://gohugo.io/" target="_blank" rel="noopener">Hugo</a> <br />
        Theme <b><a href="https://github.com/CaiJimmy/hugo-theme-stack" target="_blank" rel="noopener" data-version="3.2.0">Stack</a></b> designed by <a href="https://jimmycai.com" target="_blank" rel="noopener">Jimmy</a>
    </section>
</footer>


    
<div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">

    
    <div class="pswp__bg"></div>

    
    <div class="pswp__scroll-wrap">

        
        <div class="pswp__container">
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
        </div>

        
        <div class="pswp__ui pswp__ui--hidden">

            <div class="pswp__top-bar">

                

                <div class="pswp__counter"></div>

                <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>

                <button class="pswp__button pswp__button--share" title="Share"></button>

                <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>

                <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>

                
                
                <div class="pswp__preloader">
                    <div class="pswp__preloader__icn">
                        <div class="pswp__preloader__cut">
                            <div class="pswp__preloader__donut"></div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
                <div class="pswp__share-tooltip"></div>
            </div>

            <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
            </button>

            <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
            </button>

            <div class="pswp__caption">
                <div class="pswp__caption__center"></div>
            </div>

        </div>

    </div>

</div><script 
                src="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.js"integrity="sha256-ePwmChbbvXbsO02lbM3HoHbSHTHFAeChekF1xKJdleo="crossorigin="anonymous"
                defer="true"
                >
            </script><script 
                src="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe-ui-default.min.js"integrity="sha256-UKkzOn/w1mBxRmLLGrSeyB4e1xbrp4xylgAWb3M42pU="crossorigin="anonymous"
                defer="true"
                >
            </script><link 
                rel="stylesheet" 
                href="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/default-skin/default-skin.css"integrity="sha256-c0uckgykQ9v5k&#43;IqViZOZKc47Jn7KQil4/MP3ySA3F8="crossorigin="anonymous"
            ><link 
                rel="stylesheet" 
                href="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.css"integrity="sha256-SBLU4vv6CA6lHsZ1XyTdhyjJxCjPif/TRkjnsyGAGnE="crossorigin="anonymous"
            >

            </main>
    
        <aside class="sidebar right-sidebar sticky">
            <section class="widget archives">
                <div class="widget-icon">
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-hash" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <line x1="5" y1="9" x2="19" y2="9" />
  <line x1="5" y1="15" x2="19" y2="15" />
  <line x1="11" y1="4" x2="7" y2="20" />
  <line x1="17" y1="4" x2="13" y2="20" />
</svg>



                </div>
                <h2 class="widget-title section-title">ç›®å½•</h2>
                
                <div class="widget--toc">
                    <nav id="TableOfContents">
  <ol>
    <li><a href="#ä¸ºä»€ä¹ˆè¦å†é€ ä¸€ä¸ªè½®å­">ä¸ºä»€ä¹ˆè¦å†é€ ä¸€ä¸ªè½®å­ï¼Ÿ</a></li>
    <li><a href="#ç®€å•ä»‹ç»-binlog">ç®€å•ä»‹ç» Binlog</a></li>
    <li><a href="#ä¸€äº›æœ‰è¶£çš„å°è¯•">ä¸€äº›æœ‰è¶£çš„å°è¯•</a>
      <ol>
        <li><a href="#è¿­ä»£å™¨æ¥å£">è¿­ä»£å™¨æ¥å£</a></li>
        <li><a href="#å£°æ˜å¼çš„è§£æå™¨">å£°æ˜å¼çš„è§£æå™¨</a></li>
        <li><a href="#æ¨¡ç³Šæ¢æµ‹äº‹ä»¶å¤´">æ¨¡ç³Šæ¢æµ‹äº‹ä»¶å¤´</a></li>
      </ol>
    </li>
    <li><a href="#å°¾å£°å’Œä¸‹é›†é¢„å‘Š">å°¾å£°å’Œä¸‹é›†é¢„å‘Š</a></li>
    <li><a href="#å‚è€ƒæ–‡çŒ®">å‚è€ƒæ–‡çŒ®</a></li>
    <li><a href="#why-do-we-need-to-reinvent-the-wheel">Why do we need to reinvent the wheel?</a></li>
    <li><a href="#brief-introduction-to-binlog">Brief Introduction to Binlog</a></li>
    <li><a href="#some-interesting-attempts">Some interesting attempts</a>
      <ol>
        <li><a href="#iterator-interface">Iterator Interface</a></li>
        <li><a href="#declarative-parser">Declarative Parser</a></li>
        <li><a href="#fuzzy-probe-event-header">Fuzzy Probe Event Header</a></li>
      </ol>
    </li>
    <li><a href="#conclusion-and-preview-of-next-episode">Conclusion and Preview of Next Episode</a></li>
    <li><a href="#references">References</a></li>
  </ol>
</nav>
                </div>
            </section>
        </aside>
    

        </div>
        <script 
                src="https://cdn.jsdelivr.net/npm/node-vibrant@3.1.5/dist/vibrant.min.js"integrity="sha256-5NovOZc4iwiAWTYIFiIM7DxKUXKWvpVEuMEPLzcm5/g="crossorigin="anonymous"
                defer="false"
                >
            </script><script type="text/javascript" src="/ts/main.js" defer></script>
<script>
    (function () {
        const customFont = document.createElement('link');
        customFont.href = "https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&display=swap";

        customFont.type = "text/css";
        customFont.rel = "stylesheet";

        document.head.appendChild(customFont);
    }());
</script>

    </body>
</html>
