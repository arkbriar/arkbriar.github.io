<!DOCTYPE html>
<html lang="zh-cn">
    <head><meta charset='utf-8'>
<meta name='viewport' content='width=device-width, initial-scale=1'><meta name='description' content='ä»æŠ¥åæ¯”èµ›å¼€å§‹åˆ°ç°åœ¨å°†è¿‘å››ä¸ªæœˆäº†ï¼Œç»ˆäºå‘Šä¸€æ®µè½ï¼Œæœ€ç»ˆæ‹¿åˆ°äº†å­£å†›ä¹Ÿå¾ˆå¼€å¿ƒã€‚è¿™ä¸‰ä¸ªæœˆä¸­æˆ‘å­¦åˆ°äº†å¾ˆå¤šæœ‰ç”¨çš„å·¥ç¨‹çŸ¥è¯†ï¼Œé¡ºä¾¿æŠŠ C&#43;&#43; åˆæ‘¸ç†Ÿäº†ã€‚åˆèµ›ä»£ç å®åœ¨å†™å¤ªä¸‘å°±ä¸æ”¾å‡ºæ¥äº†ï¼Œå¤èµ›çš„ä»£ç æ‰˜ç®¡åœ¨ github ä¸Šï¼š
https://github.com/arkbriar/awrace2018_messagestore
ä¸‹é¢æ˜¯æœ¬æ¬¡å¤§èµ›åˆèµ›å’Œå¤èµ›éƒ¨åˆ†çš„æ€è€ƒè¿‡ç¨‹å’Œæœ€ç»ˆæ–¹æ¡ˆã€‚
åˆèµ›éƒ¨åˆ† èµ›é¢˜èƒŒæ™¯åˆ†æåŠç†è§£  å®ç°ä¸€ä¸ªé«˜æ€§èƒ½çš„ Service Mesh Agent ç»„ä»¶ï¼Œå¹¶åŒ…å«å¦‚ä¸‹ä¸€äº›åŠŸèƒ½ï¼š1. æœåŠ¡æ³¨å†Œä¸å‘ç°, 2. åè®®è½¬æ¢, 3. è´Ÿè½½å‡è¡¡
 æœ¬é¢˜è¦æ±‚æˆ‘ä»¬èƒ½å¤Ÿå°½å¯èƒ½çš„é«˜æ€§èƒ½ï¼Œæˆ‘ä»¬é¦–å…ˆå¯¹åœºæ™¯å’Œå¤§è‡´æ€è·¯è¿›è¡Œäº†ä¸€ä¸ªé‡è¿°ï¼š
 Consumer å°†æ¥å—è¶…è¿‡ 500 ä¸ªè¿æ¥ï¼šæƒ³åˆ°ä½¿ç”¨ IO multiplex Http = TCP è¿æ¥ï¼šç¦ç”¨ Nagle ç®—æ³• Dubbo provider åªæœ‰ 200 ä¸ªå¤„ç†çº¿ç¨‹ï¼Œè¶…è¿‡ 200 ä¸ªå¹¶å‘è¯·æ±‚ä¼šå¿«é€Ÿå¤±è´¥ï¼š è´Ÿè½½å‡è¡¡å°½é‡é¿å… provider è¿‡è½½ çº¿ä¸Šç½‘ç»œæ€§èƒ½ (pps) è¾ƒå·®ï¼šæ‰¹é‡å‘é€ request/responseï¼Œä½¿ç”¨ UDP è¿›è¡Œ Agent é—´é€šä¿¡ Consumer æ€§èƒ½è¾ƒå·®ï¼šå°†åè®®è½¬æ¢ç­‰æ”¾åˆ° provider agent ä¸Šå»åš  æ ¸å¿ƒæ€è·¯ ä¸ºäº†å‡å°‘ç³»ç»Ÿå¼€é”€ï¼Œæˆ‘ä»¬åœ¨ agent ä¹‹é—´éƒ½åªä¿æŒä¸€ä¸ª udp ä¿¡é“ï¼Œåœ¨ PA (Provider Agent) å’Œ Provider ä¹‹é—´ä¹Ÿåªä¿æŒä¸€ä¸ª tcp ä¿¡é“ã€‚'><title>ç¬¬å››å±Šå¤©æ± ä¸­é—´ä»¶æ€§èƒ½æŒ‘æˆ˜èµ›æ„Ÿæƒ³</title>

<link rel='canonical' href='https://blog.crazyark.xyz/p/awrace-2018/'>

<link rel="stylesheet" href="/scss/style.min.css"><meta property='og:title' content='ç¬¬å››å±Šå¤©æ± ä¸­é—´ä»¶æ€§èƒ½æŒ‘æˆ˜èµ›æ„Ÿæƒ³'>
<meta property='og:description' content='ä»æŠ¥åæ¯”èµ›å¼€å§‹åˆ°ç°åœ¨å°†è¿‘å››ä¸ªæœˆäº†ï¼Œç»ˆäºå‘Šä¸€æ®µè½ï¼Œæœ€ç»ˆæ‹¿åˆ°äº†å­£å†›ä¹Ÿå¾ˆå¼€å¿ƒã€‚è¿™ä¸‰ä¸ªæœˆä¸­æˆ‘å­¦åˆ°äº†å¾ˆå¤šæœ‰ç”¨çš„å·¥ç¨‹çŸ¥è¯†ï¼Œé¡ºä¾¿æŠŠ C&#43;&#43; åˆæ‘¸ç†Ÿäº†ã€‚åˆèµ›ä»£ç å®åœ¨å†™å¤ªä¸‘å°±ä¸æ”¾å‡ºæ¥äº†ï¼Œå¤èµ›çš„ä»£ç æ‰˜ç®¡åœ¨ github ä¸Šï¼š
https://github.com/arkbriar/awrace2018_messagestore
ä¸‹é¢æ˜¯æœ¬æ¬¡å¤§èµ›åˆèµ›å’Œå¤èµ›éƒ¨åˆ†çš„æ€è€ƒè¿‡ç¨‹å’Œæœ€ç»ˆæ–¹æ¡ˆã€‚
åˆèµ›éƒ¨åˆ† èµ›é¢˜èƒŒæ™¯åˆ†æåŠç†è§£  å®ç°ä¸€ä¸ªé«˜æ€§èƒ½çš„ Service Mesh Agent ç»„ä»¶ï¼Œå¹¶åŒ…å«å¦‚ä¸‹ä¸€äº›åŠŸèƒ½ï¼š1. æœåŠ¡æ³¨å†Œä¸å‘ç°, 2. åè®®è½¬æ¢, 3. è´Ÿè½½å‡è¡¡
 æœ¬é¢˜è¦æ±‚æˆ‘ä»¬èƒ½å¤Ÿå°½å¯èƒ½çš„é«˜æ€§èƒ½ï¼Œæˆ‘ä»¬é¦–å…ˆå¯¹åœºæ™¯å’Œå¤§è‡´æ€è·¯è¿›è¡Œäº†ä¸€ä¸ªé‡è¿°ï¼š
 Consumer å°†æ¥å—è¶…è¿‡ 500 ä¸ªè¿æ¥ï¼šæƒ³åˆ°ä½¿ç”¨ IO multiplex Http = TCP è¿æ¥ï¼šç¦ç”¨ Nagle ç®—æ³• Dubbo provider åªæœ‰ 200 ä¸ªå¤„ç†çº¿ç¨‹ï¼Œè¶…è¿‡ 200 ä¸ªå¹¶å‘è¯·æ±‚ä¼šå¿«é€Ÿå¤±è´¥ï¼š è´Ÿè½½å‡è¡¡å°½é‡é¿å… provider è¿‡è½½ çº¿ä¸Šç½‘ç»œæ€§èƒ½ (pps) è¾ƒå·®ï¼šæ‰¹é‡å‘é€ request/responseï¼Œä½¿ç”¨ UDP è¿›è¡Œ Agent é—´é€šä¿¡ Consumer æ€§èƒ½è¾ƒå·®ï¼šå°†åè®®è½¬æ¢ç­‰æ”¾åˆ° provider agent ä¸Šå»åš  æ ¸å¿ƒæ€è·¯ ä¸ºäº†å‡å°‘ç³»ç»Ÿå¼€é”€ï¼Œæˆ‘ä»¬åœ¨ agent ä¹‹é—´éƒ½åªä¿æŒä¸€ä¸ª udp ä¿¡é“ï¼Œåœ¨ PA (Provider Agent) å’Œ Provider ä¹‹é—´ä¹Ÿåªä¿æŒä¸€ä¸ª tcp ä¿¡é“ã€‚'>
<meta property='og:url' content='https://blog.crazyark.xyz/p/awrace-2018/'>
<meta property='og:site_name' content='çŸ³æ²‰æºªæ´ -- Ark&#39;s Blog'>
<meta property='og:type' content='article'><meta property='article:section' content='Post' /><meta property='article:tag' content='contest' /><meta property='article:tag' content='middelware' /><meta property='article:published_time' content='2018-08-01T19:59:45&#43;08:00'/><meta property='article:modified_time' content='2018-08-01T19:59:45&#43;08:00'/>
<meta name="twitter:site" content="@ImperiusDs">
    <meta name="twitter:creator" content="@ImperiusDs"><meta name="twitter:title" content="ç¬¬å››å±Šå¤©æ± ä¸­é—´ä»¶æ€§èƒ½æŒ‘æˆ˜èµ›æ„Ÿæƒ³">
<meta name="twitter:description" content="ä»æŠ¥åæ¯”èµ›å¼€å§‹åˆ°ç°åœ¨å°†è¿‘å››ä¸ªæœˆäº†ï¼Œç»ˆäºå‘Šä¸€æ®µè½ï¼Œæœ€ç»ˆæ‹¿åˆ°äº†å­£å†›ä¹Ÿå¾ˆå¼€å¿ƒã€‚è¿™ä¸‰ä¸ªæœˆä¸­æˆ‘å­¦åˆ°äº†å¾ˆå¤šæœ‰ç”¨çš„å·¥ç¨‹çŸ¥è¯†ï¼Œé¡ºä¾¿æŠŠ C&#43;&#43; åˆæ‘¸ç†Ÿäº†ã€‚åˆèµ›ä»£ç å®åœ¨å†™å¤ªä¸‘å°±ä¸æ”¾å‡ºæ¥äº†ï¼Œå¤èµ›çš„ä»£ç æ‰˜ç®¡åœ¨ github ä¸Šï¼š
https://github.com/arkbriar/awrace2018_messagestore
ä¸‹é¢æ˜¯æœ¬æ¬¡å¤§èµ›åˆèµ›å’Œå¤èµ›éƒ¨åˆ†çš„æ€è€ƒè¿‡ç¨‹å’Œæœ€ç»ˆæ–¹æ¡ˆã€‚
åˆèµ›éƒ¨åˆ† èµ›é¢˜èƒŒæ™¯åˆ†æåŠç†è§£  å®ç°ä¸€ä¸ªé«˜æ€§èƒ½çš„ Service Mesh Agent ç»„ä»¶ï¼Œå¹¶åŒ…å«å¦‚ä¸‹ä¸€äº›åŠŸèƒ½ï¼š1. æœåŠ¡æ³¨å†Œä¸å‘ç°, 2. åè®®è½¬æ¢, 3. è´Ÿè½½å‡è¡¡
 æœ¬é¢˜è¦æ±‚æˆ‘ä»¬èƒ½å¤Ÿå°½å¯èƒ½çš„é«˜æ€§èƒ½ï¼Œæˆ‘ä»¬é¦–å…ˆå¯¹åœºæ™¯å’Œå¤§è‡´æ€è·¯è¿›è¡Œäº†ä¸€ä¸ªé‡è¿°ï¼š
 Consumer å°†æ¥å—è¶…è¿‡ 500 ä¸ªè¿æ¥ï¼šæƒ³åˆ°ä½¿ç”¨ IO multiplex Http = TCP è¿æ¥ï¼šç¦ç”¨ Nagle ç®—æ³• Dubbo provider åªæœ‰ 200 ä¸ªå¤„ç†çº¿ç¨‹ï¼Œè¶…è¿‡ 200 ä¸ªå¹¶å‘è¯·æ±‚ä¼šå¿«é€Ÿå¤±è´¥ï¼š è´Ÿè½½å‡è¡¡å°½é‡é¿å… provider è¿‡è½½ çº¿ä¸Šç½‘ç»œæ€§èƒ½ (pps) è¾ƒå·®ï¼šæ‰¹é‡å‘é€ request/responseï¼Œä½¿ç”¨ UDP è¿›è¡Œ Agent é—´é€šä¿¡ Consumer æ€§èƒ½è¾ƒå·®ï¼šå°†åè®®è½¬æ¢ç­‰æ”¾åˆ° provider agent ä¸Šå»åš  æ ¸å¿ƒæ€è·¯ ä¸ºäº†å‡å°‘ç³»ç»Ÿå¼€é”€ï¼Œæˆ‘ä»¬åœ¨ agent ä¹‹é—´éƒ½åªä¿æŒä¸€ä¸ª udp ä¿¡é“ï¼Œåœ¨ PA (Provider Agent) å’Œ Provider ä¹‹é—´ä¹Ÿåªä¿æŒä¸€ä¸ª tcp ä¿¡é“ã€‚">
    </head>
    <body class="
    article-page has-toc
">
    <script>
        (function() {
            const colorSchemeKey = 'StackColorScheme';
            if(!localStorage.getItem(colorSchemeKey)){
                localStorage.setItem(colorSchemeKey, "auto");
            }
        })();
    </script><script>
    (function() {
        const colorSchemeKey = 'StackColorScheme';
        const colorSchemeItem = localStorage.getItem(colorSchemeKey);
        const supportDarkMode = window.matchMedia('(prefers-color-scheme: dark)').matches === true;

        if (colorSchemeItem == 'dark' || colorSchemeItem === 'auto' && supportDarkMode) {
            

            document.documentElement.dataset.scheme = 'dark';
        } else {
            document.documentElement.dataset.scheme = 'light';
        }
    })();
</script>
<div class="container main-container flex 
    
        extended
    
">
    
        <div id="article-toolbar">
            <a href="https://blog.crazyark.xyz" class="back-home">
                <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-chevron-left" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <polyline points="15 6 9 12 15 18" />
</svg>



                <span>è¿”å›</span>
            </a>
        </div>
    
<main class="main full-width">
    <article class="main-article">
    <header class="article-header">

    <div class="article-details">
    
    <header class="article-category">
        
            <a href="/categories/tianchi/" >
                Tianchi
            </a>
        
            <a href="/categories/contest/" >
                Contest
            </a>
        
    </header>
    

    <h2 class="article-title">
        <a href="/p/awrace-2018/">ç¬¬å››å±Šå¤©æ± ä¸­é—´ä»¶æ€§èƒ½æŒ‘æˆ˜èµ›æ„Ÿæƒ³</a>
    </h2>

    

    
    <footer class="article-time">
        
            <div>
                <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-calendar-time" width="56" height="56" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <path d="M11.795 21h-6.795a2 2 0 0 1 -2 -2v-12a2 2 0 0 1 2 -2h12a2 2 0 0 1 2 2v4" />
  <circle cx="18" cy="18" r="4" />
  <path d="M15 3v4" />
  <path d="M7 3v4" />
  <path d="M3 11h16" />
  <path d="M18 16.496v1.504l1 1" />
</svg>
                <time class="article-time--published">Aug 01, 2018</time>
            </div>
        

        
            <div>
                <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-clock" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="12" cy="12" r="9" />
  <polyline points="12 7 12 12 15 15" />
</svg>



                <time class="article-time--reading">
                    é˜…è¯»æ—¶é•¿: 4 åˆ†é’Ÿ
                </time>
            </div>
        
    </footer>
    
</div>
</header>

    <section class="article-content">
    <p>ä»æŠ¥åæ¯”èµ›å¼€å§‹åˆ°ç°åœ¨å°†è¿‘å››ä¸ªæœˆäº†ï¼Œç»ˆäºå‘Šä¸€æ®µè½ï¼Œæœ€ç»ˆæ‹¿åˆ°äº†å­£å†›ä¹Ÿå¾ˆå¼€å¿ƒã€‚è¿™ä¸‰ä¸ªæœˆä¸­æˆ‘å­¦åˆ°äº†å¾ˆå¤šæœ‰ç”¨çš„å·¥ç¨‹çŸ¥è¯†ï¼Œé¡ºä¾¿æŠŠ C++ åˆæ‘¸ç†Ÿäº†ã€‚åˆèµ›ä»£ç å®åœ¨å†™å¤ªä¸‘å°±ä¸æ”¾å‡ºæ¥äº†ï¼Œå¤èµ›çš„ä»£ç æ‰˜ç®¡åœ¨ github ä¸Šï¼š</p>
<p><a class="link" href="https://github.com/arkbriar/awrace2018_messagestore"  target="_blank" rel="noopener"
    >https://github.com/arkbriar/awrace2018_messagestore</a></p>
<p>ä¸‹é¢æ˜¯æœ¬æ¬¡å¤§èµ›åˆèµ›å’Œå¤èµ›éƒ¨åˆ†çš„æ€è€ƒè¿‡ç¨‹å’Œæœ€ç»ˆæ–¹æ¡ˆã€‚</p>
<h2 id="åˆèµ›éƒ¨åˆ†">åˆèµ›éƒ¨åˆ†</h2>
<h3 id="èµ›é¢˜èƒŒæ™¯åˆ†æåŠç†è§£">èµ›é¢˜èƒŒæ™¯åˆ†æåŠç†è§£</h3>
<blockquote>
<p>å®ç°ä¸€ä¸ªé«˜æ€§èƒ½çš„ Service Mesh Agent ç»„ä»¶ï¼Œå¹¶åŒ…å«å¦‚ä¸‹ä¸€äº›åŠŸèƒ½ï¼š1.  æœåŠ¡æ³¨å†Œä¸å‘ç°, 2.  åè®®è½¬æ¢, 3.  è´Ÿè½½å‡è¡¡</p>
</blockquote>
<p>æœ¬é¢˜è¦æ±‚æˆ‘ä»¬èƒ½å¤Ÿå°½å¯èƒ½çš„<strong>é«˜æ€§èƒ½</strong>ï¼Œæˆ‘ä»¬é¦–å…ˆå¯¹åœºæ™¯å’Œå¤§è‡´æ€è·¯è¿›è¡Œäº†ä¸€ä¸ªé‡è¿°ï¼š</p>
<ul>
<li>Consumer å°†æ¥å—è¶…è¿‡ 500 ä¸ªè¿æ¥ï¼šæƒ³åˆ°ä½¿ç”¨ IO multiplex</li>
<li>Http = TCP è¿æ¥ï¼šç¦ç”¨ Nagle ç®—æ³•</li>
<li>Dubbo provider åªæœ‰ 200 ä¸ªå¤„ç†çº¿ç¨‹ï¼Œè¶…è¿‡ 200 ä¸ªå¹¶å‘è¯·æ±‚ä¼šå¿«é€Ÿå¤±è´¥ï¼š è´Ÿè½½å‡è¡¡å°½é‡é¿å… provider è¿‡è½½</li>
<li>çº¿ä¸Šç½‘ç»œæ€§èƒ½ (pps) è¾ƒå·®ï¼šæ‰¹é‡å‘é€ request/responseï¼Œä½¿ç”¨ UDP è¿›è¡Œ Agent é—´é€šä¿¡</li>
<li>Consumer æ€§èƒ½è¾ƒå·®ï¼šå°†åè®®è½¬æ¢ç­‰æ”¾åˆ° provider agent ä¸Šå»åš</li>
</ul>
<h3 id="æ ¸å¿ƒæ€è·¯">æ ¸å¿ƒæ€è·¯</h3>
<p>ä¸ºäº†å‡å°‘ç³»ç»Ÿå¼€é”€ï¼Œæˆ‘ä»¬åœ¨ agent ä¹‹é—´éƒ½åªä¿æŒä¸€ä¸ª udp ä¿¡é“ï¼Œåœ¨ PA (Provider Agent) å’Œ Provider ä¹‹é—´ä¹Ÿåªä¿æŒä¸€ä¸ª tcp ä¿¡é“ã€‚</p>
<p>æ•´ä½“çš„æ¶æ„å›¾å¦‚ä¸‹æ‰€ç¤ºï¼š</p>
<p><figure 
	
		class="gallery-image" 
		style="
			flex-grow: 133; 
			flex-basis: 320px"
	>
	<a href="/p/awrace-2018/img/15321002017148.jpg" data-size="1280x960">
		<img src="/p/awrace-2018/img/15321002017148.jpg"
			width="1280"
			height="960"
			srcset="/p/awrace-2018/img/15321002017148_hua5afa8ce71308f91ef79d2bfc60f7366_105122_480x0_resize_q75_box.jpg 480w, /p/awrace-2018/img/15321002017148_hua5afa8ce71308f91ef79d2bfc60f7366_105122_1024x0_resize_q75_box.jpg 1024w"
			loading="lazy"
			>
	</a>
	
</figure></p>
<p>å…¶ä¸­ï¼ŒCA (Consumer Agent) ç«¯ä½¿ç”¨ä¸€ä¸ª epoll çš„ eventloopï¼Œloop çš„å¤§è‡´æµç¨‹å¦‚ä¸‹å›¾ï¼š</p>
<p><figure 
	
		class="gallery-image" 
		style="
			flex-grow: 133; 
			flex-basis: 320px"
	>
	<a href="/p/awrace-2018/img/15321002990709.jpg" data-size="1502x1126">
		<img src="/p/awrace-2018/img/15321002990709.jpg"
			width="1502"
			height="1126"
			srcset="/p/awrace-2018/img/15321002990709_hu0a5db44a40f1a46ca5b546777e717e36_117478_480x0_resize_q75_box.jpg 480w, /p/awrace-2018/img/15321002990709_hu0a5db44a40f1a46ca5b546777e717e36_117478_1024x0_resize_q75_box.jpg 1024w"
			loading="lazy"
			>
	</a>
	
</figure>
1. é¦–å…ˆæ¥èµ·æ‰€æœ‰çš„æ–°çš„è¿æ¥ï¼Œåœ¨æ¥åˆ°è¿æ¥çš„æ—¶å€™ï¼Œæ ¹æ® provider çš„æƒé‡ç›´æ¥åˆ†é…ä¸€ä¸ª provider å¤„ç†åç»­è¯¥è¿æ¥çš„æ‰€æœ‰è¯·æ±‚</p>
<p>2. è¯»æ‰€æœ‰çš„èƒ½è¯»çš„ socket</p>
<ul>
<li>å¦‚æœè¯»åˆ°å®Œæ•´çš„è¯·æ±‚ï¼Œé‚£ä¹ˆå°†å®ƒ<strong>æ”¾å…¥åˆ°è¯·æ±‚é˜Ÿåˆ—</strong></li>
<li>å¦‚æœè¯»åˆ°å®Œæ•´çš„å›å¤ï¼Œç›´æ¥é€šè¿‡é˜»å¡å†™çš„æ–¹å¼å†™å›</li>
</ul>
<p>3. æ‰€æœ‰äº‹ä»¶å¤„ç†å®Œæˆä»¥åï¼Œæ‰¹é‡å‘é€æ‰€æœ‰çš„è¯·æ±‚é˜Ÿåˆ— (æ­¤å¤„ä½¿ç”¨ writev)</p>
<p>åœ¨è¯·æ±‚å‘é€å’Œè·å–å›å¤çš„è¿‡ç¨‹ä¸­ï¼Œæˆ‘ä»¬å§‹ç»ˆæœ‰ä¸€ä¸ª id é™„åœ¨è¯·æ±‚ä¸­ï¼Œè¿™ä¸ª id æ˜¯ consumer ç«¯å”¯ä¸€çš„ï¼Œè¿™ä¿è¯äº†æˆ‘ä»¬åªåœ¨ consumer ç«¯æœ‰ä¸€ä¸ª map æ¥ç¡®å®šå›å¤çš„å½’å®¿ï¼Œåœ¨è¿™é‡Œæˆ‘ä»¬çš„ id æ˜¯ handler çš„ç¼–å·ã€‚</p>
<h3 id="å…³é”®ä»£ç ">å…³é”®ä»£ç </h3>
<p>æ‰¹é‡å‘é€è¯·æ±‚ä»£ç å¤§è‡´å¦‚ä¸‹ï¼š</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="n">epoll_event</span> <span class="n">events</span><span class="p">[</span><span class="n">LOWER_LOAD_EVENT_SIZE</span><span class="p">];</span>
<span class="k">while</span> <span class="p">(</span><span class="n">_event_group</span><span class="p">.</span><span class="n">wait_and_handle</span><span class="p">(</span><span class="n">events</span><span class="p">,</span> <span class="n">LOWER_LOAD_EVENT_SIZE</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">))</span> <span class="p">{</span>
    <span class="c1">// check pending write queue, and block write all
</span><span class="c1"></span>    <span class="k">for</span> <span class="p">(</span><span class="k">auto</span><span class="o">&amp;</span> <span class="nl">entry</span> <span class="p">:</span> <span class="n">_pending_data</span><span class="p">)</span> <span class="p">{</span>
        <span class="c1">// write all requests to provider agent
</span><span class="c1"></span>        <span class="c1">// ... 
</span><span class="c1"></span>    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div><p>å…¶ä½™ä»£ç åœ¨ <a class="link" href="https://code.aliyun.com/arkbriar/dubbo-agent-cxx"  target="_blank" rel="noopener"
    >https://code.aliyun.com/arkbriar/dubbo-agent-cxx</a> ä¸­ã€‚</p>
<h2 id="å¤èµ›éƒ¨åˆ†">å¤èµ›éƒ¨åˆ†</h2>
<h3 id="èµ›é¢˜èƒŒæ™¯åˆ†æåŠç†è§£-1">èµ›é¢˜èƒŒæ™¯åˆ†æåŠç†è§£</h3>
<blockquote>
<p>å®ç° Queue Store çš„æ¥å£ put/getï¼Œè¦æ±‚æ”¯æŒå•æœºç™¾ä¸‡é˜Ÿåˆ—å’Œç™¾Gæ•°æ®ã€‚</p>
</blockquote>
<p>åœ¨å¯¹é¢˜ç›®ç¨å¾®äº†è§£è¿‡åï¼Œæˆ‘ä»¬å¾—åˆ°äº†ä»¥ä¸‹çš„å‡ ä¸ªä¿¡æ¯ï¼š</p>
<ul>
<li>æ¶ˆæ¯æ¡æ•°å¤§çº¦ä¸º 2gï¼Œæ¶ˆæ¯å¤§å°å¤§çº¦ä¸º 64 byteï¼Œä½†æ˜¯å¯èƒ½ä¼šæœ‰é•¿ä¸º 1024 byte çš„æ¶ˆæ¯</li>
<li>çº¿ä¸Šçš„æœºå™¨æ˜¯ 4c8g å¸¦ ssdï¼Œiops 1w å·¦å³ï¼Œé¡ºåº 4k è¯»å†™æ€§èƒ½å¤§çº¦ä¸º 200m/s å·¦å³</li>
<li>å¯¹åŒä¸€ä¸ªé˜Ÿåˆ—ï¼Œput æ˜¯åºåˆ—åŒ–çš„</li>
<li>å¯¹åŒä¸€ä¸ªé˜Ÿåˆ—ï¼Œget å¯èƒ½æ˜¯å¹¶å‘çš„</li>
<li>ä¸å­˜åœ¨åˆ é™¤é˜Ÿåˆ—å’Œæ¶ˆæ¯ï¼Œä¹Ÿä¸å­˜åœ¨ put ä¸ get åŒæ—¶è¿›è¡Œ</li>
</ul>
<p>è€Œè¯„æµ‹ç¨‹åºçš„ç©ºè·‘ put TPS å¤§çº¦åœ¨ 600w å·¦å³ï¼Œæ€§èƒ½ä¹Ÿä¸æ˜¯å¾ˆé«˜ï¼›è€Œåœ¨ä¸å‹ç¼©çš„æƒ…å†µä¸‹ï¼Œå†™æ‰“æ»¡å†™ 100g æ•°æ®æœ€å°‘è€—æ—¶ 500sã€‚å› æ­¤æœ¬é¢˜è¦æ±‚é€‰æ‰‹èƒ½å¤Ÿå°½å¯èƒ½çš„ä¿è¯ put é˜¶æ®µçš„æ— é˜»å¡ï¼Œä»¥åŠèƒ½å¤Ÿè®¾è®¡å‡ºä¸€ä¸ªè‰¯å¥½çš„æ•°æ®ç»“æ„ï¼Œä¿è¯ get é˜¶æ®µèƒ½å¤Ÿåˆ©ç”¨ç¼“å­˜å’Œå±€éƒ¨æ€§ã€‚</p>
<h3 id="æ ¸å¿ƒæ€è·¯-1">æ ¸å¿ƒæ€è·¯</h3>
<p>ä¸ºäº†å®ç°é«˜æ€§èƒ½çš„æ¥å£ï¼Œæˆ‘ä»¬å¿…é¡»è¦è§£å†³ä»¥ä¸‹ä¸‰ä¸ªé—®é¢˜ï¼š</p>
<ol>
<li>å­˜å‚¨è®¾è®¡é—®é¢˜ï¼Œè¦æ±‚èƒ½å¤Ÿæ”¯æŒé¡ºåºå†™ä¸éšæœºè¯»</li>
<li>IO/SSD ä¼˜åŒ–é—®é¢˜ï¼Œèƒ½å°½å¯èƒ½çš„ä½¿ IO åšåˆ°æé™</li>
<li>å†…å­˜è§„åˆ’é—®é¢˜ï¼Œç”±äºè¯„æµ‹ç¯å¢ƒå†…å­˜æ¯”è¾ƒæœ‰é™ï¼Œéœ€è¦ç´§å‡‘çš„è§„åˆ’å’Œä½¿ç”¨</li>
</ol>
<h4 id="å­˜å‚¨è®¾è®¡é¡µå¼å­˜å‚¨">å­˜å‚¨è®¾è®¡ï¼šé¡µå¼å­˜å‚¨</h4>
<p>é¦–å…ˆæˆ‘ä»¬ç ”ç©¶äº†ä¸€ä¸ªæ¯”è¾ƒç±»ä¼¼çš„äº§å“ï¼ŒKafkaï¼š</p>
<p><figure 
	
		class="gallery-image" 
		style="
			flex-grow: 215; 
			flex-basis: 516px"
	>
	<a href="/p/awrace-2018/img/15321022399044.jpg" data-size="904x420">
		<img src="/p/awrace-2018/img/15321022399044.jpg"
			width="904"
			height="420"
			srcset="/p/awrace-2018/img/15321022399044_hu4bb4523a07eff2093e6598edd29d0d43_98681_480x0_resize_q75_box.jpg 480w, /p/awrace-2018/img/15321022399044_hu4bb4523a07eff2093e6598edd29d0d43_98681_1024x0_resize_q75_box.jpg 1024w"
			loading="lazy"
			>
	</a>
	
</figure></p>
<p><figure 
	
		class="gallery-image" 
		style="
			flex-grow: 338; 
			flex-basis: 811px"
	>
	<a href="/p/awrace-2018/img/15321022432192.jpg" data-size="954x282">
		<img src="/p/awrace-2018/img/15321022432192.jpg"
			width="954"
			height="282"
			srcset="/p/awrace-2018/img/15321022432192_hu1c06df13f10d3387ac2ac27db6f6fc34_74387_480x0_resize_q75_box.jpg 480w, /p/awrace-2018/img/15321022432192_hu1c06df13f10d3387ac2ac27db6f6fc34_74387_1024x0_resize_q75_box.jpg 1024w"
			loading="lazy"
			>
	</a>
	
</figure></p>
<p>Kafka çš„å¤§è‡´å­˜å‚¨æ¨¡å‹å¦‚ä¸Šå›¾æ‰€ç¤ºï¼Œè¿™é‡Œå¹¶ä¸å±•å¼€å™è¿°ï¼Œæœ‰å…´è¶£çš„åŒå­¦å¯ä»¥åˆ°è¿™ä¸ªç½‘ç«™ç»§ç»­å­¦ä¹  <a class="link" href="https://thehoard.blog/how-kafkas-storage-internals-work-3a29b02e026"  target="_blank" rel="noopener"
    >https://thehoard.blog/how-kafkas-storage-internals-work-3a29b02e026</a></p>
<p>ä½†æ˜¯å¯¹äºæˆ‘ä»¬æ¥è¯´ï¼Œç…§æ¬å®ƒæœ‰å¾ˆå¤šé—®é¢˜ï¼š</p>
<ol>
<li>100w ä¸ªé˜Ÿåˆ—ï¼Œè‡³å°‘æœ‰ 200w ä¸ªæ–‡ä»¶ï¼Œè¿™å¯¹æ–‡ä»¶ç³»ç»Ÿå½¢æˆäº†å·¨å¤§çš„è´Ÿæ‹…</li>
<li>Kafka ä½¿ç”¨å…¨é‡ç´¢å¼•ï¼Œè€Œ 2g æ¶ˆæ¯çš„å…¨é‡ç´¢å¼•æ ¹æœ¬æ”¾ä¸è¿›å†…å­˜ï¼Œè‡³å°‘åšä¸¤çº§ç´¢å¼•ï¼Œè¿™åŠ é‡äº†è¯»çš„è´Ÿæ‹…</li>
<li>2g æ¶ˆæ¯çš„å…¨é‡ç´¢å¼•çš„ç£ç›˜ overhead å¤ªå¤§</li>
<li>é˜Ÿåˆ—çš„ä¸»è¦åœºæ™¯æ˜¯é¡ºåºè¯»ï¼Œå…¨é‡ç´¢å¼•ä¼˜åŠ¿å®Œå…¨æ²¡æœ‰å‘æŒ¥ (éšæœºè¯»)</li>
</ol>
<p>æ‰€ä»¥æˆ‘ä»¬å€Ÿé‰´äº†ä¸€ä¸ªå¸¸è§çš„æ–‡ä»¶åˆ‡åˆ†æ¨¡å¼ï¼Œä¹Ÿå°±æ˜¯åˆ†é¡µï¼Œå¹¶ä»¥é¡µä¸ºæœ€å°å•ä½è¿›è¡Œæ“ä½œå’Œå»ºç«‹ç´¢å¼•ã€‚è¿™å°±æ˜¯æˆ‘ä»¬çš„å­˜å‚¨æ¨¡å¼ï¼šé¡µå¼å­˜å‚¨ã€‚</p>
<p>é€šè¿‡è¿™ä¸ªå­˜å‚¨æ–¹å¼ï¼Œ</p>
<ul>
<li>å¯ä»¥æœ‰æ•ˆçš„å‡å°‘æ–‡ä»¶çš„æ•°ç›®</li>
<li>å¹¶ä¸”ç”±äºé¡ºåºå†™çš„æ€§è´¨ï¼Œæˆ‘ä»¬å¹¶ä¸éœ€è¦è€ƒè™‘è„é¡µçš„é—®é¢˜</li>
<li>åŒæ—¶ç”±äºé¡µæ˜¯æœ€å°å•ä½ï¼ŒåŒå±ä¸€ä¸ªé˜Ÿåˆ—çš„è¿ç»­æ¶ˆæ¯å°½å¯èƒ½çš„åœ¨ä¸€ä¸ªé¡µä¸­ï¼Œä¿è¯äº†é¡ºåºè¯»èƒ½å¤Ÿåˆ©ç”¨ç¼“å­˜å’Œå±€éƒ¨æ€§</li>
<li>æœ€åï¼Œæˆ‘ä»¬å¯¹é¡µå»ºç«‹ç´¢å¼•ï¼Œæ­¤æ—¶çš„ç´¢å¼•å·²ç»å®Œå…¨å¯ä»¥æ”¾å…¥å†…å­˜äº†</li>
</ul>
<p>ä¸ºäº†å…¼é¡¾å†…å­˜ï¼Œé¡µå¤§å°è®¾ç½®ä¸º 4kã€‚</p>
<h4 id="iossd-ä¼˜åŒ–å—è¯»å—å†™">IO/SSD ä¼˜åŒ–ï¼šå—è¯»å—å†™</h4>
<p>å¯¹äºç°æœ‰çš„å¤§å¤šæ•°å­˜å‚¨è®¾å¤‡æ¥è¯´ï¼Œæ— è®ºæ˜¯ HDD è¿˜æ˜¯ SSD ä¹Ÿå¥½ï¼Œé¡ºåºè¯»å†™æ°¸è¿œéƒ½æ˜¯æœ€ä¼˜çš„ã€‚</p>
<p>ä½†æ˜¯ï¼ŒSSD æœ‰åŒºåˆ«çš„ä¸€ç‚¹åœ¨äºï¼Œç”±äº SSD çš„ç‰¹æ€§ â€œå†…ç½®å¹¶å‘â€ï¼Œå¯¹é½äº Clustered Block çš„è¯»å†™å°†å®Œå…¨ä¸è¾“äºé¡ºåºè¯»å†™ã€‚</p>
<p>å¦‚æœè¦ç†è§£å†…ç½®å¹¶å‘è¿™ä¸ªäº‹æƒ…ï¼Œæˆ‘ä»¬å¯èƒ½éœ€è¦å»äº†è§£ä¸€äº› SSD çš„åŸç†ï¼Œä¸‹é¢è¿™ä¸ªç½‘ç«™æä¾›äº†æ›´å¤šçš„ç»†èŠ‚ï¼Œåœ¨è¿™é‡Œåªå™è¿°ä¸€éƒ¨åˆ†çš„ä¸œè¥¿ã€‚</p>
<p><a class="link" href="http://codecapsule.com/2014/02/12/coding-for-ssds-part-3-pages-blocks-and-the-flash-translation-layer/"  target="_blank" rel="noopener"
    >http://codecapsule.com/2014/02/12/coding-for-ssds-part-3-pages-blocks-and-the-flash-translation-layer/</a></p>
<p><figure 
	
		class="gallery-image" 
		style="
			flex-grow: 82; 
			flex-basis: 198px"
	>
	<a href="/p/awrace-2018/img/15321031573324.jpg" data-size="801x967">
		<img src="/p/awrace-2018/img/15321031573324.jpg"
			width="801"
			height="967"
			srcset="/p/awrace-2018/img/15321031573324_huea8623adfd433ef5c976570e570bcfa2_160898_480x0_resize_q75_box.jpg 480w, /p/awrace-2018/img/15321031573324_huea8623adfd433ef5c976570e570bcfa2_160898_1024x0_resize_q75_box.jpg 1024w"
			loading="lazy"
			>
	</a>
	
</figure></p>
<p>SSD çš„è¯»å†™éƒ½æ˜¯ä»¥é¡µ (NAND-flash page) ä¸ºå•ä½çš„ï¼Œå³ä½¿åªè¯»/å†™ä¸€ä¸ª bitï¼Œä¹Ÿä¼šåŒæ—¶è¯»/å†™ä¸€ä¸ªé¡µã€‚ç›¸é‚»çš„é¡µç»„æˆä¸€ä¸ªå—ï¼Œå—å¤§å°é€šå¸¸åœ¨ 256k åˆ° 4m ä¹‹é—´ã€‚SSD çš„è¿˜æœ‰äº›åŸç†ä¼šå¯¼è‡´ä¸€ä¸ªå†™æ”¾å¤§å’Œ GC çš„é—®é¢˜ï¼Œè¿™é‡Œä¸å†å±•å¼€ï¼Œæœ‰å…´è¶£çš„åŒå­¦è‡ªè¡Œäº†è§£ã€‚</p>
<p>SSD çš„å†…ç½®å¹¶å‘æŒ‡çš„æ˜¯ï¼Œå›¾ç¤ºä¸Šé¢çš„ä¸åŒ channel/package/chip/plane çš„è®¿é—®éƒ½æ˜¯å¯ä»¥å¹¶å‘è¿›è¡Œçš„ï¼Œä¸åŒçš„ plane ä¸Šçš„ block ç»„æˆçš„è®¿é—®å•ä½å«åšèšç°‡å— (Clustered Block)ï¼Œå¦‚å›¾ç¤ºä¸­é»„è‰²æ¡†ä¸­çš„éƒ¨åˆ†ã€‚å¯ä»¥çœ‹åˆ°ï¼Œè¯»å†™èšç°‡å—å°±èƒ½å……åˆ†åœ°å¹¶å‘è®¿é—®ï¼Œè€Œæˆ‘ä»¬æ¥ä¸‹æ¥è¦è®²çš„è¯»å†™æ¨¡å¼å°±æ˜¯ï¼Œå¯¹é½èšç°‡å—éšæœºè¯»å†™ï¼Œæ€§èƒ½å°†å®Œå…¨ä¸è¾“é¡ºåºè¯»å†™ã€‚è¿™é‡Œé¢å¤–æä¸€å¥ï¼Œé€šå¸¸èšç°‡å—å¤§å°ä¸º 32/64mã€‚</p>
<p>è¿™æ˜¯ä¸€å¼ éšæœºå†™ä¸é¡ºåºå†™çš„ååå¯¹æ¯”ï¼Œåœ¨ 32M/64M ä¸‹ï¼Œéšæœºå†™å·²ç»èƒ½å¤Ÿå…¨çº¿ç­‰åŒé¡ºåºå†™ã€‚
<figure 
	
		class="gallery-image" 
		style="
			flex-grow: 151; 
			flex-basis: 362px"
	>
	<a href="/p/awrace-2018/img/15321036720838.jpg" data-size="810x536">
		<img src="/p/awrace-2018/img/15321036720838.jpg"
			width="810"
			height="536"
			srcset="/p/awrace-2018/img/15321036720838_hu7aa2b71d568a824992a6f317ef0fc88d_121802_480x0_resize_q75_box.jpg 480w, /p/awrace-2018/img/15321036720838_hu7aa2b71d568a824992a6f317ef0fc88d_121802_1024x0_resize_q75_box.jpg 1024w"
			loading="lazy"
			>
	</a>
	
</figure></p>
<p>è€Œæˆ‘ä»¬ä¹Ÿåšäº†ä¸€ä¸ªå°æµ‹è¯•ï¼Œæµ‹è¯• 4g å¤§å°çš„æ–‡ä»¶è¯»å†™ï¼Œå•ä½éƒ½æ˜¯ç§’ï¼š</p>
<p><figure 
	
		class="gallery-image" 
		style="
			flex-grow: 316; 
			flex-basis: 759px"
	>
	<a href="/p/awrace-2018/img/15321037598597.jpg" data-size="1906x602">
		<img src="/p/awrace-2018/img/15321037598597.jpg"
			width="1906"
			height="602"
			srcset="/p/awrace-2018/img/15321037598597_hu24a85cf152ae3fa35fb59282832f4ac6_314186_480x0_resize_q75_box.jpg 480w, /p/awrace-2018/img/15321037598597_hu24a85cf152ae3fa35fb59282832f4ac6_314186_1024x0_resize_q75_box.jpg 1024w"
			loading="lazy"
			>
	</a>
	
</figure></p>
<p>å…¶ä¸­ concurrent pseudo sequential write æ˜¯æŒ‡å¤šä¸ªçº¿ç¨‹ä»åŒä¸€ä¸ª atomic int ä¸Šè·å–ä¸‹ä¸€ä¸ªå†™ offsetã€‚å®éªŒç»“æœè¯æ˜äº†è¿™ä¸ªæ¨¡å¼çš„æœ‰æ•ˆæ€§ã€‚</p>
<p>æ‰€ä»¥æˆ‘ä»¬æœ€åçš„è¯»å†™æ¨¡å¼ä¸ºå—è¯»å—å†™ï¼š</p>
<ul>
<li>å¤§å— (64m) å†™ï¼Œç”šè‡³å¯ä»¥ä¸ç”¨é¡ºåºå†™</li>
<li>æœ‰æ•ˆåœ°æé«˜äº†å¹¶å‘è¯»å†™æ€§èƒ½</li>
<li>é¡ºåºè¯»æ—¶å……åˆ†åˆ©ç”¨ç¼“å­˜å’Œé¢„è¯»</li>
</ul>
<h4 id="å†…å­˜è§„åˆ’ç²¾æ‰“ç»†ç®—">å†…å­˜è§„åˆ’ï¼šç²¾æ‰“ç»†ç®—</h4>
<p>åœ¨ç»“åˆä¸Šè¿°ä¸¤ä¸ªè®¾è®¡çš„åŸºç¡€ä¸Šï¼Œæˆ‘ä»¬å¯¹å†…å­˜æœ‰ä¸ªç²¾ç¡®çš„è§„åˆ’ï¼š</p>
<ul>
<li>æ¯ä¸ªé˜Ÿåˆ—æœ‰è‡ªå·±çš„ 4k é¡µç¼“å­˜ï¼Œå¯¹åº”äºå½“å‰æ­£åœ¨å†™çš„é¡µ</li>
<li>æ¯ä¸ª put çº¿ç¨‹æœ‰è‡ªå·±çš„åŒ 64m å†™ç¼“å†²ï¼Œç¼“å†²æ°¸è¿œå¯¹åº”æŸä¸ªæ–‡ä»¶çš„ä¸€ä¸ªåŒºé—´</li>
<li>æ€»è®¡åŠ èµ·æ¥ç¼“å­˜å…±å ç”¨ 4k * 1m + 64m * 2 â‰ˆ 5.2g</li>
</ul>
<h4 id="æ•´ä½“æ¶æ„">æ•´ä½“æ¶æ„</h4>
<p>Queue ä¸æ–‡ä»¶çš„å…³ç³»å¦‚ä¸‹å›¾ï¼š</p>
<p><figure 
	
		class="gallery-image" 
		style="
			flex-grow: 133; 
			flex-basis: 319px"
	>
	<a href="/p/awrace-2018/img/15321040869218.jpg" data-size="1390x1044">
		<img src="/p/awrace-2018/img/15321040869218.jpg"
			width="1390"
			height="1044"
			srcset="/p/awrace-2018/img/15321040869218_huacd3f5dc60665b25a2f31db973dbb916_102813_480x0_resize_q75_box.jpg 480w, /p/awrace-2018/img/15321040869218_huacd3f5dc60665b25a2f31db973dbb916_102813_1024x0_resize_q75_box.jpg 1024w"
			loading="lazy"
			>
	</a>
	
</figure>
é¡µä¸æ¶ˆæ¯çš„ç»“æ„å¦‚ä¸‹å›¾ï¼š</p>
<p><figure 
	
		class="gallery-image" 
		style="
			flex-grow: 133; 
			flex-basis: 319px"
	>
	<a href="/p/awrace-2018/img/15321040994886.jpg" data-size="1578x1184">
		<img src="/p/awrace-2018/img/15321040994886.jpg"
			width="1578"
			height="1184"
			srcset="/p/awrace-2018/img/15321040994886_huacd3f5dc60665b25a2f31db973dbb916_76700_480x0_resize_q75_box.jpg 480w, /p/awrace-2018/img/15321040994886_huacd3f5dc60665b25a2f31db973dbb916_76700_1024x0_resize_q75_box.jpg 1024w"
			loading="lazy"
			>
	</a>
	
</figure>
Size çš„è®¡ç®—é‡‡ç”¨å˜é•¿ç¼–ç ï¼š</p>
<ul>
<li>Size &lt; 128ï¼Œä½¿ç”¨ä¸€ä¸ª byte å­˜å‚¨ï¼Œç¬¬ä¸€ä¸ª bit ä¸º 0</li>
<li>Size &gt;= 128 å¹¶ä¸” &lt; 32768ï¼Œä½¿ç”¨ä¸¤ä¸ª byte å­˜å‚¨ï¼Œä½†æ˜¯ç”±äºç¬¬ä¸€ä¸ª bit ä¹Ÿä¸º 0ï¼Œæ‰€ä»¥å­˜å‚¨ size | 0x8000</li>
</ul>
<p>é’ˆå¯¹æ¯ä¸ªé¡µçš„ç´¢å¼•å¤§è‡´å¦‚ä¸‹ï¼š</p>
<p><figure 
	
		class="gallery-image" 
		style="
			flex-grow: 133; 
			flex-basis: 320px"
	>
	<a href="/p/awrace-2018/img/15321041984763.jpg" data-size="1582x1186">
		<img src="/p/awrace-2018/img/15321041984763.jpg"
			width="1582"
			height="1186"
			srcset="/p/awrace-2018/img/15321041984763_hu3b7b820f6188ac43dd748418d36a402e_116922_480x0_resize_q75_box.jpg 480w, /p/awrace-2018/img/15321041984763_hu3b7b820f6188ac43dd748418d36a402e_116922_1024x0_resize_q75_box.jpg 1024w"
			loading="lazy"
			>
	</a>
	
</figure></p>
<p>æ¯ä¸ªé¡µå­˜å‚¨é¡µç¼–å·ã€æ–‡ä»¶ç¼–å·ã€é¡µå†…æ¶ˆæ¯æ•°å’Œä¹‹å‰æ‰€æœ‰é¡µæ¶ˆæ¯æ•°è¿™å››é¡¹ï¼Œè¿™æ ·æˆ‘ä»¬åœ¨ get æ—¶äºŒåˆ†æŸ¥æ‰¾å°±å¯ä»¥è·å–åˆ°å¯¹åº”æ¶ˆæ¯æ‰€åœ¨çš„é¡µã€‚æ‰€æœ‰çš„ç´¢å¼•æ€»é‡å¤§çº¦ä¸º 12byte * 25m = 300mï¼Œå®Œå…¨å¯ä»¥æ”¾äºå†…å­˜ã€‚</p>
<h4 id="putget-æµç¨‹">Put/Get æµç¨‹</h4>
<p>è¿™ä¸¤ä¸ªæµç¨‹ç›¸å¯¹ç®€å•ï¼Œé¦–å…ˆæ˜¯ put æµç¨‹ï¼š</p>
<p><figure 
	
		class="gallery-image" 
		style="
			flex-grow: 133; 
			flex-basis: 320px"
	>
	<a href="/p/awrace-2018/img/15321043391182.jpg" data-size="1308x980">
		<img src="/p/awrace-2018/img/15321043391182.jpg"
			width="1308"
			height="980"
			srcset="/p/awrace-2018/img/15321043391182_huc5d40804f4c6da7eecc544ca84e32f82_156135_480x0_resize_q75_box.jpg 480w, /p/awrace-2018/img/15321043391182_huc5d40804f4c6da7eecc544ca84e32f82_156135_1024x0_resize_q75_box.jpg 1024w"
			loading="lazy"
			>
	</a>
	
</figure></p>
<ul>
<li>æ£€æŸ¥å†…å­˜ä¸­çš„é¡µè¿˜æœ‰æ²¡æœ‰ç©ºé—´
<ul>
<li>æœ‰ï¼Œç›´æ¥å†™å…¥</li>
<li>æ²¡æœ‰ï¼Œå°†å½“å‰é¡µå†™å‡ºï¼Œæ›´æ–°ç´¢å¼•ï¼Œç„¶åå†™å…¥æ¶ˆæ¯</li>
</ul>
</li>
</ul>
<p>é¡µå†™å‡ºæ—¶ä¼šæäº¤åˆ°å½“å‰ put çº¿ç¨‹çš„å†™ç¼“å†²ï¼Œå¹¶åé¦ˆä¿®æ”¹ç´¢å¼•ã€‚å½“å†™ç¼“å†²æ»¡çš„æ—¶å€™ï¼Œä¸åå¤‡çš„ç¼“å†²äº¤æ¢ç»§ç»­å†™å…¥ç¼“å†²ï¼Œå¹¶èµ·æ–°çš„çº¿ç¨‹åˆ·ç›˜ï¼Œè¿™æ ·å°½å¯èƒ½ä¸é˜»å¡ put çº¿ç¨‹ã€‚</p>
<p>åœ¨æ‰€æœ‰ get å‘ç”Ÿå‰ï¼Œæˆ‘ä»¬ä¼šå¼ºåˆ¶æ‰€æœ‰ç¼“å†²è½ç›˜ï¼Œæ¥ä¸‹æ¥çš„ get æµç¨‹ä¹Ÿç›¸å¯¹ç®€å•ï¼š</p>
<ul>
<li>äºŒåˆ†æŸ¥æ‰¾ç¬¬ä¸€é¡µå’Œæœ€åä¸€é¡µ</li>
<li>é¡ºåº<strong>é˜»å¡è¯»</strong>å¯¹åº”çš„æ–‡ä»¶é¡µ</li>
<li>è·³è¿‡é¡µå†…æ— å…³çš„æ¶ˆæ¯ï¼Œæ”¶é›†æ‰€æœ‰ç›¸å…³æ¶ˆæ¯</li>
<li>å¦‚æœè¯·æ±‚çš„æœ€åä¸€é¡µå‰©ä½™æ¶ˆæ¯æ•°å°äºæŸä¸ªé˜ˆå€¼ (e.g. 15)ï¼Œä½¿ç”¨ readahead é¢„è¯»ä¸‹ä¸€é¡µ</li>
<li>è¿”å›è¯·æ±‚çš„æ¶ˆæ¯</li>
</ul>
<p>æˆ‘ä»¬åœ¨ get çš„è¿‡ç¨‹ä¸­ä¿æŒä¸¤ä¸ªç†å¿µï¼š</p>
<ol>
<li>å…¨åŠ›ä½¿ç”¨ OS çš„é¡µç¼“å­˜</li>
<li>å°½å¯èƒ½é¢„è¯»ï¼Œä»¥æœŸæœ›å‡å°‘é¡ºåºè¯»çš„æ—¶é—´</li>
</ol>
<p>å…¨åŠ›ä½¿ç”¨ OS çš„é¡µç¼“å­˜ä¸»è¦æ˜¯è€ƒè™‘åˆ°</p>
<ol>
<li>å®ç° Concurrent LRU cache æ¯”è¾ƒéº»çƒ¦</li>
<li>å¦‚æœå®ç°é˜Ÿåˆ—çš„ä¸€ä¸ªé¡ºåºè¯»ç¼“å†²ï¼Œç±»ä¼¼äºé“¾è¡¨ç»“æ„ï¼Œä¸€æ—¦å‘ç”Ÿå¤šçº¿ç¨‹åŒæ—¶é¡ºåºè¯»ï¼Œç¼“å†²ä¼šä¸€ç›´å¤±æ•ˆï¼›å³ä½¿å®ç° thread local ç¼“å†²ï¼Œå¦‚æœå‡ºç°å•çº¿ç¨‹ä¸åŒåç§»é‡é¡ºåºè¯»åŒä¸€ä¸ªé˜Ÿåˆ— (e.g. å®Œæ•´è¯»ä¸¤æ¬¡)ï¼Œç¼“å†²ä¹Ÿä¼šä¸æ–­å¤±æ•ˆ</li>
</ol>
<p>æ‰€ä»¥ä¸å¦‚ç›´æ¥ä½¿ç”¨é¡µç¼“å­˜ã€‚</p>
<h3 id="å…³é”®ä»£ç -1">å…³é”®ä»£ç </h3>
<p>é˜Ÿåˆ—æ˜ å°„æˆ‘ä»¬ä½¿ç”¨äº† tbb çš„ concurrent hash mapï¼Œæœ€ç»ˆè¯æ˜è¿™æ˜¯æœ€å¤§çš„ cpu ç“¶é¢ˆï¼Œè€Œæˆ‘ä»¬çš„ put å®Œå…¨å¡åœ¨äº† cpu ä¸Šã€‚</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="k">template</span> <span class="o">&lt;</span><span class="k">class</span> <span class="nc">K</span><span class="p">,</span> <span class="k">class</span> <span class="nc">V</span><span class="p">,</span> <span class="k">class</span> <span class="nc">C</span> <span class="o">=</span> <span class="n">tbb</span><span class="o">::</span><span class="n">tbb_hash_compare</span><span class="o">&lt;</span><span class="n">K</span><span class="o">&gt;</span><span class="p">,</span>
          <span class="k">class</span> <span class="nc">A</span> <span class="o">=</span> <span class="n">tbb</span><span class="o">::</span><span class="n">cache_aligned_allocator</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">pair</span><span class="o">&lt;</span><span class="k">const</span> <span class="n">K</span><span class="p">,</span> <span class="n">V</span><span class="o">&gt;&gt;&gt;</span>
<span class="k">class</span> <span class="nc">ConcurrentHashMapProxy</span> <span class="o">:</span> <span class="k">public</span> <span class="n">tbb</span><span class="o">::</span><span class="n">concurrent_hash_map</span><span class="o">&lt;</span><span class="n">K</span><span class="p">,</span> <span class="n">V</span><span class="p">,</span> <span class="n">C</span><span class="p">,</span> <span class="n">A</span><span class="o">&gt;</span> <span class="p">{</span>
<span class="k">public</span><span class="o">:</span>
    <span class="n">ConcurrentHashMapProxy</span><span class="p">(</span><span class="n">size_t</span> <span class="n">n</span><span class="p">)</span> <span class="o">:</span> <span class="n">tbb</span><span class="o">::</span><span class="n">concurrent_hash_map</span><span class="o">&lt;</span><span class="n">K</span><span class="p">,</span> <span class="n">V</span><span class="p">,</span> <span class="n">C</span><span class="p">,</span> <span class="n">A</span><span class="o">&gt;</span><span class="p">(</span><span class="n">n</span><span class="p">)</span> <span class="p">{}</span>
    <span class="o">~</span><span class="n">ConcurrentHashMapProxy</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">this</span><span class="o">-&gt;</span><span class="n">tbb</span><span class="o">::</span><span class="n">concurrent_hash_map</span><span class="o">&lt;</span><span class="n">K</span><span class="p">,</span> <span class="n">V</span><span class="p">,</span> <span class="n">C</span><span class="p">,</span> <span class="n">A</span><span class="o">&gt;::~</span><span class="n">concurrent_hash_map</span><span class="o">&lt;</span><span class="n">K</span><span class="p">,</span> <span class="n">V</span><span class="p">,</span> <span class="n">C</span><span class="p">,</span> <span class="n">A</span><span class="o">&gt;</span><span class="p">();</span>
    <span class="p">}</span>
    <span class="k">typename</span> <span class="n">tbb</span><span class="o">::</span><span class="n">concurrent_hash_map</span><span class="o">&lt;</span><span class="n">K</span><span class="p">,</span> <span class="n">V</span><span class="p">,</span> <span class="n">C</span><span class="p">,</span> <span class="n">A</span><span class="o">&gt;::</span><span class="n">const_pointer</span> <span class="n">fast_find</span><span class="p">(</span><span class="k">const</span> <span class="n">K</span><span class="o">&amp;</span> <span class="n">key</span><span class="p">)</span> <span class="k">const</span> <span class="p">{</span>
        <span class="k">return</span> <span class="k">this</span><span class="o">-&gt;</span><span class="n">internal_fast_find</span><span class="p">(</span><span class="n">key</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">};</span>

<span class="n">MessageQueue</span><span class="o">*</span> <span class="n">QueueStore</span><span class="o">::</span><span class="n">find_or_create_queue</span><span class="p">(</span><span class="k">const</span> <span class="n">String</span><span class="o">&amp;</span> <span class="n">queue_name</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">auto</span> <span class="n">q_ptr</span> <span class="o">=</span> <span class="n">queues_</span><span class="p">.</span><span class="n">fast_find</span><span class="p">(</span><span class="n">queue_name</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">q_ptr</span><span class="p">)</span> <span class="k">return</span> <span class="n">q_ptr</span><span class="o">-&gt;</span><span class="n">second</span><span class="p">;</span>

    <span class="k">decltype</span><span class="p">(</span><span class="n">queues_</span><span class="p">)</span><span class="o">::</span><span class="n">const_accessor</span> <span class="n">ac</span><span class="p">;</span>
    <span class="n">queues_</span><span class="p">.</span><span class="n">find</span><span class="p">(</span><span class="n">ac</span><span class="p">,</span> <span class="n">queue_name</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">ac</span><span class="p">.</span><span class="n">empty</span><span class="p">())</span> <span class="p">{</span>
        <span class="kt">uint32_t</span> <span class="n">queue_id</span> <span class="o">=</span> <span class="n">next_queue_id_</span><span class="p">.</span><span class="n">next</span><span class="p">();</span>
        <span class="k">auto</span> <span class="n">queue_ptr</span> <span class="o">=</span> <span class="k">new</span> <span class="n">MessageQueue</span><span class="p">(</span><span class="n">queue_id</span><span class="p">,</span> <span class="k">this</span><span class="p">);</span>
        <span class="n">queues_</span><span class="p">.</span><span class="n">insert</span><span class="p">(</span><span class="n">ac</span><span class="p">,</span> <span class="n">std</span><span class="o">::</span><span class="n">make_pair</span><span class="p">(</span><span class="n">queue_name</span><span class="p">,</span> <span class="n">queue_ptr</span><span class="p">));</span>
        <span class="n">DLOG</span><span class="p">(</span><span class="s">&#34;Created a new queue, id: %d, name: %s&#34;</span><span class="p">,</span> <span class="n">q</span><span class="o">-&gt;</span><span class="n">get_queue_id</span><span class="p">(),</span>
             <span class="n">q</span><span class="o">-&gt;</span><span class="n">get_queue_name</span><span class="p">().</span><span class="n">c_str</span><span class="p">());</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="n">ac</span><span class="o">-&gt;</span><span class="n">second</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">MessageQueue</span><span class="o">*</span> <span class="n">QueueStore</span><span class="o">::</span><span class="n">find_queue</span><span class="p">(</span><span class="k">const</span> <span class="n">String</span><span class="o">&amp;</span> <span class="n">queue_name</span><span class="p">)</span> <span class="k">const</span> <span class="p">{</span>
    <span class="k">auto</span> <span class="n">q_ptr</span> <span class="o">=</span> <span class="n">queues_</span><span class="p">.</span><span class="n">fast_find</span><span class="p">(</span><span class="n">queue_name</span><span class="p">);</span>
    <span class="k">return</span> <span class="n">q_ptr</span> <span class="o">?</span> <span class="n">q_ptr</span><span class="o">-&gt;</span><span class="nl">second</span> <span class="p">:</span> <span class="k">nullptr</span><span class="p">;</span>

    <span class="k">decltype</span><span class="p">(</span><span class="n">queues_</span><span class="p">)</span><span class="o">::</span><span class="n">const_accessor</span> <span class="n">ac</span><span class="p">;</span>
    <span class="n">queues_</span><span class="p">.</span><span class="n">find</span><span class="p">(</span><span class="n">ac</span><span class="p">,</span> <span class="n">queue_name</span><span class="p">);</span>
    <span class="k">return</span> <span class="n">ac</span><span class="p">.</span><span class="n">empty</span><span class="p">()</span> <span class="o">?</span> <span class="k">nullptr</span> <span class="o">:</span> <span class="n">ac</span><span class="o">-&gt;</span><span class="n">second</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="n">QueueStore</span><span class="o">::</span><span class="n">put</span><span class="p">(</span><span class="k">const</span> <span class="n">String</span><span class="o">&amp;</span> <span class="n">queue_name</span><span class="p">,</span> <span class="k">const</span> <span class="n">MemBlock</span><span class="o">&amp;</span> <span class="n">message</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">message</span><span class="p">.</span><span class="n">ptr</span><span class="p">)</span> <span class="k">return</span><span class="p">;</span>
    <span class="k">auto</span> <span class="n">q_ptr</span> <span class="o">=</span> <span class="n">find_or_create_queue</span><span class="p">(</span><span class="n">queue_name</span><span class="p">);</span>
    <span class="n">q_ptr</span><span class="o">-&gt;</span><span class="n">put</span><span class="p">(</span><span class="n">message</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">Vector</span><span class="o">&lt;</span><span class="n">MemBlock</span><span class="o">&gt;</span> <span class="n">QueueStore</span><span class="o">::</span><span class="n">get</span><span class="p">(</span><span class="k">const</span> <span class="n">String</span><span class="o">&amp;</span> <span class="n">queue_name</span><span class="p">,</span> <span class="kt">long</span> <span class="n">offset</span><span class="p">,</span> <span class="kt">long</span> <span class="n">size</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">flushed</span><span class="p">)</span> <span class="n">flush_all_before_read</span><span class="p">();</span>

    <span class="k">auto</span> <span class="n">q_ptr</span> <span class="o">=</span> <span class="n">find_queue</span><span class="p">(</span><span class="n">queue_name</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">q_ptr</span><span class="p">)</span> <span class="k">return</span> <span class="n">q_ptr</span><span class="o">-&gt;</span><span class="n">get</span><span class="p">(</span><span class="n">offset</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>
    <span class="c1">// return empty list when queue is not found
</span><span class="c1"></span>    <span class="k">return</span> <span class="n">Vector</span><span class="o">&lt;</span><span class="n">MemBlock</span><span class="o">&gt;</span><span class="p">();</span>
<span class="p">}</span>
</code></pre></div><p>ç„¶åæ˜¯æˆ‘ä»¬çš„ä¸»è¦æ•°æ®ç»“æ„ FilePageï¼š</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="c1">// File page header
</span><span class="c1"></span><span class="k">struct</span> <span class="nf">__attribute__</span><span class="p">((</span><span class="n">__packed__</span><span class="p">))</span> <span class="n">FilePageHeader</span> <span class="p">{</span>
    <span class="kt">uint64_t</span> <span class="n">offset</span> <span class="o">=</span> <span class="n">NEGATIVE_OFFSET</span><span class="p">;</span>
<span class="p">};</span>

<span class="cp">#define FILE_PAGE_HEADER_SIZE sizeof(FilePageHeader)
</span><span class="cp">#define FILE_PAGE_AVAILABLE_SIZE (FILE_PAGE_SIZE - FILE_PAGE_HEADER_SIZE)
</span><span class="cp"></span>
<span class="c1">// File page
</span><span class="c1"></span><span class="k">struct</span> <span class="nf">__attribute__</span><span class="p">((</span><span class="n">__packed__</span><span class="p">))</span> <span class="n">FilePage</span> <span class="p">{</span>
    <span class="n">FilePageHeader</span> <span class="n">header</span><span class="p">;</span>
    <span class="kt">char</span> <span class="n">content</span><span class="p">[</span><span class="n">FILE_PAGE_AVAILABLE_SIZE</span><span class="p">];</span>
<span class="p">};</span>
</code></pre></div><p>åŒå†™ç¼“å†²æœ‰ä¸ªäº¤æ¢ä¸Šçš„åŒæ­¥ï¼Œæˆ‘ä»¬ä½¿ç”¨ mutex å»è¿›è¡Œè¿™ä¸ªåŒæ­¥ï¼š</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="c1">// buffer is full, switch to back
</span><span class="c1"></span><span class="p">{</span>
    <span class="c1">// spin wait until back buf is not in scheduled status
</span><span class="c1"></span>    <span class="k">while</span> <span class="p">(</span><span class="n">back_buf_status</span><span class="o">-&gt;</span><span class="n">load</span><span class="p">()</span> <span class="o">==</span> <span class="n">BACK_BUF_FLUSH_SCHEDULED</span><span class="p">)</span>
        <span class="p">;</span>
    <span class="c1">// try swap active and back buffer
</span><span class="c1"></span>    <span class="n">std</span><span class="o">::</span><span class="n">unique_lock</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">mutex</span><span class="o">&gt;</span> <span class="n">lock</span><span class="p">(</span><span class="o">*</span><span class="n">back_buf_mutex</span><span class="p">);</span>
    <span class="n">std</span><span class="o">::</span><span class="n">swap</span><span class="p">(</span><span class="n">active_buf</span><span class="p">,</span> <span class="n">back_buf</span><span class="p">);</span>
    <span class="n">assert</span><span class="p">(</span><span class="n">back_buf_status</span><span class="o">-&gt;</span><span class="n">load</span><span class="p">()</span> <span class="o">==</span> <span class="n">BACK_BUF_FREE</span><span class="p">);</span>
    <span class="kt">uint32_t</span> <span class="n">exp</span> <span class="o">=</span> <span class="n">BACK_BUF_FREE</span><span class="p">;</span>
    <span class="n">back_buf_status</span><span class="o">-&gt;</span><span class="n">compare_exchange_strong</span><span class="p">(</span><span class="n">exp</span><span class="p">,</span> <span class="n">BACK_BUF_FLUSH_SCHEDULED</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div><p>ä¸ºäº†ä½¿å¾— OS å……åˆ†çš„è·‘èµ·æ¥ï¼Œget é˜¶æ®µéœ€è¦é‡Šæ”¾æ‰æ‰€æœ‰æ— ç”¨çš„å†…å­˜ï¼Œç„¶è€Œ tcmalloc æ˜¯ä¸ä¼šä¸»åŠ¨é‡Šæ”¾çš„ï¼Œæ‰€ä»¥éœ€è¦å¼ºåˆ¶é‡Šæ”¾ï¼š</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="c1">// release free memory back to os
</span><span class="c1"></span><span class="n">MallocExtension</span><span class="o">::</span><span class="n">instance</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">ReleaseFreeMemory</span><span class="p">();</span>
</code></pre></div><p>ç”±äºçº¿ä¸Šçš„å†™å…¥å¤ªè¿‡äºå‡åŒ€ï¼Œåˆ°äº†åˆ·ç›˜çš„æ—¶å€™å°±æ˜¯æ‰€æœ‰é¡µç¼“å­˜ä¸€èµ·åˆ·ç›˜ï¼Œè¿™ä¼šé€ æˆæ‰€æœ‰ put çº¿ç¨‹éƒ½é˜»å¡å¹¶ç­‰å¾…çš„çŠ¶å†µï¼Œä¸ºäº†ç¼“è§£è¿™ä¸ªæƒ…å†µï¼Œæˆ‘ä»¬è®©æŸäº›é˜Ÿåˆ—çš„ç¬¬ä¸€é¡µå¿«é€Ÿå†™å‡ºï¼š</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="c1">// first page will hold at most (queue_id / DATA_FILE_SPLITS) % 64 + 1 messages, this make write
</span><span class="c1">// more average. This leads to 64 timepoints of first flush. I call it flush fast.
</span><span class="c1"></span><span class="kt">bool</span> <span class="n">flush_fast</span> <span class="o">=</span>
    <span class="n">paged_message_indices_</span><span class="p">.</span><span class="n">size</span><span class="p">()</span> <span class="o">==</span> <span class="mi">1</span> <span class="o">&amp;&amp;</span>
    <span class="n">paged_message_indices_</span><span class="p">.</span><span class="n">back</span><span class="p">().</span><span class="n">msg_size</span> <span class="o">&gt;=</span> <span class="p">((</span><span class="n">queue_id_</span> <span class="o">/</span> <span class="n">DATA_FILE_SPLITS</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x3f</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
</code></pre></div><p>å…¶ä½™ä»£ç æ”¾åœ¨ <a class="link" href="https://code.aliyun.com/arkbriar/queue-race-2018-cpp"  target="_blank" rel="noopener"
    >https://code.aliyun.com/arkbriar/queue-race-2018-cpp</a> ä¸­ã€‚</p>
<h3 id="æœ€ç»ˆæˆç»©">æœ€ç»ˆæˆç»©</h3>
<p>æœ€å¿«å†™å…¥æ—¶é—´å¤§çº¦ 690sï¼Œæœ€ç»ˆç¼“å­˜è½ç›˜ 20sï¼Œéšæœºæ ¡éªŒ 120sï¼Œé¡ºåºæ ¡éªŒ 140sï¼Œæ€»è®¡ 970s+ã€‚</p>
<p>æœŸé—´ä» 1.9 å¼€å§‹çš„æå‡å…¨åœ¨å‹ç¼© cpu å¼€é”€ï¼Œæ²¡æœ‰åŠ¨è¿‡è¯»å†™ç»“æ„ã€‚</p>
<h3 id="å·¥ç¨‹ä»·å€¼ä¸å¥å£®æ€§">å·¥ç¨‹ä»·å€¼ä¸å¥å£®æ€§</h3>
<p>åœ¨å­˜å‚¨è®¾è®¡è¿‡ç¨‹ä¸­ï¼Œæˆ‘ä»¬å……åˆ†è€ƒè™‘åˆ°äº†é•¿æ¶ˆæ¯çš„å­˜åœ¨ï¼›è™½ç„¶åœ¨æ¯”èµ›ä»£ç çš„å®ç°ä¸­ï¼Œæˆ‘ä»¬æœ€é•¿æ”¯æŒä¹Ÿå°±æ˜¯ 4k å¤šä¸€ç‚¹çš„é•¿åº¦ï¼Œä½†æ˜¯å´å¯ä»¥å¾ˆè½»æ˜“çš„æ”¯æŒè·¨é¡µæ¶ˆæ¯æ¥å»æ‰è¿™ä¸ªé™åˆ¶ã€‚</p>
<p>åœ¨ put çš„è®¾è®¡è¿‡ç¨‹ä¸­ï¼Œæˆ‘ä»¬å……åˆ†åˆ©ç”¨äº† SSD çš„ç‰¹æ€§ï¼Œä½¿å¾—å³ä½¿æ˜¯éšæœºå†™ä¹Ÿèƒ½è¾¾åˆ°æœ€å¤§çš„ç£ç›˜ååã€‚é—æ†¾çš„æ˜¯ï¼Œæœ€ç»ˆæˆ‘ä»¬æ·±é™· cpu ç“¶é¢ˆä»æ¥æ²¡æœ‰è·‘å‡ºè¿‡æœ€å¤§ååã€‚</p>
<p>è™½ç„¶è€ƒè™‘åˆ°åœºæ™¯ä¸‹æ²¡æœ‰è¾¹è¯»è¾¹å†™çš„æƒ…å†µï¼Œä½†æ˜¯é€šè¿‡åœ¨é˜Ÿåˆ—æ˜ å°„ä¸ŠåŠ è¯»å†™é”ï¼Œæˆ–è€…åœ¨æ›´ç»†ç²’åº¦çš„å†…å­˜é¡µä¸ŠåŠ é”ï¼Œå¹¶åœ¨è¯»æ—¶è€ƒè™‘å†…å­˜ä¸­æœªè½ç›˜çš„æ•°æ®ï¼Œåˆ™ç«‹åˆ»å¯ä»¥æ”¯æŒè¾¹è¯»è¾¹å†™ã€‚</p>
<h2 id="æ€»ç»“ä¸æ„Ÿæƒ³">æ€»ç»“ä¸æ„Ÿæƒ³</h2>
<p>å¯¹å„ç§çŸ¥è¯†çš„ç†è§£å’Œè¿ç”¨æ˜¯è§£å†³å®é™…é—®é¢˜çš„å…³é”®ï¼Œåœ¨ä¸å„ä½é€‰æ‰‹çš„äº¤æµä¸ç«äº‰ä¸­ï¼Œæˆ‘ä»¬å­¦åˆ°äº†å¾ˆå¤šçŸ¥è¯†ï¼Œç›¸ä¿¡å¤§å®¶é€šè¿‡è¿™æ¬¡æ¯”èµ›ä¹Ÿèƒ½æ”¶è·å¾ˆå¤šã€‚</p>

</section>


    <footer class="article-footer">
    
    <section class="article-tags">
        
            <a href="/tags/contest/">contest</a>
        
            <a href="/tags/middelware/">middelware</a>
        
    </section>


    
    <section class="article-copyright">
        <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-copyright" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="12" cy="12" r="9" />
  <path d="M14.5 9a3.5 4 0 1 0 0 6" />
</svg>



        <span>Licensed under CC BY-NC-SA 4.0</span>
    </section>
    </footer>


    
</article>

    <aside class="related-contents--wrapper">
    
    
        <h2 class="section-title">ç›¸å…³æ–‡ç« </h2>
        <div class="related-contents">
            <div class="flex article-list--tile">
                
                    
<article class="">
    <a href="/p/awrace-topkn/">
        
        

        <div class="article-details">
            <h2 class="article-title">2017 Alibaba Middleware 24h Final (Just for Fun ğŸ˜€)</h2>
        </div>
    </a>
</article>
                
            </div>
        </div>
    
</aside>

     
     
        
    <div class="disqus-container">
    <div id="disqus_thread"></div>
<script type="application/javascript">
    var disqus_config = function () {
    
    
    
    };
    (function() {
        if (["localhost", "127.0.0.1"].indexOf(window.location.hostname) != -1) {
            document.getElementById('disqus_thread').innerHTML = 'Disqus comments not available by default when the website is previewed locally.';
            return;
        }
        var d = document, s = d.createElement('script'); s.async = true;
        s.src = '//' + "crazyark" + '.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="https://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
</div>

<style>
    .disqus-container {
        background-color: var(--card-background);
        border-radius: var(--card-border-radius);
        box-shadow: var(--shadow-l1);
        padding: var(--card-padding);
    }
</style>

<script>
    window.addEventListener('onColorSchemeChange', (e) => {
        if (DISQUS) {
            DISQUS.reset({
                reload: true
            });
        }
    })
</script>

    

    <footer class="site-footer">
    <section class="copyright">
        &copy; 
        
            2018 - 
        
        2021 çŸ³æ²‰æºªæ´ -- Ark&#39;s Blog
    </section>
    
    <section class="powerby">
        Built with <a href="https://gohugo.io/" target="_blank" rel="noopener">Hugo</a> <br />
        Theme <b><a href="https://github.com/CaiJimmy/hugo-theme-stack" target="_blank" rel="noopener" data-version="3.2.0">Stack</a></b> designed by <a href="https://jimmycai.com" target="_blank" rel="noopener">Jimmy</a>
    </section>
</footer>


    
<div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">

    
    <div class="pswp__bg"></div>

    
    <div class="pswp__scroll-wrap">

        
        <div class="pswp__container">
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
        </div>

        
        <div class="pswp__ui pswp__ui--hidden">

            <div class="pswp__top-bar">

                

                <div class="pswp__counter"></div>

                <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>

                <button class="pswp__button pswp__button--share" title="Share"></button>

                <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>

                <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>

                
                
                <div class="pswp__preloader">
                    <div class="pswp__preloader__icn">
                        <div class="pswp__preloader__cut">
                            <div class="pswp__preloader__donut"></div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
                <div class="pswp__share-tooltip"></div>
            </div>

            <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
            </button>

            <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
            </button>

            <div class="pswp__caption">
                <div class="pswp__caption__center"></div>
            </div>

        </div>

    </div>

</div><script 
                src="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.js"integrity="sha256-ePwmChbbvXbsO02lbM3HoHbSHTHFAeChekF1xKJdleo="crossorigin="anonymous"
                defer="true"
                >
            </script><script 
                src="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe-ui-default.min.js"integrity="sha256-UKkzOn/w1mBxRmLLGrSeyB4e1xbrp4xylgAWb3M42pU="crossorigin="anonymous"
                defer="true"
                >
            </script><link 
                rel="stylesheet" 
                href="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/default-skin/default-skin.css"integrity="sha256-c0uckgykQ9v5k&#43;IqViZOZKc47Jn7KQil4/MP3ySA3F8="crossorigin="anonymous"
            ><link 
                rel="stylesheet" 
                href="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.css"integrity="sha256-SBLU4vv6CA6lHsZ1XyTdhyjJxCjPif/TRkjnsyGAGnE="crossorigin="anonymous"
            >

            </main>
    
        <aside class="sidebar right-sidebar sticky">
            <section class="widget archives">
                <div class="widget-icon">
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-hash" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <line x1="5" y1="9" x2="19" y2="9" />
  <line x1="5" y1="15" x2="19" y2="15" />
  <line x1="11" y1="4" x2="7" y2="20" />
  <line x1="17" y1="4" x2="13" y2="20" />
</svg>



                </div>
                <h2 class="widget-title section-title">ç›®å½•</h2>
                
                <div class="widget--toc">
                    <nav id="TableOfContents">
  <ol>
    <li><a href="#åˆèµ›éƒ¨åˆ†">åˆèµ›éƒ¨åˆ†</a>
      <ol>
        <li><a href="#èµ›é¢˜èƒŒæ™¯åˆ†æåŠç†è§£">èµ›é¢˜èƒŒæ™¯åˆ†æåŠç†è§£</a></li>
        <li><a href="#æ ¸å¿ƒæ€è·¯">æ ¸å¿ƒæ€è·¯</a></li>
        <li><a href="#å…³é”®ä»£ç ">å…³é”®ä»£ç </a></li>
      </ol>
    </li>
    <li><a href="#å¤èµ›éƒ¨åˆ†">å¤èµ›éƒ¨åˆ†</a>
      <ol>
        <li><a href="#èµ›é¢˜èƒŒæ™¯åˆ†æåŠç†è§£-1">èµ›é¢˜èƒŒæ™¯åˆ†æåŠç†è§£</a></li>
        <li><a href="#æ ¸å¿ƒæ€è·¯-1">æ ¸å¿ƒæ€è·¯</a>
          <ol>
            <li><a href="#å­˜å‚¨è®¾è®¡é¡µå¼å­˜å‚¨">å­˜å‚¨è®¾è®¡ï¼šé¡µå¼å­˜å‚¨</a></li>
            <li><a href="#iossd-ä¼˜åŒ–å—è¯»å—å†™">IO/SSD ä¼˜åŒ–ï¼šå—è¯»å—å†™</a></li>
            <li><a href="#å†…å­˜è§„åˆ’ç²¾æ‰“ç»†ç®—">å†…å­˜è§„åˆ’ï¼šç²¾æ‰“ç»†ç®—</a></li>
            <li><a href="#æ•´ä½“æ¶æ„">æ•´ä½“æ¶æ„</a></li>
            <li><a href="#putget-æµç¨‹">Put/Get æµç¨‹</a></li>
          </ol>
        </li>
        <li><a href="#å…³é”®ä»£ç -1">å…³é”®ä»£ç </a></li>
        <li><a href="#æœ€ç»ˆæˆç»©">æœ€ç»ˆæˆç»©</a></li>
        <li><a href="#å·¥ç¨‹ä»·å€¼ä¸å¥å£®æ€§">å·¥ç¨‹ä»·å€¼ä¸å¥å£®æ€§</a></li>
      </ol>
    </li>
    <li><a href="#æ€»ç»“ä¸æ„Ÿæƒ³">æ€»ç»“ä¸æ„Ÿæƒ³</a></li>
  </ol>
</nav>
                </div>
            </section>
        </aside>
    

        </div>
        <script 
                src="https://cdn.jsdelivr.net/npm/node-vibrant@3.1.5/dist/vibrant.min.js"integrity="sha256-5NovOZc4iwiAWTYIFiIM7DxKUXKWvpVEuMEPLzcm5/g="crossorigin="anonymous"
                defer="false"
                >
            </script><script type="text/javascript" src="/ts/main.js" defer></script>
<script>
    (function () {
        const customFont = document.createElement('link');
        customFont.href = "https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&display=swap";

        customFont.type = "text/css";
        customFont.rel = "stylesheet";

        document.head.appendChild(customFont);
    }());
</script>

    </body>
</html>
