<!DOCTYPE html>
<html>

<head>
  <title> ç¨€ç–è¡¨å’Œå¹¶è¡ŒäºŒåˆ†æŸ¥æ‰¾ (Sparse Table &amp; Parallel Binary Search) &middot; crazy.ark </title>
  
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">
<meta name="generator" content="Hugo 0.87.0" />


<link rel="stylesheet" href="https://blog.crazyark.xyz/css/vec.css">
<link rel="stylesheet" href="https://blog.crazyark.xyz/css/github.css">


<link rel="apple-touch-icon-precomposed" sizes="144x144" href="/apple-touch-icon-144-precomposed.png">
<link rel="shortcut icon" href="/favicon.ico">


<link href="" rel="alternate" type="application/rss+xml" title="crazy.ark" />

</head>

<body>
  <header>
  <nav>
    <ul>
      
      
      <li class="pull-left ">
        <a href="https://blog.crazyark.xyz/">/home/crazy.ark</a>
      </li>
      
      
      <li class="pull-left ">
        <a href="/about">~/about</a>
      </li>
      
      
      <li class="pull-left ">
        <a href="/contact">~/contact</a>
      </li>
      
      
      <li class="pull-left ">
        <a href="https://ericfu.me">~/external/coding husky</a>
      </li>
      
      
      <li class="pull-left current">
        <a href="/posts">~/posts</a>
      </li>
      
  
      <li class="pull-right"><a href=""><i class="fas fa-rss"></i></a></li>
    </ul>
  </nav>
</header>

  <div class="content toc">
    <nav id="TableOfContents">
  <ul>
    <li>
      <ul>
        <li><a href="#sparse-table">Sparse Table</a></li>
        <li><a href="#parallel-binary-search">Parallel Binary Search</a></li>
        <li><a href="#conclusion">Conclusion</a></li>
        <li><a href="#reference">Reference</a></li>
        <li><a href="#appendix">Appendix</a></li>
      </ul>
    </li>
  </ul>
</nav>
    
    <section class="post">
      <h1 class="post-title"><a href="https://blog.crazyark.xyz/posts/hourrank23/">ç¨€ç–è¡¨å’Œå¹¶è¡ŒäºŒåˆ†æŸ¥æ‰¾ (Sparse Table &amp; Parallel Binary Search)</a></h1>
      <span class="post-date">Sep 10, 2017 </span>
      <div class="post-content">
        <p>ä¸åˆ·é¢˜ä¸çŸ¥é“è‡ªå·±èœï¼Œè¶Šåˆ·é¢˜è¶Šå‘ç°è‡ªå·±ğŸ™„ â€”â€” è®° HourRank23 è¢«è™ã€‚</p>
<h3 id="sparse-table">Sparse Table</h3>
<p>è¿˜è®°å¾—ä¸Šä¸¤ç¯‡çº¿æ®µæ ‘å’ŒBITéƒ½è®²åˆ°äº†åŒºé—´æŸ¥æ‰¾çš„é—®é¢˜ï¼Œæˆ‘ä»¬æ¥å›å¿†ä¸€ä¸‹ã€‚</p>
<p>çº¿æ®µæ ‘ç©ºé—´æ”¯æŒå„ç§å‡½æ•°(Associativeï¼Œéœ€è¦æ»¡è¶³ç»“åˆå¾‹)çš„åŒºé—´æ›´æ–°å’ŒåŒºé—´æŸ¥è¯¢ï¼Œç©ºé—´å¤æ‚åº¦æ˜¯ O(nlgn)ï¼Œæ›´æ–°å’ŒæŸ¥è¯¢çš„æ—¶é—´å¤æ‚åº¦éƒ½æ˜¯ O(lgn)ã€‚</p>
<p>BIT æ”¯æŒä»»æ„ç¾¤ä¸Šè¿ç®—çš„å•ç‚¹æ›´æ–°/åŒºé—´æŸ¥è¯¢ã€åŒºé—´æ›´æ–°/å•ç‚¹æŸ¥è¯¢ï¼Œç©ºé—´å¤æ‚åº¦æ˜¯ O(n)ï¼Œæ›´æ–°å’ŒæŸ¥è¯¢çš„æ—¶é—´å¤æ‚åº¦ä¹Ÿéƒ½æ˜¯ O(lgn) (å…¶å®å–å†³äºé€†å…ƒæ„é€ é€Ÿåº¦)ã€‚BIT çš„åŒºé—´æ›´æ–°/åŒºé—´æŸ¥è¯¢æ³›åŒ–éœ€è¦æ›´å¤šæ€§è´¨ï¼Œåæ­£ä¸»è¦æ˜¯ç”¨äºæ•´æ•°åŸŸä¸Šçš„å’Œè¿ç®—ã€‚</p>
<p>è€Œè¿™é‡Œæ‰€è¦è®²çš„ Sparse Table æ˜¯å¦ä¸€ç§æ”¯æŒåŒºé—´æŸ¥è¯¢çš„æ•°æ®ç»“æ„ï¼Œé’ˆå¯¹çš„æ˜¯<strong>ä¸å˜çš„ï¼ˆimmutableï¼‰çš„æ•°ç»„</strong>ï¼Œå…¶ç©ºé—´å¤æ‚åº¦ä¸º O(nlgn)ã€‚</p>
<p>Sparse Table åŒæ ·æ”¯æŒå„ç§å‡½æ•°ï¼Œåªè¦æ˜¯æ»¡è¶³ç»“åˆå¾‹çš„å‡½æ•°ä¸€å¾‹éƒ½æ˜¯æ”¯æŒçš„ï¼Œå¯¹æ‰€æœ‰è¿™æ ·çš„å‡½æ•°ï¼Œå…¶æ—¶é—´å¤æ‚åº¦ä¸º O(nlgn)ï¼Œè€Œä¸”æ€æƒ³å’Œç¼–ç éƒ½éå¸¸ç®€å•æ˜“æ‡‚ã€‚</p>
<p>æ›´è¿›ä¸€æ­¥åœ°ï¼Œå¦‚æœ<strong>å‡½æ•°æ˜¯å¹‚ç­‰ (Idemponent) çš„ï¼ŒSparse Tableå¯ä»¥åœ¨O(1)å†…å¾—åˆ°åŒºé—´æŸ¥è¯¢çš„ç»“æœ</strong>ã€‚</p>
<h4 id="æ ¸å¿ƒåŸç†">æ ¸å¿ƒåŸç†</h4>
<p>å‡è®¾æœ‰ä¸€ä¸ªé•¿åº¦ä¸º <code>$N$ çš„æ•°ç»„ $\{a_0, ..., a_{N - 1}\}$</code>ï¼Œå¹¶æœ‰ä¸€ä¸ªäºŒå…ƒå‡½æ•° <code>$f$</code>ï¼Œæ»¡è¶³ç»“åˆå¾‹ <code>$f(a, f(b, c)) = f(f(a, b), c)$</code>ã€‚</p>
<p>æˆ‘ä»¬ç®€è®°åŒºé—´ <code>$[i, j]$</code> ä¸Šå¯¹å‡½æ•° <code>$f$</code> çš„æŸ¥è¯¢ä¸º <code>$f(a[i..j])$</code>ã€‚</p>
<p>é‚£ä¹ˆ Sparse Table å°†ç”Ÿæˆè¿™æ ·ä¸€ä¸ªäºŒç»´æ•°ç»„ï¼Œè¿™ä¸ªäºŒç»´æ•°ç»„çš„å¤§å°ä¸º <code>$N(\lfloor\log N\rfloor + 1)$</code>ã€‚æ•°ç»„çš„ç¬¬ <code>$(i, j)$</code> é¡¹ä»£è¡¨äº†åŒºé—´ç»“æœ <code>$f(a[i..i + 2^j - 1])$</code>ï¼Œè®°ä¸º <code>$b_{i,j}$</code>ã€‚</p>
<p>ç”Ÿæˆä¸€ä¸ªè¿™æ ·çš„äºŒç»´æ•°ç»„æ˜¯å¾ˆç®€å•çš„ï¼Œå› ä¸º <code>$f(a[i..i + 2^j - 1]) = f(f(a[i..i+2^{j-1} - 1]), f(a[i + 2^{j-1}..i + 2^j - 1]))$</code>ï¼Œè€Œåé¢è¿™ä¸¤ä¸ªåˆ†åˆ«æ˜¯ç¬¬ <code>$(i, j - 1)$</code> é¡¹å’Œç¬¬ <code>$(i + 2^{j - 1}, j - 1)$ </code>é¡¹ï¼Œå¹¶ä¸” <code>$f([i..i]) = a_i$</code>ï¼Œæ‰€ä»¥æˆ‘ä»¬ä¸€å±‚å±‚é€’æ¨å°±è¡Œï¼Œè¿‡ç¨‹å¦‚ä¸‹</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-fallback" data-lang="fallback">// assuming Arr is indexed from 0
for i=0..N-1: 
  Table[i][0] = Arr[i]
  
// assuming N &lt; 2^(k+1)
for j=1..k: 
  for i=0..N-2^j:
    Table[i][j] = F(Table[i][j - 1], Table[i + 2^(j - 1)][j - 1])
</code></pre></div><p>é‚£ä¹ˆæˆ‘ä»¬å¦‚ä½•è¿›è¡ŒæŸ¥è¯¢å‘¢ï¼Ÿå› ä¸ºå¯¹äºä¸€ä¸ªåŒºé—´ <code>$[i, j]$</code> æ¥è¯´ï¼ŒåŒºé—´é•¿åº¦ <code>$L = j - i + 1 \le N$</code> æ’æˆç«‹ï¼Œæ‰€ä»¥å¦‚æœæˆ‘ä»¬å°† <code>$L$</code> è¡¨ç¤ºæˆäºŒè¿›åˆ¶å½¢å¼ï¼Œ<code>$L = 2^{q_k} + 2^{q_{k - 1}} + ... + 2^{q_0}$</code>ï¼Œ
é‚£ä¹ˆæœ‰</p>
<p><code>$j = (\cdots((i + 2^{q_k} - 1) + 2^{q_{k - 1}} - 1) + ... + 2^{q_0}) - 1$</code>ï¼Œè¿™ä¸ªè¡¨ç¤ºå½¢å¼æ˜¯ä¸æ˜¯æé†’ä½ äº†å‘¢ï¼Ÿ</p>
<p>æ‰€ä»¥ç”¨ä»¥ä¸‹è¿‡ç¨‹æˆ‘ä»¬å¯ä»¥åœ¨ O(lgN) æ—¶é—´å†…å¾—åˆ°å‡†ç¡®ç»“æœ:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-fallback" data-lang="fallback">answer = ZERO 
Lâ€™ = L
for i=k..0:
  if Lâ€™ + 2^i - 1 &lt;= R:
    // F is associative, so this operation is meaningful
    answer = F(answer, Table[Lâ€™][i]) 
    Lâ€™ += 2^i
</code></pre></div><p>å‡è®¾æˆ‘ä»¬çš„å‡½æ•° <code>$f$</code> åŒæ—¶æ˜¯å¹‚ç­‰çš„ï¼Œä¹Ÿå°±æ˜¯è¯´ <code>$f(x, x) = x$</code> å¯¹æ‰€æœ‰å®šä¹‰åŸŸå†…çš„æ•°éƒ½æˆç«‹ï¼Œé‚£ä¹ˆæˆ‘ä»¬é©¬ä¸Šå°±èƒ½å¾—åˆ°</p>
<p><code>$f(a[i..j]) = f(f(a[i..s],f(a[t..j])), i \le t, s \le j, t \le s + 1$</code>ã€‚</p>
<p><strong>è¿™æ¡æ€§è´¨å…è®¸æˆ‘ä»¬ä¸ç”¨ç²¾ç¡®åœ°åªè¦†ç›–è¯¥åŒºåŸŸä¸€æ¬¡ï¼Œè¿™æ˜¯åŠ é€Ÿåˆ° O(1) çš„å…³é”®ã€‚</strong></p>
<p>ä»¤ <code>$t$</code> æ˜¯æ»¡è¶³ <code>$2^t \le (j - i + 1)$</code> çš„æœ€å¤§çš„ <code>$t$</code>ï¼Œä¹Ÿå°±æ˜¯ <code>$2^{t + 1} &gt; (j - i + 1)$</code>ã€‚é‚£ä¹ˆæ˜¾ç„¶ <code>$i + 2^t - 1 \le j$ï¼Œ$j - 2^t + 1 \ge i$</code>ï¼Œå¹¶ä¸”æœ‰ <code>$j - 2^t + 1 \le (i + 2^t - 1) + 1$</code> æ’æˆç«‹ã€‚</p>
<p>æ‰€ä»¥ <code>$f(a[i..j]) = f(f(i..i + 2^t - 1), f(j - 2^t + 1..j))$ï¼Œåé¢ä¸¤é¡¹å°±æ˜¯ $b_{i, t}$ å’Œ $b_{j - 2^t, t}$</code>ã€‚</p>
<p>è‡³æ­¤åŸç†ä»‹ç»å®Œæ¯•ï¼Œå®ç°çš„ä»£ç åœ¨æœ€å Appendix ä¸­ã€‚</p>
<h4 id="st--lca">ST &amp; LCA</h4>
<p>Sparse Table ä¸ä»…å¯ä»¥ç”¨äºè®¡ç®—å„ç§åŒºé—´æŸ¥è¯¢ï¼Œè¿˜å¯ä»¥ç”¨äºè®¡ç®—æ ‘ä¸Šä¸¤ä¸ªèŠ‚ç‚¹çš„æœ€è¿‘å…¬å…±ç¥–å…ˆã€‚ä½¿ç”¨STå¯ä»¥åœ¨ O(2lgH) çš„æ—¶é—´å†…è®¡ç®—å‡ºä»»æ„ä¸¤ä¸ªå‡ ç‚¹çš„æœ€è¿‘å…¬å…±ç¥–å…ˆï¼Œç©ºé—´å¤æ‚åº¦è¿˜æ˜¯ O(NlgN)ï¼Œè¿™é‡Œ N æ˜¯æ ‘ä¸ŠèŠ‚ç‚¹æ•°ï¼ŒH æ˜¯æ ‘é«˜åº¦ã€‚</p>
<p>å…¶ä¸»è¦æ€æƒ³æ˜¯ç”¨æ•°ç»„å­˜æ”¾èŠ‚ç‚¹ i çš„ç¬¬ 2^j ä¸ªç¥–å…ˆï¼Œç„¶åæœç´¢ï¼Œå…·ä½“ç»†èŠ‚æœ‰å…´è¶£çš„åŒå­¦å¯ä»¥å‚è€ƒ topcoder ä¸Šå…³äºRMQå’ŒLCAçš„é‚£ç¯‡æ–‡ç« ï¼Œé“¾æ¥åœ¨å¼•ç”¨ä¸­ï¼Œè¿™é‡Œä¸å†èµ˜è¿°ã€‚</p>
<h3 id="parallel-binary-search">Parallel Binary Search</h3>
<p>Parallel Binary Searchï¼Œä¸­æ–‡å«<strong>æ•´ä½“äºŒåˆ†</strong>ï¼Œæˆ‘ä»¬å…ˆç”¨ä¸€ä¸ªspojä¸Šçš„é¢˜ç›®æ¥ä»‹ç»è¿™ä¸ªæ–¹æ³•ï¼Œç„¶åå†æ¥çœ‹ä¸€ä¸‹hourrankä¸Šçš„å¦ä¸€ä¸ªä¸å¤ªä¸€æ ·çš„é¢˜ç›®ã€‚</p>
<p>æ¥ä¸‹æ¥çš„ä¸¤ä¸ªå°èŠ‚å¤§é‡å‚è€ƒäº†codeforcesä¸Šçš„åšå®¢ï¼ŒåŸæ–‡é“¾æ¥åœ¨æ–‡ç« çš„æœ«å°¾ï¼Œæœ‰å…´è¶£çš„åŒå­¦å¯ä»¥å‰å»å­¦ä¹ ã€‚</p>
<h4 id="motivation-problem">Motivation Problem</h4>
<p>SPOJä¸Šæœ‰è¿™æ ·ä¸€ä¸ªé¢˜ç›®ï¼š<a href="http://www.spoj.com/problems/METEORS/">Meteors</a>ï¼Œåœ¨è¿™é‡Œæˆ‘ç®€å•æè¿°ä¸€ä¸‹ï¼š</p>
<blockquote>
<p>æœ‰ N ä¸ªå›½å®¶ï¼Œæœ‰ä¸€å—åœ†å½¢çš„åœ°æ–¹ï¼Œç­‰åˆ†æˆ M ä¸ªæ‰‡å½¢åŒºåŸŸï¼Œæ¯ä¸ªåŒºåŸŸå±äºæŸä¸€ä¸ªå›½å®¶ã€‚ç°åœ¨é¢„æŠ¥æœ‰ Q é˜µæµæ˜Ÿé›¨ï¼Œæ¯ä¸€é’ˆé™è½åœ¨æŸä¸ªæ‰‡å½¢åŒºåŸŸ [L, R]ï¼Œæ¯ä¸ªæ‰‡å½¢éƒ½è·å¾—ç›¸åŒæ•°é‡ K çš„é™¨çŸ³ã€‚å·²çŸ¥æ¯ä¸ªå›½å®¶æœ‰ä¸€ä¸ªé™¨çŸ³æ”¶é›†ç›®æ ‡ reqd[i]ï¼Œè¯·é—®æ¯ä¸ªå›½å®¶åˆ†åˆ«æœ€å°‘åœ¨å¤šå°‘é˜µæµæ˜Ÿé›¨åæ‰èƒ½æ”¶é›†åˆ°ç›®æ ‡æ•°é‡çš„é™¨çŸ³ã€‚</p>
</blockquote>
<blockquote>
<p>1 &lt;= N, M, Q&lt;= 300000
1 &lt;= K &lt;= 1e9</p>
</blockquote>
<h4 id="solution">Solution</h4>
<p>å¦‚æœæˆ‘ä»¬è€ƒè™‘ä¸ä½¿ç”¨ä»»ä½•æ•°æ®ç»“æ„é€æ¬¡æ¨¡æ‹Ÿï¼Œç„¶åæ£€æŸ¥ç›®æ ‡æ˜¯å¦è¾¾åˆ°äº†ï¼Œæ›´æ–°ä»£ä»·æ˜¯O(M)ï¼Œæ£€æŸ¥çš„ä»£ä»·æ˜¯O(N + M)ï¼Œæ€»ä»£ä»· O((2M + N)Q) æ˜¯æ— æ³•æ‰¿å—çš„ã€‚</p>
<p>è€Œçœ‹åˆ°åŒºé—´æ›´æ–°ï¼Œç»“åˆBlogå¼€å¤´æ‰€è®²çš„å‡ ä¸ªæ•°æ®ç»“æ„ï¼Œé€‰æ‹©BITç”¨äºæ¨¡æ‹Ÿæ›´æ–°æ˜¯æœ€åˆé€‚ä¸è¿‡çš„äº†ï¼›è¿™æ ·æˆ‘ä»¬æ›´æ–°ä»£ä»·é™åˆ°äº† O(lgM)ï¼Œä½†æ˜¯æ£€æŸ¥çš„ä»£ä»·å˜ä¸ºäº† O(MlgM)ï¼Œå¦‚æœè¿˜æ˜¯é€æ¬¡æ¨¡æ‹Ÿï¼Œæ˜¾ç„¶ä¼šæ¯”ä¹‹å‰æ›´å·®ã€‚</p>
<p>åˆ°äº†è¿™é‡Œï¼Œèƒ½æƒ³åˆ°äº†ä»€ä¹ˆäº†å˜›ï¼Ÿå¯¹ï¼ŒäºŒåˆ†æŸ¥æ‰¾ï¼äºŒåˆ†æŸ¥æ‰¾ä¸å…³å¿ƒåºåˆ—ä¸­æ¯ä¸ªæ•°é•¿ä»€ä¹ˆæ ·å­ï¼Œåªéœ€è¦çŸ¥é“ï¼š</p>
<ol>
<li>åºåˆ—å•è°ƒ</li>
<li>å¯ä»¥é€šè¿‡æŸç§æ–¹å¼è·å–åˆ°åºåˆ—ä¸­æŒ‡å®šä½ç½®çš„å€¼</li>
</ol>
<p>ç„¶åï¼Œé€šè¿‡äºŒåˆ†æŸ¥æ‰¾ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨ O(lgN) çš„å€¼è·å–/æ£€æŸ¥å†…ï¼Œæ‰¾åˆ°æˆ‘ä»¬æƒ³è¦çš„ä½ç½®ã€‚</p>
<p>è¿™é‡Œçš„åºåˆ—æŒ‡ä¸€ä¸ªå›½å®¶çš„æ”¶é›†æ€»æ•°ï¼Œè€Œè¿™ä¸ªæ”¶é›†æ€»æ•°ç”±æ‰‡å½¢åŒºé—´æ‰€æ„æˆçš„åºåˆ—éšå¼åœ°ååº”ï¼Œé‚£ä¹ˆé€šè¿‡äºŒåˆ†æŸ¥æ‰¾ï¼Œå¯¹æ¯ä¸ªå›½å®¶æˆ‘ä»¬åªéœ€è¦è¿›è¡Œ O(lgQ) æ¬¡æ£€æŸ¥ï¼Œå°±èƒ½çŸ¥é“æ˜¯åœ¨é‚£ä¸ªæ—¶é—´ç‚¹æ»¡è¶³æ¡ä»¶ã€‚æ‰€ä»¥æ¯ä¸ªå›½å®¶çš„æ€»è®¡æ—¶é—´å¤æ‚åº¦ä¸ºå¤§çº¦ä¸º O(logQ * Q * logM)ï¼Œè¿™é‡Œæ¯æ¬¡æ£€æŸ¥çš„æ—¶é—´ç›¸æ¯”æ›´æ–°çš„æ—¶é—´å¾®ä¸è¶³é“æ‰€ä»¥ç•¥å»äº†ã€‚æœ€ç»ˆå¤æ‚åº¦ä¸º O(N * log Q * Q * logM)ã€‚</p>
<p>å¯ä»¥çœ‹åˆ°ï¼Œä¸Šé¢çš„å¤æ‚åº¦è¿˜æ˜¯å¤ªé«˜ï¼Œæ¯”ç›´æ¥æ¨¡æ‹Ÿè¿˜æ˜¯é«˜äº†å¾ˆå¤šï¼Œé‚£æ€ä¹ˆåŠå‘¢ï¼Ÿ</p>
<p>ç¨å¾®æƒ³ä¸€æƒ³ï¼Œæ¯æ¬¡æ¨¡æ‹Ÿçš„ä»£ä»·è™½ç„¶é™ä½äº†ï¼Œä½†æ˜¯æ¨¡æ‹Ÿçš„æ•°é‡ä¸Šå‡åˆ°äº† O(NlgQ) æ¬¡ï¼Œè™½ç„¶æ£€æŸ¥çš„æ¬¡æ•°ä¹Ÿé™ä½äº†ï¼Œä½†æ˜¯è·Ÿæ¨¡æ‹Ÿçš„è€—æ—¶ç›¸æ¯”ï¼Œä½çš„éƒ½è¢«ç•¥æ‰äº† &hellip; æ‰€ä»¥å½“åŠ¡ä¹‹æ€¥æ˜¯åŒæ—¶èƒ½é™ä½æ¨¡æ‹Ÿçš„å¼€é”€ã€‚</p>
<p>æ˜¯ä¸æ˜¯æ„Ÿè§‰æœ‰ç‚¹å¥¢ä¾ˆï¼Ÿæ¯æ¬¡æˆ‘å°±æ£€æŸ¥é‚£ä¹ˆä¸€ä¸‹ï¼Œå°±è¦æ¨¡æ‹Ÿä¸€æ•´è½®ï¼Œè™½ç„¶æˆ‘å¼€é”€å°ï¼Œä¹Ÿæ¶ä¸ä½ä½ çƒ§CPUç©å•Šã€‚</p>
<p>å…¶å®æ¯ä¸ªå›½å®¶çš„äºŒåˆ†æŸ¥æ‰¾ç»å†æ˜¯å¾ˆç±»ä¼¼çš„ï¼Œåœ¨æ•´ä¸ªæ¨¡æ‹Ÿå‡ºæ¥çš„åºåˆ—é‡Œé¢æ‰¾åˆ°é‚£ä¸€ç‰‡è¦çš„ï¼Œç„¶åæ£€æŸ¥ä¸€ä¸‹æˆ‘ä»¬å°±ä¸‹ä¸€è½®äº†ã€‚é‚£ä¹ˆï¼Œæ—¢ç„¶ä¸€æ•´è½®æ¨¡æ‹Ÿéƒ½åšå®Œäº†ï¼Œèƒ½ä¸èƒ½è®©æ¯ä¸ªå›½å®¶éƒ½æ£€æŸ¥å®Œï¼Œç„¶åæˆ‘ä»¬å†å¼€ä¸‹ä¸€è½®å¥½ä¸å¥½ï¼Ÿ</p>
<p>è¿™å°±æ˜¯ Parallel Binary Search çš„æ ¸å¿ƒæ€æƒ³ï¼š<strong>é€šè¿‡ä¸€è½®æ¨¡æ‹Ÿå®Œæˆæ‰€æœ‰å›½å®¶çš„è¿™ä¸€æ­¥æŸ¥æ‰¾</strong>ï¼Œä»è€Œå°†æ¨¡æ‹Ÿæ€»æ•°å‡å°‘åˆ°äº† O(lgQ) æ¬¡ï¼Œå·¨å¤§çš„è¿›æ­¥ï¼</p>
<p>å…·ä½“æ–¹æ³•æ˜¯ï¼Œå¼€ä¸¤ä¸ªé•¿åº¦ä¸ºNçš„æ•°ç»„ï¼Œå¯¹æ¯ä¸€ä¸ªå›½å®¶ï¼Œè®°å½•å®ƒå½“å‰çš„ L å’Œ Rï¼›å¯¹äºæ¯ä¸€ä¸ªè¦æ£€æŸ¥çš„ midï¼Œå¼€ä¸€ä¸ªé“¾è¡¨è®°å½•å½“å‰éœ€è¦æ£€æŸ¥ mid å€¼çš„å›½å®¶ï¼›å…¶ä½™è¿‡ç¨‹ç”¨ä¸‹åˆ—ä¼ªä»£ç æè¿°ï¼š</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-fallback" data-lang="fallback">for all logQ steps:
    clear range tree and linked list check
    for all member states i:
        if L[i] != R[i]:
            mid = (L[i] + R[i]) / 2
            insert i in check[mid]
    for all queries q:
        apply(q)
        for all member states m in check[q]:
            if m has requirements fulfilled:
                R[m] = q
            else:
                L[m] = q + 1
</code></pre></div><p>ä¸Šè¿°è¿‡ç¨‹ä¸­ï¼Œ<code>apply()</code> å‡½æ•°çš„ä½œç”¨æ˜¯ï¼Œè¿›è¡Œæ¨¡æ‹Ÿï¼Œç„¶åæ£€æŸ¥éœ€è¦æ£€æŸ¥çš„å›½å®¶æ˜¯å¦æ»¡è¶³æ¡ä»¶äº†ã€‚</p>
<p>è¿™æ ·å­ï¼Œæ¨¡æ‹Ÿçš„ä»£ä»·æ€»è®¡ä¸º O(lgQ * Q * lgM)ï¼Œæ£€æŸ¥çš„ä»£ä»·æ€»è®¡ä¸º O(lgQ * (MlgM + N))ï¼Œæˆ‘ä»¬æˆåŠŸåœ°åŒæ—¶å°†æ¨¡æ‹Ÿå’Œæ£€æŸ¥çš„ä»£ä»·éƒ½å‡å°äº†ï¼è¿™æ ·çš„æ—¶é—´å¤æ‚åº¦æ€»å…±ä¸º O(lgQ * (Q + M) * lgM)ï¼Œè‡³äºå°‘çš„é‚£ä¸ªNï¼Œå¿½ç•¥ä¸è®¡~</p>
<p>åŒåŸæ–‡ä¸€æ ·ï¼Œè¿™é‡Œå¼•ä¸€å¥å¤§ä½¬çš„è¯è§£é‡Šè¿™ä¸ª Parallel Binary Searchï¼Œ</p>
<blockquote>
<p>&ldquo;A cool way to visualize this is to think of a binary search tree. Suppose we are doing standard binary search, and we reject the right interval â€” this can be thought of as moving left in the tree. Similarly, if we reject the left interval, we are moving right in the tree.
So what Parallel Binary Search does is move one step down in N binary search trees simultaneously in one &ldquo;sweep&rdquo;, taking O(Nâ€‰â€‰*â€‰â€‰X) time, where X is dependent on the problem and the data structures used in it. Since the height of each tree is LogN, the complexity is O(Nâ€‰â€‰*â€‰â€‰Xâ€‰â€‰*â€‰â€‰logN).&rdquo; â€” rekt_n00b</p>
</blockquote>
<h4 id="hourrank23----selective-additions">Hourrank23 &ndash; Selective Additions</h4>
<p>è¿™æ˜¯ä¸€é“è¢«è¯…å’’çš„é¢˜ç›®&hellip;æŠ±æ­‰å®åœ¨æ²¡å¿ä½ğŸ¤£</p>
<p>è¿™é“é¢˜ç›®æ˜¯è¿™æ ·çš„ï¼š</p>
<blockquote>
<p>æœ‰ä¸€ä¸ªæ•°ç»„ï¼Œé•¿åº¦ä¸ºNï¼Œç°åœ¨è¦è¿›è¡Œ M æ¬¡åŒºé—´æ›´æ–°ï¼Œéƒ½æ˜¯åŠ ä¸€ä¸ªæ­£æ•°ã€‚ä½†æ˜¯æˆ‘æœ‰ K ä¸ªå¾ˆå–œæ¬¢çš„æ•°å­—ï¼Œä¸€æ—¦æ•°ç»„ä¸­æŸä¸ªå…ƒç´ æˆä¸ºæˆ‘å–œæ¬¢çš„æ•°å­—ï¼Œå¯¹å®ƒçš„æ›´æ–°å°±æ— æ•ˆï¼Œå®ƒå°†ä¸€ç›´ä¿æŒé‚£ä¸ªæ•°å­—ã€‚
é—®æ¯è½®æ›´æ–°åçš„æ•°ç»„å’Œã€‚</p>
<p>1 &lt;= N, M &lt;= 1e5
1 &lt;= k &lt;= 5</p>
</blockquote>
<p>è¿™é“é¢˜å’Œä¸Šé“é¢˜ä¸å¤ªä¸€æ ·ï¼Œ<strong>æ£€æŸ¥çš„ä»£ä»·ä½ã€æ£€æŸ¥ç›®æ ‡å’ŒåŸåŒºé—´ç›¸åŒ</strong>ï¼Œè€Œä¸”ç›®æ ‡å˜æˆäº†å¤šä¸ªã€‚</p>
<p>ç›®æ ‡æ˜¯å¤šä¸ªå¯ä»¥è¿™æ ·è§£å†³ï¼šå¯¹å–œæ¬¢çš„æ•°æ’åºï¼Œå› ä¸ºæ°¸è¿œæ˜¯æ­£çš„æ›´æ–°ï¼Œæ‰€ä»¥å…ˆåˆ°è¾¾å‰ä¸€ä¸ªåä¸€ä¸ªå°±ä¸ç”¨æ£€æŸ¥äº†ã€‚</p>
<p>é‡‡ç”¨ä¸Šè¿°çš„ PBS çš„æ–¹æ³•ï¼Œè¿™é¢˜çš„å¤æ‚åº¦åœ¨ O(k(n + m)lognlogm)ï¼Œæ˜¯ä¸€ä¸ªå¾ˆå¥½çš„å¤æ‚åº¦äº†ã€‚</p>
<p>ä½†æ˜¯ï¼Œè¿™é‡Œä¸€å®šè¦æœ‰ä¸ªä½†æ˜¯ï¼Œå› ä¸ºæ£€æŸ¥çš„ä»£ä»·å¾ˆä½ï¼Œæ‰€ä»¥è¿™é¢˜çš„äºŒåˆ†æŸ¥æ‰¾ä¸æ˜¯å¿…é¡»çš„ï¼Œæˆ‘ç¿»é˜…äº†å¤§é‡å¤§ä½¬çš„ä»£ç å’Œeditorialï¼Œæœ‰ç”¨PBSçš„ï¼Œæœ‰æ¨¡æ‹Ÿæ—¶é—´åºåˆ—çš„ï¼Œæœ‰ç”¨Segment treeåŠ trickçš„ï¼Œå„ç§å„æ ·ï¼Œæˆ‘æ¥ä¸€ä¸ªä¸ªä»‹ç»ä¸€ä¸‹ï¼š</p>
<h4 id="pbs">PBS</h4>
<p>è¿™ä¸ªä¸å¤šè¯´äº†ï¼Œç¦»çº¿æ¨¡æ‹Ÿ logm éã€‚</p>
<h4 id="time-series-simulation">Time Series Simulation</h4>
<p>ä»£ç : <a href="https://www.hackerrank.com/rest/contests/hourrank-23/challenges/selective-additions/hackers/nuipqiun/download_solution">https://www.hackerrank.com/rest/contests/hourrank-23/challenges/selective-additions/hackers/nuipqiun/download_solution</a></p>
<p>åŒæ ·æ˜¯ç¦»çº¿å¤„ç†ï¼Œä½†æ˜¯è¿™ä¸ªå¤§ä½¬çš„æ¨¡æ‹Ÿæ–¹å¼å¾ˆç‰¹åˆ«ï¼Œä»–æ˜¯åœ¨æ—¶é—´åºåˆ—ä¸Šæ¨¡æ‹Ÿæ•°ç»„å½“å‰é¡¹çš„å€¼ï¼Œæˆ‘è¿˜æ˜¯ç¬¬ä¸€æ¬¡è§ã€‚</p>
<p>é¦–å…ˆè¿˜è®°å¾— BIT çš„åŒºé—´æ›´æ–°æ–¹å¼ä¹ˆï¼Œåœ¨lå¤„åŠ deltaï¼Œr + 1å¤„å‡å»deltaã€‚å‡è®¾è€ƒè™‘åŒºé—´æ›´æ–°éƒ½æ˜¯ [l, n] çš„ï¼Œé‚£ä¹ˆåœ¨æ—¶é—´åºåˆ—ä¸Šæ¨¡æ‹Ÿ i-th æ•°ç»„é¡¹ çš„å€¼å°±å¾ˆå®¹æ˜“æƒ³åˆ°äº†ï¼šå¯¹äºåœ¨ i ä»¥åŠä¹‹å‰çš„æ›´æ–°(j, a, b, delta) (a &lt;= i), åœ¨æ—¶é—´åºåˆ—å¯¹åº”æ•°ç»„çš„ jå¤„åŠ deltaã€‚è¿™æ ·jæ—¶é—´ä¹‹åçš„æ•°éƒ½è¢«åŠ äº†deltaã€‚</p>
<p>æƒ³åˆ°è¿™é‡Œï¼Œæ—¶é—´åºåˆ—ä¸Šçš„æ¨¡æ‹Ÿå°±å‘¼ä¹‹æ¬²å‡ºäº†ï¼Œæ—¢ç„¶å¯¹åº”æœ‰åŠ ï¼Œè‚¯å®šå¯¹åº”æœ‰å‡ï¼šå¯¹äº i  ä»¥åŠ i ä¹‹å‰çš„æ‰€æœ‰æ›´æ–° (j, a, b, delta) (b &lt; i)ï¼Œåœ¨åºåˆ—ä¸ŠæŠµæ¶ˆæ‰ï¼Œä¹Ÿå³åœ¨æ—¶é—´åºåˆ—jå¤„å‡deltaï¼Œå› ä¸ºè¿™æ ·çš„æ›´æ–°ä¸åº”è¯¥å½±å“åˆ°æ•°ç»„é¡¹ i çš„æ—¶é—´åºåˆ—ï¼Œè€Œä¸”ä¸€å®šåœ¨ä¹‹å‰è¢«æ›´æ–°ä¸Šå»äº†ã€‚</p>
<p>æ‰€ä»¥å°±å˜æˆäº†è¿™æ ·ä¸€ç§æ–¹å¼ï¼š</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp">rep(i,n){
	<span style="color:#080;font-weight:bold">for</span>(<span style="color:#339;font-weight:bold">int</span> <span style="color:#970;font-weight:bold">j</span>:ad[i]) add(j,ads[j]);
	<span style="color:#080;font-weight:bold">for</span>(<span style="color:#339;font-weight:bold">int</span> <span style="color:#970;font-weight:bold">j</span>:rm[i]) add(j,<span style="color:#333">-</span>ads[j]);
	<span style="color:#888">// do you work
</span><span style="color:#888"></span>}
</code></pre></div><p>è¿™é‡Œï¼Œad[i] æ˜¯ [i, r] æ›´æ–°çš„ç´¢å¼•å·ï¼Œrm[i] æ˜¯ [l, i - 1] æ›´æ–°çš„ç´¢å¼•å·ï¼Œadd æ“ä½œæ˜¯fenwick treeçš„åŠ æ“ä½œï¼Œäºæ˜¯æˆ‘ä»¬å¯ä»¥ç”¨sum(j)è®¡ç®—å‡ºä»»ä¸€ä¸ªæ—¶é—´èŠ‚ç‚¹ä¸Ša[i]çš„å€¼ã€‚</p>
<p>åé¢å°±å¾ˆç®€å•äº†ï¼Œå¯¹æ¯ä¸ªiäºŒåˆ†æŸ¥æ‰¾ï¼Œæ‰¾åˆ°å°±è®°ä¸‹æ¥ã€‚æ€»è®¡æ—¶é—´å¤æ‚åº¦åº”è¯¥ä¸º O((kn + m)logm)ã€‚</p>
<p>è¿™é‡Œæ˜æ˜¾æ¯” PBS å¿«äº†ä¸€ç‚¹ï¼Œè¿™æ˜¯å› ä¸º<strong>æ£€æŸ¥åŒºé—´å’ŒåŸåŒºé—´ä¸€è‡´</strong>ã€‚è¿™ä»¶äº‹æƒ…å¾ˆé‡è¦ï¼Œç±»æ¯”åˆ° Meteorsï¼Œè™½ç„¶æˆ‘ä»¬ä¹Ÿèƒ½æ¨¡æ‹Ÿå‡ºä¸€ä¸ªåŒºé—´çš„æ—¶é—´åºåˆ—ï¼Œä½†æ˜¯ä¸€ä¸ªåŒºé—´å¯¹äºç›®æ ‡æ²¡æœ‰æ„ä¹‰ã€‚</p>
<h4 id="segment-tree">Segment Tree</h4>
<p>ä¸ä¸Šé¢ä¸¤ä¸ªä¸åŒçš„æ˜¯ï¼Œè¿™æ˜¯ä¸ªåœ¨çº¿ç®—æ³•ã€‚</p>
<p>æ—¶é—´å¤æ‚åº¦æ˜¯ O(klgm(n + m))ï¼Œä¸è¿‡ç”¨äº†çº¿æ®µæ ‘ï¼Œç©ºé—´å¤æ‚åº¦ä¸º O(kmlgm)ã€‚</p>
<p>è¿™é‡Œçº¿æ®µæ ‘ä¸­è®°å½•äº†ä¸‰ä¸ªå€¼ï¼šlazyåŸŸaddï¼ŒåŒºé—´æœ€å¤§å€¼maxiï¼Œå¯¹åº”çš„æ•°ç»„ç´¢å¼•idã€‚</p>
<p>ä¸€å…±kæ£µçº¿æ®µæ ‘ï¼Œæ¯é¢—çº¿æ®µæ ‘åˆå§‹åŒ–ä¸ºæ•°ç»„ {a_i - fav_j}ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œå¯¹åº”çš„å€¼å¦‚æœä¸ºæ­£æ•°ï¼Œæ‰æœ‰æ£€æŸ¥çš„å¿…è¦ï¼Œå¦‚æœä¸ºè´Ÿæ•°ï¼Œé‚£å‹æ ¹è¿˜æ²¡åˆ°æ£€æŸ¥çš„æ—¶å€™ã€‚</p>
<p>æ­£å·§ï¼Œåˆ©ç”¨çº¿æ®µæ ‘çš„ç»“æ„ï¼Œæˆ‘ä»¬æ£€æŸ¥çº¿æ®µæ ‘çš„rootèŠ‚ç‚¹å°±èƒ½çŸ¥é“è¿™æ£µæ ‘ä¸­å­˜ä¸å­˜åœ¨éœ€è¦æ£€æŸ¥çš„é¡¹ï¼Œè¿™ä¸ªæ“ä½œæ˜¯ O(1) çš„ã€‚è€Œå½“ä¸€ä¸ªæ•°ç»„é¡¹è¢«æ£€æŸ¥è¿‡åï¼Œå®ƒå°†è¢«èµ‹å€¼ä¸º -infï¼Œè¿™æ ·å®ƒæ°¸è¿œä¹Ÿä¸ä¼šè¢«å†æ¬¡æ£€æŸ¥ï¼Œçº¿æ®µæ ‘ä¹Ÿé¡ºåˆ©æ›´æ–°åˆ°ä¸‹ä¸€ä¸ªå¾…æ£€æŸ¥çŠ¶æ€ã€‚</p>
<p>ç”±äºæ¯ä¸ªæ•°ç»„é¡¹å¯¹äºæ¯ä¸ªfavoriteæœ€å¤šè¢«æ£€æŸ¥ä¸€æ¬¡ï¼Œæ‰€ä»¥æ€»è®¡æ£€æŸ¥å¤æ‚åº¦ä¸º O(knlgm)ã€‚</p>
<p>æ›´æ–°å¤æ‚åº¦æ˜¯ O(kmlgm)ï¼Œæ‰€ä»¥æ€»è®¡å¤æ‚åº¦ä¸º O(k(m + n)lgm)ã€‚</p>
<p>è¿™é‡Œåˆ©ç”¨Segment Treeçš„trickä¸€å¼€å§‹è®©æˆ‘ç™¾æ€ä¸å¾—å…¶è§£ï¼Œä¸ºä»€ä¹ˆmeteorsä¸è¡Œè€Œè¿™é‡Œå¯ä»¥ï¼Œæƒ³æ¥æƒ³å»ä¹Ÿæƒ³ä¸å‡ºç¬¬ä¸‰ç§æ–¹å¼ï¼ŒæŠŠmeteorsçš„æŸ¥è¯¢åŒºé—´æ˜ å°„åˆ°æ–¹ä¾¿ä¿®æ”¹çš„ç»“æ„ä¸Šï¼Œæ‰€ä»¥è¿˜æ˜¯å½’ç»“ä¸ºä¹‹å‰æ‰€è¿°çš„ä¸¤ä¸ªåŸå› ã€‚</p>
<h3 id="conclusion">Conclusion</h3>
<p>å¯¹äºæ›´æ–°/æŸ¥è¯¢çš„ä¸€ç³»åˆ—é—®é¢˜ï¼Œä¸šç•Œå¤§ä½¬ä»¬å·²ç»æä¾›äº†å„ç§å„æ ·æœ‰åŠ›çš„æ­¦å™¨ï¼š</p>
<ol>
<li>æ•°æ®ç»“æ„ Segment treeã€Fenwick treeã€Sparse tableï¼Œè¿˜æœ‰æœ€è¿‘æ‰ç ”ç©¶åˆ°çš„ Cartesian tree ç­‰ç­‰</li>
<li>äºŒåˆ†ã€æ•´ä½“äºŒåˆ†ã€è¿˜æ²¡çœ‹è¿‡çš„ CDQ åˆ†æ²»ç­‰ç­‰</li>
</ol>
<p>æŠŠè¿™é‡Œæ•´ç†è¿›è„‘å­é‡Œï¼Œå¤§æ¦‚ä¸‹æ¬¡åˆ·é¢˜çš„æ—¶å€™åº•æ°”ä¹Ÿä¼šè¶³ä¸€äº›ğŸº</p>
<h3 id="reference">Reference</h3>
<p>[1] <a href="https://www.hackerearth.com/practice/notes/sparse-table/">https://www.hackerearth.com/practice/notes/sparse-table/</a></p>
<p>[2] <a href="https://www.topcoder.com/community/data-science/data-science-tutorials/range-minimum-query-and-lowest-common-ancestor/#Sparse_Table_(ST)_algorithm">https://www.topcoder.com/community/data-science/data-science-tutorials/range-minimum-query-and-lowest-common-ancestor/#Sparse_Table_(ST)_algorithm</a></p>
<p>[3] <a href="http://codeforces.com/blog/entry/45578">http://codeforces.com/blog/entry/45578</a></p>
<p>[4] <a href="https://ideone.com/tTO9bD">https://ideone.com/tTO9bD</a></p>
<h3 id="appendix">Appendix</h3>
<h4 id="impl-stc">Impl ST/C++</h4>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp"><span style="color:#579">#include</span> <span style="color:#579">&lt;vector&gt;</span><span style="color:#579">
</span><span style="color:#579">#include</span> <span style="color:#579">&lt;cassert&gt;</span><span style="color:#579">
</span><span style="color:#579">#include</span> <span style="color:#579">&lt;cstring&gt;</span><span style="color:#579">
</span><span style="color:#579">#include</span> <span style="color:#579">&lt;iostream&gt;</span><span style="color:#579">
</span><span style="color:#579">#include</span> <span style="color:#579">&lt;limits&gt;</span><span style="color:#579">
</span><span style="color:#579">#include</span> <span style="color:#579">&lt;type_traits&gt;</span><span style="color:#579">
</span><span style="color:#579">#include</span> <span style="color:#579">&lt;random&gt;</span><span style="color:#579">
</span><span style="color:#579"></span><span style="color:#080;font-weight:bold">using</span> <span style="color:#080;font-weight:bold">namespace</span> std;

<span style="color:#080;font-weight:bold">namespace</span> st_impl {

<span style="color:#080;font-weight:bold">template</span> <span style="color:#333">&lt;</span><span style="color:#080;font-weight:bold">class</span> <span style="color:#b06;font-weight:bold">T</span>, <span style="color:#080;font-weight:bold">class</span> <span style="color:#b06;font-weight:bold">F</span><span style="color:#333">&gt;</span>
<span style="color:#080;font-weight:bold">class</span> <span style="color:#b06;font-weight:bold">SparseTable</span> {
<span style="color:#080;font-weight:bold">public</span><span style="color:#333">:</span>
    <span style="color:#080;font-weight:bold">typedef</span> F func_type;
    <span style="color:#080;font-weight:bold">typedef</span> <span style="color:#339;font-weight:bold">unsigned</span> size_type;
    <span style="color:#080;font-weight:bold">typedef</span> T value_type;

    SparseTable(<span style="color:#080;font-weight:bold">const</span> vector<span style="color:#333">&lt;</span>T<span style="color:#333">&gt;&amp;</span> init) <span style="color:#333">:</span> _size(init.size()), _idx_size(flsl(_size)) {
        table.resize(_size);
        <span style="color:#080;font-weight:bold">for</span> (<span style="color:#080;font-weight:bold">auto</span><span style="color:#333">&amp;</span> <span style="color:#970;font-weight:bold">row</span> : table) {
            row.resize(_idx_size, func_type<span style="color:#333">::</span>default_value);
        }

        <span style="color:#888">// initialize sparse table
</span><span style="color:#888"></span>        <span style="color:#080;font-weight:bold">for</span> (size_type i <span style="color:#333">=</span> <span style="color:#00d;font-weight:bold">0</span>; i <span style="color:#333">&lt;</span> _size; <span style="color:#333">++</span>i) {
            table[i][<span style="color:#00d;font-weight:bold">0</span>] <span style="color:#333">=</span> init[i];
        }
        <span style="color:#080;font-weight:bold">for</span> (size_type j <span style="color:#333">=</span> <span style="color:#00d;font-weight:bold">1</span>; j <span style="color:#333">&lt;</span> _idx_size; <span style="color:#333">++</span>j) {
            <span style="color:#080;font-weight:bold">for</span> (size_type i <span style="color:#333">=</span> <span style="color:#00d;font-weight:bold">0</span>; i <span style="color:#333">&lt;=</span> _size <span style="color:#333">-</span> (<span style="color:#00d;font-weight:bold">1</span> <span style="color:#333">&lt;&lt;</span> j); <span style="color:#333">++</span>i) {
                table[i][j] <span style="color:#333">=</span> f(table[i][j <span style="color:#333">-</span> <span style="color:#00d;font-weight:bold">1</span>], table[i <span style="color:#333">+</span> (<span style="color:#00d;font-weight:bold">1</span> <span style="color:#333">&lt;&lt;</span> (j <span style="color:#333">-</span> <span style="color:#00d;font-weight:bold">1</span>))][j <span style="color:#333">-</span> <span style="color:#00d;font-weight:bold">1</span>]);
            }
        }
    }

    SparseTable(<span style="color:#080;font-weight:bold">const</span> initializer_list<span style="color:#333">&lt;</span>T<span style="color:#333">&gt;&amp;</span> init) <span style="color:#333">:</span> SparseTable(vector<span style="color:#333">&lt;</span>T<span style="color:#333">&gt;</span>(init)) {}

    SparseTable(<span style="color:#080;font-weight:bold">const</span> vector<span style="color:#333">&lt;</span>T<span style="color:#333">&gt;&amp;</span> init, F f) <span style="color:#333">:</span> SparseTable(init) { <span style="color:#080;font-weight:bold">this</span><span style="color:#333">-&gt;</span>f <span style="color:#333">=</span> f; }
    SparseTable(<span style="color:#080;font-weight:bold">const</span> initializer_list<span style="color:#333">&lt;</span>T<span style="color:#333">&gt;&amp;</span> init, F f) <span style="color:#333">:</span> SparseTable(vector<span style="color:#333">&lt;</span>T<span style="color:#333">&gt;</span>(init), f) {}

    T <span style="color:#06b;font-weight:bold">rangeQuery</span>(size_type l, size_type r) <span style="color:#080;font-weight:bold">const</span> {
        <span style="color:#080;font-weight:bold">if</span> (<span style="color:#333">!</span>(l <span style="color:#333">&lt;=</span> r <span style="color:#333">&amp;&amp;</span> r <span style="color:#333">&lt;</span> _size)) {
            <span style="color:#080;font-weight:bold">throw</span> std<span style="color:#333">::</span>out_of_range(<span style="background-color:#fff0f0">&#34;Bad query!&#34;</span>);
        }

        <span style="color:#888">// if the function is idempotent, which means f(x, x) = x holds for
</span><span style="color:#888"></span>        <span style="color:#888">// all x with definition, then we can deduce that
</span><span style="color:#888"></span>        <span style="color:#888">// f(range(l, s), range(t, r)) == f(range(l, r)) always
</span><span style="color:#888"></span>        <span style="color:#888">// holds for all l, s, t, r which satisfies l &lt;= t &amp;&amp; s &lt;= r &amp;&amp; t &lt;= s + 1
</span><span style="color:#888"></span>        <span style="color:#888">// then rangeQuery will be executed in O(1).
</span><span style="color:#888"></span>        <span style="color:#888">// otherwise it should be finished in O(lgN).
</span><span style="color:#888"></span>        <span style="color:#080;font-weight:bold">if</span> (func_type<span style="color:#333">::</span>idempotent) {
            size_type idx <span style="color:#333">=</span> flsl(r <span style="color:#333">-</span> l <span style="color:#333">+</span> <span style="color:#00d;font-weight:bold">1</span>) <span style="color:#333">-</span> <span style="color:#00d;font-weight:bold">1</span>;
            <span style="color:#080;font-weight:bold">return</span> f(table[l][idx], table[r <span style="color:#333">-</span> (<span style="color:#00d;font-weight:bold">1</span> <span style="color:#333">&lt;&lt;</span> idx) <span style="color:#333">+</span> <span style="color:#00d;font-weight:bold">1</span>][idx]);
        } <span style="color:#080;font-weight:bold">else</span> {
            T res <span style="color:#333">=</span> func_type<span style="color:#333">::</span>default_value;
            <span style="color:#080;font-weight:bold">for</span> (size_type i <span style="color:#333">=</span> <span style="color:#00d;font-weight:bold">0</span>; i <span style="color:#333">&lt;</span> _idx_size; <span style="color:#333">++</span>i) {
                size_type idx <span style="color:#333">=</span> _idx_size <span style="color:#333">-</span> <span style="color:#00d;font-weight:bold">1</span> <span style="color:#333">-</span> i;
                <span style="color:#080;font-weight:bold">if</span> (l <span style="color:#333">+</span> (<span style="color:#00d;font-weight:bold">1</span> <span style="color:#333">&lt;&lt;</span> idx) <span style="color:#333">-</span> <span style="color:#00d;font-weight:bold">1</span> <span style="color:#333">&lt;=</span> r) {
                    res <span style="color:#333">=</span> f(res, table[l][idx]);
                    l <span style="color:#333">+=</span> <span style="color:#00d;font-weight:bold">1</span> <span style="color:#333">&lt;&lt;</span> idx;
                }
            }
            <span style="color:#080;font-weight:bold">return</span> res;
        }
    }

<span style="color:#080;font-weight:bold">private</span><span style="color:#333">:</span>
    func_type f;

    size_type _size;
    size_type _idx_size;
    vector<span style="color:#333">&lt;</span>vector<span style="color:#333">&lt;</span>T<span style="color:#333">&gt;&gt;</span> table;
};

}  <span style="color:#888">// namespace st_impl
</span><span style="color:#888"></span>
<span style="color:#080;font-weight:bold">template</span> <span style="color:#333">&lt;</span><span style="color:#080;font-weight:bold">class</span> <span style="color:#b06;font-weight:bold">T</span>, T v <span style="color:#333">=</span> T{}<span style="color:#333">&gt;</span>
<span style="color:#080;font-weight:bold">struct</span> <span style="color:#b06;font-weight:bold">sum_f</span> {
    <span style="color:#080;font-weight:bold">static</span> <span style="color:#080;font-weight:bold">constexpr</span> T default_value <span style="color:#333">=</span> v;
    <span style="color:#080;font-weight:bold">static</span> <span style="color:#080;font-weight:bold">constexpr</span> <span style="color:#339;font-weight:bold">bool</span> idempotent <span style="color:#333">=</span> <span style="color:#007020">false</span>;
    T <span style="color:#06b;font-weight:bold">operator</span>()(<span style="color:#080;font-weight:bold">const</span> T<span style="color:#333">&amp;</span> a, <span style="color:#080;font-weight:bold">const</span> T<span style="color:#333">&amp;</span> b) <span style="color:#080;font-weight:bold">const</span> { <span style="color:#080;font-weight:bold">return</span> a <span style="color:#333">+</span> b; }
};
<span style="color:#080;font-weight:bold">template</span> <span style="color:#333">&lt;</span><span style="color:#080;font-weight:bold">class</span> <span style="color:#b06;font-weight:bold">T</span>, T v<span style="color:#333">&gt;</span>
<span style="color:#080;font-weight:bold">constexpr</span> <span style="color:#080;font-weight:bold">const</span> T sum_f<span style="color:#333">&lt;</span>T, v<span style="color:#333">&gt;::</span>default_value;

<span style="color:#080;font-weight:bold">template</span> <span style="color:#333">&lt;</span><span style="color:#080;font-weight:bold">class</span> <span style="color:#b06;font-weight:bold">T</span>, T v <span style="color:#333">=</span> numeric_limits<span style="color:#333">&lt;</span>T<span style="color:#333">&gt;::</span>min(),
          <span style="color:#080;font-weight:bold">typename</span> <span style="color:#333">=</span> <span style="color:#080;font-weight:bold">typename</span> enable_if<span style="color:#333">&lt;</span>numeric_limits<span style="color:#333">&lt;</span>T<span style="color:#333">&gt;::</span>is_specialized<span style="color:#333">&gt;::</span>type<span style="color:#333">&gt;</span>
<span style="color:#080;font-weight:bold">struct</span> <span style="color:#b06;font-weight:bold">max_f</span> {
    <span style="color:#080;font-weight:bold">static</span> <span style="color:#080;font-weight:bold">constexpr</span> T default_value <span style="color:#333">=</span> v;
    <span style="color:#080;font-weight:bold">static</span> <span style="color:#080;font-weight:bold">constexpr</span> <span style="color:#339;font-weight:bold">bool</span> idempotent <span style="color:#333">=</span> <span style="color:#007020">true</span>;
    T <span style="color:#06b;font-weight:bold">operator</span>()(<span style="color:#080;font-weight:bold">const</span> T<span style="color:#333">&amp;</span> a, <span style="color:#080;font-weight:bold">const</span> T<span style="color:#333">&amp;</span> b) <span style="color:#080;font-weight:bold">const</span> { <span style="color:#080;font-weight:bold">return</span> max(a, b); }
};
<span style="color:#080;font-weight:bold">template</span> <span style="color:#333">&lt;</span><span style="color:#080;font-weight:bold">class</span> <span style="color:#b06;font-weight:bold">T</span>, T v, <span style="color:#080;font-weight:bold">typename</span> R<span style="color:#333">&gt;</span>
<span style="color:#080;font-weight:bold">constexpr</span> <span style="color:#080;font-weight:bold">const</span> T max_f<span style="color:#333">&lt;</span>T, v, R<span style="color:#333">&gt;::</span>default_value;

<span style="color:#080;font-weight:bold">template</span> <span style="color:#333">&lt;</span><span style="color:#080;font-weight:bold">class</span> <span style="color:#b06;font-weight:bold">T</span>, T v <span style="color:#333">=</span> numeric_limits<span style="color:#333">&lt;</span>T<span style="color:#333">&gt;::</span>max(),
          <span style="color:#080;font-weight:bold">typename</span> <span style="color:#333">=</span> <span style="color:#080;font-weight:bold">typename</span> enable_if<span style="color:#333">&lt;</span>numeric_limits<span style="color:#333">&lt;</span>T<span style="color:#333">&gt;::</span>is_specialized<span style="color:#333">&gt;::</span>type<span style="color:#333">&gt;</span>
<span style="color:#080;font-weight:bold">struct</span> <span style="color:#b06;font-weight:bold">min_f</span> {
    <span style="color:#080;font-weight:bold">static</span> <span style="color:#080;font-weight:bold">constexpr</span> T default_value <span style="color:#333">=</span> v;
    <span style="color:#080;font-weight:bold">static</span> <span style="color:#080;font-weight:bold">constexpr</span> <span style="color:#339;font-weight:bold">bool</span> idempotent <span style="color:#333">=</span> <span style="color:#007020">true</span>;
    T <span style="color:#06b;font-weight:bold">operator</span>()(<span style="color:#080;font-weight:bold">const</span> T<span style="color:#333">&amp;</span> a, <span style="color:#080;font-weight:bold">const</span> T<span style="color:#333">&amp;</span> b) <span style="color:#080;font-weight:bold">const</span> { <span style="color:#080;font-weight:bold">return</span> min(a, b); }
};
<span style="color:#080;font-weight:bold">template</span> <span style="color:#333">&lt;</span><span style="color:#080;font-weight:bold">class</span> <span style="color:#b06;font-weight:bold">T</span>, T v, <span style="color:#080;font-weight:bold">typename</span> R<span style="color:#333">&gt;</span>
<span style="color:#080;font-weight:bold">constexpr</span> <span style="color:#080;font-weight:bold">const</span> T min_f<span style="color:#333">&lt;</span>T, v, R<span style="color:#333">&gt;::</span>default_value;

<span style="color:#339;font-weight:bold">uint64_t</span> <span style="color:#06b;font-weight:bold">gcd</span>(<span style="color:#339;font-weight:bold">uint64_t</span> a, <span style="color:#339;font-weight:bold">uint64_t</span> b) {
    <span style="color:#080;font-weight:bold">if</span> (a <span style="color:#333">&lt;</span> b) swap(a, b);
    <span style="color:#080;font-weight:bold">while</span> (b <span style="color:#333">!=</span> <span style="color:#00d;font-weight:bold">0</span>) {
        <span style="color:#080;font-weight:bold">auto</span> t <span style="color:#333">=</span> b;
        b <span style="color:#333">=</span> a <span style="color:#333">%</span> b;
        a <span style="color:#333">=</span> t;
    }
    <span style="color:#080;font-weight:bold">return</span> a;
}

<span style="color:#080;font-weight:bold">template</span> <span style="color:#333">&lt;</span><span style="color:#080;font-weight:bold">class</span> <span style="color:#b06;font-weight:bold">T</span>, T v <span style="color:#333">=</span> T{}, <span style="color:#080;font-weight:bold">typename</span> <span style="color:#333">=</span> <span style="color:#080;font-weight:bold">typename</span> enable_if<span style="color:#333">&lt;</span>numeric_limits<span style="color:#333">&lt;</span>T<span style="color:#333">&gt;::</span>is_integer<span style="color:#333">&gt;::</span>type<span style="color:#333">&gt;</span>
<span style="color:#080;font-weight:bold">struct</span> <span style="color:#b06;font-weight:bold">gcd_f</span> {
    <span style="color:#080;font-weight:bold">static</span> <span style="color:#080;font-weight:bold">constexpr</span> T default_value <span style="color:#333">=</span> v;
    <span style="color:#080;font-weight:bold">static</span> <span style="color:#080;font-weight:bold">constexpr</span> <span style="color:#339;font-weight:bold">bool</span> idempotent <span style="color:#333">=</span> <span style="color:#007020">true</span>;
    T <span style="color:#06b;font-weight:bold">operator</span>()(<span style="color:#080;font-weight:bold">const</span> T<span style="color:#333">&amp;</span> a, <span style="color:#080;font-weight:bold">const</span> T<span style="color:#333">&amp;</span> b) <span style="color:#080;font-weight:bold">const</span> { <span style="color:#080;font-weight:bold">return</span> gcd(a, b); }
};
<span style="color:#080;font-weight:bold">template</span> <span style="color:#333">&lt;</span><span style="color:#080;font-weight:bold">class</span> <span style="color:#b06;font-weight:bold">T</span>, T v, <span style="color:#080;font-weight:bold">typename</span> R<span style="color:#333">&gt;</span>
<span style="color:#080;font-weight:bold">constexpr</span> <span style="color:#080;font-weight:bold">const</span> T gcd_f<span style="color:#333">&lt;</span>T, v, R<span style="color:#333">&gt;::</span>default_value;

<span style="color:#080;font-weight:bold">template</span> <span style="color:#333">&lt;</span><span style="color:#080;font-weight:bold">class</span> <span style="color:#b06;font-weight:bold">T</span>, <span style="color:#080;font-weight:bold">class</span> <span style="color:#b06;font-weight:bold">F</span> <span style="color:#333">=</span> max_f<span style="color:#333">&lt;</span>T<span style="color:#333">&gt;&gt;</span>
<span style="color:#080;font-weight:bold">using</span> SparseTable <span style="color:#333">=</span> st_impl<span style="color:#333">::</span>SparseTable<span style="color:#333">&lt;</span>T, F<span style="color:#333">&gt;</span>;

<span style="color:#080;font-weight:bold">template</span> <span style="color:#333">&lt;</span><span style="color:#080;font-weight:bold">class</span> <span style="color:#b06;font-weight:bold">F</span><span style="color:#333">&gt;</span>
<span style="color:#339;font-weight:bold">void</span> random_test(string target_func) {
    <span style="color:#339;font-weight:bold">int</span> n <span style="color:#333">=</span> <span style="color:#00d;font-weight:bold">400</span>;
    vector<span style="color:#333">&lt;</span><span style="color:#339;font-weight:bold">int</span><span style="color:#333">&gt;</span> test(n);

    <span style="color:#888">// generate random numbers
</span><span style="color:#888"></span>    random_device r;
    default_random_engine <span style="color:#06b;font-weight:bold">eng</span>(r());
    uniform_int_distribution<span style="color:#333">&lt;</span><span style="color:#339;font-weight:bold">int</span><span style="color:#333">&gt;</span> uniform_dist(<span style="color:#00d;font-weight:bold">0</span>, <span style="color:#00d;font-weight:bold">2000</span>);

    <span style="color:#080;font-weight:bold">for</span> (<span style="color:#339;font-weight:bold">int</span> i <span style="color:#333">=</span> <span style="color:#00d;font-weight:bold">0</span>; i <span style="color:#333">&lt;</span> n; <span style="color:#333">++</span>i) {
        test[i] <span style="color:#333">=</span> uniform_dist(eng);
    }

    <span style="color:#888">// query and verify
</span><span style="color:#888"></span>    F f;
    SparseTable<span style="color:#333">&lt;</span><span style="color:#339;font-weight:bold">int</span>, F<span style="color:#333">&gt;</span> st_test(test, f);

    cout <span style="color:#333">&lt;&lt;</span> <span style="background-color:#fff0f0">&#34;Begin random test on &#34;</span> <span style="color:#333">&lt;&lt;</span> target_func <span style="color:#333">&lt;&lt;</span> <span style="background-color:#fff0f0">&#34;!&#34;</span> <span style="color:#333">&lt;&lt;</span> endl;
    <span style="color:#339;font-weight:bold">int</span> t <span style="color:#333">=</span> <span style="color:#00d;font-weight:bold">10</span>;
    <span style="color:#080;font-weight:bold">for</span> (<span style="color:#339;font-weight:bold">int</span> i <span style="color:#333">=</span> <span style="color:#00d;font-weight:bold">0</span>; i <span style="color:#333">&lt;</span> t; <span style="color:#333">++</span>i) {
        <span style="color:#339;font-weight:bold">int</span> l <span style="color:#333">=</span> uniform_dist(eng) <span style="color:#333">%</span> n, r <span style="color:#333">=</span> l <span style="color:#333">+</span> ((uniform_dist(eng) <span style="color:#333">%</span> (n <span style="color:#333">-</span> l)) <span style="color:#333">&gt;&gt;</span> (i <span style="color:#333">/</span> <span style="color:#00d;font-weight:bold">2</span>));
        <span style="color:#080;font-weight:bold">auto</span> to_verify <span style="color:#333">=</span> st_test.rangeQuery(l, r);
        <span style="color:#080;font-weight:bold">auto</span> expected <span style="color:#333">=</span> <span style="color:#080;font-weight:bold">decltype</span>(f)<span style="color:#333">::</span>default_value;

        <span style="color:#080;font-weight:bold">for</span> (<span style="color:#339;font-weight:bold">int</span> j <span style="color:#333">=</span> l; j <span style="color:#333">&lt;=</span> r; <span style="color:#333">++</span>j) {
            expected <span style="color:#333">=</span> f(expected, test[j]);
        }
        assert(to_verify <span style="color:#333">==</span> expected);
        cout <span style="color:#333">&lt;&lt;</span> <span style="background-color:#fff0f0">&#34; + query range(&#34;</span> <span style="color:#333">&lt;&lt;</span> l <span style="color:#333">&lt;&lt;</span> <span style="background-color:#fff0f0">&#34;,&#34;</span> <span style="color:#333">&lt;&lt;</span> r <span style="color:#333">&lt;&lt;</span> <span style="background-color:#fff0f0">&#34;)</span><span style="color:#666;background-color:#fff0f0;font-weight:bold">\t</span><span style="background-color:#fff0f0">= &#34;</span> <span style="color:#333">&lt;&lt;</span> to_verify <span style="color:#333">&lt;&lt;</span> endl;
    }
    cout <span style="color:#333">&lt;&lt;</span> <span style="background-color:#fff0f0">&#34;Test passed!&#34;</span> <span style="color:#333">&lt;&lt;</span> endl;
}

<span style="color:#339;font-weight:bold">void</span> <span style="color:#06b;font-weight:bold">regular_test</span>() {
    SparseTable<span style="color:#333">&lt;</span><span style="color:#339;font-weight:bold">int</span><span style="color:#333">&gt;</span> st_max({<span style="color:#00d;font-weight:bold">3</span>, <span style="color:#00d;font-weight:bold">1</span>, <span style="color:#00d;font-weight:bold">2</span>, <span style="color:#00d;font-weight:bold">5</span>, <span style="color:#00d;font-weight:bold">2</span>, <span style="color:#00d;font-weight:bold">10</span>, <span style="color:#00d;font-weight:bold">8</span>});

    assert(st_max.rangeQuery(<span style="color:#00d;font-weight:bold">0</span>, <span style="color:#00d;font-weight:bold">2</span>) <span style="color:#333">==</span> <span style="color:#00d;font-weight:bold">3</span>);
    assert(st_max.rangeQuery(<span style="color:#00d;font-weight:bold">3</span>, <span style="color:#00d;font-weight:bold">6</span>) <span style="color:#333">==</span> <span style="color:#00d;font-weight:bold">10</span>);
    assert(st_max.rangeQuery(<span style="color:#00d;font-weight:bold">0</span>, <span style="color:#00d;font-weight:bold">6</span>) <span style="color:#333">==</span> <span style="color:#00d;font-weight:bold">10</span>);
    assert(st_max.rangeQuery(<span style="color:#00d;font-weight:bold">2</span>, <span style="color:#00d;font-weight:bold">4</span>) <span style="color:#333">==</span> <span style="color:#00d;font-weight:bold">5</span>);

    SparseTable<span style="color:#333">&lt;</span><span style="color:#339;font-weight:bold">int</span>, min_f<span style="color:#333">&lt;</span><span style="color:#339;font-weight:bold">int</span><span style="color:#333">&gt;&gt;</span> st_min({<span style="color:#00d;font-weight:bold">3</span>, <span style="color:#00d;font-weight:bold">1</span>, <span style="color:#00d;font-weight:bold">2</span>, <span style="color:#00d;font-weight:bold">5</span>, <span style="color:#00d;font-weight:bold">2</span>, <span style="color:#00d;font-weight:bold">10</span>, <span style="color:#00d;font-weight:bold">8</span>});

    assert(st_min.rangeQuery(<span style="color:#00d;font-weight:bold">0</span>, <span style="color:#00d;font-weight:bold">2</span>) <span style="color:#333">==</span> <span style="color:#00d;font-weight:bold">1</span>);
    assert(st_min.rangeQuery(<span style="color:#00d;font-weight:bold">3</span>, <span style="color:#00d;font-weight:bold">6</span>) <span style="color:#333">==</span> <span style="color:#00d;font-weight:bold">2</span>);
    assert(st_min.rangeQuery(<span style="color:#00d;font-weight:bold">0</span>, <span style="color:#00d;font-weight:bold">6</span>) <span style="color:#333">==</span> <span style="color:#00d;font-weight:bold">1</span>);
    assert(st_min.rangeQuery(<span style="color:#00d;font-weight:bold">2</span>, <span style="color:#00d;font-weight:bold">4</span>) <span style="color:#333">==</span> <span style="color:#00d;font-weight:bold">2</span>);

    SparseTable<span style="color:#333">&lt;</span><span style="color:#339;font-weight:bold">int</span>, sum_f<span style="color:#333">&lt;</span><span style="color:#339;font-weight:bold">int</span><span style="color:#333">&gt;&gt;</span> st_sum({<span style="color:#00d;font-weight:bold">3</span>, <span style="color:#00d;font-weight:bold">1</span>, <span style="color:#00d;font-weight:bold">2</span>, <span style="color:#00d;font-weight:bold">5</span>, <span style="color:#00d;font-weight:bold">2</span>, <span style="color:#00d;font-weight:bold">10</span>, <span style="color:#00d;font-weight:bold">8</span>});

    assert(st_sum.rangeQuery(<span style="color:#00d;font-weight:bold">0</span>, <span style="color:#00d;font-weight:bold">2</span>) <span style="color:#333">==</span> <span style="color:#00d;font-weight:bold">6</span>);
    assert(st_sum.rangeQuery(<span style="color:#00d;font-weight:bold">3</span>, <span style="color:#00d;font-weight:bold">6</span>) <span style="color:#333">==</span> <span style="color:#00d;font-weight:bold">25</span>);
    assert(st_sum.rangeQuery(<span style="color:#00d;font-weight:bold">0</span>, <span style="color:#00d;font-weight:bold">6</span>) <span style="color:#333">==</span> <span style="color:#00d;font-weight:bold">31</span>);
    assert(st_sum.rangeQuery(<span style="color:#00d;font-weight:bold">2</span>, <span style="color:#00d;font-weight:bold">4</span>) <span style="color:#333">==</span> <span style="color:#00d;font-weight:bold">9</span>);
}

<span style="color:#339;font-weight:bold">int</span> <span style="color:#06b;font-weight:bold">main</span>() {
    regular_test();

    random_test<span style="color:#333">&lt;</span>max_f<span style="color:#333">&lt;</span><span style="color:#339;font-weight:bold">int</span><span style="color:#333">&gt;&gt;</span>(<span style="background-color:#fff0f0">&#34;max&#34;</span>);
    random_test<span style="color:#333">&lt;</span>min_f<span style="color:#333">&lt;</span><span style="color:#339;font-weight:bold">int</span><span style="color:#333">&gt;&gt;</span>(<span style="background-color:#fff0f0">&#34;min&#34;</span>);
    random_test<span style="color:#333">&lt;</span>sum_f<span style="color:#333">&lt;</span><span style="color:#339;font-weight:bold">int</span><span style="color:#333">&gt;&gt;</span>(<span style="background-color:#fff0f0">&#34;sum&#34;</span>);
    random_test<span style="color:#333">&lt;</span>gcd_f<span style="color:#333">&lt;</span><span style="color:#339;font-weight:bold">int</span><span style="color:#333">&gt;&gt;</span>(<span style="background-color:#fff0f0">&#34;gcd&#34;</span>);

    <span style="color:#080;font-weight:bold">return</span> <span style="color:#00d;font-weight:bold">0</span>;
}
</code></pre></div><h4 id="selective-additions--pbs-c">Selective Additions / PBS C++</h4>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp"><span style="color:#579">#include</span> <span style="color:#579">&lt;iostream&gt;</span><span style="color:#579">
</span><span style="color:#579">#include</span> <span style="color:#579">&lt;cstdio&gt;</span><span style="color:#579">
</span><span style="color:#579">#include</span> <span style="color:#579">&lt;cstdlib&gt;</span><span style="color:#579">
</span><span style="color:#579">#include</span> <span style="color:#579">&lt;algorithm&gt;</span><span style="color:#579">
</span><span style="color:#579">#include</span> <span style="color:#579">&lt;vector&gt;</span><span style="color:#579">
</span><span style="color:#579">#include</span> <span style="color:#579">&lt;climits&gt;</span><span style="color:#579">
</span><span style="color:#579">#include</span> <span style="color:#579">&lt;utility&gt;</span><span style="color:#579">
</span><span style="color:#579">#include</span> <span style="color:#579">&lt;queue&gt;</span><span style="color:#579">
</span><span style="color:#579">#include</span> <span style="color:#579">&lt;map&gt;</span><span style="color:#579">
</span><span style="color:#579"></span>
<span style="color:#080;font-weight:bold">using</span> <span style="color:#080;font-weight:bold">namespace</span> std;

<span style="color:#579">#define defv(alias, type) using v##alias = vector&lt;type&gt;
</span><span style="color:#579">#define defvv(alias, type) using vv##alias = vector&lt;vector&lt;type&gt;&gt;
</span><span style="color:#579"></span>
<span style="color:#080;font-weight:bold">using</span> ii <span style="color:#333">=</span> pair<span style="color:#333">&lt;</span><span style="color:#339;font-weight:bold">int</span>, <span style="color:#339;font-weight:bold">int</span><span style="color:#333">&gt;</span>;
<span style="color:#080;font-weight:bold">using</span> iii <span style="color:#333">=</span> pair<span style="color:#333">&lt;</span><span style="color:#339;font-weight:bold">int</span>, ii<span style="color:#333">&gt;</span>;

defv(i, <span style="color:#339;font-weight:bold">int</span>);
defvv(i, <span style="color:#339;font-weight:bold">int</span>);
defv(ii, ii);
defvv(ii, ii);

<span style="color:#579">#define forall(i, a, b) for (int i = int(a); i &lt; int(b); ++i)
</span><span style="color:#579">#define all(a) a.begin(), a.end()
</span><span style="color:#579">#define inf (IMAX_NT_MAX / 2)
</span><span style="color:#579">#define sz(a) int(a.size())
</span><span style="color:#579">#define mp(a, b) make_pair(a, b)
</span><span style="color:#579"></span>
<span style="color:#080;font-weight:bold">const</span> <span style="color:#339;font-weight:bold">int</span> MAX_N <span style="color:#333">=</span> <span style="color:#60e;font-weight:bold">1e5</span> <span style="color:#333">+</span> <span style="color:#00d;font-weight:bold">5</span>;

<span style="color:#339;font-weight:bold">long</span> a[MAX_N], d[MAX_N];
<span style="color:#339;font-weight:bold">int</span> l[MAX_N], r[MAX_N];
<span style="color:#339;font-weight:bold">long</span> f[<span style="color:#00d;font-weight:bold">5</span>];

<span style="color:#339;font-weight:bold">int</span> n, m, k;

<span style="color:#339;font-weight:bold">long</span> fen[MAX_N];
<span style="color:#339;font-weight:bold">int</span> <span style="color:#06b;font-weight:bold">lowbit</span>(<span style="color:#339;font-weight:bold">int</span> x) { <span style="color:#080;font-weight:bold">return</span> x <span style="color:#333">&amp;</span> <span style="color:#333">-</span>x; }

<span style="color:#339;font-weight:bold">void</span> <span style="color:#06b;font-weight:bold">fen_update</span>(<span style="color:#339;font-weight:bold">long</span> <span style="color:#333">*</span>fen, <span style="color:#339;font-weight:bold">int</span> idx, <span style="color:#339;font-weight:bold">int</span> delta) {
    <span style="color:#080;font-weight:bold">for</span> (<span style="color:#339;font-weight:bold">int</span> i <span style="color:#333">=</span> idx; i <span style="color:#333">&lt;</span> n; i <span style="color:#333">+=</span> lowbit(i <span style="color:#333">+</span> <span style="color:#00d;font-weight:bold">1</span>)) {
        fen[i] <span style="color:#333">+=</span> delta;
    }
}

<span style="color:#339;font-weight:bold">long</span> <span style="color:#06b;font-weight:bold">__fen_get</span>(<span style="color:#339;font-weight:bold">long</span> <span style="color:#333">*</span>fen, <span style="color:#339;font-weight:bold">int</span> r) {
    <span style="color:#339;font-weight:bold">long</span> res <span style="color:#333">=</span> <span style="color:#00d;font-weight:bold">0</span>;
    <span style="color:#080;font-weight:bold">while</span> (r <span style="color:#333">&gt;=</span> <span style="color:#00d;font-weight:bold">0</span>) {
        res <span style="color:#333">+=</span> fen[r];
        r <span style="color:#333">-=</span> lowbit(r <span style="color:#333">+</span> <span style="color:#00d;font-weight:bold">1</span>);
    }
    <span style="color:#080;font-weight:bold">return</span> res;
}

<span style="color:#339;font-weight:bold">long</span> <span style="color:#06b;font-weight:bold">fen_get</span>(<span style="color:#339;font-weight:bold">long</span> <span style="color:#333">*</span>fen, <span style="color:#339;font-weight:bold">int</span> l, <span style="color:#339;font-weight:bold">int</span> r) { <span style="color:#080;font-weight:bold">return</span> __fen_get(fen, r) <span style="color:#333">-</span> __fen_get(fen, l <span style="color:#333">-</span> <span style="color:#00d;font-weight:bold">1</span>); }

<span style="color:#339;font-weight:bold">void</span> <span style="color:#06b;font-weight:bold">fen_range_update</span>(<span style="color:#339;font-weight:bold">long</span> <span style="color:#333">*</span>fen, <span style="color:#339;font-weight:bold">int</span> l, <span style="color:#339;font-weight:bold">int</span> r, <span style="color:#339;font-weight:bold">int</span> delta) {
    fen_update(fen, l, delta);
    fen_update(fen, r <span style="color:#333">+</span> <span style="color:#00d;font-weight:bold">1</span>, <span style="color:#333">-</span>delta);
}

<span style="color:#339;font-weight:bold">long</span> <span style="color:#06b;font-weight:bold">fen_point_get</span>(<span style="color:#339;font-weight:bold">long</span> <span style="color:#333">*</span>fen, <span style="color:#339;font-weight:bold">int</span> i) { <span style="color:#080;font-weight:bold">return</span> __fen_get(fen, i); }

<span style="color:#339;font-weight:bold">void</span> <span style="color:#06b;font-weight:bold">fen_reset</span>(<span style="color:#339;font-weight:bold">long</span> <span style="color:#333">*</span>fen) { forall(i, <span style="color:#00d;font-weight:bold">0</span>, n) fen[i] <span style="color:#333">=</span> <span style="color:#00d;font-weight:bold">0</span>; }

<span style="color:#080;font-weight:bold">inline</span> <span style="color:#339;font-weight:bold">int</span> <span style="color:#06b;font-weight:bold">fls</span>(<span style="color:#339;font-weight:bold">int</span> x) {
    <span style="color:#339;font-weight:bold">int</span> r <span style="color:#333">=</span> <span style="color:#00d;font-weight:bold">32</span>;

    <span style="color:#080;font-weight:bold">if</span> (<span style="color:#333">!</span>x) <span style="color:#080;font-weight:bold">return</span> <span style="color:#00d;font-weight:bold">0</span>;
    <span style="color:#080;font-weight:bold">if</span> (<span style="color:#333">!</span>(x <span style="color:#333">&amp;</span> <span style="color:#058;font-weight:bold">0xffff0000u</span>)) {
        x <span style="color:#333">&lt;&lt;=</span> <span style="color:#00d;font-weight:bold">16</span>;
        r <span style="color:#333">-=</span> <span style="color:#00d;font-weight:bold">16</span>;
    }
    <span style="color:#080;font-weight:bold">if</span> (<span style="color:#333">!</span>(x <span style="color:#333">&amp;</span> <span style="color:#058;font-weight:bold">0xff000000u</span>)) {
        x <span style="color:#333">&lt;&lt;=</span> <span style="color:#00d;font-weight:bold">8</span>;
        r <span style="color:#333">-=</span> <span style="color:#00d;font-weight:bold">8</span>;
    }
    <span style="color:#080;font-weight:bold">if</span> (<span style="color:#333">!</span>(x <span style="color:#333">&amp;</span> <span style="color:#058;font-weight:bold">0xf0000000u</span>)) {
        x <span style="color:#333">&lt;&lt;=</span> <span style="color:#00d;font-weight:bold">4</span>;
        r <span style="color:#333">-=</span> <span style="color:#00d;font-weight:bold">4</span>;
    }
    <span style="color:#080;font-weight:bold">if</span> (<span style="color:#333">!</span>(x <span style="color:#333">&amp;</span> <span style="color:#058;font-weight:bold">0xc0000000u</span>)) {
        x <span style="color:#333">&lt;&lt;=</span> <span style="color:#00d;font-weight:bold">2</span>;
        r <span style="color:#333">-=</span> <span style="color:#00d;font-weight:bold">2</span>;
    }
    <span style="color:#080;font-weight:bold">if</span> (<span style="color:#333">!</span>(x <span style="color:#333">&amp;</span> <span style="color:#058;font-weight:bold">0x80000000u</span>)) {
        x <span style="color:#333">&lt;&lt;=</span> <span style="color:#00d;font-weight:bold">1</span>;
        r <span style="color:#333">-=</span> <span style="color:#00d;font-weight:bold">1</span>;
    }
    <span style="color:#080;font-weight:bold">return</span> r;
}

<span style="color:#339;font-weight:bold">int</span> t[MAX_N], lb[MAX_N], rb[MAX_N];
vector<span style="color:#333">&lt;</span><span style="color:#339;font-weight:bold">int</span><span style="color:#333">&gt;</span> to_check[MAX_N <span style="color:#333">+</span> <span style="color:#00d;font-weight:bold">1</span>];
<span style="color:#339;font-weight:bold">void</span> <span style="color:#06b;font-weight:bold">solve</span>() {
    sort(f, f <span style="color:#333">+</span> k);
    fill_n(t, n, <span style="color:#333">-</span><span style="color:#00d;font-weight:bold">1</span>);
    forall(i, <span style="color:#00d;font-weight:bold">0</span>, n) forall(s, <span style="color:#00d;font-weight:bold">0</span>, k) {
        <span style="color:#080;font-weight:bold">if</span> (t[i] <span style="color:#333">&lt;</span> <span style="color:#00d;font-weight:bold">0</span> <span style="color:#333">&amp;&amp;</span> a[i] <span style="color:#333">==</span> f[s]) t[i] <span style="color:#333">=</span> <span style="color:#00d;font-weight:bold">0</span>;
    }

    <span style="color:#888">// Parallel Binary Search
</span><span style="color:#888"></span>    <span style="color:#080;font-weight:bold">for</span> (<span style="color:#339;font-weight:bold">int</span> s <span style="color:#333">=</span> <span style="color:#00d;font-weight:bold">0</span>; s <span style="color:#333">&lt;</span> k; <span style="color:#333">++</span>s) {
        forall(i, <span style="color:#00d;font-weight:bold">0</span>, n) <span style="color:#080;font-weight:bold">if</span> (t[i] <span style="color:#333">&lt;</span> <span style="color:#00d;font-weight:bold">0</span>) { lb[i] <span style="color:#333">=</span> <span style="color:#00d;font-weight:bold">1</span>, rb[i] <span style="color:#333">=</span> m; }
        forall(rnd, <span style="color:#00d;font-weight:bold">0</span>, fls(m)) {
            fen_reset(fen);
            forall(i, <span style="color:#00d;font-weight:bold">0</span>, m <span style="color:#333">+</span> <span style="color:#00d;font-weight:bold">1</span>) to_check[i].clear();
            forall(i, <span style="color:#00d;font-weight:bold">0</span>, n) {
                <span style="color:#080;font-weight:bold">if</span> (t[i] <span style="color:#333">&lt;</span> <span style="color:#00d;font-weight:bold">0</span>) to_check[(lb[i] <span style="color:#333">+</span> rb[i]) <span style="color:#333">&gt;&gt;</span> <span style="color:#00d;font-weight:bold">1</span>].push_back(i);
            }
            forall(i, <span style="color:#00d;font-weight:bold">0</span>, m) {
                fen_range_update(fen, l[i], r[i], d[i]);
                <span style="color:#080;font-weight:bold">for</span> (<span style="color:#339;font-weight:bold">int</span> <span style="color:#970;font-weight:bold">idx</span> : to_check[i <span style="color:#333">+</span> <span style="color:#00d;font-weight:bold">1</span>]) {
                    <span style="color:#080;font-weight:bold">auto</span> now <span style="color:#333">=</span> fen_point_get(fen, idx);
                    <span style="color:#080;font-weight:bold">if</span> (now <span style="color:#333">+</span> a[idx] <span style="color:#333">&gt;</span> f[s])
                        rb[idx] <span style="color:#333">=</span> i;
                    <span style="color:#080;font-weight:bold">else</span> <span style="color:#080;font-weight:bold">if</span> (now <span style="color:#333">+</span> a[idx] <span style="color:#333">&lt;</span> f[s])
                        lb[idx] <span style="color:#333">=</span> i <span style="color:#333">+</span> <span style="color:#00d;font-weight:bold">2</span>;
                    <span style="color:#080;font-weight:bold">else</span>
                        t[idx] <span style="color:#333">=</span> i <span style="color:#333">+</span> <span style="color:#00d;font-weight:bold">1</span>;
                }
            }
        }
    }

    <span style="color:#888">// reuse fen for counting invalid updates
</span><span style="color:#888"></span>    <span style="color:#339;font-weight:bold">long</span> sum <span style="color:#333">=</span> <span style="color:#00d;font-weight:bold">0</span>;
    fen_reset(fen);
    forall(i, <span style="color:#00d;font-weight:bold">0</span>, m <span style="color:#333">+</span> <span style="color:#00d;font-weight:bold">1</span>) to_check[i].clear();
    forall(i, <span style="color:#00d;font-weight:bold">0</span>, n) {
        <span style="color:#080;font-weight:bold">if</span> (t[i] <span style="color:#333">==</span> <span style="color:#00d;font-weight:bold">0</span>)
            fen_update(fen, i, <span style="color:#00d;font-weight:bold">1</span>);
        <span style="color:#080;font-weight:bold">else</span> <span style="color:#080;font-weight:bold">if</span> (t[i] <span style="color:#333">&gt;</span> <span style="color:#00d;font-weight:bold">0</span>)
            to_check[t[i]].push_back(i);
        sum <span style="color:#333">+=</span> a[i];
    }

    forall(i, <span style="color:#00d;font-weight:bold">0</span>, m) {
        sum <span style="color:#333">+=</span> d[i] <span style="color:#333">*</span> (r[i] <span style="color:#333">-</span> l[i] <span style="color:#333">+</span> <span style="color:#00d;font-weight:bold">1</span> <span style="color:#333">-</span> fen_get(fen, l[i], r[i]));
        cout <span style="color:#333">&lt;&lt;</span> sum <span style="color:#333">&lt;&lt;</span> endl;
        <span style="color:#080;font-weight:bold">for</span> (<span style="color:#080;font-weight:bold">auto</span> <span style="color:#970;font-weight:bold">idx</span> : to_check[i <span style="color:#333">+</span> <span style="color:#00d;font-weight:bold">1</span>]) {
            fen_update(fen, idx, <span style="color:#00d;font-weight:bold">1</span>);
        }
    }
}

<span style="color:#339;font-weight:bold">int</span> <span style="color:#06b;font-weight:bold">main</span>() {
    cin <span style="color:#333">&gt;&gt;</span> n <span style="color:#333">&gt;&gt;</span> m <span style="color:#333">&gt;&gt;</span> k;
    forall(i, <span style="color:#00d;font-weight:bold">0</span>, n) { cin <span style="color:#333">&gt;&gt;</span> a[i]; }
    forall(i, <span style="color:#00d;font-weight:bold">0</span>, k) { cin <span style="color:#333">&gt;&gt;</span> f[i]; }
    forall(i, <span style="color:#00d;font-weight:bold">0</span>, m) {
        cin <span style="color:#333">&gt;&gt;</span> l[i] <span style="color:#333">&gt;&gt;</span> r[i] <span style="color:#333">&gt;&gt;</span> d[i];
        l[i]<span style="color:#333">--</span>, r[i]<span style="color:#333">--</span>;
    }

    solve();

    <span style="color:#080;font-weight:bold">return</span> <span style="color:#00d;font-weight:bold">0</span>;
}
</code></pre></div>
      </div>
    </section>
    
    <section class="pagination clearfix">
      
      <a class="btn previous " href="https://blog.crazyark.xyz/posts/binary_indexed_tree/"> äºŒå‰ç´¢å¼•æ ‘/æ ‘çŠ¶æ•°ç»„ (Binary Indexed Tree) </a> 
       
      
      <a class="btn next " href="https://blog.crazyark.xyz/posts/maximum_matching_in_bipartite_graph/"> äºŒéƒ¨å›¾çš„æœ€å¤§åŒ¹é… (Maximum Matching in Bipartite Graph) </a> 
      
    </section>
    
    
<section id="disqus_thread" class='disqus'></section>
<script>
  var disqus_config = function () {
    this.page.url = "https://blog.crazyark.xyz/posts/hourrank23/";
    
  };
  (function() {
    var d = document, s = d.createElement('script');
    s.src = '//crazyark.disqus.com/embed.js';
    s.setAttribute('data-timestamp', +new Date());
    (d.head || d.body).appendChild(s);
  })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript>

  </div>
  
  <footer>
  <div class="footer-info">
    <p>
      <a href="mailto:arkbriar@gmail.com?subject="><i class="far fa-envelope"></i> arkbriar@gmail.com </a>
      {
        <a href="https://gohugo.io/" title="Hugo :: A fast and modern static website engine">Hugo 0.87.0</a>,
        <a href="https://github.com/IvanChou/yii.im" title="vec">Vec</a> 
      }
      {<a href="http://creativecommons.org/licenses/by-nc-nd/3.0/" title="CC BY-NC-ND 3.0">CC BY-NC-ND 3.0</a>}
    </p>
  </div>
</footer>


  <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>

<script type="text/x-mathjax-config">
MathJax.Hub.Config({
  tex2jax: {
    inlineMath: [['$','$']],
    displayMath: [['$$','$$']],
    processEscapes: true,
    processEnvironments: true,
    skipTags: ['script', 'noscript', 'style', 'textarea', 'pre'],
    TeX: { equationNumbers: { autoNumber: "AMS" },
         extensions: ["AMSmath.js", "AMSsymbols.js"] }
  }
});
</script>

<style type="text/css" media="screen">
  code.has-jax {
    font: inherit;
    font-size: 100%;
    background: inherit;
    border: inherit;
    color: #515151;
}
</style>

<script type="text/x-mathjax-config">
  MathJax.Hub.Queue(function() {
    // Fix <code> tags after MathJax finishes running. This is a
    // hack to overcome a shortcoming of Markdown. Discussion at
    // https://github.com/mojombo/jekyll/issues/199
    var all = MathJax.Hub.getAllJax();
    all.forEach(function(e) {
        e.SourceElement().parentNode.className += ' has-jax';
    });
});
</script>

  
  <script src="https://blog.crazyark.xyz/js/highlight.min.js"></script>
  <script>
    hljs.initHighlightingOnLoad();
  </script>
  

</body>

</html>
