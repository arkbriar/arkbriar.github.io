[{"content":"Although the article was originally written in Chinese, with the help of ChatGPT, I was able to provide an English translation. If you want to read the English version, please jump to here for reading.\nä¸ºä»€ä¹ˆè¦å†é€ ä¸€ä¸ªè½®å­ï¼Ÿ é€ è½®å­æ˜¯ç¨‹åºå‘˜çš„æµªæ¼«ï¼ğŸ¥°\nåœ¨å‰ä¸œå®¶å·¥ä½œçš„æ—¶å€™ï¼Œæˆ‘è®¾è®¡äº†ä¸€ä¸ªåˆ†å¸ƒå¼åœºæ™¯ä¸‹çš„å¤‡ä»½æ¢å¤æ–¹æ¡ˆéœ€è¦è§£æå’Œæ“ä½œ binlogã€‚å½“æ—¶ï¼Œæˆ‘æ¯”è¾ƒæƒ³è¦ä¸€ä¸ªå¹²å‡€æ²¡æœ‰ä¾èµ–çš„å·¥å…·ï¼Œå› æ­¤æ²¡æœ‰é€‰æ‹©ç”¨æˆç†Ÿçš„ Java çš„åº“ï¼Œè€Œä½¿ç”¨ Go æ¥è¿›è¡Œäº†å®ç°ã€‚åœ¨å®ç°çš„è¿‡ç¨‹ä¸­ï¼Œæˆ‘å°è¯•äº†ä¸€äº›æ¯”è¾ƒæœ‰æ„æ€çš„æ–¹å¼ã€‚æœ€ç»ˆæ•ˆæœæ˜¯æˆ‘ç”¨ä¸€å‘¨æ—¶é—´ç³Šå®Œäº†æ•´ä¸ªè§£æéƒ¨åˆ†ï¼Œå¹¶ä¸”æ”¯æŒäº†åƒæ¨¡ç³Šæœç´¢ç­‰çš„ä¸€äº›æ¯”è¾ƒæœ‰æ„æ€çš„åŠŸèƒ½ï¼Œå ªå ªèµ¶åœ¨è·‘è·¯å‰å®Œæˆã€‚æœ¬æ–‡ä¸»è¦æ˜¯è®°å½•ä¸€ä¸‹å½“æ—¶çš„ä¸€äº›æƒ³æ³•å’Œå…¶ä¸­ä¸€äº›æœ‰è¶£çš„éƒ¨åˆ†ã€‚\næœ¬æ–‡çš„ä»£ç åœ¨ Github ä¸Šï¼Œæ„Ÿè°¢å‰å¸åŒäº‹ä»¬ç»§ç»­ç»´æŠ¤å¹¶æœ€ç»ˆå°†å®ƒå¼€æºã€‚\nç®€å•ä»‹ç» Binlog Binlog æ˜¯ binary log çš„ç¼©å†™ï¼Œé€šå¸¸æŒ‡ MySQL ä¸­å®ç°çš„äºŒè¿›åˆ¶æ—¥å¿—ã€‚Binlog åŒ…å«äº†ä¸€ç³»åˆ—çš„ç”¨æ¥æè¿°æ•°æ®åº“å˜æ›´æƒ…å†µçš„äº‹ä»¶ï¼Œä¾‹å¦‚å»ºè¡¨ã€åˆ è¡¨ã€å¢åˆ æ”¹æŸ¥ç­‰ç­‰ã€‚åœ¨ binlog ä¸­ï¼Œæ¯ä¸€ä¸ªäº‹ä»¶éƒ½è¢«ç¼–ç æˆä¸€æ®µè¿ç»­çš„äºŒè¿›åˆ¶å†…å®¹ï¼Œå…¶ä¸­åŒ…å«äº†ï¼š\nå›ºå®šçš„äº‹ä»¶å¤´ï¼ŒåŒ…å«äº†äº‹ä»¶ç±»å‹ã€æ—¶é—´æˆ³ã€äº‹ä»¶é•¿åº¦ç­‰ç­‰ï¼› äº‹ä»¶ä½“ï¼Œå¯¹æ¯ä¸€ä¸ªä¸åŒçš„äº‹ä»¶ç±»å‹äº‹ä»¶ä½“çš„å†…å®¹å’Œç¼–ç æ–¹å¼éƒ½ä¸åŒï¼› Binlog äº‹ä»¶å¤´ Binlog è§£æå™¨çš„å·¥ä½œå°±æ˜¯æŠŠç¼–ç åçš„äº‹ä»¶è§£ææˆä¸€ä¸ªä¸ªå†…å­˜ä¸­ç¨‹åºå¯æ“ä½œçš„å¯¹è±¡ã€‚å€¼å¾—æ³¨æ„çš„æ˜¯ï¼Œåœ¨ binlog çš„è¡åŒ–è¿‡ç¨‹ä¸­ï¼Œå‡ºç°å‡ ä¸ªä¸åŒçš„ç‰ˆæœ¬ï¼Œå®ƒä»¬åˆ†åˆ«æ˜¯ v1, v3 å’Œ v4ã€‚å…¶ä¸­ v2 ä»æ¥æ²¡æœ‰æ­£å¼å‘å¸ƒè¿‡ï¼Œå› æ­¤å¯ä»¥å¿½ç•¥[1]ã€‚\nå…³äº binlog çš„è¯¦ç»†ä»‹ç»ç½‘ä¸Šæœ‰å¾ˆå¤šèµ„æ–™ï¼Œè¿™é‡Œä¸å†èµ˜è¿°ã€‚ä½ å¯ä»¥å‚è€ƒå®˜æ–¹æ–‡æ¡£æˆ–æ˜¯å…¶ä»–èµ„æ–™ã€‚\nä¸€äº›æœ‰è¶£çš„å°è¯• é€šå¸¸æ¥è¯´ï¼Œè§£æå™¨è¿™ç§ä¸œè¥¿éƒ½æ˜¯ä½“åŠ›æ´»ã€‚ç‰¹åˆ«æ˜¯é’ˆå¯¹ binlog è¿™ç§ç¼–ç æ–¹å¼ç¨³å®šã€äº‹ä»¶æ•°é‡å‡ ä¹å›ºå®šçš„æ—¥å¿—ï¼Œå®ç°ä¸€ä¸ªè§£æå™¨æœ€å¥½çš„åŠæ³•å°±æ˜¯å¯¹æ¯ä¸€ä¸ªäº‹ä»¶ç¡¬ç¼–ç ä¸€ä¸ªè§£æå‡½æ•°ï¼Œä¾‹å¦‚ go-mysql ä¸­å¯¹ ROWS_EVENT çš„è§£ç å‡½æ•°çš„å®ç°ã€‚è¿™æ ·çš„å®ç°æ–¹å¼æ€§èƒ½å¥½ï¼Œä½†æ˜¯é˜…è¯»èµ·æ¥éå¸¸è´¹åŠ²ã€‚åŒæ—¶ï¼Œå› ä¸º Go â€œå¤§é“è‡³ç®€â€çš„é”™è¯¯å¤„ç†æ–¹å¼ï¼Œç¼–å†™å‡ºæ¥çš„ä»£ç å¸¸å¸¸åˆ°å¤„éƒ½æ˜¯ if err != nilã€‚è€Œä¸”äºŒè¿›åˆ¶ç¼–è§£ç çš„è°ƒè¯•å®åœ¨æ˜¯è´¹åŠ²ï¼Œæƒ³è¦å°½å¿«å®ç°è¿«ä½¿æˆ‘è€ƒè™‘ä¸€äº›å…¶ä»–çš„æ–¹æ³•ã€‚\nfunc (e *TableMapEvent) Decode(data []byte) error { // ... var err error var metaData []byte if metaData, _, n, err = LengthEncodedString(data[pos:]); err != nil { return errors.Trace(err) } if err = e.decodeMeta(metaData); err != nil { return errors.Trace(err) } pos += n // ... if err = e.decodeOptionalMeta(data[pos:]); err != nil { return err } return nil } è¿­ä»£å™¨æ¥å£ ç›¸æ¯”äºå›è°ƒæ¥å£ï¼Œæˆ‘æ›´å–œæ¬¢è¿­ä»£å™¨å¼çš„æ¥å£ã€‚å› æ­¤ï¼Œåœ¨æˆ‘çš„å®ç°ä¸­ï¼Œæ¥å£æ˜¯è¿™æ ·çš„ï¼š\ntype LogEventScanner interface { Next() (EventOffset, event.LogEvent, error) } å£°æ˜å¼çš„è§£æå™¨ ç»è¿‡æˆ‘ä¸€ç•ªç ”ç©¶ä¹‹åï¼Œæˆ‘å‘ç°è™½ç„¶æ•´ä¸ªç¼–ç æ–¹å¼çœ‹èµ·æ¥å¾ˆå¤æ‚ï¼Œä½†å¤§éƒ¨åˆ†éƒ½æ˜¯ä¸€äº›å›ºå®šçš„ç»„åˆã€‚ä¾‹å¦‚ï¼Œå¯¹å„ç§æ•´æ•°çš„ç¼–ç é€šå¸¸éƒ½æ˜¯ä¸€æ ·çš„ç»å…¸ variable-length ç¼–ç ï¼Œè€Œå¯¹å­—ç¬¦ä¸²çš„ç¼–ç åˆ™å¤§æ¦‚ç‡æ˜¯ä¸‹é¢å‡ ç§æ–¹å¼çš„å…¶ä¸­ä¸€ä¸ªï¼š\nä¸€ä¸ªç¼–ç åçš„æ•´æ•°ä»£è¡¨é•¿åº¦ï¼Œåé¢æ˜¯å¯¹åº”é•¿åº¦çš„å­—èŠ‚ NUL ç»“å°¾çš„å­—èŠ‚ä¸² å’Œç¬¬ä¸€ç§æ–¹å¼ä¸€æ ·ï¼ŒåŒæ—¶ç»“å°¾æœ‰ NUL æ˜¾ç„¶è¿™äº›ç›¸åŒçš„ç¼–ç æ–¹å¼å¯ä»¥å˜æˆä¸€ä¸ªä¸ªå‡½æ•°æ¥è°ƒç”¨ã€‚ä½†æ˜¯ï¼Œä½¿ç”¨å‡½æ•°å¹¶ä¸èƒ½å¤Ÿé¿å…è¿ç»­è€Œç¹ççš„é”™è¯¯å¤„ç†ã€‚å®é™…ä¸Šï¼Œå½“æ—¶çš„æˆ‘å—åˆ° SwiftUI ç­‰æ¡†æ¶çš„å½±å“ï¼Œè„‘ä¸­æ—©å°±æƒ³åˆ°äº†ä¸€ä¸ªæ–¹æ³•ï¼šå®ƒéœ€è¦æŠŠäº‹ä»¶è§£ç æ–¹å¼çš„å£°æ˜å’Œè§£ç åŠ¨ä½œè§£è€¦ï¼Œè¿™æ ·æˆ‘å°±å¯ä»¥ä¸ç”¨åœ¨è°ƒæ•´äº‹ä»¶å¸ƒå±€çš„åŒæ—¶å…³æ³¨é”™è¯¯çš„å¤„ç†äº†ã€‚ç±»ä¼¼åœ°ï¼Œæˆ‘å°†è¿™ç§æ–¹å¼å®ç°çš„è§£æå™¨æˆä¸ºä¸€ä¸ªå£°æ˜å¼çš„è§£æå™¨ã€‚ä¸ SwiftUI ç­‰æ¡†æ¶ç›¸åŒï¼Œä½¿ç”¨è¿™ç§æ–¹å¼ç¼–å†™çš„ä»£ç åœ¨ç®€å•åœºæ™¯ä¸‹éå¸¸ç²¾ç®€ï¼Œä¸”æå¤§åœ°æé«˜äº†å¯è¯»æ€§ã€‚\nåœ¨è¿™ç§æ–¹å¼ä¸­ï¼Œäº‹ä»¶çš„è§£æè¿‡ç¨‹ä½¿ç”¨ä¸€ä¸ª Layout å‡½æ•°æ¥å£°æ˜ï¼ˆå®šä¹‰ï¼‰ã€‚ä¹‹æ‰€ä»¥ç”¨å‡½æ•°è€Œä¸æ˜¯ XxxLayout ç»“æ„ä½“ï¼Œæ˜¯å› ä¸ºè¿™ç§æ–¹å¼å¹¶ä¸çµæ´»ã€‚ä½¿ç”¨é—­åŒ…å¯ä»¥å®Œç¾åœ°è§£å†³é—®é¢˜ï¼Œæˆ‘å¯ä»¥åœ¨é—­åŒ…ä¸­å¡å„ç§ä¸´æ—¶çŠ¶æ€ï¼Œå¹¶ä¸”åˆ©ç”¨é—­åŒ…çš„ç‰¹æ€§æŠŠå®ƒä»¬ä¼ åˆ°å„å¤„ã€‚ä»¥ä¸‹æ˜¯ QueryEvent çš„ä¾‹å­ï¼š\ntype QueryEvent struct { ThreadID uint32 `json:\u0026#34;thread_id,omitempty\u0026#34;` ExecTime uint32 `json:\u0026#34;exec_time\u0026#34;` ErrorCode uint16 `json:\u0026#34;error_code\u0026#34;` Schema str.Str `json:\u0026#34;schema\u0026#34;` Query str.Str `json:\u0026#34;query\u0026#34;` StatusVars StatusVariables `json:\u0026#34;status_vars,omitempty\u0026#34;` } func (d *QueryEvent) Layout(version uint32, code byte, fde *FormatDescriptionEvent) *layout.Layout { var schemaLength uint8 var statusVarsLength uint16 return layout.Decl( // Post header layout.Number(\u0026amp;d.ThreadID), layout.Number(\u0026amp;d.ExecTime), layout.Number(\u0026amp;schemaLength), layout.Number(\u0026amp;d.ErrorCode), layout.If(version == spec.V4, layout.Number(\u0026amp;statusVarsLength)), // Payload layout.If(version == spec.V4, layout.Area(\u0026amp;statusVarsLength, func(data []byte) (int, error) { return int(statusVarsLength), d.StatusVars.parseStatusVarsBlock(data) })), layout.Bytes(\u0026amp;schemaLength, \u0026amp;d.Schema), layout.Null(), layout.Bytes(layout.Infinite(), \u0026amp;d.Query), ) } ç›¸ä¿¡å³ä½¿ä½ ç°åœ¨çœ‹ä¸æ‡‚ layout.Number ç­‰çš„æ˜¯ä»€ä¹ˆï¼Œä½ ä¹Ÿèƒ½å¾ˆå¿«ç†è§£è¿™å°±æ˜¯åœ¨è¯´ QUERY_EVENT ç¼–ç åçš„å¸ƒå±€æ˜¯è¿™æ ·çš„ï¼š\nQUERY EVENT DATA ä» layout.Number è°ƒç”¨æ–¹å¼ï¼Œæˆ‘ç›¸ä¿¡ä½ å·²ç»èƒ½çŒœå‡ºè¿™æ˜¯æ€ä¹ˆå®ç°çš„äº† \u0026ndash; å®ƒå°±æ˜¯ä¸€ä¸ªç»‘å®šåˆ° \u0026amp;d.ThreadID è¿™ä¸ª int32 ç±»å‹çš„å˜é‡çš„ä¸€ä¸ªè§£ç å™¨ã€‚å¯¹äºä¸åŒçš„ç±»å‹ï¼Œæˆ‘åœ¨ layout åŒ…ä¸­å®ç°äº†ä¸åŒçš„è§£ç å™¨ï¼Œæˆ‘å°†å®ƒä»¬ç§°ä¸º Fieldã€‚ä»¥ä¸‹æ˜¯ Number çš„å®ç°ï¼š\ntype NumberField[N constraints.Integer | constraints.Float] struct { r *N } func (f NumberField[N]) FromBlock(data []byte) (int, error) { if err := checkDataSize(int(unsafe.Sizeof(N(0))), data); err != nil { return 0, err } utils.ReadNumberLittleEndianHack(f.r, data) return int(unsafe.Sizeof(N(0))), nil } func Number[N constraints.Integer | constraints.Float](r *N) NumberField[N] { return NumberField[N]{r: r} } æœ€åä¾æ ·ç”»è‘«èŠ¦æŠŠæ‰€æœ‰äº‹ä»¶ç±»å‹éƒ½æ”¯æŒäº†å°±è¡Œã€‚åœ¨è¿™ä¸ªè¿‡ç¨‹ä¸­ï¼Œç¹ççš„å‡½æ•°è°ƒç”¨å’Œé”™è¯¯å¤„ç†ä¸å†æ˜¯æˆ‘å†™ç çš„é˜»ç¢ï¼Œåè€Œæ˜¯ MySQL ä¸­æ¶å¿ƒçš„ç¼–ç æ–¹å¼å’Œä¸è¯¦ç»†çš„æ–‡æ¡£ä¸æ—¶é˜»ç¢ç€æˆ‘çš„æ­¥å­ \u0026ndash; å¤§éƒ¨åˆ†æ—¶å€™ï¼Œæˆ‘å¿…é¡»è¦ç¿»ç€ MySQL çš„ä»£ç æ¥ç†è§£ä¸ºä»€ä¹ˆæ˜¯è¿™æ ·ç¼–ç çš„ã€‚\næœ‰ç»†å¿ƒçš„åŒå­¦å¯èƒ½ä¼šé—®äº†ï¼Œè¿™ç§æ–¹å¼ä¼šä¸ä¼šè§£ç æ¯ä¸€ä¸ªäº‹ä»¶éƒ½è¦ç”Ÿæˆä¸€å †çš„ Field å°å¯¹è±¡ï¼Œä¼šä¸ä¼šå¯¹æ€§èƒ½æœ‰å¾ˆå¤§å½±å“ï¼Ÿä½ æ˜¯å¯¹çš„ï¼Œç¡®å®å¾ˆå½±å“ï¼Œä½†ä¹Ÿä¸æ˜¯æ²¡æœ‰åŠæ³• ğŸ¥µã€‚ Binlog çš„ç‰¹æ€§å†³å®šäº†å®ƒçš„è§£æè¿‡ç¨‹ä¸€å®šæ˜¯ä¸€ä¸ªç¡®å®šæ€§çš„è¿‡ç¨‹ï¼Œæ„å‘³ç€åœ¨ç¡®å®šäº†è¦è§£æå“ªæ¡æ—¥å¿—åï¼Œä¸ç®¡æ˜¯æ—¥å¿—ä¸­çš„å“ªä¸ªäº‹ä»¶å®ƒçš„è§£ç è¿‡ç¨‹éƒ½æ˜¯ç¡®å®šçš„ \u0026ndash; è¿™æç¤ºäº†å¯ä»¥å¯¹æ¯ä¸€ä¸ªäº‹ä»¶éƒ½ç¼“å­˜ Layout çš„ç»“æœã€‚åœ¨ç³Šå®Œäº†å¤§éƒ¨åˆ†äº‹ä»¶ä¹‹åï¼Œæˆ‘å°±å®ç°äº†è¿™æ ·çš„ä¸€ä¸ª cacheã€‚æƒ³è¦è¯¦ç»†äº†è§£çš„å¯ä»¥å‚è€ƒçš„ binlog/cache.go è¿™ä¸ªæ–‡ä»¶ã€‚\næœ€ç»ˆæµ‹è¯•åï¼Œå¤§çº¦æ€§èƒ½æ˜¯å•çº¿ç¨‹å…¨å­—æ®µè§£æçº¦ä¸º 200 MB/sï¼Œæµ‹è¯•ç¯å¢ƒæ˜¯ MacBook Pro 13\u0026rsquo;\u0026rsquo; 2019, Intelã€‚åœ¨æˆ‘çœ‹æ¥æ˜¯å®Œå…¨è¶³å¤Ÿçš„äº†ï¼Œæ¯•ç«Ÿè°å®¶çš„ binlog å†™çš„é€Ÿåº¦æœ‰ 200 MBï¼ˆä¸è€ƒè™‘å¤§äº‹åŠ¡ï¼‰ï¼Œè¿™ä¹ˆå¥½çš„ç£ç›˜è¯·ä¸€å®šé‚®å¯„ç»™æˆ‘æµ‹è¯•ä¸€ä¸‹ã€‚\næ¨¡ç³Šæ¢æµ‹äº‹ä»¶å¤´ æœ‰äº†è§£æå™¨ä¹‹åï¼Œæˆ‘å°±å¯ä»¥é€ æˆ‘è‡ªå·±çš„ CLI å·¥å…·äº†ï¼ˆå˜¿å˜¿å˜¿ ğŸ˜ƒï¼‰ã€‚å¦‚æœä½ ç”¨è¿‡ mysqlbinlog è¿™ä¸ªå·¥å…·æ¥æŸ¥çœ‹è¿‡ binlogï¼Œç›¸ä¿¡ä½ ä¸€å®šä¼šç”¨åˆ° --start-position è¿™ä¸ªå‚æ•°æ¥å¿«é€Ÿè·³è½¬åˆ°æŸä¸ªäº‹ä»¶çš„å¼€å¤´ã€‚ç„¶è€Œï¼Œç”±äº binlog æµå¼çš„ç‰¹å¾ï¼Œå¦‚æœä½ æŒ‡å®šçš„ä½ç½®ä¸æ˜¯äº‹ä»¶å¤´ï¼Œmysqlbinlog å°±æ— æ³•ç»§ç»­è¯»ä¸‹å»äº†ï¼Œå®ƒéå¸¸å…‰æ£åœ°ç›´æ¥æŠ¥é”™äº† :) æ˜¯çš„ï¼Œè¿™å¾ˆè®©äººéš¾å—ã€‚è¿™æ„å‘³ç€æˆ‘å¿…é¡»å¦å¤–å¼€ä¸€ä¸ªè®¡ç®—å™¨å’”å’”ç®—å‡ºäº‹ä»¶ä½ç½®ï¼Œç„¶åå†ä¸¢ç»™ mysqlbinlogã€‚æ¯å½“è¿™ä¸ªæ—¶å€™ï¼Œæˆ‘éƒ½åœ¨æƒ³å¦‚æœèƒ½éšä¾¿å¸®æˆ‘æ‰¾åˆ°ä¸‹ä¸€ä¸ªäº‹ä»¶è¾“å‡ºå°±å¥½ï¼Œè¿™æ ·æˆ‘å¾ˆå¿«å°±èƒ½äºŒåˆ†æ‰¾åˆ°æƒ³è¦çš„äº‹ä»¶ã€‚\nç†è®ºä¸Šæ¥è¯´ï¼Œä»æµé‡Œé¢æ¢æµ‹äº‹ä»¶çš„äº‹ä»¶å¤´æ˜¯æ²¡æ³•å®ç°çš„ã€‚ä½†å¹¸è¿çš„æ˜¯ï¼Œç°åœ¨çš„åœºæ™¯æ˜¯æ–‡ä»¶ï¼Œè€Œä¸”äº‹ä»¶å¤´é‡Œé¢æ°å¥½ï¼ˆä¸çŸ¥é“æ˜¯ä¸æ˜¯æ•…æ„åœ°ï¼‰ç•™ä¸‹äº†å†—ä½™ä¿¡æ¯ï¼š event_length å’Œ next_position è¿™ä¸¤ä¸ªå­—æ®µã€‚åœ¨è¯»å–æ–‡ä»¶çš„è¿‡ç¨‹ä¸­ï¼Œæˆ‘ä»¬å¾ˆå®¹æ˜“åœ°å°±èƒ½å¾—çŸ¥å½“å‰çš„ä½ç½®ï¼Œä¹Ÿå°±æ˜¯ current_positionã€‚é‚£ä¹ˆæ˜¾è€Œæ˜“è§ï¼Œcurrent_position + event_length = next_position å¿…é¡»æˆç«‹ã€‚è¿™æ˜¯ä¸€ä¸ªéå¸¸å¼ºçš„ç‰¹å¾ï¼Œå¦‚æœç¬¦åˆçš„è¯ï¼Œå¾ˆå¤§æ¦‚ç‡è¿™ä¸ªä½ç½®æ˜¯ä¸€ä¸ªåˆæ³•çš„äº‹ä»¶å¤´ã€‚å› æ­¤ï¼Œæ¢æµ‹çš„æ–¹å¼å°±å†³å®šæ˜¯å®ƒäº†ï¼å®ç°çš„ä»£ç å¯ä»¥çœ‹è¿™é‡Œã€‚\né‡Œé¢ç”¨äº†ä¸€ä¸ª ring buffer çš„å°æŠ€å·§æ¥å‡å°‘å†…å­˜å¼€é”€ã€‚æœ€ç»ˆå®ç°çš„æ•ˆæœå°±æ˜¯ï¼Œéšä¾¿æŒ‡å®šä»€ä¹ˆå¼€å§‹ä½ç½®ï¼Œåªè¦ä¸‹ä¸€ä¸ªäº‹ä»¶åœ¨æ¢æµ‹é•¿åº¦å†…éƒ½èƒ½éå¸¸å¿«åœ°æ‰¾åˆ°ï¼\nå°¾å£°å’Œä¸‹é›†é¢„å‘Š å½“ç„¶ï¼Œé€ è½®å­çš„äººæ°¸è¿œä¸ä¼šæ»¡è¶³ï¼Œä¸€äº›èŠ±é‡Œèƒ¡å“¨çš„åŠŸèƒ½ä¹Ÿå¿…ä¸å¯å°‘ï¼Œä¾‹å¦‚äº‹ä»¶è¿‡æ»¤ã€åŸå§‹äº‹ä»¶ã€ç»“æŸä½ç½®ã€äº‹ä»¶æ ¡éªŒã€JSON è¾“å‡ºç­‰ç­‰ã€‚åœ¨è§£æå™¨çš„åŸºç¡€ä¸Šï¼Œæˆ‘åŒæ—¶ç¼–å†™äº†ä¸€ä¸ª 2PC äº‹åŠ¡çš„åˆ†æå·¥å…·ï¼Œç”¨æ¥å®Œæˆæˆ‘ä¸€å¼€å§‹è®²çš„å¤‡ä»½æ¢å¤æ–¹æ¡ˆä¸­çš„ä¸€ä¸ªæ­¥éª¤ï¼ˆæ¯•ç«Ÿæˆ‘è¿˜æ˜¯è¦åƒé¥­çš„ï¼‰ã€‚æœ¬æ–‡ä¸»è¦æ˜¯ç®€å•è®°å½•äº†åœ¨å®ç°è¿™ä¸ªè§£æå™¨è¿‡ç¨‹ä¸­çš„ä¸€äº›æœ‰æ„æ€çš„æ€è€ƒå’Œå°è¯•ã€‚ä¸‹ä¸€ç¯‡åº”è¯¥ä¼šè®²è®²æˆ‘çš„åˆ†å¸ƒå¼å¤‡ä»½æ–¹æ¡ˆï¼Œå®Œå…¨æ— é”å“¦ï¼Œæ•¬è¯·æœŸå¾… ğŸ¥°ã€‚\nP.S. æ–¹æ¡ˆä¸“åˆ©åº”è¯¥å¿«ä¸‹æ¥äº†å§ï¼Œè¯·ä¸è¦å‘Šæˆ‘\u0026hellip;\nå‚è€ƒæ–‡çŒ® [1] https://dev.mysql.com/doc/dev/mysql-server/latest/page_protocol_replication.html#sect_protocol_replication_binlog_version_v4\n[2] https://github.com/polardb/polardbx-operator/tree/main/pkg/binlogtool\nBelow is the English version translated by the ChatGPT. Thanks for his great contribution!\nWhy do we need to reinvent the wheel? Building your own tools is the romance of programmers! ğŸ¥°\nWhen I was working for my previous employer, I designed a backup and recovery plan for distributed scenarios that required parsing and operating binlog. At the time, I wanted a clean tool without dependencies, so instead of using mature Java libraries, I implemented it in Go. During the implementation process, I tried some interesting approaches. In the end, it took me a week to complete the entire parsing part and support some interesting features such as fuzzy search just before leaving. This article mainly records some of my thoughts at that time and some interesting parts.\nThis article\u0026rsquo;s code is available on Github (https://github.com/polardb/polardbx-operator/tree/main/pkg/binlogtool). Thanks to my former colleagues for continuing to maintain it and eventually open sourcing it.\nBrief Introduction to Binlog Binlog is short for binary log, which usually refers to the binary logs implemented in MySQL. Binlog contains a series of events used to describe changes made to the database, such as creating tables, deleting tables, inserting/updating/deleting data and so on. In binlog, each event is encoded into a continuous segment of binary content that includes:\nFixed event header, which includes the event type, timestamp, event length and so on; Event body, the content and encoding method of which are different for each type of event. Binlog Event Header The job of the Binlog parser is to decode encoded events into objects that can be operated on in memory by a program. It\u0026rsquo;s worth noting that during the evolution of binlogs, several different versions have emerged: v1, v3, and v4. Version 2 was never officially released and can therefore be ignored[1].\nThere are many resources online that provide detailed information about binlogs, so we won\u0026rsquo;t go into further detail here. You can refer to the official documentation or other sources for more information.\nSome interesting attempts Generally speaking, a parser is a labor-intensive task. Especially for logs with stable encoding methods and almost fixed number of events like binlog, the best way to implement a parser is to hard-code a parsing function for each event, such as the implementation of the decoding function for ROWS_EVENT in go-mysql. This implementation has good performance but is very difficult to read. At the same time, because Go\u0026rsquo;s error handling approach is \u0026ldquo;simplest thing that could possibly work\u0026rdquo;, code written often contains if err != nil everywhere. Debugging binary encoding and decoding can be quite challenging too. In order to implement it as soon as possible, I had to consider some other methods.\nfunc (e *TableMapEvent) Decode(data []byte) error { // ... var err error var metaData []byte if metaData, _, n, err = LengthEncodedString(data[pos:]); err != nil { return errors.Trace(err) } if err = e.decodeMeta(metaData); err != nil { return errors.Trace(err) } pos += n // ... if err = e.decodeOptionalMeta(data[pos:]); err != nil { return err } return nil } Iterator Interface Compared to callback interfaces, I prefer iterator-style interfaces. Therefore, in my implementation, the interface looks like this:\ntype LogEventScanner interface { Next() (EventOffset, event.LogEvent, error) } Declarative Parser After my research, I found that although the entire coding method looks very complicated, most of it is a combination of fixed patterns. For example, the encoding for various integers is usually the same classic variable-length encoding, while the encoding for strings is likely to be one of the following methods:\nAn encoded integer represents its length, followed by corresponding bytes\nA byte string terminated with NUL\nSame as the first method but with a NUL termination\nObviously, these similar encoding methods can be turned into individual functions to call. However, using functions cannot avoid continuous and tedious error handling. In fact, at that time I was influenced by frameworks such as SwiftUI and had already thought of a way in my mind: it needs to decouple the declaration of event decoding methods from their decoding actions so that I can focus on adjusting event layout without worrying about error handling at the same time. Similarly, I implemented this type of parser as a declarative parser. Like SwiftUI and other frameworks, code written using this approach is very concise in simple scenarios and greatly improves readability.\nIn this approach, an Layout function is used to declare (define) an event\u0026rsquo;s parsing process. The reason why we use a function instead of an XxxLayout structure is because this approach isn\u0026rsquo;t flexible enough. Using closures can perfectly solve this problem; I can stuff all kinds of temporary states into closures and use closure features to pass them around everywhere. Here\u0026rsquo;s an example for QueryEvent:\ntype QueryEvent struct { ThreadID uint32 `json:\u0026#34;thread_id,omitempty\u0026#34;` ExecTime uint32 `json:\u0026#34;exec_time\u0026#34;` ErrorCode uint16 `json:\u0026#34;error_code\u0026#34;` Schema str.Str `json:\u0026#34;schema\u0026#34;` Query str.Str `json:\u0026#34;query\u0026#34;` StatusVars StatusVariables `json:\u0026#34;status_vars,omitempty\u0026#34;` } func (d *QueryEvent) Layout(version uint32, code byte, fde *FormatDescriptionEvent) *layout.Layout { var schemaLength uint8 var statusVarsLength uint16 return layout.Decl( // Post header layout.Number(\u0026amp;d.ThreadID), layout.Number(\u0026amp;d.ExecTime), layout.Number(\u0026amp;schemaLength), layout.Number(\u0026amp;d.ErrorCode), layout.If(version == spec.V4, layout.Number(\u0026amp;statusVarsLength)), // Payload layout.If(version == spec.V4, layout.Area(\u0026amp;statusVarsLength, func(data []byte) (int, error) { return int(statusVarsLength), d.StatusVars.parseStatusVarsBlock(data) })), layout.Bytes(\u0026amp;schemaLength, \u0026amp;d.Schema), layout.Null(), layout.Bytes(layout.Infinite(), \u0026amp;d.Query), ) } Believe that even if you don\u0026rsquo;t understand what layout.Number means now, you will soon understand that it refers to the layout of the encoded QUERY_EVENT.\nQUERY EVENT DATA From the layout.Number calling method, I believe you can already guess how this is implemented - it is a decoder that is bound to the int32 type variable \u0026amp;d.ThreadID. For different types, I have implemented different decoders in the layout package, which I call Field. Here is the implementation of Number:\ntype NumberField[N constraints.Integer | constraints.Float] struct { r *N } func (f NumberField[N]) FromBlock(data []byte) (int, error) { if err := checkDataSize(int(unsafe.Sizeof(N(0))), data); err != nil { return 0, err } utils.ReadNumberLittleEndianHack(f.r, data) return int(unsafe.Sizeof(N(0))), nil } func Number[N constraints.Integer | constraints.Float](r *N) NumberField[N] { return NumberField[N]{r: r} } In the end, I just followed the same pattern to support all event types. In this process, tedious function calls and error handling were no longer obstacles to my coding, but rather MySQL\u0026rsquo;s nasty encoding and lack of detailed documentation occasionally hindered my progress - most of the time, I had to flip through MySQL\u0026rsquo;s code to understand why it was encoded that way.\nCareful students may ask whether this approach will decode a bunch of Field objects for each event generated, which could have a significant impact on performance? You are right; it does affect performance. However, there is still a solution ğŸ¥µ. The nature of Binlog determines that its parsing process must be deterministic. This means that once you determine which log needs to be parsed, regardless of which event in the log needs decoding, the decoding process is always determined - this suggests caching the results for each event\u0026rsquo;s Layout. After completing most events\u0026rsquo; layout mapping work haphazardly (i.e., without much care), I implemented such a cache. For those who want more details about it can refer to binlog/cache.go.\nAfter the final test, the performance of parsing all fields in a single thread is about 200 MB/s. The test environment was MacBook Pro 13\u0026rsquo;\u0026rsquo; 2019 with Intel processor. In my opinion, this is completely sufficient since no one\u0026rsquo;s binlog can write at a speed of 200 MB (excluding large transactions). Please send me such a good disk for testing.\nFuzzy Probe Event Header With the parser, I can now create my own CLI tool (hehe ğŸ˜ƒ). If you have used mysqlbinlog to view binlogs before, you must have used the --start-position parameter to quickly jump to the beginning of an event. However, due to the streaming nature of binlogs, if you specify a position that is not an event header, mysqlbinlog cannot continue reading and will simply report an error :) Yes, it\u0026rsquo;s very frustrating. This means that I have to use another calculator to calculate the event position and then pass it on to mysqlbinlog. Every time this happens, I wish there was something that could help me find the next output event easily so that I could quickly binary search for what I want.\nIn theory, it is impossible to detect an event header from within a stream. But fortunately, in this case we are dealing with files and there happens to be redundant information left in each event header (event_length and next_position). While reading through the file we can easily determine our current position (current_position). Therefore it follows logically that: current_position + event_length = next_position. This is a very strong feature; if these conditions are met then there is high probability that this location represents a valid event header. Thus we decided on using this method! You can see how it was implemented here.\nWe also utilized some clever tricks like using ring buffers which helped reduce memory overheads significantly. Ultimately what we achieved was being able start searching from any arbitrary point - as long as there exists another subsequent valid events within our detection range!\nConclusion and Preview of Next Episode Of course, wheel makers will never be satisfied. Some fancy features are also essential, such as event filtering, raw events, end positions, event validation, JSON output and so on. Based on the parser, I also wrote an analysis tool for 2PC transactions to complete a step in the backup and recovery plan that I mentioned at the beginning (after all, I still need to eat). This article mainly records some interesting thoughts and attempts during the implementation of this parser. The next article should talk about my distributed backup plan which is completely lock-free. Stay tuned ğŸ¥°.\nP.S. The patent for this plan should be coming soon. Please don\u0026rsquo;t sue me\u0026hellip;\nReferences [1] https://dev.mysql.com/doc/dev/mysql-server/latest/page_protocol_replication.html#sect_protocol_replication_binlog_version_v4\n[2] https://github.com/polardb/polardbx-operator/tree/main/pkg/binlogtool\n","date":"2023-02-03T13:56:33+08:00","image":"https://blog.crazyark.me/p/yet-another-binlog-parser/img/cover_hue5491a8376b6bfd0d21ba4cd4ca85181_362715_120x120_fill_box_smart1_3.png","permalink":"https://blog.crazyark.me/p/yet-another-binlog-parser/","title":"åˆä¸€ä¸ª binlog è§£æå™¨ -- Yet Another Binlog Parser"},{"content":"è½¬è½½è‡ª Nathaniel J. Smith çš„ä¸€ç¯‡åšå®¢ï¼ŒåŸæ–‡æ˜¯ Timeouts and cancellation for humansï¼Œå‘è¡¨äº 2018 å¹´ 1 æœˆ 11 æ—¥ï¼ˆæ‰€ä»¥æ³¨æ„æ–‡ä¸­çš„é“¾æ¥å’Œå†…å®¹çš„æ—¶æ•ˆæ€§ï¼‰ï¼Œæœ¬æ–‡ä»…ä»…æ˜¯å¯¹åŸæ–‡çš„ä¸€ä¸ªç¿»è¯‘ã€‚\næ³¨ï¼šåŸæ¥è®¡åˆ’å†™ä¸€ç¯‡æ–‡ç« è®²è®²åœ¨ç½‘ç»œå’Œå¼‚æ­¥ç¼–ç¨‹ä¸­å¦‚ä½•è¿›è¡Œè¶…æ—¶å’Œå–æ¶ˆï¼Œä½† NJS çš„æ–‡ç« ç ç‰åœ¨å‰ï¼Œæˆ‘ä¹Ÿæ²¡æœ‰èƒ½åŠ›å†å†™ä¸€ç¯‡æ›´å¥½çš„æ–‡ç« äº†ï¼Œå› æ­¤é€‰æ‹©äº†ç›´æ¥è¿›è¡Œç¿»è¯‘ã€‚\nå¦å¤– DeepL æ‰¿æ‹…äº† 80% çš„ç¿»è¯‘å·¥ä½œï¼Œè€Œæˆ‘åªæ˜¯è¿›è¡Œäº†ä¸€äº›ç®€å•çš„æ ¡å¯¹å’Œæ¶¦è‰²ï¼Œåœ¨æ­¤å¯¹å®ƒçš„å“è¶Šè´¡çŒ®è¡¨ç¤ºæ„Ÿè°¢ ğŸ¤£ã€‚\næ‘†çƒ‚ åŸæ–‡ \u0026ndash; ä¸ºäººç±»è®¾è®¡çš„è¶…æ—¶ä¸å–æ¶ˆ ä½ çš„ä»£ç å¯èƒ½æ˜¯å®Œç¾çš„ï¼Œæ°¸è¿œä¹Ÿä¸ä¼šå¤±è´¥ï¼Œä½†ä¸å¹¸çš„æ˜¯ï¼Œå¤–é¢çš„ä¸–ç•Œå¾€å¾€å¹¶ä¸é‚£ä¹ˆå¯é ã€‚æœ‰æ—¶ï¼Œåˆ«äººçš„ä»£ç å´©æºƒæˆ–æ˜¯å¡æ­»äº†ï¼Œç½‘ç»œç˜«ç—ªäº†ï¼Œæˆ–æ˜¯æ‰“å°æœºç€ç«äº†ï¼ˆæ³¨ï¼šlp0 on fireï¼Œè¿™æ˜¯ä¸€ä¸ªå¤è€çš„ UNIX é”™è¯¯ä»£ç ï¼‰ã€‚ä½ çš„ä»£ç éœ€è¦å¯¹æ­¤åšå¥½å‡†å¤‡ï¼šæ¯å½“ä½ ä»ç½‘ç»œä¸Šè¯»å–ä¿¡æ¯æ—¶ï¼Œä¾‹å¦‚è·å–ä¸€æŠŠè¿›ç¨‹é—´çš„é”ï¼Œæˆ–æ˜¯å‘é€ä¸€ä¸ª HTTP è¯·æ±‚æ—¶ï¼Œä½ è‡³å°‘éœ€è¦è€ƒè™‘ä»¥ä¸‹ä¸‰ç§å¯èƒ½çš„æƒ…å†µï¼š\nå®ƒå¯èƒ½æˆåŠŸï¼› å®ƒå¯èƒ½å¤±è´¥ï¼› å®ƒå¯èƒ½ä¼šæ°¸è¿œæŒ‚åœ¨é‚£é‡Œï¼Œä»æœªæˆåŠŸæˆ–å¤±è´¥ï¼šæ—¥å­ä¸€å¤©å¤©è¿‡å»ï¼Œæ ‘å¶è½ä¸‹äº†ï¼Œå†¬å¤©æ¥äº†ï¼Œä½†æˆ‘ä»¬çš„è¯·æ±‚ä»ç„¶åœ¨ç­‰å¾…ï¼Œæ¸´æœ›ç€é‚£æ°¸è¿œä¸ä¼šåˆ°æ¥çš„å›åº”ã€‚ å‰ä¸¤ç§æƒ…å†µçš„å¤„ç†æ–¹å¼æ˜¯å¾ˆç›´æ¥çš„ã€‚ä½†æ˜¯ï¼Œä¸ºäº†å¤„ç†æœ€åä¸€ç§æƒ…å†µï¼Œä½ éœ€è¦è¶…æ—¶æœºåˆ¶ã€‚å‡ ä¹åœ¨ä½ çš„ç¨‹åºä¸å¦ä¸€ä¸ªç¨‹åºã€äººæˆ–ç³»ç»Ÿäº¤äº’çš„æ¯ä¸€ä¸ªåœ°æ–¹ï¼Œå®ƒéƒ½éœ€è¦ä¸€ä¸ªè¶…æ—¶ã€‚å¦‚æœä½ æ²¡æœ‰çš„è¯ï¼Œé‚£å°±æ˜¯ä¸€ä¸ªæ½œåœ¨çš„ç¼ºé™·ã€‚\nè¯´å®è¯ï¼Œå¦‚æœä½ å’Œå¤§å¤šæ•°å¼€å‘è€…ä¸€æ ·ï¼Œä½ çš„ä»£ç å¯èƒ½æœ‰å¤§é‡çš„ç”±è¶…æ—¶å¼•èµ·çš„é”™è¯¯ï¼Œå½“ç„¶æˆ‘çš„ä»£ç ä¹Ÿä¼šæœ‰ã€‚è¿™å¾ˆå¥‡æ€ª \u0026ndash; å› ä¸ºè¿™ç§éœ€æ±‚æ˜¯å¦‚æ­¤æ™®éï¼Œè€Œä¸”æ˜¯æ­£ç¡®è¿›è¡Œ I/O æ“ä½œçš„åŸºç¡€ï¼Œä½ ä¼šè®¤ä¸ºæ¯ä¸ªç¼–ç¨‹ç¯å¢ƒéƒ½æä¾›äº†ç®€å•è€Œå¼ºå¤§çš„æ–¹æ³•æ¥ä¸ºä»»ä½•æ“ä½œè®¾ç½®ä¸€ä¸ªè¶…æ—¶ã€‚ä½†æ˜¯\u0026hellip;\u0026hellip;å®ƒä»¬å¹¶æ²¡æœ‰ã€‚äº‹å®ä¸Šï¼Œå¤§å¤šæ•°è¶…æ—¶ API æ˜¯å¦‚æ­¤çš„ç¹çå’Œå®¹æ˜“å‡ºé”™ï¼Œä»¥è‡³äºå¯¹äºå¼€å‘è€…æ¥è¯´ï¼Œè¦å¯é åœ°å®Œæˆè¿™ä¸ªä»»åŠ¡æ˜¯ä¸ç°å®çš„ã€‚æ‰€ä»¥ä¸è¦æ„Ÿåˆ°éš¾è¿‡ \u0026ndash; ä½ çš„ä»£ç æœ‰é‚£äº›è¶…æ—¶çš„é”™è¯¯ä¸æ˜¯ä½ çš„é”™ï¼Œè€Œæ˜¯é‚£äº› I/O åº“çš„é”™ï¼\nä½†ç°åœ¨ï¼Œæˆ‘æ­£åœ¨å†™ä¸€ä¸ª I/O çš„åº“ã€‚è¿™ä¸æ˜¯ä¸€ä¸ªæ™®é€šçš„ I/O åº“ï¼Œè€Œæ˜¯ä¸€ä¸ªä»¥æ˜“äºä½¿ç”¨ä¸ºæ ¸å¿ƒå–ç‚¹çš„åº“ã€‚æ‰€ä»¥æˆ‘æƒ³ç¡®ä¿åœ¨æˆ‘çš„åº“ï¼ˆTrioï¼‰ä¸­ï¼Œä½ å¯ä»¥è½»æ¾å¯é åœ°å°†è¶…æ—¶åº”ç”¨äºä»»æ„çš„ I/O æ“ä½œã€‚ä½†è®¾è®¡ä¸€ä¸ªç”¨æˆ·å‹å¥½çš„è¶…æ—¶ API æ˜¯ä¸€é¡¹ä»¤äººæƒŠè®¶çš„æ£˜æ‰‹ä»»åŠ¡ï¼Œæ‰€ä»¥åœ¨è¿™ç¯‡åšæ–‡ä¸­ï¼Œæˆ‘å°†æ·±å…¥ç ”ç©¶å¯èƒ½çš„è®¾è®¡ï¼Œç‰¹åˆ«æ˜¯å¯å‘æˆ‘çš„è®¸å¤šå…ˆé©±è€…ï¼Œç„¶åè§£é‡Šæˆ‘æƒ³åˆ°çš„ä¸œè¥¿ï¼Œä»¥åŠä¸ºä»€ä¹ˆæˆ‘è®¤ä¸ºå®ƒæ˜¯å¯¹æ—§çš„æœ€å…ˆè¿›æŠ€æœ¯çš„çœŸæ­£æ”¹è¿›ã€‚æœ€åï¼Œæˆ‘å°†è®¨è®ºå¦‚ä½•æ›´å¹¿æ³›åœ°åº”ç”¨ Trio çš„æ€æƒ³ï¼Œç‰¹åˆ«æ˜¯å°†å±•ç¤ºä¸€ä¸ªç”¨äºè€å¼çš„åŒæ­¥çš„ Python ä»£ç çš„åŸå‹å®ç°ã€‚\né‚£ä¹ˆï¼Œè¶…æ—¶å¤„ç†åˆ°åº•éš¾åœ¨å“ªé‡Œï¼Ÿ\nç®€å•çš„è¶…æ—¶ä¸æ”¯æŒæŠ½è±¡ ğŸ˜¢ å¤„ç†è¶…æ—¶çš„æœ€ç®€å•çš„å’Œæœ€æ˜æ˜¾çš„æ–¹æ³•æ˜¯ï¼Œåœ¨ä½ çš„ API ä¸­æ‰¾åˆ°æ¯ä¸ªæ½œåœ¨çš„é˜»å¡çš„å‡½æ•°ï¼Œå¹¶ä¸ºå®ƒä»¬åŠ ä¸Šä¸€ä¸ªè¶…æ—¶ timeout å‚æ•°ã€‚åœ¨ Python æ ‡å‡†åº“ä¸­ï¼Œä½ ä¼šåœ¨è¯¸å¦‚ threading.Lock.acquire çš„ API ä¸­çœ‹åˆ°è¿™ä¸€ç‚¹ï¼š\nlock = threading.Lock() # Wait at most 10 seconds for the lock to become available lock.acquire(timeout=10) å¦‚æœä½ ä½¿ç”¨ socket æ¨¡å—æ¥è¿›è¡Œç½‘ç»œæ“ä½œï¼Œå®ƒçš„å·¥ä½œæ–¹å¼å’Œä¸Šé¢æ˜¯ä¸€æ ·çš„ \u0026ndash; é™¤äº†è¶…æ—¶å‚æ•° timeout æ˜¯è®¾ç½®åœ¨ socket å¯¹è±¡ä¸Šçš„ï¼Œè€Œä¸æ˜¯ä½œä¸ºå‚æ•°ä¼ é€’ç»™æ¯ä¸ªè°ƒç”¨ã€‚\nsock = socket.socket() # Set the timeout once sock.settimeout(10) # Wait at most 10 seconds to establish a connection to the remote host sock.connect(...) # Wait at most 10 seconds for data to arrive from the remote host sock.recv(...) è¿™æ¯”æ¯æ¬¡éƒ½è¦è®°å¾—ä¼ å…¥æ˜ç¡®çš„è¶…æ—¶è¦æ–¹ä¾¿ä¸€äº›ï¼ˆæˆ‘ä»¬å°†åœ¨ä¸‹æ–‡ä¸­æ›´å¤šåœ°è®¨è®ºæ–¹ä¾¿é—®é¢˜ï¼‰ï¼Œä½†é‡è¦çš„æ˜¯è¦ç†è§£è¿™åªæ˜¯ä¸€ä¸ªçº¯ç²¹çš„å¤–è§‚å˜åŒ–ã€‚å…¶è¯­ä¹‰ä¸æˆ‘ä»¬åœ¨ threading.Lock ä¸­çœ‹åˆ°çš„ä¸€æ ·ï¼šæ¯ä¸ªæ–¹æ³•çš„è°ƒç”¨éƒ½æœ‰è‡ªå·±ç‹¬ç«‹çš„ 10 ç§’è¶…æ—¶ã€‚\né‚£ä¹ˆè¿™æœ‰ä»€ä¹ˆé—®é¢˜å‘¢ï¼Ÿè¿™ä¼¼ä¹æ˜¯ä¸€ä¸ªå¾ˆæ˜¾ç„¶çš„æ–¹å¼ã€‚å¦‚æœæˆ‘ä»¬æ€»æ˜¯ç›´æ¥ä½¿ç”¨è¿™äº›ä½å±‚çš„ API æ¥ç¼–å†™ä»£ç ï¼Œé‚£ä¹ˆè¿™å¯èƒ½å°±è¶³å¤Ÿäº†ã€‚ä½†æ˜¯ï¼Œç¼–ç¨‹æ˜¯å…³äºæŠ½è±¡çš„ã€‚æ¯”å¦‚æˆ‘ä»¬æƒ³ä» S3 ä¸Šè·å–ä¸€ä¸ªæ–‡ä»¶ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ boto3 åº“ä¸­çš„è¿™ä¸ªæ¥å£ S3.Client.get_object æ¥å®Œæˆã€‚S3.Client.get_object åšäº†ä»€ä¹ˆå‘¢ï¼Ÿå®ƒå‘ S3 çš„æœåŠ¡å™¨å‘èµ·äº†ä¸€ç³»åˆ—çš„ HTTP è¯·æ±‚ï¼Œæ¯ä¸€ä¸ªè¯·æ±‚éƒ½è¦è°ƒç”¨ requests åº“ã€‚è€Œå¯¹ requests çš„æ¯ä¸€æ¬¡è°ƒç”¨éƒ½ä¼šåœ¨å†…éƒ¨è½¬åŒ–æˆå¯¹ sockets æ¨¡å—çš„ä¸€ç³»åˆ—çš„è°ƒç”¨ï¼Œä»è€Œå®ŒæˆçœŸæ­£çš„ç½‘ç»œé€šä¿¡[1]ã€‚\nä»ç”¨æˆ·çš„è§†è§’æ¥çœ‹ï¼Œè¿™æ˜¯ç”¨æ¥ä»è¿œç¨‹æœåŠ¡è·å–æ•°æ®çš„ä¸‰ä¸ªä¸åŒçš„ APIï¼š\ns3client.get_object(...) requests.get(\u0026#34;https://...\u0026#34;) sock.recv(...) å½“ç„¶å®ƒä»¬å¤„äºä¸åŒçš„æŠ½è±¡å±‚æ¬¡ï¼Œä½†æŠ½è±¡çš„æ ¸å¿ƒæ€æƒ³å°±æ˜¯å±è”½ç»†èŠ‚ï¼Œå› ä¸ºç”¨æˆ·ä¸å¿…å…³ç³»ç»†èŠ‚ã€‚å› æ­¤ï¼Œå¦‚æœæˆ‘ä»¬çš„è®¡åˆ’æ˜¯åœ¨æ‰€æœ‰åœ°æ–¹ä½¿ç”¨ timeout= å‚æ•°ï¼Œé‚£ä¹ˆæˆ‘ä»¬åº”è¯¥æœŸæœ›è¿™äº›å‡½æ•°éƒ½èƒ½æ¥å—ä¸€ä¸ª timeout= å‚æ•°ã€‚\ns3client.get_object(..., timeout=10) requests.get(\u0026#34;https://...\u0026#34;, timeout=10) sock.recv(..., timeout=10) ç°åœ¨é—®é¢˜æ¥äº†ï¼šå¦‚æœæˆ‘ä»¬æ˜¯è¿™æ ·åšçš„ï¼Œé‚£ä¹ˆå®é™…å®ç°è¿™äº›åŠŸèƒ½å°±æ˜¯ä¸€ä¸ªå¾ˆéº»çƒ¦çš„äº‹ã€‚ä¸ºä»€ä¹ˆå‘¢ï¼Ÿè®©æˆ‘ä»¬æ¥çœ‹ä¸€ä¸ªç®€åŒ–çš„ä¾‹å­ã€‚å½“å¤„ç† HTTP å“åº”æ—¶ï¼Œæœ‰ä¸€ç‚¹æ˜¯æˆ‘ä»¬å·²ç»çœ‹åˆ°äº† Content-Length å¤´ï¼Œé‚£ä¹ˆç°åœ¨æˆ‘ä»¬å°±éœ€è¦è¯»å–è¿™ä¹ˆå¤šçš„å­—èŠ‚æ¥è·å–å®é™…çš„å“åº”ä½“ã€‚å› æ­¤åœ¨ requests åº“ä¸­çš„æŸä¸ªåœ°æ–¹å­˜åœ¨ä¸€ä¸ªç±»ä¼¼è¿™æ ·çš„å¾ªç¯ï¼š\ndef read_body(sock, content_length): body = bytearray() while len(body) \u0026lt; content_length: max_to_receive = content_length - len(body) body += sock.recv(max_to_receive) assert len(body) == content_length return body ç°åœ¨æˆ‘ä»¬è¦ä¿®æ”¹è¿™ä¸ªå¾ªç¯ï¼Œå¢åŠ å¯¹è¶…æ—¶çš„æ”¯æŒã€‚æˆ‘ä»¬å¸Œæœ›èƒ½å¤Ÿè¯´ï¼šâ€œæˆ‘æ„¿æ„æœ€å¤šç­‰å¾… 10 ç§’æ¥è¯»å–å“åº”ä½“â€ã€‚ä½†æ˜¯æˆ‘ä»¬ä¸èƒ½åªæ˜¯æŠŠè¶…æ—¶å‚æ•°ä¼ é€’ç»™ recvï¼Œå› ä¸ºæƒ³è±¡ä¸€ä¸‹è¿™ç§æƒ…å†µï¼Œå‡è®¾ç¬¬ä¸€æ¬¡è°ƒç”¨ recv éœ€è¦ 6 ç§’ \u0026ndash; ä¸ºäº†ä½¿æˆ‘ä»¬çš„æ•´ä½“æ“ä½œèƒ½åœ¨ 10 ç§’å†…å®Œæˆï¼Œç¬¬äºŒæ¬¡è°ƒç”¨ recv å¿…é¡»è¢«èµ‹äºˆ 4 ç§’çš„è¶…æ—¶ã€‚ä½¿ç”¨ timeout= çš„æ–¹æ³•ï¼Œæ¯æ¬¡æˆ‘ä»¬åœ¨æŠ½è±¡å±‚ä¹‹é—´ä¼ é€’æ—¶éƒ½éœ€è¦å†™ä¸€äº›çƒ¦äººçš„åƒåœ¾ä»£ç æ¥é‡æ–°è®¡ç®—è¶…æ—¶ï¼š\ndef read_body(sock, content_length, timeout): + read_body_deadline = timeout + time.monotonic() body = bytearray() while len(body) \u0026lt; content_length: max_to_receive = content_length - len(body) + recv_timeout = read_body_deadline - time.monotonic() - body += sock.recv(max_to_receive) + body += sock.recv(max_to_receive, timeout=recv_timeout) assert len(body) == content_length return body ï¼ˆå³ä½¿æ˜¯è¿™æ ·ï¼Œå®é™…ä¸Šä¹Ÿæ˜¯ç®€åŒ–çš„ï¼Œå› ä¸ºæˆ‘ä»¬å‡è£… sock.recv éœ€è¦ä¸€ä¸ªè¶…æ—¶å‚æ•° \u0026ndash; å¦‚æœä½ æƒ³çœŸæ­£åšåˆ°è¿™ä¸€ç‚¹ï¼Œä½ å¿…é¡»åœ¨æ¯ä¸ª socket æ–¹æ³•ä¹‹å‰è°ƒç”¨ settimeoutï¼Œå¹¶ä¸”å¯èƒ½éœ€è¦ä½¿ç”¨ä¸€äº› try/finally çš„ä¸œè¥¿æ¥å°†å®ƒè®¾ç½®å›å»ï¼Œå¦åˆ™å°±æœ‰å¯èƒ½è®©ä½ ç¨‹åºçš„å…¶ä»–åœ°æ–¹å‡ºé”™ã€‚ï¼‰\nåœ¨å®è·µä¸­ï¼Œæ²¡æœ‰äººä¼šè¿™ä¹ˆåš \u0026ndash; æˆ‘æ‰€çŸ¥é“çš„æ‰€æœ‰æ¥å— timeout= å‚æ•°çš„é«˜å±‚ Python åº“éƒ½åªæ˜¯å°†å®ƒä»¬åŸå°ä¸åŠ¨åœ°ä¼ é€’ç»™ä¸‹å±‚ï¼Œè€Œè¿™ç ´åäº†æŠ½è±¡æ€§ã€‚ä¾‹å¦‚ï¼Œè¿™é‡Œæœ‰ä¸¤ä¸ªä½ ä»Šå¤©å¯èƒ½ä¼šç”¨åˆ°çš„æµè¡Œçš„ Python APIï¼Œå®ƒä»¬çœ‹èµ·æ¥éƒ½æ¥å—ç±»ä¼¼çš„ timeout= å‚æ•°ï¼š\nimport threading lock = threading.Lock() lock.acquire(timeout=10) import requests requests.get(\u0026#34;https://...\u0026#34;, timeout=10) ä½†äº‹å®ä¸Šï¼Œè¿™ä¸¤ä¸ª timeout= å‚æ•°çš„æ„æ€å®Œå…¨ä¸åŒã€‚ç¬¬ä¸€ä¸ªæ„å‘³ç€â€œå°è¯•è·å–é”ï¼Œä½† 10 ç§’ä»¥åæ”¾å¼ƒâ€ã€‚ç¬¬äºŒä¸ªæ„å‘³ç€â€œå°è¯•è·å–ç»™å®šçš„ URLï¼Œä½†å¦‚æœåœ¨ä»»ä½•æ—¶å€™ä»»ä½•å•ç‹¬çš„ä½ä»·å¥—æ¥å­—æ“ä½œè¶…è¿‡ 10 ç§’å°±æ”¾å¼ƒâ€ã€‚ä¹Ÿè®¸ä½ ä½¿ç”¨ requests çš„å…¨éƒ¨åŸå› æ˜¯ä½ ä¸æƒ³è€ƒè™‘ä½çº§å¥—æ¥å­—ï¼Œä½†å¯¹ä¸èµ·ï¼Œæ— è®ºå¦‚ä½•ä½ éƒ½å¿…é¡»è¿™æ ·åšã€‚äº‹å®ä¸Šï¼Œç›®å‰ä¸å¯èƒ½ä¿è¯ requests.get ä¼šåœ¨ä»»ä½•æœ‰é™çš„æ—¶é—´å†…è¿”å›ï¼šå¦‚æœä¸€ä¸ªæ¶æ„çš„æˆ–è¡Œä¸ºé”™è¯¯çš„æœåŠ¡ç«¯æ¯ 10 ç§’è‡³å°‘å‘é€ä¸€ä¸ªå­—èŠ‚ï¼Œé‚£ä¹ˆæˆ‘ä»¬ä¸Šé¢çš„ requests è°ƒç”¨å°†ä¸æ–­åœ°é‡ç½®å…¶è¶…æ—¶ï¼Œå¹¶ä¸”æ°¸è¿œä¸ä¼šè¿”å›ã€‚\næˆ‘å¹¶ä¸æ˜¯æƒ³åœ¨è¿™é‡ŒæŒ‘å‰” requests è¿™ä¸ªåº“ï¼Œå› ä¸ºè¿™ç±»é—®é¢˜åœ¨ Python çš„ API ä¸­éšå¤„å¯è§ã€‚æˆ‘ç”¨ requests ä½œä¸ºä¾‹å­æ˜¯å› ä¸º Kenneth Reitzï¼ˆæ³¨ï¼šrequests åº“ä½œè€…ï¼‰å› å…¶å¯¹ä½¿ API å°½å¯èƒ½æ˜æ˜¾å’Œç›´è§‚çš„æ‰§ç€è€Œé—»åï¼Œè€Œè¿™æ˜¯ä»–å°‘æœ‰çš„å¤±è´¥çš„åœ°æ–¹ä¹‹ä¸€ã€‚æˆ‘æƒ³è¿™æ˜¯ requests çš„ API ä¸­å”¯ä¸€ä¸€ä¸ªåœ¨æ–‡æ¡£ä¸­ç”¨å¤§æ–¹æ¡†è­¦å‘Šä½ å®ƒæ˜¯åç›´è§‰çš„éƒ¨åˆ†ã€‚æ‰€ä»¥\u0026hellip;\u0026hellip;å¦‚æœè¿ Kenneth Reitz éƒ½æä¸æ¸…æ¥šè¿™ä¸ªé—®é¢˜ï¼Œæˆ‘æƒ³æˆ‘ä»¬å¯ä»¥å¾—å‡ºè¿™æ ·çš„ç»“è®ºï¼šåªæ˜¯åœ¨ä¸Šé¢æ·»åŠ ä¸€ä¸ª timeout= å‚æ•°å¹¶ä¸èƒ½å¸¦æ¥ç¬¦åˆäººç±»çš„ç›´è§‰çš„ APIã€‚\nç»å¯¹çš„ deadline æ˜¯å¯è¡Œçš„ï¼ˆä½†å®ƒç”¨èµ·æ¥æœ‰ç‚¹çƒ¦äººğŸ˜¡ï¼‰ å¦‚æœ timeout= å‚æ•°ä¸èµ·ä½œç”¨ï¼Œæˆ‘ä»¬åº”è¯¥æ€ä¹ˆåšå‘¢ï¼Ÿå¥½å§ï¼Œè¿™é‡Œæœ‰ä¸€ä¸ªä¸€äº›äººæå€¡çš„é€‰æ‹©ã€‚æ³¨æ„åˆ°åœ¨æˆ‘ä»¬ä¸Šé¢çš„ read_body çš„ä¾‹å­ä¸­ï¼Œæˆ‘ä»¬æŠŠä¼ å…¥çš„ç›¸å¯¹è¶…æ—¶ï¼ˆâ€œä»æˆ‘è°ƒç”¨è¿™ä¸ªå‡½æ•°çš„é‚£ä¸€åˆ»èµ· 10 ç§’â€ï¼‰è½¬æ¢ä¸ºäº†ç»å¯¹æœŸé™ï¼ˆâ€œå½“æ—¶é’Ÿè¯»åˆ° 12:01:34:851 æ—¶â€ï¼‰ï¼Œç„¶ååœ¨æ¯æ¬¡è°ƒç”¨ socket ä¹‹å‰è½¬æ¢å›æ¥ã€‚å¦‚æœæˆ‘ä»¬ç”¨ deadline= å‚æ•°æ¥å†™æ•´ä¸ª APIï¼Œè€Œä¸æ˜¯ç”¨ timeout= å‚æ•°æ¥å†™ï¼Œè¿™æ®µä»£ç ä¼šå˜å¾—æ›´ç®€å•ã€‚è¿™å¯¹åº“çš„å®ç°è€…æ¥è¯´æ˜¯å¾ˆç®€å•çš„ï¼Œå› ä¸ºä½ å¯ä»¥ç›´æ¥æŠŠ deadline ä¼ åˆ°ä½ çš„æŠ½è±¡æ ˆä¸­ï¼š\ndef read_body(sock, content_length, deadline): body = bytearray() while len(body) \u0026lt; content_length: max_to_receive = content_length - len(body) body += sock.recv(max_to_receive, deadline=deadline) assert len(body) == content_length return body # Wait 10 seconds total for the response body to be downloaded deadline = time.monotonic() + 10 read_body(sock, content_length, deadline) ï¼ˆä¸€ä¸ªåƒè¿™æ ·å·¥ä½œçš„è‘—åçš„ API æ˜¯ Go çš„ socket å±‚ï¼‰ã€‚\nä½†è¿™ç§æ–¹æ³•ä¹Ÿæœ‰ä¸€ä¸ªç¼ºç‚¹ï¼šå®ƒæˆåŠŸåœ°å°†çƒ¦äººçš„éƒ¨åˆ†ä»åº“çš„å†…éƒ¨ç§»å‡ºï¼Œè€Œå°†å…¶æ”¾åœ¨ä½¿ç”¨ API çš„äººèº«ä¸Šã€‚åœ¨è®¾ç½®è¶…æ—¶ç­–ç•¥çš„æœ€å¤–å±‚ï¼Œä½ çš„åº“çš„ç”¨æˆ·å¯èƒ½æƒ³è¯´â€œ10ç§’ä¹‹åæ”¾å¼ƒâ€ä¹‹ç±»çš„è¯ï¼Œå¦‚æœä½ åªæ¥å—ä¸€ä¸ª deadline= å‚æ•°ï¼Œé‚£ä¹ˆä»–ä»¬æ¯æ¬¡éƒ½å¿…é¡»æ‰‹å·¥è¿›è¡Œè½¬æ¢ã€‚æˆ–è€…ä½ å¯ä»¥è®©æ¯ä¸ªå‡½æ•°éƒ½åŒæ—¶æ¥å— timeout= å’Œ deadline= å‚æ•°ï¼Œä½†æ˜¯ä½ éœ€è¦åœ¨æ¯ä¸ªå‡½æ•°ä¸­åŠ å…¥ä¸€äº›æ¨¡æ¿ä»£ç æ¥è§„èŒƒå®ƒä»¬ï¼Œåœ¨ä¸¤ä¸ªå‚æ•°éƒ½æŒ‡å®šçš„æ—¶å€™æŠ›å‡ºä¸€ä¸ªé”™è¯¯ï¼Œç­‰ç­‰ã€‚æœ€åæœŸé™æ˜¯å¯¹åŸå§‹è¶…æ—¶çš„ä¸€ç§æ”¹è¿›ï¼Œä½†æ„Ÿè§‰ä¸Šå»è¿™é‡Œä»ç„¶ç¼ºå°‘äº†ä¸€äº›æŠ½è±¡ã€‚\nå–æ¶ˆä»¤ç‰Œï¼ˆcancel tokensï¼‰ å–æ¶ˆä»¤ç‰Œå°è£…äº†å–æ¶ˆçŠ¶æ€ è¿™é‡Œæœ‰ä¸€ä¸ªç¼ºå¤±çš„æŠ½è±¡ï¼šä¸å…¶æ”¯æŒä¸¤ä¸ªä¸åŒçš„å‚æ•°ï¼š\n# What users do: requests.get(..., timeout=...) # What libraries do: requests.get(..., deadline=...) # How we implement it: def get(..., deadline=None, timeout=None): deadline = normalize_deadline(deadline, timeout) ... æˆ‘ä»¬å¯ä»¥ç”¨ä¸€ä¸ªæ–¹ä¾¿çš„æ„é€ å‡½æ•°å°†è¶…æ—¶ä¿¡æ¯å°è£…åˆ°ä¸€ä¸ªå¯¹è±¡ä¸­ï¼š\nclass Deadline: def __init__(self, deadline): self.deadline = deadline def after(timeout): return Deadline(time.monotonic() + timeout) # Wait 10 seconds total for the URL to be fetched requests.get(\u0026#34;https://...\u0026#34;, deadline=after(10)) è¿™å¯¹ç”¨æˆ·æ¥è¯´çœ‹èµ·æ¥å¾ˆè‡ªç„¶ï¼Œä½†ç”±äºå®ƒåœ¨å†…éƒ¨ä½¿ç”¨äº†ä¸€ä¸ªç»å¯¹çš„ deadlineï¼Œæ‰€ä»¥å¯¹åº“çš„å®ç°è€…æ¥è¯´ä¹Ÿå¾ˆå®¹æ˜“ã€‚\nä¸€æ—¦æˆ‘ä»¬èµ°åˆ°è¿™ä¸€æ­¥ï¼Œæˆ‘ä»¬ä¸å¦¨è®©å®ƒå˜å¾—æ›´æŠ½è±¡ä¸€äº›ã€‚æ¯•ç«Ÿï¼Œè¶…æ—¶å¹¶ä¸æ˜¯ä½ æƒ³æ”¾å¼ƒæŸäº›é˜»å¡æ“ä½œçš„å”¯ä¸€åŸå› ã€‚â€œ10 ç§’åæ”¾å¼ƒâ€åªæ˜¯â€œåœ¨\u0026lt;æŸä¸ªä»»æ„æ¡ä»¶ä¸ºçœŸ\u0026gt;åæ”¾å¼ƒâ€çš„ä¸€ä¸ªç‰¹ä¾‹ã€‚å‡è®¾ä½ æ­£åœ¨ä½¿ç”¨ requests åº“å®ç°ä¸€ä¸ªç½‘ç»œæµè§ˆå™¨ï¼Œä½ ä¼šå¸Œæœ›èƒ½å¤Ÿè¯´â€œå¼€å§‹è·å–è¿™ä¸ª URLï¼Œä½†åœ¨â€˜åœæ­¢â€™æŒ‰é’®è¢«æŒ‰ä¸‹æ—¶æ”¾å¼ƒâ€ã€‚åœ¨ä»»ä½•æƒ…å†µä¸‹ï¼Œåº“éƒ½ä¼šæŠŠè¿™ä¸ª Deadline å¯¹è±¡è§†ä¸ºå®Œå…¨ä¸é€æ˜çš„ \u0026ndash; å®ƒä»¬åªæ˜¯æŠŠå®ƒä¼ é€’ç»™ä½å±‚çš„è°ƒç”¨ï¼Œå¹¶ç›¸ä¿¡æœ€ç»ˆä¸€äº›åº•å±‚çš„æ“ä½œåŸè¯­ä¼šé€‚å½“åœ°è§£é‡Šå®ƒã€‚å› æ­¤ï¼Œä¸å…¶è®¤ä¸ºè¿™ä¸ªå¯¹è±¡å°è£…äº†ä¸€ä¸ªæœ€åæœŸé™ï¼Œæˆ‘ä»¬ä¸å¦‚å¼€å§‹è®¤ä¸ºå®ƒå°è£…äº†ä¸€ä¸ªä»»æ„çš„â€œæˆ‘ä»¬ç°åœ¨åº”è¯¥æ”¾å¼ƒå—â€çš„æ£€æŸ¥ã€‚ä¸ºäº†ä½“ç°å®ƒæ›´æŠ½è±¡çš„æ€§è´¨ï¼Œä¸å…¶å°†å®ƒç§°ä½œ Deadlineï¼Œè®©æˆ‘ä»¬ç§°è¿™ä¸ªæ–°ä¸œè¥¿ ä¸º CancelTokenã€‚\n# This library is only hypothetical, sorry from cancel_tokens import cancel_after, cancel_on_callback # Returns an opaque CancelToken object that enters the \u0026#34;cancelled\u0026#34; # state after 10 seconds. cancel_token = cancel_after(10) # So this request gives up after 10 seconds requests.get(\u0026#34;https://...\u0026#34;, cancel_token=cancel_token) # Returns an opaque CancelToken object that enters the \u0026#34;cancelled\u0026#34; # state when the given callback is called. cancel_callback, cancel_token = cancel_on_callback() # Arrange for the callback to be called if someone clicks \u0026#34;stop\u0026#34; stop_button.on_press = cancel_callback # So this request gives up if someone clicks \u0026#39;stop\u0026#39; requests.get(\u0026#34;https://...\u0026#34;, cancel_token=cancel_token) å°†å–æ¶ˆæ¡ä»¶æå‡ä¸ºä¸€çº§å¯¹è±¡ï¼ˆæ³¨ï¼šfirst-class objectï¼‰ä½¿æˆ‘ä»¬çš„è¶…æ—¶ API æ›´å®¹æ˜“ä½¿ç”¨ï¼ŒåŒæ—¶ä¹Ÿä½¿å…¶åŠŸèƒ½å¤§å¤§å¢å¼ºï¼šç°åœ¨æˆ‘ä»¬ä¸ä»…å¯ä»¥å¤„ç†è¶…æ—¶ï¼Œè¿˜å¯ä»¥å¤„ç†ä»»æ„çš„å–æ¶ˆï¼Œè¿™æ˜¯ç¼–å†™å¹¶å‘ä»£ç æ—¶éå¸¸å¸¸è§çš„éœ€æ±‚ï¼ˆä¾‹å¦‚ï¼Œå®ƒå¯ä»¥è®©æˆ‘ä»¬è¡¨è¾¾è¿™æ ·çš„ä¸œè¥¿ï¼šå¹¶è¡Œå‘èµ·å†—ä½™çš„ä¸¤ä¸ªè¯·æ±‚ï¼Œä¸€æ—¦å…¶ä¸­ä¸€ä¸ªè¯·æ±‚å®Œæˆï¼Œå°±å–æ¶ˆå¦ä¸€ä¸ªï¼‰ã€‚è¿™æ˜¯ä¸€ä¸ªéå¸¸æ£’çš„ä¸»æ„ã€‚æ®æˆ‘æ‰€çŸ¥ï¼Œå®ƒæœ€åˆæ¥è‡ªäº Joe Duffy åœ¨ C# ä¸­æå‡ºçš„ å–æ¶ˆä»¤ç‰Œï¼Œåœ¨ Go è¯­è¨€ä¸­çš„ context å¯¹è±¡ æœ¬è´¨ä¸Šä¹Ÿæ˜¯åŒæ ·çš„æƒ³æ³•ã€‚è¿™äº›äººï¼ˆæ³¨ï¼šAPI çš„è®¾è®¡è€…ï¼‰éƒ½éå¸¸èªæ˜ï¼äº‹å®ä¸Šï¼Œå–æ¶ˆä»¤ç‰Œè¿˜è§£å†³äº†å…¶ä»–ä¸€äº›åœ¨ä¼ ç»Ÿå–æ¶ˆç³»ç»Ÿä¸­å‡ºç°çš„é—®é¢˜ã€‚\nå–æ¶ˆä»¤ç‰Œæ˜¯æ°´å¹³è§¦å‘çš„ï¼Œå¯ä»¥æ ¹æ®ä½ çš„ç¨‹åºéœ€è¦æ¥ç¡®å®šèŒƒå›´ åœ¨æˆ‘ä»¬å¯¹è¶…æ—¶å’Œå–æ¶ˆçš„ API çš„å°å°è€ƒå¯Ÿä¸­ï¼Œæˆ‘ä»¬æ˜¯ä»è¶…æ—¶å¼€å§‹çš„ã€‚å¦‚æœä½ æ˜¯ä»å–æ¶ˆå¼€å§‹çš„ï¼Œé‚£ä¹ˆä½ å°†ä¼šçœ‹åˆ°å¦ä¸€ä¸ªåœ¨å¾ˆå¤šç³»ç»Ÿä¸­å¸¸è§çš„æ¨¡å¼ï¼šä¸€ä¸ªæ–¹æ³•å¯ä»¥è®©ä½ å–æ¶ˆå¦ä¸€ä¸ªçº¿ç¨‹ï¼ˆæˆ–ä»»åŠ¡ï¼Œæˆ–ä»»ä½•ä½ çš„æ¡†æ¶ä½¿ç”¨çš„çº¿ç¨‹ç­‰åŒç‰©ï¼‰ï¼Œé€šè¿‡å”¤é†’å®ƒå¹¶æŠ›å‡ºæŸç§å¼‚å¸¸ã€‚ä¾‹å­åŒ…æ‹¬ asyncio çš„ Task.cancelã€Curio çš„ Task.cancelã€Java çš„ Thread.interruptã€C# çš„ Thread.interruptï¼Œç­‰ç­‰ã€‚ä¸ºäº†ä½“ç°å®ƒä»¬çš„æ€§è´¨ï¼Œæˆ‘æŠŠè¿™ç§°ä¸ºâ€œçº¿ç¨‹ä¸­æ–­â€çš„å–æ¶ˆæ–¹æ³•ã€‚\nåœ¨çº¿ç¨‹ä¸­æ–­æ–¹æ³•ä¸­ï¼Œå–æ¶ˆæ˜¯ä¸€ä¸ªé’ˆå¯¹å›ºå®šè§„æ¨¡å®ä½“çš„æ—¶é—´ç‚¹äº‹ä»¶ï¼šä¸€ä¸ªè°ƒç”¨ â†’ ä¸€ä¸ªçº¿ç¨‹/ä»»åŠ¡ä¸­çš„å¼‚å¸¸ã€‚è¿™é‡Œæœ‰ä¸¤ä¸ªé—®é¢˜ã€‚\né¦–å…ˆï¼Œæ‰©å±•æ€§çš„é—®é¢˜æ˜¯å¾ˆæ˜æ˜¾çš„ï¼šå¦‚æœä½ æœ‰ä¸€ä¸ªæ­£å¸¸è°ƒç”¨çš„å•ä¸€å‡½æ•°ï¼Œä½†ä½ å¯èƒ½éœ€è¦å–æ¶ˆå®ƒï¼Œé‚£ä¹ˆä½ å°±å¿…é¡»ä¸ºå®ƒç”Ÿæˆä¸€ä¸ªæ–°çš„çº¿ç¨‹/ä»»åŠ¡/å…¶ä»–ç›¸åº”çš„å®ä½“ï¼š\nhttp_thread = spawn_new_thread(requests.get, \u0026#34;https://...\u0026#34;) # Arrange that http_thread.interrupt() will be called if someone # clicks the stop button stop_button.on_click = http_thread.interrupt try: http_response = http_thread.wait_for_result() except Interrupted: ... åœ¨è¿™é‡Œï¼Œçº¿ç¨‹å¹¶æ²¡æœ‰è¢«ç”¨äºå¹¶å‘ï¼Œå®ƒåªæ˜¯ä¸€ç§è®©ä½ é™å®šå–æ¶ˆä½œç”¨åŸŸçš„æ–¹å¼ï¼Œè¿™ç›¸å½“çš„ç¬¨æ‹™ã€‚\næˆ–è€…ï¼Œå¦‚æœä½ æœ‰ä¸€ä¸ªå¤§çš„å¤æ‚çš„å·¥ä½œæƒ³å–æ¶ˆ \u0026ndash; ä¾‹å¦‚ï¼Œåœ¨å†…éƒ¨äº§ç”Ÿäº†å¤šä¸ªå·¥ä½œçº¿ç¨‹çš„ä¸œè¥¿ï¼Ÿåœ¨æˆ‘ä»¬ä¸Šé¢çš„ä¾‹å­ä¸­ï¼Œå¦‚æœ requests.get å‚¬ç”Ÿäº†ä¸€äº›é¢å¤–çš„åå°çº¿ç¨‹ï¼Œå½“æˆ‘ä»¬å–æ¶ˆç¬¬ä¸€ä¸ªçº¿ç¨‹æ—¶ï¼Œå®ƒä»¬ä¿æŒè¢«æŒ‚èµ·çš„çŠ¶æ€ä¸€ç›´ç•™åœ¨é‚£ã€‚æ­£ç¡®å¤„ç†è¿™ä¸ªé—®é¢˜éœ€è¦ä¸€äº›å¤æ‚è€Œå¾®å¦™çš„è®°å½•ã€‚\nå–æ¶ˆä»¤ç‰Œè§£å†³äº†è¿™ä¸ªé—®é¢˜ï¼šå®ƒä»¬å–æ¶ˆçš„å·¥ä½œæ˜¯â€œä»¤ç‰Œè¢«ä¼ é€’åˆ°çš„ä»»ä½•ä¸œè¥¿â€ï¼Œè¿™å¯èƒ½æ˜¯ä¸€ä¸ªå•ä¸€çš„å‡½æ•°ï¼Œæˆ–è€…æ˜¯ä¸€ä¸ªå¤æ‚çš„å¤šå±‚çº¿ç¨‹æ± é›†åˆï¼Œæˆ–è€…æ˜¯ä»‹äºä¸¤è€…ä¹‹é—´çš„ä»»ä½•ä¸œè¥¿ã€‚\nçº¿ç¨‹ä¸­æ–­æ–¹æ³•çš„å¦ä¸€ä¸ªé—®é¢˜æ›´ä¸ºå¾®å¦™ï¼šå®ƒå°†å–æ¶ˆè§†ä¸ºä¸€ä¸ªäº‹ä»¶ã€‚ç›¸å¯¹çš„ï¼Œå–æ¶ˆä»¤ç‰Œçš„æ¨¡å‹åˆ™æ˜¯å°†å–æ¶ˆä½œä¸ºä¸€ç§çŠ¶æ€ï¼šå®ƒä»¬ä»æœªå–æ¶ˆçš„çŠ¶æ€å¼€å§‹ï¼Œæœ€ç»ˆè½¬å˜åˆ°å·²å–æ¶ˆçš„çŠ¶æ€ã€‚\nè¿™å¾ˆå¾®å¦™ï¼Œä½†å®ƒä½¿å–æ¶ˆä»¤ç‰Œä¸é‚£ä¹ˆå®¹æ˜“å‡ºé”™ã€‚ä¸€ç§æ€è€ƒè¿™ä¸ªé—®é¢˜çš„æ–¹å¼æ˜¯è€ƒè™‘è¾¹ç¼˜è§¦å‘å’Œæ°´å¹³è§¦å‘çš„åŒºåˆ«ï¼šçº¿ç¨‹ä¸­æ–­ API æä¾›è¾¹ç¼˜è§¦å‘çš„å–æ¶ˆé€šçŸ¥ï¼Œç›¸æ¯”ä¹‹ä¸‹ï¼Œå–æ¶ˆä»¤ç‰Œæä¾›çš„åˆ™æ˜¯æ°´å¹³è§¦å‘çš„ã€‚è¾¹ç¼˜è§¦å‘çš„ API åœ¨ä½¿ç”¨ä¸Šæ˜¯å‡ºäº†åçš„æ£˜æ‰‹ã€‚ä½ å¯ä»¥åœ¨ Python çš„ threading.Event ä¸­çœ‹åˆ°ä¸€ä¸ªä¾‹å­ï¼šå°½ç®¡å®ƒè¢«ç§°ä¸ºâ€œäº‹ä»¶â€ï¼Œä½†å®ƒå®é™…ä¸Šæœ‰ä¸€ä¸ªå†…éƒ¨çš„å¸ƒå°”çŠ¶æ€ï¼Œè€Œå–æ¶ˆä¸€ä¸ªå–æ¶ˆä»¤ç‰Œåˆ™åƒæ˜¯è®¾ç½®ä¸€ä¸ªäº‹ä»¶ã€‚\nè¿™äº›éƒ½æ˜¯ç›¸å½“æŠ½è±¡çš„ï¼Œæ‰€ä»¥è®©æˆ‘ä»¬æŠŠå®ƒä»¬å˜å¾—æ›´å…·ä½“ä¸€ç‚¹ã€‚æ€è€ƒä¸€ä¸‹ï¼Œtry/finally çš„å¸¸è§çš„ä½¿ç”¨æ¨¡å¼æ˜¯ç¡®ä¿è¿æ¥èƒ½å¤Ÿè¢«æ­£ç¡®åœ°å…³é—­ã€‚è¿™é‡Œæœ‰ä¸€ä¸ªç›¸å½“äººæ€§åŒ–çš„ä¾‹å­ï¼Œè¯¥å‡½æ•°å»ºç«‹äº†ä¸€ä¸ª Websocket è¿æ¥ï¼Œå‘é€äº†ä¸€æ¡æ¶ˆæ¯ï¼Œç„¶åæ— è®º send_message æ˜¯å¦æŠ›å‡ºäº†å¼‚å¸¸éƒ½ç¡®ä¿å…³é—­å®ƒï¼š\ndef send_websocket_messages(url, messages): open_websocket_connection(url) try: for message in messages: ws.send_message(message) finally: ws.close() ç°åœ¨ï¼Œå‡è®¾æˆ‘ä»¬å¼€å§‹è¿è¡Œè¿™ä¸ªå‡½æ•°ï¼Œä½†åœ¨æŸä¸€ä¸ªæ—¶åˆ»å¦ä¸€æ–¹é€€å‡ºäº†ç½‘ç»œï¼Œæ­¤æ—¶æˆ‘ä»¬çš„ send_message è°ƒç”¨å°†æ°¸è¿œæŒ‚èµ·ã€‚æœ€ç»ˆï¼Œæˆ‘ä»¬åŒå€¦äº†ç­‰å¾…ï¼Œå¹¶å–æ¶ˆäº†å®ƒã€‚\né€šè¿‡ä¸€ä¸ªçº¿ç¨‹ä¸­æ–­å¼çš„è¾¹ç¼˜è§¦å‘ APIï¼Œè¿™å°†å¯¼è‡´ send_message è°ƒç”¨ç«‹åˆ»å¼•å‘ä¸€ä¸ªå¼‚å¸¸ï¼Œç„¶åæˆ‘ä»¬çš„è¿æ¥æ¸…ç†ä»£ç è‡ªåŠ¨è¿è¡Œï¼Œåˆ°ç›®å‰ä¸ºæ­¢çœ‹èµ·æ¥è¿˜ä¸é”™ã€‚ä½†å…³äº websocket åè®®ï¼Œæœ‰ä¸€ä¸ªæœ‰è¶£çš„äº‹å®ï¼šå®ƒæœ‰ä¸€ä¸ªâ€œå…³é—­â€æ¶ˆæ¯ï¼Œä½ åº”è¯¥åœ¨å…³é—­è¿æ¥ä¹‹å‰å‘é€ã€‚ä¸€èˆ¬æ¥è¯´ï¼Œè¿™æ˜¯ä»¶å¥½äº‹ï¼šå®ƒå¯ä»¥ä½¿å…³é—­æ›´å¹²å‡€ã€‚å› æ­¤ï¼Œå½“æˆ‘ä»¬è°ƒç”¨ ws.close() æ—¶ï¼Œå®ƒå°†å°è¯•å‘é€è¿™ä¸ªæ¶ˆæ¯ã€‚ä½†æ˜¯ï¼Œåœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬è¯•å›¾å…³é—­è¿æ¥çš„åŸå› æ˜¯æˆ‘ä»¬å·²ç»æ”¾å¼ƒäº†å¦ä¸€æ–¹æ¥å—ä»»ä½•æ–°çš„æ¶ˆæ¯ã€‚æ‰€ä»¥ç°åœ¨ ws.close() ä¹Ÿå°†æ°¸è¿œæŒ‚èµ·ã€‚\nå¦‚æœæˆ‘ä»¬ä½¿ç”¨ä¸€ä¸ªå–æ¶ˆä»¤ç‰Œï¼Œè¿™ç§æƒ…å†µå°±ä¸ä¼šå‘ç”Ÿï¼š\ndef send_websocket_messages(url, messages, cancel_token): open_websocket_connection(url, cancel_token=cancel_token) try: for message in messages: ws.send_message(message, cancel_token=cancel_token) finally: ws.close(cancel_token=cancel_token) ä¸€æ—¦å–æ¶ˆä»¤ç‰Œè¢«è§¦å‘ï¼Œé‚£ä¹ˆæœªæ¥å¯¹è¯¥ä»¤ç‰Œçš„æ‰€æœ‰æ“ä½œéƒ½ä¼šè¢«å–æ¶ˆï¼Œæ‰€ä»¥å¯¹ ws.close çš„è°ƒç”¨å°±ä¸ä¼šè¢«å¡ä½ã€‚è¿™æ˜¯ä¸€ä¸ªæ›´ä¸å®¹æ˜“å‡ºé”™çš„èŒƒå¼ã€‚\næœ‰æ„æ€çš„æ˜¯ï¼Œè¿™ä¹ˆå¤šè€çš„ API éƒ½ä¼šçŠ¯è¿™ä¸ªé”™è¯¯ã€‚å¦‚æœä½ æŒ‰ç…§æˆ‘ä»¬åœ¨è¿™ç¯‡åšæ–‡ä¸­çš„åšæ³•ï¼Œä»è€ƒè™‘ä¸€ä¸ªç”±å¤šä¸ªé˜»å¡è°ƒç”¨ç»„æˆçš„å¤æ‚æ“ä½œåº”ç”¨è¶…æ—¶å¼€å§‹ï¼Œé‚£ä¹ˆå¾ˆæ˜æ˜¾ï¼Œå¦‚æœç¬¬ä¸€ä¸ªè°ƒç”¨ç”¨å®Œäº†æ•´ä¸ªè¶…æ—¶é¢„ç®—ï¼Œé‚£ä¹ˆä»¥åçš„è°ƒç”¨åº”è¯¥ç«‹å³å¤±è´¥ã€‚è¶…æ—¶æ˜¯å¾ˆè‡ªç„¶åœ°æ°´å¹³è§¦å‘çš„ã€‚ç„¶åå½“æˆ‘ä»¬ä»è¶…æ—¶æ‰©å±•åˆ°ä»»æ„çš„å–æ¶ˆæ—¶ï¼Œè¿™ä¸ªæ´å¯Ÿä¾ç„¶ä¿æŒã€‚ä½†æ˜¯å¦‚æœä½ åªè€ƒè™‘åŸå§‹æ“ä½œçš„è¶…æ—¶ï¼Œé‚£ä¹ˆè¿™ä¸€ç‚¹å°±ä¸ä¼šå‡ºç°ï¼›æˆ–è€…å¦‚æœä½ ä»ä¸€ä¸ªé€šç”¨çš„å–æ¶ˆ API å¼€å§‹ï¼Œç„¶åç”¨å®ƒæ¥å®ç°è¶…æ—¶ï¼ˆæ¯”å¦‚ Twisted å’Œ asyncio åšçš„ï¼‰ï¼Œé‚£ä¹ˆæ°´å¹³è§¦å‘çš„å–æ¶ˆçš„ä¼˜åŠ¿å°±å¾ˆå®¹æ˜“è¢«å¿½ç•¥ã€‚\nå–æ¶ˆä»¤ç‰Œåœ¨å®è·µä¸­æ˜¯ä¸å¯é çš„ï¼Œå› ä¸ºäººéƒ½æ˜¯æ‡’æƒ°çš„ æ‰€ä»¥ï¼Œå–æ¶ˆä»¤ç‰Œæœ‰ç€éå¸¸å¥½çš„è¯­ä¹‰ï¼Œæ˜¾ç„¶æ¯”åŸå§‹è¶…æ—¶æˆ– deadline è¦å¥½çš„å¤šï¼Œä½†å®ƒä»¬ä»ç„¶æœ‰ä¸€ä¸ªå¯ç”¨æ€§é—®é¢˜ï¼šè¦å†™ä¸€ä¸ªæ”¯æŒå–æ¶ˆçš„å‡½æ•°ï¼Œä½ å¿…é¡»æ¥å—è¿™ä¸ªæ¨¡æ¿å‚æ•°ï¼Œç„¶åç¡®ä¿æŠŠå®ƒä¼ é€’ç»™ä½ è°ƒç”¨çš„æ¯ä¸ªå­ç¨‹åºã€‚è®°ä½ï¼Œä¸€ä¸ªæ­£ç¡®çš„ã€å¥å£®çš„ç¨‹åºå¿…é¡»åœ¨å †æ ˆçš„ä»»ä½•åœ°æ–¹ï¼Œåœ¨æ¯ä¸€ä¸ªåš I/O çš„å‡½æ•°ä¸­æ”¯æŒå–æ¶ˆã€‚å¦‚æœä½ å·æ‡’ï¼ŒæŠŠå®ƒæ¼æ‰äº†ï¼Œæˆ–è€…å¿˜è®°æŠŠå®ƒä¼ é€’ç»™ä»»ä½•ç‰¹å®šçš„å­ç¨‹åºè°ƒç”¨ï¼Œé‚£ä¹ˆä½ å°±æœ‰ä¸€ä¸ªæ½œåœ¨çš„ç¼ºé™·ã€‚\näººç±»å¾ˆä¸æ“…é•¿è¿™ç§æ¨¡æ¿ã€‚æˆ‘çš„æ„æ€æ˜¯ï¼Œä¸æ˜¯è¯´ä½ ï¼Œæˆ‘ç›¸ä¿¡ä½ æ˜¯ä¸€ä¸ªéå¸¸å‹¤å¥‹çš„ç¨‹åºå‘˜ï¼Œç¡®ä¿åœ¨æ¯ä¸ªå‡½æ•°ä¸­å®ç°æ­£ç¡®çš„å–æ¶ˆæ”¯æŒï¼Œè€Œä¸”æ¯å¤©éƒ½ä¼šä½¿ç”¨ç‰™çº¿ï¼ˆæ³¨ï¼šflosses every dayï¼Œä¸æ˜¯å¾ˆæ‡‚å•¥æ¢—ï¼‰ã€‚ä½†æ˜¯\u0026hellip;\u0026hellip;ä¹Ÿè®¸ä½ çš„ä¸€äº›åŒäº‹å°±æ²¡æœ‰è¿™ä¹ˆå‹¤å¥‹äº†ï¼Ÿæˆ–è€…ä½ ä¾èµ–åˆ«äººå†™çš„ä¸€äº›åº“ \u0026ndash; ä½ æœ‰å¤šä¿¡ä»»ä½ çš„ç¬¬ä¸‰æ–¹ä¾›åº”å•†èƒ½åšå¥½è¿™ä»¶äº‹ï¼Ÿéšç€ä½ çš„å·¥ä½œæ ˆçš„å¢é•¿ï¼Œæ¯ä¸ªäººéƒ½èƒ½åšåˆ°è¿™ä¸€ç‚¹çš„å¯èƒ½æ€§è¶‹è¿‘äºé›¶ã€‚\næˆ‘å¯ä»¥ç”¨ä»»ä½•çœŸå®çš„ä¾‹å­æ¥è¯æ˜è¿™ä¸€ç‚¹å—ï¼Ÿå¥½å§ï¼Œè€ƒè™‘ä¸€ä¸‹ï¼šåœ¨ C# å’Œ Go è¿™ä¸¤ç§æœ€è‘—åçš„è¯­è¨€ä¸­ï¼Œä½¿ç”¨è¿™ç§æ–¹æ³•å¹¶ä¸”å·²ç»æå€¡äº†å¾ˆå¤šå¹´ï¼Œåº•å±‚çš„ç½‘ç»œåŸè¯­ä»ç„¶æ²¡æœ‰æ”¯æŒå–æ¶ˆä»¤ç‰Œã€‚è¿™å¬ä¸Šå»å°±åƒ\u0026hellip;è¿™äº›åŸºæœ¬æ“ä½œå¯èƒ½ä¼šå› ä¸ºä½ æ— æ³•æ§åˆ¶çš„åŸå› è€ŒæŒ‚èµ·ï¼Œä½ éœ€è¦å‡†å¤‡å¥½è¶…æ—¶æˆ–å–æ¶ˆï¼Œä½†æ˜¯\u0026hellip;\u0026hellip;æˆ‘çŒœä»–ä»¬åªæ˜¯è¿˜æ²¡æ¥å¾—åŠå®ç°å®ƒï¼Ÿç›¸åï¼Œä»–ä»¬çš„ socket å±‚æ”¯æŒä¸€ç§æ—§çš„æœºåˆ¶æ¥è®¾ç½® socket å¯¹è±¡çš„è¶…æ—¶æˆ–æœ€åæœŸé™ï¼Œå¦‚æœä½ æƒ³ä½¿ç”¨å–æ¶ˆä»¤ç‰Œï¼Œä½ å¿…é¡»è‡ªå·±æƒ³åŠæ³•åœ¨è¿™ä¸¤ä¸ªä¸åŒçš„ç³»ç»Ÿä¹‹é—´å»ºç«‹æ¡¥æ¢ã€‚\nGo æ ‡å‡†åº“ç¡®å®æä¾›äº†ä¸€ä¸ªå¦‚ä½•åšåˆ°è¿™ä¸€ç‚¹çš„ä¾‹å­ï¼šä»–ä»¬å»ºç«‹ç½‘ç»œè¿æ¥çš„å‡½æ•°ï¼ˆåŸºæœ¬ç›¸å½“äº Python çš„ socket.connectï¼‰ç¡®å®æ¥å—å–æ¶ˆä»¤ç‰Œã€‚å®ç°è¿™ä¸ªåŠŸèƒ½éœ€è¦ 40 è¡Œä»£ç å’Œä¸€ä¸ªåå°ä»»åŠ¡ï¼Œå¹¶ä¸”ç¬¬ä¸€æ¬¡å°è¯•å¯¼è‡´äº†ä¸€ä¸ªèŠ±äº†ä¸€å¹´æ‰åœ¨ç”Ÿäº§ç¯å¢ƒæ’æŸ¥å‡ºæ¥çš„èµ„æºç«äº‰é—®é¢˜ã€‚æ‰€ä»¥\u0026hellip;åœ¨ Go ä¸­ï¼Œå¦‚æœä½ æƒ³ä½¿ç”¨å–æ¶ˆä»¤ç‰Œï¼ˆæˆ– Contextï¼Œç”¨ Go çš„è¯´æ³•ï¼‰ï¼Œé‚£ä¹ˆæˆ‘æƒ³è¿™å°±æ˜¯ä½ æ¯æ¬¡ä½¿ç”¨ä»»ä½• socket æ“ä½œæ—¶éœ€è¦å®ç°çš„ä¸œè¥¿ï¼Ÿç¥ä½ å¥½è¿ï¼Ÿ\næˆ‘å¹¶ä¸æ˜¯è¦å–ç¬‘ä½ ï¼Œè¿™ä¸œè¥¿æ˜¯å¾ˆéš¾æã€‚ä½†æ˜¯ C# å’Œ Go éƒ½æ˜¯ç”±é«˜æ°´å¹³çš„å…¨èŒå¼€å‘è€…å›¢é˜Ÿç»´æŠ¤çš„å·¨å¤§é¡¹ç›®ï¼Œå¹¶ç”±ä¸–ç•Œ 50 å¼ºå…¬å¸æ”¯æŒã€‚å¦‚æœä»–ä»¬éƒ½åšä¸å¥½ï¼Œè°åˆèƒ½åšåˆ°å‘¢ï¼Ÿåæ­£ä¸æ˜¯æˆ‘ã€‚æˆ‘åªæ˜¯ä¸€ä¸ªè¯•å›¾åœ¨ Python ä¸­é‡æ–°å‘æ˜ I/O æ“ä½œçš„äººç±»ã€‚æˆ‘æä¸å®šé‚£ä¹ˆå¤æ‚çš„ä¸œè¥¿ã€‚\nå–æ¶ˆä½œç”¨åŸŸï¼ˆcancel scopesï¼‰ï¼šï¼ˆTrio å¯¹è¶…æ—¶å’Œå–æ¶ˆå¯¹äººæ€§åŒ–è§£å†³æ–¹æ¡ˆ ğŸ‘ï¼‰ è¿˜è®°å¾—åœ¨è¿™ç¯‡æ–‡ç« çš„å¼€å¤´ï¼Œæˆ‘ä»¬æ³¨æ„åˆ° Python çš„ socket æ–¹æ³•ä¸æ¥å—å•ç‹¬çš„è¶…æ—¶å‚æ•°ï¼Œè€Œæ˜¯è®©ä½ åœ¨ socket ä¸Šè®¾ç½®ä¸€æ¬¡è¶…æ—¶ï¼Œè¿™æ ·å®ƒå°±éšå«åœ°ä¼ é€’ç»™ä½ è°ƒç”¨çš„æ¯ä¸ªæ–¹æ³•ï¼Ÿè€Œåœ¨ä¸Šé¢çš„éƒ¨åˆ†ï¼Œæˆ‘ä»¬æ³¨æ„åˆ° C# å’Œ Go ä¹Ÿåšäº†å·®ä¸å¤šçš„äº‹æƒ…ï¼Ÿæˆ‘æƒ³ä»–ä»¬æ˜¯æœ‰é“ç†çš„ã€‚ä¹Ÿè®¸æˆ‘ä»¬åº”è¯¥æ‰¿è®¤ï¼Œå½“ä½ æœ‰ä¸€äº›æ•°æ®å¿…é¡»ä¼ é€’ç»™ä½ è°ƒç”¨çš„æ¯ä¸ªå‡½æ•°æ—¶ï¼Œè¿™æ˜¯è®¡ç®—æœºåº”è¯¥å¤„ç†çš„äº‹æƒ…ï¼Œè€Œä¸æ˜¯è®©ä¸ç¨³å®šçš„äººç±»æ¥åšè¿™äº›å·¥ä½œ \u0026ndash; ä½†è¦ä»¥ä¸€ç§é€šç”¨çš„æ–¹å¼æ”¯æŒå¤æ‚çš„æŠ½è±¡ï¼Œè€Œä¸ä»…ä»…æ˜¯ socketsã€‚\nå–æ¶ˆä½œç”¨åŸŸæ˜¯æ€ä¹ˆå·¥ä½œçš„ ä»¥ä¸‹æ˜¯å¦‚ä½•åœ¨ Trio ä¸­å¯¹ HTTP è¯·æ±‚æ–½åŠ  10 ç§’çš„è¶…æ—¶ï¼š\n# The primitive API: with trio.open_cancel_scope() as cancel_scope: cancel_scope.deadline = trio.current_time() + 10 await request.get(\u0026#34;https://...\u0026#34;) å½“ç„¶ï¼Œé€šå¸¸ä½ ä¼šä½¿ç”¨ä¸€ä¸ªæ–¹ä¾¿çš„å°è£…å™¨ï¼Œåƒè¿™æ ·ï¼š\n# An equivalent but more idiomatic formulation: with trio.move_on_after(10): await requests.get(\u0026#34;https://...\u0026#34;) ä½†ç”±äºè¿™ç¯‡æ–‡ç« æ˜¯å…³äºåº•å±‚è®¾è®¡çš„ï¼Œæ‰€ä»¥æˆ‘ä»¬å°†ä¸“æ³¨äºåŸå§‹çš„ç‰ˆæœ¬ã€‚ï¼ˆè‡´è°¢ï¼šä½¿ç”¨ with å—è¿›è¡Œè¶…æ—¶çš„æƒ³æ³•æ˜¯æˆ‘åœ¨ Dave Beazley çš„ Curio ä¸­ç¬¬ä¸€æ¬¡çœ‹åˆ°çš„ï¼Œè™½ç„¶æˆ‘æ”¹äº†è®¸å¤šã€‚æˆ‘ä¼šæŠŠç»†èŠ‚è—åœ¨ä¸€ä¸ªè„šæ³¨é‡Œï¼š[4]ï¼‰ã€‚\nä½ åº”è¯¥è®¤ä¸º open_cancel_scope() æ˜¯åœ¨åˆ›å»ºä¸€ä¸ªå–æ¶ˆä»¤ç‰Œï¼Œä½†å®ƒå®é™…ä¸Šå¹¶æ²¡æœ‰å…¬å¼€æš´éœ²ä»»ä½• CancelToken å¯¹è±¡ã€‚ç›¸åçš„ï¼Œå–æ¶ˆä»¤ç‰Œè¢«å‹è¿›äº†ä¸€ä¸ªä¸å¯è§çš„å†…éƒ¨å †æ ˆä¸­ï¼Œå¹¶è‡ªåŠ¨åº”ç”¨äº with å—å†…è°ƒç”¨çš„ä»»ä½•é˜»å¡æ“ä½œã€‚å› æ­¤ï¼Œrequests ä¸éœ€è¦åšä»»ä½•äº‹æƒ…æ¥ä¼ é€’å®ƒ \u0026ndash; å½“å®ƒæœ€ç»ˆé€šè¿‡ç½‘ç»œå‘é€å’Œæ¥æ”¶æ•°æ®æ—¶ï¼Œè¿™äº›åŸå§‹è°ƒç”¨å°†è‡ªåŠ¨åº”ç”¨å…¶ä¸­çš„æœ€åæœŸé™ã€‚\ncancel_scope å¯¹è±¡è®©æˆ‘ä»¬å¯ä»¥æ§åˆ¶å–æ¶ˆçŠ¶æ€ï¼šä½ å¯ä»¥æ”¹å˜æœ€åæœŸé™ï¼Œæˆ–æ˜¯é€šè¿‡è°ƒç”¨ cancel_scope.cancel() å‘èµ·ä¸€ä¸ªæ˜ç¡®çš„å–æ¶ˆï¼Œç­‰ç­‰ã€‚å¦‚æœä½ äº†è§£ C#ï¼Œå®ƒå°±ç±»ä¼¼äºä¸€ä¸ª CancellationTokenSourceã€‚ä¸€ä¸ªå®ƒå…è®¸çš„æœ‰ç”¨çš„æŠ€å·§æ˜¯ï¼Œåœ¨æ›´åŸå§‹çš„å–æ¶ˆä½œç”¨åŸŸå›å·è¯­ä¹‰ä¸Šï¼Œå®ç°äººä»¬ä¹ æƒ¯çš„é‚£ç§â€œå½“è¶…æ—¶å‘ç”Ÿæ—¶æŠ›å‡ºä¸€ä¸ªé”™è¯¯â€çš„ APIã€‚\nå½“ä¸€ä¸ªæ“ä½œè¢«å–æ¶ˆæ—¶ï¼Œå®ƒä¼šæŠ›å‡ºä¸€ä¸ª Cancelled å¼‚å¸¸ï¼Œè¿™ä¸ªå¼‚å¸¸è¢«ç”¨æ¥å°†å †æ ˆå›å·åˆ°åˆé€‚çš„ open_cancel_scope å—ä¸­ã€‚å–æ¶ˆä½œç”¨åŸŸå¯ä»¥æ˜¯åµŒå¥—çš„ï¼ŒCancelled å¼‚å¸¸çŸ¥é“å®ƒä»¬æ˜¯åœ¨å“ªä¸ªä½œç”¨åŸŸè§¦å‘çš„ï¼Œå¹¶å°†æŒç»­ä¼ æ’­ç›´åˆ°åˆ°è¾¾ç›¸åº”çš„ with å—ä¸­ï¼ˆå› æ­¤ï¼Œä½ åº”è¯¥æ€»æ˜¯è®© Trio è¿è¡Œæ—¶è´Ÿè´£å¼•å‘å’Œæ•æ‰å–æ¶ˆå¼‚å¸¸ï¼Œè¿™æ ·å®ƒå°±èƒ½æ­£ç¡®åœ°è·Ÿè¸ªè¿™äº›å…³ç³»ï¼‰ã€‚\næ”¯æŒåµŒå¥—å¾ˆé‡è¦ï¼Œå› ä¸ºæœ‰äº›æ“ä½œå¯èƒ½æƒ³åœ¨å†…éƒ¨ä½¿ç”¨è¶…æ—¶ä½œä¸ºå®ç°ç»†èŠ‚ã€‚ä¾‹å¦‚ï¼Œå½“ä½ è¦æ±‚ Trio ä¸ä¸€ä¸ªæœ‰å¤šä¸ª IP åœ°å€å…³è”çš„ä¸»æœºåå»ºç«‹ TCP è¿æ¥æ—¶ï¼Œå®ƒä½¿ç”¨äº†ä¸€ç§å«â€œhappy eyeballsâ€çš„ç®—æ³•ï¼Œä»¥äº¤é”™çš„æ–¹å¼å¹¶è¡Œè¿è¡Œå¤šä¸ªè¿æ¥å°è¯•ï¼Œè¿™éœ€è¦ä¸€ä¸ªå†…éƒ¨è¶…æ—¶æ¥å†³å®šä½•æ—¶å¯åŠ¨ä¸‹ä¸€æ¬¡è¿æ¥å°è¯•ã€‚ä½†æ˜¯ï¼Œç”¨æˆ·ä¸åº”è¯¥å…³å¿ƒè¿™ä¸ªé—®é¢˜ï¼å¦‚æœä½ æƒ³è¯´â€œå°è¯•è¿æ¥åˆ° example.com:443ï¼Œä½† 10 ç§’åæ”¾å¼ƒâ€ï¼Œé‚£å°±è¿™ä¹ˆå†™ï¼š\nwith trio.move_on_after(10): tcp_stream = await trio.open_tcp_stream(\u0026#34;example.com\u0026#34;, 443) æ„Ÿè°¢å–æ¶ˆä½œç”¨åŸŸçš„åµŒå¥—è§„åˆ™ï¼Œä¸€åˆ‡éƒ½èƒ½æ­£å¸¸å·¥ä½œã€‚äº‹å®è¯æ˜ï¼Œopen_tcp_stream å¯ä»¥æ­£ç¡®åœ°å¤„ç†è¿™ä¸ªé—®é¢˜ï¼Œä¸éœ€è¦é¢å¤–çš„ä»£ç ã€‚\nåœ¨å“ªé‡Œæ£€æŸ¥å–æ¶ˆçŠ¶æ€ï¼Ÿ é¢å¯¹å–æ¶ˆæ“ä½œï¼Œæƒ³è¦æ­£ç¡®åœ°ç¼–å†™ä»£ç æ˜¯æ¯”è¾ƒæ£˜æ‰‹çš„ã€‚å¦‚æœä¸€ä¸ª Cancelled å¼‚å¸¸çªç„¶å‡ºç°åœ¨ç”¨æˆ·æ²¡æœ‰å‡†å¤‡å¥½çš„åœ°æ–¹ \u0026ndash; ä¹Ÿè®¸æ˜¯åœ¨ä»–ä»¬çš„ä»£ç æ­£åœ¨æ“ä½œä¸€äº›å¾®å¦™çš„æ•°æ®ç»“æ„çš„æ—¶å€™ \u0026ndash; å®ƒå¯èƒ½ä¼šç ´åå†…éƒ¨çŠ¶æ€å¹¶å¯¼è‡´éš¾ä»¥è¿½è¸ªçš„ç¼ºé™·ã€‚å¦ä¸€æ–¹é¢ï¼Œå¦‚æœä½ ä¸èƒ½ç›¸å¯¹åŠæ—¶åœ°æ³¨æ„åˆ°å–æ¶ˆçš„æƒ…å†µï¼Œé‚£ä¹ˆè¶…æ—¶å’Œå–æ¶ˆç³»ç»Ÿä¹Ÿæ²¡æœ‰ä»€ä¹ˆç”¨å¤„ã€‚å› æ­¤ï¼Œå¯¹ä»»ä½•ç³»ç»Ÿæ¥è¯´ï¼Œä¸€ä¸ªé‡è¦çš„æŒ‘æˆ˜æ˜¯é¦–å…ˆé€‰æ‹©ä¸€ä¸ªâ€œé‡‘å‘å§‘å¨˜åŸåˆ™â€ï¼ˆæ³¨ï¼šæºè‡ªç«¥è¯æ•…äº‹ã€Šé‡‘å‘å§‘å¨˜å’Œä¸‰åªç†Šã€‹ï¼Œæ¯”å–»åšåŠ›æ‰€èƒ½åŠã€éš¾æ˜“é€‚ä¸­çš„äº‹æƒ…ï¼‰ï¼Œæ£€æŸ¥çš„é¢‘ç‡è¦è¶³å¤Ÿé«˜ï¼Œä½†åˆä¸èƒ½å¤ªé¢‘ç¹ï¼Œç„¶åä»¥æŸç§æ–¹å¼å°†è¿™ä¸ªè§„åˆ™ä¼ è¾¾ç»™ç”¨æˆ·ï¼Œä½¿ä»–ä»¬èƒ½å¤Ÿç¡®ä¿ä»–ä»¬çš„ä»£ç å·²ç»å‡†å¤‡å¥½äº†ã€‚\nåœ¨ Trio çš„ä¾‹å­ä¸­ï¼Œè¿™æ˜¯å¾ˆç®€å•çš„ã€‚ç”±äºå…¶ä»–ä¸€äº›åŸå› ï¼Œæˆ‘ä»¬å·²ç»ä½¿ç”¨ Python çš„ async/await è¯­æ³•æ¥æ³¨é‡Šé˜»å¡å‡½æ•°ã€‚å®ƒçš„ä¸»è¦ä½œç”¨æ˜¯è®©ä½ åœ¨çœ‹åˆ°ä»»ä½•å‡½æ•°çš„æ–‡æœ¬æ—¶ï¼Œå¯ä»¥ç«‹åˆ»çœ‹åˆ°å“ªäº›ç‚¹å¯èƒ½ä¼šé˜»å¡ï¼Œç›´åˆ°æŸäº›äº‹æƒ…å‘ç”Ÿã€‚æ¯”å¦‚è¿™ä¸ªä¾‹å­ï¼š\nasync def user_defined_function(): print(\u0026#34;Hello!\u0026#34;) await trio.sleep(1) print(\u0026#34;Goodbyte!\u0026#34;) åœ¨è¿™é‡Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œå¯¹ trio.sleep å¯¹è°ƒç”¨æ—¶é˜»å¡çš„ï¼Œå› ä¸ºå®ƒæœ‰ä¸€ä¸ªç‰¹æ®Šçš„ await å…³é”®å­—ã€‚å¦‚æœä¸ä½¿ç”¨è¿™ä¸ªå…³é”®å­—ï¼Œä½ å°±ä¸èƒ½è°ƒç”¨ trio.sleep æˆ–ä»»ä½•å…¶ä»– Trio çš„å†…ç½®é˜»å¡åŸè¯­ï¼Œå› ä¸ºå®ƒä»¬è¢«æ ‡è®°æˆåŒæ­¥å‡½æ•°ã€‚å¹¶ä¸” Python å¼ºåˆ¶è§„å®šï¼Œå¦‚æœä½ æƒ³ä½¿ç”¨ await å…³é”®å­—ï¼Œé‚£ä¹ˆä½ å¿…é¡»è¦è°ƒç”¨æ–¹çš„å‡½æ•°ä¹Ÿæ ‡è®°æˆ asyncï¼Œè¿™æ„å‘³ç€æ‰€æœ‰è°ƒç”¨ user_defined_function çš„äººä¹Ÿå°†ä½¿ç”¨ await å…³é”®å­—ï¼ˆæ³¨ï¼šè¿™æ˜¯ async/await è¯­æ³•å—åˆ°è¯Ÿç—…çš„ä¸€ç‚¹ï¼Œè¯­æ³•çš„ä¼ æ’­å¯¼è‡´äº†ä»¥å¾€çš„é˜»å¡ä»£ç æ— æ³•å¤ç”¨ï¼‰ã€‚è¿™æ˜¯æœ‰é“ç†çš„ï¼Œå› ä¸ºå¦‚æœ user_defined_function è°ƒç”¨äº†ä¸€ä¸ªé˜»å¡çš„å‡½æ•°ï¼Œé‚£å®ƒä¹Ÿå°±æˆäº†ä¸€ä¸ªé˜»å¡çš„å‡½æ•°ã€‚åœ¨è®¸å¤šå…¶ä»–ç³»ç»Ÿä¸­ï¼Œä¸€ä¸ªå‡½æ•°æ˜¯å¦ä¼šé˜»å¡ï¼Œä½ åªèƒ½é€šè¿‡æ£€æŸ¥å®ƒçš„æ‰€æœ‰æ½œåœ¨çš„è¢«è°ƒç”¨è€…ï¼Œä»¥åŠå®ƒä»¬çš„æ‰€æœ‰è¢«è°ƒç”¨è€…ç­‰æ¥ç¡®å®šï¼›async/await é‡‡ç”¨äº†è¿™ç§å…¨å±€çš„è¿è¡Œæ—¶å±æ€§ï¼Œä½¿å®ƒåœ¨æºä»£ç ä¸­ä¸€ç›®äº†ç„¶ã€‚\nTrio çš„å–æ¶ˆä½œç”¨åŸŸåœ¨è¿™ä¸ªç³»ç»Ÿä¸Šæ­äº†ä¸€ä¸ªä¾¿è½¦ï¼šæˆ‘ä»¬å£°æ˜ï¼Œæ— è®ºåœ¨å“ªä½ çœ‹åˆ°äº†ä¸€ä¸ª awaitï¼Œé‚£å°±æ˜¯ä¸€ä¸ªä½ å¯èƒ½éœ€è¦å¤„ç† Cancelled å¼‚å¸¸çš„åœ°æ–¹ \u0026ndash; è¦ä¹ˆæ˜¯å› ä¸ºå®ƒè°ƒç”¨äº† Trio çš„ç›´æ¥æ£€æŸ¥å–æ¶ˆçš„åŸè¯­ï¼Œè¦ä¹ˆæ˜¯å› ä¸ºå®ƒè°ƒç”¨äº†ä¸€ä¸ªé—´æ¥è°ƒç”¨è¿™äº›åŸè¯­çš„å‡½æ•°ï¼Œä»è€Œå¯èƒ½çœ‹åˆ°ä¸€ä¸ª Cancelled å¼‚å¸¸æ¶Œç°å‡ºæ¥ã€‚è¿™å¯¼è‡´äº†å‡ ä¸ªå¾ˆå¥½çš„ç‰¹æ€§ã€‚é¦–å…ˆï¼Œå®ƒéå¸¸å®¹æ˜“å‘ç”¨æˆ·è§£é‡Šã€‚å®ƒæ¶µç›–äº†æ‰€æœ‰ä½ ç»å¯¹éœ€è¦è¶…æ—¶/å–æ¶ˆæ”¯æŒä»¥é¿å…æ— é™æŒ‚èµ·çš„å‡½æ•° \u0026ndash; åªæœ‰é‚£äº›é˜»å¡çš„å‡½æ•°æ‰ä¼šè¢«æ°¸è¿œé˜»å¡ã€‚è¿™æ„å‘³ç€ä»»ä½•å®šæœŸåš I/O æ“ä½œçš„å‡½æ•°ä¹Ÿä¼šå®šæœŸè‡ªåŠ¨æ£€æŸ¥å–æ¶ˆçŠ¶æ€ï¼Œæ‰€ä»¥å¤§å¤šæ•°æ—¶å€™ä½ ä¸éœ€è¦æ‹…å¿ƒè¿™ä¸ªé—®é¢˜ï¼ˆå°½ç®¡å¯¹äºå¶å°”çš„é•¿æœŸè¿è¡Œçš„çº¯è®¡ç®—ï¼Œä½ å¯èƒ½æƒ³é€šè¿‡è°ƒç”¨ await trio.sleep(0) æ¥å¢åŠ ä¸€äº›æ˜¾å¼çš„å–æ¶ˆæ£€æŸ¥ \u0026ndash; æ— è®ºå¦‚ä½•ä½ å¿…é¡»è¿™æ ·åšæ‰èƒ½è®©è°ƒåº¦å™¨å·¥ä½œï¼ï¼‰ã€‚é˜»å¡å‡½æ•°å¾€å¾€æœ‰å¤§é‡çš„å¤±è´¥æ¨¡å¼ï¼Œå› æ­¤åœ¨è®¸å¤šæƒ…å†µä¸‹ï¼Œå¤„ç† Cancelled å¼‚å¸¸æ‰€éœ€çš„æ¸…ç†å·¥ä½œå°†ä¸å¤„ç†ä¾‹å¦‚ä¸€ä¸ªè¡Œä¸ºä¸ç«¯çš„ç½‘ç»œå¯¹ç­‰ä½“ï¼ˆæ³¨ï¼špeerï¼‰æ‰€éœ€çš„æ¸…ç†å·¥ä½œæ˜¯å…±äº«çš„ã€‚è€Œä¸” Trio çš„åˆä½œå¤šä»»åŠ¡ç³»ç»Ÿä¹Ÿä½¿ç”¨ç­‰å¾…ç‚¹æ¥æ ‡è®°è°ƒåº¦å™¨å¯èƒ½åˆ‡æ¢åˆ°å¦ä¸€ä¸ªä»»åŠ¡çš„åœ°æ–¹ï¼Œæ‰€ä»¥ä½ å·²ç»è¦å°å¿ƒåœ¨ await è¿‡ç¨‹ä¸­è®©æ•°æ®ç»“æ„å¤„äºä¸ä¸€è‡´çš„çŠ¶æ€ã€‚å–æ¶ˆå’Œ async/await å°±åƒèŠ±ç”Ÿé…±å’Œå·§å…‹åŠ›ä¸€æ ·ï¼ˆæ³¨ï¼šæ¯”å–»æœ€ä½³çš„ç»„åˆï¼‰ã€‚\nä¸€ä¸ªé€ƒç”Ÿèˆ±å£ è™½ç„¶æ£€æŸ¥æ‰€æœ‰é˜»å¡åŸå§‹è°ƒç”¨çš„å–æ¶ˆçŠ¶æ€æ˜¯ä¸€ä¸ªéå¸¸å¥½çš„é»˜è®¤é€‰æ‹©ï¼Œä½†åœ¨ä¸€äº›éå¸¸ç½•è§çš„æƒ…å†µä¸‹ï¼Œä½ å¸Œæœ›ç¦ç”¨è¿™ä¸ªåŠŸèƒ½å¹¶å¯¹å–æ¶ˆçš„è¡Œä¸ºè¿›è¡Œæ˜ç¡®çš„æ§åˆ¶ã€‚è¿™äº›æƒ…å†µéå¸¸ç½•è§ï¼Œæ‰€ä»¥æˆ‘æ²¡æœ‰ä¸€ä¸ªç®€å•çš„ä¾‹å­å¯ä»¥åœ¨è¿™é‡Œä½¿ç”¨ï¼ˆå°½ç®¡åœ¨ Trio æºä»£ç ä¸­æœ‰ä¸€äº›ç¥ç§˜çš„ä¾‹å­ï¼Œå¦‚æœä½ çœŸçš„å¾ˆå¥½å¥‡ï¼Œä½ å¯ä»¥å»æ‰¾æ‰¾çœ‹ï¼‰ã€‚ä¸ºäº†æä¾›è¿™æ ·ä¸€ä¸ªé€ƒç”Ÿèˆ±å£ï¼Œä½ å¯ä»¥è®¾ç½®ä¸€ä¸ªå–æ¶ˆä½œç”¨åŸŸæ¥â€œå±è”½â€å®ƒçš„å†…å®¹ï¼Œä½¿å…¶ä¸å—å¤–ç•Œå–æ¶ˆçš„å½±å“ã€‚å®ƒçœ‹èµ·æ¥åƒè¿™æ ·ï¼š\nwith trio.move_on_after(10): with trio.open_cancel_scope() as inner_scope: inner_scope.shield = True # Sleeps for 20 seconds, ignoring the overall 10 second # timeout await trio.sleep(20) ä¸ºäº†æ”¯æŒç»„åˆï¼Œå±è”½å¯¹å–æ¶ˆä½œç”¨åŸŸçš„æ ˆæ˜¯æ•æ„Ÿçš„ï¼šå®ƒåªé˜»æ­¢å¤–éƒ¨å–æ¶ˆä½œç”¨åŸŸçš„åº”ç”¨ï¼Œè€Œå¯¹å†…éƒ¨ä½œç”¨åŸŸæ²¡æœ‰å½±å“ã€‚åœ¨æˆ‘ä»¬ä¸Šé¢çš„ä¾‹å­ä¸­ï¼Œæˆ‘ä»¬çš„å±è”½å¯¹ä»»ä½•å¯èƒ½åœ¨ trio.sleep ä¸­ä½¿ç”¨çš„å–æ¶ˆä½œç”¨åŸŸæ²¡æœ‰ä»»ä½•å½±å“ \u0026ndash; è¿™äº›ä½œç”¨åŸŸä»ç„¶è¡¨ç°æ­£å¸¸ã€‚è¿™å¾ˆå¥½ï¼Œå› ä¸ºæ— è®º trio.sleep åœ¨å†…éƒ¨åšä»€ä¹ˆéƒ½æ˜¯å®ƒè‡ªå·±çš„ç§æœ‰å®ç°ç»†èŠ‚ã€‚äº‹å®ä¸Šï¼Œtrio.sleep åœ¨å†…éƒ¨ç¡®å®ä½¿ç”¨äº†ä¸€ä¸ªå–æ¶ˆä½œç”¨åŸŸã€‚\nshield æ˜¯å–æ¶ˆä½œç”¨åŸŸçš„ä¸€ä¸ªå±æ€§ï¼Œè€Œä¸æ˜¯æœ‰ä¸€ä¸ªç‰¹æ®Šçš„â€œå±è”½ä½œç”¨åŸŸâ€ï¼Œå…¶åŸå› ä¹‹ä¸€æ˜¯å®ƒä½¿å¾—å®ç°è¿™ç§åµŒå¥—å¾ˆæ–¹ä¾¿ï¼Œå› ä¸ºæˆ‘ä»¬å¯ä»¥é‡æ–°ä½¿ç”¨å–æ¶ˆä½œç”¨åŸŸçš„ç°æœ‰å †æ ˆç»“æ„ã€‚å¦ä¸€ä¸ªåŸå› æ˜¯ï¼Œåœ¨ä½ ç¦ç”¨å¤–éƒ¨è¶…æ—¶çš„ä»»ä½•åœ°æ–¹ï¼Œä½ éƒ½éœ€è¦è€ƒè™‘ä½ è¦åšä»€ä¹ˆæ¥ä»£æ›¿ï¼Œä»¥ç¡®ä¿å®ƒä¸ä¼šæ°¸è¿œæŒ‚èµ·ã€‚è€Œæœ‰ä¸€ä¸ªå–æ¶ˆä½œç”¨åŸŸåœ¨é‚£é‡Œå°±å¯ä»¥å¾ˆå®¹æ˜“åœ°åœ¨å±€éƒ¨ä»£ç çš„æ§åˆ¶ä¸‹åº”ç”¨ä¸€ä¸ªæ–°çš„è¶…æ—¶æ—¶é—´ï¼š\n# Demonstrating that the shielding scope can be used to avoid hangs # after disabling outside timeouts: with trio.move_on_after(10) as outer_scope: with trio.move_on_after(15) as inner_scope: inner_scope.shield = True # Returns after 15 seconds, when the shielding scope expires: await trio.sleep(1000000) ç°åœ¨ï¼Œå¦‚æœä½ æ˜¯ä¸€ä¸ª Trio çš„ç”¨æˆ·ï¼Œè¯·å¿˜è®°ä½ è¯»è¿‡è¿™ä¸€èŠ‚ã€‚å¦‚æœä½ è®¤ä¸ºä½ éœ€è¦ä½¿ç”¨å±è”½èƒ½åŠ›ï¼Œé‚£ä¹ˆä½ å‡ ä¹è‚¯å®šåº”è¯¥é‡æ–°è€ƒè™‘ä½ è¦åšçš„äº‹æƒ…ã€‚ä½†å¦‚æœä½ æ˜¯ä¸€ä¸ª I/O è¿è¡Œæ—¶çš„å®ç°è€…ï¼Œå¸Œæœ›å¢åŠ å–æ¶ˆä½œç”¨åŸŸçš„æ”¯æŒï¼Œé‚£ä¹ˆè¿™å°±æ˜¯ä¸€ä¸ªé‡è¦çš„åŠŸèƒ½ã€‚\nå–æ¶ˆä½œç”¨åŸŸå’Œå¹¶å‘ æœ€åï¼Œè¿™é‡Œè¿˜åº”è¯¥æåˆ° Trio çš„ä¸€ä¸ªç‰¹æ€§ã€‚åˆ°ç›®å‰ä¸ºæ­¢ï¼Œåœ¨è¿™ç¯‡æ–‡ç« ä¸­ï¼Œæˆ‘æ ¹æœ¬æ²¡æœ‰è¿‡å¤šåœ°è®¨è®ºå¹¶å‘ã€‚è¶…æ—¶å’Œå–æ¶ˆåœ¨å¾ˆå¤§ç¨‹åº¦ä¸Šæ˜¯ç‹¬ç«‹çš„ï¼Œä¸Šé¢çš„ä¸€åˆ‡ç”šè‡³é€‚ç”¨äºç›´æ¥çš„å•çº¿ç¨‹åŒæ­¥ä»£ç ã€‚ä½†æˆ‘ä»¬ç¡®å®åšäº†ä¸€äº›çœ‹ä¼¼å¾®ä¸è¶³é“çš„å‡è®¾ï¼šå¦‚æœä½ åœ¨ä¸€ä¸ª with å—å†…è°ƒç”¨ä¸€ä¸ªå‡½æ•°ï¼Œé‚£ä¹ˆï¼ˆaï¼‰æ‰§è¡Œå°†æ—¶æœºå‘ç”Ÿåœ¨ with å—å†…ï¼Œä»¥åŠï¼ˆbï¼‰å®ƒæŠ›å‡ºçš„ä»»ä½•å¼‚å¸¸éƒ½å°†è¢«ä¼ æ’­å› with å—ï¼Œä»¥ä¾¿å®ƒèƒ½å¤Ÿæ•è·å®ƒä»¬ã€‚ä¸å¹¸çš„æ˜¯ï¼Œè®¸å¤šçº¿ç¨‹å’Œå¹¶å‘åº“è¿åäº†è¿™ä¸€ç‚¹ï¼Œç‰¹åˆ«æ˜¯åœ¨ä¸€äº›å·¥ä½œè¢«ç”Ÿæˆæˆ–è°ƒåº¦çš„æƒ…å†µä¸‹ï¼š\n# This looks innocent enough: with move_on_after(10): do_the_thing() # But it isn\u0026#39;t: def do_the_thing(): # Using some made-up API similar to what most systems use: start_task_in_background(some_worker_that_will_actually_do_the_thing) å¦‚æœæˆ‘ä»¬åªçœ‹ with å—ï¼Œè¿™ä¼¼ä¹æ˜¯å®Œå…¨æ— è¾œçš„ã€‚ä½†æ˜¯å½“æˆ‘ä»¬çœ‹çœ‹ do_the_thing æ˜¯å¦‚ä½•å®ç°çš„ï¼Œæˆ‘ä»¬å°±ä¼šæ„è¯†åˆ°ï¼Œæˆ‘ä»¬å’Œå¯èƒ½åœ¨åå°ä»»åŠ¡å®Œæˆä¹‹å‰é€€å‡º with å—ï¼Œæ‰€ä»¥å°±ä¼šå‡ºç°ä¸€äº›æ¨¡ç³Šçš„åœ°æ–¹ï¼šè¶…æ—¶æ˜¯å¦åº”è¯¥é€‚ç”¨äºåå°ä»»åŠ¡ï¼Ÿå¦‚æœå®ƒç¡®å®é€‚ç”¨ï¼Œé‚£ä¹ˆæˆ‘ä»¬åº”è¯¥å¦‚ä½•å¤„ç† Cancelled å¼‚å¸¸ï¼Ÿå¯¹äºå¤§å¤šæ•°ç³»ç»Ÿæ¥è¯´ï¼Œåå°çº¿ç¨‹/ä»»åŠ¡ä¸­æœªå¤„ç†çš„å¼‚å¸¸è¢«ç®€å•åœ°ä¸¢å¼ƒäº†ã€‚\nç„¶è€Œï¼Œè¿™äº›é—®é¢˜åœ¨ Trio ä¸­ä¸ä¼šå‡ºç°ï¼Œå› ä¸ºå®ƒæœ‰ç‹¬ç‰¹çš„æ–¹æ³•æ¥å¤„ç†å¹¶å‘æ€§ã€‚Trio çš„æ‰˜å„¿æ‰€ç³»ç»Ÿï¼ˆæ³¨ï¼šnursery systemï¼Œç”¨äºå®ç°ç»“æ„åŒ–å¹¶å‘çš„ç³»ç»Ÿï¼‰æ„å‘³ç€å­ä»»åŠ¡æ€»æ˜¯è¢«æ•´åˆåˆ°è°ƒç”¨å †æ ˆä¸­ï¼Œè¿™å®é™…ä¸Šæˆä¸ºä¸€ä¸ªè°ƒç”¨æ ‘ã€‚å…·ä½“æ¥è¯´ï¼ŒTrio æ²¡æœ‰å…¨å±€çš„ start_task_in_background åŸè¯­ã€‚ç›¸åï¼Œå¦‚æœä½ æƒ³ç”Ÿæˆä¸€ä¸ªå­ä»»åŠ¡ï¼Œä½ å¿…é¡»å…ˆæ‰“å¼€ä¸€ä¸ªâ€œnurseryâ€å—ï¼ˆè®©å­©å­ä½åœ¨é‡Œé¢ï¼Œæ˜ç™½å—ï¼Ÿï¼‰ï¼Œç„¶åå…¶ä¸­åˆ›å»ºçš„å­ä»»åŠ¡çš„ç”Ÿå‘½å‘¨æœŸå°±å’Œåˆ›å»ºæ‰˜å„¿æ‰€çš„å—ç»‘å®šäº†èµ·æ¥ï¼š\nwith move_on_after(10): await do_the_thing() async def do_the_thing(): async with trio.open_nursery() as nursery: nursery.start_soon(some_worker_that_will_actually_do_the_thing) # Now the \u0026#39;async with\u0026#39; block won\u0026#39;t complete until the # child task has finished, and if the child has an unhandled # exception then it will be re-raised here in the parent. # Which makes this example pretty silly -- the \u0026#34;background # task\u0026#34; acts just like a function call. Which is the point :-) è¿™ä¸ªç³»ç»Ÿæœ‰å¾ˆå¤šä¼˜ç‚¹ï¼Œä½†ä¸æ­¤ç›¸å…³çš„ä¸€ç‚¹æ˜¯ï¼Œå®ƒä¿ç•™äº†å–æ¶ˆä½œç”¨åŸŸæ‰€ä¾èµ–çš„å…³é”®å‡è®¾ã€‚ä»»ä½•ç»™å®šæ‰˜å„¿æ‰€è¦ä¹ˆåœ¨å–æ¶ˆä½œç”¨åŸŸå†…ï¼Œè¦ä¹ˆåœ¨å–æ¶ˆä½œç”¨åŸŸå¤– \u0026ndash; æˆ‘ä»¬å¯ä»¥é€šè¿‡æ£€æŸ¥ with open_cancel_scope å—æ˜¯å¦åŒ…å›´äº† async with open_nursery å—æ¥åˆ¤æ–­ã€‚ç„¶åæˆ‘ä»¬å¯ä»¥ç›´æ¥è¯´ï¼Œå¦‚æœä¸€ä¸ªæ‰˜å„¿æ‰€åœ¨å–æ¶ˆä½œç”¨åŸŸå†…ï¼Œé‚£ä¹ˆè¯¥èŒƒå›´åº”è¯¥é€‚ç”¨äºè¯¥æ‰˜å„¿æ‰€å†…çš„æ‰€æœ‰å­©å­ï¼ˆæ³¨ï¼šchildï¼ŒæŒ‡å­ä»»åŠ¡ï¼‰ã€‚è¿™æ„å‘³ç€ï¼Œå¦‚æœæˆ‘ä»¬ç»™ä¸€ä¸ªå‡½æ•°åº”ç”¨ä¸€ä¸ªè¶…æ—¶ï¼Œå®ƒå°±ä¸èƒ½é€šè¿‡ç”Ÿæˆä¸€ä¸ªå­ä»»åŠ¡æ¥â€œé€ƒé€¸â€ \u0026ndash; è¶…æ—¶ä¹Ÿé€‚ç”¨äºå­ä»»åŠ¡ã€‚ï¼ˆä¾‹å¤–çš„æƒ…å†µæ˜¯ï¼Œå¦‚æœä½ å‘å‡½æ•°ä¼ é€’æ¥ä¸€ä¸ªå¤–éƒ¨æ‰˜å„¿æ‰€ï¼Œé‚£ä¹ˆå®ƒå¯ä»¥å‘è¯¥æ‰˜å„¿æ‰€æ´¾ç”Ÿä»»åŠ¡ï¼Œè¿™æ ·å°±å¯ä»¥é€ƒè„±è¶…æ—¶ã€‚ä½†è¿™å¯¹è°ƒç”¨è€…æ¥è¯´æ˜¯æ˜¾è€Œæ˜“è§çš„ï¼Œå› ä¸ºä»–ä»¬å¿…é¡»æä¾›æ‰˜å„¿æ‰€ \u0026ndash; å…³é”®æ˜¯è¦è®©äººæ˜ç™½å‘ç”Ÿäº†ä»€ä¹ˆï¼Œè€Œä¸æ˜¯è®©äººæ— æ³•ç”Ÿæˆåå°ä»»åŠ¡ï¼‰ã€‚\næ€»ç»“ å›åˆ°æˆ‘ä»¬æœ€åˆçš„ä¾‹å­ï¼šæˆ‘ä¸€ç›´åœ¨åšä¸€äº›æœ€åˆçš„å·¥ä½œæ¥å°† requests ç§»æ¤åˆ° Trio ä¸Šï¼ˆä½ å¯ä»¥æ¥å¸®å¿™ï¼ï¼‰ï¼Œåˆ°ç›®å‰ä¸ºæ­¢ï¼Œçœ‹èµ·æ¥ Trio ç‰ˆæœ¬ä¸ä»…èƒ½æ¯”ä¼ ç»Ÿçš„åŒæ­¥ç‰ˆæœ¬æ›´å¥½åœ°å¤„ç†è¶…æ—¶é—®é¢˜ï¼Œè€Œä¸”å®ƒèƒ½ç”¨é›¶è¡Œä»£ç æ¥åšåˆ°è¿™ä¸€ç‚¹ \u0026ndash; æ‰€æœ‰ä½ æƒ³æ£€æŸ¥å–æ¶ˆçš„åœ°æ–¹ï¼ŒTrio éƒ½ä¼šè‡ªåŠ¨è¿™æ ·åšï¼Œè€Œæ‰€æœ‰ä½ éœ€è¦ç‰¹åˆ«æ³¨æ„å¤„ç†æ‰€äº§ç”Ÿçš„å¼‚å¸¸çš„åœ°æ–¹ï¼Œrequests éƒ½å‡†å¤‡å¤„ç†ç”±äºå…¶ä»–åŸå› äº§ç”Ÿçš„ä»»ä½•å¼‚å¸¸ã€‚\nå¤©ä¸‹æ²¡æœ‰å…è´¹çš„åˆé¤ï¼Œå–æ¶ˆçš„å¤„ç†ä»ç„¶æ˜¯ç¼ºé™·çš„ä¸€ä¸ªæ¥æºï¼Œåœ¨ç¼–å†™ä»£ç æ—¶éœ€è¦å°å¿ƒã€‚ä½†æ˜¯ Trio çš„å–æ¶ˆä½œç”¨åŸŸæ¯”æˆ‘å‘ç°çš„ä»»ä½•å…¶ä»–ç³»ç»Ÿéƒ½æ›´å®¹æ˜“ä½¿ç”¨ï¼Œå› æ­¤ä¹Ÿæ›´å¯é ã€‚å¸Œæœ›æˆ‘ä»¬èƒ½ä½¿è¶…æ—¶é”™è¯¯æˆä¸ºä¾‹å¤–ï¼Œè€Œä¸æ˜¯å¸¸è§„æƒ…å†µã€‚\nè¿˜æœ‰è°èƒ½ä»å–æ¶ˆä½œç”¨åŸŸä¸­å—ç›Šï¼Ÿ é‚£ä¹ˆ\u0026hellip;\u0026hellip;å¦‚æœä½ åœ¨ä½¿ç”¨ Trioï¼Œé‚£å°±å¤ªå¥½äº†ï¼è¿™æ˜¯åªåœ¨ Trio çš„ç¯å¢ƒä¸‹å·¥ä½œçš„ä¸œè¥¿ï¼Œè¿˜æ˜¯ä¸€ä¸ªæ›´æ™®éçš„ä¸œè¥¿ï¼Ÿå¦‚æœè¦åœ¨å…¶ä»–ç¯å¢ƒä¸­ä½¿ç”¨ï¼Œéœ€è¦åšä»€ä¹ˆæ ·çš„è°ƒæ•´ï¼Ÿ\nå¦‚æœä½ æƒ³å®ç°å–æ¶ˆä½œç”¨åŸŸï¼Œé‚£ä¹ˆä½ å°±éœ€è¦ï¼š\næŸç§éšå«çš„ä¸Šä¸‹æ–‡æœ¬åœ°å­˜å‚¨æ¥è·Ÿè¸ªå–æ¶ˆä½œç”¨åŸŸæ ˆã€‚å¦‚æœä½ ä½¿ç”¨çš„æ˜¯çº¿ç¨‹ï¼Œé‚£ä¹ˆçº¿ç¨‹æœ¬åœ°å­˜å‚¨æ˜¯å¯è¡Œçš„ï¼›å¦‚æœä½ ä½¿ç”¨çš„æ˜¯æ›´å¥‡ç‰¹çš„ä¸œè¥¿ï¼Œé‚£ä¹ˆä½ å°±éœ€è¦åœ¨ä½ çš„ç³»ç»Ÿä¸­æ‰¾åˆ°ç›¸åº”çš„ä¸œè¥¿ã€‚ï¼ˆä¾‹å¦‚ï¼Œåœ¨ Go ä¸­ä½ éœ€è¦ goroutine-local çš„å­˜å‚¨ï¼Œè€Œè¿™æ˜¯è‘—åçš„ä¸å­˜åœ¨çš„ï¼‰ã€‚è¿™å¯èƒ½æœ‰ç‚¹æ£˜æ‰‹ï¼Œä¾‹å¦‚åœ¨ Python ä¸­ï¼Œæˆ‘ä»¬éœ€è¦ç±»ä¼¼ PEP 568 æ¥è§£å†³å–æ¶ˆä½œç”¨åŸŸå’Œç”Ÿæˆå™¨ä¹‹é—´çš„ä¸€äº›ä¸è‰¯äº¤äº’ã€‚\nä¸€ç§é™å®šå–æ¶ˆä½œç”¨åŸŸè¾¹ç•Œçš„æ–¹æ³•ã€‚Python çš„ with å·¥ä½œå¾—å¾ˆå¥½ï¼Œå…¶ä»–çš„é€‰é¡¹åŒ…æ‹¬ä¸“é—¨çš„è¯­æ³•ï¼Œæˆ–è€…å°†å–æ¶ˆä½œç”¨åŸŸé™åˆ¶åœ¨å•ç‹¬çš„å‡½æ•°è°ƒç”¨ä¸­ï¼Œæ¯”å¦‚ with_timeout(10, some_fn, arg1, arg2)ï¼ˆå°½ç®¡è¿™å¯èƒ½ä¼šè¿«ä½¿äººä»¬è¿›è¡Œåˆ«æ‰­çš„é‡æ„ï¼Œè€Œä¸”ä½ éœ€è¦æƒ³å‡ºä¸€ç§åŠæ³•æ¥æš´éœ²å–æ¶ˆä½œç”¨åŸŸå¯¹è±¡ï¼‰ã€‚\nä¸€ä¸ªåœ¨è¶…æ—¶/å–æ¶ˆå‘ç”Ÿåï¼Œèƒ½å¤Ÿå°†æ ˆå›å·åˆ°é€‚å½“çš„å–æ¶ˆä½œç”¨åŸŸçš„ç­–ç•¥ã€‚åœ¨è¿™ç‚¹ä¸Šï¼Œå¼‚å¸¸èƒ½å¤Ÿå¾ˆå¥½åœ°å·¥ä½œï¼Œåªè¦ä½ æœ‰åŠæ³•åœ¨å–æ¶ˆä½œç”¨åŸŸçš„è¾¹ç•Œä¸Šæ•æ‰å®ƒä»¬ \u0026ndash; è¿™ä¹Ÿæ˜¯ Python çš„ with å—åœ¨è¿™æ–¹é¢å·¥ä½œå¾—å¦‚æ­¤å‡ºè‰²çš„å¦ä¸€ä¸ªåŸå› ã€‚ä½†æ˜¯å¦‚æœä½ çš„è¯­è¨€ä½¿ç”¨ï¼Œæ¯”å¦‚è¯´ï¼Œé”™è¯¯ç è¿”å›è€Œä¸æ˜¯å¼‚å¸¸ï¼Œé‚£ä¹ˆæˆ‘ç¡®ä¿¡ä½ å¯ä»¥ä»ä¸­å»ºç«‹ä¸€ç§å †æ ˆå›å·çš„çº¦æŸã€‚\nä¸€ä¸ªå…³äºå¦‚ä½•å°†å–æ¶ˆä½œç”¨åŸŸå’Œä½ çš„å¹¶å‘ API ç»“åˆçš„æ•…äº‹ã€‚å½“ç„¶ï¼Œæœ€ç†æƒ³çš„æ˜¯åƒ Trio çš„ nursery ç³»ç»Ÿé‚£æ ·çš„ä¸œè¥¿ï¼ˆå®ƒä¹Ÿæœ‰å¾ˆå¤šå…¶ä»–çš„ä¼˜ç‚¹ï¼Œä½†é‚£æ˜¯å¦ä¸€ç¯‡åšå®¢çš„å†…å®¹äº†ï¼‰ã€‚ä½†å³ä½¿æ²¡æœ‰è¿™ä¸ªï¼Œä½ ä¹Ÿå¯ä»¥è®¤ä¸ºåœ¨ä¸€ä¸ªå–æ¶ˆä½œç”¨åŸŸå†…äº§ç”Ÿçš„ä»»ä½•æ–°ä»»åŠ¡éƒ½ä¼šç»§æ‰¿è¯¥å–æ¶ˆä½œç”¨åŸŸï¼Œæ— è®ºä»–ä»¬ä½•æ—¶å®Œæˆï¼ˆé™¤éå®ƒä»¬é€‰æ‹©ä½¿ç”¨ç±»ä¼¼ä¸Šè¿°çš„å±è”½åŠŸèƒ½æ¥è¿›è¡Œé€€å‡ºï¼‰ã€‚\nä¸€äº›ç”¨äºç¡®å®šå“ªäº›æ“ä½œæ˜¯å¯ä»¥å–æ¶ˆçš„ï¼Œå¹¶ä¸”å°†å…¶ä¼ è¾¾ç»™ç”¨æˆ·ã€‚å¦‚ä¸Šæ‰€è¿°ï¼Œasync/await å¯ä»¥å®Œç¾åœ°å®ç°è¿™ä¸€ç‚¹ï¼Œä½†å¦‚æœä½ æ²¡æœ‰ä½¿ç”¨ async/awaitï¼Œé‚£ä¹ˆå…¶ä»–çš„çº¦å®šå½“ç„¶ä¹Ÿæ˜¯å¯ä»¥çš„ã€‚å…·æœ‰ä¸°å¯Œçš„é™æ€ç±»å‹ç³»ç»Ÿçš„è¯­è¨€å¯èƒ½ä¼šä»¥æŸç§æ–¹å¼åˆ©ç”¨å®ƒä»¬ã€‚å¯¹æœ€åçš„æƒ…å†µä½ å¯ä»¥å°å¿ƒåœ°å°†å®ƒä»¬å†™åœ¨æ¯ä¸ªå‡½æ•°çš„æ–‡æ¡£ä¸­ã€‚\né›†æˆå–æ¶ˆä½œç”¨åŸŸåˆ°æ‰€æœ‰ä½ å…³å¿ƒçš„é˜»å¡ I/O åŸè¯­ä¸­ã€‚å¦‚æœä½ æ­£åœ¨ä»å¤´å¼€å§‹æ„å»ºä¸€ä¸ªç³»ç»Ÿï¼Œé‚£è¿™ä¸ªæ˜¯ç›¸å½“ç›´æ¥çš„ã€‚å¼‚æ­¥ç³»ç»Ÿåœ¨è¿™æ–¹é¢æœ‰ä¼˜åŠ¿ï¼Œå› ä¸ºå°†æ‰€æœ‰ä¸œè¥¿æ•´åˆåˆ°äº‹ä»¶å¾ªç¯ä¸­å·²ç»è¿«ä½¿ä½ ä»¥æŸç§ç»Ÿä¸€çš„æ–¹å¼æ¥å®ç°æ‰€æœ‰çš„ I/O åŸè¯­ï¼Œè¿™æ˜¯æ·»åŠ ç»Ÿä¸€çš„å–æ¶ˆå¤„ç†çš„ä¸€ä¸ªç»ä½³æ—¶æœºã€‚\nåŒæ­¥ã€å•çº¿ç¨‹çš„ Python ä»£ç  æˆ‘ä»¬æœ€åˆåŠ¨æœºé‡Œçš„ä¾‹å­æ¶‰åŠåˆ°äº† requestsï¼Œä¸€ä¸ªæ™®é€šçš„åŒæ­¥åº“ã€‚è€Œä¸Šé¢å‡ ä¹æ‰€æœ‰çš„ä¸œè¥¿éƒ½åŒæ ·é€‚ç”¨äºåŒæ­¥æˆ–å¹¶å‘çš„ä»£ç ã€‚æ‰€ä»¥æˆ‘è®¤ä¸ºå°è¯•åœ¨è¿™äº›ç»å…¸çš„åŒæ­¥ Python ä»£ç ä¸­åº”ç”¨è¿™äº›æƒ³æ³•æ˜¯éå¸¸æœ‰æ„æ€çš„ã€‚ä¹Ÿè®¸æˆ‘ä»¬å¯ä»¥ä¿®å¤ requests åº“ï¼Œè¿™æ ·å®ƒå°±ä¸å¿…ä¸ºå®ƒçš„ timeout å‚æ•°è¯´æŠ±æ­‰äº†ã€‚\nç„¶è€Œï¼Œæœ‰ä¸€äº›é™åˆ¶æ˜¯æˆ‘ä»¬å¿…é¡»æ¥å—çš„ï¼š\nå®ƒä¼šæ˜¯æ— å¤„ä¸åœ¨çš„ \u0026ndash; åº“å¿…é¡»ç¡®ä¿å®ƒä»¬åªé€‚ç”¨â€œæ”¯æŒè¶…æ—¶èŒƒå›´â€çš„é˜»å¡æ“ä½œã€‚ä¹Ÿè®¸ä»é•¿è¿œæ¥çœ‹ï¼Œæˆ‘ä»¬å¯ä»¥æƒ³è±¡è¿™å°†æˆä¸ºæ ‡å‡†åº“çš„ä¸€éƒ¨åˆ†ï¼Œå¹¶é›†æˆåˆ°æ‰€æœ‰çš„æ ‡å‡†åŸè¯­ä¸­ã€‚ä½†å³ä½¿å¦‚æ­¤ï¼Œä»ç„¶ä¼šæœ‰ç¬¬ä¸‰æ–¹æ‰©å±•åº“ä¸é€šè¿‡æ ‡å‡†åº“æ¥å®Œæˆè‡ªå·±çš„ I/O æ“ä½œã€‚å¦ä¸€æ–¹é¢ï¼Œåƒ requests è¿™æ ·çš„åº“å¯ä»¥è°¨æ…åœ°åªé€‚ç”¨æ”¯æŒè¶…æ—¶èŒƒå›´çš„åº“ï¼Œç„¶ååœ¨æ–‡æ¡£ä¸­å°†è‡ªå·±æ ‡è®°æˆæ”¯æŒè¶…æ—¶èŒƒå›´çš„ï¼ˆè¿™ä¹Ÿè®¸æ˜¯åƒ Trio è¿™æ ·çš„å¼‚æ­¥åº“åœ¨è¶…æ—¶å’Œå–æ¶ˆæ–¹é¢çš„æœ€å¤§ä¼˜åŠ¿ï¼šå¼‚æ­¥æœ¬èº«å¹¶æ²¡æœ‰ä»€ä¹ˆåŒºåˆ«ï¼Œä½†å¼‚æ­¥åº“è¢«è¿«é‡æ–°å®ç°äº†æ‰€æœ‰çš„ I/O åŸè¯­ï¼Œä»¥ä¾¿å®ƒä»¬æ•´åˆåˆ° I/O å¾ªç¯ä¸­ã€‚å¦‚æœä½ æ— è®ºå¦‚ä½•éƒ½è¦é‡æ–°å®ç°ä¸€åˆ‡ï¼Œé‚£ä¹ˆåº”è¯¥å¾ˆå®¹æ˜“èƒ½å®ç°ä¸€ä¸ªä¸€è‡´çš„å¯¹å–æ¶ˆæ“ä½œçš„æ”¯æŒï¼‰ã€‚\næ²¡æœ‰åƒ await é‚£æ ·çš„æ ‡è®°æ¥æ˜¾ç¤ºå“ªäº›æ“ä½œæ˜¯å¯ä»¥å–æ¶ˆçš„ã€‚è¿™æ„å‘³ç€ç”¨æˆ·å°†ä¸å¾—ä¸æ›´åŠ å°å¿ƒï¼Œå¹¶æ£€æŸ¥æ¯ä¸ªå‡½æ•°çš„æ–‡æ¡£ \u0026ndash; ä½†è¿™ä»ç„¶æ¯”ç›®å‰ä½¿è¶…æ—¶æ­£å¸¸å·¥ä½œçš„å·¥ä½œé‡è¦å°ã€‚\nPython çš„åº•å±‚åŒæ­¥åŸè¯­é€šå¸¸åªæ”¯æŒç”±äºè¶…æ—¶è€Œå–æ¶ˆï¼Œè€Œä¸æ˜¯ä»»æ„æ—¶é—´ï¼Œæ‰€ä»¥æˆ‘ä»¬å¯èƒ½æ— æ³•æä¾› cancel_scope.cancel() æ“ä½œã€‚ä½†è¿™ä¸ªé™åˆ¶ä¼¼ä¹å¹¶ä¸å¤ªè‹›åˆ»ï¼Œå› ä¸ºå¦‚æœä½ æœ‰ä¸€ä¸ªå•çº¿ç¨‹çš„åŒæ­¥ç¨‹åºï¼Œè€Œè¿™ä¸ªä½†çº¿ç¨‹è¢«å¡åœ¨æŸä¸ªé˜»å¡è°ƒç”¨ä¸­ï¼Œé‚£ä¹ˆè°ä¼šå»è°ƒç”¨ cancel() å‘¢ï¼Ÿæ€»ç»“ä¸€ä¸‹ï¼šå®ƒä¸å¯èƒ½åƒ Trio æä¾›çš„é‚£æ ·å¥½ï¼Œä½†å®ƒä»ç„¶æ˜¯éå¸¸æœ‰ç”¨çš„ï¼Œè€Œä¸”è‚¯å®šæ¯”æˆ‘ä»¬ç°åœ¨çš„è¦å¥½ã€‚\nå¦‚æœä½ è§‰å¾—è¿™å¬èµ·æ¥å¾ˆæœ‰è¶£ï¼Œå¯ä»¥çœ‹çœ‹æˆ‘å®ç°çš„æ¦‚å¿µéªŒè¯ä»£ç ã€‚\nasyncio è¿™ç¯‡åšæ–‡æœ€åˆçš„åŠ¨æœºä¹‹ä¸€æ˜¯ä¸ Yury è®¨è®ºæˆ‘ä»¬æ˜¯å¦å¯ä»¥å°† Trio çš„ä¸€äº›æ”¹è¿›åº”ç”¨åˆ° asyncio ä¹‹ä¸Šã€‚é€šè¿‡ä¸Šé¢çš„åˆ†ææ¥çœ‹ asyncioï¼Œæœ‰å‡ ä»¶äº‹è®©æˆ‘ä»¬çœ¼å‰ä¸€äº®ï¼š\nåœ¨éšå«çš„æœ‰çŠ¶æ€çš„ä»»æ„è§„æ¨¡çš„å–æ¶ˆä»¤ç‰Œçš„å–æ¶ˆä½œç”¨åŸŸæ¨¡å‹å’Œ asyncio ç›®å‰çš„é¢å‘ä»»åŠ¡çš„è¾¹ç¼˜è§¦å‘çš„å–æ¶ˆä¹‹é—´å­˜åœ¨ä¸€äº›é˜»æŠ—ä¸åŒ¹é…ï¼ˆæ³¨ï¼šimpedence mismatchï¼‰ï¼ˆç„¶å Future å±‚åˆæœ‰ä¸€ä¸ªç¨å¾®ä¸åŒçš„å–æ¶ˆæ¨¡å‹ï¼‰ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦ä¸€äº›æ•…äº‹æ¥è¯´æ˜å¦‚ä½•å°†è¿™äº›èåˆåˆ°ä¸€èµ·ã€‚æˆ–è€…ï¼Œä¹Ÿè®¸æˆ‘ä»¬æœ‰å¯èƒ½å°†ä»»åŠ¡è¿ç§»åˆ°ä¸€ä¸ªæœ‰çŠ¶æ€çš„å–æ¶ˆæ¨¡å‹ï¼Ÿ\nå¦‚æœæ²¡æœ‰æ‰˜å„¿æ‰€ç³»ç»Ÿï¼Œå°±æ²¡æœ‰å¯é çš„æ–¹æ³•åœ¨ä»»åŠ¡é—´ä¼ æ’­å–æ¶ˆï¼Œè€Œä¸”æœ‰å¾ˆå¤šä¸åŒçš„æ“ä½œï¼Œæœ‰ç‚¹åƒäº§ç”Ÿä¸€ä¸ªä»»åŠ¡ï¼Œä½†æ˜¯åœ¨ä¸ç”¨çš„æŠ½è±¡å±‚æ¬¡ä¸Šï¼ˆä¾‹å¦‚ loop.call_soonï¼‰ã€‚ä½ å¯ä»¥åˆ¶å®šä¸€ä¸ªè§„åˆ™ï¼Œä»»ä½•æ–°çš„ä»»åŠ¡æ€»æ˜¯ç»§æ‰¿ä»–ä»¬çš„ spawners çš„å–æ¶ˆä½œç”¨åŸŸï¼Œä½†æˆ‘ä¸ç¡®å®šè¿™æ˜¯å¦æ˜¯ä¸€ä¸ªå¥½ä¸»æ„ \u0026ndash; è¿™éœ€è¦ä¸€äº›æ€è€ƒã€‚\nå¦‚æœæ²¡æœ‰ä¸€ä¸ªé€šç”¨çš„æœºåˆ¶å°†å¼‚å¸¸ä¼ å›å †æ ˆï¼Œå°±æ²¡æœ‰åŠæ³•å°† Cancelled å¼‚å¸¸å¯é åœ°ä¼ å›åŸå§‹ä½œç”¨åŸŸã€‚ä¸€èˆ¬æ¥è¯´ï¼Œasyncio åªæ˜¯æ‰“å°å’Œä¸¢å¼ƒæ¥è‡ª Task çš„æœªå¤„ç†çš„å¼‚å¸¸ã€‚ä¹Ÿè®¸è¿™æ ·å°±å¯ä»¥äº†ï¼Ÿ\nä¸å¹¸çš„æ˜¯ï¼Œasyncio å¤„äºä¸€ä¸ªæœ‰ç‚¹æ£˜æ‰‹çš„ä½ç½®ï¼Œå› ä¸ºå®ƒæ˜¯å»ºç«‹åœ¨ Python ä¸­è¿‡å»åå¹´çš„å¼‚æ­¥ I/O ç»éªŒåŸºç¡€ä¹‹ä¸Šçš„\u0026hellip;\u0026hellip;ç„¶ååœ¨è¿™ä¸ªæ¶æ„è¢«é”å®šä¹‹åï¼Œå®ƒåˆç»™ Python æ·»åŠ äº†æ–°çš„è¯­æ³•ï¼Œä½¿æ‰€æœ‰è¿™äº›ç»éªŒéƒ½å¤±æ•ˆäº†ã€‚ä½†å¸Œæœ›è¿˜æ˜¯æœ‰å¯èƒ½é€‚åº”å…¶ä¸­çš„ä¸€äº›ç»éªŒ \u0026ndash; è‡³å°‘è¦åšå‡ºä¸€äº›å¦¥åã€‚\nå…¶ä»–è¯­è¨€ å¦‚æœä½ åœ¨å·¥ä½œä¸­ä½¿ç”¨äº†å…¶ä»–è¯­è¨€ï¼Œæˆ‘å¾ˆæƒ³å¬å¬å–æ¶ˆä½œç”¨åŸŸæ˜¯å¦‚ä½•é€‚åº”è¿™äº›è¯­è¨€çš„ \u0026ndash; å¦‚æœæœ‰çš„è¯ã€‚ä¾‹å¦‚ï¼Œå¯¹äºé‚£äº›ä¸ä½¿ç”¨å¼‚å¸¸çš„è¯­è¨€ï¼Œæˆ–è€…ç¼ºå°‘ Python with å—æä¾›çš„é‚£ç§ç”¨æˆ·å¯æ‰©å±•è¯­æ³•çš„è¯­è¨€ï¼Œå®ƒè‚¯å®šéœ€è¦ä¸€äº›è°ƒæ•´ã€‚\nç°åœ¨å»ä¿®å¤ä½ çš„è¶…æ—¶ç¼ºé™·å§ï¼ æˆ–è€…å¦‚æœä½ æƒ³é˜…è¯»æ›´å¤šå…³äº Trio çš„ä¿¡æ¯ï¼Œæˆ‘ä»¬æœ‰ä¸€ä¸ªäººä»¬ä¼¼ä¹å¾ˆå–œæ¬¢çš„ã€å‹å¥½çš„æ•™ç¨‹ã€‚\nè¯‘è€…æ³¨ Nathaniel J. Smith å¯¹ç¼–ç¨‹è¯­è¨€é¢†åŸŸçš„å¾ˆå¤šé—®é¢˜éƒ½æœ‰éå¸¸æ·±åˆ»çš„ç†è§£å’Œæ´å¯Ÿï¼Œä»–æå‡ºå¹¶å®è·µäº†ç»“æ„åŒ–å¹¶å‘ï¼Œæ·±åˆ»å½±å“äº†æˆ‘çš„ç¼–ç¨‹ç†å¿µã€‚æœ¬æ–‡å°± I/Oã€å¼‚æ­¥ç³»ç»Ÿä¸­çš„è¶…æ—¶å’Œå–æ¶ˆçš„æœºåˆ¶è¿›è¡Œäº†æ¢è®¨ï¼Œä»ç›¸å¯¹ã€ç»å¯¹è¶…æ—¶ä¸€æ­¥æ­¥å¼•ç”³å‡ºç°ä»£çš„ç†å¿µå–æ¶ˆä»¤ç‰Œï¼Œå¹¶æå‡ºäº†ç¬¦åˆäººç±»ç›´è§‰çš„å–æ¶ˆä½œç”¨åŸŸã€‚\næˆ‘è®¤ä¸ºå–æ¶ˆä½œç”¨åŸŸæ˜¯ä¸€ä¸ªç›¸å½“æ£’çš„æŠ½è±¡ï¼Œä½†å¯æƒœçš„æ˜¯åœ¨è®¸å¤šç°ä»£ç¼–ç¨‹è¯­è¨€ä¸­æ²¡æœ‰æä¾›ç›¸åº”çš„æœºåˆ¶æ¥å¸®åŠ©å®ç°å–æ¶ˆä½œç”¨åŸŸï¼Œä¾‹å¦‚ C++/Rust/Java ç­‰ï¼Œç”šè‡³äºåœ¨ Java ä¸­ç›®å‰åº”ç”¨å–æ¶ˆä»¤ç‰Œä¹Ÿä¸å¤ªç°å®ã€‚å¦å¤–ï¼Œè™½ç„¶æ–‡ä¸­ä¹Ÿæåˆ°äº† Go è¯­è¨€ï¼Œä½†åœ¨ Go ä¸­å› ä¸ºæ²¡æœ‰ goroutine-local å­˜å‚¨ï¼ˆå®˜æ–¹ä¹Ÿä¸æ‰“ç®—æ”¯æŒï¼‰ï¼Œæˆ‘ä»¬ä¹Ÿæ— æ³•å®ç°å–æ¶ˆä½œç”¨åŸŸã€‚\nå°±æˆ‘ä¸ªäººç†è§£ï¼Œå–æ¶ˆä»¤ç‰Œåœ¨å°å¿ƒåœ°ä½¿ç”¨ä¸‹ï¼ˆéµå¾ªä¸€äº›çº¦æŸï¼Œä¾‹å¦‚æœ€ç®€å•çš„æ˜¯åˆ°å¤„ä¼ é€’å®ƒï¼‰ï¼Œå·²ç»å¤§å¤§é™ä½äº†ç¨‹åºçš„å¤æ‚åº¦ã€æå‡äº†é²æ£’æ€§ã€‚åœ¨ Go æ¯”è¾ƒæ–°è®¾è®¡çš„æ¥å£ä¸­ï¼Œæ¶‰åŠåˆ°å¼‚æ­¥ä»»åŠ¡ã€I/O æ“ä½œçš„å‡½æ•°/æ–¹æ³•åŸºæœ¬éƒ½ä¼šæ¥å—ä¸€ä¸ª Context å¯¹è±¡æ¥è¿›è¡Œæ“ä½œçš„å–æ¶ˆï¼Œä½ æœ€å¥½ä¹Ÿè¿™ä¹ˆåšğŸ¤“ã€‚\nå½“ç„¶ä¸Šæ–‡æåˆ°çš„é—®é¢˜è¿˜æ˜¯å­˜åœ¨çš„ï¼Œä»¥ Go ä¸ºä¾‹å­ï¼Œä¿æŒæ—©æœŸç‰ˆæœ¬å…¼å®¹æ€§å¯¼è‡´äº† SPDY ä»£ç å¯¹å–æ¶ˆå¤„ç†ä¸å¥½å¼•å‘äº† goroutine æ³„éœ²é—®é¢˜ã€‚\nå¦å¤–ï¼Œåƒåœ¨ Rust çš„ async/await ä¸‹ï¼Œç”±äº Rust å¼‚æ­¥åŸç†çš„é™åˆ¶ï¼Œå–æ¶ˆå¸¦æ¥çš„é—®é¢˜æ›´åŠ çš„è‡´å‘½ï¼ˆå¯èƒ½ä¼šå¯¼è‡´éé¢„æœŸçš„å¯¹è±¡ææ„ï¼Œå…¸å‹çš„ä¾‹å­æ˜¯ async-iouringï¼‰ã€‚ç°åœ¨åœ¨ async Rust ä¸­åº”ç”¨å–æ¶ˆä¼šæ›´ä¸ºéº»çƒ¦ï¼Œä½ å¯èƒ½éœ€è¦å°å¿ƒåœ°å¤„ç†æŸäº›ä»»åŠ¡ä¸­å–æ¶ˆåçš„çŠ¶æ€ã€‚ä½œä¸ºä¸€ä¸ªä¾‹å­ï¼Œæˆ‘åœ¨ risinglight ä¸­åŸºäº CancellationToken å®ç°äº†å¯éšæ—¶å–æ¶ˆçš„æŸ¥è¯¢ï¼Œå…¶ä¸­å¯¹äºå–æ¶ˆåçš„ä¿®æ”¹å’ŒæŸ¥è¯¢éƒ½éœ€è¦å°å¿ƒåœ°å¤„ç†äº‹åŠ¡çš„çŠ¶æ€ã€‚\nNJS æ–‡ç« çš„è®²è§£è®©æˆ‘å¯¹è¶…æ—¶å’Œå–æ¶ˆæœ‰äº†æ›´æ·±åˆ»çš„ç†è§£ï¼Œä¹ŸåŠ æ·±äº†æˆ‘å¯¹è®¾è®¡ç®€æ´ã€äººç±»å‹å¥½ APIã€ä»£ç çš„ç²¾ç¥çš„å‘å¾€ï¼Œå¸Œæœ›ä½ ä¹Ÿèƒ½æœ‰æ‰€æ”¶è·ï¼\nå…³äºåŸæ–‡æœ‰ä»»ä½•æ¢è®¨æˆ–æƒ³æ³•ï¼Œæ¬¢è¿åœ¨è¯„è®ºåŒºç•™è¨€ã€‚\n","date":"2022-05-07T16:14:00+08:00","image":"https://blog.crazyark.me/p/timeouts-and-cancellation-for-humans/img/bailan1_hu5d12782c2fb4dece080d23c59e5dba7d_78947_120x120_fill_q75_box_smart1.jpeg","permalink":"https://blog.crazyark.me/p/timeouts-and-cancellation-for-humans/","title":"ä»£ç æ‚è°ˆï¼šè¶…æ—¶ä¸å–æ¶ˆï¼ˆè½¬è½½ï¼‰"},{"content":"ç¼˜èµ· ä¿—è¯è¯´çš„å¥½ï¼Œä½œä¸ºä¸€ä¸ªåœ¨æ•°æ®åº“å›¢é˜Ÿåš Kubernetes å¼€å‘çš„åŒå­¦ï¼Œä¸èƒ½åšåˆ°ç¼–å†™ B æ ‘è‡³å°‘è¦åšåˆ°å¿ƒé‡Œæœ‰ B æ•°ã€‚å› æ­¤æœ€è¿‘é—²æš‡æ—¶é—´ä¸€ç›´åœ¨ç ”ç©¶å¯æŒä¹…åŒ–çš„ B æ ‘æ€ä¹ˆå†™ï¼Œæ¥ç€å°±äº†è§£åˆ°äº† BwTreeï¼ˆå¾®è½¯ 14 å¹´æå‡ºçš„æ— é” B æ ‘ï¼‰ï¼Œç„¶åå¼€å§‹æ€è€ƒå…¶ä¸­çš„ mapping table æ€ä¹ˆå®ç°ï¼Œç„¶åå¼€å§‹çœ‹ FasterKVï¼ˆå¾®è½¯ 18 å¹´æå‡ºçš„å¯æŒä¹…åŒ–æ— é” KVï¼‰ï¼Œç„¶åå°±å½»åº•è·‘åäº†\u0026hellip;\næœ¬æ–‡ä¸»è¦è®°å½•æˆ‘æ‹¿ Rust æŠ˜è…¾å‡ ä¸ªæ— é”æ•°æ®ç»“æ„çš„ç»éªŒå’Œæ•™è®­ï¼Œè¿™æ ·ä»¥åä¸è®°å¾—äº†è¿˜èƒ½ç¿»ä¸€ç¿»ï¼Œå¹¶å‘Šè¯‰è‡ªå·±ï¼š\næ²¡äº‹åˆ«çæŠ˜è…¾ä»€ä¹ˆåŠ³ä»€å­æ— é”ç¼–ç¨‹ï¼\næ•°æ®ç»“æ„ é€šå¸¸ï¼Œæ— é”æ•°æ®ç»“æ„çš„å®ç°éƒ½è¦æ±‚æœ‰ä¸€äº›ç‰¹æ®Šçš„ç¡¬ä»¶æ”¯æŒï¼Œä¾‹å¦‚æ”¯æŒåŸå­ CAS ã€LL/SC æŒ‡ä»¤çš„å¤„ç†å™¨ï¼Œæˆ–æ˜¯äº‹åŠ¡å‹å†…å­˜ï¼ˆtransactional memoryï¼‰ã€‚ç›®å‰ï¼Œä¸»æµçš„å¤„ç†å™¨éƒ½å·²ç»æ”¯æŒäº† CAS æ“ä½œï¼Œå› æ­¤å¤§éƒ¨åˆ†æ— é”æ•°æ®ç»“æ„æ˜¯åŸºäº CAS æ“ä½œè®¾è®¡çš„ã€‚é€šå¸¸æ¥è¯´ï¼ŒCAS æ“ä½œåªèƒ½ä½œç”¨äº 32/64 ä½æ•´æ•° \u0026ndash; æ­£å¥½æ”¾ä¸‹ä¸€ä¸ªæŒ‡é’ˆï¼Œå› æ­¤å„ç§æ— é”ç»“æ„éƒ½å›´ç»•ç€æŒ‡é’ˆçš„åŸå­æ“ä½œè€Œè®¾è®¡ã€‚æœ¬æ–‡ä¹Ÿå°†ä¸»è¦ä»‹ç»ä¸€ç§æ— é”é“¾è¡¨åœ¨ Rust ä¸­çš„å®ç°ï¼Œé“¾è¡¨ç®—æ³•ä¸»è¦åŸºäº Zhang et al. åœ¨ 2013 å¹´æå‡ºçš„ä¸€ç§æ— é”æ— åºé“¾è¡¨ [1]ã€‚\næ³¨ï¼šä¹Ÿå­˜åœ¨æ”¯æŒ multi-word CAS çš„ CPUã€‚\næ— é”é“¾è¡¨ï¼ˆUnordered Set) é¦–å…ˆä»‹ç»ä¸€ä¸‹ä¸Šè¿°æåˆ°çš„æ— é”é“¾è¡¨ï¼Œå®ƒå…¶å®æ˜¯ä¸€ä¸ªç»“æ„ä¸ºå•å‘é“¾è¡¨çš„æ— åºé›†åˆï¼ŒåŒ…å«ä»¥ä¸‹ 3 ç§æ“ä½œï¼š\ninsert(k)ï¼Œæ’å…¥ä¸€ä¸ªå…ƒç´  k å¹¶è¿”å›æ˜¯å¦æˆåŠŸï¼› remove(k)ï¼Œåˆ é™¤ä¸€ä¸ªå…ƒç´  k å¹¶è¿”å›æ˜¯å¦æˆåŠŸï¼› contains(k)ï¼Œåˆ¤æ–­ä¸€ä¸ªå…ƒç´  k æ˜¯å¦åœ¨é›†åˆï¼ˆé“¾è¡¨ï¼‰ä¸­ï¼› é“¾è¡¨çš„èŠ‚ç‚¹å’Œæ•´ä½“ç»“æ„å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š\nLock Free Linked List å…¶ä¸­æ¯ä¸ªèŠ‚ç‚¹é™¤äº†åŒ…å«æœ¬èº«çš„å…ƒç´ ä»¥å¤–ï¼Œè¿˜æœ‰ä¸¤ä¸ªåŸå­å˜é‡ï¼š\nstateï¼Œä»£è¡¨äº†å½“å‰èŠ‚ç‚¹çš„çŠ¶æ€ï¼Œè®ºæ–‡ä¸­çŠ¶æ€çš„å®šä¹‰æœ‰ 4 ç§ï¼š DATï¼Œè¡¨ç¤ºå¯è§çš„å…ƒç´ ï¼ˆèŠ‚ç‚¹ï¼‰ INSï¼Œè¡¨ç¤ºæ’å…¥ä¸­çš„å…ƒç´  REMï¼Œè¡¨ç¤ºåˆ é™¤ä¸­çš„å…ƒç´  INVï¼Œè¡¨ç¤ºæ— æ•ˆçš„å…ƒç´ ï¼ˆèŠ‚ç‚¹ï¼‰ nextï¼Œå­˜å‚¨äº†ä¸‹ä¸€ä¸ªèŠ‚ç‚¹çš„æŒ‡é’ˆ å’Œé€šå¸¸çš„å•å‘é“¾è¡¨ä¸€æ ·ï¼Œé“¾è¡¨æœ‰ä¸€ä¸ª head æŒ‡é’ˆæŒ‡å‘é“¾è¡¨å¤´ï¼Œç„¶åé€šè¿‡èŠ‚ç‚¹ä¸Š next ä¸­å­˜å‚¨çš„æŒ‡é’ˆä¸²è”èµ·æ¥ã€‚å½“éœ€è¦æ’å…¥ä¸€ä¸ªæ–°èŠ‚ç‚¹çš„æ—¶å€™ï¼Œä½¿ç”¨ CAS åŸå­æ“ä½œå°† head ä¿®æ”¹ä¸ºæ–°èŠ‚ç‚¹çš„åœ°å€ï¼Œå¦‚å›¾æ‰€ç¤ºã€‚å½“ç„¶ CAS æ“ä½œæ˜¯å¯èƒ½ä¼šå¤±è´¥çš„ï¼Œæ­¤æ—¶æˆ‘ä»¬åªéœ€è¦é‡æ–°è¿›è¡Œå›¾ä¸­çš„æ­¥éª¤ã€‚Rust ä»£ç å¤§è‡´å¦‚ä¸‹ï¼š\nfn enlist(\u0026amp;self, node_ptr: SharedNodePtr\u0026lt;E\u0026gt;, g: \u0026amp;Guard) { debug_assert!(!node_ptr.is_null()); let node = unsafe { node_ptr.deref() }; let mut head_ptr = self.head.load(Ordering::Acquire, g); loop { // Set node.next to untagged(head). node.next.store(head_ptr.with_tag(0), Ordering::Release); match self.head.compare_exchange( // Keep head\u0026#39;s tag. head_ptr, node_ptr.with_tag(head_ptr.tag()), Ordering::AcqRel, Ordering::Acquire, g ) { Ok(_) =\u0026gt; return, Err(err) =\u0026gt; head_ptr = err.current, } } } å‡å¦‚ä¸è€ƒè™‘é“¾è¡¨èŠ‚ç‚¹çš„åˆ é™¤ï¼ŒåŸºäºæ— é”é“¾è¡¨çš„æ— åºé›†åˆå…¶å®å¾ˆå®¹æ˜“å®ç° \u0026ndash; æ·»åŠ åªéœ€è¦åœ¨é“¾è¡¨å¤´æ’å…¥å¯¹åº”å…ƒç´ çš„èŠ‚ç‚¹ (DAT)ï¼Œåˆ é™¤åŒæ ·æ’å…¥ä¸€ä¸ªèŠ‚ç‚¹ï¼Œåªä¸è¿‡æ ‡è®°çŠ¶æ€ä¸ºåˆ é™¤ (REM)ã€‚é›†åˆå…ƒç´ çš„æŸ¥æ‰¾åªè¦é¡ºåºéå†é“¾è¡¨ï¼Œç›´åˆ°æ‰¾åˆ°ç¬¬ä¸€ä¸ªæ‹¥æœ‰ç›¸åŒå…ƒç´ çš„èŠ‚ç‚¹ï¼Œé‚£ä¹ˆèŠ‚ç‚¹çš„çŠ¶æ€å°±æ˜¯å…ƒç´ çš„å­˜åœ¨çŠ¶æ€ã€‚è¿™ç§ç®€å•çš„æ–¹å¼æ˜¾ç„¶æœ‰ä¸€ä¸ªæ¯”è¾ƒå¤§çš„é—®é¢˜ï¼Œé‚£å°±æ˜¯é“¾è¡¨ä¼šè¶Šæ¥è¶Šé•¿ï¼Œè€Œé›†åˆæ“ä½œçš„å¤æ‚åº¦å’Œé“¾è¡¨é•¿åº¦æ˜¯æ­£ç›¸å…³çš„ã€‚å› æ­¤ Zhang et al. æå‡ºçš„ç®—æ³•å¼•å…¥äº† INS å’Œ INV ä¸¤ç§çŠ¶æ€ï¼Œå¹¶åŒ…å«äº†èŠ‚ç‚¹çš„åˆ é™¤æ“ä½œã€‚\nåœ¨ä¸Šè¿° 3 ç§æ“ä½œä¸­ï¼Œcontains æ˜¯ä¸€ä¸ªåªè¯»æ“ä½œï¼Œå› æ­¤å®ç°å®ƒåªéœ€è¦æŒ‰ç…§é“¾è¡¨æ— è„‘å‘ä¸‹å¯»æ‰¾å°±å¯ï¼Œç›´åˆ°æ‰¾åˆ°ç¬¬ä¸€ä¸ªå¯è§çš„å…ƒç´ ã€‚åœ¨ä¸è€ƒè™‘ GC çš„æƒ…å†µä¸‹ï¼Œåªè¯»æ“ä½œæ°¸è¿œéƒ½èƒ½æ­£å¸¸è¿è¡Œã€‚å¦å¤–ä¸¤ä¸ªæ“ä½œæ˜¯æ¯”è¾ƒç±»ä¼¼çš„ï¼šå®ƒä»¬éƒ½åœ¨é“¾è¡¨å¤´æ’å…¥äº†ä¸€ä¸ªåŒ…å«äº†å¯¹åº”å…ƒç´ çš„èŠ‚ç‚¹ï¼Œç„¶åä»è¯¥èŠ‚ç‚¹å¼€å§‹å¾€åæ¢æŸ¥æ˜¯å¦æ“ä½œæˆåŠŸã€‚ç®—æ³•æµç¨‹å¤§è‡´ä¸ºï¼š\ninsert æ’å…¥çŠ¶æ€ä¸º INS çš„èŠ‚ç‚¹ï¼Œå¹¶å‘åæ‰¾åˆ°ç¬¬ä¸€ä¸ªå…ƒç´ ç›¸åŒçš„èŠ‚ç‚¹ èŠ‚ç‚¹çŠ¶æ€ä¸º INS æˆ–è€… DAT åˆ™è¡¨æ˜é“¾è¡¨ä¸­å·²ç»å­˜åœ¨è¯¥å…ƒç´ äº†ï¼Œè¡¨æ˜æ’å…¥å¤±è´¥ï¼› èŠ‚ç‚¹çŠ¶æ€ä¸º REM åˆ™è¡¨æ˜é“¾è¡¨ä¸­è¯¥å…ƒç´ å·²ç»è¢«åˆ é™¤äº†ï¼Œè¡¨æ˜æ’å…¥æˆåŠŸï¼› èŠ‚ç‚¹çŠ¶æ€ä¸º INV çš„å¿½ç•¥ï¼› æœªæ‰¾åˆ°ï¼Œåˆ™æ’å…¥æˆåŠŸï¼› remove æ’å…¥çŠ¶æ€ä¸º REM çš„èŠ‚ç‚¹ï¼Œå¹¶å‘åæ‰¾åˆ°ç¬¬ä¸€ä¸ªå…ƒç´ ç›¸åŒçš„èŠ‚ç‚¹ èŠ‚ç‚¹çŠ¶æ€ä¸º REM åˆ™è¡¨æ˜é“¾è¡¨ä¸­è¯¥å…ƒç´ å·²ç»è¢«åˆ é™¤äº†ï¼Œè¡¨æ˜åˆ é™¤å¤±è´¥ï¼› èŠ‚ç‚¹çŠ¶æ€ä¸º INS åˆ™è¡¨æ˜æœ‰å¦ä¸€ä¸ªçº¿ç¨‹æ­£åœ¨æ’å…¥è¯¥å…ƒç´ ï¼Œå°è¯•ä½¿ç”¨ CAS æ ‡è®°ä¸º REMï¼› æˆåŠŸï¼Œè¡¨æ˜åˆ é™¤æˆåŠŸï¼› å¤±è´¥ï¼Œåˆ™é‡æ–°è¯»å–èŠ‚ç‚¹çŠ¶æ€é‡è¯•ï¼› èŠ‚ç‚¹çŠ¶æ€ä¸º INV çš„å¿½ç•¥ï¼› èŠ‚ç‚¹çŠ¶æ€ä¸º DAT åˆ™å°è¯•ç”¨ CAS æ ‡è®°ä¸º INVï¼ŒCAS çš„æˆåŠŸ/å¤±è´¥ä»£è¡¨åˆ é™¤çš„æˆåŠŸ/å¤±è´¥ï¼› åœ¨æ’å…¥å’Œåˆ é™¤çš„å‘åæŸ¥æ‰¾è¿‡ç¨‹ä¸­ï¼Œå¦‚æœé‡åˆ° INV çš„æ— æ•ˆèŠ‚ç‚¹ï¼Œåˆ™ä¼šå°è¯•ä½¿ç”¨ CAS åˆ é™¤è¯¥èŠ‚ç‚¹ï¼Œä»è€Œè¾¾åˆ°ç¼©çŸ­é“¾è¡¨çš„ç›®çš„ã€‚\nCAS(prev.next, cur_ptr, cur.next) åœ¨åŸºäº CAS çš„æ— é”é“¾è¡¨ç®—æ³•ä¸­ï¼Œé€šå¸¸ä¼šé‡åˆ°ä¸¤ä¸ªé—®é¢˜ï¼š\nABA é—®é¢˜ï¼šå³åœ¨ä¸€ä¸ªçº¿ç¨‹ 1 è¿›è¡ŒåŸå­ CAS æ“ä½œå‰ï¼Œå®ƒçœ‹åˆ°çš„æ˜¯ Aï¼Œæ­¤æ—¶å¦ä¸€ä¸ªçº¿ç¨‹ 2å°†å®ƒä¿®æ”¹ä¸º Bï¼Œç„¶ååˆä¿®æ”¹å› Aï¼Œç„¶åçº¿ç¨‹ 1 å†è¿›è¡Œ CAS æ“ä½œæ—¶å°†ä¼šæˆåŠŸå®Œæˆæ“ä½œå¹¶å¯èƒ½ç ´åæ•°æ®ç»“æ„ï¼› åœ¨æœ¬æ–‡æè¿°çš„ç®—æ³•ä¸­ä¸ä¼šå‡ºç° ABA é—®é¢˜ï¼Œå› ä¸ºå…¶ä¸­çš„ä»»æ„ä¸€ä¸ªåŸå­å˜é‡éƒ½ä¸ä¼šå‡ºç°å€¼å¾ªç¯çš„ä¿®æ”¹ï¼ˆstate æ˜¯æœ‰é¡ºåºçš„ï¼Œnext ä¸€å®šæ˜¯é—´éš”å‘åä¿®æ”¹ï¼Œè€Œé“¾è¡¨ä¸­é—´ä¸ä¼šæœ‰æ’å…¥ï¼‰ï¼› å¹¶å‘åˆ é™¤é—®é¢˜ï¼šå½“é“¾è¡¨ä¸º A -\u0026gt; B -\u0026gt; C -\u0026gt; D æ—¶ï¼Œçº¿ç¨‹ 1 å’Œçº¿ç¨‹ 2 å¹¶å‘åˆ é™¤ B å’Œ C å¯èƒ½ä¼šå¯¼è‡´ C çš„åˆ é™¤æ— æ•ˆåŒ–/è¢«å–æ¶ˆï¼š æ— æ•ˆåŒ–ï¼šçº¿ç¨‹ 1 åˆ é™¤ Bï¼Œæ­¤æ—¶é“¾è¡¨ä¸º A -\u0026gt; C -\u0026gt; Dï¼Œæ­¤æ—¶é“¾è¡¨ 2 çœ‹åˆ°çš„é“¾è¡¨è¿˜æ˜¯ B -\u0026gt; C -\u0026gt; Dï¼Œå®ƒå°† B.next è®¾ç½®ä¸º D å¯¹åŸé“¾è¡¨æ— å½±å“ï¼› è¢«å–æ¶ˆï¼šçº¿ç¨‹ 1 è¯»å– B.next ä¸º Cï¼Œæ­¤æ—¶ çº¿ç¨‹ 2 åˆ é™¤ Cï¼Œé“¾è¡¨ä¸º A -\u0026gt; B -\u0026gt; Dï¼Œç„¶åçº¿ç¨‹ 1 æ‰§è¡Œ CAS(A.next, B, C) æˆåŠŸï¼Œé“¾è¡¨åˆæ¢å¤åˆ°äº† A -\u0026gt; C -\u0026gt; Dï¼› å¹¶å‘åˆ é™¤é—®é¢˜åœ¨è¯¥ç®—æ³•ä¸­æ˜¯å­˜åœ¨çš„ï¼Œä½†æ˜¯å¹¶ä¸å½±å“æ­£ç¡®æ€§ï¼Œå› ä¸ºè¢«åˆ é™¤çš„èŠ‚ç‚¹ä¸€å®šæ˜¯ INV çŠ¶æ€çš„ï¼Œè€Œè¯¥çŠ¶æ€çš„èŠ‚ç‚¹ä¸ä¼šå½±å“ä»»ä½•æ“ä½œï¼› åœ¨ Java ç­‰ GC è¯­è¨€ä¸­ï¼Œå¹¶å‘åˆ é™¤é—®é¢˜å¹¶ä¸æ˜¯ä¸€ä¸ªå¤§é—®é¢˜ã€‚è€Œåœ¨æ—  GC çš„è¯­è¨€ä¸­ï¼Œå¹¶å‘åˆ é™¤ä¼šè®©èŠ‚ç‚¹ GC å˜å¾—æ›´éš¾ï¼Œè¿™åœ¨åç»­çš„ GC å°èŠ‚ä¸­ä¼šè¿›è¡Œåˆ†æå¹¶æå‡ºè§£å†³æ–¹æ¡ˆã€‚\nä¸Šè¿°ç®—æ³•ä¸‰ä¸ªæ“ä½œçš„æ—¶é—´å¤æ‚åº¦éƒ½æ˜¯ O(n) çš„ï¼Œå› æ­¤åœ¨é›†åˆå¤§çš„æ—¶å€™æ€§èƒ½ä¸æ˜¯å¾ˆå¥½ã€‚åŒæ ·ï¼ŒæŒ‡é’ˆæœ¬èº«ä¼šå¸¦æ¥å·¨é‡çš„ cpu cache missï¼Œå› æ­¤æ— é”ç®—æ³•é€šå¸¸å•çº¿ç¨‹æ€§èƒ½æ¯”æ™®é€šçš„éå¹¶å‘ç®—æ³•è¦å·®çš„å¤šã€‚\næ— é”å“ˆå¸Œè¡¨ åœ¨å“ˆå¸Œè¡¨ä¸­é€šå¸¸ä½¿ç”¨é“¾è¡¨æ¥è§£å†³å“ˆå¸Œå†²çªçš„é—®é¢˜ï¼Œé‚£å½“æˆ‘ä»¬æ‹¥æœ‰ä¸€ä¸ªæ— é”é“¾è¡¨ï¼Œè‡ªç„¶è€Œç„¶çš„å¯ä»¥æ„å»ºä¸€ä¸ªæ— é”çš„å“ˆå¸Œè¡¨ï¼Œå®ƒåŒ…å«ä»¥ä¸‹å‡ ä¸ªæ“ä½œï¼š\nput(k, v)ï¼Œå°† k æ˜ å°„åˆ° v remove(k)ï¼Œåˆ é™¤ k ä¸Šçš„æ˜ å°„ get(k)ï¼Œè·å– k ä¸Šæ˜ å°„çš„å€¼ æ˜¾ç„¶ï¼Œæˆ‘ä»¬åªéœ€è¦å’Œæ™®é€šçš„å“ˆå¸Œè¡¨ä¸€æ ·å‡†å¤‡ä¸€ç»„ bucketsï¼Œæ¯ä¸€ä¸ª bucket æŒ‡å‘ä¸€ä¸ªæ— é”é“¾è¡¨å°±å¯ä»¥è½»æ¾åœ°æ„å»ºå‡ºä¸€ä¸ªæ— é”å“ˆå¸Œè¡¨ã€‚è¿™æ ·çš„æ— é”å»ºç«‹åœ¨æ— æ³•å¢åŠ æˆ–æ˜¯å‡å°‘ buckets çš„åŸºç¡€ä¸Šã€‚åœ¨ SIGMOD 2018 ä¸Šå¾®è½¯å‘è¡¨äº†å…³äº FasterKV çš„è®ºæ–‡[3]ä¸­æåˆ°ï¼Œé€šè¿‡ç»“åˆ epoch æ¡†æ¶æå‡ºäº†ä¸€ç§æ— é”æ‰©ç¼©å®¹çš„æ–¹å¼ï¼ŒæŒ‰ç…§æˆ‘çš„ç†è§£ä»ç„¶æ˜¯ä¸€ä¸ªå˜ç›¸çš„è‡ªæ—‹é”ï¼Œè¿™é‡Œä¸åšè¯¦ç»†ä»‹ç»ã€‚\nä¸ºäº†è¿›è¡Œå®éªŒï¼Œæˆ‘ä¹Ÿç”¨ Rust å®ç°äº† FasterKV çš„å†…å­˜ç‰ˆæœ¬ï¼ˆä¸å¸¦æ‰©ç¼©å®¹çš„èƒ½åŠ›ï¼‰ï¼Œåœ¨å®ç°å°èŠ‚ä¸­ä¼šå‘ˆç°å®éªŒç»“æœã€‚\nåƒåœ¾å›æ”¶ï¼ˆGC) ç°ä»£çš„é«˜çº§ç¼–ç¨‹è¯­è¨€é€šå¸¸éƒ½ä¼šæä¾›å†…å­˜ GC çš„èƒ½åŠ›ï¼Œä¾‹å¦‚ Javaã€Goã€Python ä»¥åŠä¸€ä¼—åŸºäº JVM çš„è¯­è¨€ç­‰ç­‰ã€‚åªæœ‰ä¸€äº›åå‘åº•å±‚çš„â€œå€’éœ‰â€è¯­è¨€æ‰æ²¡æœ‰ GCï¼ŒRust æ˜¯å±äºæ–°æ™‹çš„è¿™ä¸€ç±»ç¼–ç¨‹è¯­è¨€ä¹‹ä¸€ã€‚åœ¨ Rust ä¸­ï¼Œç¼–è¯‘å™¨ä¼šè‡ªåŠ¨å°†å†…å­˜é‡Šæ”¾çš„ç›¸å…³ä»£ç ç¼–ç»‡åˆ°ç¨‹åºä¸­ï¼Œè¿™ç§æ–¹å¼å¤§çº¦æ˜¯å€Ÿé‰´çš„ C++ çš„ RAIIã€‚ä½†æ˜¯åœ¨æ— é”æ•°æ®ç»“æ„ä¸­ï¼Œå¹¶å‘è®¿é—®ä¼šå¸¦æ¥ä¸€ä¸ªé¢å¤–çš„é—®é¢˜ï¼šä»€ä¹ˆæ—¶å€™å¯¹è±¡ä»¥åŠå®ƒçš„å†…å­˜æ‰æ˜¯å¯ä»¥å®‰å…¨å›æ”¶çš„ï¼Ÿ\nè€ƒè™‘è¿™æ ·ä¸€ä¸ªåœºæ™¯ï¼šçº¿ç¨‹ 1 åˆ é™¤äº†é“¾è¡¨ä¸­çš„ä¸€ä¸ªèŠ‚ç‚¹ï¼Œä½†çº¿ç¨‹ 2 æ­¤æ—¶è¿˜åœ¨è®¿é—®è¿™ä¸ªèŠ‚ç‚¹ï¼Œè¿™åœ¨æ— é”å¹¶å‘åœºæ™¯ä¸‹æ˜¯æˆç«‹çš„ã€‚æ­¤æ—¶ï¼Œè¿™ä¸ªèŠ‚ç‚¹è¿˜ä¸èƒ½è¢«å®‰å…¨å›æ”¶ï¼Œä½†æˆ‘ä»¬éƒ½çŸ¥é“å®ƒæœ€ç»ˆå°†ä¸å¯èƒ½è¢«è®¿é—®åˆ°ã€‚å› æ­¤æ— é”æƒ…å†µä¸‹çš„åƒåœ¾å›æ”¶æ–¹æ³•ä¸»è¦éœ€è¦è§£å†³çš„é—®é¢˜æ˜¯ï¼šå¦‚ä½•æ‰¾åˆ°ä¸€ä¸ªæ—¶åˆ»ï¼Œæ­¤æ—¶è¢«åˆ é™¤çš„å¯¹è±¡å·²ç»ä¸å¯èƒ½åœ¨è®¿é—®åˆ°äº†ã€‚è‘—åçš„ GC æ–¹æ³•æœ‰ QSBRï¼ˆQuiescent-state-based Reclaimationï¼‰ã€EBRï¼ˆEpoch-based Reclaimationï¼‰å’Œ HPBRï¼ˆHazard-pointer-based Reclaimationï¼‰ç­‰ï¼Œæœ¬æ–‡ä¸»è¦ä»‹ç»å’Œä½¿ç”¨å…¶ä¸­çš„ EBR è¿™ä¸€ç§æ–¹æ³•ã€‚\nEpoch-based Reclaimation EBR çš„ä¸»è¦æ€è·¯æ˜¯å°†æ“ä½œåˆ†ä»£ï¼ˆepochï¼‰ï¼Œåœ¨ epoch ä¸æ–­æ¨è¿›çš„è¿‡ç¨‹ä¸­ä¿è¯åœ¨è€ epoch ä¸­åˆ é™¤çš„å¯¹è±¡åœ¨æ–°çš„ epoch ä¸­ä¸å¯èƒ½å†è¢«è®¿é—®åˆ°ï¼Œä»è€Œæ‰¾åˆ°ä¸€ä¸ªå®‰å…¨çš„æ—¶åˆ»å»å›æ”¶å¯¹è±¡ã€‚EBR çš„å·¥ä½œæ–¹å¼å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š\nEpoch GC é€šå¸¸çš„ EBR å®ç°æ–¹å¼ä¸­ï¼š\nå…¨å±€æœ‰ä¸€ä¸ªå”¯ä¸€çš„ epochï¼Œå®ƒä¼šä¸æ–­åœ°å¢é•¿ï¼Œå¹¶ä¸”åœ¨å¢é•¿æ—¶åŠ  memory fence ä¿è¯ä¹‹å‰çš„æ‰€æœ‰ä¿®æ”¹å¯è§ï¼› æ¯ä¸ªçº¿ç¨‹åœ¨æ“ä½œæ—¶è¿›å…¥å½“å‰ epochï¼Œåœ¨ç»“æŸæ—¶é€€å‡ºå½“å‰ epochï¼Œå®ç°ä¸Šæ¥è¯´å°±æ˜¯æ¯ä¸ªçº¿ç¨‹ç»´æŠ¤ä¸€ä¸ªæœ¬åœ°çš„ epochï¼Œåœ¨æ¯æ¬¡æ“ä½œæ—¶è¿›è¡ŒåŒæ­¥ï¼› ä¸ºäº†æ•ˆç‡è€ƒè™‘ï¼ŒçœŸæ­£å®ç°æ—¶å¯ä»¥åœ¨æ•°æ¬¡æ“ä½œåå†åŒæ­¥ï¼› åœ¨çº¿ç¨‹ä»æ— é”æ•°æ®ç»“æ„ä¸­åˆ é™¤ä¸€ä¸ªå¯¹è±¡æ—¶ï¼Œå°†è¿™ä¸ªå¯¹è±¡åŠ åˆ° retire åˆ—è¡¨ä¸­ï¼Œå¹¶æ ‡è®°å›æ”¶ epoch ä¸ºå½“å‰çš„å…¨å±€ epochï¼ŒåŒæ—¶å°è¯•æŠ¬é«˜å…¨å±€ epochï¼› åŒæ ·æ•ˆç‡èµ·è§ï¼Œå®ç°æ—¶å¯ä»¥åœ¨æ•°æ¬¡æ“ä½œåå†æŠ¬é«˜å…¨å±€ epochï¼› æ˜¾ç„¶ï¼Œåœ¨ epoch æŠ¬é«˜ä¹‹åï¼Œä¹‹å‰çš„åˆ é™¤æ“ä½œéƒ½åº”è¯¥å¯¹æ‰€æœ‰çº¿ç¨‹å¯è§äº†ï¼Œé‚£ä¹ˆåªè¦æ‰€æœ‰çš„çº¿ç¨‹éƒ½é€€å‡ºäº†åˆ é™¤å‘ç”Ÿçš„ epochï¼Œå°±ä¸€å®šèƒ½å®‰å…¨åœ°å›æ”¶é‚£äº›è¢«åˆ é™¤çš„å¯¹è±¡ã€‚å› æ­¤ï¼Œå®‰å…¨ epochï¼ˆåœ¨å°äºç­‰äºè¿™ä¸ª epoch çš„åˆ é™¤çš„å¯¹è±¡å¯ä»¥å®‰å…¨å›æ”¶ï¼‰çš„æ˜¯æ‰€æœ‰çº¿ç¨‹çš„æœ¬åœ° epoch ä¸­æœ€å°çš„é‚£ä¸ªå‡ 1ã€‚è¿™ç§ç­–ç•¥ä¸‹å…¨å±€ epoch å¯èƒ½ä¼šå¾ˆå¿«åœ°å¢é•¿ä¸Šå»ï¼Œå› æ­¤è¿˜æœ‰å¦å¤–ä¸€ç§æ–¹å¼ï¼šåœ¨æŠ¬é«˜å…¨å±€ epoch æ—¶ï¼Œæ£€æŸ¥æ˜¯å¦æ‰€æœ‰çº¿ç¨‹çš„æœ¬åœ° epoch éƒ½å·²ç»ç­‰äºå…¨å±€ epoch äº†ï¼Œå¦‚æœæ˜¯æ‰è¿›è¡ŒæŠ¬é«˜ã€‚å› ä¸ºåœ¨è¿™ç§æƒ…å†µä¸‹å…¨å±€ epoch å’Œæœ¬åœ° epoch æœ€å¤šå·®ä¸è¶…è¿‡ 1ï¼Œå› æ­¤å®‰å…¨ epoch å¯ä»¥ç®€å•çš„ç”¨å…¨å±€ epoch å‡ 2 æ¥è®¡ç®—ã€‚åœ¨è¿™ç§ç­–ç•¥ä¸‹ä¹Ÿå¯ä»¥å°† epoch ç®€åŒ–æˆåªæœ‰ 3 ä»£ï¼Œå¯ä»¥å®‰å…¨å›æ”¶çš„é‚£ä¸€ä»£æ˜¯ (å…¨å±€ epoch + 1) % 3ã€‚\næ³¨ï¼šå›¾ä¸­è™½ç„¶ä¹Ÿä¿è¯äº†ä»£å·®ä¸è¶…è¿‡ 1ï¼Œä½†æ˜¯ä½¿ç”¨çš„æ˜¯æœ¬åœ° epoch ä½œä¸º retire çš„ä»£ï¼Œå› æ­¤å®‰å…¨ epoch åº”è¯¥æ˜¯å…¨å±€ epoch - 3ã€‚\nEBR é€šè¿‡åˆ†ä»£çš„æ–¹å¼æœ‰æ•ˆåœ°æ‰¾å‡ºäº†å¯å®‰å…¨å›æ”¶çš„ grace periodï¼Œä½†æ˜¯ä¹Ÿå­˜åœ¨ä¸€äº›é—®é¢˜ï¼š\nå¦‚æœæœ‰ä¸€äº›æ“ä½œæ¯”è¾ƒæ…¢ï¼Œå¯èƒ½ä¼šå¯¼è‡´å®‰å…¨ epoch / å…¨å±€ epochï¼ˆä¸‰ä»£ï¼‰æ— æ³•æ¨è¿›ï¼Œä»è€Œå¯¼è‡´å†…å­˜å§‹ç»ˆæ— æ³•é‡Šæ”¾ï¼› å…¶ä¸­è¿›è¡Œçš„åˆ é™¤æ“ä½œä¸€å®šè¦å®Œå…¨å‘ç”Ÿï¼Œä¸èƒ½è¢«å–æ¶ˆæˆ–æ˜¯å¤±æ•ˆä½¿å¾—åœ¨åç»­çš„æ“ä½œä¸­è¿˜èƒ½å¤Ÿè®¿é—®åˆ°ï¼› ä¸Šæ–‡æè¿°çš„æ— é”é“¾è¡¨åœ¨é…åˆ EBR æ—¶å°±å­˜åœ¨ç¬¬äºŒä¸ªé—®é¢˜ï¼Œå› ä¸ºå¹¶å‘åˆ é™¤ä¼šå¯¼è‡´èŠ‚ç‚¹åˆ é™¤çš„å–æ¶ˆæˆ–è€…å¤±æ•ˆã€‚è¿™é‡Œæ„Ÿè°¢ @zzy590 æŒ‡å‡ºè¿™ä¸ªé—®é¢˜ï¼Œåœ¨å’Œä»–è®¨è®ºåå¾—å‡ºäº†ä¸€ä¸ªè§£å†³åŠæ³• \u0026ndash; åšæŒ‡é’ˆæ ‡è®°ï¼Œä¸¤é˜¶æ®µåˆ é™¤èŠ‚ç‚¹ã€‚æ–¹æ³•å¤§æ¦‚åŸç†ä¸ºï¼š\nåˆ é™¤å‰åœ¨å¯¹åº”èŠ‚ç‚¹çš„ next æŒ‡é’ˆä¸Šåšæ ‡è®°ï¼šCAS(node.next, unmark(next), mark(next))ï¼› ç¦æ­¢åˆ é™¤æ ‡è®°è¿‡çš„èŠ‚ç‚¹çš„ä¸‹ä¸€ä¸ªèŠ‚ç‚¹ï¼Œä¹Ÿå°±æ˜¯ç¦æ­¢äº†ç›¸é‚»çš„å¹¶å‘åˆ é™¤ï¼› åˆ é™¤æ“ä½œçš„ CAS æ”¹ä¸º CAS(prev.next, unmark(cur), unmark(next))ï¼› æ‰€æœ‰çº¿ç¨‹é‡åˆ°æ ‡è®°è¿‡æŒ‡é’ˆçš„èŠ‚ç‚¹éƒ½å¯ä»¥å°è¯•è¿›è¡Œåˆ é™¤æ“ä½œï¼› åˆ é™¤æ“ä½œä¸­é‡åˆ°ç¦æ­¢åˆ é™¤çš„æƒ…å†µåˆ™è·³è¿‡èŠ‚ç‚¹ï¼› åœ¨æ›´æ”¹è¿‡çš„ç®—æ³•ä¸­ï¼Œç›¸é‚»å¹¶å‘åˆ é™¤çš„ä¸€ç§æƒ…å†µå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š\nRemove on Linked List é™¤äº†è¿›è¡Œå¯¹è±¡å›æ”¶ä¹‹å¤–ï¼ŒEBR è¿˜å¯ä»¥æˆä¸ºé˜²æ­¢å…¶ä»–å¹¶å‘è®¿é—®é—®é¢˜çš„æ¡†æ¶ï¼Œä¾‹å¦‚ FasterKV ä¸­å°±ä½¿ç”¨å®ƒæ¥æ¨è¿› Hybrid Log ä¸­ fuzzy regionï¼Œå…·æœ‰æ¯”è¾ƒå¼ºçš„é€šç”¨æ€§ã€‚\nå®ç° æœ€åï¼Œæˆ‘å°†æ–‡ä¸­æ‰€æè¿°åˆ°çš„æ— é”é“¾è¡¨ã€å“ˆå¸Œè¡¨ä½¿ç”¨ Rust è¿›è¡Œäº†å®ç°ã€‚EBR æ¡†æ¶ä½¿ç”¨äº† crossbeam-epoch è¿™ä¸ª crate æä¾›ï¼Œç„¶åå‚è€ƒå†…éƒ¨çš„ç»“æ„å®ç°äº† FasterKV ä¸­æåˆ°çš„å‰ 16 ä½ä½œä¸ºæ ‡è®°ã€å 48 ä½ä½œä¸ºåœ°å€çš„åŸå­æŒ‡é’ˆã€‚\nä»£ç å¼€æ”¾åœ¨ github ä¸Šï¼šhttps://github.com/ruaaadb/lock-freeã€‚æ„Ÿå…´è¶£çš„åŒå­¦å¯ä»¥ä¸‹ä¸‹æ¥ç©ä¸€ä¸‹ã€‚\næ³¨ï¼šç¼–è¯‘è¦æ±‚æœ¬åœ°æœ‰ tcmalloc é“¾æ¥åº“ï¼Œtcmalloc å¯ä»¥é€‚åº”æé«˜çš„æœ¬åœ°å†…å­˜åˆ†é…é€Ÿç‡ã€‚\næˆ‘çš„ Macbook Pro / M1 Pro ä¸Šç®€å•åšäº†ä¸€ä¸‹é“¾è¡¨çš„å®éªŒï¼Œæ€§èƒ½å¦‚ä¸‹æ‰€ç¤ºï¼š\nThreads R=2K, S=1K, L=0% R=2K, S=1K, L=34% R=2K, S=1K, L=80% R=2K, S=1K, L=100% 1 637 ops/ms 649 ops/ms 660 ops/ms 671 ops/ms 2 1060 ops/ms 1094 ops/ms 1196 ops/ms 1312 ops/ms 4 1754 ops/ms 1914 ops/ms 2148 ops/ms 2571 ops/ms 8 2907 ops/ms 3321 ops/ms 4042 ops/ms 4941 ops/ms æ³¨ï¼šR æ˜¯ key rangeï¼ŒS æ˜¯é“¾è¡¨æœŸæœ›é•¿åº¦ï¼ŒL æ˜¯æŸ¥è¯¢æ¯”ä¾‹ï¼Œæµ‹è¯•ä¸­å†™æ˜¯ä¸€åŠåˆ é™¤ä¸€åŠæ’å…¥ã€‚\nå¯ä»¥çœ‹åˆ°æ€§èƒ½å¹¶ä¸æ˜¯ç‰¹åˆ«å¥½ï¼Œä½†å¾—ç›ŠäºèŠ¯ç‰‡çš„è¿›æ­¥ï¼Œå³ä½¿åšäº†ä¸¤é˜¶æ®µåˆ é™¤è¿˜æ˜¯èƒ½åŠæ‰“è®ºæ–‡çš„æ•°æ®ã€‚\nå‚è€ƒæ–‡çŒ® [1] Zhang, Kunlong, et al. \u0026ldquo;Practical non-blocking unordered lists.\u0026rdquo; International Symposium on Distributed Computing. Springer, Berlin, Heidelberg, 2013.\n[2] Harris, Timothy L. \u0026ldquo;A pragmatic implementation of non-blocking linked-lists.\u0026rdquo; International Symposium on Distributed Computing. Springer, Berlin, Heidelberg, 2001.\n[3] Chandramouli, Badrish, et al. \u0026ldquo;Faster: A concurrent key-value store with in-place updates.\u0026rdquo; Proceedings of the 2018 International Conference on Management of Data. 2018.\n[4] https://github.com/crossbeam-rs/crossbeam\n[5] https://en.wikipedia.org/wiki/ABA_problem\n[6] https://www.youtube.com/watch?v=trsmyznC2I8\u0026ab_channel=ACMSIGPLAN\n","date":"2021-11-28T20:44:45+08:00","image":"https://blog.crazyark.me/p/lock-free-linked-list-and-epoch-gc/img/card_hu7135dc73c6958f5f4d22636ae49c04db_104583_120x120_fill_box_smart1_3.png","permalink":"https://blog.crazyark.me/p/lock-free-linked-list-and-epoch-gc/","title":"ä»£ç æ‚è°ˆï¼šæ— é”ç¼–ç¨‹ï¼ˆä¸€ï¼‰"},{"content":" æœ€è¿‘é˜…è¯»çš„å‡ ç¯‡æ–‡ç« éƒ½æ˜¯å›´ç»•ç€ç¼–ç¨‹æ¥çš„ã€‚åœ¨æˆ‘çœ‹æ¥ï¼Œç¼–ç¨‹è¯­è¨€/æ¨¡å‹/æŠ½è±¡çš„ä¸€å¤§é‡è¦ç›®çš„æ˜¯åœ¨ä¿è¯æ ¸å¿ƒåŠŸèƒ½å’Œæ€§èƒ½çš„åŸºç¡€ä¸Šï¼Œè®©å¼€å‘äººå‘˜æ›´å®¹æ˜“åœ°å¼€å‘å‡ºä¸æ˜“å‡ºé”™çš„ã€é«˜æ•ˆçš„ç¨‹åºï¼Œéƒ½æ˜¯ä¸ºäººæœåŠ¡çš„ã€‚å¹¶å‘ç¼–ç¨‹é€šå¸¸è¢«è®¤ä¸ºæ˜¯éš¾ä»¥ç¼–å†™ä¸”å®¹æ˜“å†™å‡ºç¼ºé™·çš„ï¼Œå› æ­¤æˆ‘ä¹Ÿå¸Œæœ›èƒ½æœ‰ä¸€ä¸ªè‰¯å¥½çš„æŠ½è±¡ä½¿å¹¶å‘ç¼–ç¨‹æ›´åŠ çš„å®¹æ˜“ã€‚\nç»“æ„åŒ–å¹¶å‘ï¼ˆStructured Concurrencyï¼‰æ˜¯ä¸€ä¸ªè¿‘å¹´æ¥æ‰è¢«æå‡ºçš„æ¦‚å¿µï¼Œä¸»è¦ç›®çš„æ˜¯æé«˜å¹¶å‘ç¼–ç¨‹çš„ç¡®å®šæ€§ã€è´¨é‡å’Œå¼€å‘æ•ˆç‡ã€‚ç»“æ„åŒ–å¹¶å‘çš„ä¸­å¿ƒæ€æƒ³æ˜¯å¯¹å¹¶å‘çš„æ‰§è¡Œæµè¿›è¡Œå°è£…ï¼Œä½¿å¾—å®ƒä»¬èƒ½å¤Ÿæœ‰ç¡®å®šçš„å…¥å£å’Œå‡ºå£ã€‚\nèµ·åˆæˆ‘æ˜¯åœ¨è°ƒç ” tokio çš„ scope spawn çš„æ—¶å€™äº†è§£åˆ°ç»“æ„åŒ–å¹¶å‘çš„ã€‚åœ¨æ·±å…¥è°ƒç ”ä¹‹åï¼Œæˆ‘è®¤ä¸ºè¿™ç§æ€æƒ³æœ‰åŠ©äºæ›´é«˜æ•ˆåœ°å†™å‡ºæ›´é²æ£’çš„å¹¶å‘ä»£ç ï¼Œå› æ­¤å†³å®šåœ¨æ­¤è¯¦ç»†ä»‹ç»ä¸€ä¸‹å®ƒçš„ç”±æ¥ã€æ€æƒ³å’Œç°çŠ¶ã€‚\næœ¬æ–‡éƒ¨åˆ†å‚è€ƒäº†ç»“æ„åŒ–å¹¶å‘çš„ç»å…¸æ–‡ç« [2]ã€‚è¿™ç¯‡æ–‡ç« ä»‹ç»äº†ä½œè€…å¯¹ç»“æ„åŒ–å¹¶å‘çš„æ€è€ƒå’Œä¸€ä¸ª Python çš„ç»“æ„åŒ–å¹¶å‘å¼€å‘å·¥å…· nurseryï¼Œæ„Ÿå…´è¶£çš„åŒå­¦å¯ä»¥è¯»ä¸€è¯»ã€‚\nç”±æ¥ \u0026ndash; æŠ½è±¡ç ´åè€… ä¸ºäº†ä½¿å¼€å‘è€…èƒ½å¤Ÿé«˜æ•ˆåœ°å¼€å‘ç¨‹åºï¼Œç°ä»£ç¼–ç¨‹è¯­è¨€é€šå¸¸éƒ½éµå¾ªç»“æ„åŒ–ç¼–ç¨‹çš„æ¨¡å¼ï¼Œå¹¶æä¾›äº†è¿™æ ·çš„ä¸€ä¸ªæŠ½è±¡ï¼šä½ å¯ä»¥å°†ç¨‹åºçš„ä¸€éƒ¨åˆ†å½“åšé»‘ç›’æ¥ä½¿ç”¨ï¼Œä¸”æ§åˆ¶æµä¸€å®šéµå¾ª è°ƒç”¨è€… -\u0026gt; é»‘ç›’ -\u0026gt; è°ƒç”¨è€… çš„æ–¹å¼è¿›è¡Œè½¬ç§»ã€‚ä¸¾ä¸ªä¾‹å­ï¼š\n// Go fmt.Println(\u0026#34;Hello world\u0026#34;) æˆ‘ä»¬ä¸éœ€è¦å…³å¿ƒ Println é‡Œé¢åˆ°åº•åšäº†ä»€ä¹ˆï¼Œåªéœ€è¦çŸ¥é“æœ€åå®ƒå®Œæˆè¾“å‡ºä¹‹åä¼šå°†æ§åˆ¶æƒäº¤è¿˜ï¼Œåœ¨è¿™ä¹‹ä¸­å‘ç”Ÿçš„æ‰€æœ‰çš„äº‹æƒ…éƒ½æ˜¯ å—æ§åˆ¶çš„ã€‚è¿™ç§æŠ½è±¡ä½¿å¾—å¼€å‘è€…ä¸éœ€è¦è®°ä½ç¨‹åºçš„æ‰€æœ‰å®ç°ç»†èŠ‚ï¼Œè€Œåªéœ€è¦å…³æ³¨åœ¨æˆ‘ä»¬æƒ³è¦çš„äº‹æƒ…ä¹‹ä¸Šã€‚å¦‚æœæ²¡æœ‰è¿™ä¸ªæŠ½è±¡ï¼Œæˆ‘ä»¬å°±å¿…é¡»äº†è§£ç¨‹åºçš„æ‰€æœ‰ç»†èŠ‚ï¼Œæ˜¾ç„¶å¯¹äºç°ä»£çš„ç¼–ç¨‹å·¥ä½œæ¥è¯´æ˜¯ä¸å¯èƒ½çš„ã€‚\ngoto ç¬¬ä¸€ä¸ªæŠ½è±¡ç ´åè€…å‡ºç°åœ¨ç¼–ç¨‹æ—¶ä»£çš„æ—©æœŸï¼Œæˆ–è€…è¯´å®ƒæ˜¯è¿™ç§æŠ½è±¡çš„åŸå› ä¹‹ä¸€ï¼Œå®ƒå°±æ˜¯å¤§åé¼é¼çš„ gotoã€‚åœ¨ä¸Šä¸ªä¸–çºª 50 å¹´ä»£ï¼Œäººä»¬å¼€å§‹ç ”å‘ä¸€ç±»æ–°çš„ç¼–ç¨‹è¯­è¨€ã€‚æœ‰åˆ«äºæ›´è´´è¿‘æœºå™¨çš„è¯­è¨€ï¼ˆåƒæ±‡ç¼–ï¼‰ï¼Œè¿™ç±»ç¼–ç¨‹è¯­è¨€çš„ç›®çš„æ˜¯è®©äººèƒ½æ›´å¥½åœ°ç¼–å†™ç¨‹åºã€‚å…¶ä¸­ä¸€ç§è¯­è¨€å« FLOW-MATICã€‚\nFLOW-MATIC ä¸­æ²¡æœ‰ ifï¼Œæ²¡æœ‰å¾ªç¯ï¼Œä¹Ÿæ²¡æœ‰å‡½æ•°è°ƒç”¨ï¼Œä½†å®ƒæœ‰ä¸€ä¸ªæ“ä½œå« JUMP \u0026ndash; å¯ä»¥è·³è½¬åˆ°æŒ‡å®šçš„ä»»ä½•ä¸€ä¸ªä½ç½®ã€‚åŒæ ·ï¼ŒFLOW-MATIC ä¸­ä¹Ÿæ²¡æœ‰å‡½æ•°çš„æ¦‚å¿µï¼Œå› æ­¤ä¸€ä¸ªç”¨è¯¥è¯­è¨€ç¼–å†™çš„ç¨‹åºï¼Œå®ƒçš„æ§åˆ¶æµå¯èƒ½é•¿è¿™æ ·[2]\u0026hellip;\nFLOW-MATIC FLOW-MATIC ä¸­çš„ JUMP å°±æ˜¯æœ€æ—©çš„ gotoï¼Œå®ƒä¸å—ä»»ä½•é™åˆ¶ï¼Œå¯ä»¥è·³è½¬åˆ°ä»»ä½•ä½ æƒ³è·³è½¬çš„åœ°æ–¹ã€‚å¯ä»¥æƒ³è§ï¼Œå¦‚æœå­˜åœ¨è¿™ç§ä¸œè¥¿ï¼Œä¸Šè¿°çš„é»‘ç›’æŠ½è±¡å°†ä¸å¤å­˜åœ¨ã€‚å› æ­¤åœ¨åƒ C è¿™ç±»è¿‘ä»£è¯­è¨€é‡Œï¼Œgoto è¢«ä¸¥æ ¼é™åˆ¶åœ¨ä¸€ä¸ªå‡½æ•°å†…ï¼Œä»è€Œä¿è¯äº†æŠ½è±¡çš„æœ‰æ•ˆæ€§ã€‚\ngo ç¬¬äºŒä¸ªæŠ½è±¡ç ´åè€…æ˜¯ç”±å¹¶å‘ç¼–ç¨‹å¸¦æ¥çš„ã€‚åœ¨å¯ä»¥å¹¶å‘çš„ä¸–ç•Œé‡Œï¼Œæ–°å¯åŠ¨ä¸€ä¸ªå¹¶å‘å•å…ƒæ„å‘³ç€åœ¨å½“å‰æ§åˆ¶æµä¹‹å¤–å¦å¤–æœ‰ä¸€æ¡æ–°çš„æ§åˆ¶æµå°†è¦å¼€å§‹æ‰§è¡Œã€‚æˆ‘ä»¬å°†é¢ä¸´å‡ ä¸ªé—®é¢˜ï¼š\næ–°çš„æ§åˆ¶æµä»€ä¹ˆæ—¶å€™è¿è¡Œ/ç»“æŸï¼Ÿ è°æ¥å›æ”¶æ–°æ§åˆ¶æµä½¿ç”¨çš„èµ„æºï¼Ÿ è°æ¥å¤„ç†æ–°æ§åˆ¶æµå¯èƒ½çš„æŠ¥é”™ï¼Ÿ å¯ä»¥ä¸­æ­¢æ–°æ§åˆ¶æµçš„æ‰§è¡Œä¹ˆï¼Ÿ æˆ‘ä»¬ä»¥ Go ä¸ºä¾‹ï¼Œä¸¾ä¸€ä¸ªç®€å•çš„ä¾‹å­ã€‚å‡è®¾æœ‰ä¸€ä¸ªç¬¬ä¸‰æ–¹åº“æä¾›äº†è¿™æ ·ä¸€ç»„ç»“æ„ä½“/å‡½æ•°ï¼š\n// Go type Result struct {} func (r *Result) Read(p []byte) (n int, err error) {} func HttpGet(url string) Result {} å½“æˆ‘ä»¬éµå¾ªæœ€åˆçš„æŠ½è±¡çš„æ—¶å€™ï¼Œæˆ‘ä»¬å¯ä»¥ç›´æ¥çš„åšå‡ºå¦‚ä¸‹ç†è§£ï¼šHttpGet æ˜¯è¯·æ±‚ç»™å®š URL å¹¶è¯»å–ç»“æœè¿”å›ç»™è°ƒç”¨è€…ï¼Œè°ƒç”¨è€…å¯ä»¥é€šè¿‡è°ƒç”¨ Result.read æ¥è·å–ç»“æœçš„å†…å®¹ã€‚åœ¨ç¼–å†™ä»£ç çš„æ—¶å€™ï¼Œæˆ‘ä»¬å°±å¯ä»¥ç®€å•åœ°è°ƒç”¨ HttpGetã€‚\n// Go func JustGet(url string) { lib.HttpGet(url) } å½“ä»£ç å®Œå…¨æ˜¯åŒæ­¥å®ç°çš„æ—¶å€™ï¼Œso far so goodã€‚ç„¶è€Œï¼Œå½“é¢ä¸´å¹¶å‘ç¼–ç¨‹åŸè¯­ go æ—¶ï¼Œäº‹æƒ…ä¸€ä¸‹å­å˜çš„å¤æ‚äº†èµ·æ¥ã€‚å‡è®¾ä¸Šè¿°ç»“æ„ä½“/æ–¹æ³•çš„å®ç°æ˜¯ä¸‹é¢è¿™æ ·çš„ï¼š\n// Go type Result struct { ch chan []byte buf *bytes.Buffer } // Implement io.Reader. func (r *Result) Read(p []byte) (n int, err error) { if r.buf == nil { if buf, ok = bytes.NewBuffer(\u0026lt;-r.ch); ok { r.buf = buf } else { r.buf = \u0026amp;bytes.Buffer{} } } return r.buf.Read(p) } func HttpGet(url string) Result { ch := make(chan []byte) go func() { defer close(ch) resp, err := http.Get(url) if err != nil { return } defer resp.Body.Close() content, err := io.ReadAll(resp.Body) if err != nil { return } ch \u0026lt;- content }() return Result{ ch: ch, } } HttpGet åœ¨æ‰§è¡Œæ—¶å¯åŠ¨äº†ä¸€ä¸ª goroutine ç”¨äºå¼‚æ­¥è¿›è¡Œ HTTP è¯·æ±‚ï¼Œä½†æ˜¯ç«‹å³è¿”å›äº†å½“å‰å‡½æ•°ï¼è€Œæˆ‘ä»¬çŸ¥é“ï¼Œåœ¨é¢å¯¹ç½‘ç»œ IO çš„æ—¶å€™ï¼Œä»¤äººæ‹…å¿§çš„äº‹æƒ…æ€»æ˜¯ä¼šå‘ç”Ÿï¼šè¿™ä¸ª HTTP è¯·æ±‚å¯èƒ½ä¼šå¡å¾ˆä¹…ï¼Œä¹Ÿå¯èƒ½æ°¸è¿œä¸ä¼šç»“æŸï¼ˆæš‚ä¸è€ƒè™‘è¶…æ—¶ï¼‰ã€‚æç«¯æƒ…å†µä¸‹ï¼Œå½“è¶Šæ¥è¶Šå¤šçš„ JustGet è¢«æ‰§è¡Œæ—¶ï¼Œæˆ‘ä»¬çš„ä¸»æ§åˆ¶æµè™½ç„¶æ€»æ˜¯èƒ½ç»“æŸï¼Œä½†åå°ä¼šå †ç§¯è¶Šæ¥è¶Šå¤šçš„ goroutine \u0026ndash; ç¨‹åºçš„è¡Œä¸ºå¼€å§‹ä¸å—æ§åˆ¶äº†ï¼\nåœ¨è¿™é‡Œï¼Œgo å¯¹æ§åˆ¶æµçš„æŠ½è±¡è¿›è¡Œäº†ç¬¬äºŒæ¬¡ç ´åã€‚å¯¹æ¯” goto å’Œ goï¼Œä½ ä¼šå‘ç°å®ƒä»¬æ˜¯æä¸ºç›¸ä¼¼çš„[2]ã€‚\ngo vs. goto ä¸ä»…å¦‚æ­¤ï¼Œå› ä¸º çº¿ç¨‹/go ä¸ºä»£è¡¨çš„å¹¶å‘æ§åˆ¶çš„å‡ºç°ï¼Œè®¸å¤šåœ¨éå¹¶å‘ä¸–ç•Œé‡Œå¾ˆè‡ªç„¶çš„äº‹æƒ…å˜éš¾äº†ï¼š\nä¼˜é›…é€€å‡ºï¼Œåœ¨å¹¶å‘çš„ä¸–ç•Œé‡Œæ„å‘³ç€è¦åœæ­¢æ‰€æœ‰çš„å¼‚æ­¥æ‰§è¡Œæµ è‡ªåŠ¨èµ„æºå›æ”¶ï¼Œå…¸å‹ä¾‹å­æ˜¯ RAII å’Œ Python çš„ ContextManager é”™è¯¯å¤„ç†ï¼Œåœ¨éå¹¶å‘çš„ä¸–ç•Œé‡Œï¼Œé”™è¯¯çš„å¤„ç†å¯ä»¥ç”±å½“å‰æ§åˆ¶æµä¸Šæ³¨å†Œçš„å¤„ç†å™¨å®Œæˆï¼Œè€Œåœ¨ goroutine ä¸­ï¼Œå¦‚æœæ²¡æœ‰ç‰¹åˆ«æ³¨å†Œ panic å¤„ç†å½“å‰è¿›ç¨‹ä¼šç«‹å³å´©æºƒ åœ¨æˆ‘ç»™ Kubernetes ç¤¾åŒºæäº¤çš„ä¸€ä¸ª PR ä¸­ï¼Œreviewer ç‰¹åˆ«æåˆ°äº†å¯¹ goroutine panic çš„å¤„ç† # Python with open(\u0026#39;/some/file\u0026#39;) as f: ... # Async flow outlives here æœ€åï¼Œæˆ‘æƒ³åŒå­¦å¯èƒ½ä¼šå¯¹è¿™ä¸ªä¾‹å­æœ‰ç–‘é—®ï¼šå¦‚æœæ–‡æ¡£è¶³å¤Ÿè¯¦å°½æˆ–è€…æ–¹æ³•æ”¹åä¸º AsyncHttpGet ä¼šä¸ä¼šä½¿å¾—å¼€å‘è€…é¿å…è¿™æ ·çš„é”™è¯¯ï¼Ÿ\næˆ‘ä¸ªäººçš„è§è§£æ˜¯ï¼šæ²¡é”™ï¼Œä½†æ˜¯å¹¶ä¸èƒ½è§£å†³æ‰€æœ‰é—®é¢˜ã€‚ç°å®å¾€å¾€æ¯”ç†æƒ³æ›´è®©äººæ— å¥ˆï¼š\nå¦‚æœåº“çš„æä¾›è€…ä¸å¤Ÿå¨´ç†Ÿ/å·æ‡’/è„‘å­æŠ½äº†å‘¢ï¼Ÿ å¦‚æœå¼€å‘è€…æ²¡æœ‰ä»”ç»†é˜…è¯»æ–‡æ¡£è€Œæ˜¯ä¾èµ–ç›´è§‰å‘¢ï¼Ÿ å¦‚æœè¿™ä¸ªæ˜¯ä¸€ä¸ªé—´æ¥ä¾èµ–è€Œéç›´æ¥ä¾èµ–å‘¢ï¼Ÿ æˆ‘ä»¬æ¯•ç«Ÿåªæ˜¯äººç±»ï¼Œåªèƒ½å¤„ç†æœ‰é™çš„å¤æ‚åº¦ï¼Œè€Œä¸”å¾ˆå®¹æ˜“å‡ºé”™ã€‚ä¸Šé¢è¿™äº›æ¯ä¸€æ¡éƒ½å¯¼è‡´äº†æ— æ•°çœŸå®ä¸–ç•Œçš„ç¼ºé™·ã€‚ä¸¾ä¸€ä¸ªä¾‹å­ï¼ŒKubernetes ä¸­ kubectl exec ä¸­ä½¿ç”¨çš„ SPDYExecutor è‡³ä»Šè¿˜å­˜åœ¨ goroutine æ³„éœ²å’Œå¡æ­»ï¼ˆSIGINT å¤±æ•ˆï¼‰çš„å¯èƒ½ï¼Œè€Œè¿™å¯æ˜¯ Google å’Œä¸–ç•Œä¸Šè®¸å¤šä¼˜ç§€å·¥ç¨‹å¸ˆä¸€ç›´åœ¨ç»´æŠ¤çš„é¡¹ç›®ã€‚\næ€æƒ³ \u0026ndash; ç»“æ„åŒ–å¹¶å‘ Structured Concurrency æ­£å¦‚å‰æ–‡æ‰€è¯´ï¼Œgo è¿™æ ·çš„å¹¶å‘åŸè¯­æ˜¯å¼ºå¤§ä½†éœ€è¦ä»”ç»†æ§åˆ¶çš„ï¼Œå› æ­¤æˆ‘ä»¬éœ€è¦é¢å¤–çš„æŠ½è±¡æ¥è®©å¹¶å‘å˜å¾—æ›´ä¸ºå¯æ§ã€‚å¯¹åº”ç»“æ„åŒ–ç¼–ç¨‹ï¼ˆStructured Programmingï¼‰ï¼Œ Martin SÃºstrik å’Œ Nathaniel J. Smith æå‡ºå¹¶ç»†åŒ–äº†ç»“æ„åŒ–å¹¶å‘çš„æ¦‚å¿µã€‚\nç»“æ„åŒ–å¹¶å‘çš„æ ¸å¿ƒæ€æƒ³æ˜¯ï¼šæ¯å½“æ§åˆ¶æµåˆ†è£‚æˆå‡ æ¡å¹¶å‘çš„æ§åˆ¶æµæ—¶ï¼Œä¿è¯å®ƒä»¬æœ€åä¼šåˆå¹¶èµ·æ¥ã€‚ä¸¾ä¸ªä¾‹å­ï¼Œå‡è®¾æˆ‘ä»¬è¦å¹¶å‘åœ°è¿›è¡Œä¸‰ä»¶äº‹æƒ…ï¼Œå®ƒä»¬æœ€åä¼šåˆå¹¶åˆ°ä¸€èµ·ï¼ˆå›åˆ°ä¸»æ§åˆ¶æµï¼‰ã€‚\nControl Flow Nursery Example åœ¨ Smith å¼€å‘çš„ trio åº“ä¸­ï¼Œnursery ä»£è¡¨äº†ä¸€ä¸ªç»“æ„åŒ–å¹¶å‘çš„æ§åˆ¶å™¨ \u0026ndash; æ‰€æœ‰å¹¶å‘å•å…ƒå¿…é¡»åœ¨ nursery ä¸­å¯åŠ¨ï¼Œnursery ä¼šç­‰å¾…æ‰€æœ‰çš„å¹¶å‘ä»»åŠ¡ç»“æŸã€‚Nursery ä¿è¯äº†åœ¨å®ƒè¢«å…³é—­æ—¶ï¼Œæ‰€æœ‰çš„å¹¶å‘å•å…ƒéƒ½å·²ç»æ‰§è¡Œç»“æŸ/è¢«å–æ¶ˆäº†ã€‚å› æ­¤ä½¿ç”¨ nursery èƒ½å¤Ÿç»§ç»­ä¿è¯ä¸€å¼€è¯´æ‰€è¯´çš„é»‘ç›’æŠ½è±¡ã€‚\nä½¿ç”¨ nursery æˆ‘ä»¬åŒæ ·å¯ä»¥åŠ¨æ€åœ°å¯åŠ¨å¹¶å‘ä»»åŠ¡ï¼Œä½†çœ‹ä¸Šå»å®ƒä¸€å®šéœ€è¦äº‹å…ˆåˆ›å»ºä¸€ä¸ª nursery å¯¹è±¡ï¼Ÿå²‚ä¸æ˜¯å¹¶å‘ä»»åŠ¡çš„ç”Ÿå‘½å‘¨æœŸä¸€å®šå’Œ nursery å¯¹è±¡ç»‘å®šäº†ï¼Ÿæ˜¾ç„¶è¿™ä¸ªé—®é¢˜æœ‰ä¸€ä¸ªå¾ˆç®€å•çš„è§£å†³åŠæ³•ï¼šå½“æˆ‘ä»¬éœ€è¦ä¸€ä¸ªä¸é™åˆ¶ç”Ÿå‘½å‘¨æœŸï¼ˆaka. ç”Ÿå‘½å‘¨æœŸå’Œç¨‹åºä¸€æ ·é•¿çš„ï¼‰çš„å¹¶å‘ä»»åŠ¡æ—¶ï¼Œæˆ‘ä»¬å¯ä»¥ç”¨ä¸€ä¸ªå…¨å±€é™æ€çš„ nursery æ¥åˆ›å»ºå®ƒã€‚\n\u0008ä¸ä»…å¦‚æ­¤ï¼Œnursery æ‰€ä»£è¡¨çš„ç»“æ„åŒ–å¹¶å‘æ€æƒ³åŒæ—¶å¯ä»¥è§£å†³æˆ‘ä»¬ä¸Šé¢æ‰€è¯´çš„é—®é¢˜ï¼š\nä¼˜é›…é€€å‡ºï¼Œnursery æ”¯æŒå–æ¶ˆå¼‚æ­¥ä»»åŠ¡ï¼Œå¹¶ä¼šä¸€ç›´ç­‰å¾…å¼‚æ­¥ä»»åŠ¡ç»“æŸ è‡ªåŠ¨èµ„æºå›æ”¶ï¼Œå› ä¸ºé»‘ç›’åŸåˆ™çš„ä¿è¯ï¼Œå¼‚æ­¥ä»»åŠ¡çš„ç”Ÿå‘½å‘¨æœŸå¯ä»¥ä¿è¯æ¯”èµ„æºé•¿ é”™è¯¯ä¼ æ’­ï¼ŒåŒæ ·å› ä¸ºæ§åˆ¶æµçš„åˆå¹¶ï¼Œé”™è¯¯å¯ä»¥ä»åˆ†è£‚çš„æ§åˆ¶æµæ­£ç¡®åœ°ä¼ æ’­åˆ°ä¸»æ§åˆ¶æµï¼Œå¹¶è¢«å¤„ç† What\u0026rsquo;s more? åœ¨ç»“æ„åŒ–å¹¶å‘ä¸­å¯ä»¥æ›´è‡ªç„¶å’Œé²æ£’åœ°å®ç°è¶…æ—¶å’Œå–æ¶ˆï¼Œå› ä¸ºä¸€åˆ‡å¹¶å‘ç»“æ„éƒ½å’Œä»¥å‰ä¸€æ ·æ˜¯æ ‘çŠ¶çš„ã€‚åœ¨å¼‚æ­¥ IO ä¸­é²æ£’çš„è¶…æ—¶å®ç°æ˜¯éå¸¸é‡è¦çš„ï¼Œå› æ­¤å…³äºè¶…æ—¶å’Œå–æ¶ˆä¹Ÿæ˜¯ä¸€ä¸ªå¾ˆæœ‰æ„æ€çš„è¯é¢˜ï¼Œç­‰æœ‰æ—¶é—´äº†ä¼šå¼€ä¸€ç¯‡æ–°çš„æ–‡ç« èŠä¸€ä¸‹ã€‚\né™¤äº† nursery ä¹‹å¤–ï¼Œæˆªæ­¢åˆ°ç›®å‰æˆ‘å·²çŸ¥çš„å·²ç»å®ç°/æ­£åœ¨å®ç°ç»“æ„åŒ–å¹¶å‘çš„ç¼–ç¨‹è¯­è¨€å’Œé¡¹ç›®æœ‰ Python çš„ trio [8]ã€Kotlin [9]ã€Java çš„ loom [7] ä»¥åŠ Swift [10]ã€‚Rust çš„ tokio å¼‚æ­¥è¿è¡Œæ—¶æ›¾ç»å°è¯•è¿‡æä¾›ç»“æ„åŒ–å¹¶å‘çš„èƒ½åŠ›ï¼Œä½†æ— å¥ˆç°åœ¨çš„ Rust ç‰¹æ€§è¿˜ä¸èƒ½å¤Ÿæ”¯æ’‘ç»“æ„åŒ–å¹¶å‘ã€‚\næ³¨ï¼šForkJoin æ¨¡å‹åŒæ ·ä¹Ÿå®ç°äº†æ§åˆ¶æµçš„ç­‰å¾…ï¼Œä½† Smith å¹¶ä¸è®¤ä¸ºå®ƒæ˜¯ç»“æ„åŒ–å¹¶å‘ã€‚å› ä¸ºç¼–ç¨‹è¯­è¨€å¹¶ä¸äº†è§£ fork-join çš„è¯­ä¹‰ï¼Œæ— æ³•åœ¨ç¼–è¯‘æœŸä¿è¯å¹¶å‘å®‰å…¨ã€‚\nç°çŠ¶ \u0026ndash; æ— èƒ½ä¸ºåŠ›çš„ Rust \u0008 Carl Lerche å°è¯•åœ¨ tokio çš„ issue [4] ä¸­æå‡ºäº†ä¸€ä¸ªç»“æ„åŒ–å¹¶å‘çš„ææ¡ˆï¼Œæ„å›¾ä¸€ä¸¾æ”¯æŒ scoped spawnï¼ˆå‚é˜… [6]ï¼‰å’Œç»“æ„åŒ–å¹¶å‘ä¸¤ä¸ªåŠŸèƒ½ã€‚ç„¶è€Œç»è¿‡ä¸€ç•ªè®¨è®ºåå‘ç°ï¼Œåœ¨ç›®å‰çš„ Rust ä¸­æ— æ³•å®ç° scoped spawnï¼Œä¹Ÿæ— æ³•å®Œå–„åœ°æ”¯æŒç»“æ„åŒ–å¹¶å‘ã€‚åŸææ¡ˆçš„è®¨è®ºæ¯”è¾ƒå‘æ•£ï¼Œå› æ­¤æœ‰ä¸€ç‚¹éš¾ä»¥ç†è§£ï¼Œè¿™é‡Œä¸»è¦è®²è¿°æˆ‘ä¸ªäººçš„è§è§£ [11]ã€‚\nä¸æ˜¯å¾ˆç†Ÿæ‚‰ Rust å’Œ tokio çš„åŒå­¦å¯ä»¥å…ˆä¸ç”¨ç®¡å…¶ä»–ç»†èŠ‚ï¼Œåªéœ€è¦è®°ä½ç›®å‰æœ‰ä¸¤ä¸ªä¸»è¦é™åˆ¶ï¼š\nRust çš„åç¨‹ Future çš„å–æ¶ˆä¾èµ– Dropï¼ˆç­‰ä»·äºææ„å‡½æ•°ï¼‰ï¼Œå®ƒæ˜¯ç«‹å³æ‰§è¡Œçš„ tokio ä¸­åªæ”¯æŒ spawn ä¸€ä¸ª static ç”Ÿå‘½å‘¨æœŸï¼ˆæ²¡æœ‰å±€éƒ¨å˜é‡å¼•ç”¨ï¼‰çš„ Futureï¼Œä¸ä¹‹ç›¸å¯¹åº”çš„å°±æ˜¯ scoped spawn ä¸¾ä¸¤ä¸ªç®€å•çš„ä¾‹å­æ–¹ä¾¿ç†è§£ï¼Œç†Ÿæ‚‰çš„åŒå­¦å¯ä»¥ç›´æ¥è·³è¿‡ï¼š\n// Rust async fn request_or_timeout(tiemout: time::Duration) -\u0026gt; Result\u0026lt;()\u0026gt; { let timer = tokio::time::sleep(timeout)); let request_fut = async_do_request(); tokio::select! { _ = timer =\u0026gt; { // request_fut is dropped immediately before exiting current block Err(\u0026#34;timeout\u0026#34;) }, _ = request_fut =\u0026gt; { Ok(()) } } } async fn scoped_spawn() { let x = 1; let x_ref = \u0026amp;x; // Not allowed tokio::spawn(async { println!(*x_ref); }).await; } é‚£ç°åœ¨é—®é¢˜åœ¨å“ªå‘¢ï¼Ÿå‡å¦‚ Rust / tokio ä¸­å·²ç»æ”¯æŒäº†ç»“æ„åŒ–å¹¶å‘ï¼Œæˆ‘ä»¬å°è¯•æ¥åæ¨ä¸€ä¸‹ã€‚è¿™è¦æ±‚æˆ‘ä»¬äº†è§£ Rust åç¨‹å’Œè¿è¡Œæ—¶çš„çœŸæ­£æ‰§è¡Œæµç¨‹ï¼Œä¸ç†Ÿæ‚‰çš„åŒå­¦å¯ä»¥å‚è€ƒæˆ‘ä¸Šä¸€ç¯‡ä»‹ç»åç¨‹çš„æ–‡ç« ã€‚\né¦–å…ˆï¼Œå‡å¦‚ Rust / tokio å·²ç»æ”¯æŒäº†ç»“æ„åŒ–å¹¶å‘ï¼Œé‚£æ”¯æŒ scoped spawn åº”è¯¥æ˜¯ä¸€ä¸ªéå¸¸è‡ªç„¶çš„äº‹æƒ… \u0026ndash; å› ä¸ºæ§åˆ¶æµæ°¸è¿œéƒ½ä¼šå½’å¹¶ï¼Œæ„å‘³ç€ä½ å¯ä»¥ä¿è¯ scoped å¼•ç”¨çš„ç”Ÿå‘½å‘¨æœŸä¸€å®šæ¯” spawned task è¦é•¿ã€‚å› æ­¤æˆ‘ä»¬éœ€è¦æ¥çœ‹ä¸€ä¸‹å¦‚ä½•æ”¯æŒ scoped spawnã€‚æ³¨æ„åˆ° spawn å‡ºæ¥çš„ä»»åŠ¡æ˜¯å¼‚æ­¥å¹¶å‘æ‰§è¡Œçš„ï¼Œæ„å‘³ç€ä½ æ— æ³•ä¿è¯åœ¨ä»»æ„æ—¶åˆ»éƒ½èƒ½å¤Ÿç«‹å³ä¸­æ­¢å®ƒçš„è¿è¡Œã€‚æ³¨æ„åˆ°æœ‰ select è¿™ç§åŸè¯­çš„å­˜åœ¨ï¼Œå› æ­¤ä»»æ„ Future éƒ½å¯ä»¥åœ¨æ²¡æœ‰æ‰§è¡Œå®Œå‰è¢« dropï¼ˆå¼ºåˆ¶ç«‹å³å–æ¶ˆ + é”€æ¯ï¼‰ã€‚\né‚£ä¹ˆè¿™é‡ŒçŸ›ç›¾æ¥äº†ï¼Œä»¥ä¸Šé¢çš„ scoped_spawn ä¸ºä¾‹ï¼š\nscoped_spawn æ‰€ä»£è¡¨çš„ Future å¯ä»¥è¢«å¼ºåˆ¶é”€æ¯ æ­¤æ—¶å®ƒ spawn çš„ println ä»»åŠ¡å¯èƒ½è¿˜åœ¨è¿è¡Œä¸­ï¼Œä¿è¯ x_ref çš„æœ‰æ•ˆæ€§ï¼Œéœ€è¦ä¿è¯ scoped_spawn ä¸è¢«é”€æ¯ å¦‚ä½•ä¿è¯ scoped_spawn è¢« drop å‰ println è¿™ä¸ªå¹¶å‘ä»»åŠ¡å®Œæˆ/å–æ¶ˆï¼Ÿç­”æ¡ˆæ˜¯ï¼Œå¾ˆé—æ†¾ï¼Œæ²¡æœ‰åŠæ³•ã€‚Rust æ²¡æœ‰æä¾›ä¸€ä¸ªå¼‚æ­¥å–æ¶ˆçš„æ–¹å¼ï¼Œé™¤éåœ¨ drop ä¸­ç”¨ä¸€ç§é˜»å¡çº¿ç¨‹çš„æ–¹å¼æ¥åŒæ­¥ç­‰å¾…ï¼Œç¬¬ä¸€è¿™æ˜¯ä¸å¯å–çš„ï¼ˆä½ æ— æ³•çŸ¥é“è¦ç­‰å¤šä¹…ï¼‰ï¼Œç¬¬äºŒ Rust çš„ç¼–è¯‘å™¨ä¹Ÿæ²¡æœ‰è¿™ä¸ªèƒ½åŠ›è‡ªåŠ¨æ’å…¥è·Ÿ runtime ç›¸å…³çš„é˜»å¡ç­‰å¾…æ–¹å¼ã€‚\næ˜¾ç„¶ï¼Œè¿™é‡Œæˆ‘ä»¬ç¼ºå°‘ä¸€ä¸ªå¼‚æ­¥å–æ¶ˆçš„æœºåˆ¶ã€‚å…³äºè¿™ä¸ªæœºåˆ¶å…¶å® tokio ç¤¾åŒºå¾ˆæ—©å°±è®¨è®ºè¿‡ã€‚åœ¨æ”¯æŒå¼‚æ­¥ IO é©±åŠ¨å™¨ io_uring çš„è¿‡ç¨‹ä¸­å‘ç°ï¼Œio_uring å¯¹ä¼ å…¥å†…æ ¸çš„ buffer çš„ç”Ÿå‘½å‘¨æœŸæœ‰è¦æ±‚ï¼šå¿…é¡»ä¿è¯å†…æ ¸åœ¨å·¥ä½œæœŸé—´ buffer æ˜¯å­˜æ´»çš„ã€‚è¿™å¯¹ä½¿ç”¨ Drop æ¥å–æ¶ˆåç¨‹çš„ Rust æ¥è¯´é‡åˆ°äº†å’Œä¸Šé¢ä¸€æ ·çš„é—®é¢˜ã€‚å› æ­¤ç¤¾åŒºåŸºäºæ­¤æå‡ºäº†éœ€è¦ä¸€ä¸ª AsyncDrop [12] çš„ trait æ¥å®Œæˆå¼‚æ­¥ Dropã€‚ä½†åŒæ ·ï¼Œå³ä½¿æ˜¯ AsyncDrop ä¹Ÿä»ç„¶æœªæœ‰å®šè®ºï¼Œæ¯”å¦‚å…¶é€šç”¨çš„å½¢å¼\ntrait AsyncDrop { async fn drop(\u0026amp;mut self); } å°±æœ‰å¥½å‡ ä¸ªé—®é¢˜ï¼šasync trait ä¸æ”¯æŒï¼Œasync trait çš„æ”¯æŒéœ€è¦ GATï¼ˆgeneric associate typeï¼‰ï¼ŒGAT è¿˜æ²¡æœ‰ stableã€‚Just too many problems aheadã€‚å’³ï¼Œè¿™é‡Œä¸åšå±•å¼€ã€‚\né™¤äº†å¼‚æ­¥å–æ¶ˆï¼Œæˆ‘ä»¬è¿˜é¢ä¸´äº†é”™è¯¯ä¼ æ’­å’Œå¤„ç†çš„é—®é¢˜ï¼Œå…¶ä¸­æœ€å¤´ç–¼çš„åº”è¯¥æ˜¯ panic çš„å¤„ç†ï¼Œæˆ‘æƒ³æœ¬æ–‡å·²ç»å¤Ÿé•¿ï¼ˆæ°´ï¼‰äº†ï¼Œå°±ä¸å†ç»§ç»­è®¨è®ºäº†ã€‚\næ€»è€Œè¨€ä¹‹ï¼ŒRust çš„å¼‚æ­¥ç¼–ç¨‹ä»¥åŠç»“æ„åŒ–å¹¶å‘çš„æ”¯æŒè¿˜æœ‰å¾ˆé•¿ä¸€æ®µè·¯è¦èµ°ã€‚è™½ç„¶çœ‹ç€éš”å£ swift çš„å®Œæ•´ proposal æœ‰ä¸€ç‚¹æµå£æ°´ï¼Œä½†è¿˜æ˜¯æœŸå¾…å°†æ¥èƒ½åœ¨ Rust ä¸Šå®Œæ•´ä½“éªŒç»“æ„åŒ–å¹¶å‘çš„é­…åŠ›ã€‚\nå…³äº Rust å¼‚æ­¥ç¼–ç¨‹ç›®å‰å­˜åœ¨çš„ä¸€äº›é—®é¢˜ï¼Œæ„Ÿå…´è¶£çš„åŒå­¦å¯ä»¥å‚é˜… [6]ã€‚\næ€»ç»“ å…³äºç¼–ç¨‹ï¼Œæˆ‘å§‹ç»ˆè®¤ä¸ºå…¶æ¨¡å‹çš„è®¾è®¡åº”è¯¥æ˜¯ä»¥äººä¸ºå¯¼å‘çš„ã€‚ç¼–ç¨‹è¯­è¨€å’Œå…¶æ‰€å¯¹åº”çš„æ¨¡å‹åº”å½“æ˜¯è¾…åŠ©äººå»å®Œæˆå¤æ‚ç®—æ³•/ç³»ç»Ÿçš„è®¾è®¡ä¸å®ç°ã€‚å› æ­¤ï¼Œæˆ‘è®¤ä¸ºç»“æ„åŒ–å¹¶å‘æ˜¯ä¸€ç§ä¼˜é›…ä¸”æœ‰æ•ˆçš„å¹¶å‘ç¼–ç¨‹æ¨¡å‹ï¼Œåœ¨è¿™ç§æ¨¡å‹ä¸‹æ€è€ƒè®¸å¤šå¹¶å‘ç®—æ³•çš„å®ç°èƒ½æ˜¾è‘—é™ä½å¿ƒæ™ºè´Ÿæ‹…ï¼Œä½¿å¾—æˆ‘è¿™ç§æ™®é€šå¼€å‘è€…å†™å‡ºæ›´é²æ£’çš„å¹¶å‘ä»£ç ã€‚\nå…¶å®ï¼Œåœ¨å¼‚æ­¥å’Œå¹¶å‘ç¼–ç¨‹é¢†åŸŸè¿˜æœ‰ä¸€ä¸ªæˆ‘éå¸¸æ„Ÿå…´è¶£çš„è¯é¢˜ \u0026ndash; è¶…æ—¶å’Œå–æ¶ˆï¼ŒæœŸå¾…åç»­èƒ½å¤Ÿæœ‰æœºä¼šå†™ï¼ˆæ°´ï¼‰ä¸€ç¯‡æ–‡ç« æ¢è®¨ä¸‹ã€‚\næœ€åï¼Œäº’ç›¸äº¤æµæƒ³æ³•æ˜¯æˆ‘å†™æ–‡ç« çš„ä¸»è¦ç›®çš„ä¹‹ä¸€ï¼Œå¸Œæœ›å„ä½å¤§ä½¬èƒ½å¤Ÿå¤šåœ¨è¯„è®ºåŒºäº’åŠ¨ã€‚\né¢„å‘Š ä¸‹ä¸€ç¯‡æ–‡ç« æ°´ä¸€ä¸‹è€æœ¬è¡Œï¼ŒèŠèŠ Kubernetes ä¸­å®ç° operator æ¨¡å¼çš„å‡ ä¸ªæ³¨æ„ç‚¹ã€‚\nå‚è€ƒæ–‡çŒ® [1] https://arunsworld.medium.com/structured-concurrency-in-go-b800c7c4434e\n[2] https://vorpus.org/blog/notes-on-structured-concurrency-or-go-statement-considered-harmful/#nurseries-a-structured-replacement-for-go-statements\n[3] https://en.wikipedia.org/wiki/Structured_concurrency\n[4] https://github.com/tokio-rs/tokio/issues/2596\n[5] http://smallcultfollowing.com/babysteps/blog/2019/10/26/async-fn-in-traits-are-hard/\n[6] https://carllerche.com/2021/06/17/six-ways-to-make-async-rust-easier/\n[7] https://wiki.openjdk.java.net/display/loom/Structured+Concurrency\n[8] https://github.com/python-trio/trio\n[9] https://elizarov.medium.com/structured-concurrency-722d765aa952\n[10] https://github.com/apple/swift-evolution/blob/main/proposals/0304-structured-concurrency.md\n[11] https://gist.github.com/arkbriar/39b30ac4a882277372dacbb85eb6cdd2\n[12] https://boats.gitlab.io/blog/post/poll-drop/\n","date":"2021-09-14T08:37:50+08:00","image":"https://blog.crazyark.me/p/structured-concurrency/img/eva0_hu99d7499bbdfd2fe463cca52e562d0795_149321_120x120_fill_q75_box_smart1.jpeg","permalink":"https://blog.crazyark.me/p/structured-concurrency/","title":"ä»£ç æ‚è°ˆï¼šç»“æ„åŒ–å¹¶å‘"},{"content":" åç¨‹æ˜¯å¯¹å­ç¨‹åºï¼ˆsubroutineï¼‰çš„ä¸€ç§æ‰©å±•ï¼Œå®ƒå…è®¸æ‰§è¡Œæµç¨‹è¢«æŒ‚èµ·å’Œæ¢å¤ [1]ã€‚\néšç€è¶Šæ¥è¶Šå¤šçš„ç¼–ç¨‹è¯­è¨€çš„æ”¯æŒï¼Œåç¨‹è¿™ä¸ªæ¦‚å¿µä¹Ÿè¢«æ›´å¤šçš„äººæ‰€çŸ¥æ™“ã€‚åç¨‹å®šä¹‰äº†ä¸€ç§é€šç”¨çš„æ§åˆ¶æµçš„äº¤äº’æ–¹å¼ã€‚ é€šå¸¸æ¥è¯´ï¼ˆæ ¹æ®æœ€åˆçš„å®šä¹‰ï¼‰ï¼Œåç¨‹çš„æ‰§è¡Œæ˜¯åä½œå¼çš„ã€‚æ¢å¥è¯è¯´ï¼Œæ§åˆ¶æµçš„è½¬ç§»æ˜¯ä¸»åŠ¨çš„ã€åä½œçš„ï¼Œè¿™ä¸çº¿ç¨‹çš„æŠ¢å å¼è°ƒåº¦æœ‰ç€å¾ˆå¤§çš„åŒºåˆ«ã€‚ ä½¿ç”¨åç¨‹å¯ä»¥å¾ˆä¼˜é›…åœ°å®ç°ä¸€äº›æ¦‚å¿µï¼Œæ¯”å¦‚äº‹ä»¶å¾ªç¯ã€è¿­ä»£å™¨ã€æ— é™é•¿çš„åˆ—è¡¨ï¼ˆgeneratorï¼‰ç­‰ï¼Œä¸¾ä¸€ä¸ªç»å…¸çš„ Python çš„ä¾‹å­ï¼š\n# å®ç°ä¸€ä¸ªæ— é™é•¿çš„ä» 0 å¼€å§‹çš„ range # yield æ—¶æŒ‚èµ·å½“å‰åç¨‹ï¼Œå¹¶æŠŠæ§åˆ¶æƒäº¤ç»™ caller def infinite_range(): i = 0 while True: yield i i += 1 ç›®å‰å·²ç»æœ‰å¾ˆå¤šè¯­è¨€åŸç”Ÿåœ°æ”¯æŒäº†åç¨‹ï¼Œæ¯”å¦‚ Pythonã€Kotlinã€Go å’Œ Rust ç­‰ã€‚æœ¬æ–‡ä¸»è¦æƒ³èŠä¸€ä¸‹å…¶ä¸­çš„ä¸¤ä¸ªè¯­è¨€ï¼šGo å’Œ Rustã€‚è¿™ä¸¤ä¸ªè¯­è¨€å…¸å‹åœ°ä»£è¡¨äº†åç¨‹çš„å‘ˆç°å’Œå®ç°æ–¹å¼ï¼Œå¯¹äºç†è§£åç¨‹æœ‰æ¯”è¾ƒå¥½çš„å¸®åŠ©ã€‚\næ³¨ï¼šè™½ç„¶ Go çš„ goroutine é€šå¸¸ä¹Ÿè¢«å½’ç±»ä¸ºåç¨‹ï¼Œä½†æ˜¯åç¨‹çš„å¤å…¸æ¦‚å¿µè¿˜æ˜¯åº”è¯¥æ˜¯åä½œå¼å­ä¾‹ç¨‹ã€‚Go åœ¨ 1.14 ç‰ˆæœ¬å®ç°äº† [3] ä¸­æå‡ºçš„éåä½œå¼æŠ¢å ï¼Œä¹Ÿå°±æ˜¯æŠ¢å å¼è°ƒåº¦ã€‚Go å®˜æ–¹ä¸ºäº†å’Œè¿›ç¨‹ã€çº¿ç¨‹ã€åç¨‹ç­‰å·²æœ‰æ¦‚å¿µä½œåŒºåˆ«æ–°åˆ›äº† goroutine è¿™ä¸ªè¯ [2]ã€‚æˆ‘ä¸ªäººä¹Ÿæ›´å–œæ¬¢ç”¨ goroutine æ¥æŒ‡ä»£ Go ä¸­å®ç°çš„è½»é‡çº§å¹¶å‘çš„æ¦‚å¿µã€‚\nåç¨‹ å…³äºæ”¯æŒåç¨‹çš„ç†ç”±ä¸å†è¿‡å¤šä»‹ç»ï¼Œæœ¬æ–‡ä¸»è¦æƒ³ä»¥ Rust å’Œ Go ä¸ºä¾‹ï¼ŒèŠä¸€ä¸‹åç¨‹çš„å‡ ç§å½¢å¼ã€å®ç°å’Œç°çŠ¶ã€‚\nåç¨‹çš„ç¼–ç¨‹æ¨¡å‹æœ‰å¾ˆå¤šç§ï¼Œæœ€å¸¸è§çš„å°±æ˜¯ async/await æ¨¡å‹ï¼ŒRust æä¾›çš„å°±æ˜¯è¿™ç§ã€‚ç›¸å¯¹è€Œè¨€ï¼ŒGo æä¾›çš„ go å…³é”®å­—æ›´åƒå¯åŠ¨ä¸€ä¸ªç”¨æˆ·æ€çº¿ç¨‹ï¼Œä½¿ç”¨èµ·æ¥æ¯” async/await æ›´åŠ ç®€æ´ã€‚\nåœ¨å®ç°ä¸Šï¼Œé€šå¸¸åˆ†ä¸ºä¸¤ç§ï¼Œä¹Ÿå°±æ˜¯å¸¸è¯´çš„æœ‰æ ˆåç¨‹å’Œæ— æ ˆåç¨‹ã€‚è¿™é‡Œçš„æ ˆæŒ‡çš„æ˜¯æ¯ä¸ªåç¨‹æ˜¯å¦æ‹¥æœ‰ç‹¬ç«‹çš„æ ˆç©ºé—´ï¼Œåƒ Go æä¾›çš„ goroutine æ˜¯å…¸å‹çš„æœ‰æ ˆå®ç°ï¼Œæ¯ä¸€ä¸ª goroutine åœ¨è‡ªå·±çš„æ ˆç©ºé—´ä¸Šæ‰§è¡Œã€‚è€Œ Rust æä¾›çš„åˆ™æ˜¯å…¸å‹çš„æ— æ ˆåç¨‹ï¼Œæ— æ ˆåç¨‹çš„è¿è¡Œæ–¹å¼ç±»ä¼¼äºä¸€ä¸ªå·¨å¤§çš„çŠ¶æ€æœºã€‚è¿™ä¹ˆè¯´ä½ å¯èƒ½ä¸èƒ½ä¸€ä¸‹å­åœ¨è„‘ä¸­æ„å»ºè¿è¡Œæ—¶çš„çŠ¶æ€ï¼Œå¾…ä¼šä¼šå±•å¼€è®²è®² Rust æ˜¯å¦‚ä½•è¿è¡Œå®ƒçš„åç¨‹çš„ã€‚\nå¦‚å‰æ–‡æ‰€è¯´ï¼Œåç¨‹é€šå¸¸æ˜¯åä½œå¼çš„ï¼Œä½†ç°ä»£çš„ä¸€äº›é«˜çº§ç¼–ç¨‹è¯­è¨€è¿˜æ˜¯å®ç°äº†æŠ¢å å¼çš„è°ƒåº¦ã€‚åœ¨ä»‹ç» goroutine çš„è¿‡ç¨‹ä¸­ï¼Œæœ¬æ–‡ä¹Ÿä¼šå¤§æ¦‚ä»‹ç»ä¸‹åä½œå¼å’ŒæŠ¢å å¼çš„åŸç†ï¼Œä»¥åŠç›¸åº”çš„ç†ç”±å’Œæ¼”è¿›è¿‡ç¨‹ã€‚\nGo \u0026ndash; Just go ç†Ÿæ‚‰ Go è¯­è¨€çš„åŒå­¦éƒ½çŸ¥é“ï¼Œå®ƒæä¾›äº†ä¸€ä¸ªç®€å•æ˜“ç”¨çš„å¹¶å‘ä½¿ç”¨æ–¹å¼ \u0026ndash; goã€‚é€šè¿‡åœ¨å‡½æ•°è°ƒç”¨å‰åŠ ä¸Š go å…³é”®å­—ï¼Œå°±å¯ä»¥å¹¶å‘åœ°æ‰§è¡Œå®ƒçš„é€»è¾‘ï¼š\nfunc handleTasks(ctx: context.Context, taskChan: \u0026lt;- chan Task) { for { select { case \u0026lt;- ctx.Done(): return case task := \u0026lt;- taskChan: handle(ctx, task) } } } func startTaskHandler(ctx: context.Context, taskChan: \u0026lt;- chan Task) { // With simple `go`, we start a task handler which runs in the // background asynchronously and concurrently. go handleTasks(ctx, taskChan) } ä¸Šé¢çš„ç¤ºä¾‹ä¸­å¯åŠ¨äº†ä¸€ä¸ªå¼‚æ­¥çš„ä»»åŠ¡å¤„ç†å™¨ã€‚Go å°†å®ƒå¯åŠ¨çš„å¼‚æ­¥å•å…ƒç§°ä¸º goroutine \u0026ndash; å®ƒçœ‹ä¸Šå»æ›´åƒæ˜¯ä¸€ä¸ªçº¿ç¨‹ã€‚å½“ç„¶ï¼Œæœ¬æ–‡è¿˜æ˜¯ä»¥åç¨‹çš„è§†è§’æ¥æè¿° Go ä¸­ goroutine çš„æ¨¡å‹å’Œè¿è¡Œæ–¹å¼ï¼Œå› æ­¤ä»¥ä¸‹çš„åç¨‹ä¹Ÿä»£æŒ‡ goroutineã€‚\nGo çš„åç¨‹å®ç°æ˜¯æ‰€è°“çš„æœ‰æ ˆåç¨‹ã€‚æ¯ä¸€ä¸ªåç¨‹åœ¨å¯åŠ¨çš„æ—¶å€™ï¼Œruntime éƒ½éœ€è¦ä¸ºå®ƒåˆ†é…ä¸€å—æ ˆå†…å­˜ \u0026ndash; ä¹‹ååç¨‹çš„è¿è¡Œå°±å‘ç”Ÿåœ¨è¿™ä¸€å—æ ˆä¸Šã€‚æœ‰æ ˆåç¨‹çš„è¿è¡Œæ–¹å¼å¾ˆåƒçº¿ç¨‹ï¼Œå› æ­¤ç›¸æ¯”äºæŠ½è±¡çš„æ— æ ˆåç¨‹ï¼Œä¹Ÿæ›´åŠ çš„å®¹æ˜“ç†è§£ã€‚åœ¨æœ‰æ ˆåç¨‹çš„å®ç°ä¸­ï¼Œæ¯ä¸€ä¸ªåç¨‹éƒ½å¯ä»¥æ˜¯ä¸€ä¸ªå¯è°ƒåº¦çš„å•å…ƒï¼Œä¹Ÿå°±æ˜¯è¯´åªè¦ç¯å¢ƒæ”¯æŒï¼Œå¯ä»¥å¹¶è¡Œï¼ˆè€Œéå¹¶å‘ï¼‰åœ°è¿è¡Œã€‚\nåŒæ“ä½œç³»ç»Ÿæä¾›çš„çº¿ç¨‹ä¸€æ ·ï¼Œåç¨‹åœ¨æ‰§è¡Œä¸€äº›é˜»å¡è°ƒç”¨çš„æ—¶å€™ä¼šé™·å…¥ runtimeï¼Œç”± runtime æ¥è´Ÿè´£é˜»å¡è°ƒç”¨çš„è½¬æ¢/æ‰§è¡Œã€ä»¥åŠåç»­çš„è°ƒåº¦ã€‚åŒæ ·ï¼Œå½“å¯¹åº”è°ƒç”¨å®Œæˆæ—¶ runtime ä¼šå”¤é†’å¯¹åº”çš„åç¨‹ï¼Œé‡æ–°è°ƒåº¦æ‰§è¡Œå®ƒã€‚å½“ç„¶å®é™…ä¸Šçš„æƒ…å†µè¦æ›´åŠ å¤æ‚ä¸€ç‚¹ï¼Œæ¯”å¦‚ï¼Œæ€è€ƒä¸€ä¸‹\u0008 Linux ä¸Šæ–‡ä»¶ IO å’Œç½‘ç»œ IO çš„è°ƒç”¨ä¼šæœ‰ä»€ä¹ˆä¸åŒï¼Ÿ\nå½“ç„¶ï¼ŒGo ä¸­åç¨‹çš„åˆ‡æ¢æ–¹å¼å¹¶ä¸æ˜¯åªæœ‰é˜»å¡è°ƒç”¨è¿™ä¸€ç§ã€‚Go ä¸ºäº†åç¨‹è°ƒåº¦çš„å…¬å¹³èµ·è§ï¼ˆé˜²æ­¢ CPU å¯†é›†åç¨‹å æ»¡è®¡ç®—èµ„æºæŠŠå…¶ä»–åç¨‹é¥¿æ­»ï¼‰ï¼Œè®¾è®¡äº†ä¸€äº›åˆ‡æ¢ç‚¹ï¼ˆsuspend pointï¼‰ï¼Œç»å…¸çš„æ¯”å¦‚ï¼š\nå‡½æ•°è°ƒç”¨æ£€æŸ¥ï¼šè°ƒç”¨å‡½æ•°æ—¶æ£€æŸ¥æ˜¯å¦åº”è¯¥è®©å‡ºæ§åˆ¶æƒ å¾ªç¯å›è¾¹æ£€æŸ¥ï¼šä¸‹ä¸€æ¬¡å¾ªç¯å¼€å§‹å‰æ£€æŸ¥æ˜¯å¦åº”è¯¥è®©å‡ºæ§åˆ¶æƒ æ—©æœŸçš„ Go æ²¡æœ‰å¾ªç¯å›è¾¹æ£€æŸ¥ï¼Œå¯¼è‡´äº†åœ¨ä¸€äº›åœºæ™¯ä¸‹ç¨‹åºæ•´ä¸ª hang æ­»çš„æƒ…å†µã€‚è¿™äº›åˆ‡æ¢ç‚¹è¢« Go çš„ç¼–è¯‘å™¨è‡ªåŠ¨åœ°ç¼–ç»‡åˆ°ä»£ç ä¸­ã€‚é€šè¿‡è¿™ç§æ–¹å¼ï¼ŒGo å®ç°äº†æ‰€è°“çš„â€œåä½œå¼â€è°ƒåº¦ã€‚å¯ä»¥æƒ³è§ï¼Œä¸ºäº†æ€§èƒ½è€ƒè™‘ï¼Œè¿™äº›æ£€æŸ¥çš„å®ç°æ–¹å¼æ— éæ˜¯é€šè¿‡è®¡æ•°å™¨æ¥åˆ¤æ–­å½“å‰è°ƒç”¨/å¾ªç¯ç´¯è®¡æ¬¡æ•°æ˜¯å¦åˆ°è¾¾é˜ˆå€¼ï¼Œæˆ–æ˜¯å½“å‰å·²æ‰§è¡Œæ—¶é—´æ˜¯å¦è¾¾åˆ°é˜ˆå€¼ï¼Œä»è€Œåˆ¤æ–­è¯¥ä¸è¯¥åˆ‡æ¢äº†ã€‚ï¼ˆæ€è€ƒä¸€ä¸‹ï¼Œä¸ºå•¥ä¸èƒ½ç»Ÿç»Ÿåˆ¤æ–­æ‰§è¡Œæ—¶é—´ï¼Ÿï¼‰\n// Cooperative Preemption func doSomething() { // Compiler inserts (Just example). runtime.CheckIfWeAreGoingToBeSched() // Do something... } func doSomethingInLoop() { for i := 0; i \u0026lt; 1e8; i ++ { // Compiler inserts (Just example). if i % 1e7 == 0 { runtime.GoSched() } // Do something... } } è¿™ç§æ–¹å¼è™½ç„¶åœ¨èƒ½è§£å†³é—®é¢˜ï¼Œä½†åœ¨ä¸€äº›ç´§çš„å¾ªç¯ï¼ˆtight loopï¼‰è¿˜æ˜¯ä¼šé€ æˆæ— æ³•æ¥å—çš„æ€§èƒ½ä¸‹é™ã€‚å› æ­¤åœ¨ [3] ä¸­ Austin æå‡ºäº†éåä½œå¼çš„è°ƒåº¦ï¼Œå¹¶ä¸” Go åœ¨ 1.14 ä¸­é¦–æ¬¡å®ç°äº†åŸºäº signal çš„æŠ¢å å¼è°ƒåº¦ã€‚ä¸ªäººè®¤ä¸ºï¼Œä»è¿™é‡Œå¼€å§‹ goroutine å’Œç»å…¸åç¨‹çš„å®šä¹‰è¶Šæ¥è¶Šè¿œï¼Œæ›´æ¥è¿‘äºç”¨æˆ·æ€çº¿ç¨‹ã€‚\nGo çš„è°ƒåº¦æ¨¡å‹ MPG ç›¸ä¿¡ä¹Ÿæ˜¯å¤§åé¼é¼äº†ï¼Œè¿™é‡Œä¸å†èµ˜è¿°ï¼Œæ”¾ä¸€å¼ ä» [8] ä¸­å€Ÿé‰´çš„å›¾ï¼š\nGo Runtime å½“ç„¶ï¼ŒGo ç›®å‰çš„è°ƒåº¦å®ç°å’Œè¯¸å¦‚ Linux çš„çº¿ç¨‹è°ƒåº¦å®ç°è¿˜æ˜¯æœ‰æ‰€åŒºåˆ«çš„ï¼Œä¾‹å¦‚å®ƒè¿˜æ— æ³•æ”¯æŒ goroutine çš„ä¼˜å…ˆçº§è®¾ç½®ã€‚æ ¹æ® TYGG çš„è¯´æ³•ï¼ŒTiDB åœ¨é¡¹ç›®è¿‡ç¨‹ä¸­å› ä¸º TSO goroutine çš„é˜»å¡å¯¼è‡´äº†ç³»ç»Ÿæ•´ä½“æ€§èƒ½çš„ä¸‹é™ï¼Œè¿™ä»ç„¶æ˜¯ä¸€ä¸ªå€¼å¾—ä¼˜åŒ–çš„ç‚¹ã€‚\nRust \u0026ndash; async/await ç›¸ä¿¡æ¯ä¸€ä¸ª Rust æ–°æ‰‹éƒ½çœ‹è¿‡è¿™ç¯‡ä»‹ç» Asynchronous Programming çš„æ–‡æ¡£ [4]ï¼Œä½†æ˜¯è¿™ç¯‡æ–‡æ¡£å±å®æœ‰ä¸€ç‚¹æ–°æ‰‹ä¸å‹å¥½ï¼Œçœ‹å®Œä»¥åè¿˜æ˜¯ä¸€å¤´é›¾æ°´ã€‚å› æ­¤æˆ‘å†³å®šåœ¨æœ¬ç¯‡ä¸­ç€é‡ä»‹ç»ä¸‹ Rust çš„æ¨¡å‹ï¼Œä»¥åŠå®ƒæ˜¯å¦‚ä½•è¢«è¿è¡Œèµ·æ¥çš„ã€‚\nRust çš„åç¨‹é‡‡ç”¨çš„æ˜¯å¸¸è§çš„ async/await æ¨¡å‹ã€‚async æ ‡å¿—äº†å¯¹åº”çš„ä»£ç å—æ˜¯å¯ä»¥å¼‚æ­¥è¿è¡Œçš„ï¼Œå¯¹åº”äº†ä¸€ä¸ªåç¨‹ã€‚await åˆ™ä»£è¡¨ç­‰å¾…å¼‚æ­¥æ‰§è¡Œç»“æŸï¼Œå¯¹åº”å¼‚æ­¥ä»£ç å—ä¸­å¯¹åç¨‹çš„è°ƒç”¨ã€‚é‡‡ç”¨ async/await å¯ä»¥è®©å¼€å‘è€…ç”¨ä¸€ç§åŒæ­¥çš„æ–¹å¼ç¼–å†™å¼‚æ­¥ä»£ç ï¼Œå› æ­¤é¢‡å—æ¬¢è¿ã€‚ä½†æ˜¯ async å’Œ sync \u0008çš„ä¸åŒçš„ç¼–ç¨‹æ¨¡å‹ï¼Œä½¿å¾—å¯¹åŒæ­¥ä»£ç çš„å¼‚æ­¥åŒ–æ”¹é€ å°†ä¼šéå¸¸å›°éš¾ï¼Œé€šå¸¸éœ€è¦ä»åº•å±‚å¼€å§‹é‡å†™ã€‚ç›¸æ¯”ä¹‹ä¸‹ï¼ŒGo åœ¨è¿™æ–¹é¢æ›´åŠ å‹å¥½ã€‚\nFuture Async/Await çš„æ¨¡å‹çš„é€šå¸¸æ˜¯é€šè¿‡æ— æ ˆåç¨‹å®ç°çš„ã€‚å¦‚å‰æ–‡æ‰€è¿°ï¼Œæ— æ ˆæŒ‡çš„æ˜¯åç¨‹æ²¡æœ‰ä¸€ä¸ªç‹¬ç«‹çš„æ ˆã€‚åœ¨åç¨‹è¿è¡Œæ—¶ï¼Œæ˜¯å’Œå…¶ä»–åç¨‹ç”¨çš„åŒä¸€å—æ ˆç©ºé—´ã€‚Rust çš„ async è¯­ä¹‰å®ç°éå¸¸ç›´æ¥ï¼Œå®ƒå°±æ˜¯ä¸€ä¸ªç¼–è¯‘å™¨æä¾›çš„è¯­æ³•ç³– \u0026ndash; å°† async çš„ä»£ç å—/å‡½æ•°ç­‰ä»·è½¬æˆè¿”å›ä¸€ä¸ª Future çš„ä»£ç å—/å‡½æ•°ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š\nasync fn do_something_async() -\u0026gt; u32 { // user codes // ... } // ç­‰ä»·äº fn do_something_async() -\u0026gt; impl Future\u0026lt;Output: u32\u0026gt; { Future { // compiler specific transform // ... } } è¿™ä¸ª Future å°±ä»£è¡¨äº†åç¨‹ï¼Œå®ƒå†…éƒ¨æ˜¯ä¸€ä¸ªçŠ¶æ€æœºã€‚Future åœ¨ Rust é‡Œæ˜¯ä¸€ä¸ª traitï¼š\npub trait Future { type Output; fn poll(self: Pin\u0026lt;\u0026amp;mut Self\u0026gt;, cx: \u0026amp;mut Context\u0026lt;\u0026#39;_\u0026gt;) -\u0026gt; Poll\u0026lt;Self::Output\u0026gt;; } pub enum Poll\u0026lt;T\u0026gt; { Ready(T), Pending, } Future æä¾›äº†ä¸€ä¸ª poll å‡½æ•°ï¼Œæˆ‘ä»¬å…ˆä¸ç®¡å‚æ•°é‡Œé¢ Pin å’Œ Context æ˜¯ä»€ä¹ˆæ„æ€ã€‚ä»å£°æ˜ä¸Šçœ‹ï¼Œå®ƒçš„æ‰§è¡Œæ–¹å¼å°±æ˜¯å¾ªç¯åœ°è°ƒç”¨ Future::pollï¼Œç›´åˆ°è¿”å› Ready è¡¨ç¤ºæ‰§è¡Œå®Œæˆã€‚\nåˆ°ç›®å‰ä¸ºæ­¢ï¼Œæˆ‘ä»¬å¹¶ä¸éœ€è¦å…³å¿ƒ Future å†…éƒ¨æ˜¯å¦‚ä½•å®ç°çš„ï¼Œåªè¦çŸ¥é“æ‰§è¡Œ poll å®ƒå°±èƒ½è¿è¡Œä¸‹å»äº†ã€‚æ˜¾ç„¶ï¼Œpoll æ˜¯ä¸€ä¸ªè¢«åŠ¨å¼çš„æ¥å£ï¼Œéœ€è¦ä¸€ä¸ª runtime ä¸åœåœ°é©±åŠ¨å®ƒæ‰§è¡Œã€‚é—æ†¾çš„æ˜¯ï¼Œåœ¨ Rust çš„æ ‡å‡†åº“ä¸­è¿™ä¸€éƒ¨åˆ†æ˜¯ç¼ºå¤±çš„ã€‚ç›®å‰åœ¨ Rust ä¸Šèƒ½æä¾› runtime çš„æœ‰å‡ ä¸ªä¸‰æ–¹åº“ï¼Œå…¶ä¸­åŒ…æ‹¬è‘—åçš„ tokio å’Œ async-stdã€‚ä»¥åèŠ Rust å¼‚æ­¥å¹¶å‘çš„æ—¶å€™ï¼Œtokio çš„å®ç°æ˜¯æˆ‘é‡ç‚¹å‚è€ƒçš„å¯¹è±¡ã€‚\nå‡è®¾æˆ‘ä»¬å·²ç»æœ‰ä¸€ä¸ª runtime èƒ½å¤Ÿè°ƒç”¨ poll æ¥é©±åŠ¨ Future æ‰€ä»£è¡¨çš„çš„åç¨‹å¾€å‰æ¨è¿›äº†ï¼Œé‚£ä¹ˆå¾ˆæœ‰å¯èƒ½ Future::poll çš„ç¬¬ä¸€æ¬¡è°ƒç”¨å¹¶ä¸ä¼šè¿”å› Readyã€‚è¿™ä¸ªæ—¶å€™æˆ‘ä»¬éœ€è¦è€ƒè™‘ä¸€ä¸ªé—®é¢˜ï¼šä»€ä¹ˆæ—¶å€™éœ€è¦å†æ¬¡æ‰§è¡Œè¿™ä¸ª Futureï¼Ÿ\nRust æ˜¾ç„¶å·²ç»è€ƒè™‘è¿‡è¿™ä¸ªé—®é¢˜äº†ï¼Œå®ƒåœ¨æ ‡å‡†åº“é‡Œæä¾›äº†ä¸€ä¸ªå« Waker çš„ç±»å‹ï¼š\npub struct Waker { /* fields omitted */ } impl Waker { // å½“ wake æˆ–è€… wake_by_ref è¢«è°ƒç”¨æ—¶ï¼Œæ„å‘³ç€å¯¹åº”çš„ Future éœ€è¦è¢«å†æ¬¡æ‰§è¡Œ pub fn wake(self); pub fn wake_by_ref(\u0026amp;self); } ç›´è§‚åœ°æƒ³ï¼Œå¥½åƒä¸åŒçš„ Future éœ€è¦æœ‰ä¸åŒçš„ Wakerã€‚ä½†å®é™…ä¸Šä¸æ˜¯è¿™ä¸ªæ„æ€ï¼ŒWaker åªæ˜¯é€šçŸ¥ runtime æŸä¸ªåç¨‹å¯ä»¥ç»§ç»­æ‰§è¡Œäº†ï¼Œå› æ­¤ runtime åªéœ€è¦æŠŠåç¨‹åŠ å…¥å¾…è¿è¡Œé˜Ÿåˆ—å°±å¥½ã€‚Rust ä¸­ Waker çš„è‡ªå®šä¹‰æ–¹å¼æ¯”è¾ƒç‰¹æ®Šï¼Œå®ƒéœ€è¦æ‰‹åŠ¨åœ°ç»‘å®šå¯¹åº”çš„æ•°æ®å’Œå‡½æ•°çš„æŒ‡é’ˆï¼ˆvtableï¼‰ï¼Œä»è€Œè¾¾åˆ°è‡ªå®šä¹‰ Waker çš„ç›®çš„ï¼Œæœ‰å…´è¶£çš„åŒå­¦å¯ä»¥è‡ªè¡Œäº†è§£ä¸‹ã€‚æœ‰äº† Waker ä¹‹åï¼Œæˆ‘ä»¬å°±å¯ä»¥å®šä¹‰ä»€ä¹ˆæ—¶å€™å°† Future å†æ¬¡å”¤é†’å¹¶æ‰§è¡Œäº†ã€‚å½“ç„¶é‡Œé¢è¿˜æ¶‰åŠåˆ°ä¸€äº›é—®é¢˜ï¼Œå¤§å®¶å…ˆæœ‰è¿™ä¹ˆä¸€ä¸ªæ¦‚å¿µå°±å¥½ï¼Œå¾…ä¼šä¼šä¸€ä¸€ç»†è¯´ã€‚\nç°åœ¨æ¥çœ‹ä¸€ä¸ªç®€å•çš„ async ä»£ç ï¼š\nuse tokio::io::{self, AsyncReadExt}; use tokio::net::TcpStream; async fn echo_handle(socket: TcpStream) -\u0026gt; io::Result\u0026lt;()\u0026gt; { let mut buf = vec![0; 1024]; // Loop writing everything read from socket. loop { match socket.read(\u0026amp;mut buf).await? { Ok(0) =\u0026gt; { // Remote has closed, break loop. break; } Ok(n) =\u0026gt; { // Copy the data back to socket. socket.write_all(\u0026amp;buf[..n]).await?; } } } Ok(()) } è¿™æ®µä»£ç å®ç°äº†ä¸€ä¸ªç®€æ˜“ echo server çš„ handlerï¼Œå…¶ä¸­å‡ºç°äº† await è¿™ä¸ªå…³é”®å­—ã€‚ä¼—æ‰€å‘¨çŸ¥ï¼Œawait è¯­ä¹‰ä¸Šè¡¨ç¤ºå¼‚æ­¥ç­‰å¾… async å®Œæˆï¼Œåœ¨ Rust çš„å®ç°ä¸­ä¹Ÿå°±æ˜¯ç­‰å¾…å¯¹åº”çš„ Future å®Œæˆã€‚æˆ‘ä»¬ç¨å¾®æŠ½è±¡ä¸€ä¸‹ï¼Œä¸Šé¢çš„ä»£ç ä»è¿è¡Œç»“æ„ä¸Šæ¥è¯´å¤§æ¦‚é•¿è¿™æ ·ï¼š\nasync fn echo_handle() { // Do something synchronous here. // ... LOOP: // Create the first future. let fut1 = create_socket_read_fut(); let res = fut1.await; // Do something else synchronous here. // ... // Create the second future. let fut2 = create_socket_write_all_fut(); fut2.await; // Do something synchronous here. // ... goto LOOP; // Do the left, either synchronously or asynchronously, // or loop from the some block above. // ... } æ‰€ä»¥ await æ˜¯æ€ä¹ˆå®ç°çš„ï¼Ÿä¸ async ä¸€æ ·ï¼Œawait æ˜¯ Rust è¯­è¨€æä¾›çš„å¦ä¸€ä¸ªè¯­æ³•ç³–ï¼Œç¼–è¯‘å™¨ä¼šè‡ªåŠ¨å°†å®ƒè½¬æ¢æˆå¯¹ poll çš„è°ƒç”¨ã€‚æœ€ç»ˆè¿™æ®µä»£ç å°†å˜æˆå¦‚ä¸‹çš„æ ·å­ï¼š\nenum State { Sync(u32), Async(u32), } struct EchoHandleFuture { state: State, fut1: Pin\u0026lt;\u0026amp;mut SocketRead\u0026gt;, fut2: Pin\u0026lt;\u0026amp;mut SocketWrite\u0026gt;, // other contexts... } impl Future for EchoHandleFuture { type Output = (); pub fn poll(self: Pin\u0026lt;\u0026amp;mut Self\u0026gt;, cx: \u0026amp;mut Context\u0026lt;\u0026#39;_\u0026gt;) -\u0026gt; Poll\u0026lt;Self::Output\u0026gt; { loop { match self.state { Sync(STATE_1) =\u0026gt; { self.sync_block_1(); self.state = Sync(STATE_2); // Go to STATE_2 sync; } Sync(STATE_2) =\u0026gt; { self.fut1 = pin!(self.create_socket_read_fut()); self.state = Async(STATE_3); // Go to STATE_3 async; } Async(STATE_3) =\u0026gt; match self.fut1.poll(cx) { Pending =\u0026gt; return Pending, // Wait until fut1 ready; Ready(_) =\u0026gt; { // Record the result here. self.state = Sync(STATE_4); // Go to STATE_4 sync; } }, Sync(STATE_4) =\u0026gt; { self.sync_block_2(); self.state = Sync(STATE_5); // Go to STATE_5 sync; } Sync(STATE_5) =\u0026gt; { self.fut2 = pin!(self.create_socket_write_all_fut()); self.state = Async(STATE_6); // Go to STATE_6 async; } Async(STATE_6) =\u0026gt; match self.fut2.poll(cx) { Pending =\u0026gt; return Pending, // Wait until fut2 ready; Ready(_) =\u0026gt; { self.state = Sync(STATE_7); // Go to STATE_7 sync; } }, Sync(STATE_7) =\u0026gt; { self.sync_block_3(); self.state = Sync(STATE_2); // Loop from STATE_2, i.e. fut1; }, // Other states, either sync or async. // ... } } Ready(()) // Finally we are ready. } } è¿™ä¸€æ®µä»£ç æ˜¯æˆ‘äººè‚‰ç¿»è¯‘çš„ï¼Œæ²¡æœ‰ç»†ç©¶ Rust ç¼–è¯‘å™¨çš„çœŸå®è¡Œä¸ºï¼Œä½†åŸºæœ¬çš„æ€æƒ³æ˜¯ä¸€è‡´çš„ã€‚å¯ä»¥çœ‹åˆ°ä¸Šè¿°çš„çŠ¶æ€æœºä¸­ï¼Œå› ä¸ºåœ¨å±•å¼€è¿‡ç¨‹ä¸­æ— æ³•å¾—çŸ¥ runtimeï¼Œcontext æ˜¯ç®€å•åœ°ä»çˆ¶ Future ä¸€è·¯ä¼ é€’ç»™å­ Futureã€‚åŒæ ·ï¼ŒRust åœ¨ç¼–è¯‘æ—¶ä¹Ÿæ— æ³•å¾—çŸ¥ runtime çš„å­˜åœ¨ï¼Œå› æ­¤æ— æ³•åšå‡ºé¢å¤–çš„æ“ä½œï¼Œä¹Ÿæ˜¯ç®€å•çš„ä¼ é€’ contextï¼Œè¿™åœ¨ç‰¹æ®Šæƒ…å†µä¸‹ä¼šå¼•èµ·å¥‡æ€ªçš„é—®é¢˜ [7]ã€‚ æ—¢ç„¶æˆ‘ä»¬å·²ç»çŸ¥é“çš„çŠ¶æ€æœºçš„å½¢çŠ¶ï¼Œæˆ‘ä»¬å¯ä»¥å¾—çŸ¥ä»¥ä¸‹ä¸¤ä¸ªä¿¡æ¯ï¼š\nasync ä»£ç å—/å‡½æ•°æ˜¯é¡ºåºæ‰§è¡Œçš„ï¼Œå®ƒå†…éƒ¨å¯ä»¥å­˜åœ¨ä¸¤ä¸ª future æ˜¯å¹¶å‘çš„ï¼Œä½†ç»å¯¹ä¸ä¼šæ˜¯å¹¶è¡Œï¼ˆin parallelï¼‰çš„ ç»†å¿ƒçš„åŒå­¦ä¼šå‘ç° await å¹¶ä¸èƒ½å®ç°å¹¶å‘ï¼Œä¾‹å­ä¸­ fut1 å’Œ fut2 å°±æ˜¯é¡ºåºæ‰§è¡Œçš„ï¼Œä½†å®é™…ä¸Šæˆ‘ä»¬å¯ä»¥ç®€å•ç”¨å¦‚ä¸‹æ–¹å¼å®ç°ä¸¤ä¸ª Future çš„äº¤æ›¿æ‰§è¡Œï¼ˆå¹¶å‘ï¼‰ï¼Œç”¨è¿™ç§æ€æƒ³æˆ‘ä»¬å¯ä»¥å®ç°å¾ˆå¤šæœ‰æ„æ€çš„è¯­ä¹‰ï¼Œæ¯”å¦‚ select / join all ç­‰ï¼› struct JoinFuture\u0026lt;F1, F2\u0026gt; where F1: Future\u0026lt;Output = ()\u0026gt;, F2: Future\u0026lt;Output = ()\u0026gt;, { fut1: Pin\u0026lt;\u0026amp;mut F1\u0026gt;, fut1_done: bool, fut2: Pin\u0026lt;\u0026amp;mut F2\u0026gt;, fut2_done: bool, } impl\u0026lt;F1, F2\u0026gt; Future for JoinFuture\u0026lt;F1, F2\u0026gt; where F1: Future\u0026lt;Output = ()\u0026gt;, F2: Future\u0026lt;Output = ()\u0026gt;, { type Output = (); pub fn poll(self: Pin\u0026lt;\u0026amp;mut Self\u0026gt;, cx: \u0026amp;mut Context\u0026lt;\u0026#39;_\u0026gt;) -\u0026gt; Poll\u0026lt;Self::Output\u0026gt; { if !self.fut1_done { if let Ready(_) = self.fut1.poll(cx) { fut1_done = true; } } if !self.fut2_done { if let Ready(_) = self.fut2.poll(cx) { fut2_done = true; } } if self.fut1_done \u0026amp;\u0026amp; self.fut2_done { Ready(()) } else { Pending } } } runtime åœ¨æ²¡æœ‰è¿è¡Œèµ·æ¥å‰ï¼Œæ˜¯æ— æ³•æ„ŸçŸ¥ async ä»£ç å—ä¸­çš„å­ Future çš„å­˜åœ¨çš„ æ‰€ä»¥ï¼Œæ‰€æœ‰çš„ async runtime çš„åŸºæœ¬è°ƒåº¦å•ä½éƒ½æ˜¯é¡¶å±‚çš„ Futureï¼Œé€šå¸¸å®ƒä»¬ä¼šè¢«å°è£…æˆä¸€ä¸ª Taskã€‚Task å†…éƒ¨çš„è¿è¡Œä¸€å®šä¸æ˜¯å¹¶è¡Œçš„ï¼ŒTask é—´æ‰èƒ½å¹¶è¡Œã€‚å› æ­¤ç±»ä¼¼ tokio ç­‰è¿è¡Œæ—¶å®ç°éƒ½æä¾›äº†å’Œçº¿ç¨‹ä¸€æ ·çš„ spawn æ–¹æ³•ç”¨æ¥å¯åŠ¨ä¸€ä¸ªå¯ä»¥å¹¶è¡Œæ‰§è¡Œçš„åç¨‹ã€‚ä¸ºäº†æ–¹ä¾¿èµ·è§ï¼Œä¹‹åå°† runtime èƒ½æ„ŸçŸ¥çš„é¡¶å±‚ Future ç»Ÿç§°ä¸ºä»»åŠ¡ï¼ˆTaskï¼‰ï¼Œå®ƒæ˜¯ runtime çš„åŸºæœ¬è°ƒåº¦å•ä½ã€‚\nWaker åœ¨äº†è§£äº† Rust ä¸­åç¨‹çš„å‘ˆç°å½¢å¼ \u0026ndash; async/await çš„åŸºæœ¬åŸç†ä¹‹åï¼Œæˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹ä¹‹å‰æ‰€è¯´çš„ Wakerã€‚\nåœ¨ä»»åŠ¡çš„å®Œæ•´è¿è¡Œè¿‡ç¨‹ä¸­ï¼Œå¯èƒ½ä¼šæ¶‰åŠåˆ°å¤šæ¬¡æš‚åœã€æ¢å¤çš„è¿‡ç¨‹ã€‚æ˜¾ç„¶ï¼Œæ¯æ¬¡çš„ä»»åŠ¡çš„å”¤é†’æ¡ä»¶éƒ½å¯èƒ½ä¸åŒã€‚ä»¥ä¸Šé¢çš„ä»£ç ä¸ºä¾‹ï¼Œsocket.read éœ€è¦åœ¨å¯¹åº”çš„ socket æœ‰è¯»äº‹ä»¶æ—¶å”¤é†’ï¼Œè€Œ socket.write éœ€è¦åœ¨æœ‰å†™äº‹ä»¶æ—¶å”¤é†’ï¼Œå› æ­¤è¿è¡Œæ—¶æ˜¯æ— æ³•åœ¨ä¸€å¼€å§‹å°±å¾—çŸ¥ä»»åŠ¡éœ€è¦åœ¨ä½•æ—¶å”¤é†’çš„ã€‚ç°åœ¨æˆ‘ä»¬å¯ä»¥å…³æ³¨ Future::poll çš„ Context å‚æ•°äº†ï¼Œä»æ–‡æ¡£ä¸­æˆ‘ä»¬å¯ä»¥å¾—çŸ¥ Context ä¸»è¦ç”¨äºè·å–è‡ªèº« waker çš„å¼•ç”¨ã€‚è°ƒç”¨ waker.wake() å¯ä»¥å°†æ‰€åœ¨çš„ä»»åŠ¡å”¤é†’ï¼Œå³é‡æ–°åŠ å…¥è°ƒåº¦é˜Ÿåˆ—ã€‚Rust çš„è¿™ç§è®¾è®¡å°† Waker å’Œäº‹ä»¶é©±åŠ¨å™¨çš„ç»‘å®šä¸‹æ¨ç»™äº†ä¸€äº›åŸºæœ¬çš„ Futureï¼Œä¾‹å¦‚ SocketReadã€‚å½“ SocketRead éœ€è¦è®©å‡ºæ§åˆ¶æƒå‰ï¼Œéœ€è¦å°†å®ƒçš„ Waker å’Œäº‹ä»¶é©±åŠ¨å™¨ç»‘å®šèµ·æ¥ï¼Œä»è€Œä¿è¯äº‹ä»¶é©±åŠ¨å™¨ä¸­çš„äº‹ä»¶å‘ç”Ÿæ—¶ä¼šå°†å®ƒæ‰€åœ¨çš„ä»»åŠ¡å”¤é†’èµ·æ¥ã€‚å½“ç„¶ï¼Œè¿™äº›åŸºæœ¬ Future å’Œäº‹ä»¶é©±åŠ¨å™¨éƒ½éœ€è¦æœ‰äººå®ç°ï¼Œå¹¶ç”±è¿è¡Œæ—¶å¯åŠ¨èµ·æ¥ã€‚\nåœ¨è¿è¡ŒæœŸé—´ï¼ŒFuture è·å–çš„ Waker æ˜¯ç”±è¿è¡Œæ—¶ä¼ é€’è¿›æ¥çš„ï¼Œç†è®ºä¸Šæ¥è¯´å®ƒä»…èƒ½æ„ŸçŸ¥ Future æ‰€åœ¨çš„ä»»åŠ¡ã€‚è®¾æƒ³æˆ‘ä»¬æœ‰å¦‚ä¸‹ä»£ç ï¼š\nasync fn do() { let fut1 = do_action1(); let fut2 = do_action2(); join_all!(fut1, fut2).await; } å…¶ä¸­ join_all çš„è¯­ä¹‰æ˜¯å®Œæˆæ‰€æœ‰çš„å­ä»»åŠ¡ã€‚åœ¨ä¸Šæ–‡ä¸­æœ‰ä¸€ä¸ªè¯¥è¯­ä¹‰çš„ç®€å•å®ç°ï¼šæ¯å½“ä»»åŠ¡è¢«å”¤é†’æ—¶ï¼Œpoll ä¸€ä¸‹æ‰€æœ‰çš„å­ Future æ¥æ¨è¿›è¿è¡ŒçŠ¶æ€ã€‚æ˜¾ç„¶ï¼Œå½“å­ Future æ•°é‡å¤šæ—¶ï¼Œè¿™ä¸ªå®ç°ä¼šå‡ºç°æ€§èƒ½é—®é¢˜ã€‚åœ¨ futures è¿™ä¸ª crate ä¸­æä¾›äº†ä¸€ä¸ªå®ç° FuturesUnorderedï¼Œå®ƒé’ˆå¯¹å¤§é‡å­ Future çš„ join åšäº†ä¸€ä¸ªä¼˜åŒ–ï¼šä»»åŠ¡è¢«å”¤é†’çš„æ—¶å€™åªæœ‰ç›¸åº”çš„ Future è¢«å†æ¬¡ pollï¼Œä¹Ÿå°±æ˜¯å®ç°äº†å¯¹ä»»åŠ¡å†…éƒ¨ Future çš„æ„ŸçŸ¥ã€‚ç®€å•æ¥è¯´ï¼ŒFuturesUnordered ç»´æŠ¤äº†ä¸€ä¸ª active çš„ Future çš„é˜Ÿåˆ—ï¼Œä¸”åœ¨ poll å†…éƒ¨ Future æ—¶ä½¿ç”¨äº†å®ƒå¢å¼ºè¿‡åçš„ Waker \u0026ndash; åœ¨ wake çš„åŒæ—¶å°† Future æ”¾å…¥ active é˜Ÿåˆ—ä¸­ã€‚å®ç°ç»†èŠ‚å¯ä»¥å‚è€ƒä»£ç ï¼Œè¿™é‡Œä¸å†èµ˜è¿°ã€‚\nYield Future çš„æ‰§è¡Œæ˜¯ä¸€ç§è¢«åŠ¨æ‹‰å–çš„æ–¹å¼ï¼Œå…¶ä¸­çš„æ§åˆ¶æƒè½¬ç§»ä¹Ÿæ˜¯åœ¨æ‰§è¡Œæ—¶éšå¼åœ°å‘ç”Ÿã€‚å¦‚æœæˆ‘ä»¬æƒ³è¦æ˜¾ç¤ºåœ°è½¬ç§»æ§åˆ¶æƒå‘¢ï¼Ÿåˆ†ä¸ºä»¥ä¸‹ä¸‰ç§æƒ…å†µï¼š\næ§åˆ¶æƒäº¤è¿˜ç»™è¿è¡Œæ—¶ æ§åˆ¶æƒç«‹å³äº¤ç»™å¦ä¸€ä¸ªåç¨‹ æ§åˆ¶æƒäº¤ç»™è°ƒç”¨è€…ï¼Œé€šå¸¸åŒæ—¶è¿”å›ä¸€ä¸ªå€¼ç”±è°ƒç”¨è€…å¤„ç† å¯¹åº”çš„ä¼ªä»£ç å¦‚ä¸‹æ‰€ç¤ºï¼š\nyield // 1 yield to A // 2 yield a // 3 ç¬¬ä¸€ç§æ§åˆ¶æƒè½¬äº¤ç»™è¿è¡Œæ—¶åœ¨ Rust ä¸­æ—¶åˆ»åœ¨å‘ç”Ÿï¼Œæ ¹æ®ä¹‹å‰æ‰€è¿°çš„åŸç†ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥ç®€å•åœ°å®ç°ä¸€ä¸ª yieldã€‚\npub struct Yield { yielded: bool, } impl Future for Yield { type Output = (); fn poll(self: Pin\u0026lt;\u0026amp;mut Self\u0026gt;, cx: \u0026amp;mut Context\u0026lt;\u0026#39;_\u0026gt;) -\u0026gt; Poll\u0026lt;Self::Output\u0026gt; { if self.yielded { return Poll::Ready(()); } self.yielded = true; cx.waker().wake_by_ref(); Poll::Pending } } fn yield() -\u0026gt; Yield { Yield { yielded : false } } async fn with_yield() { // Yield once. yield().await; } ç¬¬äºŒç§ç«‹å³è½¬äº¤æ§åˆ¶æƒçš„ä¸€ä¸ªå…¸å‹çš„ä¾‹å­å°±æ˜¯ä¸¤ä¸ªåç¨‹ ping-pongï¼Œç›®å‰æˆ‘è¿˜æ²¡æœ‰äº†è§£åˆ° Rust ä¸‹æœ‰ä»€ä¹ˆæ–¹å¼å®ç°è¿™ç§æ§åˆ¶æƒè½¬ç§»ã€‚\nç¬¬ä¸‰ç§é€šå¸¸ç‰¹åŒ–æˆ generatorï¼Œåœ¨ Rust ä¸­å¯¹åº”çš„æ¨¡å‹æ˜¯ Streamï¼Œå¯ä»¥ç†è§£ä¸ºæ˜¯ä¸€ä¸ªå¼‚æ­¥çš„è¿­ä»£å™¨ã€‚Stream ç›®å‰è¿˜ä¸æ˜¯ä¸€ä¸ªç¨³å®šçš„ featureã€‚\npub trait Stream { type Item; fn poll_next( self: Pin\u0026lt;\u0026amp;mut Self\u0026gt;, cx: \u0026amp;mut Context\u0026lt;\u0026#39;_\u0026gt; ) -\u0026gt; Poll\u0026lt;Option\u0026lt;Self::Item\u0026gt;\u0026gt;; fn size_hint(\u0026amp;self) -\u0026gt; (usize, Option\u0026lt;usize\u0026gt;) { ... } } async fn handle() { let stream = new_stream(); while let Some(item) = stream.next().await { process(item).await; } } Runtime æ€»ç»“ä¸€ä¸‹ï¼ŒRust çš„åç¨‹çš„è¿è¡Œæ—¶å¤§æ¦‚å¦‚ä¸‹å›¾æ‰€ç¤ºï¼ˆä»…ä»¥ IO ä¸ºä¾‹ï¼‰ï¼š\nAsync Runtime â€“ Task, Worker and Waker æ€»ç»“ æœ¬æ–‡ä¸»è¦èŠäº†èŠ Rust å’Œ Go ä¸¤ç§ç¼–ç¨‹è¯­è¨€ä¸­åç¨‹çš„ç¼–ç¨‹æ¨¡å‹å’Œå¤§è‡´åŸç†ï¼Œä¹Ÿç®—æ˜¯è¡¥å…¨äº†æˆ‘å¯¹æ— æ ˆåç¨‹è¿è¡Œæ–¹å¼çš„äº†è§£ã€‚ç”±äºç¯‡å¹…å—é™ï¼Œè¿™é‡Œæœ‰ä¸€äº›æ–¹é¢æ— æ³•ä¸€ä¸€å±•ç°ï¼Œæ¯”å¦‚ Rust åç¨‹çš„å–æ¶ˆã€å¹¶å‘æ¨¡å‹çš„å¯¹æ¯”ç­‰ï¼Œå¯èƒ½ä¼šåœ¨åç»­çš„æ–‡ç« ä¸­è®¨è®ºã€‚\næ°´å¹³æœ‰é™ï¼Œé”™è¯¯ç–æ¼åœ¨æ‰€éš¾å…ï¼Œè¿˜å¸Œæœ›å„è·¯å¤§ä½¬ä¸åèµæ•™ã€‚\nP.S. è¯„è®ºç³»ç»Ÿæ¢æˆäº† beaudarï¼Œæ„Ÿè§‰è¿˜ä¸é”™ï¼Œæ¬¢è¿ç•™è¨€æ¢è®¨ ğŸ˜€ã€‚\nå‚è€ƒæ–‡çŒ® [1] https://en.wikipedia.org/wiki/Coroutine\n[2] https://golang.org/doc/effective_go#goroutines\n[3] https://github.com/golang/proposal/blob/master/design/24543-non-cooperative-preemption.md\n[4] https://rust-lang.github.io/async-book/\n[5] https://samsartor.com/coroutines-1/\n[6] https://en.wikipedia.org/wiki/Async/await\n[7] https://stackoverflow.com/questions/60964709/why-do-i-not-get-a-wakeup-for-multiple-futures-when-they-use-the-same-underlying\n[8] https://riteeksrivastava.medium.com/a-complete-journey-with-goroutines-8472630c7f5c\n[9] https://rakyll.org/scheduler/\n","date":"2021-09-09T00:37:00+08:00","image":"https://blog.crazyark.me/p/coroutines-rust-and-go/img/coroutines_how_hu2f1e02e515e351c311ec896043222feb_132661_120x120_fill_q75_box_smart1.jpg","permalink":"https://blog.crazyark.me/p/coroutines-rust-and-go/","title":"ä»£ç æ‚è°ˆï¼šåç¨‹"},{"content":"ä¼—æ‰€å‘¨çŸ¥ï¼Œæ•°æ®åº“ç®¡ç†ç³»ç»Ÿéœ€è¦æ»¡è¶³æ•°æ®æ“ä½œçš„æŒä¹…æ€§ï¼Œå³ä¿è¯æ“ä½œçš„è¯·æ±‚åœ¨è¿”å›ä¹‹å‰ï¼Œå¯¹åº”çš„æ•°æ®ä¸€å®šæ˜¯å·²ç»ä¿å­˜åœ¨éæ˜“å¤±æ€§å­˜å‚¨ä¸­ \u0026ndash; é€šå¸¸æ¥è¯´ï¼Œå°±æ˜¯ç£ç›˜ã€‚è€Œå¤§å¤šæ•°æ•°æ®åº“ç³»ç»Ÿéƒ½æ˜¯æ„å»ºåœ¨æ“ä½œç³»ç»Ÿæä¾›çš„æ–‡ä»¶ç³»ç»Ÿä¹‹ä¸Šçš„ï¼Œå› ä¸ºä¸åŒçš„å­˜å‚¨è®¾å¤‡å¾€å¾€æœ‰ç€ä¸åŒçš„ç‰¹æ€§å’Œäº¤äº’æ–¹å¼ï¼Œæ“ä½œç³»ç»Ÿå’Œæ–‡ä»¶ç³»ç»Ÿå¸®åŠ©å±è”½äº†ç‰©ç†ç»†èŠ‚ã€‚å½“ç„¶ä¹Ÿä¸æ’é™¤ç›´æ¥ä½¿ç”¨å—è®¾å¤‡æ“ä½œæˆ–æ˜¯ä½¿ç”¨ç”¨æˆ·ç©ºé—´é©±åŠ¨ (e.g. SPDK) æ“ä½œçš„ï¼Œå…¶ä¼˜åŒ–æ€æƒ³åº”å½“æ˜¯ä¸€æ ·çš„ï¼Œæœ¬æ–‡ä¸åšé¢å¤–è®¨è®ºã€‚\nå­˜å‚¨ Buffered / Direct IO æ“ä½œç³»ç»Ÿå’Œæ–‡ä»¶ç³»ç»Ÿå¯¹å­˜å‚¨åšäº†å±‚å±‚å°è£…ï¼Œæœ€ç»ˆæä¾›ç»™æˆ‘ä»¬è¿™äº›é€šç”¨çš„æ“ä½œæ–¹å¼ï¼Œå¦‚ä¸‹ C å‡½æ•°æ‰€ç¤ºï¼ˆæ‘˜æŠ„è‡ª macOS çš„ manualï¼‰ï¼š\n// æ‰“å¼€æ–‡ä»¶æè¿°ç¬¦ int open(const char *path, int oflag, ...); // å…³é—­æ–‡ä»¶æè¿°ç¬¦ int close(int fd); // é¡ºåºè¯»å†™ ssize_t read(int fd, void *buf, size_t nbyte); ssize_t write(int fd, const void *buf, size_t nbyte); // æŒ‡å®š offset è¯»å†™ ssize_t pread(int fd, void *buf, size_t nbyte, off_t offset); ssize_t pwrite(int fd, const void *buf, size_t nbyte, off_t offset); è¿™é‡Œé¢æœ‰ä¸ªä¸å¯é¿å…çš„é—®é¢˜ï¼šå½“æˆ‘è¿›è¡Œä¸€æ¬¡æ–‡ä»¶æ“ä½œçš„æ—¶å€™ï¼Œå®ƒæ˜¯å¦å·²ç»å†™å…¥äº†ç£ç›˜ï¼Œaka. å³ä½¿æ–­ç”µä¹Ÿä¸ä¼šä¸¢å¤±ï¼Ÿäº†è§£è¿‡æ“ä½œç³»ç»Ÿçš„åŒå­¦éƒ½çŸ¥é“ï¼Œä¸ºäº†ä¼˜åŒ–æ€§èƒ½ï¼Œæ“ä½œç³»ç»Ÿé€šå¸¸ä¼šæä¾›ä¸€ç§å« page cache çš„ä¸œè¥¿ã€‚\nå½“ä½¿ç”¨ read æ“ä½œè¿›è¡Œä¸€æ¬¡è¯»å–çš„æ—¶å€™ï¼Œå¦‚æœæ­¤æ—¶å¯¹åº”æ–‡ä»¶ç£ç›˜åŒºåŸŸçš„ page cache ä¸å­˜åœ¨ï¼Œæ“ä½œç³»ç»Ÿä¼šå…ˆå°†å¯¹åº”çš„å†…å®¹è¯»å–å‡ºæ¥ï¼Œå­˜æ”¾åˆ° page cache ä¸­ï¼Œç„¶ååœ¨å…¶ä¸­æ‹·è´å¯¹åº”çš„å†…å®¹åˆ°ç”¨æˆ·ç»™çš„ buffer ä¸­ï¼Œå†è¿”å›ç»™ç”¨æˆ·ï¼› å½“ä½¿ç”¨ write æ“ä½œè¿›è¡Œä¸€æ¬¡å†™å…¥çš„æ—¶å€™ï¼ŒåŒæ ·ä¹Ÿä¼šå…ˆå‡†å¤‡å¥½ page cacheï¼Œç„¶åå°†å¯¹åº”çš„å†…å®¹æ‹·è´åˆ° page cache ä¸Šï¼Œæ­¤æ—¶ç«‹å³è¿”å›ç»™ç”¨æˆ·ç¨‹åºå‘ŠçŸ¥å†™å…¥æˆåŠŸï¼› å½“å†™å…¥æˆåŠŸæ—¶ï¼Œå¯¹åº” page cache çš„æ•°æ®å’Œç£ç›˜ä¸Šçš„æ•°æ®å·²ç»å­˜åœ¨å·®å¼‚äº†ï¼Œæ“ä½œç³»ç»Ÿå°†è´Ÿè´£å°†å®ƒå›å†™åˆ°ç£ç›˜ä¸Šï¼Œç”¨ä¸€ç§ å¼‚æ­¥çš„ æ–¹å¼ï¼› è¿™ç§æ–¹å¼é€šå¸¸è¢«ç§°ä¸º buffered IOï¼Œç›¸å¯¹åº”çš„ä¹Ÿä¼šæœ‰å¦ä¸€ç§ unbuffered IOï¼Œé©¬ä¸Šä¼šè¿›è¡Œä»‹ç»ã€‚å€¼å¾—æ³¨æ„çš„æ˜¯ï¼Œå†™å…¥æ“ä½œå¹¶ä¸æ˜¯åˆ°è¾¾ç£ç›˜æ‰è¿”å›çš„ï¼Œå› æ­¤ç”¨æˆ·ç¨‹åºæ­¤æ—¶è¿˜æ²¡æœ‰åŠæ³•çŸ¥é“è‡ªå·±çš„æ•°æ®æ˜¯å¦å·²ç»æŒä¹…åŒ–äº†ï¼Œæˆ‘ä»¬æš‚ä¸”å…ˆæ”¾ä¸€ä¸‹ï¼Œå…ˆçœ‹çœ‹å®ƒæœ‰ä»€ä¹ˆä¼˜ç¼ºç‚¹ã€‚\nåœ¨æ™®éçš„è¯»å†™è´Ÿè½½ä¸‹ï¼Œ\u0008buffered IO è¦æ¯” unbuffered IO å¿«å‡ºå‡ ä¸ªæ•°é‡çº§ï¼Œä¸»è¦æœ‰ä»¥ä¸‹å‡ ä¸ªåŸå› ï¼š\nå¤§å¤šæ•°éæ˜“å¤±æ€§å­˜å‚¨çš„è¯»å†™æ¨¡å¼éƒ½ä¸æ˜¯æŒ‰ç…§ byte æ¥çš„ï¼Œè€Œæ˜¯æŒ‰ç…§å—ä¸ºå•ä½ï¼Œä¸€æ¬¡è¯»å†™çš„æœ€å°å•ä½å°±æ˜¯å—ã€‚åœ¨æ—©æœŸçš„ç£ç›˜ä¸Šè¿™ä¸ªæ•°å­—æ˜¯ 512 bytesï¼ˆå¯¹åº”ä¸€ä¸ªæ‰‡åŒºï¼‰ï¼ŒSSD ä¸Šåˆ™æ˜¯ 4096 bytesï¼ˆå¯¹åº”ä¸€ä¸ªé¡µï¼‰ã€‚è¿™æ„å‘³ç€ 1 byte çš„ä¿®æ”¹è¦å†™å…¥ç£ç›˜å°±è¦é¢å¤–å¼•å…¥ 511 æˆ–è€… 4093 ä¸ª bytes çš„å†™å…¥ï¼Œæœ¬æ¥å°±ä¸å¯Œè£•çš„ç£ç›˜å¸¦å®½æ›´ä¼šé›ªä¸ŠåŠ éœœï¼› é¢˜å¤–è¯ï¼ŒIntel å®¶çš„ Optane è®¾å¤‡æœ€å°å†™å…¥å•ä½æ˜¯ 8 bytes æˆ‘è®°å¾—ï¼Œå±å®æœ‰ä¸€ç‚¹ç¦»è°± å½“å¼•å…¥ page cache åï¼Œåœ¨åŒä¸€ä¸ª page ä¸Šè¿›è¡Œçš„å¤šæ¬¡æ“ä½œå¯ä»¥åˆå¹¶æˆä¸€æ¬¡ç£ç›˜å†™å…¥æ“ä½œï¼Œä¸ä»…ç¬¦åˆå—è¯»å–/å†™å…¥çš„è§„å®šï¼Œè€Œä¸”æœ‰æ•ˆå‡å°‘äº†ç£ç›˜æ“ä½œï¼› å¦å¤–ï¼Œæ“ä½œç³»ç»Ÿå¹¶ä¸æ˜¯å‚»å‚»åœ°ç­‰ç€åº”ç”¨ç¨‹åºè¯»å–/å†™å…¥æ—¶æ‰å‡†å¤‡ page cacheï¼Œæ ¹æ®è®¿é—®æ¨¡å¼/ç”¨æˆ· adviceï¼Œæ“ä½œç³»ç»Ÿä¼šæå‰è¯»å–ç£ç›˜å†…å®¹åˆ°å†…å­˜ä¸­ï¼Œä½¿å¾— CPU å’Œç£ç›˜æ›´å……åˆ†çš„è¢«ï¼ˆåŒæ—¶ï¼‰ä½¿ç”¨èµ·æ¥ï¼Œä»è€Œæå‡åº”ç”¨ç¨‹åº IO æ“ä½œçš„å“åº”é€Ÿåº¦ï¼› ç»¼ä¸Šï¼Œæ“ä½œç³»ç»Ÿé»˜è®¤å°±ä¼šæ‰“å¼€ page cache æ¥æå‡æ€§èƒ½ã€‚ä½†ç”±äºæ§åˆ¶ page cache çš„æ“ä½œç³»ç»Ÿæ— æ³•å®Œå…¨é¢„æµ‹åº”ç”¨ç¨‹åºçš„è¡Œä¸ºï¼Œåè€Œä¼šå¯¼è‡´æŸäº›åº”ç”¨ç¨‹åºæ— æ³•æœ‰æ•ˆåˆ©ç”¨ç£ç›˜ï¼Œä¾‹å¦‚æ•°æ®åº“ç®¡ç†ç³»ç»Ÿã€‚ä¸å¿…æƒŠæ…Œï¼Œæƒ³å¿…å¾ˆå¤šåŒå­¦éƒ½äº†è§£è¿‡ direct (unbuffered) IOï¼Œå¯ä»¥å…³é—­æ“ä½œç³»ç»Ÿçš„ page cacheï¼Œè®©æ¯ä¸€æ¬¡è¯»å†™éƒ½ç›´æ¥ç»è¿‡ç£ç›˜ã€‚å‡ ä¹æ‰€æœ‰çš„æ“ä½œç³»ç»Ÿéƒ½æä¾›äº† direct IOï¼Œä¾‹å¦‚åœ¨ Linux ä¸Šæˆ‘ä»¬ç”¨è¿™ç§æ–¹å¼æ‰“å¼€æ–‡ä»¶ï¼š\nint fd = open(\u0026#34;/path/to/file\u0026#34;, O_CREAT | O_RDWR | O_DIRECT); å°±è·å¾—äº†ä¸€ä¸ªå…³é—­ page cache çš„æ–‡ä»¶æè¿°ç¬¦ã€‚æ­¤æ—¶å†è¿›è¡Œ read/write æ“ä½œæ—¶ï¼Œä¼šç›´æ¥å¯¹ç£ç›˜è®¾å¤‡è¿›è¡Œè¯·æ±‚ã€‚ç”±äºè¯·æ±‚çš„ç‰¹æ®Šæ€§ï¼ˆDMA æ“ä½œï¼‰ï¼ŒLinux ç”šè‡³å¯¹ä¼ å…¥ read/write çš„å‚æ•°æœ‰é¢å¤–çš„è¦æ±‚ï¼šbuf çš„åœ°å€è¦åšåˆ°æ‰‡åŒºå¯¹é½ï¼Œä¸”å¤§å°æ˜¯æ‰‡åŒºçš„æ•´æ•°å€ã€‚æ˜¾ç„¶ï¼Œåœ¨ç±»ä¼¼é¡ºåºå†™ï¼ˆæ—¥å¿—æ–‡ä»¶ï¼‰è¿™ç§åœºæ™¯ä¸­ï¼Œdirect IO çœå»äº†å†…å­˜æ‹·è´ï¼Œä¹Ÿæ›´èƒ½å®Œå…¨å‘æŒ¥ç£ç›˜çš„æ€§èƒ½ã€‚ä¹Ÿæ­£å› æ­¤ï¼Œæ•°æ®åº“ç³»ç»Ÿä¼šå€¾å‘äºä½¿ç”¨ direct çš„æ–¹å¼æ¥å†™å®ƒçš„ write-ahead logï¼ˆWALï¼‰ã€‚\nå¬èµ·æ¥åˆ°è¿™é‡Œæˆ‘ä»¬å°±å·²ç»èƒ½ä¿è¯æ•°æ®åº“ç®¡ç†ç³»ç»Ÿçš„æŒä¹…æ€§äº†ï¼šç”¨ direct çš„æ–¹å¼å†™ WALï¼Œå†™å…¥æˆåŠŸæ„å‘³ç€ç£ç›˜ä¸ŠæŒä¹…åŒ–æˆåŠŸäº†ï¼Œå¯æ˜¯çœŸçš„å¦‚æ­¤ä¹ˆï¼Ÿ\nåŒæ­¥å†™ (Synchronized Write) ç†Ÿæ‚‰ Linux å‡ ä¸ªæ–‡ä»¶æ¥å£çš„åŒå­¦ä¸€å®šçŸ¥é“ï¼Œé™¤äº†ä¸Šè¿°æˆ‘åˆ—å‡ºçš„ä¸€äº›å‚æ•°å’Œæ¥å£ä»¥å¤–ï¼Œè¿˜æœ‰å¦‚ä¸‹çš„å‡ ä¸ªå‚æ•°å’Œæ¥å£ï¼š\nO_SYNC // åŒæ­¥å†™ï¼Œæ“ä½œç³»ç»Ÿå°†å°½å¯èƒ½ç­‰å¾…æ•°æ®çœŸçš„å†™å…¥åˆ°å¯¹åº”çš„è®¾å¤‡ O_DSYNC // åŒæ­¥å†™ï¼Œå’Œä¸Šé¢æœ‰æ‰€åŒºåˆ«çš„æ˜¯åªç­‰å¾…æ•°æ®å†™å…¥åˆ°å¯¹åº”çš„è®¾å¤‡ int fsync(int fd); // åŒæ­¥æ–‡ä»¶ä¿®æ”¹ï¼Œæ“ä½œç³»ç»Ÿå°†å°½å¯èƒ½åœ°å°†æ‰€æœ‰æ–‡ä»¶ä¿®æ”¹å†™å…¥åˆ°è®¾å¤‡ int fdatasync(int fd); // åŒæ­¥æ–‡ä»¶ä¿®æ”¹ï¼Œä¸è¿‡ä¹Ÿæ˜¯åªç­‰å¾…æ•°æ®å’Œæ•°æ®ç›¸å…³å…ƒæ•°æ®å†™å…¥è®¾å¤‡ ä¸ºä»€ä¹ˆè¦æœ‰è¿™äº›å‚æ•°å’Œæ¥å£ï¼Ÿå› ä¸ºé™¤äº†æ“ä½œç³»ç»Ÿæœ‰ç¼“å­˜ï¼Œå­˜å‚¨è®¾å¤‡ä¹Ÿæœ‰ç¼“å­˜ï¼ˆä½ æè¿™å¥—å¨ƒå‘¢ï¼‰ï¼Œè€Œdirect write åªæ˜¯å°†ç”¨æˆ·çš„ buffer æ‹·è´åˆ°äº†å­˜å‚¨è®¾å¤‡çš„ç¼“å­˜ä¹‹ä¸­ã€‚å½“ç„¶çƒ­å¿ƒçš„åŒå­¦å¯èƒ½è¦é—®äº†ï¼Œå­˜å‚¨è®¾å¤‡çš„ç¼“å­˜æœ‰ä»€ä¹ˆç”¨ï¼ŸAFAIK [5]ï¼Œ\nç¼“å­˜è¯»å–ï¼Œé™¤äº†æ“ä½œç³»ç»Ÿä¼šåš prefetchï¼Œå­˜å‚¨è®¾å¤‡ä¹Ÿä¼šåšï¼› ç¼“å­˜å†™å…¥ï¼Œç¼“å­˜çš„ä¸€å¤§é‡è¦æ„ä¹‰å°±æ˜¯æŠŠæ¯”å¦‚è„‰å†²å¼åœ°å†™å…¥æ‹‰å¹³ï¼Œå¹¶ä¸”å¯ä»¥ç«‹å³è¿”å›ç»™ç”¨æˆ·ï¼› ç¼“å­˜æŒ‡ä»¤ï¼Œå­˜å‚¨è®¾å¤‡å¯ä»¥å°†è¯»å†™æŒ‡ä»¤ç¼“å­˜èµ·æ¥ï¼Œå¹¶åˆç†é‡æ’æŒ‡ä»¤é¡ºåºï¼ˆæ€è€ƒä¸€ä¸‹ä¸€ç§’ 5000 è½¬çš„ç£ç›˜ï¼‰ä½¿å¾—æ€§èƒ½æœ€å¤§åŒ–ï¼› å› æ­¤ä½¿ç”¨ direct write è¿˜æ˜¯ä¸èƒ½è‚¯å®šæ•°æ®åˆ°ç£ç›˜äº†ï¼Œå¯å¤ªè¾›è‹¦äº†ã€‚ä¸è¿‡æ—¢ç„¶æœ‰ç¼“å­˜ï¼Œä¸€å®šæœ‰æ§åˆ¶ç¼“å­˜çš„æ–¹å¼ï¼Œæ¯”å¦‚åˆ·ç¼“å­˜ï¼Œè€Œå…¶ä¸­ä¸€ç§æ–¹å¼å«åš FUAï¼ˆForce Unit Accessï¼‰ã€‚FUA ä¼šå¼ºåˆ¶ç­‰å¾…å†™å…¥æŒ‡ä»¤ç›´åˆ°æ•°æ®è¿›å…¥ç£ç›˜ä¸ºæ­¢ï¼Œæœ‰ä¸€äº›ç³»ç»Ÿä½¿ç”¨ FUA å®ç° O_SYNC/O_DSYNC æ¥ä¿è¯æ•°æ®åŒæ­¥åˆ°è®¾å¤‡ä¹‹ä¸Šäº†ã€‚ä¸æ­¤åŒæ—¶ï¼Œfsync/fdatasync çš„æ¥å£åŒæ ·ä¹Ÿæä¾›äº†ç›¸åŒçš„è¯­ä¹‰ï¼ˆé€šè¿‡åˆ·ç¼“å­˜ï¼‰ï¼Œä¸è¿‡ä½¿ç”¨ä»–ä»¬ä¼šé¢å¤–å¤šä¸€æ¬¡ç³»ç»Ÿè°ƒç”¨å¼€é”€ã€‚\nä»¤äººé—æ†¾çš„æ˜¯ï¼Œå¹¶ä¸æ˜¯æ‰€æœ‰è®¾å¤‡éƒ½æœ‰ FUA æŒ‡ä»¤ï¼ˆSCSI æœ‰ï¼ŒEIDE å’Œ SATA å°±ä¸è¡Œäº†ï¼‰ï¼Œä¸”ä¸æ˜¯æ‰€æœ‰ç³»ç»Ÿéƒ½ä¿è¯ O_SYNC/O_DSYNC è¿›å…¥ç£ç›˜ï¼ˆå®ç°æœ‰ bugï¼‰ï¼ŒåŸæ–‡å¤§çº¦æ˜¯ ensure synchronized as far as it can tellã€‚å› æ­¤å•ç‹¬ä½¿ç”¨ O_SYNC/O_DSYNC å¹¶ä¸èƒ½ä¸€å®šä¿è¯æ•°æ®çš„å®Œæ•´æ€§ï¼Œéœ€è¦é…åˆ fsync/fdatasync ä¸€èµ·ä½¿ç”¨æ¥è¾¾åˆ°åŒæ­¥å†™çš„ç›®çš„ã€‚\nP.S. æŸäº›ç³»ç»Ÿå¯¹ fsync/fdatasync çš„å®ç°ä¹Ÿæœ‰ bugï¼ˆå‚è€ƒ [1]ï¼‰æˆ–è€…é—®é¢˜ï¼Œæ˜¯æ•°æ®åº“ç³»ç»Ÿæ— æ³•å®¹å¿çš„ã€‚å¦‚æœä½ æŸ¥é˜… macOS çš„ fsync manualï¼Œä½ ä¼šå‘ç°å®ƒæœ‰è¿™ä¹ˆä¸€æ®µæè¿°ï¼š\nNote that while fsync() will flush all data from the host to the drive (i.e. the \u0026ldquo;permanent storage device\u0026rdquo;), the drive itself may not physically write the data to the platters for quite some time and it may be written in an out-of-order sequence.\nSpecifically, if the drive loses power or the OS crashes, the application may find that only some or none of their data was written. The disk drive may also re-order the data so that later writes may be present, while earlier writes are not.\nä½ è¿˜éœ€è¦ä½¿ç”¨å®ƒæä¾›çš„å…¶ä»–æ–¹å¼æ¥åŒæ­¥æ•°æ®ï¼Œaka. fnctlã€‚\nåˆ°è¿™é‡Œç»ˆäºçœ‹åˆ°äº†ä¸€ä¸æ›™å…‰ï¼Œæˆ‘ä»¬ç»ˆäºæœ‰åŠæ³•èƒ½å¤Ÿæä¾›åŒæ­¥å†™çš„è¯­ä¹‰äº†ã€‚é‚£ä¹ˆï¼Œæ˜¯æ—¶å€™è¯¥å®ç°ä¸€ä¸ªæ•°æ®åº“ç®¡ç†ç³»ç»Ÿäº†ï¼Œè¿˜æœ‰å…¶ä»–é—®é¢˜ä¹ˆï¼Ÿ\nå®é™…ä¸Šè¿˜æœ‰ï¼ˆæˆ‘éƒ½å†™çš„ä¸è€çƒ¦äº†ğŸ¤¡ï¼‰ï¼Œå› ä¸ºæ•°æ®åº“ç³»ç»Ÿæ¶æ„åœ¨äº†æ–‡ä»¶ç³»ç»Ÿä¹‹ä¸Šï¼Œé™¤äº†æ•°æ®æ–‡ä»¶åŒæ­¥å†™ä¹‹å¤–ï¼Œä½ è¿˜éœ€è¦å…³å¿ƒæ‰€æœ‰çš„å´©æºƒä¸€è‡´æ€§ï¼š\næ–‡ä»¶ç³»ç»Ÿä¿®æ”¹åŒæ­¥ï¼Œe.g. åˆ›å»ºäº†ä¸€ä¸ªæ–‡ä»¶ï¼Œå†™äº†ä¸€äº›å†…å®¹ï¼Œæ–‡ä»¶åŒæ­¥äº†ä½†æ˜¯ç›®å½•æ²¡åŒæ­¥ä¹‹åæ–­ç”µï¼Œä¼šå‡ºç°æ–‡ä»¶æ²¡äº†ï¼Œä½†æ˜¯ç”¨æˆ·ä¾§æ˜¾ç¤ºå·²ç»æäº¤ é¡ºåºå†™ï¼Œe.g. æ–‡ä»¶å†™ä¸€åŠæ–­ç”µï¼Œè¯·é—®å“ªäº›éƒ¨åˆ†æ˜¯å·²ç»å†™å…¥äº†çš„ï¼Ÿ åŸå­å†™ï¼Œe.g. å†™ WAL / B+ æ ‘ / SST å†™ä¸€åŠæ–­ç”µï¼Œè¿™ä¸ªè®°å½•/é¡µ/æ–‡ä»¶è¿˜èƒ½ä¸èƒ½è¦äº†ï¼Ÿ \u0026hellip; ext4_inode å®åœ¨å¤ªå¤šäº†ï¼Œè¿™é‡Œä¸ä¸€ä¸€å±•å¼€ï¼Œæ„Ÿå…´è¶£çš„åŒå­¦å¯ä»¥äº†è§£ä¸‹ rename åŸå­æ“ä½œ å’Œ MySQL InnoDB çš„åŒå†™ï¼Œä»¥åŠå—å¤§å­¦é•¿ JYY ä¹‹å‰å‘è¡¨çš„è®ºæ–‡ [7]ã€‚\nç»„æäº¤ (Group Commit) å‰æ–‡æåˆ°ï¼Œæˆ‘ä»¬å°†ä¿®æ”¹æ“ä½œåŒæ­¥åˆ°å­˜å‚¨è®¾å¤‡ä¸Šä¹‹åå†è¿›è¡Œè¿”å›ï¼Œä»è€Œä¿è¯æŒä¹…æ€§ï¼Œæˆ‘ä»¬å°†è¿™ä¸ªæ“ä½œç§°ä¸ºæäº¤ï¼ˆcommitï¼‰ã€‚é‚£å‡è®¾ç°åœ¨å·²ç»æœ‰ä¸€ä¸ªæ•°æ®åº“ç³»ç»Ÿäº†ï¼Œå®ƒæ¯æ¬¡è¯·æ±‚éƒ½ä¼šåšä¸€æ¬¡åŒæ­¥å†™ç„¶åè¿”å›ï¼Œä¼šæœ‰ä»€ä¹ˆæ ·çš„é—®é¢˜å‘¢ï¼Ÿ\nå¦‚ [1][2] ä¸­æ‰€ç¤ºï¼ŒåŒæ­¥æ“ä½œçš„æ€§èƒ½å¯ä»¥è¯´æ˜¯æƒ¨ä¸å¿ç¹ï¼Œä¸”å› ä¸ºåŒæ­¥çš„ç¼˜æ•…ï¼ŒCPU å’Œ IO ä¸èƒ½å……åˆ†å¹¶è¡Œï¼Œç®€ç›´æƒ¨ä¸ŠåŠ æƒ¨ã€‚ç”¨ [2] ä¸­çš„è„šæœ¬åœ¨æŸå°é¡¶é… ECS ä¸Šï¼ˆæ²¾äº†å…¬å¸çš„å…‰ï¼‰æµ‹è¯•ä¸‹äº† ESSD æ€§èƒ½ï¼Œfsync ä¹Ÿåªèƒ½è·å¾—çº¦ 2000 æ¬¡/s çš„æ€§èƒ½ï¼ˆå¯¹æ¯”æœºæ¢°ç¡¬ç›˜ç¡®å®éå¸¸ä¸é”™äº†ï¼‰ã€‚æˆ‘æœ¬åœ° macOS è·‘ fnctl(F_FULLFSYNC) å¯èƒ½åªæœ‰ä¸åˆ° 100ï¼Œä¸èƒ½æ›´æƒ¨ã€‚è€Œ [1] ä¸­ 4k å†™åœ¨ buffered IO ä¸‹èƒ½è·å¾— 2.5GB/s å†™å…¥é€Ÿåº¦çš„è®¾å¤‡åœ¨æ— è„‘ fsync ä¸‹åªå‰©ä¸‹å¯æ€œçš„ 0.5MB/s äº†ã€‚è¿™ä¸ªé—®é¢˜æœ‰å¤šä¸¥é‡å¯è§ä¸€æ–‘ã€‚\nfsync çš„æ¯ç§’æ‰§è¡Œæ¬¡æ•°å’Œå»¶è¿Ÿæ„å‘³ç€åœ¨å•çº¿ç¨‹è¯·æ±‚ä¸‹ï¼ŒTPS å’Œå»¶è¿Ÿä¸€å®šæœ‰ä¸ªå¯¹åº”çš„ boundï¼Œæ— æ³•æ¶ˆé™¤ï¼Œè€Œ fsync + write çš„ååé‡åˆ™å†³å®šäº†å¤§äº‹åŠ¡çš„æ‰§è¡Œé€Ÿåº¦ï¼Œå› æ­¤ä¼˜åŒ–åŒæ­¥å†™åŠ¿åœ¨å¿…è¡Œã€‚å¯¹äºå•çº¿ç¨‹è¯·æ±‚ï¼Œå®é™…ä¸Šæ²¡æœ‰åŠæ³•è¿›è¡Œä¼˜åŒ–ï¼Œå› ä¸ºä»åŸåˆ™ä¸Šå¿…é¡»è¦åŒæ­¥å†™ä¹‹åæ‰èƒ½è¿”å›ã€‚ä½†æ˜¯å¯¹äºå¹¶å‘è¯·æ±‚ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡ä¸€ç§å«ç»„æäº¤ï¼ˆgroup commitï¼‰çš„æŠ€æœ¯ï¼Œå°½å¯èƒ½çš„ä¼˜åŒ– fsync çš„æ‰§è¡Œé¢‘ç‡ã€‚\né¡¾åæ€ä¹‰ï¼Œç»„æäº¤æ˜¯å°†ä¸€ç»„è¯·æ±‚åˆå¹¶åˆ°ä¸€èµ·æäº¤ï¼Œç„¶åå†è¿”å›çš„æ–¹æ³•ã€‚é€šè¿‡é™ä½ fsync çš„é¢‘ç‡ï¼Œä½¿å¾— CPU å’Œ IO å……åˆ†å¹¶è¡Œï¼ŒåŒæ—¶æå‡äº† TPS ä¸Šé™å’Œååé‡ã€‚ç»„æäº¤çš„å®ç°å¯ä»¥æœ‰å¾ˆå¤šå‚æ•°ï¼Œæ¯”å¦‚ç­‰å¾…å¤šå°‘æ—¶é—´/å¤šå°‘äº‹åŠ¡è¿›è¡Œæäº¤ã€‚æˆ‘è§‰å¾—ä¸€ä¸ªæ¯”è¾ƒä¼˜é›…çš„å®ç°æ¥è‡ª MySQL çš„ binlogï¼Œå‚è€ƒ [4] ä¸­æè¿°å’Œä»£ç ï¼Œä»¥åŠè‡ªå·±çš„ç†è§£ç”»äº†ä¸€ä¸ªå¯¹åº”çš„æµç¨‹å›¾ï¼š\ngroup commit è¿™ç§å®ç°æœ‰ç€è‰¯å¥½çš„å•çº¿ç¨‹äº‹åŠ¡æ•ˆç‡ï¼ˆå³åˆ»æäº¤ï¼‰ï¼Œä¹Ÿæœ‰è‰¯å¥½çš„å›å‹æœºåˆ¶ï¼ˆæ—¥å¿—æ–‡ä»¶é”ä¸é‡Šæ”¾ä»£è¡¨ IO è¿›è¡Œä¸­ï¼Œé˜»å¡æäº¤ï¼‰ï¼Œéå¸¸ä¼˜é›…ã€‚\næ›´ç®€å•çš„å®ç°æ–¹å¼å¯ä»¥é€šè¿‡ä¸€ä¸ª mpsc é˜Ÿåˆ—å’Œå‡ ä¸ªå›ºå®šçš„æ¶ˆè´¹çº¿ç¨‹ï¼Œæ¥é¿å…å¤æ‚çš„ group leader æœºåˆ¶ï¼Œå®ç°æ›´åŠ ç®€å•ã€‚\nç”±äºè°ƒç ”æ—¶é—´æœ‰é™ï¼Œå¦‚æœæœ‰æ›´ä¼˜é›…çš„æ–¹æ³•å¸Œæœ›äº†è§£çš„åŒå­¦èƒ½å¤Ÿä¸åèµæ•™ã€‚\nå…¶ä»–çš„ä¼˜åŒ–æ–¹å¼ å¦‚ [2] ä¸­æŒ‡å‡ºï¼ŒæŸäº› raid æ§åˆ¶å™¨å¸¦ä¸€ä¸ªå—ä¿æŠ¤çš„å†™ç¼“å­˜ã€‚ä»€ä¹ˆå«å—ä¿æŠ¤å‘¢ï¼Ÿå°±æ˜¯ç”¨ä¸€å—å¤§ç”µå®¹ä¿è¯å³ä½¿æ–­ç”µä½ ä¹Ÿèƒ½æŠŠæ•°æ®å†™åˆ°ç£ç›˜ã€‚è¿™æ ·å®é™…ä¸Šæ•°æ®å†™åˆ°ç¼“å­˜ fsync å°±å¯ä»¥è¿”å›äº†ï¼Œè¿™ç§ç¡¬ä»¶çº§åˆ«çš„åŸå­å†™å¯ä»¥è®© fsync é¢‘ç‡æå‡ 3 ä¸ªæ•°é‡çº§ (58 -\u0026gt; 23000)ï¼Œå»¶è¿Ÿé™ä½ 3 ä¸ªæ•°é‡çº§ (17ms -\u0026gt; 0.04 ms)ï¼Œæ˜¾ç„¶åŒæ­¥å†™å¯ä»¥è·å¾—çˆ†ç‚¸æ€§çš„æå‡ã€‚\nå¦‚ [3] ä¸­æŒ‡å‡ºï¼Œæœ€æ–°ä¸€ä»£éæ˜“å¤±æ€§å†…å­˜è®¾å¤‡çš„åŒæ­¥å†™æ€§èƒ½ç®€ç›´ç”©å…¶ä»–è®¾å¤‡ä¸¤æ¡è¡—éƒ½ä¸æ­¢ã€‚ä¸”ä¸è¯´æ–°ç‰¹æ€§ï¼ˆ8-byte åŸå­å†™ï¼‰å¸¦æ¥çš„æ¶æ„å˜é©ï¼Œå…‰æ˜¯è¿™ä¸ª fsync æ€§èƒ½å°±èƒ½\u0008è®©å…¶ä»–è®¾å¤‡ç›¸å½¢è§ç»Œã€‚\næˆ‘ä»¥å‰ä¸å±‘äºæ–°è®¾å¤‡å¸¦æ¥çš„å˜é©ï¼Œç°åœ¨å‘ç°è¿˜æ˜¯ too naive äº†ã€‚\næ€»ç»“ æœ¬æ–‡ä¸»è¦èŠäº†èŠå­˜å‚¨è®¾å¤‡å’Œæ•°æ®åº“ç®¡ç†ç³»ç»ŸæŒä¹…æ€§ä¹‹é—´çš„å…³ç³»ï¼Œä»¥åŠå…¶ä¸­çš„ä¸€äº›ç»†èŠ‚å’Œä¼˜åŒ–æ–¹å¼ã€‚ç”±äºçŸ¥è¯†é¢æœ‰é™ï¼Œå¤§å¤šæ•°éƒ½æ˜¯ç°è°ƒç ”çš„ï¼Œé”™è¯¯ç–æ¼åœ¨æ‰€éš¾å…ï¼Œå¸Œæœ›èƒ½å¤Ÿå¾—åˆ°æŒ‡æ­£ï¼Œä¹Ÿæ¬¢è¿æ›´å¤šçš„äº¤æµã€‚æœ€è¿‘æ­£åœ¨æ‘¸ä¸Šä¸€ç¯‡æ–‡ç« è®²çš„é­”æ”¹ Raft WALï¼Œæ¶‰åŠæ–¹é¢ä¸å°‘ï¼Œæœ‰å…´è¶£çš„åŒå­¦ä¹Ÿæ¬¢è¿ä¸€åŒæ¢è®¨ï¼ˆå¸¦å¸¦æˆ‘ï¼‰ã€‚\nå‚è€ƒæ–‡çŒ® [1] https://github.com/ronomon/direct-io\n[2] https://www.percona.com/blog/2018/02/08/fsync-performance-storage-devices\n[3] https://www.percona.com/blog/2019/09/19/update-on-fsync-performance\n[4] https://www.burnison.ca/notes/fun-mysql-fact-of-the-day-group-commit\n[5] https://en.wikipedia.org/wiki/Disk_buffer\n[6] https://ext4.wiki.kernel.org/index.php/Ext4_Disk_Layout\n[7] Jiang, Yanyan, et al. \u0026ldquo;Crash consistency validation made easy.\u0026rdquo; Proceedings of the 2016 24th ACM SIGSOFT International Symposium on Foundations of Software Engineering. 2016.\n","date":"2021-08-21T12:36:51+08:00","image":"https://blog.crazyark.me/p/group-commit-with-direct-io-and-fsync/img/transaction_commit_hu68aa13cf911f6fed9e1992f89ad898fd_85726_120x120_fill_box_smart1_3.png","permalink":"https://blog.crazyark.me/p/group-commit-with-direct-io-and-fsync/","title":"æ•°æ®åº“ç³»ç»Ÿ: èŠèŠå­˜å‚¨å’Œç»„æäº¤ (group commit)"},{"content":"è‡ªä¸Šæ¬¡æ›´æ–°åšå®¢èµ·å·²ç»æœ‰ä¸‰å¹´æ—¶é—´äº†ï¼Œè¿™æœŸé—´ç»å†äº†ç•™å­¦ã€æ¯•ä¸šã€å·¥ä½œç­‰å¾ˆå¤šäº‹æƒ…ï¼Œä¸ªä¸­æ»‹å‘³åªæœ‰è‡ªå·±çŸ¥é“ã€‚åšå®¢é‡å¼€ï¼Œå¸Œæœ›æ–‡ç¬”å’Œæ€è·¯ä¸Šèƒ½æ¯”ä»¥å‰è¿›æ­¥ä¸€ç‚¹ç‚¹ã€‚åŒæ—¶å› ä¸ºå­¦è¯†æœ‰é™ï¼Œä¹Ÿå¸Œæœ›å„ä½å¤§ä½¬èƒ½ä¸åèµæ•™ã€‚\nèƒŒæ™¯ ä¸Šä¸ªæœˆä¸ºäº†å­¦ä¹  rust è¯­è¨€ï¼Œå‚åŠ äº†é˜¿é‡Œäº‘ ECS å›¢é˜Ÿä¸¾åŠçš„ CloudBuild æ€§èƒ½æŒ‘æˆ˜èµ›ï¼Œç”¨ rust å®ç°ä¸€ä¸ªèŠå¤©å®¤æœåŠ¡å™¨ã€‚å› ä¸º rust ä¸ç†Ÿç»ƒåˆèµ›åªæäº¤äº†ä¸€æ¬¡ï¼Œå±…ç„¶ä¹Ÿé—¯è¿›å¤èµ›äº†ï¼Œä¹ŸæŒºæœ‰æ„æ€çš„ã€‚å¤èµ›é¢˜ç›®è¦æ±‚æœåŠ¡è¦éƒ¨ç½²åœ¨ä¸‰å°æœºå™¨ä¸Šï¼ŒåŒæ—¶æä¾›å®Œæ•´çš„è¯»å†™æœåŠ¡ï¼Œä¸”è¦æ±‚å®•æœºä¸€å°ä¸å½±å“æœåŠ¡ã€‚çœ‹åˆ°é¢˜ç›®åï¼Œæˆ‘ç›´è§‚åœ°æƒ³åˆ°äº†ä½¿ç”¨ä¸€è‡´æ€§åè®®è®©ä¸‰å°æœºå™¨å…³äºå­˜å‚¨çš„æ•°æ®è¾¾æˆä¸€è‡´å°±å¯ã€‚åˆ†å¸ƒå¼ç³»ç»Ÿä¸­å¸¸ç”¨çš„ä¸€è‡´æ€§åè®®æœ‰ Paxos å’Œ Raft ç­‰ï¼Œå…¶ä¸­ Raft ä»åŸç†ä¸Šæ¥è¯´æ˜¯ä¸€ç§ç‰¹åŒ–çš„ Paxosï¼Œè€Œä¸”ç®€å•æ˜“æ‡‚ã€‚å› æ­¤æˆ‘æœ€ç»ˆå†³å®šé‡‡ç”¨ Raft + RocksDB çš„æ–¹æ¡ˆè¿›è¡Œå®ç°ã€‚\né—®é¢˜ Raft æ˜¯ä¸€ä¸ªåˆ†å¸ƒå¼ä¸€è‡´æ€§åè®®ï¼Œè€Œ RocksDB æ˜¯ä¸€ä¸ª K-V æ•°æ®åº“ï¼Œåœ¨å„è‡ªçš„é¢†åŸŸåº”è¯¥éƒ½æ˜¯é—»åéè¿©ï¼Œåœ¨æ­¤ä¸å†å¤šåšä»‹ç»ã€‚åœ¨æ–¹æ¡ˆçš„å®ç°è¿‡ç¨‹ä¸­ï¼Œç¢°åˆ°ä¸å°‘é—®é¢˜ï¼Œå…¶ä¸­çš„ä¸€ä¸ªä¸»è¦é—®é¢˜æ˜¯ï¼šRaft åè®®è¿è¡Œè¿‡ç¨‹ä¸­éœ€è¦ç»´æŠ¤ä¸€ä»½æ—¥å¿—ï¼Œè€Œ RocksDB ä¸ºäº†ä¿éšœæŒä¹…æ€§ï¼Œä¹Ÿä¼šç»´æŠ¤ä¸€ä»½ WALï¼Œè¿™ä¸¤ä»½æ—¥å¿—åœ¨æ•°æ®å†…å®¹ä¸Šæ˜¯é«˜åº¦é‡åˆçš„ã€‚è¿™æ„å‘³ç€åœ¨å†™å…¥æ•°æ®çš„è¿‡ç¨‹ä¸­ï¼Œéœ€è¦å†å¤šå†™ä¸€ä»½ï¼Œè¿™å¯¹äºä»»ä½•å…³æ³¨æ€§èƒ½çš„ç³»ç»Ÿæ¥è¯´éƒ½æ˜¯ä¸èƒ½æ¥å—çš„ã€‚\näº‹å®ä¸Šå¾ˆå¤šåˆ†å¸ƒå¼æ•°æ®åº“ç³»ç»Ÿéƒ½å·²ç»åˆå¹¶äº†è¿™ä¸¤æ¡æ—¥å¿—ï¼Œæ¯”å¦‚æŸäº›é­”æ”¹çš„åˆ†å¸ƒå¼ MySQL ç³»ç»Ÿï¼Œä»¥åŠ tikvï¼ˆï¼Ÿæˆ‘æ²¡è°ƒç ”ï¼‰ã€‚ä»–ä»¬é‡‡ç”¨çš„æ–¹æ¡ˆæˆ–æ˜¯å°†å­˜å‚¨å¼•æ“çš„ WAL æ‰©å±•æ”¯æŒä¸€è‡´æ€§åè®®çš„ç‰¹æ®Šäº‹ä»¶ï¼Œæˆ–æ˜¯åœ¨ä¸€è‡´æ€§åè®®çš„æ—¥å¿—ä¸­åµŒå…¥ä¸€æ¡å­˜å‚¨å¼•æ“çš„ WALï¼Œæˆ–è€…å¯¹æŸäº›ç‰¹åŒ–çš„ç³»ç»Ÿæ¯”å¦‚åˆ†å¸ƒå¼æ—¥å¿—ç³»ç»Ÿï¼Œå¹²è„†ç›´æ¥å°† Raft çš„æ—¥å¿—æ”¹é€ æˆå­˜å‚¨å¼•æ“ã€‚åœ¨ Google è§£å†³æ–¹æ¡ˆçš„è¿‡ç¨‹ä¸­ï¼Œæˆ‘å‘ç°äº† eBay ä»¥å‰çš„ä¸€ç¯‡æ–‡ç« [1]ï¼Œè®²çš„å°±æ˜¯å¦‚ä½•æŠŠæ—¥å¿—å­˜å‚¨çš„æ—¥å¿—å’Œ Raft çš„æ—¥å¿—ç›¸ç»“åˆèµ·æ¥ï¼Œè™½ç„¶åªæ˜¯ä¸€ç¯‡ workshop çš„æ–‡ç« ï¼Œä½†å›¾æ–‡è®²è§£è¿˜æ˜¯è®©æˆ‘èŒ…å¡é¡¿å¼€ã€‚\nç”±äºæˆ‘é‡‡ç”¨äº† RocksDB ä½œä¸ºå­˜å‚¨å¼•æ“ï¼Œæ˜¾ç„¶æˆ‘ä¸å¸Œæœ›å»ä¿®æ”¹ RocksDB çš„ WALï¼Œè¿™å·¥ç¨‹é‡å¤ªå¤§äº†ï¼Œä¸å¤Ÿå›æœ¬çš„ã€‚å› æ­¤æˆ‘å†³å®šå°è¯•å®šåˆ¶ Raft æ—¥å¿—ã€å…³é—­ RocksDB çš„ WAL çš„æ–¹æ¡ˆã€‚åœ¨å´©æºƒæ¢å¤çš„æ—¶å€™ï¼Œä½¿ç”¨ Raft çš„æ—¥å¿—å»è¿›è¡Œ RocksDB çš„æ¢å¤ã€‚å› ä¸º RocksDB æ˜¯ä¸€ä¸ª LSMT ç»“æ„çš„ç³»ç»Ÿï¼Œå®ƒåœ¨ç£ç›˜ä¸ŠæŒä¹…åŒ–çš„ SSTï¼ˆSorted String Tableï¼‰éƒ½æ˜¯åªè¯»çš„ï¼Œå³ä½¿å´©æºƒä¹Ÿåªæ˜¯ä¸¢å¤±å†…å­˜ä¸­è¿˜æ²¡æœ‰åˆ·ç›˜çš„ memtableï¼Œè¿™å¤§å¤§ç®€åŒ–äº†å´©æºƒæ¢å¤çš„å·¥ä½œé‡ã€‚\nå…±äº«æ—¥å¿— å…±äº«æ—¥å¿—éœ€è¦ä¸ºåŠŸèƒ½å’Œæ€§èƒ½è€ƒè™‘ä»¥ä¸‹ä¸¤ç‚¹é—®é¢˜ï¼š\nå´©æºƒæ¢å¤æ—¶ï¼Œæ€ä¹ˆå¯»æ‰¾æœ€æ—©æœªå†™å…¥ RocksDB çš„æ—¥å¿—ï¼Ÿ æ€ä¹ˆå‡å°‘å°çš„ç£ç›˜ IOï¼Œå°½é‡æé«˜ååï¼Ÿ å´©æºƒæ¢å¤ å› ä¸º RocksDB åªä¼šä¸¢å¤±å†…å­˜ä¸­çš„ memtableï¼Œè€Œ KV æ“ä½œåˆéƒ½æ˜¯å¹‚ç­‰çš„ï¼Œå› æ­¤æœ€ç®€å•çš„åŠæ³•å°±æ˜¯ç›´æ¥æŠŠæ—¥å¿—ä»å¤´é‡æ”¾åˆ°å°¾ã€‚æ˜¾ç„¶è¿™ä¸æ˜¯ä¸€ä¸ªå¥½æ–¹æ¡ˆï¼Œä¸è¯´æ¢å¤æ—¶é—´å¾ˆé•¿ï¼Œå› ä¸ºé‡å¤çš„ KV æ“ä½œå¯¼è‡´çš„é‡å¤æ•°æ®ä¹Ÿå¸¦æ¥äº†é¢å¤–çš„ç£ç›˜å‹åŠ›ï¼Œå¯¹ SSD è¿™ç§ GC æ˜‚è´µè¿˜æœ‰æ“¦å†™æ¬¡æ•°é™åˆ¶çš„ç£ç›˜éå¸¸ä¸å‹å¥½ã€‚æ›´å¥½çš„åšæ³•æ˜¯åœ¨ RocksDB åˆ·å®Œ SST çš„æ—¶å€™ï¼Œè®°å½•ä¸‹å½“å‰å†™ä¸‹çš„ SST çš„æœ€å¤§æ—¥å¿— LSNï¼ŒåŒæ ·å†™å…¥ç£ç›˜ã€‚å½“é‡å¯æ¢å¤æ—¶æŸ¥è¯¢åˆ°è¿™ä¸ªè®°ä¸‹çš„ LSNï¼Œä»è¿™ä¸ªç‚¹å¼€å§‹é‡æ”¾å°±å¥½ã€‚\nè¿™ä¸ªæ–¹æ¡ˆæœ‰ä¸¤ç§å®ç°åŠæ³•ï¼š\nç”¨ RocksDB æä¾›çš„äº‹ä»¶å›è°ƒå¼‚æ­¥åœ°å®Œæˆ LSN è·å–å’Œå†™å…¥ æ¯æ¬¡ put(k, v) æ—¶é¢å¤– put ä¸€ä¸ªç‰¹æ®Šçš„ keyï¼Œä¸¾ä¸ªä¾‹å­ _raft_log_lsnï¼Œå€¼æ˜¯å½“å‰æ—¥å¿—çš„ lsn ç¬¬ä¸€ç§åŠæ³•å¼‚æ­¥å†™å…¥æ€»æ˜¯æœ‰å¯èƒ½ä¼šå†™å…¥å¤±è´¥ï¼ˆå´©æºƒæ—¶ï¼‰ï¼Œå› æ­¤æˆ‘æ›´å€¾å‘äºç¬¬äºŒç§å®ç°åŠæ³•ï¼Œå®ƒå”¯ä¸€éœ€è¦ä¿è¯çš„æ˜¯ç‰¹æ®Šçš„ key ä¸åœ¨ç”¨æˆ·åˆæ³•çš„ key çš„èŒƒå›´å†…ã€‚å½“ memtable è¢«å†™å…¥ç£ç›˜æˆä¸º SST æ—¶ï¼Œè¿™ä¸ªç‰¹æ®Šçš„ key åŒæ ·ä¹Ÿä¼šå†™å…¥ã€‚é‚£ä¹ˆå½“ RocksDB å†æ¬¡å¯åŠ¨æ—¶ï¼Œåªè¦æŸ¥è¯¢ä¸€ä¸‹è¯¥ key çš„å€¼å°±å¯ä»¥è·å–å½“å‰æœ€å¤§å·²ç»å†™å…¥çš„ LSNã€‚æ˜¾ç„¶è¿™ç§æ–¹æ³•æ›´åŠ çš„ä¼˜é›…ã€‚å½“ç„¶è¿™ç§æ–¹æ³•å¹¶ä¸èƒ½ä¿è¯ LSN å’Œ SST ä¸­çš„æ•°æ®ä¸€å®šæ˜¯ä¸€è‡´çš„ï¼Œé™¤éåœ¨å†™å…¥æ—¶èƒ½é”å®š memtable ä¸è®©åˆ·ã€‚\nè¿™é‡Œæœ‰ä¸€ä¸ªæ³¨æ„ç‚¹å°±æ˜¯ï¼ŒRocksDB é»˜è®¤çš„åˆ· memtable ç­–ç•¥æ˜¯æ ¹æ®å¤§å°æ¥çš„ï¼Œå› æ­¤å¯ä»¥å…ˆåš lsn key çš„å†™å…¥ï¼ˆä¸ä¼šæ”¹å˜ memtable å¤§å°ï¼‰ï¼Œå†åš put(k, v)ï¼Œè¿™æ ·å³ä½¿è§¦å‘åˆ·ç›˜ï¼Œä¹Ÿèƒ½ä¿è¯æ•°æ®å’Œ lsn æ˜¯ä¸€è‡´çš„ã€‚ä½†æ˜¯éœ€è¦ä¿è¯ä¸ä¼šå› ä¸ºå…¶ä»–çš„ä»€ä¹ˆç­–ç•¥åˆ·ç›˜å¯¼è‡´åˆ·äº† lsn key è€Œæ•°æ®ä¸¢äº†ï¼Œç›®å‰çœ‹æ¥è¿˜æ˜¯æ¯”è¾ƒå›°éš¾çš„ï¼ˆä¸æ”¹ RocksDB çš„è¯ï¼‰ã€‚\nåˆå¹¶æäº¤ æ‰€æœ‰çš„æ•°æ®åº“éƒ½æœ‰ä¸€ä¸ªè¦æ±‚ï¼Œé‚£å°±æ˜¯åœ¨ç”¨æˆ·è¯·æ±‚è¿”å›å‰ï¼Œæ•°æ®ä¸€å®šä»¥æŸç§å½¢å¼ï¼ˆe.g. WALï¼‰å·²ç»åœ¨ç£ç›˜ä¸Šäº†ï¼Œä»è€Œä¿è¯æŒä¹…æ€§ã€‚ä½†æ˜¯å½“ç”¨æˆ·å¤§é‡çš„è¯·æ±‚éƒ½å¾ˆå°æ—¶ï¼Œæ¯ä¸ªè¯·æ±‚éƒ½å•ç‹¬è½ç›˜ä¼šå¯¼è‡´å¤§é‡çš„å° IOï¼Œè€Œå° IOï¼ˆå°äº 4KBï¼‰åœ¨ä»»ä½•ç±»å‹çš„ç£ç›˜äº§å“ä¸Šéƒ½æ˜¯æ…¢ä¸”æœ‰å®³çš„ã€‚æ•°æ®åº“ç³»ç»Ÿä¸­å¸¸ç”¨çš„ä¸€ä¸ªä¼˜åŒ–æ‰‹æ®µæ˜¯åˆå¹¶æäº¤ï¼ˆgroup commitï¼‰ï¼Œå°†ä¸€ç»„è¯·æ±‚åˆå¹¶æˆä¸€ä¸ªè¯·æ±‚åŒæ—¶æäº¤åˆ°ç£ç›˜ï¼Œç„¶åå†è¿”å›ç»™ç”¨æˆ·ã€‚è¿™æ ·å¯ä»¥è®©æ¯æ¬¡çš„ IO è¯·æ±‚éƒ½å°½å¯èƒ½çš„å¤§ï¼Œæœ‰æ•ˆåœ°æé«˜äº†ååã€‚\nå…±äº«çš„ WAL åŒæ ·ä¹Ÿå¯ä»¥é‡‡ç”¨åˆå¹¶æäº¤çš„æ–¹å¼è¿›è¡Œå†™å…¥ï¼Œä½†æ˜¯æ³¨æ„çš„è¿™æ—¶éœ€è¦å¯¹ä¸Šè¿°å´©æºƒæ¢å¤çš„æ–¹æ¡ˆåšä¸€äº›å°çš„ä¿®æ”¹ï¼Œå³å½“æ‰€æœ‰ K-V éƒ½ put åå†å°† LSN å†™å…¥ã€‚\næµç¨‹å›¾ ç…§çŒ«ç”»è™æäº†ä¸ªæµç¨‹å›¾ï¼š\næµç¨‹å›¾ æ€»ç»“ æ€»ä¹‹åªæ˜¯ä¸€ä¸ªå°æ¯”èµ›å¼•å‘çš„ä¸€ç‚¹æ€è€ƒï¼Œå®é™…ä¸Šæ¯”èµ›æ˜¯åªæœ‰æ’å…¥å’ŒæŸ¥è¯¢ï¼Œæ²¡æœ‰åˆ é™¤ã€è¦†ç›–å†™çš„åœºæ™¯ï¼Œç”šè‡³æ¶ˆæ¯åªæœ‰ appendã€‚RocksDB å¹¶ä¸æ˜¯æ¯ä¸ªåœºæ™¯éƒ½èƒ½åšåˆ°æœ€ä¼˜æ€§èƒ½ï¼Œä½† Raft on æŸç§å­˜å‚¨å¼•æ“çš„æ€è·¯åº”è¯¥æ˜¯é€šç”¨çš„ã€‚\nå‚è€ƒæ–‡çŒ® [1] Designing an Efficient Replicated Log Store with Consensus Protocol. Jung-Sang Ahn, et al. 11th USENIX Workshop on Hot Topics in Cloud Computing 2019.\n","date":"2021-08-17T00:00:00Z","image":"https://blog.crazyark.me/p/raft-and-share-log/img/raft_hu789963ccc359d12cda0ae24ab10587a7_341224_120x120_fill_q75_box_smart1.jpg","permalink":"https://blog.crazyark.me/p/raft-and-share-log/","title":"Raft on RocksDB -- å…±äº«æ—¥å¿—"},{"content":"Hash table \u0026ndash; Collision åœ¨è®¡ç®—æœºç§‘å­¦ä¸­ï¼Œå“ˆå¸Œè¡¨ (hash table) æ˜¯ä¸€ä¸ªéå¸¸é‡è¦çš„æ•°æ®ç»“æ„ï¼Œå®ƒå¸®åŠ©æˆ‘ä»¬å¿«é€Ÿçš„è¿›è¡Œæ’å…¥å’ŒæŸ¥è¯¢ã€‚ç†è®ºä¸Šæ¥è¯´ï¼Œåœ¨è¡¨ä¸­æŸ¥è¯¢ä¸€æ¬¡çš„è€—æ—¶åº”è¯¥æ˜¯ O(1) çš„ã€‚è¿™é‡Œå‡è®¾å¤§å®¶å¯¹äºå“ˆå¸Œ (hash) éƒ½å·²ç»äº†è§£ï¼Œå¦‚æœä½ ä»¥å‰æ²¡æœ‰æ¥è§¦è¿‡è¿™ä¸ªæ¦‚å¿µï¼Œè¿™ç¯‡æ–‡ç« æˆ–è®¸æ˜¯ä¸€ä¸ªå¾ˆå¥½çš„å¼€å§‹ã€‚\nå‡è®¾ä½ æœ‰ä¸€ä¸ªå®Œç¾çš„å“ˆå¸Œå‡½æ•° (perfect hashing) å’Œæ— ç©·å¤§çš„å†…å­˜ï¼Œé‚£ä¹ˆå“ˆå¸Œè¡¨ä¸­æ¯ä¸€ä¸ªå“ˆå¸Œå€¼éƒ½å¯¹åº”äº†ä¸€ä¸ªåŸå§‹çš„å…ƒç´ ã€‚æ˜¾ç„¶æ­¤æ—¶è¦è¿›è¡ŒæŸ¥æ‰¾ï¼Œæˆ‘ä»¬åªéœ€è¦ç®—å‡ºå“ˆå¸Œå€¼ï¼Œç„¶åæ‰¾åˆ°è¡¨ä¸­å¯¹åº”çš„é¡¹å°±å¯ä»¥äº†ã€‚ç„¶è€Œç°å®ä¸­ä¸å­˜åœ¨æ— ç©·å¤§çš„å†…å­˜ï¼Œä¹Ÿä¸æ˜¯å¾ˆå®¹æ˜“å»æ‰¾åˆ°ä¸€ä¸ªâ€œä¼˜ç§€â€çš„å®Œç¾å“ˆå¸Œï¼Œæ¯”å¦‚æœ€å°å®Œç¾å“ˆå¸Œ (minimal perfect hashing)ã€‚\næ‰€ä»¥å®é™…ä¸­ï¼Œæˆ‘ä»¬ä¸å¯é¿å…çš„ä¼šç¢°åˆ°å“ˆå¸Œå†²çª (hash collision) ï¼Œä¹Ÿå°±æ˜¯ä¸¤ä¸ªä¸åŒçš„å…ƒç´ è¢«æ˜ å°„åˆ°åŒä¸€ä¸ªå“ˆå¸Œå€¼ä¸Šã€‚å½“ä¸€ä¸ªå“ˆå¸Œè¡¨ç¢°åˆ°å“ˆå¸Œå†²çªçš„æ—¶å€™ï¼Œæœ‰å‡ ç§åŠæ³•å»è§£å†³å®ƒï¼Œå®ƒä»¬å„æœ‰ä¼˜åŠ£ï¼Œä¸”å®¹æˆ‘ä¸€ä¸€é“æ¥ã€‚\nHash collision å“ˆå¸Œå†²çªçš„è§£å†³åŠæ³•é€šå¸¸æ˜¯ä¸¤ç§ï¼Œä¸€ç§å«æ‹‰é“¾æ³• (separate chaining) ï¼Œä¸€ç§å«å¼€åœ°å€æ³• (open addressing)ã€‚å½“ç„¶ä¸ä»…é™äºè¿™ä¸¤ç§ï¼Œå…¶ä»–çš„æ¯”å¦‚ multiple-choice hashing, cuckoo hashing, hopscotch hashing, robin hood hashing ç­‰ç­‰ï¼Œæœ¬æ–‡æŒ‘å‡ ç§ä»‹ç»ä¸€ä¸‹ã€‚\nSeparate chaining æ‹‰é“¾æ³•æ ¸å¿ƒæ€æƒ³å°±æ˜¯å°†å“ˆå¸Œå†²çªçš„å…ƒç´ å­˜å…¥éƒ½å­˜å…¥åˆ°é“¾è¡¨ä¸­ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼Œ\nSeparate Chaining åœ¨æ¯ä¸ªå“ˆå¸Œè¡¨çš„å•å…ƒæ ¼ä¸­ (hash table cell, æˆ–è€…æˆ‘ä»¬ä¹Ÿç§°ä¸ºæ¡¶ bucket)ï¼Œéƒ½å­˜æ”¾äº†ä¸€ä¸ªé“¾è¡¨å¤´ã€‚å½“å“ˆå¸Œå†²çªå‘ç”Ÿæ—¶ï¼Œåªéœ€è¦æŠŠå†²çªçš„å…ƒç´ æ”¾åˆ°é“¾è¡¨ä¸­ã€‚å½“éœ€è¦æŸ¥æ‰¾æ—¶ï¼Œå…ˆé€šè¿‡å“ˆå¸Œå€¼æ‰¾åˆ°å¯¹åº”çš„å•å…ƒæ ¼ï¼Œå†éå†é“¾è¡¨æ‰¾åˆ°æƒ³è¦çš„å…ƒç´ ï¼Œæ­¤æ—¶æŸ¥æ‰¾æ—¶é—´æ˜¯ O(N) çš„ã€‚è¿™é‡Œ N æ˜¯é“¾è¡¨é•¿åº¦ï¼Œé€šå¸¸é“¾è¡¨ä¸ä¼šå¾ˆé•¿ï¼Œæ‰€ä»¥å¯ä»¥è®¤ä¸ºæ•´ä½“æŸ¥è¯¢æ—¶é—´è¿˜æ˜¯ O(1) çš„ã€‚å¤§å¤šæ•°æ ‡å‡†åº“ä¸­çš„å“ˆå¸Œè¡¨æ—¶é—´éƒ½æ˜¯é‡‡ç”¨äº†è¿™ç§æ–¹å¼ï¼Œå› ä¸ºè¶³å¤Ÿé€šç”¨ï¼Œæ€§èƒ½ä¹Ÿè¿˜ä¸é”™ã€‚\nå½“ç„¶æˆ‘ä»¬ä¹Ÿå¯ä»¥ç”¨ä¸€æ£µ BST æ¥ä»£æ›¿é“¾è¡¨ï¼Œæ­¤æ—¶æŸ¥è¯¢æ—¶é—´æ˜¯ O(lgN) çš„ï¼Œä½†æ˜¯æ’å…¥å’Œç©ºé—´å¼€é”€è¦æ¯”é“¾è¡¨å¤§ã€‚Java çš„ HashMap çš„å®ç°ä¸­ï¼Œå½“ä¸€ä¸ªå“ˆå¸Œå•å…ƒæ ¼çš„é“¾è¡¨é•¿åº¦è¶…è¿‡ 8 æ—¶ï¼Œå°±ä¼šè‡ªåŠ¨è½¬æˆä¸€é¢—çº¢é»‘æ ‘æ¥é™ä½æŸ¥è¯¢å¼€é”€ã€‚\næ‹‰é“¾æ³•æœ‰ä¸¤ä¸ªç¼ºç‚¹ï¼Œè¿™åœ¨ä¸€äº›å¯¹æ€§èƒ½è¦æ±‚æ¯”è¾ƒé«˜çš„åœ°æ–¹å¯èƒ½ä¸å¤ªèƒ½å¿å—:\né“¾è¡¨çš„ç©ºé—´å¼€é”€æ¯”è¾ƒå¤§ é“¾è¡¨å¯¹ CPU cache ä¸å‹å¥½ ä½†åŒæ—¶å®ƒçš„é€šç”¨æ€§æœ€å¥½ï¼Œå› ä¸ºé‡‡ç”¨æ‹‰é“¾æ³•ä¸éœ€è¦å¯¹å­˜å…¥çš„å…ƒç´ æœ‰ä»»ä½•äº†è§£ï¼Œæ‰€ä»¥ç»å¤§éƒ¨åˆ†æ ‡å‡†åº“çš„å®ç°éƒ½ç”¨çš„è¿™ç§æ–¹å¼ã€‚\nOpen Addressing å¼€åœ°å€æ³•æ˜¯å°†å…ƒç´ ç›´æ¥å­˜å…¥åˆ°è¡¨ä¸­ï¼Œä½†ä¸ä¸€å®šæ˜¯å“ˆå¸Œå€¼å¯¹åº”çš„é‚£ä¸ªå•å…ƒæ ¼ä¸­ï¼Œè€Œæ‰¾åˆ°å…ƒç´ å¯¹åº”å­˜å‚¨çš„å•å…ƒæ ¼çš„è¿‡ç¨‹é€šå¸¸è¢«ç§°ä¸ºæ¢æŸ¥ (probe)ã€‚å¼€åœ°å€æ³•éœ€è¦æœ‰ä¸€ä¸ªç‰¹æ®Šçš„å…ƒç´ ï¼Œæ¥æ ‡è¯†ç©ºçš„å•å…ƒæ ¼ã€‚æ¯”è¾ƒè‘—åçš„å¼€åœ°å€æ³•æœ‰çº¿æ€§/äºŒæ¬¡æ¢æŸ¥ (linear/quadratic probing) å’ŒåŒé‡å“ˆå¸Œ (double hashing)ã€‚\nLinear/Quadratic probing åœ¨æ’å…¥/æŸ¥æ‰¾çš„è¿‡ç¨‹ä¸­ï¼Œçº¿æ€§/äºŒæ¬¡æ¢æŸ¥æ³•ä¼šé€šè¿‡ä»¥ä¸‹è¿‡ç¨‹æ¥æ‰¾åˆ°æ’å…¥/å­˜æ”¾çš„ä½ç½®:\næ‰¾åˆ°åˆå§‹çš„å“ˆå¸Œå€¼ h(e) å¯¹åº”ä½ç½® s(0) çš„å•å…ƒæ ¼ï¼ŒæŸ¥çœ‹æ˜¯å¦æ˜¯ç©º/ç›¸åŒçš„é”®ï¼Œå¦‚æœç¬¦åˆè¦æ±‚åˆ™è¿”å›ï¼Œå¦åˆ™ç»§ç»­ä¸‹é¢çš„è¿‡ç¨‹ é€šå¸¸ s(0) = h(e) % nï¼Œn æ˜¯è¡¨å¤§å° å¦‚æœæ˜¯çº¿æ€§æ¢æŸ¥ï¼Œåˆ™ä¾æ¬¡å¾€åæœç´¢ï¼Œä½ç½®ç”± s(i +1) = (s(i) + 1) % n æ¨å¯¼; å¦‚æœæ˜¯äºŒæ¬¡æ¢æŸ¥ï¼Œä¹Ÿæ˜¯ä¾æ¬¡å¾€åæœç´¢ï¼Œä¸è¿‡ä½ç½®æ¨å¯¼ä¸º s(i + 1) = (s(i) + i^2) % n å¾ªç¯ç¬¬äºŒæ­¥ç›´åˆ°æ‰¾åˆ°æˆ–è€…ç¡®è®¤æ‰¾ä¸åˆ°ä¸ºæ­¢ Linear Probing çº¿æ€§æ¢æŸ¥çš„ä¼˜åŠ¿æ˜¯å¯¹äº CPU cache éå¸¸å‹å¥½ï¼Œç›¸å…³çš„å…ƒç´ éƒ½èšé›†åœ¨ä¸€èµ·ï¼›ä½†æ˜¯ç¼ºç‚¹åŒæ ·ä¹Ÿæ˜¯å› ä¸ºèšé›†ï¼Œè¿™ä¸ªé—®é¢˜ç§°ä¸º primary clustering: ä»»ä½•æ·»åŠ åˆ°å“ˆå¸Œè¡¨çš„å…ƒç´ ï¼Œå¿…é¡»æ¢æŸ¥å¹¶è·¨è¿‡æ¢æŸ¥è¿‡ç¨‹ä¸­çš„å…ƒç´ èšç°‡ (cluster)ï¼Œå¹¶ä¸”æœ€ç»ˆä¼šå¢å¤§èšç°‡ã€‚Primary clustering çš„é—®é¢˜åœ¨è´Ÿè½½ç³»æ•° (load factor) æ¯”è¾ƒå¤§æ—¶å€™éå¸¸ä¸¥é‡ï¼Œæ„Ÿå…´è¶£çš„åŒå­¦å¯ä»¥å»çœ‹ä¸‹å‚è€ƒæ–‡çŒ® [2] ä¸­ CMU çš„è¯¾ç¨‹è®²ä¹‰ï¼Œæœ‰ä¸€äº›è¯æ˜å’Œå®éªŒç»“æœã€‚\nç”±äºè¿™ä¸ªåŸå› ï¼Œçº¿æ€§æ¢æŸ¥çš„æ€§èƒ½å’Œå“ˆå¸Œå‡½æ•°çš„è´¨é‡æœ‰å¾ˆå¤§çš„å…³ç³»ã€‚å½“è´Ÿè½½ç³»æ•°è¾ƒå° (30% -70%) å¹¶ä¸”å“ˆå¸Œå‡½æ•°è´¨é‡æ¯”è¾ƒé«˜æ—¶ï¼Œçº¿æ€§æ¢æŸ¥çš„å®é™…è¿è¡Œé€Ÿåº¦æ˜¯ç›¸å½“å¿«çš„ã€‚\näºŒæ¬¡æ¢æŸ¥åˆ™å¾ˆå¥½çš„è§£å†³äº† primary clustering çš„é—®é¢˜ï¼Œä½†åŒæ ·æ— æ³•é¿å…èšé›†ï¼Œè¿™ä¸ªèšé›†å«åš secondary clustering: å½“ä¸¤ä¸ªå“ˆå¸Œå€¼ç›¸åŒæ—¶ï¼Œå®ƒä»¬çš„æ¢æŸ¥åºåˆ—ä¹Ÿæ˜¯ç›¸åŒçš„ï¼Œè¿™å°±å’Œåˆšæ‰çš„ä¸€æ ·ï¼Œæ¢æŸ¥åºåˆ—ä¼šè¶Šæ¥è¶Šé•¿ã€‚\näºŒæ¬¡æ¢æŸ¥æœ‰ä¸€ä¸ªé‡è¦çš„æ€§è´¨ï¼šå½“è¡¨å¤§å°æ˜¯ç´ æ•° pï¼Œå¹¶ä¸”è¡¨ä¸­è¿˜æœ‰è‡³å°‘ä¸€åŠçš„ä½ç½®æ˜¯ç©ºçš„ï¼Œé‚£ä¹ˆäºŒæ¬¡æ¢æŸ¥ä¸€å®šèƒ½æ‰¾åˆ°ç©ºçš„ä½ç½®ï¼Œå¹¶ä¸”ä»»ä½•ä½ç½®åªä¼šè¢«æ¢æŸ¥ä¸€æ¬¡ã€‚å…³äºè¿™ä¸ªæ€§è´¨çš„è¯æ˜åŒæ ·å¯ä»¥å‚è€ƒ CMU çš„æ•™æã€‚ç”±äºåªèƒ½åœ¨è´Ÿè½½ç³»æ•°å°äº 0.5 æ—¶æ‰æœ‰è¿™ä¸ªä¿è¯ï¼ŒäºŒæ¬¡æ¢æŸ¥æ³•çš„ç©ºé—´æ•ˆç‡ä¸æ€ä¹ˆé«˜ã€‚\nDouble hashing åŒé‡å“ˆå¸Œä¸çº¿æ€§/äºŒæ¬¡æ¢æŸ¥ä¸€æ ·ï¼Œéƒ½æ˜¯ä¸€æ­¥æ­¥æ¢æŸ¥ç©º/å­˜æ”¾çš„ä½ç½®ï¼Œåªä¸è¿‡ä½¿ç”¨ä¸¤ä¸ªå“ˆå¸Œå‡½æ•° h_1 å’Œ h_2ï¼Œæ¢æŸ¥çš„ä½ç½®åºåˆ— s(i) = (h_1(e) +i * h_2(e)) % nã€‚åŒé‡å“ˆå¸Œæœ‰æ•ˆåœ°é¿å…äº† secondary clusteringï¼Œå› ä¸ºå¯¹äºæ¯ä¸ªæ¢æŸ¥èµ·ç‚¹ï¼Œä¸åŒçš„å…ƒç´ å¯¹åº”çš„æ¢æŸ¥åºåˆ—ä¹Ÿæ˜¯ä¸åŒçš„ã€‚\nåŒé‡å“ˆå¸Œç›¸æ¯”äºçº¿æ€§/äºŒæ¬¡æ¢æŸ¥ï¼Œå¯ä»¥ç”¨æ›´å°çš„è¡¨ç©ºé—´å­˜æ”¾æ›´å¤šçš„å…ƒç´ ï¼Œä½†æ˜¯æ¢æŸ¥çš„è®¡ç®—è¿‡ç¨‹ä¼šè¾ƒæ…¢ã€‚\nRobin Hood hashing ç½—å®¾æ±‰å“ˆå¸Œ (Robin Hood Hashing) æ˜¯ä¸€ä¸ªå¼€åœ°å€æ³•çš„å˜ç§ï¼Œæˆ‘ä»¬é€šå¸¸æ‰€è¯´çš„ç½—å®¾æ±‰å“ˆå¸Œæ˜¯æŒ‡ Robin Hood Linear Probingã€‚åœ¨è¿™ç¯‡åšæ–‡ [14] ä¸­ï¼Œä½œè€…ç”šè‡³æ¨èå¤§å®¶ä½¿ç”¨åŸºäºç½—å®¾æ±‰å“ˆå¸Œå®ç°çš„å“ˆå¸Œè¡¨ã€‚é‚£å®ƒåˆ°åº•æœ‰ä»€ä¹ˆä¼˜åŠ¿ï¼Ÿ\nTo give you an idea how Robin Hood Hashing improves things, the probe length variance for a RH table at a load factor of 0.9 is 0.98, whereas for a normal open addressing scheme itâ€™s 16.2. At a load factor of 0.99 itâ€™s 1.87 and 194 respectively.\næ¢å¥è¯è¯´ï¼Œç½—å®¾æ±‰å“ˆå¸Œå¯ä»¥æ˜¾è‘—é™ä½æ¢æŸ¥é•¿åº¦çš„æ–¹å·®ã€‚æˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹å®ƒæ˜¯æ€ä¹ˆåšçš„ï¼š\nå¯¹æ¯ä¸ªå“ˆå¸Œè¡¨ä¸­çš„å…ƒç´ ï¼Œè®°å½•æ’å…¥æ—¶çš„æ¢æŸ¥é•¿åº¦ å½“æ’å…¥ä¸€ä¸ªæ–°å…ƒç´ æ—¶ï¼Œå¯¹äºæ¢æŸ¥è¿‡ç¨‹ä¸­çš„å…ƒç´ ï¼Œå¦‚æœå®ƒçš„æ¢æŸ¥é•¿åº¦å°äºå½“å‰æ’å…¥å…ƒç´ çš„æ¢æŸ¥é•¿åº¦ï¼Œé‚£ä¹ˆäº¤æ¢è¿™ä¸¤ä¸ªå…ƒç´  (ä»¥åŠæ¢æµ‹é•¿åº¦)ï¼Œç„¶åç»§ç»­æ¢æŸ¥ ä¹Ÿå°±æ˜¯è¯´ï¼Œäº‹å®ä¸Šå¤§å®¶çš„æ¢æŸ¥é•¿åº¦æ›´åŠ å¹³å‡äº†ï¼Œæ‰€ä»¥æœŸæœ›æœ€é•¿æ¢æŸ¥é•¿åº¦ä¹Ÿä¼šæ˜¾è‘—çš„ä¸‹é™ã€‚è¿™ä¹Ÿæ˜¯ç½—å®¾æ±‰ (è‹±å›½ä¼ è¯´ä¸­çš„ä¾ ç›—) å“ˆå¸Œåå­—çš„æ¥æºï¼ŒåŠ«å¯Œæµè´«ã€‚è™½ç„¶å¤§éƒ¨åˆ†å…ƒç´ çš„æ¢æŸ¥é•¿åº¦éƒ½æ›´è¶‹è¿‘äºå¹³å‡å€¼ï¼Œä¸æ˜¯ä¸€æ¬¡å°±èƒ½æŸ¥åˆ°ï¼Œä½†æ˜¯ç”±äºè¿™éƒ¨åˆ†å¼€é”€è¾ƒ CPU åŠ è½½ cache line å¼€é”€å¯ä»¥å¿½ç•¥ä¸è®¡ï¼Œæ‰€ä»¥æ•´ä½“ä¸Šä»æœ‰æ˜¾è‘—çš„æé«˜ã€‚\nè®ºæ–‡ [16] ä¸­é’ˆå¯¹å„ç§è´Ÿè½½ç³»æ•°å’Œè¡¨è§„æ¨¡çš„å®éªŒè¡¨æ˜ï¼Œç½—å®¾æ±‰å“ˆå¸Œåœ¨è´Ÿè½½ç³»æ•°ä¸º 0.9 æ—¶ï¼Œæœ€é•¿æ¢æŸ¥é•¿åº¦çš„æœŸæœ›å€¼ä¹Ÿå°±æ˜¯ 6 å·¦å³ (è¡¨è§„æ¨¡ 20ä¸‡)ï¼Œè€Œä¸”éšç€è¡¨è§„æ¨¡çš„å¢å¤§ï¼Œå¢é•¿é€Ÿåº¦æä¸ºç¼“æ…¢ã€‚\nä½†æ˜¯ï¼Œå³ä½¿æ˜¯ç½—å®¾æ±‰å“ˆå¸Œä¹Ÿä¸èƒ½è§£å†³ Primary clustering çš„é—®é¢˜ï¼Œè¯¥èšç°‡çš„è¿˜æ˜¯ä¼šèšç°‡åœ¨ä¸€èµ·ï¼Œå¦‚æœåœ¨èšç°‡å—å¼€å§‹æ¢æŸ¥ä¸€ä¸ªä¸å­˜åœ¨çš„å…ƒç´ ï¼Œé‚£ä¹ˆæ¢æŸ¥è¿‡ç¨‹ä¼šç›¸å½“æ¼«é•¿ã€‚ä¸å¿…æƒŠæ…Œï¼Œè¿™ä¸ªé—®é¢˜å¾ˆå®¹æ˜“è§£å†³ï¼šæˆ‘ä»¬è®°å½•ä¸€ä¸ªå…¨å±€çš„æœ€é•¿æ¢æŸ¥é•¿åº¦ï¼Œå¦‚æœå½“å‰æ¢æŸ¥é•¿åº¦å¤§äºå…¨å±€æœ€é•¿æ¢æŸ¥é•¿åº¦äº†ï¼Œé‚£è‚¯å®šæ˜¯æ‰¾ä¸åˆ°äº†ï¼Œæˆ‘ä»¬å°±å¯ä»¥ç›´æ¥è¿”å›ã€‚è€Œæ ¹æ®ä¸Šé¢çš„å®éªŒï¼Œå…¨å±€æœ€é•¿ä¹Ÿä¸ä¼šå¤ªé•¿ï¼Œéº»éº»å†ä¹Ÿä¸æ€•æˆ‘æŸ¥è¯¢å¤±è´¥äº†ï¼\nåœ¨å„ç§æµ‹è¯•ä¸­ï¼Œç½—å®¾æ±‰å“ˆå¸Œè¡¨çš„ç©ºé—´å’Œæ—¶é—´æ€§èƒ½è¡¨ç°éƒ½éå¸¸å¥½ï¼Œå¸Œæœ›ä»¥ååœ¨å·¥ä½œè¿‡ç¨‹ä¸­èƒ½æœ‰æœºä¼šä½¿ç”¨ã€‚\n2-choice hashing 2-choice hashing åŒæ ·æ˜¯ä½¿ç”¨ä¸¤ä¸ªå“ˆå¸Œå‡½æ•° h_1 å’Œ h_2ï¼Œæ¯æ¬¡æ’å…¥æ—¶ï¼Œåªè€ƒè™‘ h_1(e) å’Œ h_2(e) è¿™ä¸¤ä¸ªä½ç½®ï¼Œå¹¶é€‰å–å…¶ä¸­å…ƒç´ å°‘çš„é‚£ä¸ªæ’å…¥ã€‚2-choice hashing æœ‰ä¸€ä¸ªç¥å¥‡çš„ç»“è®ºï¼Œå³æ¯ä¸ªæ¡¶ä¸­çš„å…ƒç´ çš„æœŸæœ›å€¼ä¸º $\\theta(\\log(\\log(n)))$ã€‚\nå…³äºæœŸæœ›å€¼çš„è¯æ˜ï¼Œå¦‚æœä½ ä¹Ÿæ˜¯å—å¤§çš„åŒå­¦å¹¶ä¸”è¢«å°¹ä¸€é€šè€å¸ˆçš„éšæœºç®—æ³•è¯¾è™è¿‡ï¼Œé‚£ä½ åº”è¯¥å¬è¯´è¿‡ The power of 2-choiceï¼ŒåŒæ · CMU çš„è®²ä¹‰ä¸­ä¹Ÿæœ‰è¯æ˜ã€‚\nCuckoo Hashing å¸ƒè°·é¸Ÿå“ˆå¸Œ (Cuckoo Hashing) ä¹Ÿæ˜¯å¼€åœ°å€æ³•çš„ä¸€ç§ï¼Œå®ƒæœ€å·®æƒ…å†µçš„æŸ¥è¯¢é€Ÿåº¦éƒ½æ˜¯ O(1) çš„ã€‚å¸ƒè°·é¸Ÿå“ˆå¸Œçš„åå­—æ¥æºäºä¸€ç§å¸ƒè°·é¸Ÿï¼Œä»–ä»¬çš„å¹¼å´½ä¼šåœ¨åˆšå­µåŒ–çš„æ—¶å€™ï¼ŒæŠŠå…¶ä»–æœªå­µåŒ–çš„è›‹ä¸€è„šè¸¢å‡ºé¸Ÿå·¢ã€‚\nå¸ƒè°·é¸Ÿå“ˆå¸Œé€šå¸¸ä½¿ç”¨ä¸¤ä¸ªæ•°ç»„ä»¥åŠå“ˆå¸Œå‡½æ•°ï¼Œæ‰€ä»¥å’Œ 2-choice hashing ä¸€æ ·ï¼Œæ¯ä¸€ä¸ªå…ƒç´ éƒ½å¯¹åº”ä¸¤ä¸ªä½ç½®ã€‚å½“ä¸€ä¸ªå…ƒç´ æ’å…¥çš„æ—¶å€™ï¼Œå¦‚æœä¸¤ä¸ªä½ç½®æ²¡æ»¡ï¼Œå°±ç›´æ¥æ”¾å…¥ç©ºçš„ä½ç½®ï¼›å¦‚æœæ»¡äº†ï¼Œé‚£ä¹ˆè¸¢æ‰å…¶ä¸­ä¸€ä¸ªï¼Œæ”¾å…¥å…¶ä¸­ï¼Œç„¶åæŠŠè¸¢æ‰çš„è¿™ä¸ªæ”¾å…¥å®ƒçš„ç¬¬äºŒä¸ªä½ç½®ï¼›å¦‚æœè¸¢æ‰çš„è¿™ä¸ªçš„ç¬¬äºŒä¸ªä½ç½®ä¹Ÿè¢«å äº†ï¼Œé‚£ä¹ˆç»§ç»­è¸¢æ‰å…¶ä¸­çš„ï¼›å¾ªç¯ä¸Šè¿°è¿‡ç¨‹ç›´åˆ°æœ€åæ”¾å…¥ç©ºçš„ä½ç½®ã€‚\næ˜¾ç„¶ï¼Œå½“æœ€åé‡åˆ°æ— é™å¾ªç¯çš„æ—¶å€™ï¼Œä¸Šè¿°æ’å…¥è¿‡ç¨‹æœ‰å¯èƒ½ä¼šå¤±è´¥ã€‚æ­¤æ—¶æˆ‘ä»¬å¯ä»¥ç”¨æ–°çš„å“ˆå¸Œå‡½æ•°åŸåœ°é‡å»ºä¸€ä¸ªè¡¨ï¼š\nThere is no need to allocate new tables for the rehashing: We may simply run through the tables to delete and perform the usual insertion procedure on all keys found not to be at their intended position in the table.\nâ€”â€‰Pagh \u0026amp; Rodler, \u0026ldquo;Cuckoo Hashing\u0026rdquo;[17]\nå¸ƒè°·é¸Ÿå“ˆå¸Œç›¸è¾ƒäºå…¶ä»–æ–¹æ³•æ¥è¯´ï¼Œç©ºé—´åˆ©ç”¨ç‡æ›´é«˜ï¼Œæ‰€ä»¥æœ‰ç ”ç©¶è€…ç”¨å®ƒè®¾è®¡äº† Cuckoo Filter [18] [10]ï¼Œæ¯” Bloom Filter æ›´åŠ çš„ç©ºé—´é«˜æ•ˆï¼Œå¹¶ä¸”æ”¯æŒåŠ¨æ€åˆ é™¤ã€‚\nå…·ä½“çš„å…¶ä»–ç»†èŠ‚è¿™é‡Œå°±ä¸å¤šå™è¿°äº†ï¼Œå¤§å®¶å¯ä»¥å»é˜…è¯»ç»´åŸºç™¾ç§‘ [5] ä¸Šçš„èµ„æ–™å’Œå‚è€ƒæ–‡çŒ®ã€‚\nBenchmarks è¿™å„¿æœ‰ä¸€ç¯‡åšå®¢[11]ï¼Œåˆ†æäº† 8 ç§å“ˆå¸Œè¡¨ä¸»æµå®ç°åœ¨å„ç§åœºæ™¯ä¸‹çš„æ—¶é—´å’Œç©ºé—´æ€§èƒ½ï¼Œåˆ†æè¡¨æ˜ç½—å®¾æ±‰å“ˆå¸Œè¡¨ (robin_map) å’ŒäºŒæ¬¡çº¿æ€§æ¢æŸ¥ (dense_map) çš„æ€§èƒ½è¡¨ç°éƒ½ç›¸å½“ä¼˜ç§€ï¼Œè¯¦ç»†æ•°æ®å¯ä»¥å‰å¾€åŸåšæ–‡æŸ¥çœ‹ã€‚\nReferences [1] https://courses.cs.washington.edu/courses/cse373/01sp/Lect13.pdf\n[2] http://www.cs.cmu.edu/afs/cs/academic/class/15210-f13/www/lectures/lecture24.pdf\n[3] https://en.wikipedia.org/wiki/Hash_table\n[4] https://github.com/efficient/libcuckoo\n[5] https://en.wikipedia.org/wiki/Cuckoo_hashing\n[6] https://en.wikipedia.org/wiki/2-choice_hashing\n[7] https://www.threadingbuildingblocks.org/\n[8] https://github.com/sparsehash/sparsehash\n[9] http://www.cs.cmu.edu/afs/cs/academic/class/15859-f04/www/scribes/lec10.pdf\n[10] https://brilliant.org/wiki/cuckoo-filter/\n[11] https://tessil.github.io/2016/08/29/benchmark-hopscotch-map.html\n[12] http://www.cs.princeton.edu/~mfreed/docs/cuckoo-eurosys14.pdf\n[13] http://tcs.nju.edu.cn/wiki/index.php/%E9%AB%98%E7%BA%A7%E7%AE%97%E6%B3%95_(Fall_2017)\n[14] https://www.sebastiansylvan.com/post/robin-hood-hashing-should-be-your-default-hash-table-implementation/\n[15] http://citeseerx.ist.psu.edu/viewdoc/summary?doi=10.1.1.130.6339\n[16] http://codecapsule.com/2013/11/17/robin-hood-hashing-backward-shift-deletion/ [17] http://citeseerx.ist.psu.edu/viewdoc/download?doi=10.1.1.25.4189\u0026rep=rep1\u0026type=pdf [18] https://www.cs.cmu.edu/~dga/papers/cuckoo-conext2014.pdf\n","date":"2018-08-16T14:55:23+08:00","permalink":"https://blog.crazyark.me/p/hash-table-collision/","title":"å“ˆå¸Œè¡¨ -- å“ˆå¸Œå†²çª"},{"content":"ä»æŠ¥åæ¯”èµ›å¼€å§‹åˆ°ç°åœ¨å°†è¿‘å››ä¸ªæœˆäº†ï¼Œç»ˆäºå‘Šä¸€æ®µè½ï¼Œæœ€ç»ˆæ‹¿åˆ°äº†å­£å†›ä¹Ÿå¾ˆå¼€å¿ƒã€‚è¿™ä¸‰ä¸ªæœˆä¸­æˆ‘å­¦åˆ°äº†å¾ˆå¤šæœ‰ç”¨çš„å·¥ç¨‹çŸ¥è¯†ï¼Œé¡ºä¾¿æŠŠ C++ åˆæ‘¸ç†Ÿäº†ã€‚åˆèµ›ä»£ç å®åœ¨å†™å¤ªä¸‘å°±ä¸æ”¾å‡ºæ¥äº†ï¼Œå¤èµ›çš„ä»£ç æ‰˜ç®¡åœ¨ github ä¸Šï¼š\nhttps://github.com/arkbriar/awrace2018_messagestore\nä¸‹é¢æ˜¯æœ¬æ¬¡å¤§èµ›åˆèµ›å’Œå¤èµ›éƒ¨åˆ†çš„æ€è€ƒè¿‡ç¨‹å’Œæœ€ç»ˆæ–¹æ¡ˆã€‚\nåˆèµ›éƒ¨åˆ† èµ›é¢˜èƒŒæ™¯åˆ†æåŠç†è§£ å®ç°ä¸€ä¸ªé«˜æ€§èƒ½çš„ Service Mesh Agent ç»„ä»¶ï¼Œå¹¶åŒ…å«å¦‚ä¸‹ä¸€äº›åŠŸèƒ½ï¼š1. æœåŠ¡æ³¨å†Œä¸å‘ç°, 2. åè®®è½¬æ¢, 3. è´Ÿè½½å‡è¡¡\næœ¬é¢˜è¦æ±‚æˆ‘ä»¬èƒ½å¤Ÿå°½å¯èƒ½çš„é«˜æ€§èƒ½ï¼Œæˆ‘ä»¬é¦–å…ˆå¯¹åœºæ™¯å’Œå¤§è‡´æ€è·¯è¿›è¡Œäº†ä¸€ä¸ªé‡è¿°ï¼š\nConsumer å°†æ¥å—è¶…è¿‡ 500 ä¸ªè¿æ¥ï¼šæƒ³åˆ°ä½¿ç”¨ IO multiplex Http = TCP è¿æ¥ï¼šç¦ç”¨ Nagle ç®—æ³• Dubbo provider åªæœ‰ 200 ä¸ªå¤„ç†çº¿ç¨‹ï¼Œè¶…è¿‡ 200 ä¸ªå¹¶å‘è¯·æ±‚ä¼šå¿«é€Ÿå¤±è´¥ï¼š è´Ÿè½½å‡è¡¡å°½é‡é¿å… provider è¿‡è½½ çº¿ä¸Šç½‘ç»œæ€§èƒ½ (pps) è¾ƒå·®ï¼šæ‰¹é‡å‘é€ request/responseï¼Œä½¿ç”¨ UDP è¿›è¡Œ Agent é—´é€šä¿¡ Consumer æ€§èƒ½è¾ƒå·®ï¼šå°†åè®®è½¬æ¢ç­‰æ”¾åˆ° provider agent ä¸Šå»åš æ ¸å¿ƒæ€è·¯ ä¸ºäº†å‡å°‘ç³»ç»Ÿå¼€é”€ï¼Œæˆ‘ä»¬åœ¨ agent ä¹‹é—´éƒ½åªä¿æŒä¸€ä¸ª udp ä¿¡é“ï¼Œåœ¨ PA (Provider Agent) å’Œ Provider ä¹‹é—´ä¹Ÿåªä¿æŒä¸€ä¸ª tcp ä¿¡é“ã€‚\næ•´ä½“çš„æ¶æ„å›¾å¦‚ä¸‹æ‰€ç¤ºï¼š\nå…¶ä¸­ï¼ŒCA (Consumer Agent) ç«¯ä½¿ç”¨ä¸€ä¸ª epoll çš„ eventloopï¼Œloop çš„å¤§è‡´æµç¨‹å¦‚ä¸‹å›¾ï¼š\n1. é¦–å…ˆæ¥èµ·æ‰€æœ‰çš„æ–°çš„è¿æ¥ï¼Œåœ¨æ¥åˆ°è¿æ¥çš„æ—¶å€™ï¼Œæ ¹æ® provider çš„æƒé‡ç›´æ¥åˆ†é…ä¸€ä¸ª provider å¤„ç†åç»­è¯¥è¿æ¥çš„æ‰€æœ‰è¯·æ±‚\n2. è¯»æ‰€æœ‰çš„èƒ½è¯»çš„ socket\nå¦‚æœè¯»åˆ°å®Œæ•´çš„è¯·æ±‚ï¼Œé‚£ä¹ˆå°†å®ƒæ”¾å…¥åˆ°è¯·æ±‚é˜Ÿåˆ— å¦‚æœè¯»åˆ°å®Œæ•´çš„å›å¤ï¼Œç›´æ¥é€šè¿‡é˜»å¡å†™çš„æ–¹å¼å†™å› 3. æ‰€æœ‰äº‹ä»¶å¤„ç†å®Œæˆä»¥åï¼Œæ‰¹é‡å‘é€æ‰€æœ‰çš„è¯·æ±‚é˜Ÿåˆ— (æ­¤å¤„ä½¿ç”¨ writev)\nåœ¨è¯·æ±‚å‘é€å’Œè·å–å›å¤çš„è¿‡ç¨‹ä¸­ï¼Œæˆ‘ä»¬å§‹ç»ˆæœ‰ä¸€ä¸ª id é™„åœ¨è¯·æ±‚ä¸­ï¼Œè¿™ä¸ª id æ˜¯ consumer ç«¯å”¯ä¸€çš„ï¼Œè¿™ä¿è¯äº†æˆ‘ä»¬åªåœ¨ consumer ç«¯æœ‰ä¸€ä¸ª map æ¥ç¡®å®šå›å¤çš„å½’å®¿ï¼Œåœ¨è¿™é‡Œæˆ‘ä»¬çš„ id æ˜¯ handler çš„ç¼–å·ã€‚\nå…³é”®ä»£ç  æ‰¹é‡å‘é€è¯·æ±‚ä»£ç å¤§è‡´å¦‚ä¸‹ï¼š\nepoll_event events[LOWER_LOAD_EVENT_SIZE]; while (_event_group.wait_and_handle(events, LOWER_LOAD_EVENT_SIZE, -1)) { // check pending write queue, and block write all for (auto\u0026amp; entry : _pending_data) { // write all requests to provider agent // ... } } å…¶ä½™ä»£ç åœ¨ https://code.aliyun.com/arkbriar/dubbo-agent-cxx ä¸­ã€‚\nå¤èµ›éƒ¨åˆ† èµ›é¢˜èƒŒæ™¯åˆ†æåŠç†è§£ å®ç° Queue Store çš„æ¥å£ put/getï¼Œè¦æ±‚æ”¯æŒå•æœºç™¾ä¸‡é˜Ÿåˆ—å’Œç™¾Gæ•°æ®ã€‚\nåœ¨å¯¹é¢˜ç›®ç¨å¾®äº†è§£è¿‡åï¼Œæˆ‘ä»¬å¾—åˆ°äº†ä»¥ä¸‹çš„å‡ ä¸ªä¿¡æ¯ï¼š\næ¶ˆæ¯æ¡æ•°å¤§çº¦ä¸º 2gï¼Œæ¶ˆæ¯å¤§å°å¤§çº¦ä¸º 64 byteï¼Œä½†æ˜¯å¯èƒ½ä¼šæœ‰é•¿ä¸º 1024 byte çš„æ¶ˆæ¯ çº¿ä¸Šçš„æœºå™¨æ˜¯ 4c8g å¸¦ ssdï¼Œiops 1w å·¦å³ï¼Œé¡ºåº 4k è¯»å†™æ€§èƒ½å¤§çº¦ä¸º 200m/s å·¦å³ å¯¹åŒä¸€ä¸ªé˜Ÿåˆ—ï¼Œput æ˜¯åºåˆ—åŒ–çš„ å¯¹åŒä¸€ä¸ªé˜Ÿåˆ—ï¼Œget å¯èƒ½æ˜¯å¹¶å‘çš„ ä¸å­˜åœ¨åˆ é™¤é˜Ÿåˆ—å’Œæ¶ˆæ¯ï¼Œä¹Ÿä¸å­˜åœ¨ put ä¸ get åŒæ—¶è¿›è¡Œ è€Œè¯„æµ‹ç¨‹åºçš„ç©ºè·‘ put TPS å¤§çº¦åœ¨ 600w å·¦å³ï¼Œæ€§èƒ½ä¹Ÿä¸æ˜¯å¾ˆé«˜ï¼›è€Œåœ¨ä¸å‹ç¼©çš„æƒ…å†µä¸‹ï¼Œå†™æ‰“æ»¡å†™ 100g æ•°æ®æœ€å°‘è€—æ—¶ 500sã€‚å› æ­¤æœ¬é¢˜è¦æ±‚é€‰æ‰‹èƒ½å¤Ÿå°½å¯èƒ½çš„ä¿è¯ put é˜¶æ®µçš„æ— é˜»å¡ï¼Œä»¥åŠèƒ½å¤Ÿè®¾è®¡å‡ºä¸€ä¸ªè‰¯å¥½çš„æ•°æ®ç»“æ„ï¼Œä¿è¯ get é˜¶æ®µèƒ½å¤Ÿåˆ©ç”¨ç¼“å­˜å’Œå±€éƒ¨æ€§ã€‚\næ ¸å¿ƒæ€è·¯ ä¸ºäº†å®ç°é«˜æ€§èƒ½çš„æ¥å£ï¼Œæˆ‘ä»¬å¿…é¡»è¦è§£å†³ä»¥ä¸‹ä¸‰ä¸ªé—®é¢˜ï¼š\nå­˜å‚¨è®¾è®¡é—®é¢˜ï¼Œè¦æ±‚èƒ½å¤Ÿæ”¯æŒé¡ºåºå†™ä¸éšæœºè¯» IO/SSD ä¼˜åŒ–é—®é¢˜ï¼Œèƒ½å°½å¯èƒ½çš„ä½¿ IO åšåˆ°æé™ å†…å­˜è§„åˆ’é—®é¢˜ï¼Œç”±äºè¯„æµ‹ç¯å¢ƒå†…å­˜æ¯”è¾ƒæœ‰é™ï¼Œéœ€è¦ç´§å‡‘çš„è§„åˆ’å’Œä½¿ç”¨ å­˜å‚¨è®¾è®¡ï¼šé¡µå¼å­˜å‚¨ é¦–å…ˆæˆ‘ä»¬ç ”ç©¶äº†ä¸€ä¸ªæ¯”è¾ƒç±»ä¼¼çš„äº§å“ï¼ŒKafkaï¼š\nKafka çš„å¤§è‡´å­˜å‚¨æ¨¡å‹å¦‚ä¸Šå›¾æ‰€ç¤ºï¼Œè¿™é‡Œå¹¶ä¸å±•å¼€å™è¿°ï¼Œæœ‰å…´è¶£çš„åŒå­¦å¯ä»¥åˆ°è¿™ä¸ªç½‘ç«™ç»§ç»­å­¦ä¹  https://thehoard.blog/how-kafkas-storage-internals-work-3a29b02e026\nä½†æ˜¯å¯¹äºæˆ‘ä»¬æ¥è¯´ï¼Œç…§æ¬å®ƒæœ‰å¾ˆå¤šé—®é¢˜ï¼š\n100w ä¸ªé˜Ÿåˆ—ï¼Œè‡³å°‘æœ‰ 200w ä¸ªæ–‡ä»¶ï¼Œè¿™å¯¹æ–‡ä»¶ç³»ç»Ÿå½¢æˆäº†å·¨å¤§çš„è´Ÿæ‹… Kafka ä½¿ç”¨å…¨é‡ç´¢å¼•ï¼Œè€Œ 2g æ¶ˆæ¯çš„å…¨é‡ç´¢å¼•æ ¹æœ¬æ”¾ä¸è¿›å†…å­˜ï¼Œè‡³å°‘åšä¸¤çº§ç´¢å¼•ï¼Œè¿™åŠ é‡äº†è¯»çš„è´Ÿæ‹… 2g æ¶ˆæ¯çš„å…¨é‡ç´¢å¼•çš„ç£ç›˜ overhead å¤ªå¤§ é˜Ÿåˆ—çš„ä¸»è¦åœºæ™¯æ˜¯é¡ºåºè¯»ï¼Œå…¨é‡ç´¢å¼•ä¼˜åŠ¿å®Œå…¨æ²¡æœ‰å‘æŒ¥ (éšæœºè¯») æ‰€ä»¥æˆ‘ä»¬å€Ÿé‰´äº†ä¸€ä¸ªå¸¸è§çš„æ–‡ä»¶åˆ‡åˆ†æ¨¡å¼ï¼Œä¹Ÿå°±æ˜¯åˆ†é¡µï¼Œå¹¶ä»¥é¡µä¸ºæœ€å°å•ä½è¿›è¡Œæ“ä½œå’Œå»ºç«‹ç´¢å¼•ã€‚è¿™å°±æ˜¯æˆ‘ä»¬çš„å­˜å‚¨æ¨¡å¼ï¼šé¡µå¼å­˜å‚¨ã€‚\né€šè¿‡è¿™ä¸ªå­˜å‚¨æ–¹å¼ï¼Œ\nå¯ä»¥æœ‰æ•ˆçš„å‡å°‘æ–‡ä»¶çš„æ•°ç›® å¹¶ä¸”ç”±äºé¡ºåºå†™çš„æ€§è´¨ï¼Œæˆ‘ä»¬å¹¶ä¸éœ€è¦è€ƒè™‘è„é¡µçš„é—®é¢˜ åŒæ—¶ç”±äºé¡µæ˜¯æœ€å°å•ä½ï¼ŒåŒå±ä¸€ä¸ªé˜Ÿåˆ—çš„è¿ç»­æ¶ˆæ¯å°½å¯èƒ½çš„åœ¨ä¸€ä¸ªé¡µä¸­ï¼Œä¿è¯äº†é¡ºåºè¯»èƒ½å¤Ÿåˆ©ç”¨ç¼“å­˜å’Œå±€éƒ¨æ€§ æœ€åï¼Œæˆ‘ä»¬å¯¹é¡µå»ºç«‹ç´¢å¼•ï¼Œæ­¤æ—¶çš„ç´¢å¼•å·²ç»å®Œå…¨å¯ä»¥æ”¾å…¥å†…å­˜äº† ä¸ºäº†å…¼é¡¾å†…å­˜ï¼Œé¡µå¤§å°è®¾ç½®ä¸º 4kã€‚\nIO/SSD ä¼˜åŒ–ï¼šå—è¯»å—å†™ å¯¹äºç°æœ‰çš„å¤§å¤šæ•°å­˜å‚¨è®¾å¤‡æ¥è¯´ï¼Œæ— è®ºæ˜¯ HDD è¿˜æ˜¯ SSD ä¹Ÿå¥½ï¼Œé¡ºåºè¯»å†™æ°¸è¿œéƒ½æ˜¯æœ€ä¼˜çš„ã€‚\nä½†æ˜¯ï¼ŒSSD æœ‰åŒºåˆ«çš„ä¸€ç‚¹åœ¨äºï¼Œç”±äº SSD çš„ç‰¹æ€§ â€œå†…ç½®å¹¶å‘â€ï¼Œå¯¹é½äº Clustered Block çš„è¯»å†™å°†å®Œå…¨ä¸è¾“äºé¡ºåºè¯»å†™ã€‚\nå¦‚æœè¦ç†è§£å†…ç½®å¹¶å‘è¿™ä¸ªäº‹æƒ…ï¼Œæˆ‘ä»¬å¯èƒ½éœ€è¦å»äº†è§£ä¸€äº› SSD çš„åŸç†ï¼Œä¸‹é¢è¿™ä¸ªç½‘ç«™æä¾›äº†æ›´å¤šçš„ç»†èŠ‚ï¼Œåœ¨è¿™é‡Œåªå™è¿°ä¸€éƒ¨åˆ†çš„ä¸œè¥¿ã€‚\nhttp://codecapsule.com/2014/02/12/coding-for-ssds-part-3-pages-blocks-and-the-flash-translation-layer/\nSSD çš„è¯»å†™éƒ½æ˜¯ä»¥é¡µ (NAND-flash page) ä¸ºå•ä½çš„ï¼Œå³ä½¿åªè¯»/å†™ä¸€ä¸ª bitï¼Œä¹Ÿä¼šåŒæ—¶è¯»/å†™ä¸€ä¸ªé¡µã€‚ç›¸é‚»çš„é¡µç»„æˆä¸€ä¸ªå—ï¼Œå—å¤§å°é€šå¸¸åœ¨ 256k åˆ° 4m ä¹‹é—´ã€‚SSD çš„è¿˜æœ‰äº›åŸç†ä¼šå¯¼è‡´ä¸€ä¸ªå†™æ”¾å¤§å’Œ GC çš„é—®é¢˜ï¼Œè¿™é‡Œä¸å†å±•å¼€ï¼Œæœ‰å…´è¶£çš„åŒå­¦è‡ªè¡Œäº†è§£ã€‚\nSSD çš„å†…ç½®å¹¶å‘æŒ‡çš„æ˜¯ï¼Œå›¾ç¤ºä¸Šé¢çš„ä¸åŒ channel/package/chip/plane çš„è®¿é—®éƒ½æ˜¯å¯ä»¥å¹¶å‘è¿›è¡Œçš„ï¼Œä¸åŒçš„ plane ä¸Šçš„ block ç»„æˆçš„è®¿é—®å•ä½å«åšèšç°‡å— (Clustered Block)ï¼Œå¦‚å›¾ç¤ºä¸­é»„è‰²æ¡†ä¸­çš„éƒ¨åˆ†ã€‚å¯ä»¥çœ‹åˆ°ï¼Œè¯»å†™èšç°‡å—å°±èƒ½å……åˆ†åœ°å¹¶å‘è®¿é—®ï¼Œè€Œæˆ‘ä»¬æ¥ä¸‹æ¥è¦è®²çš„è¯»å†™æ¨¡å¼å°±æ˜¯ï¼Œå¯¹é½èšç°‡å—éšæœºè¯»å†™ï¼Œæ€§èƒ½å°†å®Œå…¨ä¸è¾“é¡ºåºè¯»å†™ã€‚è¿™é‡Œé¢å¤–æä¸€å¥ï¼Œé€šå¸¸èšç°‡å—å¤§å°ä¸º 32/64mã€‚\nè¿™æ˜¯ä¸€å¼ éšæœºå†™ä¸é¡ºåºå†™çš„ååå¯¹æ¯”ï¼Œåœ¨ 32M/64M ä¸‹ï¼Œéšæœºå†™å·²ç»èƒ½å¤Ÿå…¨çº¿ç­‰åŒé¡ºåºå†™ã€‚ è€Œæˆ‘ä»¬ä¹Ÿåšäº†ä¸€ä¸ªå°æµ‹è¯•ï¼Œæµ‹è¯• 4g å¤§å°çš„æ–‡ä»¶è¯»å†™ï¼Œå•ä½éƒ½æ˜¯ç§’ï¼š\nå…¶ä¸­ concurrent pseudo sequential write æ˜¯æŒ‡å¤šä¸ªçº¿ç¨‹ä»åŒä¸€ä¸ª atomic int ä¸Šè·å–ä¸‹ä¸€ä¸ªå†™ offsetã€‚å®éªŒç»“æœè¯æ˜äº†è¿™ä¸ªæ¨¡å¼çš„æœ‰æ•ˆæ€§ã€‚\næ‰€ä»¥æˆ‘ä»¬æœ€åçš„è¯»å†™æ¨¡å¼ä¸ºå—è¯»å—å†™ï¼š\nå¤§å— (64m) å†™ï¼Œç”šè‡³å¯ä»¥ä¸ç”¨é¡ºåºå†™ æœ‰æ•ˆåœ°æé«˜äº†å¹¶å‘è¯»å†™æ€§èƒ½ é¡ºåºè¯»æ—¶å……åˆ†åˆ©ç”¨ç¼“å­˜å’Œé¢„è¯» å†…å­˜è§„åˆ’ï¼šç²¾æ‰“ç»†ç®— åœ¨ç»“åˆä¸Šè¿°ä¸¤ä¸ªè®¾è®¡çš„åŸºç¡€ä¸Šï¼Œæˆ‘ä»¬å¯¹å†…å­˜æœ‰ä¸ªç²¾ç¡®çš„è§„åˆ’ï¼š\næ¯ä¸ªé˜Ÿåˆ—æœ‰è‡ªå·±çš„ 4k é¡µç¼“å­˜ï¼Œå¯¹åº”äºå½“å‰æ­£åœ¨å†™çš„é¡µ æ¯ä¸ª put çº¿ç¨‹æœ‰è‡ªå·±çš„åŒ 64m å†™ç¼“å†²ï¼Œç¼“å†²æ°¸è¿œå¯¹åº”æŸä¸ªæ–‡ä»¶çš„ä¸€ä¸ªåŒºé—´ æ€»è®¡åŠ èµ·æ¥ç¼“å­˜å…±å ç”¨ 4k * 1m + 64m * 2 â‰ˆ 5.2g æ•´ä½“æ¶æ„ Queue ä¸æ–‡ä»¶çš„å…³ç³»å¦‚ä¸‹å›¾ï¼š\né¡µä¸æ¶ˆæ¯çš„ç»“æ„å¦‚ä¸‹å›¾ï¼š\nSize çš„è®¡ç®—é‡‡ç”¨å˜é•¿ç¼–ç ï¼š\nSize \u0026lt; 128ï¼Œä½¿ç”¨ä¸€ä¸ª byte å­˜å‚¨ï¼Œç¬¬ä¸€ä¸ª bit ä¸º 0 Size \u0026gt;= 128 å¹¶ä¸” \u0026lt; 32768ï¼Œä½¿ç”¨ä¸¤ä¸ª byte å­˜å‚¨ï¼Œä½†æ˜¯ç”±äºç¬¬ä¸€ä¸ª bit ä¹Ÿä¸º 0ï¼Œæ‰€ä»¥å­˜å‚¨ size | 0x8000 é’ˆå¯¹æ¯ä¸ªé¡µçš„ç´¢å¼•å¤§è‡´å¦‚ä¸‹ï¼š\næ¯ä¸ªé¡µå­˜å‚¨é¡µç¼–å·ã€æ–‡ä»¶ç¼–å·ã€é¡µå†…æ¶ˆæ¯æ•°å’Œä¹‹å‰æ‰€æœ‰é¡µæ¶ˆæ¯æ•°è¿™å››é¡¹ï¼Œè¿™æ ·æˆ‘ä»¬åœ¨ get æ—¶äºŒåˆ†æŸ¥æ‰¾å°±å¯ä»¥è·å–åˆ°å¯¹åº”æ¶ˆæ¯æ‰€åœ¨çš„é¡µã€‚æ‰€æœ‰çš„ç´¢å¼•æ€»é‡å¤§çº¦ä¸º 12byte * 25m = 300mï¼Œå®Œå…¨å¯ä»¥æ”¾äºå†…å­˜ã€‚\nPut/Get æµç¨‹ è¿™ä¸¤ä¸ªæµç¨‹ç›¸å¯¹ç®€å•ï¼Œé¦–å…ˆæ˜¯ put æµç¨‹ï¼š\næ£€æŸ¥å†…å­˜ä¸­çš„é¡µè¿˜æœ‰æ²¡æœ‰ç©ºé—´ æœ‰ï¼Œç›´æ¥å†™å…¥ æ²¡æœ‰ï¼Œå°†å½“å‰é¡µå†™å‡ºï¼Œæ›´æ–°ç´¢å¼•ï¼Œç„¶åå†™å…¥æ¶ˆæ¯ é¡µå†™å‡ºæ—¶ä¼šæäº¤åˆ°å½“å‰ put çº¿ç¨‹çš„å†™ç¼“å†²ï¼Œå¹¶åé¦ˆä¿®æ”¹ç´¢å¼•ã€‚å½“å†™ç¼“å†²æ»¡çš„æ—¶å€™ï¼Œä¸åå¤‡çš„ç¼“å†²äº¤æ¢ç»§ç»­å†™å…¥ç¼“å†²ï¼Œå¹¶èµ·æ–°çš„çº¿ç¨‹åˆ·ç›˜ï¼Œè¿™æ ·å°½å¯èƒ½ä¸é˜»å¡ put çº¿ç¨‹ã€‚\nåœ¨æ‰€æœ‰ get å‘ç”Ÿå‰ï¼Œæˆ‘ä»¬ä¼šå¼ºåˆ¶æ‰€æœ‰ç¼“å†²è½ç›˜ï¼Œæ¥ä¸‹æ¥çš„ get æµç¨‹ä¹Ÿç›¸å¯¹ç®€å•ï¼š\näºŒåˆ†æŸ¥æ‰¾ç¬¬ä¸€é¡µå’Œæœ€åä¸€é¡µ é¡ºåºé˜»å¡è¯»å¯¹åº”çš„æ–‡ä»¶é¡µ è·³è¿‡é¡µå†…æ— å…³çš„æ¶ˆæ¯ï¼Œæ”¶é›†æ‰€æœ‰ç›¸å…³æ¶ˆæ¯ å¦‚æœè¯·æ±‚çš„æœ€åä¸€é¡µå‰©ä½™æ¶ˆæ¯æ•°å°äºæŸä¸ªé˜ˆå€¼ (e.g. 15)ï¼Œä½¿ç”¨ readahead é¢„è¯»ä¸‹ä¸€é¡µ è¿”å›è¯·æ±‚çš„æ¶ˆæ¯ æˆ‘ä»¬åœ¨ get çš„è¿‡ç¨‹ä¸­ä¿æŒä¸¤ä¸ªç†å¿µï¼š\nå…¨åŠ›ä½¿ç”¨ OS çš„é¡µç¼“å­˜ å°½å¯èƒ½é¢„è¯»ï¼Œä»¥æœŸæœ›å‡å°‘é¡ºåºè¯»çš„æ—¶é—´ å…¨åŠ›ä½¿ç”¨ OS çš„é¡µç¼“å­˜ä¸»è¦æ˜¯è€ƒè™‘åˆ°\nå®ç° Concurrent LRU cache æ¯”è¾ƒéº»çƒ¦ å¦‚æœå®ç°é˜Ÿåˆ—çš„ä¸€ä¸ªé¡ºåºè¯»ç¼“å†²ï¼Œç±»ä¼¼äºé“¾è¡¨ç»“æ„ï¼Œä¸€æ—¦å‘ç”Ÿå¤šçº¿ç¨‹åŒæ—¶é¡ºåºè¯»ï¼Œç¼“å†²ä¼šä¸€ç›´å¤±æ•ˆï¼›å³ä½¿å®ç° thread local ç¼“å†²ï¼Œå¦‚æœå‡ºç°å•çº¿ç¨‹ä¸åŒåç§»é‡é¡ºåºè¯»åŒä¸€ä¸ªé˜Ÿåˆ— (e.g. å®Œæ•´è¯»ä¸¤æ¬¡)ï¼Œç¼“å†²ä¹Ÿä¼šä¸æ–­å¤±æ•ˆ æ‰€ä»¥ä¸å¦‚ç›´æ¥ä½¿ç”¨é¡µç¼“å­˜ã€‚\nå…³é”®ä»£ç  é˜Ÿåˆ—æ˜ å°„æˆ‘ä»¬ä½¿ç”¨äº† tbb çš„ concurrent hash mapï¼Œæœ€ç»ˆè¯æ˜è¿™æ˜¯æœ€å¤§çš„ cpu ç“¶é¢ˆï¼Œè€Œæˆ‘ä»¬çš„ put å®Œå…¨å¡åœ¨äº† cpu ä¸Šã€‚\ntemplate \u0026lt;class K, class V, class C = tbb::tbb_hash_compare\u0026lt;K\u0026gt;, class A = tbb::cache_aligned_allocator\u0026lt;std::pair\u0026lt;const K, V\u0026gt;\u0026gt;\u0026gt; class ConcurrentHashMapProxy : public tbb::concurrent_hash_map\u0026lt;K, V, C, A\u0026gt; { public: ConcurrentHashMapProxy(size_t n) : tbb::concurrent_hash_map\u0026lt;K, V, C, A\u0026gt;(n) {} ~ConcurrentHashMapProxy() { this-\u0026gt;tbb::concurrent_hash_map\u0026lt;K, V, C, A\u0026gt;::~concurrent_hash_map\u0026lt;K, V, C, A\u0026gt;(); } typename tbb::concurrent_hash_map\u0026lt;K, V, C, A\u0026gt;::const_pointer fast_find(const K\u0026amp; key) const { return this-\u0026gt;internal_fast_find(key); } }; MessageQueue* QueueStore::find_or_create_queue(const String\u0026amp; queue_name) { auto q_ptr = queues_.fast_find(queue_name); if (q_ptr) return q_ptr-\u0026gt;second; decltype(queues_)::const_accessor ac; queues_.find(ac, queue_name); if (ac.empty()) { uint32_t queue_id = next_queue_id_.next(); auto queue_ptr = new MessageQueue(queue_id, this); queues_.insert(ac, std::make_pair(queue_name, queue_ptr)); DLOG(\u0026#34;Created a new queue, id: %d, name: %s\u0026#34;, q-\u0026gt;get_queue_id(), q-\u0026gt;get_queue_name().c_str()); } return ac-\u0026gt;second; } MessageQueue* QueueStore::find_queue(const String\u0026amp; queue_name) const { auto q_ptr = queues_.fast_find(queue_name); return q_ptr ? q_ptr-\u0026gt;second : nullptr; decltype(queues_)::const_accessor ac; queues_.find(ac, queue_name); return ac.empty() ? nullptr : ac-\u0026gt;second; } void QueueStore::put(const String\u0026amp; queue_name, const MemBlock\u0026amp; message) { if (!message.ptr) return; auto q_ptr = find_or_create_queue(queue_name); q_ptr-\u0026gt;put(message); } Vector\u0026lt;MemBlock\u0026gt; QueueStore::get(const String\u0026amp; queue_name, long offset, long size) { if (!flushed) flush_all_before_read(); auto q_ptr = find_queue(queue_name); if (q_ptr) return q_ptr-\u0026gt;get(offset, size); // return empty list when queue is not found return Vector\u0026lt;MemBlock\u0026gt;(); } ç„¶åæ˜¯æˆ‘ä»¬çš„ä¸»è¦æ•°æ®ç»“æ„ FilePageï¼š\n// File page header struct __attribute__((__packed__)) FilePageHeader { uint64_t offset = NEGATIVE_OFFSET; }; #define FILE_PAGE_HEADER_SIZE sizeof(FilePageHeader) #define FILE_PAGE_AVAILABLE_SIZE (FILE_PAGE_SIZE - FILE_PAGE_HEADER_SIZE) // File page struct __attribute__((__packed__)) FilePage { FilePageHeader header; char content[FILE_PAGE_AVAILABLE_SIZE]; }; åŒå†™ç¼“å†²æœ‰ä¸ªäº¤æ¢ä¸Šçš„åŒæ­¥ï¼Œæˆ‘ä»¬ä½¿ç”¨ mutex å»è¿›è¡Œè¿™ä¸ªåŒæ­¥ï¼š\n// buffer is full, switch to back { // spin wait until back buf is not in scheduled status while (back_buf_status-\u0026gt;load() == BACK_BUF_FLUSH_SCHEDULED) ; // try swap active and back buffer std::unique_lock\u0026lt;std::mutex\u0026gt; lock(*back_buf_mutex); std::swap(active_buf, back_buf); assert(back_buf_status-\u0026gt;load() == BACK_BUF_FREE); uint32_t exp = BACK_BUF_FREE; back_buf_status-\u0026gt;compare_exchange_strong(exp, BACK_BUF_FLUSH_SCHEDULED); } ä¸ºäº†ä½¿å¾— OS å……åˆ†çš„è·‘èµ·æ¥ï¼Œget é˜¶æ®µéœ€è¦é‡Šæ”¾æ‰æ‰€æœ‰æ— ç”¨çš„å†…å­˜ï¼Œç„¶è€Œ tcmalloc æ˜¯ä¸ä¼šä¸»åŠ¨é‡Šæ”¾çš„ï¼Œæ‰€ä»¥éœ€è¦å¼ºåˆ¶é‡Šæ”¾ï¼š\n// release free memory back to os MallocExtension::instance()-\u0026gt;ReleaseFreeMemory(); ç”±äºçº¿ä¸Šçš„å†™å…¥å¤ªè¿‡äºå‡åŒ€ï¼Œåˆ°äº†åˆ·ç›˜çš„æ—¶å€™å°±æ˜¯æ‰€æœ‰é¡µç¼“å­˜ä¸€èµ·åˆ·ç›˜ï¼Œè¿™ä¼šé€ æˆæ‰€æœ‰ put çº¿ç¨‹éƒ½é˜»å¡å¹¶ç­‰å¾…çš„çŠ¶å†µï¼Œä¸ºäº†ç¼“è§£è¿™ä¸ªæƒ…å†µï¼Œæˆ‘ä»¬è®©æŸäº›é˜Ÿåˆ—çš„ç¬¬ä¸€é¡µå¿«é€Ÿå†™å‡ºï¼š\n// first page will hold at most (queue_id / DATA_FILE_SPLITS) % 64 + 1 messages, this make write // more average. This leads to 64 timepoints of first flush. I call it flush fast. bool flush_fast = paged_message_indices_.size() == 1 \u0026amp;\u0026amp; paged_message_indices_.back().msg_size \u0026gt;= ((queue_id_ / DATA_FILE_SPLITS) \u0026amp; 0x3f) + 1; å…¶ä½™ä»£ç æ”¾åœ¨ https://code.aliyun.com/arkbriar/queue-race-2018-cpp ä¸­ã€‚\næœ€ç»ˆæˆç»© æœ€å¿«å†™å…¥æ—¶é—´å¤§çº¦ 690sï¼Œæœ€ç»ˆç¼“å­˜è½ç›˜ 20sï¼Œéšæœºæ ¡éªŒ 120sï¼Œé¡ºåºæ ¡éªŒ 140sï¼Œæ€»è®¡ 970s+ã€‚\næœŸé—´ä» 1.9 å¼€å§‹çš„æå‡å…¨åœ¨å‹ç¼© cpu å¼€é”€ï¼Œæ²¡æœ‰åŠ¨è¿‡è¯»å†™ç»“æ„ã€‚\nå·¥ç¨‹ä»·å€¼ä¸å¥å£®æ€§ åœ¨å­˜å‚¨è®¾è®¡è¿‡ç¨‹ä¸­ï¼Œæˆ‘ä»¬å……åˆ†è€ƒè™‘åˆ°äº†é•¿æ¶ˆæ¯çš„å­˜åœ¨ï¼›è™½ç„¶åœ¨æ¯”èµ›ä»£ç çš„å®ç°ä¸­ï¼Œæˆ‘ä»¬æœ€é•¿æ”¯æŒä¹Ÿå°±æ˜¯ 4k å¤šä¸€ç‚¹çš„é•¿åº¦ï¼Œä½†æ˜¯å´å¯ä»¥å¾ˆè½»æ˜“çš„æ”¯æŒè·¨é¡µæ¶ˆæ¯æ¥å»æ‰è¿™ä¸ªé™åˆ¶ã€‚\nåœ¨ put çš„è®¾è®¡è¿‡ç¨‹ä¸­ï¼Œæˆ‘ä»¬å……åˆ†åˆ©ç”¨äº† SSD çš„ç‰¹æ€§ï¼Œä½¿å¾—å³ä½¿æ˜¯éšæœºå†™ä¹Ÿèƒ½è¾¾åˆ°æœ€å¤§çš„ç£ç›˜ååã€‚é—æ†¾çš„æ˜¯ï¼Œæœ€ç»ˆæˆ‘ä»¬æ·±é™· cpu ç“¶é¢ˆä»æ¥æ²¡æœ‰è·‘å‡ºè¿‡æœ€å¤§ååã€‚\nè™½ç„¶è€ƒè™‘åˆ°åœºæ™¯ä¸‹æ²¡æœ‰è¾¹è¯»è¾¹å†™çš„æƒ…å†µï¼Œä½†æ˜¯é€šè¿‡åœ¨é˜Ÿåˆ—æ˜ å°„ä¸ŠåŠ è¯»å†™é”ï¼Œæˆ–è€…åœ¨æ›´ç»†ç²’åº¦çš„å†…å­˜é¡µä¸ŠåŠ é”ï¼Œå¹¶åœ¨è¯»æ—¶è€ƒè™‘å†…å­˜ä¸­æœªè½ç›˜çš„æ•°æ®ï¼Œåˆ™ç«‹åˆ»å¯ä»¥æ”¯æŒè¾¹è¯»è¾¹å†™ã€‚\næ€»ç»“ä¸æ„Ÿæƒ³ å¯¹å„ç§çŸ¥è¯†çš„ç†è§£å’Œè¿ç”¨æ˜¯è§£å†³å®é™…é—®é¢˜çš„å…³é”®ï¼Œåœ¨ä¸å„ä½é€‰æ‰‹çš„äº¤æµä¸ç«äº‰ä¸­ï¼Œæˆ‘ä»¬å­¦åˆ°äº†å¾ˆå¤šçŸ¥è¯†ï¼Œç›¸ä¿¡å¤§å®¶é€šè¿‡è¿™æ¬¡æ¯”èµ›ä¹Ÿèƒ½æ”¶è·å¾ˆå¤šã€‚\n","date":"2018-08-01T19:59:45+08:00","permalink":"https://blog.crazyark.me/p/awrace-2018/","title":"ç¬¬å››å±Šå¤©æ± ä¸­é—´ä»¶æ€§èƒ½æŒ‘æˆ˜èµ›æ„Ÿæƒ³"},{"content":"Epoll æ˜¯ Linux å¹³å°ä¸Šç‹¬æœ‰çš„ä¸€ç»„ç¼–ç¨‹æ¥å£ï¼Œç”¨äºç›‘å¬å¤šä¸ªæ–‡ä»¶æè¿°ç¬¦ä¸Šçš„ IO äº‹ä»¶ã€‚Epoll ç›¸å¯¹äº select/poll çš„ä¼˜åŠ¿åœ¨äºå³ä½¿ç›‘å¬äº†å¤§é‡çš„æ–‡ä»¶æè¿°ç¬¦ï¼Œæ€§èƒ½ä¹Ÿéå¸¸å¥½ã€‚Epoll API æ”¯æŒä¸¤ç§ç›‘å¬æ–¹å¼ï¼šedge-triggered (EPOLLET) å’Œ level_triggered (default)ã€‚\nEdge-triggered æ¨¡å¼ä¸‹ï¼Œåªæœ‰å½“æ–‡ä»¶æè¿°ç¬¦ä¸Šäº§ç”Ÿäº‹ä»¶æ—¶ï¼Œæ‰ä¼šè¢« epoll_wait è¿”å›ã€‚ä¾‹å¦‚ï¼Œç›‘å¬ä¸€ä¸ª socketï¼Œå‡å¦‚ç¬¬ä¸€æ¬¡ epoll_wait è¿”å›äº†è¯¥ sockï¼Œå¯è¯»å–ä¸º 2 å­—èŠ‚ï¼Œä½†æ˜¯åªè¯»å–äº† 1 å­—èŠ‚ã€‚é‚£ä¹ˆä¸‹ä¸€æ¬¡ epoll_wait å°†ä¸ä¼šè¿”å›è¯¥æ–‡ä»¶æè¿°ç¬¦äº†ã€‚æ¢å¥è¯è¯´ï¼Œç¼“å†²åŒºä¸­è¿˜æœ‰æ•°æ®å¯è¯»ä¸æ˜¯ä¸€ä¸ªäº‹ä»¶ã€‚\nLevel-triggered ä¸åŒï¼Œåªè¦è¯¥ sock è¿˜æ˜¯å¯è¯»çš„ï¼Œå°†æŒç»­è¿”å›ã€‚\nåœ¨ä½¿ç”¨ ET æ¨¡å¼æ—¶ï¼Œå¿…é¡»ä½¿ç”¨éé˜»å¡æ–‡ä»¶æè¿°ç¬¦ï¼Œé˜²æ­¢é˜»å¡è¯»/é˜»å¡å†™å°†å¤„ç†å¤šä¸ªæ–‡ä»¶æè¿°ç¬¦çš„ä»»åŠ¡é¥¿æ­»ã€‚æœ€å¥½ä»¥ä»¥ä¸‹æ¨¡å¼è°ƒç”¨ ET æ¨¡å¼çš„ epoll_wait æ¥å£ï¼š\nä½¿ç”¨éé˜»å¡çš„æ–‡ä»¶æè¿°ç¬¦ åªæœ‰å½“ read/write è¿”å› EAGAIN æ—¶æŒ‚èµ·å¹¶ç­‰å¾…ï¼›å½“ read/write è¿”å›çš„æ•°æ®é•¿åº¦å°äºè¯·æ±‚çš„æ•°æ®é•¿åº¦æ—¶ï¼Œå°±å¯ä»¥ç¡®å®šç¼“å†²ä¸­å·²ç»æ²¡æœ‰æ•°æ®äº†ï¼Œä¹Ÿå°±å¯ä»¥è®¤ä¸ºäº‹ä»¶å·²ç»å®Œæˆäº†ã€‚ Epoll API Linux æä¾›äº†ä»¥ä¸‹å‡ ä¸ªå‡½æ•°ï¼Œç”¨äºåˆ›å»ºã€ç®¡ç†å’Œä½¿ç”¨ epoll å®ä¾‹ï¼š\nint epoll_create(int size); int epoll_create1(int flags); int epoll_ctl(int epfd, int op, int fd, struct epoll_event *event); int epoll_wait(int epfd, struct epoll_event *events, int maxevents, int timeout); int epoll_pwait(int epfd, struct epoll_event *events, int maxevents, int timeout, const sigset_t *sigmask); epoll_create/epoll_create1 epoll_create å°†åˆ›å»ºä¸€ä¸ª epoll å®ä¾‹ï¼Œå¹¶ä¸”è¿”å›ä¸€ä¸ªä»£è¡¨è¯¥å®ä¾‹çš„æ–‡ä»¶æè¿°ç¬¦ã€‚åœ¨ epoll_create1 ä¸­ï¼Œepoll çš„å¤§å°é™åˆ¶è¢«å–æ¶ˆäº†ã€‚flags å¯ä»¥ä¸º EPOLL_CLOEXECï¼Œå³ä¸ºæ–°çš„æ–‡ä»¶æè¿°ç¬¦è®¾ç½® close-on-exec (FD_CLOEXEC)ï¼Œè¿™ä¸ªæ ‡å¿—åœ¨æ–‡ä»¶æè¿°ç¬¦ä¸Šè¡¨ç¤ºå½“ execve ç³»ç»Ÿè°ƒç”¨ä¹‹åï¼Œæ–°çº¿ç¨‹çš„æ–‡ä»¶æè¿°ç¬¦æ˜¯å¦è¦è¢«å…³é—­ã€‚\nepoll_ctl epoll_ctl ç”¨äºæ§åˆ¶ epoll å®ä¾‹ä¸Šçš„ç›‘å¬çš„æ–‡ä»¶æè¿°ç¬¦ï¼Œå…¶ä¸­ epfd å°±æ˜¯ epoll æ–‡ä»¶æè¿°ç¬¦ï¼Œop æ˜¯æŒ‡å¯ä»¥åšçš„æ“ä½œ (operation)ï¼Œä¸€å…±æœ‰ä¸‰ç§ï¼š\nEPOLL_CTL_ADD EPOLL_CTL_MOD EPOLL_CTL_DEL é¡¾åæ€ä¹‰ï¼Œæ·»åŠ ã€ä¿®æ”¹å’Œåˆ é™¤ã€‚\nåé¢çš„å°±æ˜¯å¯¹åº”çš„æ–‡ä»¶æè¿°ç¬¦å’Œ fdï¼Œä»¥åŠè®¾ç½®å¥½çš„æƒ³è¦ç›‘å¬çš„äº‹ä»¶é›†åˆï¼Œå­˜æ”¾åœ¨ struct epoll_event ä¸­ï¼š\ntypedef union epoll_data { void *ptr; int fd; uint32_t u32; uint64_t u64; } epoll_data_t; struct epoll_event { uint32_t events; /* Epoll events */ epoll_data_t data; /* User data variable */ }; struct epoll_event ä¸­çš„ events æ˜¯ä¸ªä½æ•°ç»„ï¼Œè¡¨æ˜å½“å‰ç›‘å¬çš„æ—¶é—´ï¼Œåˆ—ä¸¾å‡ ä¸ªæ¯”è¾ƒé‡è¦çš„ï¼š\nEPOLLIN/EPOLLOUTï¼Œæ–‡ä»¶å¯è¯»/å†™ EPOLLRDHUPï¼Œå…³é—­è¿æ¥æˆ–è€…å†™å…¥åŠè¿æ¥ EPOLLERRï¼Œé»˜è®¤å‚æ•°ï¼Œæ–‡ä»¶æè¿°ç¬¦ä¸Šå‘ç”Ÿé”™è¯¯ EPOLLHUPï¼Œé»˜è®¤å‚æ•°ï¼Œæ–‡ä»¶è¢«æŒ‚æ–­ï¼Œåœ¨ socket/pipe ä¸Šä»£è¡¨æœ¬ç«¯å…³é—­è¿æ¥ EPOLLETï¼Œå¼€å¯ edge-triggeredï¼Œé»˜è®¤æ˜¯ level-triggered EPOLLONESHOTï¼Œä¸€æ¬¡è§¦å‘åè‡ªåŠ¨ç§»é™¤ç›‘å¬ EPOLLWAKEUPï¼Œå¦‚æœEPOLLONESHOTå’ŒEPOLLETæ¸…é™¤äº†ï¼Œå¹¶ä¸”è¿›ç¨‹æ‹¥æœ‰CAP_BLOCK_SUSPENDæƒé™ï¼Œé‚£ä¹ˆè¿™ä¸ªæ ‡å¿—èƒ½å¤Ÿä¿è¯äº‹ä»¶åœ¨æŒ‚èµ·æˆ–è€…å¤„ç†çš„æ—¶å€™ï¼Œç³»ç»Ÿä¸ä¼šæŒ‚èµ·æˆ–ä¼‘çœ  epoll_wait/epoll_pwait epoll_wait é˜»å¡å¹¶ç­‰å¾…æ–‡ä»¶æè¿°ä¸Šçš„äº‹ä»¶ï¼Œéœ€è¦ä¿è¯ events æ•°ç»„çš„å¤§å°è¦æ¯” maxevents å¤§ã€‚epoll_wait å°†é˜»å¡ç›´åˆ°ï¼š\nä¸€ä¸ªæ–‡ä»¶æè¿°ç¬¦äº§ç”Ÿäº‹ä»¶ è¢«ä¿¡å·æ‰“æ–­ è¶…æ—¶ (timeoutï¼‰ å¹¶è¿”å›å½“å‰äº‹ä»¶çš„æ•°é‡ã€‚\nepoll_pwait å¤šè®¾ç½®ä¸€ä¸ª sigmaskï¼Œä»£è¡¨ä¸æƒ³è¢«è¿™äº›ä¿¡å·æ‰“æ–­ï¼Œå…¶ä½™çš„ç›¸å½“äº epoll_waitã€‚\næ€§èƒ½æµ‹è¯• å¯¹ poll/selelct å’Œ epoll åœ¨ç›‘å¬ä¸åŒæ•°é‡æ–‡ä»¶æè¿°ç¬¦æ—¶çš„ç³»ç»Ÿè°ƒç”¨æ¶ˆè€—å¯¹æ¯”ï¼Œå‚è€ƒè‡ªå‚è€ƒæ–‡çŒ®è¡¨ä¸­çš„ç¬¬ä¸€ä¸ªç½‘ç«™ã€‚\n# operations | poll | select | epoll 10 | 0.61 | 0.73 | 0.41 100 | 2.9 | 3.0 | 0.42 1000 | 35 | 35 | 0.53 10000 | 990 | 930 | 0.66 å‚è€ƒæ–‡çŒ® [1] https://jvns.ca/blog/2017/06/03/async-io-on-linux--select--poll--and-epoll/\n[2] Linux Programmer\u0026rsquo;s Manual: man epoll/epoll_create/epoll_ctl/epoll_wait\nåŸºäº epoll çš„ç®€æ˜“æœåŠ¡å™¨ ä»¥ä¸‹ä½¿ç”¨ C è¯­è¨€å®ç°äº†ä¸€ä¸ªç®€å•çš„æœåŠ¡å™¨ï¼Œæ”¯æŒåŒæ—¶æœ€å¤š 100 ä¸ªè¿æ¥ï¼Œå¯¹æ¯ä¸ªæ–°å»ºçš„è¿æ¥ã€‚å°†å®ƒåŠ å…¥ epoll é˜Ÿåˆ—ä¸­ã€‚å½“ IO äº‹ä»¶åˆ°è¾¾æ—¶ï¼Œå¤„ç†å¯¹åº”çš„å®¢æˆ·ç«¯çš„ IO äº‹ä»¶ã€‚\n#include \u0026lt;stdio.h\u0026gt; #include \u0026lt;stdlib.h\u0026gt; #include \u0026lt;string.h\u0026gt; #include \u0026lt;unistd.h\u0026gt; #include \u0026lt;fcntl.h\u0026gt; #include \u0026lt;errno.h\u0026gt; #include \u0026lt;sys/types.h\u0026gt; #include \u0026lt;sys/socket.h\u0026gt; #include \u0026lt;arpa/inet.h\u0026gt; #include \u0026lt;sys/epoll.h\u0026gt; #define MAX_EVENTS 10 #define LISTEN_PORT 1234 #define BUF_LEN 512 #define MAX_CONN 100 struct epoll_event ev, events[MAX_EVENTS]; int listen_sock, conn_sock, nfds, epollfd; struct sockaddr_in server; #define log(...) printf(__VA_ARGS__) void response_to_conn(int conn_sock) { char buf[BUF_LEN + 1]; int read_len = 0; while ((read_len = read(conn_sock, buf, BUF_LEN)) \u0026gt; 0) { buf[read_len] = \u0026#39;\\0\u0026#39;; int cursor = 0; while (cursor \u0026lt; read_len) { // writing to a pipe or socket whose reading end is closed // will lead to a SIGPIPE int len = write(conn_sock, buf + cursor, read_len - cursor); if (len \u0026lt; 0) { perror(\u0026#34;write\u0026#34;); return; } cursor += len; } // there are no data so we do not have to do another read if (read_len \u0026lt; BUF_LEN) { break; } } // must make sure that the next read will block this non-blocking // socket, then we think the event is fully consumed. if (read_len \u0026lt; 0 \u0026amp;\u0026amp; errno == EAGAIN) { return; } // end of file if (read_len == 0) { return; } } /* Code to set up listening socket, \u0026#39;listen_sock\u0026#39; */ void listen_and_bind() { if ((listen_sock = socket(AF_INET, SOCK_STREAM, 0)) == -1) { perror(\u0026#34;socket\u0026#34;); exit(EXIT_FAILURE); } int option = 1; setsockopt(listen_sock, SOL_SOCKET, SO_REUSEADDR, \u0026amp;option, sizeof(option)); server.sin_family = AF_INET; server.sin_addr.s_addr = INADDR_ANY; server.sin_port = htons(LISTEN_PORT); if (bind(listen_sock, (struct sockaddr *)\u0026amp;server, sizeof(server)) == -1) { perror(\u0026#34;bind\u0026#34;); exit(EXIT_FAILURE); } listen(listen_sock, MAX_CONN); } void create_epoll() { epollfd = epoll_create1(0); if (epollfd == -1) { perror(\u0026#34;epoll_create1\u0026#34;); exit(EXIT_FAILURE); } ev.events = EPOLLIN; ev.data.fd = listen_sock; if (epoll_ctl(epollfd, EPOLL_CTL_ADD, listen_sock, \u0026amp;ev) == -1) { perror(\u0026#34;epoll_ctl: listen_sock\u0026#34;); exit(EXIT_FAILURE); } } void set_fd_nonblocking(int fd) { int flags = fcntl(fd, F_GETFL, 0); if (flags == -1) { perror(\u0026#34;getfl\u0026#34;); return; } if (fcntl(fd, F_SETFL, flags | O_NONBLOCK) \u0026lt; 0) { perror(\u0026#34;setfl\u0026#34;); return; } } void epoll_loop() { for (;;) { int nfds = epoll_wait(epollfd, events, MAX_EVENTS, -1); if (nfds == -1) { perror(\u0026#34;epoll_wait\u0026#34;); exit(EXIT_FAILURE); } log(\u0026#34;get %d events from epoll_wait!\\n\u0026#34;, nfds); for (int n = 0; n \u0026lt; nfds; ++ n) { if (events[n].data.fd == listen_sock) { struct sockaddr_in local; socklen_t addrlen; conn_sock = accept(listen_sock, (struct sockaddr *) \u0026amp;local, \u0026amp;addrlen); if (conn_sock == -1) { perror(\u0026#34;accept\u0026#34;); exit(EXIT_FAILURE); } log(\u0026#34;accept a new connection!\\n\u0026#34;); // set non-blocking set_fd_nonblocking(conn_sock); ev.events = EPOLLIN | EPOLLET | EPOLLRDHUP; ev.data.fd = conn_sock; if (epoll_ctl(epollfd, EPOLL_CTL_ADD, conn_sock, \u0026amp;ev) == -1) { perror(\u0026#34;epoll_ctl: conn_sock\u0026#34;); exit(EXIT_FAILURE); } } else { if (events[n].events \u0026amp; (EPOLLRDHUP | EPOLLERR)) { log(\u0026#34;detect a closed/broken connection!\\n\u0026#34;); epoll_ctl(epollfd, EPOLL_CTL_DEL, events[n].data.fd, NULL); close(events[n].data.fd); } else response_to_conn(events[n].data.fd); } } } } int main(int argc, char **argv) { log(\u0026#34;listenning on port 1234!\\n\u0026#34;); listen_and_bind(); log(\u0026#34;creating epoll!\\n\u0026#34;); create_epoll(); log(\u0026#34;starting loop on epoll!\\n\u0026#34;); epoll_loop(); return 0; } ","date":"2018-04-16T19:51:21+08:00","permalink":"https://blog.crazyark.me/p/epoll/","title":"Linux IO å¤šè·¯å¤ç”¨ â€”â€” Epoll"},{"content":"å¸ƒéš†è¿‡æ»¤å™¨ (Bloom Filter) æ˜¯ä¸€ä¸ªç©ºé—´é«˜æ•ˆçš„æ¦‚ç‡æ•°æ®ç»“æ„ï¼Œå®ƒèƒ½å¤Ÿç”¨æ¥æµ‹è¯•æ˜¯å¦ä¸€ä¸ªå…ƒç´ åœ¨ä¸€ä¸ªé›†åˆä¸­ã€‚å¸ƒéš†è¿‡æ»¤å™¨å­˜åœ¨ç€ false positive (è¿”å›å­˜åœ¨ï¼Œå…¶å®ä¸å­˜åœ¨ï¼‰ï¼Œä½†æ˜¯ä¸å­˜åœ¨ false negative (è¿”å›ä¸å­˜åœ¨ï¼Œå…¶å®å­˜åœ¨)ã€‚é›†åˆä¸­çš„å…ƒç´ è¶Šå¤šï¼Œfalse positive çš„æ¦‚ç‡å°±è¶Šé«˜ã€‚\nç»“æ„æè¿° å¸ƒéš†è¿‡æ»¤å™¨çš„ç»“æ„éå¸¸ç®€å•ï¼Œå³ä¸€ä¸ªé•¿åº¦ä¸º m çš„æ¯”ç‰¹æ•°ç»„ï¼Œåˆå§‹åŒ–éƒ½ä¸º0ã€‚ç„¶åï¼Œå¸ƒéš†è¿‡æ»¤å™¨éœ€è¦æœ‰ k ä¸ªä¸åŒçš„å“ˆå¸Œå‡½æ•°ï¼Œæ¯ä¸€ä¸ªéƒ½èƒ½å°†å…ƒç´ æ˜ å°„åˆ° [0, m) ä¸­çš„ä¸€ä¸ªæ•°å­—ï¼Œä¹Ÿå°±æ˜¯æ•°ç»„ä¸Šçš„ä¸€ä¸ªä½ç½®ï¼Œå¹¶å‘ˆç°å‡åŒ€åˆ†å¸ƒã€‚\né€šå¸¸ï¼Œk æ˜¯ä¸€ä¸ªè¿œå°äº m çš„å¸¸æ•°ï¼Œä¸å°†è¦è¢«åŠ å…¥çš„å…ƒç´ æˆæ¯”ä¾‹ã€‚ç²¾ç¡®çš„ k å’Œ m çš„å–å€¼å–å†³äºæœŸæœ›çš„ false positive ç‡ã€‚\nä¸‹å›¾æ˜¯ä¸€ä¸ªå¸ƒéš†è¿‡æ»¤å™¨ï¼š\né‚£ä¹ˆä»‹ç»ä¸‹å¸ƒéš†è¿‡æ»¤å™¨ä¸Šçš„ä¸¤ä¸ªæ“ä½œï¼š\næ·»åŠ ä¸€ä¸ªå…ƒç´ ï¼šå¯¹æ¯ä¸€ä¸ªå“ˆå¸Œå‡½æ•°ï¼Œéƒ½è®¡ç®—å‡ºå¯¹åº”çš„æ•°ç»„ä¸Šçš„ä½ç½®ï¼Œå¹¶å°†å…¶ç½®ä¸º 1 æŸ¥è¯¢ä¸€ä¸ªå…ƒç´ ï¼šå¯¹æ¯ä¸€ä¸ªå“ˆå¸Œå‡½æ•°ï¼Œè®¡ç®—å‡ºå¯¹åº”çš„æ•°ç»„ä¸Šçš„ä½ç½®ï¼Œå¦‚æœéƒ½æ˜¯ 1ï¼Œåˆ™è¿”å›å…ƒç´ å­˜åœ¨ï¼Œå¦åˆ™å…ƒç´ ä¸å­˜åœ¨ æ˜¾ç„¶ï¼Œå¦‚æœä¸€ä¸ªå…ƒç´ æ›¾ç»è¢«æ·»åŠ è¿‡ï¼Œåœ¨æŸ¥è¯¢çš„æ—¶å€™ä¸€å®šå­˜åœ¨ï¼Œä½†æ˜¯æŸ¥è¯¢è¿”å›å­˜åœ¨å´ä¸ä¸€å®šè¡¨æ˜å…ƒç´ è¢«æ·»åŠ è¿‡ã€‚\nåœ¨è¿™ç§è®¾è®¡ä¸­ï¼Œç”±äºä¸å…è®¸ false negativeï¼Œæ‰€ä»¥ä¸å¯èƒ½è¿›è¡Œå…ƒç´ åˆ é™¤ã€‚å¦‚æœå…è®¸ false negativeï¼Œå¯ä»¥é€šè¿‡è®¡æ•°æ•°ç»„æ¥å¤„ç†å…ƒç´ åˆ é™¤ã€‚å¦‚æœæ˜¯ä¸€æ¬¡æ€§çš„åˆ é™¤ï¼Œå¯ä»¥é€šè¿‡æ–°å»ºä¸€ä¸ªè®°å½•è¢«åˆ é™¤å…ƒç´ çš„å¸ƒéš†è¿‡æ»¤å™¨æ¥å®ç°ï¼Œä½†æ˜¯è¿™ä¸ªè¿‡æ»¤å™¨çš„ false positive å°±ä¼šå˜æˆç¬¬ä¸€ä¸ªè¿‡æ»¤èµ·çš„ false negativeã€‚\nç©ºé—´å’Œæ—¶é—´ å¸ƒéš†è¿‡æ»¤å™¨çš„ç©ºé—´æ•ˆç‡éå¸¸é«˜ï¼Œæ¯”å…¶ä»–ä¸€äº›ç”¨äºé›†åˆçš„æ•°æ®ç»“æ„é«˜æ•ˆçš„å¤šï¼Œä¾‹å¦‚è‡ªå¹³è¡¡äºŒå‰æ ‘ã€å­—å…¸æ ‘ã€å“ˆå¸Œè¡¨ç­‰ã€‚æœŸæœ› 1% ä»¥å†…è¯¯æŠ¥ç‡çš„å¸ƒéš†è¿‡æ»¤å™¨ï¼Œåœ¨é‡‡ç”¨æœ€ä¼˜ k çš„æƒ…å†µä¸‹ï¼Œæ¯ä¸ªå…ƒç´ åªéœ€è¦ 9.6 ä¸ªæ¯”ç‰¹å­˜å‚¨ï¼Œå¹¶ä¸”ä¸å…ƒç´ æœ¬èº«æ— å…³ã€‚ç”šè‡³ï¼Œæˆ‘ä»¬åªéœ€è¦ä¸ºæ¯ä¸ªå…ƒç´ æ·»åŠ å¤§çº¦ 4.8 ä¸ªæ¯”ç‰¹ï¼Œå°±å¯ä»¥æŠŠè¯¯æŠ¥ç‡é™ä½åˆ° 0.1%ã€‚ä½†æ˜¯ï¼Œå½“é›†åˆä¸­å¯èƒ½çš„å…ƒç´ éå¸¸å°‘æ—¶ï¼Œå¸ƒéš†è¿‡æ»¤å™¨æ˜¾ç„¶è¦æ¯”æ¯”ç‰¹æ•°ç»„å·®ã€‚\nåœ¨æ’å…¥å’ŒæŸ¥è¯¢æ—¶ï¼Œå¸ƒéš†è¿‡æ»¤å™¨çš„æ—¶é—´å¤æ‚åº¦éƒ½å–å†³äº k ä¸ªå“ˆå¸Œå‡½æ•°ï¼Œé€šå¸¸å“ˆå¸Œå‡½æ•°æ•ˆç‡è¾ƒé«˜ï¼Œæˆ‘ä»¬è®¤ä¸ºæ—¶é—´å¤æ‚åº¦å°±æ˜¯ O(k)ã€‚\nè¯¯æŠ¥ç‡å’Œæœ€ä¼˜é€‰æ‹© æˆ‘ä»¬æ¥æ¨å¯¼ä¸€ä¸‹è¯¯æŠ¥çš„æ¦‚ç‡ï¼Œå½“ä¸€ä¸ªå…ƒç´ æ’å…¥æ—¶ï¼Œæ•°ç»„ä¸­ä¸€ä¸ªä½ç½®è¿˜æ²¡è¢«è®¾ç½®ä¸º 1 çš„æ¦‚ç‡æ˜¾ç„¶ä¸ºï¼š$(1 - \\frac{1}{m})^{k}$ï¼Œé‚£ä¹ˆå½“å·²ç»æ’å…¥äº† n ä¸ªå…ƒç´ ä¹‹åï¼Œè¿™ä¸ªä½ç½®ä»ç„¶æ˜¯ 0 çš„æ¦‚ç‡ä¸º $(1 - \\frac{1}{m})^{kn}$ã€‚\næ‰€ä»¥å½“æŸ¥è¯¢æ—¶ï¼Œæ¯ä¸ªå“ˆå¸Œå‡½æ•°çš„ä½ç½®éƒ½ä¸º 1 çš„æ¦‚ç‡ä¸º: $(1 - \\left[1 - \\frac{1}{m}\\right]^{kn})^k \\approx (1 - e^{-kn/m})^k$ã€‚\nè¿™ä¸ªæ¦‚ç‡çš„æ¨å¯¼å¹¶ä¸å®Œå…¨æ­£ç¡®ï¼Œå› ä¸ºå®ƒå‡è®¾æ¯ä¸ªæ¯”ç‰¹è¢«è®¾ç½®çš„äº‹ä»¶æ˜¯ç›¸äº’ç‹¬ç«‹çš„ã€‚äº‹å®ä¸Šå½“å»é™¤å‡è®¾æ—¶ï¼Œä»ç„¶å¯ä»¥åˆ†æå‡ºç›¸åŒçš„è¿‘ä¼¼ç»“æœï¼Œæœ‰å…´è¶£çš„åŒå­¦å¯ä»¥é˜…è¯»ã€‚é‚£ä¹ˆæˆ‘ä»¬æœ‰\nè¯¯æŠ¥ç‡éšç€ m çš„å¢å¤§è€Œå‡å°ï¼Œå¹¶éšç€ n çš„å¢å¤§è€Œå¢å¤§ é‚£ä¹ˆæˆ‘ä»¬å°†æœ‰æœ€ä¼˜çš„å“ˆå¸Œå‡½æ•°æ•°ä¸º: $k = \\dfrac{m}{n}\\ln 2$ æ¨å¯¼è¿‡ç¨‹å¦‚ä¸‹æ‰€ç¤º:\n$p = (1 - e^{-kn/m})^k$\n$\\ln p = k\\ln(1 - e^{-kn/m}) = -\\dfrac{m}{n}\\ln(e^{-kn/m}) \\ln(1 - e^{-kn/m})$\nä»¤ $g = e^{-kn/m}$ï¼Œå³æœ‰ $\\ln p = -\\dfrac{m}{n}\\ln(g) \\ln(1 - g)$ï¼Œç”±å¯¹ç§°æ³•å¯çŸ¥ $g = \\dfrac{1}{2}$ æ—¶ä¸Šå¼æœ€å°ã€‚\næ‰€ä»¥æœ‰ $g = e^{-kn/m} = \\dfrac{1}{2}$, $k = \\dfrac{m}{n}\\ln 2$ã€‚\nä¼°è®¡é›†åˆå¤§å° Swamidass \u0026amp; Baldi (2007) ç»™å‡ºäº†å¸ƒéš†è¿‡æ»¤å™¨ä¸­é›†åˆçš„å¤§æ¦‚å¤§å°ï¼š\n$$n^* = -\\dfrac{m}{k}\\ln\\left[1 - \\dfrac{X}{m}\\right]$$ï¼Œ\nå…¶ä¸­ X æ˜¯æ¯”ç‰¹æ•°ç»„ä¸­ 1 çš„ä¸ªæ•°ã€‚\nå¸ƒéš†è¿‡æ»¤å™¨çš„åº”ç”¨ Google Bigtableã€Apache HBaseã€Apache Cassandra å’Œ Postgresql ä½¿ç”¨å¸ƒéš†è¿‡æ»¤å™¨æ¥å‡å°‘ä¸å¿…è¦çš„ç£ç›˜æŸ¥è¯¢ã€‚ Google Chrome ä½¿ç”¨å¸ƒéš†è¿‡æ»¤å™¨æ¥æ£€æµ‹å±é™©çš„ URLã€‚ \u0026hellip; å‚è€ƒæ–‡çŒ® [1] https://en.wikipedia.org/wiki/Bloom_filter#Approximating_the_number_of_items_in_a_Bloom_filter\n","date":"2018-04-16T13:02:27+08:00","permalink":"https://blog.crazyark.me/p/bloom-filter/","title":"å¸ƒéš†è¿‡æ»¤å™¨ (Bloom Filter)"},{"content":"Emmï¼Œè¿™ç¯‡å…¶å®åœ¨ 2017 å¹´ 9 æœˆå°±æ‰“ç®—å†™äº†ï¼Œåˆ°ç°åœ¨æ‰å¡«ä¸Šï¼Œå†ä¸å¡«åˆè¦å¿˜è®°äº†\u0026hellip;\nå­—ç¬¦ä¸²ç•Œçš„æ˜æ˜Ÿå›æ–‡ä¸²ï¼Œæ€»æ˜¯æœ‰å„ç§ç¨€å¥‡å¤æ€ªéš¾æçš„é¢˜ç›®ï¼Œæ¯”å¦‚è¯´è¿™é“æœ€é•¿å›æ–‡å­ä¸² (Longest Palindromic Substring)ï¼Œæ˜¾è€Œæ˜“è§çš„ç®—æ³•å¤æ‚åº¦æ˜¯ $O(n^2)$ï¼Œè€Œè¿™ä¸ª Manacher\u0026rsquo;s Algorithm åˆ™å¯ä»¥åœ¨ $O(n)$ çš„æ—¶é—´ç»™å‡ºç­”æ¡ˆã€‚\næˆ‘ä»¬ç”¨ä¸€ä¸ªç®€å•ä½†æ˜¯ä¸é”™çš„ä¾‹å­æ¥è§£é‡Šè¿™ä¸ªç®—æ³•: \u0026ldquo;abababa\u0026rdquo;ï¼Œå®ƒçš„æœ€é•¿å›æ–‡å­ä¸²å°±æ˜¯è‡ªå·±ã€‚\nç®€å•çš„ç®—æ³• ç®€å•çš„ç®—æ³•å°±æ˜¯æšä¸¾å›æ–‡æ ¸ï¼Œå¯¹äºä¸€ä¸ªé•¿åº¦ä¸º n çš„å­—ç¬¦ä¸²ï¼Œä¸€å…±æœ‰ 2n + 1 ä¸ªå›æ–‡æ ¸ï¼Œæ¯ä¸ªå›æ–‡æ ¸è®¡ç®—å›æ–‡é•¿åº¦çš„å¤æ‚åº¦ä¸º $O(n)$ï¼Œæ‰€ä»¥æ€»è®¡ä¸º $O(n^2)$ã€‚\nManacher\u0026rsquo;s Algorithm Manacher\u0026rsquo;s Algorithm åˆ©ç”¨äº†ä¹‹å‰å·²ç»è®¡ç®—è¿‡çš„æœ€å¤§å›æ–‡é•¿åº¦ï¼Œæ¥åŠ é€Ÿåé¢çš„è®¡ç®—ã€‚\né¦–å…ˆä¾æ—§æ˜¯æ ‡æ˜æ‰€æœ‰å›æ–‡æ ¸ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š\nå¯¹äºæ¯ä¸ªå›æ–‡æ ¸ï¼Œæˆ‘ä»¬æ ‡å·ä» 0 - 2nï¼Œä¸€å…± 2n + 1 ä¸ªã€‚å¶æ•°å·çš„ä¸ºå¶æ•°é•¿åº¦çš„å›æ–‡çš„æ ¸ï¼Œå¥‡æ•°å·çš„ä¸ºå¥‡æ•°é•¿åº¦çš„å›æ–‡çš„æ ¸ã€‚æˆ‘ä»¬ä½¿ç”¨ä¸€ä¸ªæ•°ç»„ LPS æ¥è®°å½•å·²ç»çŸ¥é“çš„æœ€é•¿å›æ–‡é•¿åº¦ã€‚\næ¯«æ— ç–‘é—®ï¼ŒLPS[0] ä¸€å®šæ˜¯ 0ï¼ŒLPS[1] ä¸€å®šæ˜¯ 1ã€‚å‡è®¾æˆ‘ä»¬ä»å·¦å¾€å³è®¡ç®— LPSï¼Œå½“å‰ä¸ºæ ‡çº¢çš„ 7 å·ï¼ŒLPS[7] = 7ã€‚\nè¿™é‡Œæœ‰ä¸€ä¸ªå¾ˆé‡è¦çš„äº‹æƒ…ï¼Œé‚£å°±æ˜¯ 7 æ˜¯ i \u0026lt;= 7 ä¸­ï¼Œi + LPS[i] æœ€å¤§çš„ï¼Œä¹Ÿå°±æ˜¯å³è¾¹ç•Œæœ€è¿œçš„é‚£ä¸ªã€‚i + LPS[i] ä¸€å®šæ˜¯å¶æ•°ã€‚\nä¸ºä»€ä¹ˆä¸€å®šè¦å®ƒå‘¢ï¼Œæˆ‘ä»¬ä¹‹åä¼šè¯¦ç»†è®²ã€‚\næˆ‘ä»¬ç°åœ¨è¦è®¡ç®— LPS[8] äº†ï¼Œå› ä¸º 8 å…³äº 7 å¯¹ç§°ä¸º 6ï¼Œè€Œ 6 ä¸Šçš„æœ€å¤§å›æ–‡ä¸²ä¸º 0ï¼Œæ‰€ä»¥å…¶å®åœ¨å¯è§èŒƒå›´ [i - LPS[i], i + LPS[i]] = [0, 14] å†…ï¼Œ6 ä¸Šçš„å›æ–‡ä¸² [6 - LPS[6], 6 + LPS[6]] = [6, 6] åœ¨ 8 ä¸Šçš„å¯¹ç§°ä¸º [8, 8]ï¼Œå®ƒæ•´ä¸ªåœ¨ (0, 14) å†…ï¼Œä¸æ¥è§¦è¾¹ç•Œã€‚\nç”±å›æ–‡ä¸²å¯¹å›æ–‡æ ¸çš„å¯¹ç§°æ€§ï¼ŒLPS[8] = 0ã€‚\nä½†æ˜¯å¦‚æœå¯¹ç§°åˆ°çš„å›æ–‡ä¸²æ¥è§¦è¾¹ç•Œæˆ–è€…è¶…å‡ºè¾¹ç•Œï¼Ÿæˆ‘ä»¬å·²çŸ¥çš„é•¿åº¦åªèƒ½æ˜¯ min(i + LPS[i] - cur, LPS[2 * i - cur]), ä¹Ÿå°±æ˜¯å¯¹ç§°é‚£è¾¹çš„ LPS å’Œå³è¾¹å‰©ä½™èŒƒå›´è¿™ä¸¤ä¸ªçš„æœ€å°å€¼ã€‚é‚£ä¹ˆæˆ‘ä»¬å°±é‚»è¿‘äº†ä¸€äº›æœªçŸ¥çš„å­—ç¬¦ï¼Œæ­¤æ—¶å°±åº”è¯¥ å‘å³æ‰«ææœªçŸ¥çš„å­—ç¬¦ï¼Œå¹¶é€ä¸ªå’Œå·¦è¾¹åŒ¹é…ï¼Œæ¥å‡†ç¡®å¾—åˆ° LPS[cur]ã€‚æ­¤æ—¶å³è¾¹ç•Œæ‰©å±•äº†ï¼Œæˆ‘ä»¬å¯ä»¥æ›´æ–° i åˆ° curã€‚\nä¸Šè¿°æ–‡å­—å¯èƒ½æœ‰ç‚¹ç»•ï¼Œä½†æ˜¯ä¹Ÿæœ‰ç°æˆçš„ä¾‹å­ï¼Œæ¯”å¦‚ i = 5, cur = 7 æ—¶ï¼Œå¯¹ç§°è¿‡å»æ˜¯ 3ï¼ŒLPS[3] = 3 = i + LPS[i] - curï¼Œä¹Ÿå°±æ˜¯æ¥ç€å³è¾¹ç•Œäº†ï¼Œæ‰€ä»¥å°±å‘å³æ‰«æï¼ŒæŠŠå³è¾¹ç•Œæ‰©å±•åˆ° 14ï¼ŒåŒæ—¶æ›´æ–° i = 7ã€‚\né‡å¤ä¸Šè¿°è¿‡ç¨‹ï¼Œå°±å¯ä»¥è·å¾—æ‰€æœ‰ LPS[i]ï¼Œè¿”å›å…¶ä¸­æœ€å¤§çš„å³å¯ã€‚\nå¤æ‚åº¦ LPS çš„è®¡ç®—ï¼Œåˆ†ä¸ºä¸¤ç§æƒ…å†µï¼Œä¸€æ˜¯ç›´æ¥è®¡ç®—ï¼Œè€Œæ˜¯è®¡ç®—åˆå§‹å€¼åæ‰©å±•å³è¾¹ç•Œã€‚\nå³è¾¹ç•Œæœ€å¤šæ‰©å±•åˆ° 2 * nï¼Œæ‰€ä»¥æ˜¯ O(n) çš„ï¼Œè€Œèµ‹å€¼ä¸€å…± 2 * n + 1 æ¬¡ï¼Œæ‰€ä»¥ä¹Ÿæ˜¯ O(n) çš„ã€‚\næ‰€ä»¥æ€»è®¡æ—¶é—´å¤æ‚åº¦ä¸º O(n)ã€‚\nCpp class Solution { public: string longestPalindrome(string s) { if (s.empty()) return \u0026#34;\u0026#34;; int n = s.size(); int res = 1, resi = 1; int N = n * 2 + 1; vector\u0026lt;int\u0026gt; lps(N); lps[1] = 1; int c = 1; for (int i = 2; i \u0026lt; N; ++i) { int li = 2 * c - i, r = c + lps[c]; int to_r = r - i; // set initial lps[i] lps[i] = min(lps[li], to_r); /* if (lps[li] \u0026gt;= to_r) { */ // expand if we can // i + lps[i] \u0026lt; N - 1 \u0026amp;\u0026amp; i - lps[i] \u0026gt; 0 so that there are spaces for expand while ( i + lps[i] \u0026lt; N - 1 \u0026amp;\u0026amp; i - lps[i] \u0026gt; 0 \u0026amp;\u0026amp; ((i + lps[i] + 1) % 2 == 0 || s[(i - lps[i] - 1) / 2] == s[(i + lps[i] + 1) / 2])) { lps[i]++; } if (i + lps[i] \u0026gt; r) { c = i; } /* } */ // record result if (lps[i] \u0026gt; res) { res = lps[i]; resi = i; } } return s.substr((resi - res) / 2, res); } }; Reference [1] http://articles.leetcode.com/longest-palindromic-substring-part-ii\n[2] https://www.felix021.com/blog/read.php?entryid=2040\n[3] https://www.geeksforgeeks.org/manachers-algorithm-linear-time-longest-palindromic-substring-part-1/\n","date":"2018-04-13T01:50:51+08:00","permalink":"https://blog.crazyark.me/p/manachers-algorithm/","title":"æœ€é•¿å›æ–‡å­ä¸² Manacher ç®—æ³• (Longest Palindromic Substring -- Manacher's Algorithm)"},{"content":"ä¸Šå›è¯´åˆ°æ¥ä¸‹æ¥éƒ½æ˜¯å›¾ç®—æ³•\u0026hellip; è¿™ä¸ªï¼Œæˆ‘é£Ÿä¸ªè¨€ ğŸ™ƒ\nåšé¢˜ç›®ç¢°åˆ°äº†åšå¼ˆè®ºï¼Œå¯¹è¿™æ–¹é¢æˆ‘çœŸæ˜¯å®Œå…¨ä¸äº†è§£ï¼Œè¿˜æ˜¯è¦å­¦ä¹ ä¸€ä¸ªã€‚æœ¬ç¯‡æ–‡ç« ä¸»è¦ä»‹ç»ç»„åˆæ¸¸æˆä¸­çš„ Impartial Combinatorial Gamesï¼Œç»“æ„å’Œå†…å®¹å‡å‚è€ƒè‡ª CMU Thomas S. Ferguson æ•™æˆçš„åšå¼ˆè®ºè®²ç¨¿ï¼Œç»“åˆæˆ‘è‡ªå·±çš„æ€è€ƒã€‚\nTake-Away Games ç»„åˆæ¸¸æˆæ˜¯æŒ‡ä¸€ç§ä¸¤ä¸ªç©å®¶çš„æ¸¸æˆï¼Œæ¯ä¸ªç©å®¶éƒ½æœ‰ç€å®Œå…¨çš„ä¿¡æ¯ï¼Œä¸å­˜åœ¨éšæœºåŠ¨ä½œï¼Œæ¸¸æˆçš„ç»“æœæ€»æ˜¯èµ¢æˆ–è€…è¾“ã€‚æ¸¸æˆçš„æ¯ä¸€ä¸ªæ­¥éª¤ç”±ä¸€ä¸ªç§»åŠ¨æ„æˆï¼Œé€šå¸¸ç©å®¶ä¼šäº¤æ›¿åœ°è¿›è¡Œç§»åŠ¨ï¼Œç›´åˆ°è¾¾åˆ°ç»ˆæ­¢çŠ¶æ€ã€‚ç»ˆæ­¢çŠ¶æ€æ˜¯æŒ‡ä»è¯¥çŠ¶æ€ä¸å­˜åœ¨ä»»ä½•ä¸€ä¸ªçŠ¶æ€ç§»åŠ¨æ–¹å¼çš„çŠ¶æ€ã€‚\næ˜¾ç„¶ï¼Œæ¸¸æˆçš„ç»“æœä»ä¸€å¼€å§‹å°±è¢«å†³å®šäº†ï¼Œç»“æœç”±æ¸¸æˆçš„çŠ¶æ€é›†åˆã€æ¸¸æˆåˆå§‹çŠ¶æ€ä»¥åŠç©å®¶çš„å…ˆåæ‰‹å®Œå…¨ç¡®å®šã€‚\nç»„åˆæ¸¸æˆçš„å½¢å¼æœ‰ä¸¤ç§ï¼Œè¿™é‡Œæˆ‘ä»¬ä¸»è¦è®¨è®ºå…¶ä¸­çš„ä¸€ç§æ¸¸æˆå½¢å¼ Impartial Combinatorial Gamesï¼Œä»¥ä¸‹ç®€ç§° ICGã€‚ICG æ˜¯æŒ‡åœ¨æ¸¸æˆä¸­ï¼Œä¸¤ä¸ªç©å®¶æ‰€èƒ½è¿›è¡Œçš„ç§»åŠ¨æ˜¯å®Œå…¨ç›¸åŒçš„ã€‚å¯¹åº”çš„å¦ä¸€ç§å½¢å¼ Partizan Combinatorial Games å°±æ˜¯æŒ‡ä¸¤ä¸ªç©å®¶åˆ†åˆ«æœ‰ä¸åŒçš„ç§»åŠ¨ï¼Œæ¯”å¦‚è¯´æˆ‘ä»¬ç†ŸçŸ¥çš„è±¡æ£‹ã€‚\nA Simple Take-Away Game æˆ‘ä»¬æ¥çœ‹ä¸€ä¸ªç®€å•çš„å°æ¸¸æˆï¼š\nå‡è®¾æˆ‘ä»¬æœ‰ä¸¤ä¸ªç©å®¶ï¼Œæ ‡è®°ä¸º I å’Œ II å‡è®¾æ¡Œå­ä¸Šæœ‰ä¸€å †ç¢ç‰‡ï¼Œæ€»è®¡21ä¸ª æ¯ä¸€æ¬¡ç§»åŠ¨å¯¹åº”äºä»ç¢ç‰‡å †ä¸­å–å‡º1æˆ–2æˆ–3ä¸ªç¢ç‰‡ ä»ç©å®¶ I å¼€å§‹ï¼Œä¸¤ä¸ªç©å®¶è½®æµç§»åŠ¨ æœ€åä¸€ä¸ªç§»èµ°ç¢ç‰‡çš„ç©å®¶è·èƒœ è¿™ä¸ªæ¸¸æˆè¶³å¤Ÿç®€å•ï¼Œå¾ˆå®¹æ˜“å°±å¾—çŸ¥ç©å®¶Iæ€»æ˜¯èƒ½è·èƒœã€‚ä½†æ˜¯å¦‚æœæˆ‘ä»¬æŠŠç¢ç‰‡æ•°ç›®æ”¹æˆ nï¼Œæˆ‘ä»¬æ˜¯å¦ä¹Ÿèƒ½ç¡®å®šæœ€ç»ˆæ˜¯è°è·èƒœå‘¢ï¼Ÿ\næ˜¾ç„¶ï¼Œå¦‚æœnåœ¨1åˆ°3ä¹‹é—´ï¼Œç©å®¶ I æ€»æ˜¯èƒ½è·èƒœã€‚å‡è®¾ç°åœ¨åœºä¸Šçš„ç¢ç‰‡æ•°æ˜¯nï¼Œå¹¶ä¸”æ˜¯ç©å®¶ I çš„å›åˆã€‚é‚£ä¹ˆå‡è®¾ç©å®¶ I å–èµ°äº†mç‰‡ç¢ç‰‡ï¼Œåœºä¸Šå‰©ä½™ n - m ç‰‡ç¢ç‰‡ã€‚\næ˜¾ç„¶ï¼Œå¦‚æœç©å®¶ II èƒ½å¤Ÿç¡®å®šå¯¹æ‰€æœ‰åˆæ³•çš„ mï¼Œä»–èƒ½å¤Ÿåœ¨æ‰€æœ‰ n - m çš„æƒ…å†µä¸‹éƒ½å¿…èƒœï¼Œé‚£ä¹ˆç©å®¶ I å¿…è´¥ï¼Œå¦åˆ™ç©å®¶ I å¿…èƒœã€‚\næ³¨æ„åˆ°è¿™é‡Œç©å®¶ II å’Œç©å®¶ I ä¸€æ ·æ‹¥æœ‰å®Œå…¨çš„ä¿¡æ¯ï¼Œå…¶å®ä¹Ÿå°±æ˜¯é—®å…ˆæ‰‹æ¡ä»¶ä¸‹çš„ç©å®¶ I èƒ½ä¸èƒ½å¯¹æ‰€æœ‰ n - m éƒ½å¿…èƒœï¼Œé‚£ä¹ˆæ˜¾ç„¶ä¸€ä¸ª bottom-up æˆ–è€… top-down çš„åŠ¨æ€è§„åˆ’èƒ½å¾ˆå®¹æ˜“åœ°å›ç­”ä¸Šè¿°é—®é¢˜ã€‚\nCombinatorial Game ç°åœ¨æˆ‘ä»¬æ¥å½¢å¼åŒ–åœ°å®šä¹‰ä¸€ä¸ªç»„åˆæ¸¸æˆï¼š\nä¸¤ä¸ªç©å®¶æ„æˆçš„æ¸¸æˆ æ¸¸æˆæœ‰ä¸€ä¸ªçŠ¶æ€é›†åˆï¼Œè¡¨ç¤ºæ¸¸æˆè¿‡ç¨‹ä¸­æ‰€æœ‰å¯èƒ½çŠ¶æ€ï¼Œé€šå¸¸æ˜¯æœ‰ç©·çš„ æ¸¸æˆçš„è§„åˆ™æè¿°äº†åœ¨æŸä¸ªçŠ¶æ€ä¸‹ç©å®¶ç§»åŠ¨åˆ°ä¸‹ä¸€ä¸ªçŠ¶æ€çš„åˆæ³•ç§»åŠ¨ï¼Œå¦‚æœè§„åˆ™å¯¹ä¸¤ä¸ªç©å®¶æ˜¯ç›¸åŒçš„ï¼Œå°±æ˜¯ impartial çš„ï¼Œå¦åˆ™æ˜¯ partizan çš„ ç©å®¶äº¤æ›¿ç§»åŠ¨ å½“ç©å®¶ç§»åŠ¨åˆ°ä¸€ä¸ªçŠ¶æ€ï¼Œä¸‹ä¸€ä¸ªç§»åŠ¨çš„ç©å®¶æ²¡æœ‰å¯è¡Œçš„ç§»åŠ¨æ—¶ï¼Œæ¸¸æˆç»“æŸï¼› åœ¨é€šå¸¸çš„æ¸¸æˆè§„åˆ™ä¸‹ï¼Œæœ€åä¸€ä¸ªç§»åŠ¨çš„ç©å®¶è·èƒœ å¦ä¸€ç§è§„åˆ™å«åš mis`ere play ruleï¼Œæœ€åä¸€ä¸ªç§»åŠ¨çš„ç©å®¶å¤±è´¥ï¼›è¿™ä¸ªè§„åˆ™æå¤§åœ°æé«˜çš„åˆ†æçš„éš¾åº¦ æ¸¸æˆæ— è®ºæ€ä¹ˆè¿›è¡Œï¼Œå§‹ç»ˆèƒ½åœ¨æœ‰é™æ­¥å†…ç»“æŸ æ³¨æ„æ¸¸æˆå‡è®¾ä¸¤ä¸ªç©å®¶éƒ½æ˜¯è¶³å¤Ÿèªæ˜çš„ç©å®¶ï¼Œä¸å…è®¸ä»»ä½•éšæœºç§»åŠ¨çš„å­˜åœ¨ã€‚\nP-positionsï¼ŒN-positions åœ¨ä¸Šè¿°ç®€å•çš„ Take-Away æ¸¸æˆé‡Œï¼Œæ¸¸æˆçš„çŠ¶æ€å°±æ˜¯æ¡Œå­ä¸Šå‰©ä½™çš„ç¢ç‰‡æ•°ã€‚å¯ä»¥çœ‹åˆ°ï¼Œæ¡Œå­ä¸Šå‰©ä½™çš„ç¢ç‰‡æ•°å†³å®šäº†å“ªä¸ªç©å®¶èƒ½å¤Ÿæœ€ç»ˆè·èƒœã€‚æ›´æ™®éçš„ï¼Œæ¸¸æˆçš„å½“å‰çŠ¶æ€å†³å®šäº†ç©å®¶çš„è·èƒœæƒ…å†µã€‚\nå¯¹äºä¸€ä¸ªæ¸¸æˆçŠ¶æ€ï¼Œæˆ‘ä»¬å®šä¹‰å®ƒä¸º\nP-positionï¼Œåœ¨è¯¥çŠ¶æ€ï¼Œä¸Šä¸€ä¸ªç§»åŠ¨çš„ç©å®¶(Previous player)èƒ½å¤Ÿè·èƒœï¼Œä¹Ÿå°±æ˜¯åæ‰‹å¿…èƒœ N-positionï¼Œåœ¨è¯¥çŠ¶æ€ï¼Œä¸‹ä¸€ä¸ªç§»åŠ¨çš„ç©å®¶(Next player)èƒ½å¤Ÿè·èƒœï¼Œä¹Ÿå°±æ˜¯å…ˆæ‰‹å¿…èƒœ ä¸Šè¿°æ¸¸æˆä¸­ï¼Œ1ã€2ã€3ã€5ã€6 \u0026hellip; éƒ½æ˜¯ N-positionï¼Œ0ã€4ã€8ã€12ã€16 \u0026hellip;éƒ½æ˜¯ P-positionã€‚\næ˜¾ç„¶ï¼Œç”±å®šä¹‰å¯çŸ¥ï¼š\nå¯¹äºæ¯ä¸€ä¸ª P-positionï¼Œå¯¹äºä»»ä½•ä¸€ä¸ªåˆæ³•çš„ç§»åŠ¨ä¸‹çš„ä¸‹ä¸€ä¸ªçŠ¶æ€ä¸€å®šæ˜¯ä¸€ä¸ª N-position å¯¹äºæ¯ä¸€ä¸ª N-positionï¼Œä¸€å®šå­˜åœ¨ä¸€ä¸ªåˆæ³•ç§»åŠ¨ï¼Œä½¿å¾—ä¸‹ä¸€ä¸ªçŠ¶æ€æ˜¯ P-position å¯¹äºä¸Šè¿°çš„æ¸¸æˆï¼ŒçŠ¶æ€å¯¹åº”çš„ Nã€P å¦‚ä¸‹ï¼š\nx 0 1 2 3 4 5 6 7 8 9 \u0026hellip; position P N N N P N N N P N \u0026hellip; Subtraction Games æˆ‘ä»¬æ¥çœ‹ä¸€ä¸ªæ›´éš¾ä¸€ç‚¹çš„é—®é¢˜ã€‚ä»¤ S æ˜¯ä¸€ä¸ªæ­£æ•´æ•°çš„é›†åˆï¼Œn æ˜¯ä¸€ä¸ªæ¯”è¾ƒå¤§çš„æ­£æ•´æ•°ã€‚å‡è®¾æ¡Œä¸Šæœ‰ä¸€å †ç¢ç‰‡ï¼Œæ€»è®¡nä¸ªï¼Œä¸¤ä¸ªç©å®¶è½®æµä»ä¸­å–å‡ºxä¸ªï¼Œè¿™é‡Œxå¿…é¡»æ˜¯Sä¸­çš„æŸä¸ªæ•°ï¼Œæœ€åå–çš„ç©å®¶è·èƒœã€‚\né€šè¿‡çŠ¶æ€å¯¹åº”çš„ Nã€P åˆ†æï¼Œæˆ‘ä»¬å¯ä»¥è½»æ¾çš„å¾—å‡ºæ‰€æœ‰çŠ¶æ€ä¸‹ç»“æœã€‚\nThe Game of Nim Take-Away æ¸¸æˆä¸­æœ€å‡ºåçš„ä¸€ç±»æ¸¸æˆå«åš Nim æ¸¸æˆï¼Œå®ƒçš„æ¸¸æˆè§„åˆ™å¦‚ä¸‹ï¼š\nå‡è®¾ç°åœ¨æœ‰ä¸‰å †ç¢ç‰‡ï¼Œåˆ†åˆ«ä¸º x1, x2, x3 ä¸¤ä¸ªç©å®¶è½®æµå–ç¢ç‰‡ï¼Œæ¯æ¬¡å¿…é¡»ä»å…¶ä¸­çš„ä¸€å †å–è‡³å°‘ä¸€ä¸ªç¢ç‰‡ï¼Œæœ€å¤šä¸èƒ½è¶…è¿‡é€‰æ‹©çš„å † æœ€åä¸€ä¸ªå–ç¢ç‰‡çš„ç©å®¶è·èƒœ Nim æ¸¸æˆä¸ä¸€å®šæ˜¯ä¸‰å †çš„ï¼Œå¯ä»¥ä½¿å…¶ä»–çš„æ•°ç›®ï¼Œä¸ºäº†æ–¹ä¾¿èµ·è§ï¼Œæˆ‘ä»¬ç”¨ä¸‰å †çš„ç‰¹ä¾‹æ¥åˆ†æã€‚\næˆ‘ä»¬å°†çŠ¶æ€è¡¨ç¤ºä¸ºä¸€ä¸ªä¸‰å…ƒå¯¹ (a, b, c)ï¼Œæ¯ä¸ªæ•°è¡¨ç¤ºå¯¹åº”çš„å †å‰©ä½™çš„ç¢ç‰‡æ•°ã€‚\næ˜¾ç„¶ï¼Œç»ˆæ­¢çŠ¶æ€æ˜¯ (0, 0, 0)ï¼Œå®ƒæ˜¯ä¸€ä¸ª P-posã€‚\nå¯¹äºåªå‰©ä¸€ä¸ªä¸€å †çš„ Nim æ¸¸æˆ (0, 0, x), x \u0026gt; 0ï¼Œæ˜¾ç„¶å…ˆæ‰‹å¿…èƒœï¼Œä¹Ÿå°±æ˜¯ä¸€ä¸ª N-posã€‚\nå¯¹äºä¸¤å †çš„ Nim æ¸¸æˆï¼Œæ‰€æœ‰ (0, x, x) çš„ç‚¹éƒ½æ˜¯ N-posï¼Œå…¶ä½™ç‚¹éƒ½æ˜¯ P-posï¼šå‡è®¾åˆå§‹çŠ¶æ€ä¸º (0, x, x)ï¼Œä¹Ÿå°±æ˜¯è¯´ä¸¤å †ç›¸ç­‰ï¼Œå…ˆæ‰‹çš„ç©å®¶å¿…é¡»å–èµ°ä¸€äº›ç¢ç‰‡ï¼Œä½¿å¾—åœºä¸Šç¢ç‰‡æ•°ä¸ç›¸ç­‰ï¼Œåæ‰‹çš„ç©å®¶é€šè¿‡å–èµ°å¦ä¸€å †é‡Œç›¸åŒæ•°ç›®çš„ç¢ç‰‡å¯ä»¥æ¢å¤åœºä¸Šç›¸ç­‰çš„æ¡ä»¶ï¼Œæœ€ç»ˆåæ‰‹ç©å®¶ä¸€å®šèƒœåˆ©ã€‚\nå¯¹äºä¸‰å †çš„ Nim æ¸¸æˆï¼Œå°±å¾ˆéš¾åšä¸€ä¸ªç®€å•åˆ†æäº†ï¼Œæ¥ä¸‹å»æˆ‘ä»¬å°†ä»‹ç»ä¸€ä¸ªä¼˜ç¾çš„åˆ†ææ–¹æ³•ï¼Œå®ƒå°†è½»æ˜“çš„åˆ†æä»»æ„ Nim æ¸¸æˆã€‚\nNim-Sum \u0026amp; Bouton\u0026rsquo;s Theorem å¯¹äºä¸€ä¸ªæœ‰ m ä¸ªå †çš„ Nim æ¸¸æˆï¼Œå‡è®¾åœºä¸Šç¢ç‰‡æ•°ä¸º x1, x2, x3 \u0026hellip; xmï¼Œé‚£ä¹ˆ (x1, x2, x3 \u0026hellip; xm) æ˜¯ä¸€ä¸ª P-pos å½“ä¸”ä»…å½“ x1 ^ x2 ^ x3 \u0026hellip; ^ xm = 0ï¼Œè¿™é‡Œ ^ ä¸ºå¼‚æˆ–æ“ä½œï¼Œå¼‚æˆ–å’Œåœ¨è¿™é‡Œè¢«ç§°ä¸ºæ˜¯ Nim-Sumã€‚\nä¸Šè¿°å®šç†è¢«ç§°ä¸ºæ˜¯ Bouton\u0026rsquo;s Theoremã€‚\nè¿™é‡Œå…ˆä»‹ç»å‡ ä¸ªå¼‚æˆ–æ“ä½œçš„æ€§è´¨ï¼š\nè‡ªåï¼Œx ^ x = 0 ç»“åˆå¾‹ï¼Œa ^ (b ^ c) = (a ^ b) ^ c äº¤æ¢å¾‹ï¼Œa ^ b = b ^ a ä¸‹é¢æˆ‘ä»¬æ¥è¯æ˜ä¸Šè¿°å®šç†ã€‚å¯¹è¯¥å®šç†çš„è¯æ˜ï¼Œæˆ‘ä»¬åªéœ€è¦éªŒè¯ä¸Šè¿° Pã€N -pos çš„å‡ ä¸ªæ¡ä»¶å°±å¯ä»¥äº†ï¼š\næ‰€æœ‰ç»ˆæ­¢ç‚¹éƒ½æ˜¯ P-posï¼Œå› ä¸ºæˆ‘ä»¬åªæœ‰ç»ˆæ­¢ç‚¹ (0, 0, \u0026hellip; 0)ï¼Œæ‰€ä»¥æ˜¾ç„¶ã€‚ å¯¹æ¯ä¸ª N-posï¼Œå­˜åœ¨ä¸€ä¸ªç§»åŠ¨ä½¿å¾—ä¸‹ä¸€ä¸ªçŠ¶æ€æ—¶æ˜¯P-posã€‚å‡è®¾å½“å‰çŠ¶æ€ä¸º (x1, x2, x3 \u0026hellip;, xm), Nim-Sum ä¸º a = x1 ^ x2 ^ x3 \u0026hellip; ^ xmï¼Œä¸” a ä¸ç­‰äº 0ã€‚å‡è®¾ a çš„äºŒè¿›åˆ¶æœ€é«˜ä½ä¸ºç¬¬ k ä½ï¼Œé‚£ä¹ˆ x1, x2 \u0026hellip; xm æ‰€æœ‰æ•°ä¸­ç¬¬ k ä½ä¸º 1 çš„æ•°çš„ä¸ªæ•°æ˜¯å¥‡æ•°ï¼Œä¹Ÿå°±æ˜¯è¯´å…¶ä¸­ä¸€å®šå­˜åœ¨ä¸€ä¸ªæ•°ï¼Œç¬¬ k ä½ä¸º 1ã€‚ä¸å¤±ä¸€èˆ¬æ€§ï¼Œå‡è®¾æ˜¯ x1ã€‚é‚£ä¹ˆä»¤ x1\u0026rsquo; ä¸º x1 åœ¨ k ä¹‹åçš„é«˜ä½ã€kä½ ä¸º 0ã€a åœ¨ k ä¹‹åçš„åœ°ä½æ‹¼æ¥è€Œæˆçš„æ•°ï¼Œæ˜¾ç„¶ x1\u0026rsquo; \u0026lt; x1ï¼Œæ‰€ä»¥ (x1, x2, x3 \u0026hellip;, xm) åˆ° (x1\u0026rsquo;, x2, x3 \u0026hellip;, xm) æ˜¯ä¸€ä¸ªåˆæ³•çš„ç§»åŠ¨ã€‚æ­¤æ—¶ x1\u0026rsquo; ^ x2 ^ x3 \u0026hellip; ^ xm = a ^ x1\u0026rsquo; ^ x1 = 0ï¼Œ(x1\u0026rsquo;, x2, x3 \u0026hellip;, xm) æ˜¯ä¸€ä¸ª P-posã€‚ å¯¹æ¯ä¸ª P-posï¼Œæ¯ä¸€ä¸ªç§»åŠ¨éƒ½æ˜¯åˆ° N-posã€‚è¿™é‡Œåè¯å°±è¡Œã€‚ è¯æ¯•ã€‚\nMis`ere Nim å¯¹äº Mis`ere è§„åˆ™ä¸‹çš„ Nim æ¸¸æˆï¼ŒBouton ç»™å‡ºäº†ç©æ³•ï¼š\nå½“å‰åœºä¸Šè¿˜æœ‰è‡³å°‘ä¸¤å †å¤§äº1çš„ç¢ç‰‡æ—¶ï¼Œå’Œæ­£å¸¸è§„åˆ™ä¸€æ ·ç§»åŠ¨ å¦åˆ™åœºä¸Šåªå‰©ä¸€å †å¤§äº1çš„ç¢ç‰‡ï¼Œä»è¿™ä¸€å †é‡Œå–ï¼Œä½¿å¾—å †é‡Œå‰©ä½™0æˆ–è€…1ä¸ªç¢ç‰‡ï¼Œä»è€Œä¿è¯åœºä¸Šè¿˜å‰©å¥‡æ•°ä¸ªå †ï¼Œæ¯ä¸ªå †åªæœ‰ä¸€ä¸ª1ç¢ç‰‡ï¼Œä»è€Œå¿…èƒœã€‚ Graph Games ç»ˆäºä»‹ç»åˆ°è¿™é‡Œäº†ï¼Œè¿™ä¸€èŠ‚å°†ä»‹ç»ä¸€ç§ Impartial Combinatorial Games ä¸­çš„é‡è¦çš„åˆ†ææ‰‹æ®µï¼Œå«åš Sprague-Grundy functionã€‚\né¦–å…ˆæˆ‘ä»¬å…ˆæŠŠæ¸¸æˆè½¬æ¢æˆä¸€ä¸ªæœ‰å‘å›¾G(X, F)ï¼Œå…¶ä¸­ X æ˜¯æ¸¸æˆä¸­æ‰€æœ‰çŠ¶æ€çš„é›†åˆï¼ŒF è¡¨ç¤ºçŠ¶æ€ä¹‹é—´çš„ç§»åŠ¨å…³ç³»ï¼Œä»¤ x è¡¨ç¤ºä¸€ä¸ªçŠ¶æ€ï¼Œé‚£ä¹ˆ F(x) è¡¨ç¤ºåœ¨ x çŠ¶æ€ä¸‹çš„ä¸‹ä¸€ä¸ªåˆæ³•çŠ¶æ€ï¼Œä¹Ÿå°±ä»£è¡¨äº†ç§»åŠ¨çš„é›†åˆã€‚\nå¦‚æœå¯¹äºèŠ‚ç‚¹xï¼ŒF(x) æ˜¯ç©ºé›†ï¼Œé‚£ä¹ˆ x å°±æ˜¯ä¸€ä¸ªç»ˆæ­¢èŠ‚ç‚¹ã€‚\nä¸ºäº†åˆ†ææ–¹ä¾¿èµ·è§ï¼Œæˆ‘ä»¬å‡è®¾è¿™æ ·çš„å›¾æ¸¸æˆæ˜¯æ¸è¿›æœ‰ç•Œçš„ï¼šå­˜åœ¨ä¸€ä¸ªæ•´æ•°nï¼Œä½¿å¾—å›¾ä¸Šä»»ä½•ä¸€æ¡è·¯å¾„æ˜¯çš„é•¿åº¦ä¸è¶…è¿‡nã€‚\nSprague-Grundy Function å®šä¹‰å›¾ G(X,F) ä¸Šçš„ SG-å‡½æ•°ä¸ºå¦‚ä¸‹å½¢å¼ï¼š\n$g(x) = \\min{{n \\ge 0: n \\ne g(y)\\ \\textrm{for}\\ y \\in F(x)}}$\nä¹Ÿå°±æ˜¯è¯´ï¼Œg(x) ä»£è¡¨äº†åœ¨ x çš„åç»§èŠ‚ç‚¹çš„ SG-å‡½æ•°ä¸­æ²¡æœ‰å‡ºç°çš„ç¬¬ä¸€ä¸ªéè´Ÿæ•´æ•°ã€‚æˆ‘ä»¬å®šä¹‰ä¸€ä¸ªæ“ä½œå«åš minimal excludant, ç®€å†™ä¸º mexï¼Œä¸ºç»™å‡ºä¸å‡ºç°åœ¨ä¸€ä¸ªéè´Ÿæ•´æ•°é›†åˆä¸­çš„ç¬¬ä¸€ä¸ªéè´Ÿæ•´æ•°ï¼Œé‚£ä¹ˆ g(x) å¯ä»¥å†™æˆå¦‚ä¸‹å½¢å¼ï¼š\n$g(x) = \\mathrm{mex}{{g(y): y \\in F(x)}}$\næ³¨æ„åˆ° g(x) æ˜¯é€’å½’å®šä¹‰çš„ï¼Œå¯¹ç»ˆæ­¢èŠ‚ç‚¹xï¼Œg(x) = 0ã€‚\nThe Use of the Sprague-Grundy Function ä»¤ g ä¸ºå›¾æ¸¸æˆ G(X, F) ä¸Šçš„ SG-å‡½æ•°ï¼Œæˆ‘ä»¬æœ‰å¦‚ä¸‹æ€§è´¨ï¼š\nxæ˜¯ç»ˆæ­¢èŠ‚ç‚¹ï¼Œé‚£ä¹ˆ g(x) = 0 g(x) = 0ï¼Œé‚£ä¹ˆå¯¹äº x æ¯ä¸ªåç»§èŠ‚ç‚¹ yï¼Œg(y) != 0 g(x) != 0ï¼Œé‚£ä¹ˆå­˜åœ¨ä¸€ä¸ª x çš„åç»§èŠ‚ç‚¹ yï¼Œg(y) = 0 æ ¹æ® g çš„å®šä¹‰ï¼Œä¸Šè¿°ä¸‰æ¡ç»“è®ºæ˜¯æ˜¾ç„¶çš„ã€‚\nç°åœ¨æˆ‘ä»¬å¯ä»¥è¯´ï¼Œå¯¹äºä»»æ„ g(x) = 0 çš„èŠ‚ç‚¹ï¼Œx å¯¹åº”çš„çŠ¶æ€ä¸ºä¸€ä¸ª P-posï¼Œå…¶ä½™çš„èŠ‚ç‚¹éƒ½ä¸º N-posã€‚\näº‹å®ä¸Šï¼ŒSG-å‡½æ•°ç»™å‡ºäº†è·èƒœçš„è·¯å¾„ï¼šå½“å‰çŠ¶æ€çš„ GF-å‡½æ•°äº¤æ›¿å˜ä¸º 0ã€‚\nè¯¥ç†è®ºä¹Ÿå¯ä»¥æ¨å¹¿åˆ°æ¸è¿›æœ‰ç©·çš„çš„å›¾ä¸Šï¼šå›¾çš„æ¯ä¸€æ¡è·¯å¾„éƒ½æ˜¯æœ‰ç©·çš„ã€‚\nSums of Combinatorial Games å‡è®¾æˆ‘ä»¬ç°åœ¨æœ‰å‡ ä¸ªç»„åˆæ¸¸æˆï¼Œæˆ‘ä»¬æ‰“ç®—æŠŠå®ƒåˆå¹¶æˆä¸€ä¸ªå¤§æ¸¸æˆï¼š\nç©å®¶çš„ç§»åŠ¨å˜ä¸ºï¼šé€‰æ‹©å…¶ä¸­ä¸€ä¸ªæœªç»ˆæ­¢çš„æ¸¸æˆï¼Œè¿›è¡Œä¸€æ¬¡åˆæ³•ç§»åŠ¨ ç»ˆæ­¢çŠ¶æ€ä¸ºï¼šæ‰€æœ‰æ¸¸æˆéƒ½ç»ˆæ­¢äº† è¿™æ ·åˆå¹¶å‡ºæ¥çš„æ¸¸æˆè¢«ç§°ä¸ºæ¸¸æˆçš„ disjunctive sumã€‚\nå‡è®¾æˆ‘ä»¬æ‰€åˆå¹¶çš„æ¸¸æˆåˆ†åˆ«è¡¨ç¤ºä¸ºå›¾ G1(X1, F1)ï¼ŒG2(X2, F2) \u0026hellip;ï¼ŒGn(Xn, Fn)ï¼Œæˆ‘ä»¬å¯ä»¥æŠŠå®ƒä»¬åˆå¹¶æˆä¸€å¼ æ–°çš„å›¾ G(X, F)ï¼Œå…¶ä¸­ $X = X_1 \\times X_2 \\times \\cdots \\times X_n$ ä¸ºç¬›å¡å°”ä¹˜ç§¯ï¼›ä»¤ x = (x1, \u0026hellip; xn) ï¼Œåˆ™ $F(x) = F(x_1, \u0026hellip;, x_n) = F_1(x_1) \\times {x_2} \\times \\cdots {x_n} \\cup {x_1} \\times F_2(x_2) \\times \\cdots{x_n} \\cup \\cdots {x_1} \\times {x_2} \\times \\cdots F_n(x_n)$\nThe Sprague-Grundy Theorem åˆå¹¶åçš„å›¾æ¸¸æˆä¸­ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡ä»¥ä¸‹æ–¹å¼ç»™å‡ºå›¾ä¸Šçš„ SG-å‡½æ•° gï¼šå‡è®¾åŸæ¥æ¸¸æˆçš„ SG-å‡½æ•°åˆ†åˆ«ä¸º g1, g2, \u0026hellip;, gnï¼Œé‚£ä¹ˆå¯¹äº x = (x1, x2, \u0026hellip;, xn)ï¼Œg(x) = g1(x1) ^ g2(x2) ^ \u0026hellip; gn(xn)ï¼Œä¹Ÿå°±æ˜¯å­æ¸¸æˆå½“å‰çŠ¶æ€çš„ SG-å‡½æ•°çš„ Nim-å’Œã€‚\nä»¤ x = (x1, x2, \u0026hellip;, xn) ä¸ºå›¾ä¸Šä»»æ„ä¸€ç‚¹ï¼Œb = g1(x1) ^ g2(x2) ^ \u0026hellip; gn(xn) ï¼Œäº‹å®ä¸Šæˆ‘ä»¬åªéœ€è¦è¯æ˜å¦‚ä¸‹ä¸¤ç‚¹å°±å¯ä»¥å¾—å‡ºä¸Šè¿°ç»“è®ºï¼š\nå¯¹æ¯ä¸ªéè´Ÿæ•´æ•° a \u0026lt; bï¼Œå­˜åœ¨ä¸€ä¸ª x çš„åç»§ yï¼Œä½¿å¾— g(y) = a ä»»æ„ x çš„åç»§ä¸ä¸º b æ­¤å¤„è¯æ˜ä¸ä¸Šä¸€èŠ‚ Nim å’Œçš„è¯æ˜ç±»ä¼¼ï¼Œå°±ç•™ä½œä¹ é¢˜å§ã€‚\näº‹å®ä¸Šï¼ŒNim æ¸¸æˆä¸­ï¼Œæ˜¾ç„¶æ¯å †çš„ SG-å‡½æ•° g(n) = nï¼Œæ‰€ä»¥ Nim æ¸¸æˆåˆ¤æ–­ Nã€P-pos æ˜¯ Sprague-Grundy çš„ä¸€ä¸ªç‰¹ä¾‹ã€‚\nä¹Ÿå¯ä»¥è¯´ï¼Œä»»æ„ICGéƒ½ç­‰ä»·äºæŸä¸ªNimæ¸¸æˆã€‚\nGreen Hackenbush ä¸‹é¢ä»‹ç»ä¸€ä¸ªç»„åˆæ¸¸æˆï¼Œå«åš Hackenbush ï¼Œè¿™ä¸ªæ¸¸æˆçš„å¤§æ„æ˜¯ä»ä¸€ä¸ªæœ‰æ ¹çš„å›¾ä¸Šç ä¸‹ä¸€äº›è¾¹ï¼Œå¹¶ç§»é™¤ä¸æ¥åœ°çš„éƒ¨åˆ†ã€‚é¢ï¼Œç›´è¯‘æœ‰ç‚¹éš¾ï¼Œè¿™é‡Œhackç¿»è¯‘ä¸ºç ï¼Œbushæ˜¯çŒæœ¨ï¼Œä» Hackenbush è¿™ä¸ªæ¸¸æˆåçš„å­—é¢ä¸Šç†è§£å°±è¡Œäº†ï¼Œå°±æ˜¯ç çŒæœ¨ä¸›çš„æ¸¸æˆã€‚\nè¿™ä¸ªæ¸¸æˆçš„ impartial ç‰ˆæœ¬å«åš Green Hackenbushï¼šå›¾ä¸Šçš„æ¯æ¡è¾¹éƒ½æ˜¯ç»¿è‰²çš„ï¼Œä¸¤ä¸ªç©å®¶éƒ½èƒ½ç ä»»æ„è¾¹ã€‚Partizan ç‰ˆæœ¬çš„æ¸¸æˆå«åš Blue-Red Hackenbushï¼Œå…¶ä¸­å›¾ä¸Šçš„è¾¹æœ‰è“è‰²å’Œçº¢è‰²ä¹‹åˆ†ï¼Œç©å®¶ I åªèƒ½ç è“è‰²çš„ï¼Œè€Œç©å®¶ II åªèƒ½ç çº¢è‰²çš„ã€‚æ›´ä¸ºä¸€èˆ¬çš„ç‰ˆæœ¬ä¸­ï¼Œè¾¹æœ‰ä¸Šè¿°ä¸‰ç§ï¼Œç»¿è‰²æ˜¯éƒ½èƒ½ç çš„ã€‚\nBamboo Stalks å…ˆçœ‹ä¸€ä¸ªç®€å•çš„ Green Hackenbush çš„ç‰¹ä¾‹ï¼Œè¿™ä¸ªç‰¹ä¾‹é‡Œï¼Œæ¯ä¸ªæœ‰æ ¹çš„è”é€šåˆ†æ”¯éƒ½æ˜¯ä¸€æ¡ç›´çº¿ï¼Œå°±è·ŸæŸ±å­ä¸€æ ·ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š\nBamboo Stalks æ¯ä¸€æ¬¡ç§»åŠ¨å°±æ˜¯é€‰å–å…¶ä¸­ä¸€æ¡è¾¹ï¼Œç æ–­å®ƒå¹¶ç§»é™¤æ‰€æœ‰ä¸è¿åˆ°åœ°é¢çš„éƒ¨åˆ†ã€‚ç©å®¶äº¤æ›¿è¿›è¡Œç§»åŠ¨ï¼Œæœ€åä¸€ä¸ªç§»åŠ¨çš„ç©å®¶èƒœåˆ©ã€‚\næ˜¾ç„¶ï¼Œæœ‰næ ¹æŸ±å­çš„è¿™ä¸ªæ¸¸æˆå’Œæœ‰nå †çš„nimæ¸¸æˆæ˜¯ç­‰ä»·çš„ã€‚\nGreen Hackenbush on Trees é¡¾åæ€ä¹‰ï¼Œæ¯æ£µçŒæœ¨é•¿çš„å’Œæ ‘ä¸€æ ·ï¼š\nGreen Hackenbush on Trees ç”±ä¸Šä¸€èŠ‚çš„å®šç†ï¼Œè¿™ä¸ªæ¸¸æˆç­‰ä»·äºæŸä¸ªç‰ˆæœ¬çš„ Bamboo Stalksã€‚æˆ‘ä»¬å¯ä»¥é€šè¿‡ä»¥ä¸‹åŸåˆ™æ¥è¿›è¡Œè½¬æ¢ï¼Œæ›´ä¸ºæ™®éåœ°ï¼Œå«åš Colon Principleï¼š\nå½“åˆ†æ”¯äº¤æ±‡äºæŸä¸ªé¡¶ç‚¹æ—¶ï¼Œå¯ä»¥ç”¨ä¸€æ¡é•¿åº¦ä¸ºåˆ†æ”¯é•¿åº¦ nim-å’Œçš„æ†æ¥ä»£æ›¿ Colon Principle Colon Principle çš„è¯æ˜åº”è¯¥æ¯”è¾ƒç®€å•ï¼Œè¿™é‡Œç•™ä½œæ€è€ƒã€‚\nGreen Hackenbush on general rooted graphs ç°åœ¨æˆ‘ä»¬æ¥è€ƒè™‘ä»»æ„çš„å›¾ï¼Œè¿™äº›å›¾ä¸­å¯èƒ½å­˜åœ¨ç¯ç­‰ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š\nArbitrary Green Hackenbush è¿™å›¾çœ‹ç€å¤æ‚ï¼Œå…¶å®åŒæ ·å¯¹äºæ¯ä¸ªè”é€šåˆ†æ”¯éƒ½å¯ä»¥è½¬æ¢ä¸º Nim æ¸¸æˆä¸­çš„ä¸€ä¸ªå †ã€‚è€ƒè™‘å¦‚æœèƒ½å°†æ¯ä¸ªåˆ†æ”¯è½¬æ¢æˆä¸€æ£µæ ‘ï¼Œé‚£å°±å¯ä»¥ç”¨ä¸Šé¢çš„æ–¹æ³•è½¬æ¢æˆç­‰ä»·çš„å †äº†ã€‚\nè¿™é‡Œä»‹ç»ä¸€ç§è½¬æ¢æ–¹å¼ï¼Œå«åš Fusion Principleï¼š åœ¨ä¸æ”¹å˜å›¾ä¸Š SG-å‡½æ•°å€¼çš„æƒ…å†µä¸‹ï¼Œå›è·¯ä¸Šçš„ç‚¹å¯ä»¥è¿›è¡Œåˆå¹¶ã€‚\nå¦‚ä¸‹å›¾æ‰€ç¤ºï¼Œæˆ‘ä»¬å¯ä»¥å°†é—¨å½¢çŠ¶çš„å›è·¯è½¬æ¢ä¸ºé•¿åº¦ä¸º1çš„æ†ï¼š\nFusion Principle Example é¦–å…ˆï¼Œåœ°ä¸Šçš„ä¸¤ä¸ªç‚¹äº‹å®ä¸Šå¯ä»¥åˆå¹¶æˆä¸€ä¸ªç‚¹ï¼›ç„¶ååº”ç”¨fusion principleï¼Œè¿™ä¸ªä¸‰è§’å½¢ç­‰ä»·äºä¸‰ä¸ªç‹¬ç«‹çš„è‡ªç¯ï¼›è€Œæ¯ä¸ªè‡ªç¯åˆç­‰ä»·äºä¸€ä¸ªå¤§å°ä¸º1çš„nimå †ï¼Œæœ€ç»ˆåˆå¹¶ä¸ºä¸€ä¸ªå¤§å°ä¸º1çš„å †ã€‚\næ›´ä¸€èˆ¬åœ°ï¼Œå¥‡æ•°é•¿åº¦çš„å›è·¯éƒ½å¯ä»¥è½¬æ¢ä¸ºä¸€æ¡è¾¹ï¼Œå¶æ•°é•¿åº¦çš„å›è·¯è½¬æ¢ä¸ºä¸€ä¸ªç‚¹ã€‚\nå…³äº fusion principle çš„è¯æ˜æ¯”è¾ƒé•¿ï¼Œæœ‰å…´è¶£çš„åŒå­¦å¯ä»¥å‚è€ƒ ã€ŠWinning Waysã€‹ çš„ç¬¬ä¸ƒç« ã€‚\nA Problem è¿™é‡Œç»™å‡ºä¸€ä¸ªå…·ä½“çš„ç®—æ³•é—®é¢˜ Bob\u0026rsquo;s Gameï¼ŒåŸé¢˜åœ¨ https://www.hackerrank.com/contests/university-codesprint-3/challenges/bobs-game/problem ã€‚\né¢˜ç›®å¤§æ„ï¼š\nBob å‘æ˜äº†ä¸€ä¸ªæ–°æ¸¸æˆï¼Œè¿™ä¸ªæ¸¸æˆåœ¨ä¸€ä¸ª n x n çš„æ£‹ç›˜ä¸Šè¿›è¡Œã€‚æ¸¸æˆçš„è§„åˆ™å¦‚ä¸‹ï¼š\nä¸€å¼€å§‹ï¼Œæ£‹ç›˜ä¸Šæœ‰ä¸€äº›å›½ç‹ã€‚ä¸€ä¸ªæ ¼å­ä¸­å¯ä»¥å­˜åœ¨å¤šä¸ªå›½ç‹ã€‚ å›½ç‹åªå…è®¸å‘ä¸Šã€å·¦ã€å·¦ä¸Šç§»åŠ¨ æ£‹ç›˜ä¸Šæœ‰äº›æ ¼å­æŸåäº†ï¼Œå›½ç‹ä¸èƒ½ç§»åŠ¨åˆ°æŸåçš„æ ¼å­ä¸Š å›½ç‹ä¸èƒ½ç§»å‡ºæ£‹ç›˜ æ¸¸æˆç”±ä¸¤ä¸ªç©å®¶è¿›è¡Œï¼Œä»–ä»¬äº¤æ›¿è¿›è¡Œæ“ä½œ ç©å®¶æ¯æ¬¡æ“ä½œç§»åŠ¨ä¸€ä¸ªå›½ç‹ æœ€åä¸€ä¸ªç§»åŠ¨çš„ç©å®¶è·èƒœ Bob å’Œä»–çš„å¥½æœ‹å‹ Alice ç©è¿™ä¸ªæ¸¸æˆï¼ŒBob å…ˆæ‰‹ã€‚å‡è®¾ç»™å®šæ£‹ç›˜çš„åˆå§‹çŠ¶æ€ï¼Œç»™å‡º Bob ä¸€å®šèƒ½è·èƒœçš„ç¬¬ä¸€æ­¥ç§»åŠ¨çš„æ•°ç›®ï¼›å¦‚æœ Bob å¿…è´¥ï¼Œè¾“å‡º LOSEã€‚\nå‡è®¾æ£‹ç›˜ä¸Šåªæœ‰ä¸€ä¸ªå›½ç‹ï¼Œè¿™ä¸ªæ¸¸æˆé€šè¿‡ SG-å‡½æ•°å¾ˆå®¹æ˜“åˆ†æ Bob æ˜¯å¦å¿…èƒœï¼Œä»¥åŠå¿…èƒœçš„ç¬¬ä¸€æ­¥æ“ä½œã€‚\nç°åœ¨åœºä¸Šå­˜åœ¨å¤šä¸ªå›½ç‹ï¼Œä½†æ˜¯å›½ç‹ä¹‹é—´äº’ç›¸ä¸å¹²æ‰°ï¼Œæ‰€ä»¥è¿™ä¸ªæ¸¸æˆæ˜¯ç”±å¤šä¸ªå•å›½ç‹çš„æ¸¸æˆåˆå¹¶è€Œæˆçš„ã€‚åº”ç”¨ Sprague-Grundy å®šç†ï¼Œæˆ‘ä»¬å¯ä»¥æ¨å¯¼å‡ºè¿™ä¸ªæ¸¸æˆçš„ SG-å‡½æ•°ã€‚\nReferences [1] http://www.cs.cmu.edu/afs/cs/academic/class/15859-f01/www/notes/comb.pdf\n","date":"2017-10-11T00:40:08+08:00","permalink":"https://blog.crazyark.me/p/game-theory/","title":"åšå¼ˆè®º-å…¬å¹³ç»„åˆæ¸¸æˆ (Game Theory -- Impartial Combinatorial Games)"},{"content":"ä¸Šå‡ ç¯‡åšæ–‡ä¸»è¦æ˜¯å…³äºèŒƒå›´æ›´æ–°å’ŒèŒƒå›´æŸ¥è¯¢çš„å‡ ä¸ªæ•°æ®ç»“æ„ï¼Œæ¥ä¸‹å»çš„ä¸»é¢˜æ˜¯å›¾è®ºå’Œå›¾ç®—æ³•ï¼Œå¸Œæœ›èƒ½å¤Ÿå­¦ä¹ å’Œå›å¿†èµ·å¤§éƒ¨åˆ†å›¾ç®—æ³•ã€‚\nä»Šå¤©é‡åˆ°ä¸€ä¸ªé—®é¢˜ï¼Œå¯ä»¥è½¬åŒ–æˆäºŒéƒ¨å›¾(bipartite graph)ä¸Šçš„å®Œç¾åŒ¹é…çš„å­˜åœ¨æ€§é—®é¢˜ï¼Œæˆ‘ä»¬å…ˆæ¥çœ‹ä¸€ä¸‹å®Œç¾åŒ¹é…çš„ç†è®ºï¼ŒHall\u0026rsquo;s Marriage theoremï¼›ç„¶åä»‹ç»ä¸¤ä¸ªç®—æ³•ï¼Œç”¨äºè§£å†³å®Œç¾åŒ¹é…çš„è¶…é›†â€”â€”æœ€å¤§åŒ¹é…é—®é¢˜ã€‚\nHall\u0026rsquo;s Marriage Theorem ä»¤ $G$ è¡¨ç¤ºä¸€ä¸ªäºŒéƒ¨å›¾ï¼Œå·¦éƒ¨å’Œå³éƒ¨åˆ†åˆ«ä¸º $X$ å’Œ $Y$ã€‚ä»¤ $W \\subset X$, $N_G(W)$ ä¸º $W$ åœ¨ $Y$ ä¸­çš„ç›¸é‚»ç‚¹çš„é›†åˆã€‚\né‚£ä¹ˆå¦‚æœå­˜åœ¨ä¸€ä¸ªåŒ¹é…æ–¹å¼è¦†ç›–æ•´ä¸ª $X$ å½“ä¸”ä»…å½“\n$\\forall W \\subset X, |W| \\le |N_G(W)|$ï¼Œä¹Ÿå°±æ˜¯è¯´æ¯ä¸ª $X$ çš„å­é›†éƒ½æœ‰è¶³å¤Ÿçš„é‚»å±…åšåŒ¹é…ã€‚\nDeduction 1 [1] åŠ å…¥ä¸€ä¸ªäºŒéƒ¨å›¾ $G(X + Y, E)$ï¼Œ$|X| = |Y|$ï¼Œ$G$ æ˜¯è¿é€šå›¾ï¼Œä¸”æ¯ä¸ª $X$ ä¸­çš„ç‚¹çš„åº¦æ•°éƒ½ä¸ç›¸åŒï¼Œé‚£ä¹ˆ $G$ ä¸Šä¸€å®šå­˜åœ¨å®Œç¾åŒ¹é…ã€‚\nè¯æ˜ï¼š\né¦–å…ˆï¼Œå› ä¸º $G$ æ˜¯è¿é€šå›¾ï¼Œæ‰€ä»¥ $\\forall u \\in X, deg(u) \u0026gt;= 1$ã€‚ é‚£ä¹ˆ $\\forall W \\subset X$ï¼Œ $\\max\\limits_{u \\in W}{deg(u)} \\ge |S|$ï¼Œæ»¡è¶³ Hall\u0026rsquo;s Marriage Theoremï¼Œå¾—è¯ã€‚\nHungarian Algorithm äº‹å®ä¸Šï¼Œæˆ‘å¯¹ç…§ç€æ‰¾äº†åŠå¤©ï¼Œå¹¶æ²¡æœ‰æ‰¾åˆ°ä¸€ä¸ªå«åŒˆç‰™åˆ©ç®—æ³• (Hungarian Algorithm) çš„ç”¨äºäºŒéƒ¨å›¾æœ€å¤§åŒ¹é…çš„ç®—æ³•ï¼Œå”¯ä¸€æ‰¾åˆ°çš„ Hungarian Algorithm æ˜¯ç”¨äºä»»åŠ¡åˆ†é…é—®é¢˜ (Assignment Problem)ï¼Œä¹Ÿå°±æ˜¯å¸¦æƒäºŒéƒ¨å›¾çš„æœ€å¤§åŒ¹é…ã€‚\nç”±äºæœ€å¤§åŒ¹é…é—®é¢˜ä¸æœ€å¤§æµé—®é¢˜èƒ½å¤Ÿå¾ˆå®¹æ˜“çš„äº’ç›¸è½¬æ¢ï¼Œæ‰€ä»¥åŒæ—¶æˆ‘ä¹Ÿæ‰¾åˆ°äº†è®¸å¤šæ€æƒ³ç±»ä¼¼ç”šè‡³ä¸€è‡´çš„ç®—æ³•ï¼Œå¦‚ Ford-Fulkerson Algorihtmï¼ŒEdmonds-Karp Algorithm ç­‰ã€‚\nè‡³äºåŒˆç‰™åˆ©ç®—æ³•è¿™ä¸ªåå­—æ˜¯å“ªæœ¬ä¹¦ä¸Šæå‡ºçš„ï¼Œæˆ‘å·²ç»è®°ä¸å¤ªæ¸…äº† \u0026hellip; åº”è¯¥æ˜¯æŸæœ¬å­¦ä¹ è¿‡çš„å›¾è®ºä¹¦ï¼Œåœ¨æ­¤ä¸»è¦è®²ä¸€ä¸‹å®ƒçš„å…·ä½“æ€æƒ³å’Œè¯æ˜ã€‚\nAlternating Path \u0026amp; Augmenting Path å‡è®¾æˆ‘ä»¬æœ‰ä¸€ä¸ªäºŒéƒ¨å›¾ $G(U + V, E)$ï¼Œç°åœ¨æœ‰ä¸€ä¸ªåŒ¹é… $M \\subset E$ï¼Œæ­¤æ—¶å¦‚æœ $M$ ä¸­çš„è¾¹ä¸Šçš„ç‚¹é›†ä¸­ä¸å­˜åœ¨ä¸€ä¸ªç‚¹ï¼Œæˆ‘ä»¬å°±è¯´è¯¥ç‚¹æ˜¯æœªåŒ¹é…çš„ï¼ŒæœªåŒ¹é…è¾¹çš„å®šä¹‰ç±»ä¼¼ã€‚\näº¤æ›¿è·¯å¾„ (alternating path)ï¼šä»ä¸€ä¸ªæœªåŒ¹é…ç‚¹å‡ºå‘ï¼Œç»è¿‡æœªåŒ¹é…è¾¹ã€åŒ¹é…è¾¹ã€æœªåŒ¹é…è¾¹\u0026hellip;è¿™æ ·äº¤æ›¿çš„è·¯å¾„å«åšäº¤æ›¿è·¯å¾„ã€‚ å¢å¹¿è·¯å¾„ (augmenting path)ï¼šä» $U$ ä¸­ä¸€ä¸ªæœªåŒ¹é…ç‚¹å‡ºå‘ï¼Œåˆ°è¾¾ $V$ ä¸­ä¸€ä¸ªæœªåŒ¹é…ç‚¹çš„äº¤æ›¿è·¯å«åšå¢å¹¿è·¯å¾„ã€‚\næ˜¾ç„¶ï¼Œç”±å¢å¹¿è·¯å¾„çš„å®šä¹‰ï¼Œå¯ä»¥çŸ¥é“å¢å¹¿è·¯å¾„ä¸ŠæœªåŒ¹é…è¾¹æ¯”åŒ¹é…è¾¹è¦å¤šä¸€æ¡ï¼Œå¹¶ä¸”å°†è¿™æ¡è·¯å¾„ä¸Šæ‰€æœ‰æœªåŒ¹é…è¾¹æ”¹ä¸ºåŒ¹é…è¾¹ï¼ŒåŒ¹é…è¾¹æ”¹ä¸ºæœªåŒ¹é…è¾¹ï¼Œåˆ™ä¿®æ”¹åçš„åŒ¹é… $M\u0026rsquo;$ æ¯”åŸæ¥å¤§1ã€‚\nTheorem of Augmenting Path ä¸€ä¸ªåŒ¹é… $M$ æ˜¯æœ€å¤§åŒ¹é…å½“ä¸”ä»…å½“é‚£ä¹ˆåœ¨å›¾ $G$ ä¸Šä¸å­˜åœ¨å¢å¹¿è·¯å¾„ã€‚\nè¯æ˜å¦‚ä¸‹ï¼š\nå‡è®¾å­˜åœ¨ä¸€æ¡å¢å¹¿è·¯å¾„ï¼Œ$M$ æ˜¾ç„¶ä¸æ˜¯æœ€å¤§çš„ã€‚æ‰€ä»¥æˆ‘ä»¬åªéœ€è¦è¯æ˜å½“ä¸å­˜åœ¨å¢å¹¿è·¯å¾„æ—¶ï¼Œ$M$ æ˜¯æœ€å¤§çš„ã€‚\nå‡è®¾å­˜åœ¨ä¸€ä¸ªåŒ¹é… $M$ï¼Œä¸å­˜åœ¨å¢å¹¿è·¯å¾„å¹¶ä¸” $M$ ä¸æ˜¯æœ€å¤§åŒ¹é…ï¼Œæˆ‘ä»¬ä»¤ $M^$ ä¸º $G$ ä¸Šçš„ä¸€ä¸ªæœ€å¤§åŒ¹é…ï¼Œæ˜¾ç„¶ $|M^| \u0026gt; |M|$ã€‚\næ‰€ä»¥åŒæ—¶æœ‰ $|M^* - M| \u0026gt; |M - M^*|$ã€‚\nè€ƒå¯Ÿæ‰€æœ‰åœ¨ $M^$ å’Œ $M$ å¯¹ç§°å·® ($M^ \\cup M - M^* \\cap M$) ä¸­çš„è¾¹ï¼Œä»¤ $G\u0026rsquo;$ æ˜¯ç”±ç‚¹ $U + V$ å’Œä¸Šè¿°è¾¹æ„æˆçš„å›¾ã€‚\nå› ä¸º $G\u0026rsquo;$ ä¸­çš„è¾¹æ˜¯æ¥è‡ªä¸¤ä¸ªåŒ¹é…ï¼Œæ‰€ä»¥ $G\u0026rsquo;$ ä¸Šä»»æ„ä¸€ä¸ªç‚¹æœ€å¤šä¸ä¸¤æ¡è¾¹ç›¸è¿ã€‚\nå› æ­¤ï¼Œå¯¹äº $G\u0026rsquo;$ ä¸Šçš„ä»»æ„è”é€šåˆ†æ”¯ï¼Œåªå¯èƒ½æ˜¯ä¸€æ¡è·¯æˆ–è€…ä¸€ä¸ªç¯ï¼Œå¹¶ä¸”è¾¹çš„æ•°ç›®æ˜¯å¶æ•°ï¼Œå¹¶ä¸”è·¯æˆ–è€…ç¯ä¸Šå¯¹äº $M^* - M$ æˆ–è€… $M - M^*$ ä¸€å®šæ„æˆäº¤æ›¿è·¯ã€‚\nå› ä¸º $|M^* - M| \u0026gt; |M - M^|$ å¹¶ä¸”ç¯éƒ½æ˜¯å¶æ•°æ¡è¾¹ï¼Œæ‰€ä»¥ä¸€å®šæœ‰ä¸€æ¡è·¯ï¼Œå®ƒçš„è¾¹ï¼Œå®ƒçš„èµ·ç‚¹å’Œç»ˆç‚¹éƒ½åœ¨ $M^ - M$ ä¸­ï¼Œä¸” $M^* - M$ å’Œ $M - M^*$ äº¤æ›¿æ„æˆï¼Œæ˜¾ç„¶è¿™æ¡è·¯å¯¹äº $M$ æ„æˆå¢å¹¿è·¯å¾„ï¼ŒçŸ›ç›¾ï¼\nå¾—è¯ã€‚\nPseudocode åŒˆç‰™åˆ©ç®—æ³•æœ‰ä¸¤ç§å®ç°ï¼Œåˆ†åˆ«åŸºäº DFS å’Œ BFSï¼Œæ—¶é—´å¤æ‚åº¦éƒ½æ˜¯ $\\mathcal{O}(|V||E|)$ã€‚\nä¸‹é¢æ˜¯ BFS ç‰ˆæœ¬çš„ä¼ªä»£ç ï¼š\nAlgorithm MaximumBigartiteMatching(G) initialize set M of edges // can be the empty set initialize queue Q with all the free vertices in V while not Empty(Q) do w â† Front(Q) if w Îµ V then for every vertex u adjacent to w do // u must be in U if u is free then // augment M â† M union (w, u) v â† w while v is labeled do // follow the augmenting path u â† label of v M â† M - (v, u) // (v, u) was in previous M v â† label of u M â† M union (v, u) // add the edge to the path // start over remove all vertex labels reinitialize Q with all the free vertices in V break // exit the for loop else // u is matched if (w, u) not in M and u is unlabeled then label u with w // represents an edge in E-M Enqueue(Q, u) // only way for a U vertex to enter the queue else // w Îµ U and therefore is matched with v v â† w\u0026#39;s mate // (w, v) is in M label v with w // represents in M Enqueue(Q, v) // only way for a mated v to enter Q ç›¸æ¯”äº BFSï¼ŒDFS ç‰ˆæœ¬çš„åŒˆç‰™åˆ©ç®—æ³•æ›´å®¹æ˜“å®ç°ï¼Œå®ƒ C++ ä»£ç å¯ä»¥å‚è€ƒé™„å½•ã€‚\nHopcroft-Karp Algorithm Hopcroft-Karp ç®—æ³•æ˜¯ä¸€ä¸ªä¸“ç”¨äºè§£äºŒéƒ¨å›¾æœ€å¤§åŒ¹é…é—®é¢˜çš„ç®—æ³•ï¼Œå®ƒæœ€å·®æƒ…å†µçš„æ—¶é—´å¤æ‚åº¦ä¸º $\\mathcal{O}(|E|\\sqrt{|V|})$ï¼Œæœ€å·®æƒ…å†µä¸‹çš„ç©ºé—´å¼€é”€ä¸º $\\mathcal{O}(|V|)$ã€‚\nHopcroft-Karp ç®—æ³•æ˜¯åœ¨1973å¹´ç”± Hohn Hopcroft å’Œ Richard Karp ä¸¤ä½è®¡ç®—æœºå­¦è€…å‘ç°çš„ã€‚\nå’ŒåŒˆç‰™åˆ©ç®—æ³•ä¸€æ ·ï¼ŒHopcroft-Karp ç®—æ³•åŒæ ·æ˜¯ä¸æ–­åœ°é€šè¿‡å¯»æ‰¾å¢å¹¿è·¯å¾„ï¼Œæ¥å¢å¤§éƒ¨åˆ†åŒ¹é…ã€‚ä¸åŒçš„æ˜¯ï¼ŒåŒˆç‰™åˆ©ç®—æ³•æ¯æ¬¡åªæ‰¾åˆ°ä¸€æ¡å¢å¹¿è·¯å¾„ï¼Œè€Œè¯¥ç®—æ³•åˆ™æ¯æ¬¡æ‰¾å¢å¹¿è·¯å¾„çš„ä¸€ä¸ªæœ€å¤§é›†åˆï¼Œä»è€Œæˆ‘ä»¬åªéœ€è¦è¿›è¡Œ $\\mathcal{O}(\\sqrt{|V|})$ æ¬¡è¿­ä»£ã€‚\nHopcroft-Karp ç®—æ³•å¾ªç¯ä»¥ä¸‹ä¸¤ä¸ªé˜¶æ®µï¼š\nç”¨ BFS å¯»æ‰¾ä¸‹ä¸€ä¸ªé•¿åº¦çš„å¢å¹¿è·¯å¾„ï¼Œå¹¶ä¸”èƒ½éå†è¯¥é•¿åº¦ä¸‹æ‰€æœ‰å¢å¹¿è·¯å¾„ (ä¹Ÿå°±æ˜¯ä¸Šé¢æ‰€è¯´çš„æœ€å¤§é›†åˆ)ã€‚ å¦‚æœå­˜åœ¨æ›´é•¿çš„å¢å¹¿è·¯å¾„ï¼Œå¯¹æ¯ä¸ªå¯èƒ½çš„èµ·ç‚¹ uï¼Œç”¨ DFS å¯»æ‰¾å¹¶è®°å½•å¢å¹¿è·¯å¾„ æ¯ä¸€æ¬¡å¾ªç¯ï¼ŒBFS æ‰€æ‰¾åˆ°çš„æœ€çŸ­å¢å¹¿è·¯å¾„çš„é•¿åº¦è‡³å°‘å¢åŠ 1ï¼Œæ‰€ä»¥åœ¨ $\\sqrt{|V|}$ æ¬¡å¾ªç¯ä»¥åï¼Œèƒ½æ‰¾åˆ°çš„æœ€çŸ­å¢å¹¿è·¯å¾„é•¿åº¦è‡³å°‘ä¸º $\\sqrt{|V|}$ã€‚å‡è®¾å½“å‰çš„éƒ¨åˆ†åŒ¹é…é›†åˆä¸º $M$ (è¾¹é›†)ï¼Œ$M$ å’Œæœ€å¤§åŒ¹é…çš„å¯¹ç§°å·®ç»„æˆäº†ä¸€ç»„ç‚¹ä¸ç›¸äº¤çš„å¢å¹¿è·¯å¾„å’Œäº¤æ›¿ç¯ã€‚å¦‚æœè¿™ä¸ªé›†åˆå†…æ‰€æœ‰çš„è·¯å¾„çš„é•¿åº¦éƒ½è‡³å°‘ä¸º $\\sqrt{|V|}$ï¼Œé‚£ä¹ˆæœ€å¤šåªæœ‰ $\\sqrt{|V|}$ æ¡è·¯å¾„ï¼Œé‚£ä¹ˆæœ€å¤§åŒ¹é…çš„å¤§å°ä¸ $|M|$ æœ€å¤šä¸º $\\sqrt{|V|}$ã€‚è€Œæ¯æ¬¡å¾ªç¯è‡³å°‘å°†åŒ¹é…å¤§å°å¢åŠ 1ï¼Œæ‰€ä»¥ç›´åˆ°ç®—æ³•ç»“æŸæœ€å¤šè¿˜æœ‰ $\\sqrt{|V|}$ æ¬¡å¾ªç¯ã€‚\næ¯æ¬¡å¾ªç¯ä¸­ï¼ŒBFS æœ€å¤šéå†å›¾ä¸­æ¯æ¡è¾¹ï¼ŒDFS ä¹Ÿæ˜¯æœ€å¤šéå†æ¯æ¡è¾¹ï¼Œæ‰€ä»¥æ¯ä¸€è½®å¾ªç¯çš„æ—¶é—´å¤æ‚åº¦ä¸º $\\mathcal{O}({|E|})$ï¼Œæ€»æ—¶é—´å¤æ‚åº¦ä¸º $\\mathcal{O}({|E|\\sqrt{|V|}})$ã€‚\nPseudocode /* G = U âˆª V âˆª {NIL} where U and V are partition of graph and NIL is a special null vertex */ function BFS () for each u in U if Pair_U[u] == NIL Dist[u] = 0 Enqueue(Q,u) else Dist[u] = âˆ Dist[NIL] = âˆ while Empty(Q) == false u = Dequeue(Q) if Dist[u] \u0026lt; Dist[NIL] for each v in Adj[u] if Dist[ Pair_V[v] ] == âˆ Dist[ Pair_V[v] ] = Dist[u] + 1 Enqueue(Q,Pair_V[v]) return Dist[NIL] != âˆ function DFS (u) if u != NIL for each v in Adj[u] if Dist[ Pair_V[v] ] == Dist[u] + 1 if DFS(Pair_V[v]) == true Pair_V[v] = u Pair_U[u] = v return true Dist[u] = âˆ return false return true function Hopcroft-Karp for each u in U Pair_U[u] = NIL for each v in V Pair_V[v] = NIL matching = 0 while BFS() == true for each u in U if Pair_U[u] == NIL if DFS(u) == true matching = matching + 1 return matching A Problem ä¸€ä¸ªå¯ä»¥è½¬æ¢æˆåšå®Œç¾åŒ¹é…çš„é¢˜ç›®ï¼Œé¢˜ç›®å¤§æ„ï¼š\näºŒç»´å¹³é¢ä¸Šä¸€å…± n ä¸ªäººå’Œ n ä¸ªé˜²ç©ºæ´ï¼Œç°åœ¨ä½ éœ€è¦å°† n ä¸ªäººåˆ†é…åˆ°é˜²ç©ºæ´ä¸­ï¼Œä½¿å¾—æ¯ä¸ªé˜²ç©ºæ´ä»…å®¹çº³ä¸€ä¸ªäººï¼Œå¹¶ä¸”æ‰€æœ‰äººè¿›å…¥é˜²ç©ºæ´çš„æ—¶é—´æœ€çŸ­ï¼Œå³æœ€æ™šè¿›å…¥é˜²ç©ºæ´çš„äººçš„æ—¶é—´æœ€çŸ­ã€‚ä¸€ä¸ªäººä» (X, Y) ç§»åŠ¨åˆ° (X1, Y1) æ‰€éœ€æ—¶é—´ä¸º |X - X1| + |Y - Y1|ã€‚ 1 \u0026lt;= n \u0026lt;= 100\nè¿™é“é¢˜ç›´æ¥åšæˆ‘æ²¡æœ‰æƒ³åˆ°ä»€ä¹ˆå¥½åŠæ³•ï¼Œä½†æ˜¯è§‚å¯Ÿåˆ°å¯èƒ½è§£ä¸€å®šä¸ºæŸä¸ªäººç§»åŠ¨åˆ°æŸä¸ªé˜²ç©ºæ´çš„æ—¶é—´ï¼Œæ‰€ä»¥æˆ‘ä»¬å°†æ‰€æœ‰äººç§»åŠ¨åˆ°æ‰€æœ‰é˜²ç©ºæ´çš„æ—¶é—´å…¨éƒ¨è®¡ç®—å‡ºæ¥å¹¶æ’åºã€‚\nå¯¹äºæŸä¸ªäººç§»åŠ¨åˆ°æŸä¸ªé˜²ç©ºæ´ï¼Œå‡è®¾è€—æ—¶ä¸º Tï¼Œé‚£ä¹ˆæ‰€æœ‰è€—æ—¶å°äºç­‰äº T çš„ç§»åŠ¨æ“ä½œæ˜¯å¯è¡Œçš„ã€‚æˆ‘ä»¬å»ºç«‹ä¸€å¼ äºŒéƒ¨å›¾ï¼Œå·¦è¾¹æ˜¯äººçš„é›†åˆï¼Œå³è¾¹æ˜¯é˜²ç©ºæ´çš„é›†åˆï¼Œå¯¹äºæ‰€æœ‰å¯è¡Œæ“ä½œï¼Œæˆ‘ä»¬åœ¨äºŒéƒ¨å›¾ä¸Šæ·»åŠ ä¸€æ¡å¯¹åº”çš„è¾¹ã€‚é‚£ä¹ˆå¦‚æœæ­¤æ—¶å­˜åœ¨ä¸€ç§åˆ†é…æ–¹å¼æ»¡è¶³ä¸Šè¿°æ¡ä»¶ï¼Œå®ƒåœ¨å›¾ä¸Šä¸€å®šæ˜¯ä¸€ä¸ªå®Œç¾åŒ¹é…ï¼Œè€Œç›®æ ‡å°±æ˜¯æ‰¾åˆ°è¿™æ ·æœ€å°çš„ä¸€ä¸ªTã€‚\nå¯¹äºæˆ‘ä»¬çš„äºŒéƒ¨å›¾ï¼Œæœ€å·®æƒ…å†µä¸ºå®Œå…¨äºŒéƒ¨å›¾ï¼Œå¯¹äºåŒˆç‰™åˆ©ç®—æ³•åˆ¤å®šå®Œç¾åŒ¹é…çš„æ—¶é—´å¤æ‚åº¦ä¸º $\\mathcal{O}(n^3)$ï¼ŒHopcroft-Karp ç®—æ³•ä¸º $\\mathcal{O}(n^2\\sqrt{n})$ï¼Œæ‰€ä»¥åˆ¤å®šå¤æ‚åº¦è¿˜æ˜¯æ¯”è¾ƒé«˜çš„ã€‚\nå‡å¦‚æˆ‘ä»¬ä¸€æ¡ä¸€æ¡æ·»åŠ ï¼Œä¹Ÿå°±æ˜¯æŒ‰ç…§è€—æ—¶é¡ºåºæ·»åŠ ï¼Œé‚£ä¹ˆæœ€åæƒ…å†µä¸€å…±è¦åˆ¤å®š $n^2$ æ¬¡ï¼Œè¿™å¤ªé«˜äº†ï¼Œè¿™é‡Œæ•°æ®æ¯”è¾ƒå°è¿˜å¯ä»¥ï¼Œä½†æ˜¯ä¸‡ä¸€nå¤§åˆ°1000å°±éš¾è¯´äº†ã€‚\nè¿˜è®°å¾—ä¹‹å‰æˆ‘ä»¬æè¿‡çš„å‡å°åˆ¤å®šæ¬¡æ•°çš„æ–¹å¼å˜›ï¼Ÿå¯¹ï¼ŒäºŒåˆ†æŸ¥æ‰¾ï¼Œä¸€å…±åˆ¤å®š $2\\log n$ æ¬¡ã€‚\nåœ¨è¿™é‡Œï¼Œæˆ‘ä»¬åŒæ—¶ä¹Ÿå­˜åœ¨æ¨¡æ‹Ÿå¤æ‚åº¦ï¼Œè¿™é‡Œæ¨¡æ‹Ÿä¸ºæ„é€ å¯¹åº”çš„äºŒéƒ¨å›¾ï¼Œæ¯æ¬¡æ„é€ çš„æœ€åæ—¶é—´å¤æ‚åº¦ä¸º $n^2$ï¼Œæ‰€ä»¥æ€»è®¡æ—¶é—´å¤æ‚åº¦ä¸º $\\mathcal{O}(n^3\\log n)$ æˆ–è€… $\\mathcal{O}(n^2\\sqrt{n}\\log n)$ã€‚\nä»£ç å®ç°åœ¨é™„å½•ä¸­ã€‚\nReferences [1] https://en.wikipedia.org/wiki/Hall%27s_marriage_theorem\n[2] https://math.stackexchange.com/questions/1204270/bipartite-graph-has-perfect-matching\n[3] https://en.wikipedia.org/wiki/Matching_(graph_theory)\n[4] https://en.wikipedia.org/wiki/Hopcroft%E2%80%93Karp_algorithm\n[5] https://www.topcoder.com/community/data-science/data-science-tutorials/maximum-flow-augmenting-path-algorithms-comparison/\n[6] http://www.csl.mtu.edu/cs4321/www/Lectures/Lecture%2022%20-%20Maximum%20Matching%20in%20Bipartite%20Graph.htm\nAppendix Air Defense Exercise #include \u0026lt;cstdio\u0026gt; #include \u0026lt;cstdlib\u0026gt; #include \u0026lt;iostream\u0026gt; #include \u0026lt;algorithm\u0026gt; #include \u0026lt;vector\u0026gt; #include \u0026lt;string\u0026gt; #include \u0026lt;stack\u0026gt; #include \u0026lt;cmath\u0026gt; #include \u0026lt;deque\u0026gt; #include \u0026lt;queue\u0026gt; #include \u0026lt;map\u0026gt; #include \u0026lt;bitset\u0026gt; #include \u0026lt;set\u0026gt; #include \u0026lt;list\u0026gt; #include \u0026lt;unordered_map\u0026gt; #include \u0026lt;unordered_set\u0026gt; #include \u0026lt;sstream\u0026gt; #include \u0026lt;numeric\u0026gt; #include \u0026lt;climits\u0026gt; #include \u0026lt;utility\u0026gt; #include \u0026lt;iomanip\u0026gt; #include \u0026lt;cassert\u0026gt; using namespace std; using ll = long long; using ii = pair\u0026lt;int, int\u0026gt;; using iii = pair\u0026lt;int, ii\u0026gt;; template \u0026lt;class T\u0026gt; using vv = vector\u0026lt;vector\u0026lt;T\u0026gt;\u0026gt;; #define rep(i, b) for (int i = 0; i \u0026lt; int(b); ++i) #define reps(i, a, b) for (int i = int(a); i \u0026lt; int(b); ++i) #define rrep(i, b) for (int i = int(b) - 1; i \u0026gt;= 0; --i) #define rreps(i, a, b) for (int i = int(b) - 1; i \u0026gt;= a; --i) #define repe(i, b) for (int i = 0; i \u0026lt;= int(b); ++i) #define repse(i, a, b) for (int i = int(a); i \u0026lt;= int(b); ++i) #define rrepe(i, b) for (int i = int(b); i \u0026gt;= 0; --i) #define rrepse(i, a, b) for (int i = int(b); i \u0026gt;= int(a); --i) #define all(a) a.begin(), a.end() #define rall(a) a.rbegin(), a.rend() #define sz(a) int(a.size()) #define mp(a, b) make_pair(a, b) #define inf (INT_MAX / 2) #define infl (LONG_MAX / 2) #define infll (LLONG_MAX / 2) #define X first #define Y second #define pb push_back #define eb emplace_back // tools for pair\u0026lt;int, int\u0026gt; \u0026amp; graph template \u0026lt;class T, size_t M, size_t N\u0026gt; class graph_delegate_t { T (\u0026amp;f)[M][N]; public: graph_delegate_t(T (\u0026amp;f)[M][N]) : f(f) {} T\u0026amp; operator[](const ii\u0026amp; s) { return f[s.first][s.second]; } const T\u0026amp; operator[](const ii\u0026amp; s) const { return f[s.first][s.second]; } }; ii operator+(const ii\u0026amp; lhs, const ii\u0026amp; rhs) { return mp(lhs.first + rhs.first, lhs.second + rhs.second); } // clang-format off template \u0026lt;class S, class T\u0026gt; ostream\u0026amp; operator\u0026lt;\u0026lt;(ostream\u0026amp; os, const pair\u0026lt;S, T\u0026gt;\u0026amp; t) { return os \u0026lt;\u0026lt; \u0026#34;(\u0026#34; \u0026lt;\u0026lt; t.first \u0026lt;\u0026lt; \u0026#34;,\u0026#34; \u0026lt;\u0026lt; t.second \u0026lt;\u0026lt; \u0026#34;)\u0026#34;; } template \u0026lt;class T\u0026gt; ostream\u0026amp; operator\u0026lt;\u0026lt;(ostream\u0026amp; os, const vector\u0026lt;T\u0026gt;\u0026amp; t) { os \u0026lt;\u0026lt; \u0026#34;{\u0026#34;; rep(i, t.size() - 1) { os \u0026lt;\u0026lt; t[i] \u0026lt;\u0026lt; \u0026#34;,\u0026#34;; } if (!t.empty()) os \u0026lt;\u0026lt; t.back(); os \u0026lt;\u0026lt; \u0026#34;}\u0026#34;; return os; } vector\u0026lt;string\u0026gt; __macro_split(const string\u0026amp; s) { vector\u0026lt;string\u0026gt; v; int d = 0, f = 0; string t; for (char c : s) { if (!d \u0026amp;\u0026amp; c == \u0026#39;,\u0026#39;) v.pb(t), t = \u0026#34;\u0026#34;; else t += c; if (c == \u0026#39;\\\u0026#34;\u0026#39; || c == \u0026#39;\\\u0026#39;\u0026#39;) f ^= 1; if (!f \u0026amp;\u0026amp; c == \u0026#39;(\u0026#39;) ++d; if (!f \u0026amp;\u0026amp; c == \u0026#39;)\u0026#39;) --d; } v.pb(t); return v; } void __args_output(vector\u0026lt;string\u0026gt;::iterator, vector\u0026lt;string\u0026gt;::iterator) { cerr \u0026lt;\u0026lt; endl; } template \u0026lt;typename T, typename... Args\u0026gt; void __args_output(vector\u0026lt;string\u0026gt;::iterator it, vector\u0026lt;string\u0026gt;::iterator end, T a, Args... args) { cerr \u0026lt;\u0026lt; it-\u0026gt;substr((*it)[0] == \u0026#39; \u0026#39;, it-\u0026gt;length()) \u0026lt;\u0026lt; \u0026#34; = \u0026#34; \u0026lt;\u0026lt; a; if (++it != end) { cerr \u0026lt;\u0026lt; \u0026#34;, \u0026#34;; } __args_output(it, end, args...); } #define out(args...) { vector\u0026lt;string\u0026gt; __args = __macro_split(#args); __args_output(__args.begin(), __args.end(), args); } // clang-format on const int MAX_N = 100; int n; ii p[MAX_N], h[MAX_N]; iii d[MAX_N * MAX_N]; vector\u0026lt;int\u0026gt; edges[MAX_N]; int match[MAX_N]; bool visited[MAX_N]; void link(int u, int v) { edges[u].push_back(v); } bool dfs(int u) { for (auto v : edges[u]) { if (visited[v]) continue; visited[v] = true; if (match[v] == -1 || dfs(match[v])) { match[v] = u; return true; } } return false; } bool hungarian() { int m = 0; fill_n(match, n, -1); rep(i, n) { fill_n(visited, n, false); if (dfs(i)) ++m; } return m == n; } int match_u[MAX_N], match_v[MAX_N]; int dist[MAX_N]; int NIL = MAX_N; bool bfs() { queue\u0026lt;int\u0026gt; q; rep(u, n) { if (match_u[u] == NIL) { dist[u] = 0; q.push(u); } else { dist[u] = inf; } } dist[NIL] = inf; while (!q.empty()) { auto u = q.front(); q.pop(); for (auto v : edges[u]) { if (dist[match_v[v]] == inf) { dist[match_v[v]] = dist[u] + 1; if (match_v[v] != NIL) q.push(match_v[v]); } } } return dist[NIL] != inf; } bool dfs_h(int u) { if (u == NIL) return true; for (auto v : edges[u]) { if (dist[match_v[v]] == dist[u] + 1 \u0026amp;\u0026amp; dfs_h(match_v[v])) { match_u[u] = v; match_v[v] = u; return true; } } dist[u] = inf; return false; } bool hopcraft_karp() { int m = 0; fill_n(match_u, n, NIL); fill_n(match_v, n, NIL); while (bfs()) { rep(u, n) { if (match_u[u] == NIL \u0026amp;\u0026amp; dfs_h(u)) { ++m; } } } return m == n; } bool pfmatch() { return hopcraft_karp(); } int main() { cin \u0026gt;\u0026gt; n; rep(i, n) { cin \u0026gt;\u0026gt; p[i].first \u0026gt;\u0026gt; p[i].second; } rep(i, n) { cin \u0026gt;\u0026gt; h[i].first \u0026gt;\u0026gt; h[i].second; } rep(i, n) { rep(j, n) { int idx = i * n + j; int dis = abs(p[i].X - h[j].X) + abs(p[i].Y - h[j].Y); d[idx] = {dis, {i, j}}; } } sort(d, d + n * n); int l = 0, r = n * n - 1; // binary search // time complexity: O(n^3lgn) for hungarian, // O(n^2âˆšn * lgn) for hopcroft-karp while (l \u0026lt; r \u0026amp;\u0026amp; d[l].first != d[r].first) { // replay rep(i, n) { edges[i].clear(); } int mid = (l + r) / 2; repe(i, mid) { int pi = d[i].second.first, hj = d[i].second.second; link(hj, pi); } if (pfmatch()) { r = mid; } else { l = mid + 1; } } cout \u0026lt;\u0026lt; d[l].first \u0026lt;\u0026lt; endl; return 0; } ","date":"2017-09-26T22:26:08+08:00","permalink":"https://blog.crazyark.me/p/maximum-matching-in-bipartite-graph/","title":"äºŒéƒ¨å›¾çš„æœ€å¤§åŒ¹é… (Maximum Matching in Bipartite Graph)"},{"content":"ä¸åˆ·é¢˜ä¸çŸ¥é“è‡ªå·±èœï¼Œè¶Šåˆ·é¢˜è¶Šå‘ç°è‡ªå·±ğŸ™„ â€”â€” è®° HourRank23 è¢«è™ã€‚\nSparse Table è¿˜è®°å¾—ä¸Šä¸¤ç¯‡çº¿æ®µæ ‘å’ŒBITéƒ½è®²åˆ°äº†åŒºé—´æŸ¥æ‰¾çš„é—®é¢˜ï¼Œæˆ‘ä»¬æ¥å›å¿†ä¸€ä¸‹ã€‚\nçº¿æ®µæ ‘ç©ºé—´æ”¯æŒå„ç§å‡½æ•°(Associativeï¼Œéœ€è¦æ»¡è¶³ç»“åˆå¾‹)çš„åŒºé—´æ›´æ–°å’ŒåŒºé—´æŸ¥è¯¢ï¼Œç©ºé—´å¤æ‚åº¦æ˜¯ O(nlgn)ï¼Œæ›´æ–°å’ŒæŸ¥è¯¢çš„æ—¶é—´å¤æ‚åº¦éƒ½æ˜¯ O(lgn)ã€‚\nBIT æ”¯æŒä»»æ„ç¾¤ä¸Šè¿ç®—çš„å•ç‚¹æ›´æ–°/åŒºé—´æŸ¥è¯¢ã€åŒºé—´æ›´æ–°/å•ç‚¹æŸ¥è¯¢ï¼Œç©ºé—´å¤æ‚åº¦æ˜¯ O(n)ï¼Œæ›´æ–°å’ŒæŸ¥è¯¢çš„æ—¶é—´å¤æ‚åº¦ä¹Ÿéƒ½æ˜¯ O(lgn) (å…¶å®å–å†³äºé€†å…ƒæ„é€ é€Ÿåº¦)ã€‚BIT çš„åŒºé—´æ›´æ–°/åŒºé—´æŸ¥è¯¢æ³›åŒ–éœ€è¦æ›´å¤šæ€§è´¨ï¼Œåæ­£ä¸»è¦æ˜¯ç”¨äºæ•´æ•°åŸŸä¸Šçš„å’Œè¿ç®—ã€‚\nè€Œè¿™é‡Œæ‰€è¦è®²çš„ Sparse Table æ˜¯å¦ä¸€ç§æ”¯æŒåŒºé—´æŸ¥è¯¢çš„æ•°æ®ç»“æ„ï¼Œé’ˆå¯¹çš„æ˜¯ä¸å˜çš„ï¼ˆimmutableï¼‰çš„æ•°ç»„ï¼Œå…¶ç©ºé—´å¤æ‚åº¦ä¸º O(nlgn)ã€‚\nSparse Table åŒæ ·æ”¯æŒå„ç§å‡½æ•°ï¼Œåªè¦æ˜¯æ»¡è¶³ç»“åˆå¾‹çš„å‡½æ•°ä¸€å¾‹éƒ½æ˜¯æ”¯æŒçš„ï¼Œå¯¹æ‰€æœ‰è¿™æ ·çš„å‡½æ•°ï¼Œå…¶æ—¶é—´å¤æ‚åº¦ä¸º O(nlgn)ï¼Œè€Œä¸”æ€æƒ³å’Œç¼–ç éƒ½éå¸¸ç®€å•æ˜“æ‡‚ã€‚\næ›´è¿›ä¸€æ­¥åœ°ï¼Œå¦‚æœå‡½æ•°æ˜¯å¹‚ç­‰ (Idemponent) çš„ï¼ŒSparse Tableå¯ä»¥åœ¨O(1)å†…å¾—åˆ°åŒºé—´æŸ¥è¯¢çš„ç»“æœã€‚\næ ¸å¿ƒåŸç† å‡è®¾æœ‰ä¸€ä¸ªé•¿åº¦ä¸º $N$ çš„æ•°ç»„ ${a_0, \u0026hellip;, a_{N - 1}}$ï¼Œå¹¶æœ‰ä¸€ä¸ªäºŒå…ƒå‡½æ•° $f$ï¼Œæ»¡è¶³ç»“åˆå¾‹ $f(a, f(b, c)) = f(f(a, b), c)$ã€‚\næˆ‘ä»¬ç®€è®°åŒºé—´ $[i, j]$ ä¸Šå¯¹å‡½æ•° $f$ çš„æŸ¥è¯¢ä¸º $f(a[i..j])$ã€‚\né‚£ä¹ˆ Sparse Table å°†ç”Ÿæˆè¿™æ ·ä¸€ä¸ªäºŒç»´æ•°ç»„ï¼Œè¿™ä¸ªäºŒç»´æ•°ç»„çš„å¤§å°ä¸º $N(\\lfloor\\log N\\rfloor + 1)$ã€‚æ•°ç»„çš„ç¬¬ $(i, j)$ é¡¹ä»£è¡¨äº†åŒºé—´ç»“æœ $f(a[i..i + 2^j - 1])$ï¼Œè®°ä¸º $b_{i,j}$ã€‚\nç”Ÿæˆä¸€ä¸ªè¿™æ ·çš„äºŒç»´æ•°ç»„æ˜¯å¾ˆç®€å•çš„ï¼Œå› ä¸º $f(a[i..i + 2^j - 1]) = f(f(a[i..i+2^{j-1} - 1]), f(a[i + 2^{j-1}..i + 2^j - 1]))$ï¼Œè€Œåé¢è¿™ä¸¤ä¸ªåˆ†åˆ«æ˜¯ç¬¬ $(i, j - 1)$ é¡¹å’Œç¬¬ $(i + 2^{j - 1}, j - 1)$ `é¡¹ï¼Œå¹¶ä¸” $f([i..i]) = a_i$ï¼Œæ‰€ä»¥æˆ‘ä»¬ä¸€å±‚å±‚é€’æ¨å°±è¡Œï¼Œè¿‡ç¨‹å¦‚ä¸‹\n// assuming Arr is indexed from 0 for i=0..N-1: Table[i][0] = Arr[i] // assuming N \u0026lt; 2^(k+1) for j=1..k: for i=0..N-2^j: Table[i][j] = F(Table[i][j - 1], Table[i + 2^(j - 1)][j - 1]) é‚£ä¹ˆæˆ‘ä»¬å¦‚ä½•è¿›è¡ŒæŸ¥è¯¢å‘¢ï¼Ÿå› ä¸ºå¯¹äºä¸€ä¸ªåŒºé—´ $[i, j]$ æ¥è¯´ï¼ŒåŒºé—´é•¿åº¦ $L = j - i + 1 \\le N$ æ’æˆç«‹ï¼Œæ‰€ä»¥å¦‚æœæˆ‘ä»¬å°† $L$ è¡¨ç¤ºæˆäºŒè¿›åˆ¶å½¢å¼ï¼Œ$L = 2^{q_k} + 2^{q_{k - 1}} + \u0026hellip; + 2^{q_0}$ï¼Œ é‚£ä¹ˆæœ‰\n$j = (\\cdots((i + 2^{q_k} - 1) + 2^{q_{k - 1}} - 1) + \u0026hellip; + 2^{q_0}) - 1$ï¼Œè¿™ä¸ªè¡¨ç¤ºå½¢å¼æ˜¯ä¸æ˜¯æé†’ä½ äº†å‘¢ï¼Ÿ\næ‰€ä»¥ç”¨ä»¥ä¸‹è¿‡ç¨‹æˆ‘ä»¬å¯ä»¥åœ¨ O(lgN) æ—¶é—´å†…å¾—åˆ°å‡†ç¡®ç»“æœ:\nanswer = ZERO Lâ€™ = L for i=k..0: if Lâ€™ + 2^i - 1 \u0026lt;= R: // F is associative, so this operation is meaningful answer = F(answer, Table[Lâ€™][i]) Lâ€™ += 2^i å‡è®¾æˆ‘ä»¬çš„å‡½æ•° $f$ åŒæ—¶æ˜¯å¹‚ç­‰çš„ï¼Œä¹Ÿå°±æ˜¯è¯´ $f(x, x) = x$ å¯¹æ‰€æœ‰å®šä¹‰åŸŸå†…çš„æ•°éƒ½æˆç«‹ï¼Œé‚£ä¹ˆæˆ‘ä»¬é©¬ä¸Šå°±èƒ½å¾—åˆ°\n$f(a[i..j]) = f(f(a[i..s],f(a[t..j])), i \\le t, s \\le j, t \\le s + 1$ã€‚\nè¿™æ¡æ€§è´¨å…è®¸æˆ‘ä»¬ä¸ç”¨ç²¾ç¡®åœ°åªè¦†ç›–è¯¥åŒºåŸŸä¸€æ¬¡ï¼Œè¿™æ˜¯åŠ é€Ÿåˆ° O(1) çš„å…³é”®ã€‚\nä»¤ $t$ æ˜¯æ»¡è¶³ $2^t \\le (j - i + 1)$ çš„æœ€å¤§çš„ $t$ï¼Œä¹Ÿå°±æ˜¯ $2^{t + 1} \u0026gt; (j - i + 1)$ã€‚é‚£ä¹ˆæ˜¾ç„¶ $i + 2^t - 1 \\le j$ï¼Œ$j - 2^t + 1 \\ge i$ï¼Œå¹¶ä¸”æœ‰ $j - 2^t + 1 \\le (i + 2^t - 1) + 1$ æ’æˆç«‹ã€‚\næ‰€ä»¥ $f(a[i..j]) = f(f(i..i + 2^t - 1), f(j - 2^t + 1..j))$ï¼Œåé¢ä¸¤é¡¹å°±æ˜¯ $b_{i, t}$ å’Œ $b_{j - 2^t, t}$ã€‚\nè‡³æ­¤åŸç†ä»‹ç»å®Œæ¯•ï¼Œå®ç°çš„ä»£ç åœ¨æœ€å Appendix ä¸­ã€‚\nST \u0026amp; LCA Sparse Table ä¸ä»…å¯ä»¥ç”¨äºè®¡ç®—å„ç§åŒºé—´æŸ¥è¯¢ï¼Œè¿˜å¯ä»¥ç”¨äºè®¡ç®—æ ‘ä¸Šä¸¤ä¸ªèŠ‚ç‚¹çš„æœ€è¿‘å…¬å…±ç¥–å…ˆã€‚ä½¿ç”¨STå¯ä»¥åœ¨ O(2lgH) çš„æ—¶é—´å†…è®¡ç®—å‡ºä»»æ„ä¸¤ä¸ªå‡ ç‚¹çš„æœ€è¿‘å…¬å…±ç¥–å…ˆï¼Œç©ºé—´å¤æ‚åº¦è¿˜æ˜¯ O(NlgN)ï¼Œè¿™é‡Œ N æ˜¯æ ‘ä¸ŠèŠ‚ç‚¹æ•°ï¼ŒH æ˜¯æ ‘é«˜åº¦ã€‚\nå…¶ä¸»è¦æ€æƒ³æ˜¯ç”¨æ•°ç»„å­˜æ”¾èŠ‚ç‚¹ i çš„ç¬¬ 2^j ä¸ªç¥–å…ˆï¼Œç„¶åæœç´¢ï¼Œå…·ä½“ç»†èŠ‚æœ‰å…´è¶£çš„åŒå­¦å¯ä»¥å‚è€ƒ topcoder ä¸Šå…³äºRMQå’ŒLCAçš„é‚£ç¯‡æ–‡ç« ï¼Œé“¾æ¥åœ¨å¼•ç”¨ä¸­ï¼Œè¿™é‡Œä¸å†èµ˜è¿°ã€‚\nParallel Binary Search Parallel Binary Searchï¼Œä¸­æ–‡å«æ•´ä½“äºŒåˆ†ï¼Œæˆ‘ä»¬å…ˆç”¨ä¸€ä¸ªspojä¸Šçš„é¢˜ç›®æ¥ä»‹ç»è¿™ä¸ªæ–¹æ³•ï¼Œç„¶åå†æ¥çœ‹ä¸€ä¸‹hourrankä¸Šçš„å¦ä¸€ä¸ªä¸å¤ªä¸€æ ·çš„é¢˜ç›®ã€‚\næ¥ä¸‹æ¥çš„ä¸¤ä¸ªå°èŠ‚å¤§é‡å‚è€ƒäº†codeforcesä¸Šçš„åšå®¢ï¼ŒåŸæ–‡é“¾æ¥åœ¨æ–‡ç« çš„æœ«å°¾ï¼Œæœ‰å…´è¶£çš„åŒå­¦å¯ä»¥å‰å»å­¦ä¹ ã€‚\nMotivation Problem SPOJä¸Šæœ‰è¿™æ ·ä¸€ä¸ªé¢˜ç›®ï¼šMeteorsï¼Œåœ¨è¿™é‡Œæˆ‘ç®€å•æè¿°ä¸€ä¸‹ï¼š\næœ‰ N ä¸ªå›½å®¶ï¼Œæœ‰ä¸€å—åœ†å½¢çš„åœ°æ–¹ï¼Œç­‰åˆ†æˆ M ä¸ªæ‰‡å½¢åŒºåŸŸï¼Œæ¯ä¸ªåŒºåŸŸå±äºæŸä¸€ä¸ªå›½å®¶ã€‚ç°åœ¨é¢„æŠ¥æœ‰ Q é˜µæµæ˜Ÿé›¨ï¼Œæ¯ä¸€é’ˆé™è½åœ¨æŸä¸ªæ‰‡å½¢åŒºåŸŸ [L, R]ï¼Œæ¯ä¸ªæ‰‡å½¢éƒ½è·å¾—ç›¸åŒæ•°é‡ K çš„é™¨çŸ³ã€‚å·²çŸ¥æ¯ä¸ªå›½å®¶æœ‰ä¸€ä¸ªé™¨çŸ³æ”¶é›†ç›®æ ‡ reqd[i]ï¼Œè¯·é—®æ¯ä¸ªå›½å®¶åˆ†åˆ«æœ€å°‘åœ¨å¤šå°‘é˜µæµæ˜Ÿé›¨åæ‰èƒ½æ”¶é›†åˆ°ç›®æ ‡æ•°é‡çš„é™¨çŸ³ã€‚\n1 \u0026lt;= N, M, Q\u0026lt;= 300000 1 \u0026lt;= K \u0026lt;= 1e9\nSolution å¦‚æœæˆ‘ä»¬è€ƒè™‘ä¸ä½¿ç”¨ä»»ä½•æ•°æ®ç»“æ„é€æ¬¡æ¨¡æ‹Ÿï¼Œç„¶åæ£€æŸ¥ç›®æ ‡æ˜¯å¦è¾¾åˆ°äº†ï¼Œæ›´æ–°ä»£ä»·æ˜¯O(M)ï¼Œæ£€æŸ¥çš„ä»£ä»·æ˜¯O(N + M)ï¼Œæ€»ä»£ä»· O((2M + N)Q) æ˜¯æ— æ³•æ‰¿å—çš„ã€‚\nè€Œçœ‹åˆ°åŒºé—´æ›´æ–°ï¼Œç»“åˆBlogå¼€å¤´æ‰€è®²çš„å‡ ä¸ªæ•°æ®ç»“æ„ï¼Œé€‰æ‹©BITç”¨äºæ¨¡æ‹Ÿæ›´æ–°æ˜¯æœ€åˆé€‚ä¸è¿‡çš„äº†ï¼›è¿™æ ·æˆ‘ä»¬æ›´æ–°ä»£ä»·é™åˆ°äº† O(lgM)ï¼Œä½†æ˜¯æ£€æŸ¥çš„ä»£ä»·å˜ä¸ºäº† O(MlgM)ï¼Œå¦‚æœè¿˜æ˜¯é€æ¬¡æ¨¡æ‹Ÿï¼Œæ˜¾ç„¶ä¼šæ¯”ä¹‹å‰æ›´å·®ã€‚\nåˆ°äº†è¿™é‡Œï¼Œèƒ½æƒ³åˆ°äº†ä»€ä¹ˆäº†å˜›ï¼Ÿå¯¹ï¼ŒäºŒåˆ†æŸ¥æ‰¾ï¼äºŒåˆ†æŸ¥æ‰¾ä¸å…³å¿ƒåºåˆ—ä¸­æ¯ä¸ªæ•°é•¿ä»€ä¹ˆæ ·å­ï¼Œåªéœ€è¦çŸ¥é“ï¼š\nåºåˆ—å•è°ƒ å¯ä»¥é€šè¿‡æŸç§æ–¹å¼è·å–åˆ°åºåˆ—ä¸­æŒ‡å®šä½ç½®çš„å€¼ ç„¶åï¼Œé€šè¿‡äºŒåˆ†æŸ¥æ‰¾ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨ O(lgN) çš„å€¼è·å–/æ£€æŸ¥å†…ï¼Œæ‰¾åˆ°æˆ‘ä»¬æƒ³è¦çš„ä½ç½®ã€‚\nè¿™é‡Œçš„åºåˆ—æŒ‡ä¸€ä¸ªå›½å®¶çš„æ”¶é›†æ€»æ•°ï¼Œè€Œè¿™ä¸ªæ”¶é›†æ€»æ•°ç”±æ‰‡å½¢åŒºé—´æ‰€æ„æˆçš„åºåˆ—éšå¼åœ°ååº”ï¼Œé‚£ä¹ˆé€šè¿‡äºŒåˆ†æŸ¥æ‰¾ï¼Œå¯¹æ¯ä¸ªå›½å®¶æˆ‘ä»¬åªéœ€è¦è¿›è¡Œ O(lgQ) æ¬¡æ£€æŸ¥ï¼Œå°±èƒ½çŸ¥é“æ˜¯åœ¨é‚£ä¸ªæ—¶é—´ç‚¹æ»¡è¶³æ¡ä»¶ã€‚æ‰€ä»¥æ¯ä¸ªå›½å®¶çš„æ€»è®¡æ—¶é—´å¤æ‚åº¦ä¸ºå¤§çº¦ä¸º O(logQ * Q * logM)ï¼Œè¿™é‡Œæ¯æ¬¡æ£€æŸ¥çš„æ—¶é—´ç›¸æ¯”æ›´æ–°çš„æ—¶é—´å¾®ä¸è¶³é“æ‰€ä»¥ç•¥å»äº†ã€‚æœ€ç»ˆå¤æ‚åº¦ä¸º O(N * log Q * Q * logM)ã€‚\nå¯ä»¥çœ‹åˆ°ï¼Œä¸Šé¢çš„å¤æ‚åº¦è¿˜æ˜¯å¤ªé«˜ï¼Œæ¯”ç›´æ¥æ¨¡æ‹Ÿè¿˜æ˜¯é«˜äº†å¾ˆå¤šï¼Œé‚£æ€ä¹ˆåŠå‘¢ï¼Ÿ\nç¨å¾®æƒ³ä¸€æƒ³ï¼Œæ¯æ¬¡æ¨¡æ‹Ÿçš„ä»£ä»·è™½ç„¶é™ä½äº†ï¼Œä½†æ˜¯æ¨¡æ‹Ÿçš„æ•°é‡ä¸Šå‡åˆ°äº† O(NlgQ) æ¬¡ï¼Œè™½ç„¶æ£€æŸ¥çš„æ¬¡æ•°ä¹Ÿé™ä½äº†ï¼Œä½†æ˜¯è·Ÿæ¨¡æ‹Ÿçš„è€—æ—¶ç›¸æ¯”ï¼Œä½çš„éƒ½è¢«ç•¥æ‰äº† \u0026hellip; æ‰€ä»¥å½“åŠ¡ä¹‹æ€¥æ˜¯åŒæ—¶èƒ½é™ä½æ¨¡æ‹Ÿçš„å¼€é”€ã€‚\næ˜¯ä¸æ˜¯æ„Ÿè§‰æœ‰ç‚¹å¥¢ä¾ˆï¼Ÿæ¯æ¬¡æˆ‘å°±æ£€æŸ¥é‚£ä¹ˆä¸€ä¸‹ï¼Œå°±è¦æ¨¡æ‹Ÿä¸€æ•´è½®ï¼Œè™½ç„¶æˆ‘å¼€é”€å°ï¼Œä¹Ÿæ¶ä¸ä½ä½ çƒ§CPUç©å•Šã€‚\nå…¶å®æ¯ä¸ªå›½å®¶çš„äºŒåˆ†æŸ¥æ‰¾ç»å†æ˜¯å¾ˆç±»ä¼¼çš„ï¼Œåœ¨æ•´ä¸ªæ¨¡æ‹Ÿå‡ºæ¥çš„åºåˆ—é‡Œé¢æ‰¾åˆ°é‚£ä¸€ç‰‡è¦çš„ï¼Œç„¶åæ£€æŸ¥ä¸€ä¸‹æˆ‘ä»¬å°±ä¸‹ä¸€è½®äº†ã€‚é‚£ä¹ˆï¼Œæ—¢ç„¶ä¸€æ•´è½®æ¨¡æ‹Ÿéƒ½åšå®Œäº†ï¼Œèƒ½ä¸èƒ½è®©æ¯ä¸ªå›½å®¶éƒ½æ£€æŸ¥å®Œï¼Œç„¶åæˆ‘ä»¬å†å¼€ä¸‹ä¸€è½®å¥½ä¸å¥½ï¼Ÿ\nè¿™å°±æ˜¯ Parallel Binary Search çš„æ ¸å¿ƒæ€æƒ³ï¼šé€šè¿‡ä¸€è½®æ¨¡æ‹Ÿå®Œæˆæ‰€æœ‰å›½å®¶çš„è¿™ä¸€æ­¥æŸ¥æ‰¾ï¼Œä»è€Œå°†æ¨¡æ‹Ÿæ€»æ•°å‡å°‘åˆ°äº† O(lgQ) æ¬¡ï¼Œå·¨å¤§çš„è¿›æ­¥ï¼\nå…·ä½“æ–¹æ³•æ˜¯ï¼Œå¼€ä¸¤ä¸ªé•¿åº¦ä¸ºNçš„æ•°ç»„ï¼Œå¯¹æ¯ä¸€ä¸ªå›½å®¶ï¼Œè®°å½•å®ƒå½“å‰çš„ L å’Œ Rï¼›å¯¹äºæ¯ä¸€ä¸ªè¦æ£€æŸ¥çš„ midï¼Œå¼€ä¸€ä¸ªé“¾è¡¨è®°å½•å½“å‰éœ€è¦æ£€æŸ¥ mid å€¼çš„å›½å®¶ï¼›å…¶ä½™è¿‡ç¨‹ç”¨ä¸‹åˆ—ä¼ªä»£ç æè¿°ï¼š\nfor all logQ steps: clear range tree and linked list check for all member states i: if L[i] != R[i]: mid = (L[i] + R[i]) / 2 insert i in check[mid] for all queries q: apply(q) for all member states m in check[q]: if m has requirements fulfilled: R[m] = q else: L[m] = q + 1 ä¸Šè¿°è¿‡ç¨‹ä¸­ï¼Œapply() å‡½æ•°çš„ä½œç”¨æ˜¯ï¼Œè¿›è¡Œæ¨¡æ‹Ÿï¼Œç„¶åæ£€æŸ¥éœ€è¦æ£€æŸ¥çš„å›½å®¶æ˜¯å¦æ»¡è¶³æ¡ä»¶äº†ã€‚\nè¿™æ ·å­ï¼Œæ¨¡æ‹Ÿçš„ä»£ä»·æ€»è®¡ä¸º O(lgQ * Q * lgM)ï¼Œæ£€æŸ¥çš„ä»£ä»·æ€»è®¡ä¸º O(lgQ * (MlgM + N))ï¼Œæˆ‘ä»¬æˆåŠŸåœ°åŒæ—¶å°†æ¨¡æ‹Ÿå’Œæ£€æŸ¥çš„ä»£ä»·éƒ½å‡å°äº†ï¼è¿™æ ·çš„æ—¶é—´å¤æ‚åº¦æ€»å…±ä¸º O(lgQ * (Q + M) * lgM)ï¼Œè‡³äºå°‘çš„é‚£ä¸ªNï¼Œå¿½ç•¥ä¸è®¡~\nåŒåŸæ–‡ä¸€æ ·ï¼Œè¿™é‡Œå¼•ä¸€å¥å¤§ä½¬çš„è¯è§£é‡Šè¿™ä¸ª Parallel Binary Searchï¼Œ\n\u0026ldquo;A cool way to visualize this is to think of a binary search tree. Suppose we are doing standard binary search, and we reject the right interval â€” this can be thought of as moving left in the tree. Similarly, if we reject the left interval, we are moving right in the tree. So what Parallel Binary Search does is move one step down in N binary search trees simultaneously in one \u0026ldquo;sweep\u0026rdquo;, taking O(Nâ€‰*â€‰X) time, where X is dependent on the problem and the data structures used in it. Since the height of each tree is LogN, the complexity is O(Nâ€‰*â€‰Xâ€‰*â€‰logN).\u0026rdquo; â€” rekt_n00b\nHourrank23 \u0026ndash; Selective Additions è¿™æ˜¯ä¸€é“è¢«è¯…å’’çš„é¢˜ç›®\u0026hellip;æŠ±æ­‰å®åœ¨æ²¡å¿ä½ğŸ¤£\nè¿™é“é¢˜ç›®æ˜¯è¿™æ ·çš„ï¼š\næœ‰ä¸€ä¸ªæ•°ç»„ï¼Œé•¿åº¦ä¸ºNï¼Œç°åœ¨è¦è¿›è¡Œ M æ¬¡åŒºé—´æ›´æ–°ï¼Œéƒ½æ˜¯åŠ ä¸€ä¸ªæ­£æ•°ã€‚ä½†æ˜¯æˆ‘æœ‰ K ä¸ªå¾ˆå–œæ¬¢çš„æ•°å­—ï¼Œä¸€æ—¦æ•°ç»„ä¸­æŸä¸ªå…ƒç´ æˆä¸ºæˆ‘å–œæ¬¢çš„æ•°å­—ï¼Œå¯¹å®ƒçš„æ›´æ–°å°±æ— æ•ˆï¼Œå®ƒå°†ä¸€ç›´ä¿æŒé‚£ä¸ªæ•°å­—ã€‚ é—®æ¯è½®æ›´æ–°åçš„æ•°ç»„å’Œã€‚\n1 \u0026lt;= N, M \u0026lt;= 1e5 1 \u0026lt;= k \u0026lt;= 5\nè¿™é“é¢˜å’Œä¸Šé“é¢˜ä¸å¤ªä¸€æ ·ï¼Œæ£€æŸ¥çš„ä»£ä»·ä½ã€æ£€æŸ¥ç›®æ ‡å’ŒåŸåŒºé—´ç›¸åŒï¼Œè€Œä¸”ç›®æ ‡å˜æˆäº†å¤šä¸ªã€‚\nç›®æ ‡æ˜¯å¤šä¸ªå¯ä»¥è¿™æ ·è§£å†³ï¼šå¯¹å–œæ¬¢çš„æ•°æ’åºï¼Œå› ä¸ºæ°¸è¿œæ˜¯æ­£çš„æ›´æ–°ï¼Œæ‰€ä»¥å…ˆåˆ°è¾¾å‰ä¸€ä¸ªåä¸€ä¸ªå°±ä¸ç”¨æ£€æŸ¥äº†ã€‚\né‡‡ç”¨ä¸Šè¿°çš„ PBS çš„æ–¹æ³•ï¼Œè¿™é¢˜çš„å¤æ‚åº¦åœ¨ O(k(n + m)lognlogm)ï¼Œæ˜¯ä¸€ä¸ªå¾ˆå¥½çš„å¤æ‚åº¦äº†ã€‚\nä½†æ˜¯ï¼Œè¿™é‡Œä¸€å®šè¦æœ‰ä¸ªä½†æ˜¯ï¼Œå› ä¸ºæ£€æŸ¥çš„ä»£ä»·å¾ˆä½ï¼Œæ‰€ä»¥è¿™é¢˜çš„äºŒåˆ†æŸ¥æ‰¾ä¸æ˜¯å¿…é¡»çš„ï¼Œæˆ‘ç¿»é˜…äº†å¤§é‡å¤§ä½¬çš„ä»£ç å’Œeditorialï¼Œæœ‰ç”¨PBSçš„ï¼Œæœ‰æ¨¡æ‹Ÿæ—¶é—´åºåˆ—çš„ï¼Œæœ‰ç”¨Segment treeåŠ trickçš„ï¼Œå„ç§å„æ ·ï¼Œæˆ‘æ¥ä¸€ä¸ªä¸ªä»‹ç»ä¸€ä¸‹ï¼š\nPBS è¿™ä¸ªä¸å¤šè¯´äº†ï¼Œç¦»çº¿æ¨¡æ‹Ÿ logm éã€‚\nTime Series Simulation ä»£ç : https://www.hackerrank.com/rest/contests/hourrank-23/challenges/selective-additions/hackers/nuipqiun/download_solution\nåŒæ ·æ˜¯ç¦»çº¿å¤„ç†ï¼Œä½†æ˜¯è¿™ä¸ªå¤§ä½¬çš„æ¨¡æ‹Ÿæ–¹å¼å¾ˆç‰¹åˆ«ï¼Œä»–æ˜¯åœ¨æ—¶é—´åºåˆ—ä¸Šæ¨¡æ‹Ÿæ•°ç»„å½“å‰é¡¹çš„å€¼ï¼Œæˆ‘è¿˜æ˜¯ç¬¬ä¸€æ¬¡è§ã€‚\né¦–å…ˆè¿˜è®°å¾— BIT çš„åŒºé—´æ›´æ–°æ–¹å¼ä¹ˆï¼Œåœ¨lå¤„åŠ deltaï¼Œr + 1å¤„å‡å»deltaã€‚å‡è®¾è€ƒè™‘åŒºé—´æ›´æ–°éƒ½æ˜¯ [l, n] çš„ï¼Œé‚£ä¹ˆåœ¨æ—¶é—´åºåˆ—ä¸Šæ¨¡æ‹Ÿ i-th æ•°ç»„é¡¹ çš„å€¼å°±å¾ˆå®¹æ˜“æƒ³åˆ°äº†ï¼šå¯¹äºåœ¨ i ä»¥åŠä¹‹å‰çš„æ›´æ–°(j, a, b, delta) (a \u0026lt;= i), åœ¨æ—¶é—´åºåˆ—å¯¹åº”æ•°ç»„çš„ jå¤„åŠ deltaã€‚è¿™æ ·jæ—¶é—´ä¹‹åçš„æ•°éƒ½è¢«åŠ äº†deltaã€‚\næƒ³åˆ°è¿™é‡Œï¼Œæ—¶é—´åºåˆ—ä¸Šçš„æ¨¡æ‹Ÿå°±å‘¼ä¹‹æ¬²å‡ºäº†ï¼Œæ—¢ç„¶å¯¹åº”æœ‰åŠ ï¼Œè‚¯å®šå¯¹åº”æœ‰å‡ï¼šå¯¹äº i ä»¥åŠ i ä¹‹å‰çš„æ‰€æœ‰æ›´æ–° (j, a, b, delta) (b \u0026lt; i)ï¼Œåœ¨åºåˆ—ä¸ŠæŠµæ¶ˆæ‰ï¼Œä¹Ÿå³åœ¨æ—¶é—´åºåˆ—jå¤„å‡deltaï¼Œå› ä¸ºè¿™æ ·çš„æ›´æ–°ä¸åº”è¯¥å½±å“åˆ°æ•°ç»„é¡¹ i çš„æ—¶é—´åºåˆ—ï¼Œè€Œä¸”ä¸€å®šåœ¨ä¹‹å‰è¢«æ›´æ–°ä¸Šå»äº†ã€‚\næ‰€ä»¥å°±å˜æˆäº†è¿™æ ·ä¸€ç§æ–¹å¼ï¼š\nrep(i,n){ for(int j:ad[i]) add(j,ads[j]); for(int j:rm[i]) add(j,-ads[j]); // do you work } è¿™é‡Œï¼Œad[i] æ˜¯ [i, r] æ›´æ–°çš„ç´¢å¼•å·ï¼Œrm[i] æ˜¯ [l, i - 1] æ›´æ–°çš„ç´¢å¼•å·ï¼Œadd æ“ä½œæ˜¯fenwick treeçš„åŠ æ“ä½œï¼Œäºæ˜¯æˆ‘ä»¬å¯ä»¥ç”¨sum(j)è®¡ç®—å‡ºä»»ä¸€ä¸ªæ—¶é—´èŠ‚ç‚¹ä¸Ša[i]çš„å€¼ã€‚\nåé¢å°±å¾ˆç®€å•äº†ï¼Œå¯¹æ¯ä¸ªiäºŒåˆ†æŸ¥æ‰¾ï¼Œæ‰¾åˆ°å°±è®°ä¸‹æ¥ã€‚æ€»è®¡æ—¶é—´å¤æ‚åº¦åº”è¯¥ä¸º O((kn + m)logm)ã€‚\nè¿™é‡Œæ˜æ˜¾æ¯” PBS å¿«äº†ä¸€ç‚¹ï¼Œè¿™æ˜¯å› ä¸ºæ£€æŸ¥åŒºé—´å’ŒåŸåŒºé—´ä¸€è‡´ã€‚è¿™ä»¶äº‹æƒ…å¾ˆé‡è¦ï¼Œç±»æ¯”åˆ° Meteorsï¼Œè™½ç„¶æˆ‘ä»¬ä¹Ÿèƒ½æ¨¡æ‹Ÿå‡ºä¸€ä¸ªåŒºé—´çš„æ—¶é—´åºåˆ—ï¼Œä½†æ˜¯ä¸€ä¸ªåŒºé—´å¯¹äºç›®æ ‡æ²¡æœ‰æ„ä¹‰ã€‚\nSegment Tree ä¸ä¸Šé¢ä¸¤ä¸ªä¸åŒçš„æ˜¯ï¼Œè¿™æ˜¯ä¸ªåœ¨çº¿ç®—æ³•ã€‚\næ—¶é—´å¤æ‚åº¦æ˜¯ O(klgm(n + m))ï¼Œä¸è¿‡ç”¨äº†çº¿æ®µæ ‘ï¼Œç©ºé—´å¤æ‚åº¦ä¸º O(kmlgm)ã€‚\nè¿™é‡Œçº¿æ®µæ ‘ä¸­è®°å½•äº†ä¸‰ä¸ªå€¼ï¼šlazyåŸŸaddï¼ŒåŒºé—´æœ€å¤§å€¼maxiï¼Œå¯¹åº”çš„æ•°ç»„ç´¢å¼•idã€‚\nä¸€å…±kæ£µçº¿æ®µæ ‘ï¼Œæ¯é¢—çº¿æ®µæ ‘åˆå§‹åŒ–ä¸ºæ•°ç»„ {a_i - fav_j}ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œå¯¹åº”çš„å€¼å¦‚æœä¸ºæ­£æ•°ï¼Œæ‰æœ‰æ£€æŸ¥çš„å¿…è¦ï¼Œå¦‚æœä¸ºè´Ÿæ•°ï¼Œé‚£å‹æ ¹è¿˜æ²¡åˆ°æ£€æŸ¥çš„æ—¶å€™ã€‚\næ­£å·§ï¼Œåˆ©ç”¨çº¿æ®µæ ‘çš„ç»“æ„ï¼Œæˆ‘ä»¬æ£€æŸ¥çº¿æ®µæ ‘çš„rootèŠ‚ç‚¹å°±èƒ½çŸ¥é“è¿™æ£µæ ‘ä¸­å­˜ä¸å­˜åœ¨éœ€è¦æ£€æŸ¥çš„é¡¹ï¼Œè¿™ä¸ªæ“ä½œæ˜¯ O(1) çš„ã€‚è€Œå½“ä¸€ä¸ªæ•°ç»„é¡¹è¢«æ£€æŸ¥è¿‡åï¼Œå®ƒå°†è¢«èµ‹å€¼ä¸º -infï¼Œè¿™æ ·å®ƒæ°¸è¿œä¹Ÿä¸ä¼šè¢«å†æ¬¡æ£€æŸ¥ï¼Œçº¿æ®µæ ‘ä¹Ÿé¡ºåˆ©æ›´æ–°åˆ°ä¸‹ä¸€ä¸ªå¾…æ£€æŸ¥çŠ¶æ€ã€‚\nç”±äºæ¯ä¸ªæ•°ç»„é¡¹å¯¹äºæ¯ä¸ªfavoriteæœ€å¤šè¢«æ£€æŸ¥ä¸€æ¬¡ï¼Œæ‰€ä»¥æ€»è®¡æ£€æŸ¥å¤æ‚åº¦ä¸º O(knlgm)ã€‚\næ›´æ–°å¤æ‚åº¦æ˜¯ O(kmlgm)ï¼Œæ‰€ä»¥æ€»è®¡å¤æ‚åº¦ä¸º O(k(m + n)lgm)ã€‚\nè¿™é‡Œåˆ©ç”¨Segment Treeçš„trickä¸€å¼€å§‹è®©æˆ‘ç™¾æ€ä¸å¾—å…¶è§£ï¼Œä¸ºä»€ä¹ˆmeteorsä¸è¡Œè€Œè¿™é‡Œå¯ä»¥ï¼Œæƒ³æ¥æƒ³å»ä¹Ÿæƒ³ä¸å‡ºç¬¬ä¸‰ç§æ–¹å¼ï¼ŒæŠŠmeteorsçš„æŸ¥è¯¢åŒºé—´æ˜ å°„åˆ°æ–¹ä¾¿ä¿®æ”¹çš„ç»“æ„ä¸Šï¼Œæ‰€ä»¥è¿˜æ˜¯å½’ç»“ä¸ºä¹‹å‰æ‰€è¿°çš„ä¸¤ä¸ªåŸå› ã€‚\nConclusion å¯¹äºæ›´æ–°/æŸ¥è¯¢çš„ä¸€ç³»åˆ—é—®é¢˜ï¼Œä¸šç•Œå¤§ä½¬ä»¬å·²ç»æä¾›äº†å„ç§å„æ ·æœ‰åŠ›çš„æ­¦å™¨ï¼š\næ•°æ®ç»“æ„ Segment treeã€Fenwick treeã€Sparse tableï¼Œè¿˜æœ‰æœ€è¿‘æ‰ç ”ç©¶åˆ°çš„ Cartesian tree ç­‰ç­‰ äºŒåˆ†ã€æ•´ä½“äºŒåˆ†ã€è¿˜æ²¡çœ‹è¿‡çš„ CDQ åˆ†æ²»ç­‰ç­‰ æŠŠè¿™é‡Œæ•´ç†è¿›è„‘å­é‡Œï¼Œå¤§æ¦‚ä¸‹æ¬¡åˆ·é¢˜çš„æ—¶å€™åº•æ°”ä¹Ÿä¼šè¶³ä¸€äº›ğŸº\nReference [1] https://www.hackerearth.com/practice/notes/sparse-table/\n[2] https://www.topcoder.com/community/data-science/data-science-tutorials/range-minimum-query-and-lowest-common-ancestor/#Sparse_Table_(ST)_algorithm\n[3] http://codeforces.com/blog/entry/45578\n[4] https://ideone.com/tTO9bD\nAppendix Impl ST/C++ #include \u0026lt;vector\u0026gt; #include \u0026lt;cassert\u0026gt; #include \u0026lt;cstring\u0026gt; #include \u0026lt;iostream\u0026gt; #include \u0026lt;limits\u0026gt; #include \u0026lt;type_traits\u0026gt; #include \u0026lt;random\u0026gt; using namespace std; namespace st_impl { template \u0026lt;class T, class F\u0026gt; class SparseTable { public: typedef F func_type; typedef unsigned size_type; typedef T value_type; SparseTable(const vector\u0026lt;T\u0026gt;\u0026amp; init) : _size(init.size()), _idx_size(flsl(_size)) { table.resize(_size); for (auto\u0026amp; row : table) { row.resize(_idx_size, func_type::default_value); } // initialize sparse table for (size_type i = 0; i \u0026lt; _size; ++i) { table[i][0] = init[i]; } for (size_type j = 1; j \u0026lt; _idx_size; ++j) { for (size_type i = 0; i \u0026lt;= _size - (1 \u0026lt;\u0026lt; j); ++i) { table[i][j] = f(table[i][j - 1], table[i + (1 \u0026lt;\u0026lt; (j - 1))][j - 1]); } } } SparseTable(const initializer_list\u0026lt;T\u0026gt;\u0026amp; init) : SparseTable(vector\u0026lt;T\u0026gt;(init)) {} SparseTable(const vector\u0026lt;T\u0026gt;\u0026amp; init, F f) : SparseTable(init) { this-\u0026gt;f = f; } SparseTable(const initializer_list\u0026lt;T\u0026gt;\u0026amp; init, F f) : SparseTable(vector\u0026lt;T\u0026gt;(init), f) {} T rangeQuery(size_type l, size_type r) const { if (!(l \u0026lt;= r \u0026amp;\u0026amp; r \u0026lt; _size)) { throw std::out_of_range(\u0026#34;Bad query!\u0026#34;); } // if the function is idempotent, which means f(x, x) = x holds for // all x with definition, then we can deduce that // f(range(l, s), range(t, r)) == f(range(l, r)) always // holds for all l, s, t, r which satisfies l \u0026lt;= t \u0026amp;\u0026amp; s \u0026lt;= r \u0026amp;\u0026amp; t \u0026lt;= s + 1 // then rangeQuery will be executed in O(1). // otherwise it should be finished in O(lgN). if (func_type::idempotent) { size_type idx = flsl(r - l + 1) - 1; return f(table[l][idx], table[r - (1 \u0026lt;\u0026lt; idx) + 1][idx]); } else { T res = func_type::default_value; for (size_type i = 0; i \u0026lt; _idx_size; ++i) { size_type idx = _idx_size - 1 - i; if (l + (1 \u0026lt;\u0026lt; idx) - 1 \u0026lt;= r) { res = f(res, table[l][idx]); l += 1 \u0026lt;\u0026lt; idx; } } return res; } } private: func_type f; size_type _size; size_type _idx_size; vector\u0026lt;vector\u0026lt;T\u0026gt;\u0026gt; table; }; } // namespace st_impl template \u0026lt;class T, T v = T{}\u0026gt; struct sum_f { static constexpr T default_value = v; static constexpr bool idempotent = false; T operator()(const T\u0026amp; a, const T\u0026amp; b) const { return a + b; } }; template \u0026lt;class T, T v\u0026gt; constexpr const T sum_f\u0026lt;T, v\u0026gt;::default_value; template \u0026lt;class T, T v = numeric_limits\u0026lt;T\u0026gt;::min(), typename = typename enable_if\u0026lt;numeric_limits\u0026lt;T\u0026gt;::is_specialized\u0026gt;::type\u0026gt; struct max_f { static constexpr T default_value = v; static constexpr bool idempotent = true; T operator()(const T\u0026amp; a, const T\u0026amp; b) const { return max(a, b); } }; template \u0026lt;class T, T v, typename R\u0026gt; constexpr const T max_f\u0026lt;T, v, R\u0026gt;::default_value; template \u0026lt;class T, T v = numeric_limits\u0026lt;T\u0026gt;::max(), typename = typename enable_if\u0026lt;numeric_limits\u0026lt;T\u0026gt;::is_specialized\u0026gt;::type\u0026gt; struct min_f { static constexpr T default_value = v; static constexpr bool idempotent = true; T operator()(const T\u0026amp; a, const T\u0026amp; b) const { return min(a, b); } }; template \u0026lt;class T, T v, typename R\u0026gt; constexpr const T min_f\u0026lt;T, v, R\u0026gt;::default_value; uint64_t gcd(uint64_t a, uint64_t b) { if (a \u0026lt; b) swap(a, b); while (b != 0) { auto t = b; b = a % b; a = t; } return a; } template \u0026lt;class T, T v = T{}, typename = typename enable_if\u0026lt;numeric_limits\u0026lt;T\u0026gt;::is_integer\u0026gt;::type\u0026gt; struct gcd_f { static constexpr T default_value = v; static constexpr bool idempotent = true; T operator()(const T\u0026amp; a, const T\u0026amp; b) const { return gcd(a, b); } }; template \u0026lt;class T, T v, typename R\u0026gt; constexpr const T gcd_f\u0026lt;T, v, R\u0026gt;::default_value; template \u0026lt;class T, class F = max_f\u0026lt;T\u0026gt;\u0026gt; using SparseTable = st_impl::SparseTable\u0026lt;T, F\u0026gt;; template \u0026lt;class F\u0026gt; void random_test(string target_func) { int n = 400; vector\u0026lt;int\u0026gt; test(n); // generate random numbers random_device r; default_random_engine eng(r()); uniform_int_distribution\u0026lt;int\u0026gt; uniform_dist(0, 2000); for (int i = 0; i \u0026lt; n; ++i) { test[i] = uniform_dist(eng); } // query and verify F f; SparseTable\u0026lt;int, F\u0026gt; st_test(test, f); cout \u0026lt;\u0026lt; \u0026#34;Begin random test on \u0026#34; \u0026lt;\u0026lt; target_func \u0026lt;\u0026lt; \u0026#34;!\u0026#34; \u0026lt;\u0026lt; endl; int t = 10; for (int i = 0; i \u0026lt; t; ++i) { int l = uniform_dist(eng) % n, r = l + ((uniform_dist(eng) % (n - l)) \u0026gt;\u0026gt; (i / 2)); auto to_verify = st_test.rangeQuery(l, r); auto expected = decltype(f)::default_value; for (int j = l; j \u0026lt;= r; ++j) { expected = f(expected, test[j]); } assert(to_verify == expected); cout \u0026lt;\u0026lt; \u0026#34; + query range(\u0026#34; \u0026lt;\u0026lt; l \u0026lt;\u0026lt; \u0026#34;,\u0026#34; \u0026lt;\u0026lt; r \u0026lt;\u0026lt; \u0026#34;)\\t= \u0026#34; \u0026lt;\u0026lt; to_verify \u0026lt;\u0026lt; endl; } cout \u0026lt;\u0026lt; \u0026#34;Test passed!\u0026#34; \u0026lt;\u0026lt; endl; } void regular_test() { SparseTable\u0026lt;int\u0026gt; st_max({3, 1, 2, 5, 2, 10, 8}); assert(st_max.rangeQuery(0, 2) == 3); assert(st_max.rangeQuery(3, 6) == 10); assert(st_max.rangeQuery(0, 6) == 10); assert(st_max.rangeQuery(2, 4) == 5); SparseTable\u0026lt;int, min_f\u0026lt;int\u0026gt;\u0026gt; st_min({3, 1, 2, 5, 2, 10, 8}); assert(st_min.rangeQuery(0, 2) == 1); assert(st_min.rangeQuery(3, 6) == 2); assert(st_min.rangeQuery(0, 6) == 1); assert(st_min.rangeQuery(2, 4) == 2); SparseTable\u0026lt;int, sum_f\u0026lt;int\u0026gt;\u0026gt; st_sum({3, 1, 2, 5, 2, 10, 8}); assert(st_sum.rangeQuery(0, 2) == 6); assert(st_sum.rangeQuery(3, 6) == 25); assert(st_sum.rangeQuery(0, 6) == 31); assert(st_sum.rangeQuery(2, 4) == 9); } int main() { regular_test(); random_test\u0026lt;max_f\u0026lt;int\u0026gt;\u0026gt;(\u0026#34;max\u0026#34;); random_test\u0026lt;min_f\u0026lt;int\u0026gt;\u0026gt;(\u0026#34;min\u0026#34;); random_test\u0026lt;sum_f\u0026lt;int\u0026gt;\u0026gt;(\u0026#34;sum\u0026#34;); random_test\u0026lt;gcd_f\u0026lt;int\u0026gt;\u0026gt;(\u0026#34;gcd\u0026#34;); return 0; } Selective Additions / PBS C++ #include \u0026lt;iostream\u0026gt; #include \u0026lt;cstdio\u0026gt; #include \u0026lt;cstdlib\u0026gt; #include \u0026lt;algorithm\u0026gt; #include \u0026lt;vector\u0026gt; #include \u0026lt;climits\u0026gt; #include \u0026lt;utility\u0026gt; #include \u0026lt;queue\u0026gt; #include \u0026lt;map\u0026gt; using namespace std; #define defv(alias, type) using v##alias = vector\u0026lt;type\u0026gt; #define defvv(alias, type) using vv##alias = vector\u0026lt;vector\u0026lt;type\u0026gt;\u0026gt; using ii = pair\u0026lt;int, int\u0026gt;; using iii = pair\u0026lt;int, ii\u0026gt;; defv(i, int); defvv(i, int); defv(ii, ii); defvv(ii, ii); #define forall(i, a, b) for (int i = int(a); i \u0026lt; int(b); ++i) #define all(a) a.begin(), a.end() #define inf (IMAX_NT_MAX / 2) #define sz(a) int(a.size()) #define mp(a, b) make_pair(a, b) const int MAX_N = 1e5 + 5; long a[MAX_N], d[MAX_N]; int l[MAX_N], r[MAX_N]; long f[5]; int n, m, k; long fen[MAX_N]; int lowbit(int x) { return x \u0026amp; -x; } void fen_update(long *fen, int idx, int delta) { for (int i = idx; i \u0026lt; n; i += lowbit(i + 1)) { fen[i] += delta; } } long __fen_get(long *fen, int r) { long res = 0; while (r \u0026gt;= 0) { res += fen[r]; r -= lowbit(r + 1); } return res; } long fen_get(long *fen, int l, int r) { return __fen_get(fen, r) - __fen_get(fen, l - 1); } void fen_range_update(long *fen, int l, int r, int delta) { fen_update(fen, l, delta); fen_update(fen, r + 1, -delta); } long fen_point_get(long *fen, int i) { return __fen_get(fen, i); } void fen_reset(long *fen) { forall(i, 0, n) fen[i] = 0; } inline int fls(int x) { int r = 32; if (!x) return 0; if (!(x \u0026amp; 0xffff0000u)) { x \u0026lt;\u0026lt;= 16; r -= 16; } if (!(x \u0026amp; 0xff000000u)) { x \u0026lt;\u0026lt;= 8; r -= 8; } if (!(x \u0026amp; 0xf0000000u)) { x \u0026lt;\u0026lt;= 4; r -= 4; } if (!(x \u0026amp; 0xc0000000u)) { x \u0026lt;\u0026lt;= 2; r -= 2; } if (!(x \u0026amp; 0x80000000u)) { x \u0026lt;\u0026lt;= 1; r -= 1; } return r; } int t[MAX_N], lb[MAX_N], rb[MAX_N]; vector\u0026lt;int\u0026gt; to_check[MAX_N + 1]; void solve() { sort(f, f + k); fill_n(t, n, -1); forall(i, 0, n) forall(s, 0, k) { if (t[i] \u0026lt; 0 \u0026amp;\u0026amp; a[i] == f[s]) t[i] = 0; } // Parallel Binary Search for (int s = 0; s \u0026lt; k; ++s) { forall(i, 0, n) if (t[i] \u0026lt; 0) { lb[i] = 1, rb[i] = m; } forall(rnd, 0, fls(m)) { fen_reset(fen); forall(i, 0, m + 1) to_check[i].clear(); forall(i, 0, n) { if (t[i] \u0026lt; 0) to_check[(lb[i] + rb[i]) \u0026gt;\u0026gt; 1].push_back(i); } forall(i, 0, m) { fen_range_update(fen, l[i], r[i], d[i]); for (int idx : to_check[i + 1]) { auto now = fen_point_get(fen, idx); if (now + a[idx] \u0026gt; f[s]) rb[idx] = i; else if (now + a[idx] \u0026lt; f[s]) lb[idx] = i + 2; else t[idx] = i + 1; } } } } // reuse fen for counting invalid updates long sum = 0; fen_reset(fen); forall(i, 0, m + 1) to_check[i].clear(); forall(i, 0, n) { if (t[i] == 0) fen_update(fen, i, 1); else if (t[i] \u0026gt; 0) to_check[t[i]].push_back(i); sum += a[i]; } forall(i, 0, m) { sum += d[i] * (r[i] - l[i] + 1 - fen_get(fen, l[i], r[i])); cout \u0026lt;\u0026lt; sum \u0026lt;\u0026lt; endl; for (auto idx : to_check[i + 1]) { fen_update(fen, idx, 1); } } } int main() { cin \u0026gt;\u0026gt; n \u0026gt;\u0026gt; m \u0026gt;\u0026gt; k; forall(i, 0, n) { cin \u0026gt;\u0026gt; a[i]; } forall(i, 0, k) { cin \u0026gt;\u0026gt; f[i]; } forall(i, 0, m) { cin \u0026gt;\u0026gt; l[i] \u0026gt;\u0026gt; r[i] \u0026gt;\u0026gt; d[i]; l[i]--, r[i]--; } solve(); return 0; } ","date":"2017-09-10T01:06:11+08:00","permalink":"https://blog.crazyark.me/p/hourrank23/","title":"ç¨€ç–è¡¨å’Œå¹¶è¡ŒäºŒåˆ†æŸ¥æ‰¾ (Sparse Table \u0026 Parallel Binary Search)"},{"content":"Binary Indexed Tree/Fenwick tree çš„æ ‘æ„æˆæ–¹å¼æˆ‘ä¸€ç›´å¾ˆç–‘æƒ‘ï¼Œæ€»æ˜¯ä¼¼æ‡‚éæ‡‚ã€‚ç°åœ¨ç»ˆäºå¼„æ¸…æ¥šäº†å®ƒçš„èŠ‚ç‚¹çš„çˆ¶å­å…³ç³»ï¼Œè®°å½•ä¸‹æ¥é˜²æ­¢å¿˜è®°ã€‚\nBinary Indexed Tree BIT é€šå¸¸ç”¨äºå­˜å‚¨å‰ç¼€å’Œï¼Œæˆ–è€…å­˜å‚¨æ•°ç»„æœ¬èº«(ç”¨å‰ç¼€å’Œtrick)ã€‚BIT ç”¨ä¸€ä¸ªæ•°ç»„æ¥è¡¨ç¤ºæ ‘ï¼Œç©ºé—´å¤æ‚åº¦ä¸º O(n)ã€‚BIT æ”¯æŒä¸¤ä¸ªæ“ä½œï¼Œupdateå’Œqueryï¼Œç”¨äºå•ç‚¹æ›´æ–°å’Œå‰ç¼€å’ŒæŸ¥è¯¢ï¼Œå®ƒä»¬çš„æ—¶é—´å¤æ‚åº¦éƒ½ä¸ºä¸¥æ ¼çš„ O(lgn)ã€‚\nå‰ç¼€å’ŒBITæ•°ç»„é‡Œçš„ç¬¬ié¡¹ï¼ˆ1-basedï¼‰è®°å½•äº†åŸæ•°ç»„åŒºé—´ [i - (i \u0026amp; -i) + 1, i] çš„å’Œï¼Œå…¶ä¸­(i \u0026amp; -i) æ˜¯ i çš„æœ€ä½ä½1è¡¨ç¤ºçš„æ•°ã€‚\nParent å‡è®¾æˆ‘ä»¬æœ‰èŠ‚ç‚¹iï¼ŒèŠ‚ç‚¹içš„çˆ¶èŠ‚ç‚¹ä¸º i - (i \u0026amp; -i)ï¼Œä¹Ÿå°±æ˜¯æŠ¹é™¤æœ€åä¸€ä¸ª1ã€‚æ˜¾ç„¶çˆ¶èŠ‚ç‚¹å”¯ä¸€ï¼Œä¸”æ‰€æœ‰èŠ‚ç‚¹éƒ½æœ‰å…¬å…±ç¥–å…ˆ0ã€‚\nSiblings é€šè¿‡ä»¥ä¸‹è¿‡ç¨‹å¯ä»¥è·å¾—æ‰€æœ‰å…„å¼ŸèŠ‚ç‚¹:\nfor (int j = 1; j \u0026lt; (i \u0026amp; -i); j \u0026lt;\u0026lt;= 1) { // z is a sibling of i int z = i + j; } Point Get å‡è®¾æˆ‘ä»¬æœ‰èŠ‚ç‚¹iï¼Œé‚£ä¹ˆå¯ä»¥é€šè¿‡ä»¥ä¸‹è¿‡ç¨‹è·å–æ•°ç»„içš„å€¼ï¼š\nint res = bit[i]; int z = i - (i \u0026amp; -i); int j = i - 1; while (j != z) { res -= bit[j]; j = j - (j \u0026amp; -j); } ä¸Šè¿°è¿‡ç¨‹å³æŠŠ i - 1 çš„æœ«å°¾çš„è¿ç»­çš„1ä¸€æ­¥æ­¥ç§»é™¤ï¼Œä¹Ÿå°±æ˜¯æ±‚äº† sum(i - (i \u0026amp; -i), i - 1)ï¼Œç„¶åç”¨ièŠ‚ç‚¹çš„å’Œå‡å»å°±å¾—åˆ°äº†æ•°ç»„é¡¹içš„å€¼ã€‚\nPrefix Sum é€šè¿‡ä»¥ä¸‹è¿‡ç¨‹ä¸æ–­æ‰¾åˆ°çˆ¶èŠ‚ç‚¹ï¼Œå¹¶åŠ å’Œï¼š\nlong sum = 0; for (int j = i; j \u0026gt; 0; j -= (j \u0026amp; -j)) { sum += bit[j]; } æ˜¾ç„¶å„ä¸ªåŒºé—´ä¸äº¤ï¼Œæœ€ç»ˆåŒºé—´ä¸º [1, i]ã€‚\nIntervals Cover [i, i] é€šè¿‡ä»¥ä¸‹è¿‡ç¨‹ï¼Œè·å¾—æ‰€æœ‰è¦†ç›–åŒºé—´[i, i]çš„èŠ‚ç‚¹ï¼ŒåŒæ—¶å®ƒä»¬æ˜¯èŠ‚ç‚¹iåœ¨è¡¥ç ä¸­çš„çˆ¶èŠ‚ç‚¹ï¼Œç¨åè¯æ˜ï¼š\nfor (int j = i; j \u0026lt; n; j += (j \u0026amp; -j)) { // node j covers [i, i] } é¦–å…ˆæ˜¾ç„¶ï¼ŒèŠ‚ç‚¹iæ˜¯ç¬¬ä¸€ä¸ªè¦†ç›–içš„èŠ‚ç‚¹ï¼Œç„¶å j = i + (i \u0026amp; -i) æ˜¯iä¹‹åçš„ç¬¬ä¸€ä¸ªæ»¡è¶³ j - (j \u0026amp; -j) \u0026lt; i çš„èŠ‚ç‚¹ï¼Œè¯æ˜ä¹Ÿå¾ˆå®¹æ˜“ã€‚\nä¸”æœ‰ j = i + (i \u0026amp; -i)ï¼Œj - (j \u0026amp; -j) \u0026lt;= i - (i \u0026amp; -i) æ’æˆç«‹ï¼Œä¹Ÿå°±æ˜¯èŠ‚ç‚¹jæ‰€ä»£è¡¨çš„åŒºé—´èƒ½å¤Ÿè¦†ç›–içš„èŠ‚ç‚¹ï¼Œè€Œiåˆ°jä¹‹é—´çš„èŠ‚ç‚¹ä¸èŠ‚ç‚¹iå‡ä¸äº¤ã€‚\næ‰€ä»¥å¾ˆå®¹æ˜“å°±èƒ½æ¨å¯¼å‡ºï¼Œæ‰€æœ‰ä¸èŠ‚ç‚¹iæ‰€ä»£è¡¨åŒºé—´ç›¸äº¤çš„èŠ‚ç‚¹ä¸ºä¸Šè¿°è¿‡ç¨‹ä¸­çš„èŠ‚ç‚¹ã€‚\nParent in 2\u0026rsquo;s Complement ä¸å¦¨è®¾è¿™é‡Œæ˜¯32ä½çš„ç¯å¢ƒï¼Œå¤§å®¶è¿˜è®°å¾—è´Ÿæ•° -i çš„äºŒè¿›åˆ¶è¡¨ç¤ºä¹ˆï¼Ÿå¯¹ï¼Œå°±æ˜¯ 2^32 - iï¼Œæ‰€ä»¥æˆ‘ä»¬æœ‰ i \u0026amp; -i = i \u0026amp; (2^32 - i)ï¼Œè¿™æ ·æˆ‘ä»¬å¯ä»¥ä»æœ‰ç¬¦å·æ•°è½¬æ¢åˆ°æ— ç¬¦å·æ•°çš„æ“ä½œã€‚\nè¿˜è®°å¾—ä¸Šè¿°è·å–ä¸‹ä¸€ä¸ªè¦†ç›–içš„èŠ‚ç‚¹çš„æ“ä½œï¼Œi + (i \u0026amp; -i)ï¼Œæˆ‘ä»¬ç”¨ j = 2^32 - i æ¥é‡æ–°ç»„ç»‡ä¸€ä¸‹è¿™ä¸ªå¼å­ï¼š\ni + (i \u0026amp; -i) = 2^32 - (j - (j \u0026amp; (2 ^32 - j))),\næˆ‘ä»¬æŠŠå®ƒä¹Ÿæ˜ å°„æˆè¡¥ç ï¼Œ2^32 - i - (i \u0026amp; -i) = j - (j \u0026amp; (2 ^32 - j))\nååˆ†ç†Ÿæ‚‰äº†å§ï¼Ÿå°±æ˜¯jå»æ‰æœ€åä¸€ä½1çš„æ“ä½œï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥æŠŠå®ƒçœ‹åšä¸€ä¸ªæ‰¾çˆ¶èŠ‚ç‚¹çš„æ“ä½œï¼Œå…¬å…±ç¥–å…ˆä¹Ÿæ˜¯0ã€‚ç°åœ¨å°±å¯ä»¥æ¸…æ¥šåœ°çœ‹åˆ°äº†ï¼Œå…¶å® i + (i \u0026amp; -i) çš„æ“ä½œåœ¨è¡¥ç ä¸­æ˜¯ä¸€ä¸ªå¯¹ç§°çš„æ±‚çˆ¶èŠ‚ç‚¹æ“ä½œï¼ŒåŸæ¥çš„æ±‚çˆ¶èŠ‚ç‚¹æ“ä½œ i - (i \u0026amp; -i) åŒç†ä¸ºå¯¹ç§°æ“ä½œã€‚\nSuffix BIT ç°åœ¨å¯ä»¥å¼•å‡ºä¸€ä¸ªåç¼€å’Œçš„BITï¼š\nconst int MAX_N = 1e5; int bit[MAX_N]; void update(int i, int delta) { while (i \u0026gt; 0) { bit[i] += delta; i -= (i \u0026amp; -i); } } // get the suffix sum of [i, n] int get(int i, int n) { int res = 0; while (i \u0026lt;= n) { res += bit[i]; i += (i \u0026amp; -i); } return res; } æœ¬æ¥ç™¾æ€ä¸å¾—å…¶è§£çš„æ“ä½œåœ¨è¡¥ç ä¸­å¾—åˆ°äº†è§£é‡Šï¼Œè¿™é‡ŒèŠ‚ç‚¹iä»£è¡¨çš„åŒºé—´å’Œä¸º[i, i + (i \u0026amp; -i) - 1]ã€‚\nä½†æ˜¯è¿™é‡Œç›´æ¥æ·»åŠ ä¸€ä¸ªæ•°å­—ç”¨äºè®°å½•å…¨å±€sumï¼Œç„¶å sum - prefix(1, i - 1) ä¹Ÿæ˜¯å¯ä»¥çš„ã€‚\nAppendix Impl \u0026amp; 3 Usages #include \u0026lt;vector\u0026gt; #include \u0026lt;iostream\u0026gt; #include \u0026lt;cassert\u0026gt; using namespace std; class BinaryIndexedTree { protected: vector\u0026lt;long\u0026gt; bit; static int lowbit(int x) { return x \u0026amp; -x; } BinaryIndexedTree(BinaryIndexedTree\u0026amp;\u0026amp; other) { bit = std::move(other.bit); } public: BinaryIndexedTree(int n) { bit = vector\u0026lt;long\u0026gt;(n); } BinaryIndexedTree(const vector\u0026lt;long\u0026gt;\u0026amp; nums) { int n = nums.size(); bit = vector\u0026lt;long\u0026gt;(n); for (int i = 0; i \u0026lt; n; ++i) { bit[i] = nums[i]; for (int j = i - 1; j \u0026gt; i - lowbit(i + 1); --j) { bit[i] += nums[j]; } } } void add(int i, long delta) { for (int j = i; j \u0026lt; int(bit.size()); j += lowbit(j + 1)) { bit[j] += delta; } } long sum(int k) { long res = 0; for (int i = k; i \u0026gt;= 0; i -= lowbit(i + 1)) { res += bit[i]; } return res; } }; class PointUpdateRangeQueryExectuor { private: int n; BinaryIndexedTree tree; long prefixSum(int r) { if (r \u0026lt; 0) return 0; return tree.sum(r); } public: PointUpdateRangeQueryExectuor(int n) : n(n), tree(n) {} PointUpdateRangeQueryExectuor(const vector\u0026lt;long\u0026gt;\u0026amp; nums) : n(nums.size()), tree(nums) {} void update(int i, long delta) { assert(i \u0026gt;= 0 \u0026amp;\u0026amp; i \u0026lt; n); tree.add(i, delta); } long rangeSum(int l, int r) { assert(l \u0026lt;= r \u0026amp;\u0026amp; l \u0026gt;= 0 \u0026amp;\u0026amp; r \u0026lt; n); return prefixSum(r) - prefixSum(l - 1); } }; class RangeUpdatePointQueryExecutor { private: int n; BinaryIndexedTree tree; // Tear array into pieces static vector\u0026lt;long\u0026gt; rangePieces(const vector\u0026lt;long\u0026gt;\u0026amp; nums) { int n = nums.size(); vector\u0026lt;long\u0026gt; res(n); // make sure that prefix_sum(res, i) = nums[i] if (n != 0) res[0] = nums[0]; for (int i = 1; i \u0026lt; n; ++i) { res[i] = nums[i] - nums[i - 1]; } return res; } friend class RangeUpdateRangeQueryExecutor; public: RangeUpdatePointQueryExecutor(int n) : n(n), tree(n) {} RangeUpdatePointQueryExecutor(const vector\u0026lt;long\u0026gt;\u0026amp; nums) : n(nums.size()), tree(rangePieces(nums)) {} void update(int l, int r, long delta) { assert(l \u0026lt;= r \u0026amp;\u0026amp; l \u0026gt;= 0 \u0026amp;\u0026amp; r \u0026lt; n); tree.add(l, delta); if (r + 1 \u0026lt; n) tree.add(r + 1, -delta); } long get(int i) { assert(i \u0026gt;= 0 \u0026amp;\u0026amp; i \u0026lt; n); return tree.sum(i); } }; class RangeUpdateRangeQueryExecutor { private: long n; BinaryIndexedTree tree; BinaryIndexedTree tree2; static vector\u0026lt;long\u0026gt; prefixPieces(const vector\u0026lt;long\u0026gt;\u0026amp; nums) { int n = nums.size(); vector\u0026lt;long\u0026gt; res(n); // make sure that nums[i] * i - res[i] = prefix_sum(nums, i), // so that the following prefixSum works. // Then run rangePieces, so that we get res[i] = (nums[i] - nums[i - 1]) * (i - 1); if (n != 0) res[0] = -nums[0]; for (long i = 0; i \u0026lt; n; ++i) { res[i] = (nums[i] - nums[i - 1]) * (i - 1); } return res; } long prefixSum(long r) { if (r \u0026lt; 0) return 0; return tree.sum(r) * r - tree2.sum(r); } static constexpr auto rangePieces = RangeUpdatePointQueryExecutor::rangePieces; public: RangeUpdateRangeQueryExecutor(long n) : n(n), tree(n), tree2(n) {} RangeUpdateRangeQueryExecutor(const vector\u0026lt;long\u0026gt;\u0026amp; nums) : n(nums.size()), tree(rangePieces(nums)), tree2(prefixPieces(nums)) {} void update(long l, long r, long delta) { assert(l \u0026lt;= r \u0026amp;\u0026amp; l \u0026gt;= 0 \u0026amp;\u0026amp; r \u0026lt; n); tree.add(l, delta); if (r + 1 \u0026lt; n) tree.add(r + 1, -delta); tree2.add(l, delta * (l - 1)); if (r + 1 \u0026lt; n) tree2.add(r + 1, -delta * r); } long rangeSum(long l, long r) { assert(l \u0026lt;= r \u0026amp;\u0026amp; l \u0026gt;= 0 \u0026amp;\u0026amp; r \u0026lt; n); return prefixSum(r) - prefixSum(l - 1); } }; int main() { // point update range query PointUpdateRangeQueryExectuor purq(5); purq.update(0, 2); purq.update(3, 3); purq.update(4, 5); cout \u0026lt;\u0026lt; purq.rangeSum(0, 1) \u0026lt;\u0026lt; endl; // 2 cout \u0026lt;\u0026lt; purq.rangeSum(2, 3) \u0026lt;\u0026lt; endl; // 3 cout \u0026lt;\u0026lt; purq.rangeSum(3, 4) \u0026lt;\u0026lt; endl; // 8 PointUpdateRangeQueryExectuor purq2({2, 1, 2, 3, 5}); cout \u0026lt;\u0026lt; purq2.rangeSum(0, 1) \u0026lt;\u0026lt; endl; // 3 cout \u0026lt;\u0026lt; purq2.rangeSum(2, 3) \u0026lt;\u0026lt; endl; // 5 cout \u0026lt;\u0026lt; purq2.rangeSum(3, 4) \u0026lt;\u0026lt; endl; // 8 // range update point query RangeUpdatePointQueryExecutor rupq(5); rupq.update(0, 4, 2); rupq.update(3, 4, 3); cout \u0026lt;\u0026lt; rupq.get(0) \u0026lt;\u0026lt; endl; // 2 cout \u0026lt;\u0026lt; rupq.get(3) \u0026lt;\u0026lt; endl; // 5 RangeUpdatePointQueryExecutor rupq2({11, 3, 2, 6, 5}); cout \u0026lt;\u0026lt; rupq2.get(0) \u0026lt;\u0026lt; endl; // 11 cout \u0026lt;\u0026lt; rupq2.get(3) \u0026lt;\u0026lt; endl; // 6 // range update range query RangeUpdateRangeQueryExecutor rurq(5); rurq.update(0, 4, 2); rurq.update(3, 4, 3); cout \u0026lt;\u0026lt; rurq.rangeSum(2, 4) \u0026lt;\u0026lt; endl; // 12 RangeUpdateRangeQueryExecutor rurq2({2, 2, 3, 6, 5}); cout \u0026lt;\u0026lt; rurq2.rangeSum(2, 4) \u0026lt;\u0026lt; endl; // 14 return 0; } ","date":"2017-09-08T22:23:50+08:00","permalink":"https://blog.crazyark.me/p/binary-indexed-tree/","title":"äºŒå‰ç´¢å¼•æ ‘/æ ‘çŠ¶æ•°ç»„ (Binary Indexed Tree)"},{"content":"æœ¬ç¯‡ä¸ºWCIPEGä¸Šå…³äºSegmentTreeçš„ç¿»è¯‘ç¨¿ï¼Œé™¤äº†åˆ å»äº†å‡ ä¸ªå°èŠ‚ï¼Œå…¶ä½™è¡Œæ–‡ç»“æ„å°†å®Œå…¨ä¸€è‡´ã€‚\nçº¿æ®µæ ‘æ˜¯ä¸€ç§éå¸¸çµæ´»çš„æ•°æ®ç»“æ„ï¼Œå®ƒå¯ä»¥å¸®åŠ©æˆ‘ä»¬é«˜æ•ˆåœ°å®Œæˆå¯¹åº•å±‚æ•°ç»„åŒºé—´æŸ¥è¯¢æˆ–æ˜¯ä¿®æ”¹ã€‚é¡¾åæ€ä¹‰ï¼Œçº¿æ®µæ ‘å¯ä»¥è¢«æƒ³è±¡æˆåº•å±‚æ•°ç»„åŒºé—´æ„æˆçš„ä¸€æ£µæ ‘ï¼Œå®ƒçš„åŸºæœ¬æ€æƒ³æ˜¯åˆ†æ²»ã€‚\nMotivation çº¿æ®µæ ‘çš„ä¸€ä¸ªæœ€å¸¸è§çš„åº”ç”¨æ˜¯ç”¨äºè§£å†³èŒƒå›´æœ€å°å€¼æŸ¥è¯¢é—®é¢˜ï¼šç»™å®šä¸€ä¸ªæ•°ç»„ï¼Œç„¶åä¸æ–­åœ°æŸ¥è¯¢æŸä¸ªç»™å®šç´¢å¼•èŒƒå›´çš„æœ€å°å€¼ã€‚ä¸¾ä¸ªä¾‹å­ï¼Œç»™å®šæ•°ç»„ [9, 2, 6, 3, 1, 5, 0, 7]ï¼ŒæŸ¥è¯¢ç¬¬3ä¸ªåˆ°ç¬¬6ä¸ªæ•°ä¹‹é—´çš„æœ€å°å€¼ï¼Œç­”æ¡ˆæ˜¯ min(6, 3, 1, 5) = 1ã€‚æ¥ç€æŸ¥è¯¢ç¬¬1ä¸ªåˆ°ç¬¬3ä¸ªï¼Œç­”æ¡ˆæ˜¯2\u0026hellip; ç­‰ç­‰ä¸€ç³»åˆ—æŸ¥è¯¢æ“ä½œã€‚å…³äºè¿™ä¸ªé—®é¢˜æœ‰å¾ˆå¤šæ–‡ç« è¿›è¡Œäº†æ¢è®¨ï¼Œæå‡ºäº†è¯¸å¤šä¸åŒçš„è§£æ³•ã€‚å…¶ä¸­çº¿æ®µæ ‘å¾€å¾€æ˜¯æœ€åˆé€‚çš„é€‰æ‹©ï¼Œç‰¹åˆ«æ˜¯æŸ¥è¯¢å’Œä¿®æ”¹ç©¿æ’ç€è¿›è¡Œçš„æ—¶å€™ã€‚ä¸ºäº†ç®€ä¾¿èµ·è§ï¼Œåœ¨æ¥ä¸‹æ¥çš„å‡ ä¸ªå°èŠ‚ä¸­ï¼Œæˆ‘ä»¬å°†å…³æ³¨äºç”¨äºå›ç­”èŒƒå›´æœ€å°å€¼æŸ¥è¯¢çš„ç‰¹å®šçº¿æ®µæ ‘ï¼Œä¸ä¼šå†å¦è¡Œå£°æ˜ï¼Œè€Œå…¶ä»–ç±»å‹çº¿æ®µæ ‘å°†åœ¨æœ¬æ–‡åé¢è¿›è¡Œè®¨è®ºã€‚\nThe divide-and-conquer solution åˆ†è€Œæ²»ä¹‹:\nå¦‚æœè¿™ä¸ªèŒƒå›´ä»…åŒ…å«ä¸€ä¸ªå…ƒç´ ï¼Œé‚£ä¹ˆè¿™ä¸ªå…ƒç´ è‡ªå·±æ˜¾ç„¶å°±æ˜¯æœ€å°å€¼ å¦åˆ™ï¼Œå°†èŒƒå›´äºŒåˆ†æˆä¸¤ä¸ªå·®ä¸å¤šå¤§çš„å°èŒƒå›´ï¼Œç„¶åæ‰¾åˆ°å®ƒä»¬ç›¸åº”çš„æœ€å°å€¼ï¼Œé‚£ä¹ˆåŸæ¥çš„æœ€å°å€¼ç­‰äºä¸¤ä¸ªå€¼ä¹‹ä¸­å°çš„é‚£ä¸ªã€‚ æ•…è€Œï¼Œä»¤ $a_i$ è¡¨ç¤ºæ•°ç»„å†…ç¬¬iä¸ªå…ƒç´ ï¼Œæœ€å°å€¼æŸ¥è¯¢å¯ä»¥è¡¨ç¤ºä¸ºä»¥ä¸‹é€’å½’å‡½æ•°ï¼š\n$f(x,y) = \\begin{cases} a_x \u0026amp; \\textrm{if}\\ x = y\\\\min(f(x, \\lfloor\\frac{x+y}{2}\\rfloor), f(\\lfloor\\frac{x+y}{2}\\rfloor) + 1, y) \u0026amp; \\textrm{otherwise}\\end{cases}, x \\le y$\nå› æ­¤ï¼Œä¸¾ä¸ªä¾‹å­ï¼Œä¸Šä¸€ç« çš„ç¬¬ä¸€ä¸ªæŸ¥è¯¢$f(3,6)$å°†è¢«é€’å½’åœ°è¡¨ç¤ºä¸º$\\min(f(3,4),f(5,6))$ã€‚\nStructure å‡è®¾æˆ‘ä»¬ç”¨ä¸Šé¢å®šä¹‰çš„å‡½æ•°æ¥è®¡ç®— $f(1,N)$ï¼Œè¿™é‡Œ $N$ æ˜¯æ•°ç»„å†…å…ƒç´ çš„æ•°ç›®ã€‚å½“ $N$ å¾ˆå¤§æ—¶ï¼Œè¿™ä¸ªé€’å½’è®¡ç®—æœ‰ä¸¤ä¸ªå­è®¡ç®—ï¼Œä¸€ä¸ªæ˜¯ $f(1, \\lfloor\\frac{1+N}{2}\\rfloor)$ï¼Œå¦ä¸€ä¸ªæ˜¯ $f(\\lfloor\\frac{1+N}{2}\\rfloor) + 1, N)$ã€‚æ¯ä¸ªå­è®¡ç®—åˆæœ‰ä¸¤ä¸ªå­è®¡ç®—ï¼Œç­‰ç­‰ï¼Œç›´åˆ°é‡åˆ°base caseã€‚å¦‚æœæˆ‘ä»¬å°†è¿™ä¸ªé€’å½’è®¡ç®—çš„è¿‡ç¨‹è¡¨ç¤ºæˆä¸€æ£µæ ‘ï¼Œ$f(1, N)$å°±æ˜¯æ ¹èŠ‚ç‚¹ï¼Œå®ƒæœ‰ä¸¤ä¸ªè‡ªå·±ç‚¹ï¼Œæ¯ä¸ªå­èŠ‚ç‚¹å¯èƒ½ä¹Ÿæœ‰ä¸¤ä¸ªå­èŠ‚ç‚¹ï¼Œç­‰ç­‰ã€‚Base case å°±æ˜¯è¿™æ£µæ ‘çš„å¶èŠ‚ç‚¹ã€‚ç°åœ¨æˆ‘ä»¬å¯ä»¥æ¥æè¿°çº¿æ®µæ ‘çš„ç»“æ„ï¼š\nä¸€æ£µäºŒå‰æ ‘ï¼Œç”¨äºè¡¨ç¤ºåº•å±‚æ•°ç»„ æ¯ä¸ªèŠ‚ç‚¹ä»£è¡¨äº†æ•°ç»„çš„æŸä¸ªåŒºé—´ï¼Œå¹¶ä¸”åŒ…å«äº†åŒºé—´ä¸Šçš„æŸäº›å‡½æ•°å€¼ æ ¹èŠ‚ç‚¹ä»£è¡¨æ•´ä¸ªæ•°ç»„ (ä¹Ÿå°±æ˜¯åŒºé—´ [1, N]) æ¯ä¸ªå¶èŠ‚ç‚¹è¡¨ç¤ºæ•°ç»„ä¸­æŸä¸ªç‰¹å®šå…ƒç´  æ¯ä¸ªéå¶èŠ‚ç‚¹æœ‰ä¸¤ä¸ªå­èŠ‚ç‚¹ï¼Œå®ƒä»¬çš„åŒºé—´ä¸äº¤ï¼Œå¹¶ä¸”å®ƒä»¬çš„åŒºé—´çš„å¹¶ç­‰äºçˆ¶èŠ‚ç‚¹çš„åŒºé—´ æ¯ä¸ªå­èŠ‚ç‚¹çš„åŒºé—´å¤§çº¦æ˜¯çˆ¶èŠ‚ç‚¹åŒºé—´çš„ä¸€åŠå¤§å° æ¯ä¸ªéå¶èŠ‚ç‚¹å­˜å‚¨çš„å€¼ä¸ä»…æ˜¯å®ƒä»£è¡¨çš„åŒºé—´çš„å‡½æ•°å€¼ï¼Œè€Œä¸”æ˜¯å®ƒçš„å­èŠ‚ç‚¹çš„å­˜å‚¨å€¼çš„å‡½æ•°å€¼ï¼ˆæ‹—å£\u0026hellip;å°±æ˜¯é‚£ä¸ªé€’å½’è¿‡ç¨‹ï¼‰ ä¹Ÿå°±æ˜¯è¯´ï¼Œçº¿æ®µæ ‘çš„ç»“æ„å’Œé€’å½’è®¡ç®— $f(1,N)$ çš„è¿‡ç¨‹å®Œå…¨ç›¸åŒã€‚\nå› æ­¤ï¼Œä¸¾ä¸ªä¾‹å­ï¼Œæ•°ç»„ [9,2,6,3,1,5,0,7]çš„æ ¹èŠ‚ç‚¹åŒ…å«æ•°å­—0 â€”â€” æ•´ä¸ªæ•°ç»„çš„æœ€å°å€¼ã€‚å®ƒçš„å·¦å­èŠ‚ç‚¹åŒ…å«[9,2,6,3]ä¸­çš„æœ€å°ï¼Œ2ï¼›å³å­èŠ‚ç‚¹åŒ…å«[1,5,0,7]ä¸­çš„æœ€å°ï¼Œ0ã€‚æ¯ä¸ªå…ƒç´ å¯¹åº”äºä¸€ä¸ªå¶èŠ‚ç‚¹ï¼Œä»…ä»…åŒ…å«å®ƒè‡ªå·±ã€‚\nOperations çº¿æ®µæ ‘ä¸€å…±æœ‰ä¸‰ç§åŸºç¡€æ“ä½œï¼šæ„å»ºã€æ›´æ–°ã€æŸ¥è¯¢ã€‚\nConstruction ä¸ºäº†è¿›è¡ŒæŸ¥è¯¢å’Œæ›´æ–°ï¼Œé¦–å…ˆæˆ‘ä»¬éœ€è¦æ„å»ºä¸€æ£µçº¿æ®µæ ‘æ¥è¡¨ç¤ºæŸä¸ªæ•°ç»„ã€‚æˆ‘ä»¬å¯ä»¥è‡ªåº•å‘ä¸Šæˆ–æ˜¯è‡ªé¡¶å‘ä¸‹åœ°æ„å»ºã€‚è‡ªé¡¶å‘ä¸‹çš„æ„å»ºæ˜¯ä¸€ä¸ªé€’å½’çš„è¿‡ç¨‹ï¼šå°è¯•å¡«å……èŠ‚ç‚¹ï¼Œå¦‚æœæ˜¯å¶å­èŠ‚ç‚¹ï¼Œç›´æ¥ç”¨å¯¹åº”çš„å€¼å¡«å……ï¼Œå¦åˆ™å…ˆå¡«å……è¯¥èŠ‚ç‚¹çš„ä¸¤ä¸ªå­èŠ‚ç‚¹ï¼Œç„¶åç”¨å­èŠ‚ç‚¹ä¸­å°çš„å€¼å¡«å……è¯¥èŠ‚ç‚¹ã€‚è‡ªåº•å‘ä¸Šçš„æ„å»ºç•™ä½œç»ƒä¹ ã€‚è¿™ä¸¤ç§æ–¹å¼åœ¨è¿è¡Œé€Ÿåº¦ä¸Šçš„å·®è·å‡ ä¹å¯ä»¥å¿½ç•¥ä¸è®¡ã€‚\nUpdate æ›´æ–°çº¿æ®µæ ‘å³æ›´æ–°åº•å±‚æ•°ç»„çš„æŸä¸ªå…ƒç´ ã€‚æˆ‘ä»¬é¦–å…ˆæ›´æ–°å¯¹åº”çš„å¶å­èŠ‚ç‚¹ â€”â€” å› ä¸ºå¶å­èŠ‚ç‚¹åªå¯¹åº”æ•°ç»„çš„ä¸€ä¸ªå…ƒç´ ã€‚è¢«æ›´æ–°çš„èŠ‚ç‚¹çš„çˆ¶èŠ‚ç‚¹ä¹Ÿå°†è¢«å½±å“ï¼Œå› ä¸ºå®ƒå¯¹åº”çš„åŒºé—´åŒ…å«äº†è¢«ä¿®æ”¹çš„å…ƒç´ ï¼Œå¯¹ç¥–çˆ¶èŠ‚ç‚¹åŒæ ·ï¼Œç›´åˆ°æ ¹èŠ‚ç‚¹ï¼Œä½†æ˜¯ä¸ä¼šå½±å“å…¶ä»–èŠ‚ç‚¹ã€‚å¦‚æœè¦è¿›è¡Œè‡ªé¡¶å‘ä¸‹çš„æ›´æ–°ï¼Œé¦–å…ˆè¿›è¡Œæ ¹èŠ‚ç‚¹çš„æ›´æ–°ï¼Œè¿™å°†å¯¼è‡´ä¸¤ä¸ªå­èŠ‚ç‚¹ä¸­çš„ç›¸å…³çš„é‚£ä¸ªé€’å½’åœ°æ›´æ–°ã€‚å¯¹å­èŠ‚ç‚¹çš„æ›´æ–°ä¹Ÿæ˜¯åŒæ ·çš„ï¼Œè¾¹ç•Œä¸ºå¯¹å¶èŠ‚ç‚¹çš„æ›´æ–°ã€‚å½“é€’å½’è¿‡ç¨‹å®Œæˆä»¥åï¼Œéå¶èŠ‚ç‚¹çš„å€¼æ›´æ–°ä¸ºä¸¤ä¸ªå­èŠ‚ç‚¹çš„è¾ƒå°å€¼ã€‚è‡ªåº•å‘ä¸Šçš„æ›´æ–°åŒæ ·ç•™ä½œç»ƒä¹ ã€‚\n0 changed to 8 Query åœ¨çº¿æ®µæ ‘ä¸Šè¿›è¡ŒæŸ¥è¯¢å³ç¡®å®šåº•å±‚æ•°ç»„æŸä¸ªåŒºé—´çš„å‡½æ•°å€¼ï¼Œåœ¨è¿™é‡Œå°±æ˜¯åŒºé—´å†…çš„æœ€å°å…ƒç´ å€¼ã€‚æŸ¥è¯¢æ“ä½œçš„æ‰§è¡Œè¿‡ç¨‹æ¯”æ›´æ–°æ“ä½œå¤æ‚çš„å¤šï¼Œæˆ‘ä»¬ç”¨ä¸€ä¸ªä¾‹å­æ¥é˜é‡Šã€‚å‡è®¾æˆ‘ä»¬æƒ³è¦çŸ¥é“ç¬¬1ä¸ªåˆ°ç¬¬6ä¸ªå…ƒç´ å†…çš„æœ€å°å€¼ï¼Œæˆ‘ä»¬å°†è¿™ä¸ªæŸ¥è¯¢è¡¨ç¤ºä¸º $f(1, 6)$ã€‚çº¿æ®µæ ‘ä¸Šæ¯ä¸ªèŠ‚ç‚¹åŒ…å«äº†æŸä¸ªåŒºé—´å†…çš„æœ€å°å€¼ï¼šä¸¾ä¾‹æ¥è¯´ï¼Œæ ¹èŠ‚ç‚¹åŒ…å«äº† $f(1, 8)$ï¼Œå®ƒçš„å·¦å­èŠ‚ç‚¹ $f(1, 4)$ï¼Œå³å­èŠ‚ç‚¹ $f(5, 8)$ï¼Œç­‰ç­‰ï¼›æ¯ä¸ªå¶èŠ‚ç‚¹åŒ…å«äº† $f(x,x)$ã€‚æ²¡æœ‰ä¸€ä¸ªèŠ‚ç‚¹æ˜¯ $f(1,6)$ï¼Œä½†æ˜¯æ³¨æ„åˆ° $f(1, 6) = \\min(f(1,4),f(5,6))$ï¼Œå¹¶ä¸”å­˜åœ¨ä¸¤ä¸ªèŠ‚ç‚¹åŒ…å«è¿™ä¸¤ä¸ªå€¼ï¼ˆåœ¨ä¸‹å›¾ä¸­ä»¥é»„è‰²æ ‡è¯†ï¼‰ã€‚\nå› æ­¤åœ¨çº¿æ®µæ ‘ä¸ŠæŸ¥è¯¢æ—¶ï¼Œæˆ‘ä»¬é€‰æ‹©æ‰€æœ‰èŠ‚ç‚¹çš„ä¸€ä¸ªå­é›†ï¼Œä½¿å¾—å®ƒä»¬æ‰€è¡¨ç¤ºçš„åŒºé—´çš„å¹¶é›†ä¸æˆ‘ä»¬è¦æŸ¥è¯¢çš„åŒºé—´å®Œå…¨ç›¸åŒã€‚ä¸ºäº†æ‰¾åˆ°è¿™äº›èŠ‚ç‚¹ï¼Œæˆ‘ä»¬é¦–å…ˆä»æ ¹èŠ‚ç‚¹å¼€å§‹ï¼Œé€’å½’æŸ¥è¯¢é‚£äº›ä¸åŒºé—´è‡³å°‘æœ‰ä¸€ä¸ªäº¤é›†çš„èŠ‚ç‚¹ã€‚åœ¨æˆ‘ä»¬çš„ä¾‹å­ä¸­ï¼Œ$f(1, 6)$ï¼Œæˆ‘ä»¬æ³¨æ„åˆ°å·¦å­æ ‘å’Œå³å­æ ‘å¯¹åº”çš„åŒºé—´éƒ½æœ‰äº¤é›†ï¼Œå› æ­¤ä»–ä»¬éƒ½è¢«é€’å½’æ‰§è¡Œã€‚å·¦å­èŠ‚ç‚¹æ˜¯ä¸€ä¸ªbase caseï¼ˆä»¥é»„è‰²æ ‡è¯†ï¼‰ï¼Œå› ä¸ºå®ƒçš„åŒºé—´è¢«æŸ¥è¯¢åŒºé—´æ•´ä¸ªåŒ…å«ã€‚åœ¨å³å­èŠ‚ç‚¹ä¸­ï¼Œæˆ‘ä»¬æ³¨æ„åˆ°å®ƒçš„å·¦å­èŠ‚ç‚¹å’ŒæŸ¥è¯¢åŒºé—´ç›¸äº¤ï¼Œä½†æ˜¯å³å­èŠ‚ç‚¹æ²¡æœ‰ï¼Œæ‰€ä»¥æˆ‘ä»¬åªé€’å½’æ‰§è¡Œå®ƒçš„å·¦å­èŠ‚ç‚¹ã€‚è€Œå®ƒä¹Ÿæ˜¯ä¸€ä¸ªbase caseï¼ŒåŒæ ·ä»¥é»„è‰²æ ‡è¯†ã€‚é€’å½’ç»ˆæ­¢ï¼Œè€Œæœ€ç»ˆçš„æœ€å°å€¼å°±æ˜¯è¿™äº›è¢«é€‰ä¸­çš„èŠ‚ç‚¹çš„æœ€å°å€¼ã€‚\nQuery (1, 6) Analysis çº¿æ®µæ ‘çš„ä¸€äº›é‡è¦çš„æ€§èƒ½æŒ‡æ ‡å¦‚ä¸‹ï¼š\nSpace å¾ˆå®¹æ˜“è¯æ˜ï¼Œä¸€ä¸ªæ·±åº¦ä¸ºdçš„èŠ‚ç‚¹å¯¹åº”çš„åŒºé—´å¤§å°ä¸è¶…è¿‡ $\\lceil \\frac{N}{2^d} \\rceil$ã€‚æˆ‘ä»¬å¯ä»¥çœ‹åˆ°æ‰€æœ‰æ·±åº¦ä¸º $\\lceil \\lg N\\rceil$ çš„èŠ‚ç‚¹å¯¹åº”äºä¸è¶…è¿‡ä¸€ä¸ªèŠ‚ç‚¹ï¼Œä¹Ÿå°±è¯´å®ƒä»¬æ˜¯å¶èŠ‚ç‚¹ã€‚å› æ­¤ï¼Œçº¿æ®µæ ‘æ˜¯ä¸€æ£µå®Œå…¨å¹³è¡¡äºŒå‰æ ‘ï¼Œå®ƒçš„é«˜åº¦æ˜¯ç†è®ºæœ€å°å€¼ã€‚å› æ­¤ï¼Œæˆ‘ä»¬å¯ä»¥å°†æ ‘å­˜å‚¨ä¸ºä¸€ä¸ªæ•°ç»„ï¼ŒèŠ‚ç‚¹é¡ºåºæŒ‰ç…§å®½åº¦ä¼˜å…ˆéå†æ’åºï¼Œä¸ºäº†æ–¹ä¾¿èµ·è§ï¼Œå­èŠ‚ç‚¹æŒ‰ç…§å…ˆå·¦åå³é¡ºåºã€‚é‚£ä¹ˆï¼Œå¯¹äºä¸Šè¿°[9,2,6,3,1,5,8,7]çš„çº¿æ®µæ ‘ï¼Œå°†è¢«å­˜å‚¨ä¸º[1,2,1,2,3,1,7,9,2,6,3,1,5,8,7]ã€‚å‡è®¾æ ¹èŠ‚ç‚¹çš„ç´¢å¼•æ˜¯1ã€‚é‚£ä¹ˆå¯¹äºä¸€ä¸ªç´¢å¼•æ˜¯içš„éå¶èŠ‚ç‚¹ï¼Œå®ƒçš„ä¸¤ä¸ªå­èŠ‚ç‚¹çš„ç´¢å¼•æ˜¯2iå’Œ2i+1ã€‚æ³¨æ„åœ¨æ ‘çš„å¶èŠ‚ç‚¹å±‚æœ‰ä¸€äº›ç©ºé—´å¯èƒ½æ˜¯è¢«æ— ç”¨çš„ï¼Œä½†æ˜¯é€šå¸¸è¿™éƒ½æ˜¯å¯ä»¥æ¥å—çš„ã€‚ä¸€æ£µé«˜åº¦ä¸º $\\lceil \\lg N\\rceil$ çš„äºŒå‰æ ‘æœ€å¤šæœ‰ $2^{\\lfloor\\lg N\\rfloor + 1} - 1$ ä¸ªèŠ‚ç‚¹ï¼Œæ‰€ä»¥é€šè¿‡ç®€å•çš„æ•°å­¦åˆ†ææˆ‘ä»¬å¯ä»¥çŸ¥é“ä¸€æ£µå­˜å‚¨äº†Nä¸ªå…ƒç´ çš„çº¿æ®µæ ‘éœ€è¦ä¸€ä¸ªä¸è¶…è¿‡ $4N$ å¤§å°çš„æ•°ç»„è¿›è¡Œå­˜å‚¨ã€‚ä¸€æ£µçº¿æ®µæ ‘ä½¿ç”¨äº† $\\mathcal{O} (N)$ çš„ç©ºé—´\nTime Construction å¯¹æ¯ä¸ªèŠ‚ç‚¹ï¼Œæ„å»ºåªéœ€è¦è¿›è¡Œå‡ ä¸ªå›ºå®šæ“ä½œã€‚å› ä¸ºä¸€æ£µçº¿æ®µæ ‘çš„èŠ‚ç‚¹æ•°æ˜¯ $\\mathcal{O} (n)$ï¼Œæ‰€ä»¥æ„å»ºä¹Ÿæ˜¯çº¿æ€§çš„æ—¶é—´ã€‚\nUpdate æ›´æ–°æ“ä½œä¸€å…±æ›´æ–°ä»æ ¹èŠ‚ç‚¹åˆ°è¢«å½±å“çš„å¶èŠ‚ç‚¹çš„è·¯å¾„ä¸Šæ‰€æœ‰çš„èŠ‚ç‚¹ï¼Œå¯¹æ¯ä¸ªèŠ‚ç‚¹çš„æ›´æ–°æ“ä½œæ•°æ˜¯å›ºå®šçš„ã€‚èŠ‚ç‚¹çš„æ•°é‡ä»¥æ ‘çš„é«˜åº¦ä¸ºä¸Šç•Œï¼Œå› æ­¤åŒä¸Šè¿°ç»“è®ºï¼Œæ›´æ–°çš„æ—¶é—´å¤æ‚åº¦ä¸º $\\mathcal{O}(\\lg N)$ã€‚\nQuery è€ƒè™‘æ‰€æœ‰è¢«é€‰ä¸­çš„èŠ‚ç‚¹ (ä¸ŠèŠ‚å›¾ä¸­é»„è‰²çš„èŠ‚ç‚¹)ã€‚æŸ¥è¯¢ $f(1, N - 1)$ çš„æƒ…å†µä¸‹ï¼Œæœ‰ $\\lg N$ é‚£ä¹ˆå¤šã€‚é‚£ä¹ˆæ˜¯å¦ä¼šæœ‰æ›´å¤šå‘¢ï¼Ÿç­”æ¡ˆæ˜¯å¦å®šçš„ã€‚ä¸€ä¸ªå¯èƒ½æœ€ç®€å•çš„è¯æ˜æ˜¯ï¼Œå°†é€‰ä¸­èŠ‚ç‚¹çš„ç®—æ³•å±•å¼€ï¼Œå°†åœ¨ $\\mathcal{O}(\\lg N)$ æ­¥å†…ç»ˆæ­¢ï¼Œä¹Ÿå°±æ˜¯ä¹‹å‰æš—ç¤ºè¿‡çš„éé€’å½’çš„æ–¹å¼ã€‚æ‰€ä»¥ä¸€ä¸ªæŸ¥è¯¢æ“ä½œè€—æ—¶ $\\mathcal{O}(\\lg N)$ ã€‚å¯¹é€’å½’ç‰ˆæœ¬çš„è¯æ˜ç•™ä½œç»ƒä¹ ã€‚\nImplementation object rmq_segtree private function build_rec(node,begin,end,a[]) if begin = end A[node] = a[begin]; else let mid = floor((begin+end)/2) build_rec(2*node,begin,mid,a[]) build_rec(2*node+1,mid+1,end,a[]) A[node] = min(A[2*node],A[2*node+1]) private function update_rec(node,begin,end,pos,val) if begin = end A[node] = val else let mid=floor((begin+end)/2) if pos\u0026lt;=mid update_rec(2*node,begin,mid,pos,val) else update_rec(2*node+1,mid+1,end,pos,val) A[node] = min(A[2*node],A[2*node+1]) private function query_rec(node,t_begin,t_end,a_begin,a_end) if t_begin\u0026gt;=a_begin AND t_end\u0026lt;=a_end return A[node] else let mid = floor((t_begin+t_end)/2) let res = âˆ if mid\u0026gt;=a_begin AND t_begin\u0026lt;=a_end res = min(res,query_rec(2*node,t_begin,mid,a_begin,a_end)) if t_end\u0026gt;=a_begin AND mid+1\u0026lt;=a_end res = min(res,query_rec(2*node+1,mid+1,t_end,a_begin,a_end)) return res function construct(size,a[1..size]) let N = size let A be an array that can hold at least 4N elements build_rec(1,1,N,a) function update(pos,val) update_rec(1,1,N,pos,val) function query(begin,end) return query_rec(1,1,N,begin,end) Variations çº¿æ®µæ ‘ä¸ä»…é€‚ç”¨äºåŒºé—´æœ€å°å€¼æŸ¥è¯¢ï¼Œå®ƒè¿˜å¯ä»¥é€‚ç”¨äºè®¸å¤šä¸åŒçš„å‡½æ•°æŸ¥è¯¢ã€‚è¿™é‡Œæœ‰ä¸€äº›æ¯”è¾ƒéš¾çš„ç«èµ›é¢˜ä¸­çš„ä¾‹å­ã€‚\nMaximum å’Œæœ€å°ç±»ä¼¼ï¼šæ‰€æœ‰minæ“ä½œæ›¿æ¢ä¸ºmaxã€‚\nSum or product æ¯ä¸ªéå¶èŠ‚ç‚¹çš„å€¼ä¸ºå®ƒçš„å­èŠ‚ç‚¹çš„å’Œï¼Œä¹Ÿå°±æ˜¯è¡¨ç¤ºäº†å®ƒçš„åŒºé—´å†…çš„æ•°ç»„å’Œã€‚ä¸¾ä¾‹æ¥è¯´ï¼Œåœ¨ä¸Šè¿°ä¼ªä»£ç ä¸­ï¼Œæ‰€æœ‰minæ“ä½œè¢«æ›¿æ¢æˆåŠ æ“ä½œã€‚ä½†æ˜¯ï¼Œåœ¨ä¸€äº›åŠ å’Œçš„æƒ…å†µä¸­ï¼Œçº¿æ®µæ ‘è¢«äºŒå‰ç´¢å¼•æ ‘(Binary Indexed Tree)å–ä»£ï¼Œå› ä¸ºBITç©ºé—´å ç”¨æ›´å°ï¼Œè¿è¡Œæ›´å¿«ï¼Œå¹¶ä¸”å®¹æ˜“ç¼–ç ã€‚ä¹˜å¯ä»¥ä»¥åŒæ ·çš„æ–¹å¼å®ç°ï¼Œåªä¸è¿‡æ˜¯ç”¨ä¹˜å–ä»£åŠ ã€‚\nMaximum/minimum prefix suffix sum ä¸€ä¸ªåŒºé—´å‰ç¼€ç”±åŒºé—´å†…å‰kä¸ªå…ƒç´ ç»„æˆ (kå¯ä»¥ä¸º0)ï¼›ç±»ä¼¼çš„ï¼Œåç¼€ç”±åkä¸ªå…ƒç´ ç»„æˆã€‚åŒºé—´æœ€å¤§å‰ç¼€å’Œè¡¨ç¤ºåŒºé—´å†…æ‰€æœ‰å‰ç¼€çš„å’Œä¸­æœ€å¤§çš„æ•°(ç©ºåŒºé—´çš„å’Œä¸º0)ã€‚è¿™ä¸ªæœ€å¤§å’Œè¢«ç§°ä¸ºæœ€å¤§å‰ç¼€å’Œï¼ˆæœ€å°å‰ç¼€å’Œå¯ä»¥ç±»ä¼¼çš„å®šä¹‰ï¼‰ã€‚æˆ‘ä»¬å¸Œæœ›èƒ½å¤Ÿé«˜æ•ˆåœ°æŸ¥è¯¢æŸä¸ªåŒºé—´çš„æœ€å¤§å‰ç¼€å’Œã€‚ä¸¾ä¸ªä¾‹å­ï¼Œ[1,-2,3,-4]çš„å‰ç¼€å’Œæ˜¯2ï¼Œå¯¹åº”çš„å‰ç¼€æ˜¯[1,-2,3]ã€‚\nä¸ºäº†ä½¿ç”¨çº¿æ®µæ ‘è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œæˆ‘ä»¬ç”¨æ¯ä¸ªèŠ‚ç‚¹å­˜å‚¨å¯¹åº”åŒºé—´çš„ä¸¤ä¸ªå‡½æ•°å€¼ï¼šæœ€å¤§å‰ç¼€å’Œå’ŒåŒºé—´å’Œã€‚ä¸€ä¸ªéå¶èŠ‚ç‚¹çš„åŒºé—´å’Œæ˜¯å®ƒçš„ä¸¤ä¸ªå­èŠ‚ç‚¹åŒºé—´å’Œçš„å’Œã€‚ä¸ºäº†æ‰¾åˆ°ä¸€ä¸ªéå¶èŠ‚ç‚¹çš„æœ€å¤§å‰ç¼€å’Œï¼Œæˆ‘ä»¬æ³¨æ„åˆ°æœ€å¤§å‰ç¼€å’Œå¯¹åº”çš„å‰ç¼€çš„æœ€åä¸€ä¸ªå…ƒç´ è¦ä¹ˆåœ¨å·¦å­èŠ‚ç‚¹å¯¹åº”çš„åŒºé—´å†…ï¼Œè¦ä¹ˆåœ¨å³å­èŠ‚ç‚¹å¯¹åº”çš„åŒºé—´å†…ã€‚å‰ä¸€ç§æƒ…å†µï¼Œæˆ‘ä»¬å¯ä»¥ç›´æ¥ä»å·¦å­èŠ‚ç‚¹è·å–æœ€å¤§å‰ç¼€å’Œï¼Œè€Œåä¸€ç§æƒ…å†µï¼Œæˆ‘ä»¬é€šè¿‡å·¦å­èŠ‚ç‚¹çš„åŒºé—´å’Œå’Œå³å­èŠ‚ç‚¹çš„æœ€å¤§å‰ç¼€å’Œç›¸åŠ è·å¾—ã€‚è¿™ä¸¤ä¸ªæ•°ä¸­çš„è¾ƒå¤§è¿™å°±æ˜¯æˆ‘ä»¬çš„æœ€å¤§å‰ç¼€å’Œã€‚æŸ¥è¯¢ä¹Ÿæ˜¯ç±»ä¼¼çš„ï¼Œä½†æ˜¯å¯èƒ½ä¼šæœ‰è¶…è¿‡ä¸¤ä¸ªç›¸é‚»çš„åŒºé—´ï¼ˆè¿™ç§æƒ…å†µä¸‹æœ€å¤§å‰ç¼€å’Œçš„æœ€åä¸€ä¸ªå…ƒç´ å¯èƒ½åœ¨å®ƒä»¬ä¸­çš„ä»»ä½•ä¸€ä¸ªï¼‰ã€‚\nMaximum/minimum subvector sum è¿™ä¸ªé—®é¢˜æ˜¯æŸ¥è¯¢ç»™å®šåŒºé—´å†…æ‰€æœ‰å­åŒºé—´çš„æœ€å¤§å’Œã€‚å’Œä¸Šä¸€èŠ‚æœ€å¤§å‰ç¼€å’Œçš„é—®é¢˜ç±»ä¼¼ï¼Œä½†æ˜¯å­åŒºé—´çš„ç¬¬ä¸€ä¸ªå…ƒç´ å¹¶ä¸ä¸€å®šåœ¨åŒºé—´çš„å¼€å§‹ã€‚([1,-2,3,-4]æœ€å¤§å­åŒºé—´å’Œæ˜¯3ï¼Œå¯¹åº”çš„å­åŒºé—´æ˜¯[3])ã€‚æ¯ä¸ªèŠ‚ç‚¹éœ€è¦å­˜å‚¨4ä»½ä¿¡æ¯ï¼šæœ€å¤§å‰ç¼€å’Œï¼Œæœ€å¤§åç¼€å’Œï¼Œæœ€å¤§å­åŒºé—´å’Œï¼ŒåŒºé—´å’Œã€‚è¯¦ç»†è®¾è®¡ç•™ä½œä¹ é¢˜ã€‚\n\u0026ldquo;Stabbing query\u0026rdquo; For more details, please visit the original page. ğŸº\nExtension to two or more dimensions çº¿æ®µæ ‘å¹¶ä¸åªé™äºè§£å†³ä¸€ç»´æ•°ç»„çš„é—®é¢˜ã€‚åŸåˆ™ä¸Šæ¥è¯´ï¼Œå®ƒå¯ä»¥è¢«ç”¨äºä»»æ„çº¬åº¦çš„æ•°ç»„ï¼ŒåŒºé—´å°†è¢«ç®±å­ç­”é¢˜ã€‚å› æ­¤ï¼Œåœ¨ä¸€ä¸ªäºŒç»´æ•°ç»„ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥æŸ¥è¯¢ä¸€ä¸ªç®±å­å†…çš„æœ€å°å…ƒç´ ï¼Œæˆ–è€…ä¸¤ä¸ªåŒºé—´çš„ç¬›å¡å°”ä¹˜ç§¯ã€‚\nFor more details, please visit the original page. ğŸº\nLazy propagation æŸäº›ç±»å‹çš„çº¿æ®µæ ‘æ”¯æŒåŒºé—´æ›´æ–°ã€‚ä¸¾ä¸ªä¾‹å­ï¼Œè€ƒè™‘ä¸€ä¸ªåŒºé—´æœ€å°å€¼é—®é¢˜çš„å˜ç§ï¼šæˆ‘ä»¬éœ€è¦èƒ½å¤Ÿæ›´æ–°ä¸€ä¸ªåŒºé—´å†…æ‰€æœ‰çš„å…ƒç´ åˆ°æŸä¸ªç‰¹å®šçš„å€¼ã€‚è¿™è¢«ç§°ä¸ºåŒºé—´æ›´æ–°ã€‚æ‡’ä¼ æ’­æ˜¯ä¸€ç§å¯ä»¥ä½¿å¾—åŒºé—´æ›´æ–°å’Œå•ä¸ªå…ƒç´ æ›´æ–°ä¸€æ ·èƒ½å¤Ÿåœ¨ $\\mathcal{O}(\\lg N)$ æ—¶é—´å†…å®Œæˆçš„æŠ€æœ¯ã€‚\nå®ƒçš„å·¥ä½œåŸç†å¦‚ä¸‹ï¼šæ¯ä¸ªèŠ‚ç‚¹é¢å¤–æ‹¥æœ‰ä¸€ä¸ªlazyåŸŸï¼Œç”¨äºä¸´æ—¶å­˜å‚¨ã€‚å½“è¿™ä¸ªåŸŸä¸è¢«ä½¿ç”¨æ˜¯ï¼Œä»¤å®ƒçš„å€¼ä¸º $+\\infty$ã€‚å½“æ›´æ–°ä¸€ä¸ªåŒºé—´æ˜¯ï¼Œæˆ‘ä»¬é€‰ä¸­å’ŒæŸ¥è¯¢ä¸€æ ·çš„é‚£äº›åŒºé—´ã€‚å¦‚æœåŒºé—´ä¸æ˜¯å¶èŠ‚ç‚¹ï¼Œåˆ™æ›´æ–°å®ƒä»¬çš„lazyåŸŸåˆ°æ–°çš„æœ€å°å€¼(å¦‚æœæ–°çš„æœ€å°å€¼æ¯”åŸæ¥å°çš„è¯)ï¼Œå¦åˆ™ç›´æ¥å°†å€¼æ›´æ–°åˆ°èŠ‚ç‚¹ä¸Šã€‚å½“æŸ¥è¯¢æˆ–æ˜¯æ›´æ–°æ“ä½œéœ€è¦è®¿é—®ä¸€ä¸ªèŠ‚ç‚¹çš„åä»£ï¼Œå¹¶ä¸”è¿™ä¸ªèŠ‚ç‚¹çš„lazyåŸŸæœ‰å€¼ï¼Œæˆ‘ä»¬å°†lazyåŸŸå†…çš„å€¼æ›´æ–°åˆ°å®ƒçš„ä¸¤ä¸ªå­èŠ‚ç‚¹ä¸Šï¼šç”¨çˆ¶èŠ‚ç‚¹lazyåŸŸå†…çš„å€¼æ›´æ–°åˆ°ä¸¤ä¸ªå­èŠ‚ç‚¹çš„lazyåŸŸä¸Šï¼Œç„¶åå°†çˆ¶èŠ‚ç‚¹çš„lazyåŸŸé‡æ–°è®¾ç½®ä¸º $+\\infty$ã€‚ä½†æ˜¯ï¼Œå¦‚æœæˆ‘ä»¬åªæ˜¯æƒ³è¦è¯¥èŠ‚ç‚¹çš„å€¼ï¼Œå¹¶ä¸è®¿é—®å®ƒçš„ä»»ä½•å­èŠ‚ç‚¹ï¼Œå¹¶ä¸”lazyåŸŸæœ‰å€¼ï¼Œæˆ‘ä»¬å¯ä»¥ç›´æ¥è¿”å›lazyå†…çš„å€¼å½“åšæ˜¯åŒºé—´å†…æœ€å°å€¼ã€‚\nReference [1] https://wcipeg.com/wiki/Segment_tree\nApendix C++ æœ€å¤§æŸ¥è¯¢ã€åŒºé—´æ›´æ–°ã€æ‡’ä¼ æ’­ class SegmentTree { private: int n; vector\u0026lt;int\u0026gt; max_val, to_add; void push(int i, int tl, int tr) { max_val[i] += to_add[i]; if (tl != tr - 1) { to_add[2 * i + 1] += to_add[i]; to_add[2 * i + 2] += to_add[i]; } to_add[i] = 0; } void add(int i, int tl, int tr, int l, int r, int delta) { push(i, tl, tr); if (tl \u0026gt;= r || tr \u0026lt;= l) { return; } if (l \u0026lt;= tl \u0026amp;\u0026amp; tr \u0026lt;= r) { to_add[i] += delta; push(i, tl, tr); return; } int tm = (tl + tr) / 2; add(2 * i + 1, tl, tm, l, r, delta); add(2 * i + 2, tm, tr, l, r, delta); max_val[i] = max(max_val[2 * i + 1], max_val[2 * i + 2]); } int get(int i, int tl, int tr, int l, int r) { push(i, tl, tr); if (tl \u0026gt;= r || tr \u0026lt;= l) { return 0; } if (l \u0026lt;= tl \u0026amp;\u0026amp; tr \u0026lt;= r) { return max_val[i]; } int tm = (tl + tr) / 2; return max(get(2 * i + 1, tl, tm, l, r), get(2 * i + 2, tm, tr, l, r)); } public: SegmentTree(int k) { n = 1; while (n \u0026lt; k) { n *= 2; } max_val = vector\u0026lt;int\u0026gt;(2 * n, 0); to_add = vector\u0026lt;int\u0026gt;(2 * n, 0); } void add(int l, int r, int delta) { add(0, 0, n, l, r, delta); } int get(int l, int r) { return get(0, 0, n, l, r); } }; ","date":"2017-09-08T12:58:11+08:00","permalink":"https://blog.crazyark.me/p/segment-tree/","title":"çº¿æ®µæ ‘ (Segment Tree)"},{"content":"åŸé¢˜ç›®åœ¨ AtCoder Grand Contest 019ï¼ŒF - Yes or Noã€‚\næŠŠå®ƒæ”¹æˆæ•°å­¦é¢˜ï¼Œé¢˜ç›®å¤§æ„å¦‚ä¸‹ï¼š\nå‡è®¾ä½ æœ‰M+Nä¸ªé—®é¢˜è¦å›ç­”ï¼Œæ¯ä¸ªé—®é¢˜çš„å›ç­”ä¸æ˜¯Yeså°±æ˜¯Noã€‚ä½ çŸ¥é“å…¶ä¸­æœ‰Nä¸ªYesï¼ŒMä¸ªNoï¼Œä½†æ˜¯å¹¶ä¸çŸ¥é“é¡ºåºã€‚ä½ å°†æŒ‰é¡ºåºä¸€ä¸ªä¸€ä¸ªå›ç­”é—®é¢˜ï¼Œå¹¶ä¸”ç­”å®Œä¸€é“é¢˜åç«‹åˆ»å°±èƒ½çŸ¥é“è¿™é“é¢˜çš„æ­£ç¡®ç­”æ¡ˆã€‚ å‡è®¾ä½ æ¯æ¬¡å›ç­”é—®é¢˜éƒ½é‡‡å–æœ€å¤§åŒ–æœŸæœ›æ­£ç¡®é¢˜ç›®æ•°çš„æ–¹å¼ï¼Œè¯·é—®æœŸæœ›æ­£ç¡®é¢˜ç›®æ•°æ˜¯å¤šå°‘ï¼Ÿ\næ­£ç¡®ç­”æ¡ˆ ä»¤ $E(M, N)$ è¡¨ç¤ºå·²çŸ¥(M, N)x(Yes, No)çš„æœŸæœ›æ­£ç¡®é¢˜ç›®æ•°ã€‚\nåˆ™\n$E(M, N) = E(N, M)$ï¼Œä¸”\n$E(M, N) = \\dfrac{\\sum\\limits_{k = 1}^{k = N}\\binom{2k}{k}\\binom{M + N - 2k}{N - k}}{2\\binom{M + N}{N}} + M, M \\ge N$\nå½’çº³è¯æ˜ æ˜¾ç„¶ï¼Œæ‰€è°“æœ€å¤§åŒ–æœŸæœ›çš„æ–¹å¼å°±æ˜¯é€‰å½“å‰ç­”æ¡ˆå¤šçš„é‚£ä¸ªï¼Œæ‰€ä»¥æœ‰\n$E(M, N) = \\dfrac{M}{M + N}\\left(E(M - 1, N) + 1\\right) + \\dfrac{N}{M + N}E(M, N - 1), M \\ge N$\n$E(M, 0) = M$\nç”±ä¸¤æ¡åŠå¯¹ç§°æ€§ $E(M, N) = E(N, M)$ å¯ä»¥æ¨å‡ºä»»ä½• $E(M, N)$ã€‚\nä»¤ $F(M, N) = E(M, N) - M, M \\ge N$ï¼Œä»¥åŠ $F(M, N) = F(N, M)$\næˆ‘ä»¬æœ‰\n$F(M, N) = \\dfrac{M}{M + N}F(M - 1, N) + \\dfrac{N}{M + N}F(M, N - 1), M \\gt N$ $F(N, N) = F(N, N - 1) + \\dfrac{1}{2}$ ä»¤ $G(M, N) = \\binom{M + N}{N}F(M, N), M \\ge N$ï¼ŒåŒæ ·æœ‰ $G(M, N) = G(N, M)$\nåŒæ—¶ä¸‹ä¸¤å¼æˆç«‹\n$G(M, N) = G(M - 1, N) + G(M, N - 1), M \\gt N$ $G(N, N) = \\dfrac{1}{2}\\binom{2N}{N} + 2G(N, N-1)$ æ‰€ä»¥æˆ‘ä»¬åªéœ€è¦éªŒè¯ $G(M, N) = \\dfrac{\\sum\\limits_{k = 1}^{k = N}\\binom{2k}{k}\\binom{M + N - 2k}{N - k}}{2} = \\sum\\limits_{k = 1}^{k = N}\\binom{2k - 1}{k}\\binom{M + N - 2k}{N - k}, M\\ge N$ å³å¯ã€‚\né¦–å…ˆæ˜¾ç„¶ $G(M, 0) = 0$ æˆç«‹ã€‚\nä»¤ $M = N = 1$ï¼Œæœ‰$G(1, 1) = 1 + 2G(1, 0) = 1$ï¼Œä¸” $G(M, 1) = G(M - 1, 1) + G(M, 0), M \\gt 1$ï¼Œæ‰€ä»¥ $G(M, 1) = 1, M \\ge 1$ æˆç«‹ã€‚\nå‡è®¾å¯¹ $\\forall n.n \\le N - 1, \\forall m.m\\ge n$, éƒ½æœ‰ $G(m, n) = \\sum\\limits_{k = 1}^{k = n}\\binom{2k - 1}{k}\\binom{m + n - 2k}{n - k}$, åˆ™æœ‰\n$G(N, N) = \\binom{2N - 1}{N - 1} + 2\\sum\\limits_{k = 1}^{k = N - 1}\\binom{2k - 1}{k}\\binom{2N - 1 - 2k}{N - k}$ $ = \\binom{2N - 1}{N - 1} + \\sum\\limits_{k = 1}^{k = N - 1}\\binom{2k - 1}{k}\\binom{2N - 2k}{N - 1 - k}$ $=\\sum\\limits_{k = 1}^{k = N}\\binom{2k - 1}{k}\\binom{2N - 2k}{N - k}$\nå‡è®¾ $\\forall m. m \\le M, m \\ge n$, ä¸Šå¼åŒæ ·æˆç«‹ï¼Œåˆ™æœ‰\n$G(M + 1, N) = G(M, N) + G(M + 1, N - 1)$ $= \\sum\\limits_{k = 1}^{k = N}\\binom{2k - 1}{k}\\binom{M + N - 2k}{N - k} + \\sum\\limits_{k = 1}^{k = N - 1}\\binom{2k - 1}{k}\\binom{M + N - 2k}{N - 1- k}$ $ = \\sum\\limits_{k = 1}^{k = N - 1}\\binom{2k - 1}{k}\\left(\\binom{M + N - 2k}{N - k} + \\binom{M + N- 2k}{N - 1- k}\\right) + \\binom{2N-1}{N}$ $ = \\sum\\limits_{k = 1}^{k = N - 1}\\binom{2k - 1}{k}\\binom{M + N + 1 - 2k}{N - k}+ \\binom{2N-1}{N} = \\sum\\limits_{k = 1}^{k = N}\\binom{2k - 1}{k}\\binom{M + N + 1 - 2k}{N - k}$\næ‰€ä»¥ $\\forall n.n\\le N, \\forall m.m\\ge n$ï¼Œä¸Šå¼æˆç«‹ã€‚\næ‰€ä»¥ $\\forall m, \\forall n.m \\ge n$ï¼Œä¸Šå¼æˆç«‹ã€‚\nè¯æ¯•ã€‚\nå¤´ç–¼çš„é—®é¢˜ çœ‹è¿™ä¸ªè§£çš„å½¢å¼ï¼Œæ„Ÿè§‰ä¸Šå»åƒæ˜¯å¯ä»¥æœ‰æ„é€ è§£ï¼Œä½†æ˜¯æˆ‘ç»å°½è„‘æ±ä¹Ÿæƒ³ä¸å‡ºæ¥ã€‚è€Œä¸”æ›´å…³é”®çš„æ˜¯ï¼Œåœ¨ä¸çŸ¥é“è§£å½¢å¼çš„æƒ…å†µä¸‹ï¼Œæ ¹æœ¬ä¸èƒ½å®Œæˆä¸Šè¿°å½’çº³è¯æ˜\u0026hellip;\næˆ‘æƒ³æˆ‘å¾—æ±‚åŠ©ä¸‹è€æœ‹å‹\u0026hellip;æˆ–è€…å‘ä¸ªé‚®ä»¶é—®ä¸‹è§£é¢˜çš„å¤§ä½¬äº†\u0026hellip;\næ„é€ è§£ ç»“æœåˆšæ´—å®Œæ¾¡å°±ç ”ç©¶å‡ºæ¥äº†\u0026hellip;éš¾é“æ˜¯ä¼ è¯´ä¸­çš„æ´—æ¾¡è§£é¢˜æ³•ï¼Ÿï¼Ÿï¼Ÿ\né—®é¢˜æ˜ å°„ å‡è®¾æˆ‘ä»¬æœ‰ä¸€ä¸ªMxNçš„çŸ©å½¢æ ¼å­ï¼Œæˆ‘ä»¬æŠŠæ ¼å­æ”¾ç½®åœ¨åæ ‡ç³»ç¬¬ä¸€è±¡é™ï¼Œæ ¼å­å·¦ä¸‹è§’åœ¨(0, 0)ï¼Œå³ä¸Šè§’åœ¨(M, N)ã€‚\né‚£ä¹ˆï¼Œä¸€å…±å­˜åœ¨ $\\binom{M + N}{N}$ æ¡ä¸åŒçš„è·¯å¾„èƒ½å¤Ÿè¿é€šå·¦ä¸‹è§’å’Œå³ä¸Šè§’ï¼Œ(ä»å·¦ä¸‹åˆ°å³ä¸Šä¸ºMæ¬¡å‘å³å’ŒNæ¬¡å‘ä¸Šçš„æ’åˆ—)ã€‚\nä¸‹è¿°æ‰€æœ‰è·¯å¾„æ„é€ è¿‡ç¨‹å‡ä»å³ä¸Šè§’(M,N)è‡³å·¦ä¸‹è§’(0,0)ï¼Œä¸” M \u0026gt;= Nï¼Œæå‰å£°æ˜ã€‚\nä¸‹é¢å®šä¹‰ä¸€æ¡è·¯å¾„åˆ°ç­”é¢˜æ–¹å¼çš„æ˜ å°„ï¼š\nå½“å¤„äºæ ¼ç‚¹ (x, y) æ—¶ï¼Œè¡¨æ˜å½“å‰è¿˜å‰© x + y é¢˜ï¼Œå…¶ä¸­ x é¢˜ä¸ºYesï¼Œyé¢˜ä¸ºNo å½“å¤„äºæ ¼ç‚¹ (x, y) æ—¶ å¦‚æœ x \u0026gt;= yï¼Œé‚£ä¹ˆè·¯å¾„å‘å·¦(x - 1, y)è¡¨æ˜(ç­”Yesï¼Œæ­£ç¡®)ï¼Œå‘ä¸‹(x, y - 1)è¡¨æ˜(ç­”Yesï¼Œé”™è¯¯) å¦‚æœ x \u0026lt; y, åˆ™å‘å·¦(x - 1, y)è¡¨æ˜(ç­”Noï¼Œé”™è¯¯)ï¼Œå‘ä¸‹è¡¨æ˜(ç­”Noï¼Œæ­£ç¡®) æ˜¾ç„¶ï¼Œé€šè¿‡ä¸Šè¿°è¡¨ç¤ºæ˜ å°„ï¼Œä¸€æ¡è·¯å¾„å”¯ä¸€åœ°ç¡®å®šå‡ºé¢˜å’Œç­”é¢˜æ–¹å¼ï¼Œåä¹‹äº¦ç„¶ã€‚\né‚£ä¹ˆåŸé—®é¢˜ä¸­æ­£ç¡®ç­”æ¡ˆçš„æ•°ç›®æ€ä¹ˆè®¡ç®—å‘¢ï¼Ÿå¯ä»¥çœ‹åˆ°ï¼Œè·¯å¾„ç»è¿‡æ ¼ç‚¹(x, y)æ—¶ï¼Œæ­£ç¡®æˆ–æ˜¯é”™è¯¯æ˜¯ç”±è·¯å¾„èµ°å‘å”¯ä¸€ç¡®å®šçš„ï¼Œä¹Ÿå°±æ˜¯ç”±è¾¹å”¯ä¸€ç¡®å®šçš„\næ‰€æœ‰ x \u0026gt;= y, (x, y)-(x - 1, y) çš„è¾¹è®¡æ•°ä¸º1ï¼Œ(x, y)-(x, y - 1)çš„è¾¹è®¡æ•°ä¸º0 æ‰€æœ‰ x \u0026lt; y, (x, y)-(x - 1, y) çš„è¾¹è®¡æ•°ä¸º0ï¼Œ(x, y)-(x, y - 1)ä¸º1 æˆ‘ä»¬å°†è®¡æ•°æ ‡åˆ°æ ¼å­çš„æ‰€æœ‰è¾¹ä¸Šï¼Œé‚£ä¹ˆæˆ‘ä»¬æ­£ç¡®ç­”æ¡ˆçš„è®¡æ•°å°±ç­‰äºæ‰€æœ‰è·¯å¾„ä¸Šæ‰€ç»è¿‡çš„è¾¹æƒå’Œã€‚\né—®é¢˜æ±‚è§£ è¿™é‡Œæˆ‘ä¸ç”»å›¾ï¼Œå¤§å®¶è¿˜æ˜¯åœ¨ç¨¿çº¸ä¸Šç”»ä¸€ä¸‹ã€‚\nä»¤ $w(x, y, 1)$ ä»£è¡¨(x,y)-(x-1,y)è¾¹ä¸Šçš„æƒï¼Œ$w(x, y, 0)$ä»£è¡¨(x, y-1)è¾¹ä¸Šçš„æƒï¼Œé‚£ä¹ˆ\n$x \\ne y, w(x, y, 1) = w(y, x, 0)$ $x = y, w(x, y, 1) = 1, w(x, y, 0) = 0$ è¿™ä¸ªè„‘è¡¥å‡ºæ¥å°±æ˜¯é™¤äº†(x, x)æ ¼ç‚¹å‡ºæ¥çš„è¾¹ï¼Œå…¶ä½™è¾¹éƒ½å…³äº$y = x$å¯¹ç§°ã€‚\nå‡è®¾ä»»æ„ä¸€æ¡è·¯å¾„Sï¼Œå…¶åœ¨æ ¼å­å†…ä¸y=xå¯¹ç§°å¾—åˆ°çš„è·¯å¾„ä¸ºS\u0026rsquo; (å¯ä»¥å¯¹ç§°çš„éƒ¨åˆ†å¯¹ç§°)ã€‚\nä»¤$w(S)$è¡¨ç¤ºSä¸Šæ‰€æœ‰è¾¹çš„åŠ æƒå’Œï¼Œå¯ä»¥è¯æ˜ï¼š\n$w(S) + w(S\u0026rsquo;)= 2M + |S \\cap {(x, y) | y = x}|$\nè¯æ˜å¦‚ä¸‹ï¼š\næ˜¾ç„¶ï¼Œå‡è®¾ S ä¸ $y = x$ ç¬¬ä¸€æ¬¡ç›¸äº¤äº (X, X)ï¼Œé‚£ä¹ˆåˆ°è¾¾ (X, X)ä¹‹å‰æƒå’Œæ€»å…±ä¸º (M - X)ï¼›\nä» (X, X) å¼€å§‹åˆ° (0, 0)ï¼Œä¸¤æ¡è·¯å¾„ S + S\u0026rsquo; çš„åŠ æƒå’Œä¸º $2X + |S \\cap {(x, y) | y = x}|$ï¼š\nå› ä¸ºå‡è®¾ $w(x,x,1)=w(x,x,0)=0$ï¼Œé‚£ä¹ˆè¾¹å…³äº$y=x$å°±å®Œå…¨å¯¹ç§°ï¼Œæˆ‘ä»¬å°†Sæ‰€æœ‰è·¯å¾„å…¨éƒ¨ç¿»åˆ°$y=x$ä¹‹ä¸Šä¸å½±å“è·¯å¾„æƒå’Œï¼Œåˆ™å‘ä¸‹æ°¸è¿œä¸º1ï¼Œå‘å·¦æ°¸è¿œä¸º0ï¼Œæƒå’Œä¸ºXã€‚è€Œ S + S\u0026rsquo; ä¸­ $w(x,x,1)$å’Œ$w(x,x,0)$ éƒ½åªèƒ½è·å¾—ä¸€æ¬¡ï¼Œæ‰€ä»¥ä¸Šå¼æˆç«‹ã€‚\næ‰€ä»¥å¯¹äºæ‰€æœ‰è·¯å¾„ï¼Œè¾¹æƒå’Œä¸º $W = \\sum\\limits_{S}w(S) = \\sum\\limits_{S}\\dfrac{2M + |S \\cap {(x, y) | y = x}|}{2}$ï¼Œä¹Ÿå°±æ˜¯\n$W = M\\binom{M + N}{N} + \\frac{\\sum\\limits_{S}{|S \\cap {(x, y) | y = x}|}}{2}$ï¼Œæˆ‘ä»¬åªéœ€è¦å†è®¡ç®—æ¯ä¸ª(x,x)ç‚¹è¢«è¢«å¤šå°‘æ¡è·¯å¾„ç»è¿‡ï¼Œå†åŠ å’Œå°±è¡Œã€‚\nå¯¹äºä¸€ä¸ªç‚¹(x,y)ï¼Œç»è¿‡çš„è·¯å¾„æ•°ä¸º$\\binom{x + y}{x}\\binom{M + N - x - y}{N - y}$ï¼Œè¶…çº§æ˜¾ç„¶\u0026hellip;\næ‰€ä»¥ï¼Œ$W = M\\binom{M + N}{N} + \\frac{\\sum\\limits_{k = 1}^{N}\\binom{2k}{k}\\binom{M + N - 2k}{N - k}}{2}$ã€‚\næ‰€ä»¥æœŸæœ›ä¸º $\\dfrac{W}{\\binom{M + N}{N}} = M + \\frac{\\sum\\limits_{k = 1}^{N}\\binom{2k}{k}\\binom{M + N - 2k}{N - k}}{2\\binom{M + N}{N}}$ï¼Œç»ˆäºè¯æ¯•ã€‚\nåœ¨è¯æ˜è¿‡ç¨‹ä¸­å¯ä»¥å‘ç°ä¸€ä¸ªå¾ˆæœ‰æ„æ€çš„äº‹å®ï¼Œåœ¨å›ç­”é—®é¢˜çš„è¿‡ç¨‹ä¸­ï¼Œå¦‚æœå½“å‰å‰©ä½™çš„M=Nï¼Œç›´æ¥æ”¾å¼ƒç­”é¢˜å¹¶æŸ¥çœ‹ç­”æ¡ˆï¼Œé‚£ä¹ˆç­”å¯¹çš„é¢˜ç›®æ•°æ°¸è¿œæ˜¯Mã€‚\næ€»ç»“ è„‘å­ä¸å¥½ä½¿çš„æ—¶å€™ï¼Œæˆ‘é€‰æ‹©æ´—æ¾¡ğŸ›€ï¼ˆè¯¯\nè¿™é¢˜çš„è§£æ³•æ„é€ ååˆ†å·§å¦™ï¼Œæ²¡å›¾è§£é‡Š/ç†è§£èµ·æ¥ä¼šå¾ˆç´¯ï¼Œå¤§å®¶çœ‹çš„æ—¶å€™è¿˜æ˜¯è‡ªå·±ç”»ä¸€ç”»å›¾æ¯”è¾ƒå¥½ã€‚\næˆ‘èŠ±äº†ä¸‰å¤©æ—¶é—´æ‰æƒ³å‡ºæ¥ï¼ŒæœŸé—´è¿˜çœ‹äº†editorialï¼Œæç¤ºäº†æˆ‘æ ¼å­æ„é€ æ³•\u0026hellip;å¦‚æœç­”é¢˜æ²¡ä»€ä¹ˆæ—¶é—´æƒ³ï¼Œæˆ‘å¤§æ¦‚å°±ç›´æ¥O(MN)çš„dpäº†\u0026hellip;\né™„å½• å°ç»“è®º è¿™æ¬¡ç ”ç©¶é¢˜ç›®è¿˜æœ‰ä¸€ä¸ªå°ç»“è®ºï¼Œå‡è®¾ $p$ æ˜¯è´¨æ•°ï¼Œ$a, b, c, d$ ä¸ $p$ å‡äº’è´¨ï¼Œä¸”å­˜åœ¨ $x, y \\lt p$ï¼Œä½¿å¾— $a \\equiv bx \\ (\\textrm{mod} \\ p)$ï¼Œ$c \\equiv dy \\ (\\textrm{mod} \\ p)$ã€‚\né‚£ä¹ˆ $ad + bc \\equiv (x + y)bd \\ (\\textrm{mod} \\ p)$ï¼Œè¯æ˜å¦‚ä¸‹\n$ad + bc \\equiv xbd^pb^{p - 1} + ydb^pd^{p - 1} \\ (\\textrm{mod} \\ p) \\equiv (bd)^p(x + y) \\ (\\textrm{mod} \\ p) \\equiv bd(x + y) \\ (\\textrm{mod} \\ p)$ï¼Œè¯æ¯•ã€‚\nç”¨äºåˆ†æ•° $\\frac{a}{b}$ å¯¹äº $p$ çš„æ¨¡æ•° $ab^{-1} \\ (\\textrm{mod} \\ p)$ çš„åŠ å’Œã€‚\n","date":"2017-09-06T21:16:06+08:00","permalink":"https://blog.crazyark.me/p/agc019-mysterious-combinators/","title":"ç¥å¥‡çš„ç»„åˆæ•° (AGC019-F Mysterious Combinators)"},{"content":"æœ€é•¿é€’å¢å­åºåˆ—ç®—æ³•ï¼ŒåŸæœ¬ä»¥ä¸ºå·²ç»è®°ä½äº†æœ€å¿«çš„ç®—æ³•ï¼Œçœ‹æ¥æ˜¯è®°æ€§å¤ªå·®ï¼Œä»Šå¤©ç¢°åˆ°ä¸€é“é¢˜ç›®åˆå¿˜è®°äº†æ€ä¹ˆåš ğŸ™„\nä¸‰ç§åšæ³•ï¼šDPï¼ŒSort + LCSï¼ŒDP + BSï¼Œæˆ‘åªè®°å¾—ç¬¬ä¸€ç§DPäº† \u0026hellip;\nç„¶åå’±ä»¬é¡ºä¾¿æŠŠæŸé“é¢˜ç›®åšäº† ğŸ¤£\nAlgorithms for LIS DP å¾ˆæ˜¾ç„¶ï¼Œä»¥ç¬¬iä¸ªå…ƒç´ ä¸ºç»“å°¾çš„æœ€é•¿é€’å¢å­åºåˆ—çš„é•¿åº¦æ˜¯ max{dp[j] + 1}, j \u0026lt; i \u0026amp;\u0026amp; arr[j] \u0026lt; arr[i]ï¼Œæ‰€ä»¥DPç©ºé—´å¤æ‚åº¦ O(n)ï¼Œæ—¶é—´å¤æ‚åº¦ O(n^2)ã€‚\nint LIS(vector\u0026lt;int\u0026gt; nums) { int n = nums.size(); int dp[n]; int res = 0; for (int i = 0; i \u0026lt; n; ++ i) { dp[n] = 1; for (int j = 0; j \u0026lt; i; ++ j) { if (nums[j] \u0026lt; nums[i]) dp[i] = max(dp[i], dp[j] + 1); } res = max(res, dp[i]); } return res; } Sort + LCS åŸæ•°ç»„çš„é€’å¢å­åºåˆ—ä¸€å®šæ˜¯æ’åºåæ•°ç»„å’ŒåŸæ¥æ•°ç»„çš„å…¬å…±å­åºåˆ—ï¼Œæ‰€ä»¥æ’å®Œåºæ‰¾æœ€é•¿å…¬å…±å­åºåˆ—å°±è¡Œäº†ã€‚\nç©ºé—´å¤æ‚åº¦ O(n^2)ï¼Œæ—¶é—´å¤æ‚åº¦ O(n^2)ã€‚\nint LCS(vector\u0026lt;int\u0026gt; a, vector\u0026lt;int\u0026gt; b) { assert(a.size() == b.size()); int n = a.size(); int dp[n + 1][n + 1]; for (int i = 0; i \u0026lt; n; ++ i) { for (int j = 0; j \u0026lt; n; ++ j) { if (i == 0 || j == 0) dp[i][j] = 0; else if (a[i - 1] == b[j - 1]) dp[i][j] = dp[i - 1][j - 1] + 1; else dp[i][j] = max(dp[i - 1][j], dp[i][j - 1]); } } return dp[n][n]; } int LIS(vector\u0026lt;int\u0026gt; nums) { auto sorted = nums; sort(sorted.begin(), sorted.end()); return LCS(nums, sorted); } DP + BS è¿™æ˜¯æœ€å¿«çš„ä¸€ä¸ªç®—æ³•ï¼Œä¹Ÿæ˜¯æˆ‘åˆ°ç°åœ¨éƒ½è¿˜æ²¡è®°ä½çš„ç®—æ³• ğŸ™„ï¼Œå…³é”®æ€æƒ³ä¸ºç»´æŠ¤ä¸€ä¸ªæ•°ç»„ï¼Œæ•°ç»„ä¸­ç¬¬lé¡¹(1-based) ä¸ºé•¿åº¦ä¸ºlçš„é€’å¢å­åºåˆ—çš„æœ€å¤§(æœ€å)å…ƒç´ çš„æœ€å°å€¼ï¼Œç„¶åä¸æ–­ç»´æŠ¤è¿™ä¸ªæ•°ç»„ç›´åˆ°ç»“æŸï¼Œæœ€ç»ˆæ•°ç»„çš„æœ‰æ•ˆé•¿åº¦å³ä¸ºLISçš„ç»“æœã€‚\nç”±äºç¬¬lé¡¹ä¸ºé•¿åº¦ä¸ºlçš„é€’å¢å­åºåˆ—çš„æœ€å¤§å…ƒç´ çš„æœ€å°å€¼ï¼Œæ‰€ä»¥è¯¥æ•°ç»„ä¸€å®šä¸ºä¸€ä¸ªé€’å¢æ•°ç»„ã€‚å½“ä¸‹ä¸€ä¸ªæ•°néœ€è¦èƒ½å¤Ÿæˆä¸ºæŸä¸ªé€’å¢å­åºåˆ—çš„ç»“å°¾æ—¶ï¼Œæˆ‘ä»¬åœ¨è¯¥æ•°ç»„ä¸­æŸ¥æ‰¾ç¬¬ä¸€ä¸ªä¸æ¯”nå°çš„æ•°ï¼Œå‡è®¾ä½ç½®ä¸ºlï¼Œé‚£ä¹ˆæˆ‘ä»¬å°±çŸ¥é“æˆ‘ä»¬èƒ½ä»¥nç»“å°¾æ„å»ºä¸€ä¸ªæœ€é•¿ä¸ºlçš„é€’å¢å­åºåˆ— (æƒ³æƒ³ä¸ºä»€ä¹ˆï¼Ÿå¾ˆç®€å•)ï¼Œæ­¤æ—¶æˆ‘ä»¬å°±å°†lä½ç½®çš„æ•°ç»„å€¼æ›´æ–°ä¸ºnã€‚æœ‰ä¸€ä¸ªç‰¹æ®Šæƒ…å†µå³æ•°ç»„ä¸­ä¸å­˜åœ¨ä½ç½®lï¼Œé‚£ä¹ˆå°±åœ¨æ•°ç»„æœ€åæ·»åŠ nã€‚\nè¿™é‡ŒæŸ¥æ‰¾å¯ä»¥ä½¿ç”¨äºŒåˆ†æŸ¥æ‰¾çš„æ–¹å¼ï¼Œä»è€Œç©ºé—´å¤æ‚åº¦ä¸º O(n)ï¼Œæ—¶é—´å¤æ‚åº¦ä¸º O(nlgn)ã€‚\nint LIS(vector\u0026lt;int\u0026gt; nums) { vector\u0026lt;int\u0026gt; dp; for (auto n : nums) { auto it = lower_bound(dp.begin(), dp.end(), n); if (it == dp.end()) dp.push_back(n); else *it = n; } return dp.size(); } å…¶å®æˆ‘å‘ç°\u0026hellip;ï¼Œæˆ‘éƒ½ä¸ç”¨æ‰‹å†™BSï¼ŒSTLè¿˜æ˜¯è§£å†³äº†å¾ˆå¤šé—®é¢˜çš„ï¼Œé™¤äº†æ²¡æœ‰Fibonacci Heapä¹‹å¤–æ„Ÿè§‰å¥½åƒä¹Ÿæ²¡å•¥ç¼ºç‚¹äº† (ç¬‘\nAtCoder Grand Contest 019C é¢˜ç›®ï¼š\nIn the city of Nevermore, there are 10e8 streets and 10e8 avenues, both numbered from 0 to 10e8 âˆ’ 1. All streets run straight from west to east, and all avenues run straight from south to north. The distance between neighboring streets and between neighboring avenues is exactly 100 meters. Every street intersects every avenue. Every intersection can be described by pair (x,y), where x is avenue ID and y is street ID.\nThere are N fountains in the city, situated at intersections (Xi,Yi). Unlike normal intersections, there\u0026rsquo;s a circle with radius 10 meters centered at the intersection, and there are no road parts inside this circle. The picture below shows an example of how a part of the city with roads and fountains may look like.\ncity çº¦æŸ:\n0â‰¤x1,y1,x2,y2\u0026lt;10e8 1â‰¤Nâ‰¤200,000 0â‰¤Xi,Yi\u0026lt;10e8 Xiâ‰ Xj for iâ‰ j Yiâ‰ Yj for iâ‰ j Intersections (x1,y1) and (x2,y2) are different and don\u0026rsquo;t contain fountains. All input values are integers. è¾“å…¥:\nx1 y1 x2 y2 N X1 Y1 X2 Y2 : XN YN\nè¾“å‡º:\nPrint the shortest possible distance one needs to cover in order to get from intersection (x1,y1) to intersection (x2,y2), in meters. Your answer will be considered correct if its absolute or relative error doesn\u0026rsquo;t exceed 10eâˆ’11.\nSamples:\nI: 1 1 6 5 3 3 2 5 3 2 4\nO: 891.415926535897938\nI: 3 5 6 4 3 3 2 5 3 2 4\nO: 400.000000000000000\nI: 4 2 2 2 3 3 2 5 3 2 4\nO: 211.415926535897938\nOkï¼Œä¸€ä¸ªç½‘æ ¼ç»™å®šä¸¤ä¸ªç‚¹ï¼Œé‚£ä¹ˆä¸è€ƒè™‘å–·æ³‰çš„èµ°æ³•æ˜¯å›ºå®šçš„ï¼Œé•¿åº¦ä¸º abs(x1 - x2) + abs(y1 - y2)ã€‚\nç”±å¯¹ç§°æ€§ï¼Œæˆ‘ä»¬ä¸å¦¨è®¾ x1 \u0026lt;= x2, y1 \u0026lt;= y2ï¼Œè€ƒè™‘å–·æ³‰çš„æƒ…å†µä¸‹ï¼Œä»å–·æ³‰å¤„è½¬è§’èƒ½å¤Ÿå°‘èµ°ä¸€äº›è·¯ï¼Œè€Œç›´èµ°ç»è¿‡å–·æ³‰ä¼šå¤šèµ°ä¸€äº›è·¯ã€‚\nå‡è®¾æˆ‘ä»¬çš„èµ°æ³•æ˜¯ç»•è¿œè·¯è´ªè½¬è§’å°‘èµ°ï¼Œæˆ–æ˜¯é¿å…ç›´èµ°ï¼Œå³èµ°å‡º{(x1, y1), (x2, y2)}æ‰€æ„æˆçš„çŸ©å½¢çš„æƒ…å†µï¼Œç”±äºæ¯è¡Œæ¯åˆ—ä»…æœ‰ä¸€ä¸ªå–·æ³‰ï¼Œæ‰€ä»¥å¤šè¿œç¦»çŸ©å½¢ä¸€æ ¼ä¼šå¯¼è‡´å¤šèµ°200mï¼Œè€Œæœ€å¤šåªèƒ½å°‘èµ° (2 * r - pi * r / 2) å¤§çº¦ä¸º4.5mçš„è·ç¦»ï¼Œæˆ–è€…å°‘èµ°(pi * r - 2 * r) å¤§çº¦ä¸º 11.4m çš„è·ç¦»ï¼Œæ‰€ä»¥æ˜¾ç„¶æ˜¯ä¸å¯èƒ½çš„ã€‚\næ‰€ä»¥èµ°æ³•ä¸€å®šæ˜¯åœ¨{(x1, y1), (x2, y2)}çŸ©å½¢å†…éƒ¨ï¼Œè´ªæœ€å¤šçš„è½¬è§’ã€‚\næ˜¾ç„¶ï¼Œåœ¨ (x1, y1) åˆ° (x2, y2) çš„è·¯ç¨‹ä¸­ï¼Œæœ€å¤šåªæœ‰ c = min(x2 - x1, y2 - y1) æ¬¡è½¬è§’ï¼Œæœ€å¤šæœ‰ c + 1 ä¸ªå–·æ³‰ã€‚\nå‡è®¾å–·æ³‰æ˜¯æŒ‰ç…§xçš„å¤§å°è¿›è¡Œæ’åˆ—çš„ï¼Œé‚£ä¹ˆæˆ‘ä»¬èƒ½è¿‡çš„æœ€å¤šçš„æ¸©æ³‰ç­‰äºæ¸©æ³‰yå€¼æ•°ç»„çš„æœ€é•¿é€’å¢å­åºåˆ—ï¼Œå‡è®¾é•¿åº¦ä¸ºkã€‚\né‚£ä¹ˆæœ‰ä¸¤ç§æƒ…å†µï¼Œ\nk \u0026lt;= c, é‚£ä¹ˆå°±ä¸€å®šæœ‰ä¸€ç§èµ°æ³•ï¼Œä½¿å¾—æˆ‘ä»¬ç»è¿‡è¿™ä¸ªå­åºåˆ—ä¸­æ¯ä¸ªæ¸©æ³‰çš„æ—¶å€™éƒ½æ˜¯è½¬è§’ k == c + 1ï¼Œé‚£ä¹ˆä¸€å®šå­˜åœ¨ä¸€ä¸ªå–·æ³‰éœ€è¦ç»è¿‡ï¼Œæ‰€ä»¥èµ°æ³•æ˜¯èµ°cä¸ªè§’ï¼Œå¹¶ç»è¿‡å‰©ä½™çš„ä¸€ä¸ªã€‚ æ‰€ä»¥å…³é”®å³æ±‚æœ€é•¿é€’å¢å­åºåˆ—ï¼Œæ”¾ä»£ç \n#include \u0026lt;bits/stdc++.h\u0026gt; using namespace std; pair\u0026lt;long long, long long\u0026gt; p[200000]; const double PI = 3.14159265358979323846; const double R = 10.0; const double quarter_circle = PI * R / 2; const double edge = 100.0; using PLL = pair\u0026lt;long long, long long\u0026gt;; int dp[200000]; int main() { long long x1, y1, x2, y2; scanf(\u0026#34;%lld %lld %lld %lld\u0026#34;, \u0026amp;x1, \u0026amp;y1, \u0026amp;x2, \u0026amp;y2); if (x1 \u0026gt; x2) { swap(x1, x2); swap(y1, y2); } long long y_min = min(y1, y2), y_max = max(y1, y2); // drop those not used int n; scanf(\u0026#34;%d\u0026#34;, \u0026amp;n); for (int i = 0; i \u0026lt; n;) { scanf(\u0026#34;%lld %lld\u0026#34;, \u0026amp;p[i].first, \u0026amp;p[i].second); if (p[i].first \u0026lt; x1 || p[i].first \u0026gt; x2 || p[i].second \u0026lt; y_min || p[i].second \u0026gt; y_max) { n--; } else { ++i; } } // x1 \u0026lt;= x2 double res = edge * (x2 - x1 + y_max - y_min); sort(p, p + n, [\u0026amp;](const PLL\u0026amp; a, const PLL\u0026amp; b) { return a.first \u0026lt; b.first; }); if (y1 \u0026gt; y2) { for (int i = 0; i \u0026lt; n; ++i) { p[i].second = -p[i].second; } } int len = 0; for (int i = 0; i \u0026lt; n; ++i) { auto it = lower_bound(dp, dp + len, p[i].second); *it = p[i].second; if (it == dp + len) { len ++; } } int max_corner = min(x2 - x1, y_max - y_min); if (len \u0026lt; max_corner + 1) res += len * (quarter_circle - 2 * R); else res += max_corner * (quarter_circle - 2 * R) + (2 * quarter_circle - 2 * R); printf(\u0026#34;%.15f\\n\u0026#34;, res); return 0; } æ€»ç»“ ä¸€å¤©ä¸åˆ·é¢˜å°±ä¼šå¿˜è®°ç®—æ³•ï¼Œè¿˜æœ‰ atcoder çš„é¢˜è¿˜çœŸæ˜¯éš¾\u0026hellip;\n","date":"2017-09-01T15:41:22+08:00","permalink":"https://blog.crazyark.me/p/longest-increasing-subsequence/","title":"æœ€é•¿é€’å¢å­åºåˆ— (Longest Increasing Subsequence)"},{"content":"ç¬¬ä¸€æ¬¡é‡åˆ°äº†é™¤0ä»¥å¤–çš„SIGFPEï¼Œè®°å½•ä¸€ä¸‹ã€‚\nç—‡çŠ¶ åœ¨ä½¿ç”¨ä»¥ä¸‹å‡½æ•°çš„æ—¶å€™ï¼Œå‡å®š a = 1e18, b = 1e18, m = 1e9 + 7 å°±ä¼šè§¦å‘ SIGFPEã€‚\nlong mulmod(long a, long b, long m) { long res; asm(\u0026#34;mulq %2; divq %3\u0026#34; : \u0026#34;=d\u0026#34;(res), \u0026#34;+a\u0026#34;(a) : \u0026#34;S\u0026#34;(b), \u0026#34;c\u0026#34;(m)); return res; } åŸå›  ä¸»è¦æ˜¯ç”±äº divq S çš„æ‰§è¡Œé€»è¾‘æ˜¯ç”¨ 128bit çš„ %rdx:%rax é™¤ä»¥ Sï¼Œå°†å•†å­˜å…¥ %rax, ä½™æ•°å­˜å…¥ %rdxï¼Œè€Œä¸Šé¢çš„æƒ…å†µ a * b / m å¤ªå¤§ï¼Œè¶…è¿‡äº† 64bitï¼Œæ‰€ä»¥ %rax å­˜ä¸ä¸‹å°±è§¦å‘äº† SIGFPEã€‚\nè§£å†³æ–¹æ¡ˆ å…ˆæ¨¡å†æ¨¡ä¹˜ã€‚\n","date":"2017-08-27T17:38:37+08:00","permalink":"https://blog.crazyark.me/p/cpp-sigfpe/","title":"SIGFPE When Doing DivQ"},{"content":"æ¥ä¸Šæ¬¡çš„åšæ–‡ï¼Œæˆ‘ä»¬æ¥è§£å†³å¤§æ•´æ•°åˆ†è§£é—®é¢˜ï¼Œå¹¶æœ€ç»ˆè§£å†³ Project Euler #188ã€‚\nå›å¿†ä¸€ä¸‹ï¼Œé—®é¢˜è¦æ±‚è§£çš„æ˜¯ $a\\uparrow\\uparrow b \\ (\\textrm{mod} \\ m)$ï¼Œå…¶ä¸­ $1 \\le a, b, m \\le 10^{18}$ã€‚\nå…¶å®è¿™é‡Œçš„æ•´æ•°åœ¨æ•´æ•°åˆ†è§£é¢†åŸŸå¹¶ä¸ç®—å¤ªå¤§ï¼Œä¹‹å‰å¹¶æ²¡æœ‰å­¦ä¹ è¿‡è¿™ç±»çš„ç®—æ³•ï¼Œæ­£å¥½ä¹Ÿç®—æ˜¯è¡¥ä¸Šäº†ã€‚åœ¨è¿™é‡Œæˆ‘ä½¿ç”¨äº† Pollard Rho ç®—æ³•ï¼Œå…¶ä»–çš„ç®—æ³•è¿˜æœ‰ Fermat Rho å’Œ Quadratic Sieve ç®—æ³•ã€‚\nPollard Rho ç®—æ³•ä¼ªä»£ç  x â† 2; y â† 2; d â† 1 while d = 1: x â† g(x) y â† g(g(y)) d â† gcd(|x - y|, n) if d = n: return failure else: return d æ ¸å¿ƒæ€æƒ³ å‡è®¾è¦åˆ†è§£çš„æ•´æ•° $n = pq$ï¼Œå…¶ä¸­ $p, q$ éƒ½æ˜¯è´¨æ•°ï¼Œä¸å¦¨è®¾ $p \\le q$ã€‚æˆ‘ä»¬ä½¿ç”¨ $g(x) = (x^2 + 1) \\ (\\textrm{mod} \\ n)$ æ¥ç”Ÿæˆä¸€ä¸ªä¼ªéšæœºæ•°åºåˆ—ã€‚\nä¸å¦¨è®¾åˆå§‹çš„xä¸º2ï¼Œé‚£ä¹ˆæˆ‘ä»¬æœ‰ä¸€ä¸ªåºåˆ—ä¸º ${x_1 = g(2), x_2 = g(g(2)), \u0026hellip; x_k = g^k(2),\u0026hellip;}$ï¼Œå› ä¸ºåºåˆ—ä¸­çš„å€¼ä¸€å®šæ˜¯æœ‰ç©·çš„ï¼Œå¹¶ä¸”åºåˆ—çš„æ¯ä¸€ä¸ªæ•°åªä¾èµ–äºå‰ä¸€ä¸ªæ•°ï¼Œæ‰€ä»¥è¯¥åºåˆ—ä¸€å®šä¼šå¾ªç¯ã€‚\nå®šä¹‰ ${y_k = x_k\\ (\\textrm{mod} \\ p), k = 1, 2, \u0026hellip;}$ åºåˆ—ï¼Œé‚£ä¹ˆè¿™ä¸ªåºåˆ—ä¹Ÿä¸€å®šä¼šå¾ªç¯ï¼Œå¹¶ä¸”ç”±äº $p$ æ¯” $n$ å°å¾—å¤šï¼Œæ‰€ä»¥åºåˆ—å¾ªç¯ä¹Ÿä¸€å®šä¼šæ¯” ${x_k}$ åºåˆ—å¾ªç¯å¾—æ—©è®¸å¤šã€‚\né‚£ä¹ˆæˆ‘ä»¬åªéœ€è¦æ£€æµ‹åˆ°è¿™ä¸ªç¯ï¼Œå‡è®¾ç¯é•¿ä¸ºrï¼Œä»–ä¸€å®šæœ‰$y_{r+k} - y_{k} \\equiv 0 \\ (\\textrm{mod} \\ p)$ï¼Œæ‰€ä»¥ä½¿ç”¨ Floyd Cycle Detection ï¼Œå¹¶ä½¿ç”¨æœ€å°å…¬çº¦æ•°æ¥æ£€æµ‹ç¯çš„å‡ºç° (æœ€å°å…¬çº¦æ•°ä¸ä¸º1)ï¼Œæ­¤æ—¶å¦‚æœæœ€å°å…¬çº¦æ•°ä¸ºä¸ç­‰äºnï¼Œé‚£ä¹ˆå®ƒä¸€å®šæ˜¯pæˆ–è€…qã€‚\nå”¯ä¸€éœ€è¦æ³¨æ„çš„æ˜¯ç¯å‡ºç°çš„æ—¶å€™å¯èƒ½æœ€å°å…¬çº¦æ•°ä¸ºnï¼Œä¹Ÿå°±æ˜¯ä¸Šè¿°ç®—æ³•ä¸­xç­‰äºyã€‚æ­¤æ—¶æˆ‘ä»¬éšæœºæ›´æ¢åºåˆ—ç§å­xï¼Œå¹¶è¿›è¡Œä¸‹ä¸€è½®åˆ†è§£ã€‚\næ—¶é—´å¤æ‚åº¦ æœŸæœ›è¿è¡Œæ—¶é—´æ­£æ¯”äºnçš„æœ€å°ç´ æ•°çš„å¼€æ ¹ï¼Œæ­¤å¤„å¤§çº¦ä¸º O(3.2e4)ã€‚\n#188 æ•´ä½“æ€è·¯ å®šä¹‰ $T(a, b) = a\\uparrow\\uparrow b$ã€‚\næˆ‘ä»¬æœ‰ $T(a, b) = a^{T(a, b - 1)}$ã€‚\nç”±æ¬§æ‹‰å®šç†çš„æ‰©å±•ï¼Œå¦‚æœ $T(a, b - 1) \u0026gt;= \\phi(m)$ï¼Œåˆ™æœ‰ $T(a,b) \\equiv a^{T(a, b - 1) \\ %\\ \\phi(m) + \\phi(m)} \\ (\\textrm{mod} \\ m)$ï¼Œå¦åˆ™æœ‰ $T(a,b) \\equiv a^{T(a, b - 1) \\ %\\ \\phi(m)} \\ (\\textrm{mod} \\ m)$ï¼Œæ­¤æ—¶éœ€è¦æ±‚è§£ $T(a, b - 1) \\ (\\textrm{mod}\\ \\phi(m))$ã€‚\nåŒç†ï¼Œ$T(a, b - 1) \\equiv a^{T(a, b - 2) \\ %\\ \\phi(\\phi(m))\\ ?+\\ \\phi(\\phi(m))} \\ (\\textrm{mod} \\ \\phi(m))$ï¼Œæ­¤æ—¶æ±‚è§£ $T(a, b - 2) \\ (\\textrm{mod}\\ \\phi(\\phi(m)))$ï¼Œæˆ‘ä»¬å¯ä»¥ä¸€ç›´é€’å½’ä¸‹å»ã€‚\nç›´åˆ°æ±‚è§£ $T(a, 1)\\ (\\textrm{mod} \\ \\phi^{b - 1}(m))$ï¼Œæˆ–è€… $T(a, b\u0026rsquo;) \\ (\\textrm{mod} \\ 1), \\phi^{b - b\u0026rsquo;}(m) = 1$ ä¸ºæ­¢ã€‚\né€’å½’æ·±åº¦ é€’å½’æ·±åº¦é¡¶å¤šä¸º min(128, b - 1)ï¼Œè¯æ˜å¦‚ä¸‹ï¼š\né€’å½’ç»“æŸæ¡ä»¶æœ‰ä¸¤ä¸ªï¼Œä¸€ä¸ªæ˜¯ b ç­‰äº 1ï¼Œæˆ–è€…æ¬§æ‹‰å‡½æ•°ä¸º1ã€‚\næˆ‘ä»¬è¯æ˜ $m \\ge 2$ æ—¶ï¼Œ$\\phi(\\phi(m)) \\le m/2$ å³å¯ï¼Œç”± $\\phi(m)$ å®šä¹‰, $1 \\le \\phi(m) \\le m$ æ’æˆç«‹ã€‚\nåˆ†ä»¥ä¸‹ä¸¤ç§æƒ…å†µï¼š\nm ä¸ºå¶æ•°ï¼Œåˆ™ç”±å®šä¹‰ $\\phi(m) \\le m / 2$ï¼Œ$\\phi(\\phi(m)) \\le \\phi(m) \\le m / 2$ m ä¸ºå¥‡æ•°ï¼Œåˆ™ç”±å®šä¹‰$\\phi(m)$ä¸€å®šä¸ºå¶æ•°ï¼Œ$\\phi(\\phi(m)) \\le \\phi(m) / 2 \\le m / 2$ è¯æ¯•ã€‚\næ‰€ä»¥å¦‚æœ $\\phi^{s}(m) = 1, m \u0026lt; 2^{64}$ï¼Œé‚£ä¹ˆ $s \\le 64 \\times 2 = 128$ æ’æˆç«‹ï¼Œæ‰€ä»¥é€’å½’æ·±åº¦æœ€å¤§ä¸ä¼šè¶…è¿‡ 128ã€‚\næ‰©å±•æ¬§æ‹‰å®šç†çš„åº”ç”¨ æ‰©å±•å½¢å¼ç”±äºæœ‰ä¸€ä¸ªå¤§å°æ¯”è¾ƒçš„æ¡ä»¶ï¼Œæ‰€ä»¥éœ€è¦ä¼°ç®—å½“å‰æ ˆè¿­ä»£æ¬¡å¹‚çš„å¤§å°ï¼Œè€Œè¿­ä»£æ¬¡å¹‚ (tetration) å¢é•¿ååˆ†å¿«ï¼Œæ‰€ä»¥å€¼åœ¨ (2^63 - 1) ä»¥å†…çš„aå’Œbç”šè‡³å¯ä»¥æšä¸¾å‡ºæ¥ï¼š\na b T(a, b) 1 any 1 any 1 a 2 2 4 2 3 16 2 4 65536 3 2 27 3 3 7625597484987 4 2 64 \u0026hellip; \u0026hellip; \u0026hellip; 15 2 437893890380859375 è¿™äº›æ•°æˆ‘ä»¬å¯ä»¥è½»æ˜“çš„è®¡ç®—å‡ºæ¥ï¼Œä¸æ¨¡æ•°è¿›è¡Œæ¯”è¾ƒï¼Œè€Œå…¶ä½™çš„ä¸€å®šå¤§äºæ¨¡æ•°ã€‚\nå¤§æ•´æ•°åˆ†è§£ ç”±äº $m$ çš„èŒƒå›´ï¼Œæˆ‘å…ˆæ‰“è¡¨ 1e6 å†…æ‰€æœ‰çš„ç´ æ•°ï¼Œå¹¶å…ˆå°† m ä¸­è¿™æ ·çš„è´¨å› å­å…¨éƒ¨åˆ†è§£ï¼Œå‡è®¾å‰©ä½™çš„æ•°ä¸º $m\u0026rsquo;$ï¼Œé‚£ä¹ˆ $m\u0026rsquo;$ å¦‚æœæ˜¯åˆæ•°ï¼Œä¸€å®šæ˜¯ä¸¤ä¸ªè´¨æ•° $p, q \\gt 1000000$ çš„ä¹˜ç§¯ã€‚\nå¦‚æœ $m\u0026rsquo; \\le 1e12$ï¼Œé‚£ä¹ˆ $m\u0026rsquo;$ ä¸€å®šæ˜¯ç´ æ•°ï¼Œå¦åˆ™æˆ‘ä»¬å…ˆå¯¹ $m\u0026rsquo;$ è¿›è¡Œç´ æ•°æµ‹è¯• (Miller-Rabin)ï¼Œå¦‚æœä¸ºåˆæ•°å†ä½¿ç”¨ Polland-Rho è¿›è¡Œåˆ†è§£ï¼Œä¸€æ—¦åˆ†è§£ä¸€å®šä¸ºä¸¤ä¸ªç´ æ•°ã€‚\n64ä½æ¨¡ä¹˜trick Gcc/Clang å‡æä¾›å†…ç½®ç±»å‹ __int128_tï¼Œå¯ä»¥æ”¯æŒ128ä½çš„è¿ç®—ï¼Œè€Œå¦‚æœè¿è¡Œåœ¨ intel x86_64 æ¶æ„ä¸Šï¼Œå¯ä»¥ç›´æ¥ä½¿ç”¨å¦‚ä¸‹æ±‡ç¼–\nlong mulmod(long a, long b, long m) { long res; asm(\u0026#34;mulq %2; divq %3\u0026#34; : \u0026#34;=d\u0026#34;(res), \u0026#34;+a\u0026#34;(a) : \u0026#34;S\u0026#34;(b), \u0026#34;c\u0026#34;(m)); return res; } ç®—æ³•æµç¨‹ $T(a, b, m)$:\nå¦‚æœ a == 1 æˆ–è€… b == 1ï¼Œè¿”å› a % m å¦‚æœ m == 1ï¼Œè¿”å› 0 å¯¹mè¿›è¡Œè´¨å› æ•°åˆ†è§£ï¼Œå¹¶è®¡ç®—æ¬§æ‹‰å‡½æ•° $\\phi(m)$ é€’å½’è®¡ç®— $e = T(a, b - 1, \\phi(m))$ ä¼°ç®— $T(a, b - 1)$ å¹¶ä¸ $\\phi(m)$ æ¯”è¾ƒå¤§å°ï¼Œå¦‚æœ $T(a, b - 1) \\ge \\phi(m)$ï¼Œ$e = e + \\phi(m)$ è®¡ç®— $a ^ e % m$ æ•´ä¸ªæµç¨‹ä¿è¯äº†æ‰€æœ‰æ“ä½œæ•°éƒ½åœ¨64ä½ä»¥å†…ï¼Œé€’å½’æ·±åº¦æœ€å¤§ä¸º min(128, b - 1)ã€‚\nç®—æ³•ä»£ç æ‰˜ç®¡åœ¨ https://github.com/arkbriar/hackerrank-projecteuler/blob/master/cpp/188.cc ã€‚\nReferences [1] https://en.wikipedia.org/wiki/Pollard%27s_rho_algorithm\n","date":"2017-08-25T21:32:26+08:00","permalink":"https://blog.crazyark.me/p/project-euler-188/","title":"æ•´æ•°çš„è¶…å¹‚ (Project Euler #188 -- The Hyperexponentiation of A Number)"},{"content":"åˆšé‡åˆ°ä¸€é“å¯æ€•çš„é¢˜ç›®ï¼Œè¿­ä»£æ¬¡å¹‚(tetration)åœ¨è¶…çº§å¤§çš„èŒƒå›´ä¸‹å¿«é€Ÿæ±‚è§£å¯¹æŸä¸ªæ¨¡æ•°çš„å¹‚ï¼Œæ¨¡æ•°èŒƒå›´åœ¨ 1 åˆ° 1e18 ä¹‹é—´ã€‚\nOKï¼Œè¿™é“é¢˜å…¶å®æ€è·¯å¾ˆæ¸…æ™°ï¼Œç”¨æ¬§æ‹‰å®šç†é™å¹‚ï¼Œä½†æ˜¯æœ€éš¾çš„éƒ¨åˆ†åœ¨äº\nå¯¹ m è¿›è¡Œè´¨å› æ•°åˆ†è§£ ä½¿ç”¨æ¬§æ‹‰å®šç†åœ¨éäº’è´¨æƒ…å†µçš„æ‰©å±•å½¢å¼ æˆ‘ä»¬å…ˆæŠŠmçš„è´¨å› æ•°åˆ†è§£æ”¾ä¸€æ”¾ (å…¶å®è¿˜æ²¡è§£å†³)\u0026hellip; å…ˆæ¥è§£å†³ç¬¬äºŒä¸ªé—®é¢˜ã€‚\nEuler Theorem \u0026amp; Fermat\u0026rsquo;s Little/Last Theorem è®¾mæ˜¯å¤§äº1çš„æ•´æ•°ï¼Œ$(a, m) = 1$ï¼Œåˆ™\n$$a^{\\phi(m)} \\equiv 1 \\ (\\textrm{mod}\\ m)$$\nè¿™é‡Œ $\\phi(m)$ æ˜¯æ¬§æ‹‰å‡½æ•°ï¼Œå¦‚æœ $m = p_1^{k_1}p_2^{k_2}\\cdots p_s^{k_s}$ï¼Œ$\\phi(m) = m(1 - \\frac{1}{p_1})\\cdots (1 - \\frac{1}{p_s})$ã€‚\nè¿™é‡Œå¼•å…¥ç®€åŒ–å‰©ä½™ç³»çš„æ¦‚å¿µï¼Œå¯¹æ•´æ•°mç®€åŒ–å‰©ä½™ç³»ä¸ºä¸€ä¸ªé›†åˆ $R(m) = {r | 0 \\le r \\lt m, (r, m) = 1}$ï¼Œä¹Ÿå°±æ˜¯æ‰€æœ‰mçš„æ¨¡æ•°é‡Œä¸mäº’è´¨çš„æ•°çš„é›†åˆã€‚\næ˜¾ç„¶ $|R(m)| = \\phi(m)$ã€‚\nProven for Euler Theorem è¿™ä¸ªè¯æ˜åº”è¯¥å¾ˆå¸¸è§äº†ï¼Œæˆ‘è¿˜æ˜¯å†™ä¸€ä¸‹ï¼Œä¹Ÿå¾ˆç®€å•ï¼Œå¯¹äºæ•´æ•°aå’Œmï¼Œ$(a, m) = 1$ï¼Œmçš„ç®€åŒ–å‰©ä½™ç³» $R(m) = {r_1, r_2, \u0026hellip;, r_{\\phi(m)}}$\n$(ar_1)(ar_2)\\cdots(ar_{\\phi(m)}) \\equiv a^{\\phi(m)}(r_1r_2\\cdots r_{\\phi(m)})\\ (\\textrm{mod}\\ m)$\nè€Œå› ä¸º $(a, m) = 1$, æ˜¾ç„¶æœ‰\n$ar_i \\not\\equiv 0 \\ (\\textrm{mod} \\ m)$ $ar_i \\not\\equiv ar_j \\ (\\textrm{mod} \\ m), i \\ne j$ å› æ­¤ $b_i = (ar_i\\ \\textrm{mod} \\ m)$ åŒæ ·æ„æˆäº†mçš„ç®€åŒ–å‰©ä½™ç³»ã€‚\næ‰€ä»¥ $\\prod_{i = 1}^{i = \\phi(m)} b_i \\equiv \\prod_{i = 1}^{i = \\phi(m)} r_i \\ (\\textrm{mod} \\ m)$\næ‰€ä»¥ $\\prod_{i = 1}^{i = \\phi(m)} r_i \\equiv a^{\\phi(m)}\\prod_{i = 1}^{i = \\phi(m)} r_i \\ (\\textrm{mod} \\ m)$\né‚£ä¹ˆ $(a^{\\phi(m)} - 1)\\prod_{i = 1}^{i = \\phi(m)} r_i \\equiv 0 \\ (\\textrm{mod} \\ m)$\nç”± $(r_i, m) = 1$ï¼Œæ˜¾ç„¶ $a^{\\phi(m)} - 1 \\equiv 0 \\ (\\textrm{mod} \\ m)$\nè¯æ¯•ã€‚\nFermat\u0026rsquo;s Little Theorem æ¬§æ‹‰å®šç†çš„ç‰¹æ®Šæƒ…å†µã€‚\nEuler Theorem for Non-coprime å…ˆç»™å‡ºç»“è®ºï¼Œè®¾aï¼Œmæ˜¯æ­£æ•´æ•°ï¼Œæˆ‘ä»¬æœ‰ $a^{k\\phi(m) + b} \\equiv a^{\\phi(m) + b} \\ (\\textrm{mod} \\ m), k \\in N^+$ï¼Œæ˜¾ç„¶åªéœ€è¦è€ƒè™‘ $(a, m) \\ne 1$\næˆ‘ä»¬é€šè¿‡è¯æ˜ä¸¤ä¸ªå¼±åŒ–çš„ç»“è®ºï¼Œæ¥è¯æ˜ä¸Šè¿°ç»“è®ºã€‚\nå¦‚æœpæ˜¯mçš„è´¨å› æ•°ï¼Œå³ $(p, m) = p$ï¼Œé‚£ä¹ˆ$p^{2\\phi(m)} \\equiv p^{\\phi(m)} \\ (\\textrm{mod} \\ m)$ $a^{2\\phi(m)} \\equiv a^{\\phi(m)} \\ (\\textrm{mod} \\ m)$ ä»¤ $m = p_1^{k_1}p_2^{k_2}\\cdots p_s^{k_s}$ã€‚\nå¼±åŒ–1(p, m) ä¸å¦¨è®¾ $p = p_1$, ä»¤ $m\u0026rsquo; = m \\ / \\ p_1^{k_1}, k = k_1$ï¼Œæ˜¾ç„¶ $(p^{k}, m\u0026rsquo;) = 1$ã€‚\næ˜“è§ï¼Œ$p^{2\\phi(m)} - p^{\\phi(m)} \\equiv 0 \\ (\\textrm{mod} \\ m\u0026rsquo;)$ã€‚\nä¸”, $p^{2\\phi(m)} - p^{\\phi(m)} \\equiv 0 \\ (\\textrm{mod} \\ p^k)$ï¼Œå› ä¸º $\\phi(m) \\ge p^{k - 1}(p - 1) \\ge k$ æ°¸è¿œæˆç«‹ã€‚\nç”±ä¸­å›½å‰©ä½™å®šç†ï¼Œ$(p^{2\\phi(m)} - p^{\\phi(m)}) \\ (\\textrm{mod} \\ p^k\\cdot m\u0026rsquo;)$è§£å­˜åœ¨ä¸”å”¯ä¸€ï¼Œè€Œè¿™é‡Œæ˜¾ç„¶æ˜¯0.\næ‰€ä»¥ï¼Œ$p^{2\\phi(m)} \\equiv p^{\\phi(m)} \\ (\\textrm{mod} \\ m)$\nå¼±åŒ–2(a, m) å‡è®¾ $(a, m) \\ne 1$ï¼Œå¹¶ä¸”è´¨æ•°pï¼Œæœ‰ $p | (a,m)$ï¼ŒåŒä¸Šä¸å¦¨è®¾$p = p_1, k = k_1$, å®šä¹‰$a = pa_1, m = p^km_1$ï¼Œæˆ‘ä»¬æœ‰\n$a^{2\\phi(m)} - a^{\\phi(m)} = p^{2\\phi(m)}a_1^{2\\phi(m)} - p^{\\phi(m)}a_1^{\\phi(m)}$\n$= p^{2\\phi(m)}a_1^{2\\phi(m)} - p^{\\phi(m)}a_1^{2\\phi(m)} + p^{\\phi(m)}a_1^{2\\phi(m)} - p^{\\phi(m)}a_1^{\\phi(m)}$\nå› æ­¤ $a^{2\\phi(m)} - a^{\\phi(m)} = (p^{2\\phi(m)} - p^{\\phi(m)})a_1^{2\\phi(m)} + p^{\\phi(m)}(a_1^{2\\phi(m)} -a_1^{\\phi(m)})$\n$\\equiv p^{\\phi(m)}(a_1^{2\\phi(m)} -a_1^{\\phi(m)}) \\ (\\textrm{mod} \\ m)$\nå³è¦è¯æ˜ $p^{\\phi(m)}(a_1^{2\\phi(m)} -a_1^{\\phi(m)}) \\equiv 0\\ (\\textrm{mod} \\ m)$ï¼Œæ˜¾ç„¶å³ $a_1^{2\\phi(m)} -a_1^{\\phi(m)} \\equiv 0\\ (\\textrm{mod} \\ m_1)$\nå¦‚æœ $(a_1, m_1) = 1$ï¼Œå³å¾—è¯ï¼Œå¦åˆ™ $a_1 \u0026lt; a$ï¼Œæˆ‘ä»¬æ€»èƒ½æ‰¾åˆ°è´¨æ•° $q | (a_1, m_1)$ï¼Œç„¶åé€’é™ï¼Œè€Œ $a_1$ ä¸€å®šæ˜¯æ•´æ•°ï¼Œæ‰€ä»¥ $a_1 \\ge 1$ï¼Œå³å­˜åœ¨é€’é™ä¸‹é™1ï¼Œè€Œ $(1, m_t) = 1$ æ’æˆç«‹ã€‚\næ•…å¾—è¯ã€‚\næœ€ç»ˆç»“è®º ç”±å¼±åŒ–ç»“è®º2ï¼Œå¾ˆå®¹æ˜“å¾—çŸ¥ $a^{k\\phi(m)} \\equiv a^{\\phi(m)} \\ (\\textrm{mod} \\ m), k \\in N^+$ï¼Œä»¥åŠ $a^{k\\phi(m) + b} \\equiv a^{\\phi(m) + b} \\ (\\textrm{mod} \\ m), k \\in N^+, b \\in N, b \\le m$ï¼Œå¾—è¯ã€‚\næ€»ç»“ è¯æ˜è¿™ä¸ªèŠ±äº†æˆ‘ä¸€æ®µæ—¶é—´ï¼Œæœç„¶æ•°è®ºå·²ç»å…¨æ‰”äº†=_=ã€‚\nç„¶è€Œè¿˜æœ‰å¤§æ•´æ•°åˆ†è§£è®©æˆ‘å¤´ç–¼\u0026hellip;\nReference [1] ã€Šåˆç­‰æ•°è®ºã€‹(ç¬¬ä¸‰ç‰ˆ)ï¼Œé«˜ç­‰æ•™è‚²å‡ºç‰ˆç¤¾\n","date":"2017-08-23T22:02:59+08:00","permalink":"https://blog.crazyark.me/p/euler-theorem-for-noncoprime/","title":"éè´¨æ•°çš„æ¬§æ‹‰å®šç†æ‰©å±• (Euler Theorem for Non-coprime)"},{"content":"å‰ä¸¤å¤©åˆ· Hackerrank ä¸Šçš„ Contestï¼Œç»™äº†ä¸¤å¤©æ—¶é—´ï¼Œæ²¡æƒ³åˆ°è¢«æœ€åä¸€é¢˜å¡æˆğŸ¶ï¼Œè°¨è®°å½•æ€è€ƒå’Œæ”¶è·ã€‚\nåŸé¢˜ç›®åœ¨ https://www.hackerrank.com/contests/gs-codesprint/challenges/transaction-certificates ï¼Œå°±ä¸åœ¨æ­¤èµ˜è¿°äº†ã€‚\næ€è€ƒè¿‡ç¨‹ é¦–å…ˆï¼Œé¢˜ç›®å…¶å®å°±æ˜¯å°†ä¸€ä¸ªäº¤æ˜“é“¾è¿›è¡Œhashï¼Œå¹¶è¦æ±‚ç»™å‡ºhashç¢°æ’çš„ä¸¤ä¸ªä¸åŒçš„äº¤æ˜“é“¾ã€‚\næœ‰ä¸€äº›å¯èƒ½æœ‰ç”¨çš„æ¡ä»¶ï¼Œpæ˜¯ç´ æ•°ï¼Œmæ˜¯2çš„å¹‚ã€‚\nè§£çš„å­˜åœ¨æ€§å°±ä¸è¯æ˜äº†ï¼Œé¸½ç¬¼åŸç†å¾ˆç®€å•ã€‚\næ€è·¯1 ç”±ä¸¤ä¸ªhashç›¸å‡å¾—åˆ°ï¼Œå¯ä»¥å°†é¢˜ç›®è½¬æ¢ä¸º $\\sum\\limits_{i = 0}^{n - 1}a_i \\cdot p^{n - 1 - i} \\equiv 0 \\ (mod\\ m), a_i \\in (-k, k)$, å¹¶ä¸”ä¸èƒ½æ˜¯æ‰€æœ‰ $a_i$ ä¸º0çš„ trival è§£ã€‚\nåœ¨ $k \\gt p$ æ—¶ï¼Œä»¤ $a_{n - 1} = p % m, a_{n - 2} = -1$ï¼Œå…¶ä½™éƒ½ä¸º0ï¼Œæˆ‘ä»¬å¯ä»¥å¾ˆå®¹æ˜“çš„æ„é€ åŸæ¥çš„è§£ã€‚\nä½†æ˜¯åœ¨ $k \\le p$ æ—¶ï¼Œæˆ‘åªæƒ³åˆ°äº†æš´åŠ›æœç´¢ï¼ˆé€šè¿‡æš´åŠ›æœç´¢å¤šå…ƒä¸€æ¬¡åŒä½™å¼çš„è§£ç©ºé—´ï¼‰ã€‚\næ€è·¯2 ç”±è§‚å¯Ÿï¼Œ$a_0a_1\u0026hellip;a_{n-1}$ æ„æˆäº†ä¸€ä¸ªæ•°çš„pè¿›åˆ¶è¡¨ç¤ºï¼Œè€Œå¯¹äºä¸€ä¸ªæ­£æ•´æ•°$x$ï¼Œæœ‰ $tm + x, t \\in N$ æ¨¡mçš„ä½™æ•°å€¼ä¸xç›¸åŒã€‚\nè€Œå¯¹äº $x$ çš„pè¿›åˆ¶è¡¨ç¤ºï¼Œå¯ä»¥å”¯ä¸€çš„ç¡®å®šä¸€æ¡äº¤æ˜“é“¾ (æ¯ä½+1æ„æˆäº¤æ˜“é“¾)ï¼Œå¹¶ä¸ $tm + x$ æ„æˆçš„äº¤æ˜“é“¾hashç›¸åŒã€‚\nä½†æ˜¯å› ä¸ºäº¤æ˜“é“¾ç¼–å·é™åˆ¶ï¼Œåªèƒ½åœ¨ $k\\ge p$ æ—¶å¿«é€Ÿç»™å‡ºè§£ã€‚\nå¯¹äº $k \\lt p$ çš„æƒ…å†µï¼Œè¿˜æ˜¯åªæƒ³åˆ°äº†æš´åŠ›æœç´¢ (é€šè¿‡æš´åŠ›æœç´¢ tm)ï¼Œä½†æ˜¯ç»“åˆä¸Šé¢çš„ $k \u0026gt; p$ æƒ…å†µçš„å¿«é€Ÿæ„é€ ï¼Œè§£å‡ºäº†44åˆ†ã€‚\nä½†æ˜¯æœ‰ä¸¤ä¸‰ä¸ª TLEï¼Œè¿™ç§è§£æ³•è‚¯å®šä¸è¡Œã€‚\nEditorial åœ¨å‡ºé¢˜è€…ç»™å‡ºçš„ç­”æ¡ˆé‡Œï¼Œä½¿ç”¨ Thue-Morse Sequence ç»™å‡ºäº†ä¸€ç§éå¸¸å¿«é€Ÿçš„æ„é€ æ–¹æ¡ˆï¼Œä¸»è¦æ˜¯åˆ©ç”¨äº†mæ˜¯2çš„å¹‚è¿™ä¸ªæ€§è´¨ï¼Œå¹¶ä¸”pç”šè‡³å¯ä»¥é€€åŒ–ä¸ºå¥‡æ•°ã€‚\nä¸‹é¢å®šä¹‰ä¸¤ä¸ªåºåˆ— $f(N)$ å’Œ $g(N)$ï¼Œå®šä¹‰ä¸º\n$f(1) = [1]$\n$g(0) = [0]$\n$f(N) = f(N - 1) \\oplus g(N - 1)$\n$g(N) = g(N - 1) \\oplus f(N - 1)$\nè¿™é‡Œ $\\oplus$ æ˜¯æŒ‡çº§è”ä¸¤ä¸ªåºåˆ—ã€‚\nå®šä¹‰è®¡ç®— certificate çš„å‡½æ•°ä¸º $H(A, m), A = [a_0, a_1, \u0026hellip;, a_{n - 1}]$ã€‚\næ˜¾ç„¶, N ä¸€ç›´æ˜¯2çš„å¹‚ï¼Œä»¤ $N = 2^n$ï¼Œé‚£ä¹ˆå­˜åœ¨ä¸€ä¸ªè¶³å¤Ÿå¤§çš„ $N$ ï¼Œ$H(f(N), m) = H(g(N), m)$ï¼Œè¿™é‡Œ m å¿…é¡»æ˜¯2çš„å¹‚ã€‚\næœ€æœ‰æ„æ€çš„æ˜¯å®ƒçš„è¯æ˜ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡è¯æ˜çŸ¥é“ï¼Œåœ¨ $m \\le 2^{32}$ çš„æƒ…å†µä¸‹ï¼Œè¿™æ ·çš„ $N$ å¤§çº¦åœ¨ $\\sqrt{m}$ å·¦å³ã€‚\nä¸‹é¢æ˜¯è¯æ˜ï¼š\næ˜¾ç„¶ï¼Œæˆ‘ä»¬çŸ¥é“ $\\overline{f(N)} = g(N)$ã€‚\nä»¤ $T = H(f(N), m) - H(g(N), m)$, æ˜¾ç„¶\n$T = p^{2^n - 1} - p^{2^n - 2} - p^{2^n - 3} + p^{2^n - 4} - \u0026hellip; \\pm 1$\né‚£ä¹ˆ $T = (p - 1)(p^2 - 1)\\cdots(p^{2^{n-1}} - 1)$ã€‚\nOKï¼Œè¿˜æœ‰æœ€åä¸€å—ç –: å¦‚æœ $2^s|(p - 1)$ï¼Œé‚£ä¹ˆ $2^{s + 1} |(p^2 - 1)$ï¼Œè¿™ä¸ªè¯æ˜å¾ˆç®€å•ï¼Œå°±ä¸è¯äº†ã€‚\nè¿™é‡Œç­”æ¡ˆæ¼è€ƒè™‘ p = 2 çš„æƒ…å†µï¼Œä½†æ˜¯è¿™ç§æƒ…å†µå¤ªå®¹æ˜“äº†ï¼Œæ‰€ä»¥ç›´æ¥å¿½ç•¥äº†\u0026hellip;è€Œä¸”test casesé‡Œä¹Ÿæ²¡æœ‰ğŸ˜…\næ‰€ä»¥ç”±pä¸ºè´¨æ•°å³å¥‡æ•°ï¼Œ$2 | (p - 1)$ï¼Œé‚£ä¹ˆä¸€å®šæœ‰ $2^n | (p^{2^n} - 1)$ã€‚\næ•…è€Œä¸€å®šæœ‰ $2^{n(n - 1)/2} | T$ï¼Œåªè¦ $n(n-1)/2 \\ge xï¼Œm = 2^x$ï¼Œå°±æœ‰ $m | T$ã€‚\nå¯ä»¥çœ‹åˆ°ï¼Œ$N$ çš„æ”¶æ•›å²‚æ­¢æ˜¯å¿«ã€‚\nå¾—åˆ° $f, g$ ç¨å¾®å¤„ç†ä¸‹å°±å‡ºç­”æ¡ˆäº†ï¼Œå› ä¸ºç­”æ¡ˆè¦æ±‚é•¿åº¦ä¸º $n$ çš„æ•´æ•°å€ï¼Œæ‰€ä»¥å¤æ‚åº¦ä¸º $O(n)$ã€‚\næ€»ç»“ è¿™ä¸ªé¢˜ç›®é‡ŒCertificateçš„è®¡ç®—æ–¹å¼å°±æ˜¯ Polynominal Hashï¼Œå®ƒå’Œ Thue-Morse Sequence ä¸€æ ·ï¼Œéƒ½æœ‰ä¸€äº›å¾ˆæœ‰æ„æ€çš„æ€§è´¨ï¼Œç•™ç€ä¹‹åæ…¢æ…¢å‘æ˜ä¸€ä¸‹ã€‚\nåœ¨çœ‹åˆ° mä¸º2çš„å¹‚çš„æ¡ä»¶æ—¶ï¼Œç¬¬ä¸€ååº”è‚¯å®šæ˜¯èƒ½å¤Ÿåšä»€ä¹ˆæ–‡ç« ï¼Œè€Œæˆ‘æƒ³æ¥æƒ³å»æƒ³å°† Fermat\u0026rsquo;s Last Theorem åº”ç”¨ä¸Šå»ï¼Œå§‹ç»ˆæ— æ³•å¦‚æ„¿ã€‚è¿™é“é¢˜ç”±äºè§£ç©ºé—´åºå¤§ï¼Œæ‰€ä»¥æƒ³å¿…æ˜¯æ„é€ è§£ï¼Œåªæ˜¯å®åœ¨æƒ³ä¸åˆ°å¦‚ä½•åº”ç”¨pæ˜¯ç´ æ•°ä»¥åŠmæ˜¯2çš„å¹‚ï¼Œå¯ä»¥çœ‹åˆ°æˆ‘çš„æ€è·¯ä¸­å§‹ç»ˆæ— æ³•åº”ç”¨è¿™ä¸¤ç‚¹ã€‚\nEditorial çš„è§£æ³•ç®€ç›´ç²¾å¦™ï¼Œæ›´åè¿‘äºæ•°å­¦äº†ã€‚\nReferences http://codeforces.com/blog/entry/4898 https://www.hackerrank.com/contests/gs-codesprint/challenges/transaction-certificates/editorial https://www.wikiwand.com/en/Thue%E2%80%93Morse_sequence ","date":"2017-08-21T23:58:42+08:00","permalink":"https://blog.crazyark.me/p/polynomial-hash-and-theu-morse-sequence/","title":"å¤šé¡¹å¼å“ˆå¸ŒåŠTheu-Morseåºåˆ— (Polynomial Hash and Theu-Morse Sequence)"},{"content":"æœ€è¿‘ç¢°åˆ°ä¸€é“é¢˜ç›®ï¼Œæ±‚ä¸€ä¸ªå›¾çš„å…¨å±€æœ€å°å‰²ï¼Œå¯æƒœå›¾è®ºåšä¸»å­¦çš„ä¸å¤ªå¥½ï¼Œè‡³ä»Šåªè®°å¾—ä¸€ä¸ªæ±‚s-tæœ€å¤§æµ/æœ€å°å‰²çš„ ford-fulkersonã€‚æƒ³äº†æƒ³æ€»ä¸èƒ½åš$n^2$æ¬¡æœ€å¤§æµå§ï¼Œæœ€ç»ˆè¿˜æ˜¯æ±‚åŠ©äº†ç»´åŸºç™¾ç§‘ ğŸ¤£\nStoer-Wagner Algorithm Stoer-Wagner ç®—æ³•æ˜¯ä¸€ä¸ªæ±‚å¸¦éè´Ÿæƒæ— å‘å›¾ä¸­å…¨å±€æœ€å°å‰²çš„ç®—æ³•ï¼Œå®ƒæ˜¯åœ¨1995å¹´ç”± Mechthild Stoer å’Œ Frank Wagner æå‡ºçš„ã€‚\nç®—æ³•çš„æ ¸å¿ƒæ€æƒ³æ˜¯é€šè¿‡ä¸æ–­çš„åˆå¹¶æŸä¸ªs-tæœ€å°å‰²çš„é¡¶ç‚¹æ¥ç¼©å°å›¾çš„è§„æ¨¡ï¼Œç›´åˆ°å›¾é‡Œåªå‰©ä¸‹ä¸¤ä¸ªåˆå¹¶å‰©ä¸‹çš„é¡¶ç‚¹ã€‚\nç®—æ³•æµç¨‹ åœ¨å›¾Gä¸­ï¼Œå‡è®¾Gçš„å…¨å±€æœ€å°å‰²ä¸ºC = {S, T}ï¼Œé‚£ä¹ˆå¯¹äºä»»ä½•ä¸€å¯¹Gä¸Šçš„é¡¶ç‚¹(s, t)æ¥è¯´\nè¦ä¹ˆså’Œtåˆ†å±Så’ŒT è¦ä¹ˆså’ŒtåŒå±Sæˆ–T Stoer-Wagneré¦–å…ˆæ‰¾åˆ°ä¸€ä¸ªs-tæœ€å°å‰²ï¼Œç„¶åå°†så’Œtåˆå¹¶ï¼š\nåˆ é™¤så’Œtä¹‹é—´çš„è¾¹ å¯¹äºä»»ä½•å’Œsã€tç›¸é‚»çš„é¡¶ç‚¹vï¼Œä¸æ–°é¡¶ç‚¹é“¾æ¥çš„æƒé‡ä¸º w(v, s) + w(v, t)ï¼ˆå‡è®¾ä¸ç›¸é‚»ä¸º0æƒé‡ï¼‰ æ˜¾ç„¶ï¼Œå¯¹äºä»»ä½•sã€tåœ¨åŒä¸€ä¸ªé›†åˆçš„å‰²ï¼Œåˆå¹¶sã€tå¹¶ä¸å½±å“å‰²çš„æƒé‡ã€‚\nä¸Šè¿°æµç¨‹ï¼ˆæ‰¾åˆ°ä¸€ä¸ªæœ€å°å‰²ã€åˆå¹¶ï¼‰ä¸ºä¸€ä¸ªé˜¶æ®µï¼Œåœ¨è¿›è¡Œ |V| - 1 æ¬¡è¿™æ ·çš„é˜¶æ®µä¹‹åï¼ŒGä¸­åªå‰©ä¸‹ä¸¤ä¸ªç‚¹ï¼Œé‚£ä¹ˆå…¨å±€æœ€å°å‰²ä¸€å®šä¸ºæ¯ä¸ªé˜¶æ®µçš„s-tæœ€å°å‰²ä»¥åŠæœ€åä¸¤ä¸ªç‚¹çš„å‰²ä¸­çš„æœ€å°å€¼ï¼Œå¦‚æ­¤ç®—æ³•å³å®Œæˆäº†ã€‚\nåŒå­¦ä»¬ä¸€å®šå‘ç°äº†ï¼Œå¦‚ä½•æ‰¾åˆ°ä¸€ä¸ªs-tæœ€å°å‰²æ‰æ˜¯ç®—æ³•èƒ½å¤Ÿé«˜æ•ˆæ‰§è¡Œçš„å…³é”®ï¼ŒStoer-Wagner ç®—æ³•çš„å·§å¦™ä¹‹å¤„å°±åœ¨äºæ­¤ã€‚\nå› ä¸ºç®—æ³•å¯¹äºs-tæœ€å°å‰²çš„èµ·ç‚¹å’Œç»ˆç‚¹æ²¡æœ‰ä»»ä½•è¦æ±‚ï¼Œæ‰€ä»¥æ‰¾åˆ°ä»»ä½•ä¸€ä¸ªæœ€å°å‰²å°±è¡Œï¼Œè¿‡ç¨‹å¦‚ä¸‹ï¼š\nå›¾Gä¸Šä»»æ„ä¸€ä¸ªé¡¶ç‚¹$u$ï¼Œæ”¾å…¥é›†åˆ$A$ä¸­ é€‰å–ä¸€ä¸ª$V - A$ä¸­çš„ç‚¹$v$ï¼Œä½¿å¾—$w(A,v)$æœ€å¤§ï¼Œå°†å®ƒæ”¾å…¥$A$ä¸­ï¼›å…¶ä¸­ $w(A,v) = \\sum_\\limits{u \\in A}w(u,v)$ é‡å¤æ‰§è¡Œ æ­¥éª¤2ï¼Œç›´åˆ°$V = A$ å‡è®¾æœ€ååŠ å…¥$A$çš„ä¸¤ä¸ªé¡¶ç‚¹æ˜¯$s$å’Œ$t$, åˆå¹¶å®ƒä»¬ ä¸Šè¿°è¿‡ç¨‹ä¸­ $\\left(A - {s}, {t}\\right)$ æ˜¯ä¸€ä¸ªs-tæœ€å°å‰²ã€‚\næ­£ç¡®æ€§è¯æ˜ è¦è¯æ˜ç®—æ³•çš„æ­£ç¡®æ€§ï¼Œåªéœ€è¦è¯æ˜é˜¶æ®µä¸­æ‰¾åˆ°çš„ä¸€å®šæ˜¯ä¸€ä¸ªs-tæœ€å°å‰²ã€‚\nç¬¦å·å®šä¹‰\nå›¾$G(V,E,W)$ $s$,$t$ æ˜¯æœ€ååŠ å…¥é›†åˆ$A$çš„ä¸¤ä¸ªé¡¶ç‚¹ ä»¤$C = (X, \\overline{X})$ä¸ºä»»æ„ä¸€ä¸ªs-tå‰²ï¼Œä¸å¤±ä¸€èˆ¬æ€§ï¼Œä»¤ $t \\in X$ $A_v$ä¸ºåœ¨é¡¶ç‚¹$v$åŠ å…¥$A$ä¹‹å‰çš„é›†åˆ $C_v$æ˜¯åœ¨ç”±é¡¶ç‚¹$A_v \\cup {v}$æ„æˆçš„$G$çš„å­å›¾ä¸Šï¼Œç”±å‰²$C$å¯¼å‡ºçš„å‰² æ‰€ä»¥ï¼Œæˆ‘ä»¬æœ‰$C_v = C$ï¼Œå³åªéœ€è¦è¯æ˜ $w(A_t, t) \\le w(C ) = w(C_t)$ã€‚\nä¸‹é¢æˆ‘ä»¬å°†å½’çº³è¯æ˜ $\\forall u \\in X$ï¼Œ$w(A_u, u) \\le w(C_u)$ã€‚\nè®¾$u_0$æ˜¯$X$ä¸­ç¬¬ä¸€ä¸ªè¢«æ”¾å…¥$A$ä¸­çš„é¡¶ç‚¹ï¼Œé‚£ä¹ˆç”±å®šä¹‰ï¼Œæœ‰ $w(A_{u_0}, u) = w(C_{u_0})$\nå‡è®¾å¯¹äºä¸¤ä¸ªè¿ç»­è¢«æ”¾å…¥$A$ä¸­ã€å¹¶ä¸”åŒå±äº$X$çš„é¡¶ç‚¹$u, v$ï¼Œå½’çº³å‡è®¾æœ‰ $w(A_u,u) \\le w(C_u)$\né¦–å…ˆï¼Œæˆ‘ä»¬æœ‰ $w(A_v, v) = w(A_u, v) + w(A_v - A_u, v)$\nå› ä¸º$u$ä¼˜å…ˆäº$v$è¢«é€‰å–ï¼Œæ‰€ä»¥$w(A_u, u) \\ge w(A_u, v)$ï¼Œæ‰€ä»¥ä¸Šå¼æœ‰\n$w(A_v, v) \\le w(A_u, u) + w(A_v - A_u, v) \\le w(C_u) + w(A_v - A_u, v)$\nè€Œç”±äº$(A_v - A_u) \\cap X = {u}$ï¼Œæ‰€ä»¥ $W(C_u) + w(A_v - A_u, v) = w(C_v)$\næ‰€ä»¥æœ‰ $w(A_u, u) \\le w(C_u)$ï¼Œè¯æ¯•ã€‚\næ•…è€Œæˆ‘ä»¬çŸ¥é“ï¼Œç®—æ³•æ¯ä¸ªé˜¶æ®µéƒ½èƒ½æ‰¾åˆ°ä¸€ä¸ªs-tæœ€å°å‰²ã€‚\næ—¶é—´å¤æ‚åº¦ æ¯æ¬¡è®¡ç®—æœ€å¤§çš„$w(A, u)$çš„æ—¶é—´ä¸º$O(|V|^2)$ï¼Œæœ€ååˆå¹¶çš„æ—¶é—´ä¸º $O(|E|)$ï¼Œæ‰€ä»¥æ¯ä¸€ä¸ªé˜¶æ®µæ—¶é—´å¤æ‚åº¦ä¸º $O(|E| + |V|^2)$ï¼›\nä¸€å…±æ‰§è¡Œ $|V|-1$æ¬¡ï¼Œç®—æ³•æ€»è®¡æ—¶é—´å¤æ‚åº¦ä¸º $O(|V||E| + |V|^3)$ã€‚\nå…¶ä¸­æ¯æ¬¡é€‰æ‹©æœ€å¤§çš„$w(A, u)$å¯ä»¥é€šè¿‡å †è¿›è¡Œä¼˜åŒ–ï¼Œå°†æ—¶é—´ä¼˜åŒ–åˆ°$O(lg|V|)$ï¼Œæ€»è®¡æ—¶é—´å¤æ‚åº¦å¯ä»¥é™ä¸º $O(|V||E| + |V|^2lg|V|)$ã€‚\nè¿™é‡Œé¡ºä¾¿ä¸€æï¼ŒStoer-Wagner ç®—æ³•é€‚ç”¨çš„å †éœ€è¦æ”¯æŒåŠ¨æ€ updateï¼Œå¸¸ç”¨çš„å †ä¸ºæ–æ³¢é‚£å¥‘å †ï¼Œåœ¨ C++ çš„æ ‡å‡† stl é‡Œå¹¶æ²¡æœ‰å®ç°ï¼Œæ›¿ä»£æ–¹æ¡ˆå¯ä»¥ä½¿ç”¨ std::multisetã€‚åœ¨ boost ä¸­ï¼Œå¯¹ Stoer-Wagner ç®—æ³•æœ‰ç›´æ¥æ”¯æŒã€‚\nReferences [1] https://en.wikipedia.org/wiki/Stoer%E2%80%93Wagner_algorithm\n[2] http://www.boost.org/doc/libs/1_64_0/libs/graph/doc/stoer_wagner_min_cut.html\n","date":"2017-08-05T22:14:01+08:00","permalink":"https://blog.crazyark.me/p/stoer-wagner-algorithm/","title":"æ— å‘å¸¦æƒå›¾å›¾å…¨å±€æœ€å°å‰² Stoer-Wagner ç®—æ³• (Stoer-Wagner Algorithm -- Global Min-Cut in Undirected Weighted Graphs)"},{"content":"å¶ç„¶å‘ç° AtCoderï¼Œä¸Šå»æ³¨å†Œäº†å‡†å¤‡è¯•è¯•ï¼Œç»“æœå¡åœ¨practice contest\u0026hellip;\né—®é¢˜å€’æ˜¯å¾ˆç®€å•ï¼š\nThere are N balls labeled with the first N uppercase letters. The balls have pairwise distinct weights. You are allowed to ask at most Q queries. In each query, you can compare the weights of two balls (see Input/Output section for details). Sort the balls in the ascending order of their weights.\nConstraints (N,Q)=(26,1000), (26,100), or (5,7).\nPartial Score There are three testsets. Each testset is worth 100 points. In testset 1, N=26 and Q=1000. In testset 2, N=26 and Q=100. In testset 3, N=5 and Q=7.\né€šè¿‡æ¯”è¾ƒæ’åºï¼Œä¸€å…±ä¸‰ç§æ•°æ®ï¼Œå…¶ä¸­ (26, 1000) çš„æƒ…å†µç”¨ä»»ä½•æ¯”è¾ƒéƒ½èƒ½è¿‡ï¼Œä½†æ˜¯å¯èƒ½ä¼š TLEï¼Œ(26, 100) çš„ç”¨ worst-case $O(nlgn)$ çš„ merge sort èƒ½è¿‡ï¼Œå”¯ä¸€éš¾å—çš„æ˜¯ (5, 7)ã€‚è¿™ä¸ªæ ·ä¾‹ merge sort çš„ worst case æ˜¯æ¯”è¾ƒ8æ¬¡ã€‚\næˆ‘å’ŒæŸç½‘å‹ä¸€æ ·ï¼Œå°è¯•ç”¨ STL çš„ sort æ¥è§£å†³ï¼Œç»“æœå‘ç° WA äº†æ›´å¤š ğŸ™„\nYou must be kidding!\nFord-Johnson ç»æœ›ä¹‹ä¸‹åªèƒ½æ±‚åŠ© googleï¼Œæœç„¶æ‰¾åˆ°äº†ä¸€ä¸ªç®—æ³•å« Ford-Johnson Algorithmï¼Œæ˜¯ 1959 å¹´è¢«æå‡ºæ¥çš„ï¼Œæ˜¯é’ˆå¯¹æ¯”è¾ƒæ’åºä¸­æ¯”è¾ƒæ•°è¿›è¡Œæœ€ä¼˜åŒ–çš„ç®—æ³•ï¼Œäº‹å®ä¸Šåœ¨æå‡ºåçš„ç›¸å½“é•¿ä¸€æ®µæ—¶é—´è¢«è®¤ä¸ºæ˜¯æ¯”è¾ƒæ•°çš„ lower boundã€‚\nå³ä¾¿åæ¥è¢«è¯æ˜èƒ½å¤Ÿè¿›ä¸€æ­¥ä¼˜åŒ–ï¼ŒFord-Johnson ç®—æ³•è·ç¦»äº‹å® lower bound ä¹Ÿæå…¶æ¥è¿‘ã€‚\nåœ¨ Knuth è€çˆ·å­çš„ ã€Š The Art of Computer Programming ã€‹ç¬¬ä¸‰å·ä¸­ï¼Œè¯¥ç®—æ³•ä¹Ÿè¢«ç§°ä¸º merge-insertion sortã€‚\nç®—æ³•æµç¨‹ å‡è®¾æˆ‘ä»¬æœ‰nä¸ªå…ƒç´ éœ€è¦æ’åºï¼Œç®—æ³•æ€»å…±åˆ†ä¸ºä¸‰æ­¥ï¼š\nå°†å…ƒç´ åˆ†ä¸º $\\lfloor n/2 \\rfloor$ å¯¹ï¼Œå¹¶ä¸¤ä¸¤è¿›è¡Œæ¯”è¾ƒï¼Œå¦‚æœ n æ˜¯å¥‡æ•°ï¼Œæœ€åä¸€ä¸ªå…ƒç´ ä¸è¿›è¡Œé…å¯¹\né€’å½’åœ°æ’åºæ¯å¯¹ä¸­å¤§çš„é‚£ä¸€ä¸ªã€‚ç°åœ¨æˆ‘ä»¬æœ‰ä¸€ä¸ªç”±æ¯å¯¹ä¸­è¾ƒå¤§å€¼ç»„æˆçš„æ’è¿‡åºçš„åºåˆ—ï¼Œå«åš main chainã€‚å‡è®¾ main chain æ˜¯ $a_1, a_2, \u0026hellip; a_{\\lfloor n/2 \\rfloor}$ ï¼Œå‰©ä½™çš„å…ƒç´ å‡è®¾ä»–ä»¬æ˜¯ $b_1, b_2, \u0026hellip;, b_{\\lceil n/2\\rceil}$ï¼Œå¹¶ä¸”æœ‰ $b_i \\le a_i$ å¯¹ $i = 1, 2, \u0026hellip;, \\lfloor n/2 \\rfloor$ æˆç«‹ã€‚\nç°åœ¨æˆ‘ä»¬å°† $b_1, \u0026hellip;, b_{\\lceil n/2 \\rceil}$ æ’å…¥ main chain ä¸­ï¼Œé¦–å…ˆæ˜¯ $b_1$ï¼Œæˆ‘ä»¬çŸ¥é“ä»–åœ¨ $a_1$ å‰é¢ï¼Œæ‰€ä»¥ main chain å˜ä¸º ${b_1, a_1, a_2, \u0026hellip; a_{\\lfloor n/2 \\rfloor}}$ï¼Œç„¶åè€ƒè™‘æ’å…¥ $b_3$ï¼Œä»…éœ€è¦æ¯”è¾ƒä¸‰ä¸ªæ•° ${b_1, a_1, a_2}$ï¼›å‡è®¾å‰ä¸‰ä¸ªå…ƒç´ å˜ä¸º ${b_1, a_1, b_3}$ï¼Œé‚£ä¹ˆæ’å…¥ $b_2$ ä¹Ÿæ˜¯åœ¨è¿™ä¸‰ä¸ªæ•°å†…ï¼›å¯ä»¥çœ‹åˆ°ï¼Œä¸è®º $b_3$ è¢«æ’å…¥åˆ°é‚£é‡Œäº†ï¼Œè¦æ’å…¥çš„èŒƒå›´æ€»æ˜¯æœ€å¤šä¸º3ã€‚ä¸‹ä¸€ä¸ªè¦æ’å…¥çš„æ•° $b_k$ å¯¹åº”äºä¸‹ä¸€ä¸ªJacobsthal Numberï¼Œå³æˆ‘ä»¬å…ˆæ’å…¥ $b_3$ï¼Œç„¶åæ’å…¥ $b_5, b_{11}, b_{21} \u0026hellip;$ï¼Œæ€»ç»“ä¸€ä¸‹æ’å…¥é¡ºåºä¸º $b_1, b_3, b_2, b_5, b_4, b_{11}, b_{10}, \u0026hellip;, b_6, b_{21}, \u0026hellip;$\næ€§èƒ½ Ford-Johnson ç®—æ³•éœ€è¦ç‰¹æ®Šçš„æ•°æ®ç»“æ„æ¥å®ç°ï¼Œè¿è¡Œé€Ÿåº¦å¹¶ä¸ç®—å¿«ï¼Œåªæ˜¯èƒ½å¤Ÿæ›´å°‘åœ°è¿›è¡Œæ¯”è¾ƒï¼Œåœ¨å®é™…ä½¿ç”¨ä¸­è¿˜æ˜¯ merge sort å’Œ quick sort æ¥å¾—æ›´å¿«ä¸€ç‚¹ã€‚\né—®é¢˜ (5, 7) å‡è®¾å…ƒç´  A, B, C, D, E\næ¯”è¾ƒ (A, B) å’Œ (C, D)ï¼Œä¸å¤±ä¸€èˆ¬æ€§ï¼Œæˆ‘ä»¬å‡è®¾ A \u0026gt; Bï¼ŒC \u0026gt; D æ¯”è¾ƒ (A, C)ï¼Œä¸å¤±ä¸€èˆ¬æ€§ï¼Œå‡è®¾ A \u0026gt; C å°† E æ’å…¥ (D, C, A)ï¼Œä¸¤æ¬¡æ¯”è¾ƒå†…å®Œæˆ å°† B æ’å…¥æ’åºåçš„{E, C, D} ä¸­ (å› ä¸º B \u0026lt; Aï¼Œæ‰€ä»¥ä¸éœ€è¦è€ƒè™‘ A çš„æ¯”è¾ƒ)ï¼Œä¸¤æ¬¡æ¯”è¾ƒå†…å®Œæˆ è¿™é‡Œç¬¬ä¸‰æ­¥å…ˆæ’å…¥ Eï¼Œæ˜¯å› ä¸ºå¦‚æœå…ˆæ’å…¥ B åˆ° (D, C)ï¼Œæœ€å¤šéœ€è¦ä¸¤æ¬¡æ¯”è¾ƒï¼Œè€Œæ’å…¥ E åˆ° {D, C, B, A} æœ€å¤šè¦ä¸‰æ¬¡æ¯”è¾ƒã€‚\nReferences [1] Bui, T. D., and Mai Thanh. \u0026ldquo;Significant improvements to the Ford-Johnson algorithm for sorting.\u0026rdquo; BIT Numerical Mathematics 25.1 (1985): 70-75.\n[2] https://codereview.stackexchange.com/questions/116367/ford-johnson-merge-insertion-sort\nAppendix Interactive Sorter in C++ #include \u0026lt;iostream\u0026gt; #include \u0026lt;algorithm\u0026gt; #include \u0026lt;vector\u0026gt; using namespace std; bool less_than(char a, char b) { cout \u0026lt;\u0026lt; \u0026#34;? \u0026#34; \u0026lt;\u0026lt; a \u0026lt;\u0026lt; \u0026#34; \u0026#34; \u0026lt;\u0026lt; b \u0026lt;\u0026lt; endl; cout.flush(); char ans; cin \u0026gt;\u0026gt; ans; if (ans == \u0026#39;\u0026lt;\u0026#39;) return true; return false; } void ford_johnson(string \u0026amp;s, int n) { // assert(n == 5) // ugly but work if (!less_than(s[0], s[1])) { swap(s[0], s[1]); } if (!less_than(s[2], s[3])) { swap(s[2], s[3]); } if (!less_than(s[1], s[3])) { swap(s[0], s[2]); swap(s[1], s[3]); } // now we have s[0] \u0026lt; s[1], s[2] \u0026lt; s[3], s[1] \u0026lt; s[3] vector\u0026lt;char\u0026gt; cs = {s[0], s[1], s[3]}; // insertion will be completed in two comparations auto insert_into_first_three = [\u0026amp;](char c) { if (less_than(c, cs[1])) { if (less_than(c, cs[0])) cs.insert(cs.begin(), c); else cs.insert(cs.begin() + 1, c); } else { if (less_than(c, cs[2])) cs.insert(cs.begin() + 2, c); else cs.insert(cs.begin() + 3, c); } }; insert_into_first_three(s[4]); // always sorted {s[0], s[1], s[4]} \u0026lt; s[3] or s[0] \u0026lt; s[1] \u0026lt; s[3] \u0026lt; s[4] // so the first three elements are enough insert_into_first_three(s[2]); s = string(cs.begin(), cs.end()); } // at most 99 comparations for n = 26 void merge_sort(string \u0026amp;s, int n) { if (n == 1) return; else if (n == 2) { if (!less_than(s[0], s[1])) swap(s[0], s[1]); return; } auto left_half = s.substr(0, n / 2), right_half = s.substr(n / 2); merge_sort(left_half, n / 2); merge_sort(right_half, n - n / 2); // merge, at most n - 1 comparations int i = 0, j = 0, k = 0; while (k \u0026lt; n) { if (i \u0026gt;= n / 2) s[k++] = right_half[j++]; if (j \u0026gt;= n - n / 2) s[k++] = left_half[i++]; else if (less_than(left_half[i], right_half[j])) s[k++] = left_half[i++]; else s[k++] = right_half[j++]; } } int main() { int n, q; cin \u0026gt;\u0026gt; n \u0026gt;\u0026gt; q; string s; for (int i = 0; i \u0026lt; n; ++i) { s += \u0026#39;A\u0026#39; + i; } if (n == 5) ford_johnson(s, n); else merge_sort(s, n); cout \u0026lt;\u0026lt; \u0026#34;! \u0026#34; \u0026lt;\u0026lt; s \u0026lt;\u0026lt; endl; return 0; } ","date":"2017-08-04T14:15:35+08:00","permalink":"https://blog.crazyark.me/p/ford-johnson-algorithm/","title":"ä¼˜åŒ–æ¯”è¾ƒæ¬¡æ•°çš„æ’åºç®—æ³• (Ford Johnson Algorithm)"},{"content":"Leetcode ä¸Šæœ‰ä¸€é“é¢˜å« Sliding Window Maximumï¼Œè™½ç„¶ä¸æ˜¯ä»Šå¤©åˆ·çš„ï¼Œä½†æ˜¯è§£æ³•éå¸¸æœ‰æ„æ€ï¼Œå°±è®°å½•ä¸€ä¸‹ã€‚\né—®é¢˜æè¿°ï¼š\nGiven an array nums, there is a sliding window of size k which is moving from the very left of the array to the very right. You can only see the k numbers in the window. Each time the sliding window moves right by one position.\nFor example, Given nums = [1,3,-1,-3,5,3,6,7], and k = 3.\nTherefore, return the max sliding window as [3,3,5,5,6,7].\nè¿™é“é¢˜å¯ä»¥ç”¨ä¼˜å…ˆé˜Ÿåˆ—ã€è‡ªå¹³è¡¡BSTç­‰æ–¹æ³•å¾—åˆ°ä¸€ä¸ª O(nlgn) çš„è§£æ³•ï¼Œä½†å…¶å®è¿™é“é¢˜æœ‰å¦ä¸€ç§ O(n) çš„è§£æ³•ï¼ŒåŸºæœ¬æ€æƒ³æ˜¯åœ¨è¿‡ç¨‹ä¸­ç»´æŒä¸€ä¸ªå•è°ƒé˜Ÿåˆ—ã€‚\nMonotonic Queue æˆ‘ä»¬ç”¨åŒç«¯é˜Ÿåˆ—æ¥å®ç°è¿™ä¸ªå•è°ƒé˜Ÿåˆ—ï¼Œä¿è¯è¿™ä¸ªé˜Ÿåˆ—ä¸­æ‰€æœ‰æ•°å•è°ƒéå¢ï¼ŒåŒæ—¶ä¸€ä¸ªçª—å£ä¸­çš„æœ€å¤§çš„æ•°å°±åœ¨é˜Ÿåˆ—çš„å¼€ç«¯ã€‚\nå‡è®¾æˆ‘ä»¬ç°åœ¨æœ‰ä¸€ä¸ªé˜Ÿåˆ— Q æ»¡è¶³ä¸Šè¿°æ¡ä»¶ï¼Œå½“ä¸€ä¸ªæ•° a è¿›å…¥çª—å£æ—¶ï¼Œæ­¤æ—¶æ•° b æ»‘å‡ºçª—å£ï¼Œé˜Ÿåˆ—æ“ä½œæ­¥éª¤ï¼š\nå¦‚æœé˜Ÿåˆ—ä¸ä¸ºç©ºå¹¶ä¸”é˜Ÿåˆ—å¼€ç«¯ç­‰äº bï¼Œremove it! å¦‚æœé˜Ÿåˆ—ä¸ä¸ºç©ºå¹¶ä¸”é˜Ÿåˆ—å°¾ç«¯å°äº aï¼Œremove itï¼ å¾ªç¯ æ­¥éª¤2 ç›´åˆ°é˜Ÿåˆ—ä¸ºç©ºæˆ–è€…é˜Ÿåˆ—å°¾ç«¯ä¸å°äº a å°† a åŠ åˆ°é˜Ÿåˆ—å°¾ç«¯ æ˜¾ç„¶ï¼Œåœ¨ æ­¥éª¤2 ä¸­ï¼Œåˆ é™¤çš„æ•°éƒ½æ˜¯ä¸å¯èƒ½ä¸ºæœ€å¤§å€¼çš„æ•°ï¼Œæ‰€ä»¥åœ¨æ“ä½œç»“æŸåï¼Œçª—å£å†…æœ€å¤§å€¼ä»ç„¶åœ¨é˜Ÿåˆ—ä¸­ï¼Œå¹¶ä¸”é˜Ÿåˆ—ä¿æŒå•è°ƒéå¢ã€‚\næ­¤æ—¶æœ€å¤§å€¼å³ä¸ºé˜Ÿåˆ—å¼€ç«¯ã€‚\nå› ä¸ºæ¯ä¸ªæ•°åªè¿›é˜Ÿä¸€æ¬¡ï¼Œå¹¶å‡ºé˜Ÿä¸€æ¬¡ï¼Œæ‰€ä»¥æ—¶é—´å¼€é”€ä¸º O(n)ã€‚\nAppendix C++ å®ç° vector\u0026lt;int\u0026gt; maxSlidingWindow(vector\u0026lt;int\u0026gt; \u0026amp;nums, int k) { vector\u0026lt;int\u0026gt; res; // tracking index instead of value deque\u0026lt;int\u0026gt; dq; for (int i = 0; i \u0026lt; nums.size(); ++ i) { // dequeue (i - k)th element if exists if (!dq.empty() \u0026amp;\u0026amp; dq.front() == i - k) dq.pop_front(); // remove those less than current while (!dq.empty() \u0026amp;\u0026amp; nums[dq.back()] \u0026lt; nums[i]) dq.pop_back(); // enqueue current dq.push_back(i); if (i \u0026gt;= k - 1) res.push_back(nums[dq.front()]); } return res; } ","date":"2017-08-03T15:55:02+08:00","permalink":"https://blog.crazyark.me/p/monotonic-queue/","title":"æ»‘åŠ¨çª—å£ä¸­çš„æœ€å¤§å€¼ (Sliding Window Maximum / Monotonic Queue)"},{"content":"ä»Šå¤©åœ¨åˆ· leetcode çš„æ—¶å€™é‡åˆ°ä¸€é“é¢˜ç›® Kth Smallest Element in a Sorted Matrixã€‚\né¦–å…ˆç”¨ä¸€ä¸ª Min-Heap å°±å¯ä»¥å¾—åˆ° O(klgn) (nä¸ºåˆ—æ•°)çš„ç®—æ³•ï¼Œå®ç°æ”¾åœ¨æœ€åã€‚\nç„¶è€Œåœ¨ç¿»é˜…è§ˆ Discuss åŒºçš„æ—¶å€™å‘ç°ï¼Œè¿™ç©æ„å±…ç„¶æœ‰ O(n) (nä¸ºè¡Œã€åˆ—æ•°) çš„ç®—æ³•ï¼Œæ¥è‡ªä¸€ç¯‡è®ºæ–‡ Selection in X + Y and Matrices with Sorted Rows and Columnsï¼ŒåŒæ—¶é€‚ç”¨äºå¦ä¸€é“é¢˜ Find k Pairs with Smallest Sumsï¼Œåœ¨æ­¤åªåšä»‹ç»ï¼Œå› ä¸ºæˆ‘ä¸è®¤ä¸ºæœ‰äººèƒ½åœ¨é¢è¯•çš„æ—¶å€™å†™çš„å‡ºæ¥\u0026hellip;\nç®€å•ä»‹ç» è®¾ A ä¸ºä¸€ä¸ª n * n çš„çŸ©é˜µï¼Œæ‰€æœ‰è¡Œå’Œåˆ—éƒ½æ˜¯éé™ç»­çš„ã€‚\nä»¤ $A^*$ æ˜¯ A å–æ‰€æœ‰å¥‡æ•°è¡Œçš„å­çŸ©é˜µï¼Œå¦‚æœ n ä¸ºå¶æ•°çš„è¯æ·»ä¸Š A çš„æœ€åä¸€è¡Œä¸€åˆ—ï¼›ä»¤ $rank_{desc}(A, a)$ ä¸º A ä¸­å¤§äº a çš„å…ƒç´ çš„æ•°ç›®ï¼Œ$rank_{asc}(A, a)$ ä¸º A ä¸­å°äº a çš„å…ƒç´ æ•°ç›®ã€‚\né‚£ä¹ˆæœ‰ä»¥ä¸‹ä¸ç­‰å¼æˆç«‹\n$rank_{asc}(A, a) \\le 4 rank_{asc}(A^*, a)$ $rank_{desc}(A, a) \\le 4 rank_{desc}(A^*, a)$ è¿™æ˜¯è¿™ä¸ªç®—æ³•çš„åŸºç¡€ï¼ŒåŠ ä¸Šå·§å¦™çš„é€‰æ‹©ï¼Œå¯ä»¥æ˜¯ä½¿å¾—é—®é¢˜å˜ä¸ºè§£ä¸€ä¸ªåœ¨A*ä¸Šçš„å­é—®é¢˜ã€‚\nç®—æ³•è¿‡ç¨‹å‚è€ƒè®ºæ–‡ï¼Œéå¸¸ä¸ç›´è§‚ï¼Œéœ€è¦ä¸å°‘ç†è®ºè¯æ˜ï¼Œå®åœ¨æ²¡æ³•è¯¦è¿°\u0026hellip; æœ‰å…´è¶£çš„åŒå­¦è¿˜æ˜¯å‚é˜…åŸè®ºæ–‡\nPythonã€C++ ç®—æ³•å®ç° åœ¨æ­¤æ‘˜å½• discuss ä¸Šå¤§ä½¬ç»™å‡ºçš„ python å’Œ cpp ç‰ˆå®ç°ï¼Œåœ¨é¢è¯•ä¸­è°èƒ½æ‰‹å†™å‡ºæ¥æˆ‘åªèƒ½è·ªç©¿ã€‚\nclass Solution(object): def kthSmallest(self, matrix, k): # The median-of-medians selection function. def pick(a, k): if k == 1: return min(a) groups = (a[i:i+5] for i in range(0, len(a), 5)) medians = [sorted(group)[len(group) / 2] for group in groups] pivot = pick(medians, len(medians) / 2 + 1) smaller = [x for x in a if x \u0026lt; pivot] if k \u0026lt;= len(smaller): return pick(smaller, k) k -= len(smaller) + a.count(pivot) return pivot if k \u0026lt; 1 else pick([x for x in a if x \u0026gt; pivot], k) # Find the k1-th and k2th smallest entries in the submatrix. def biselect(index, k1, k2): # Provide the submatrix. n = len(index) def A(i, j): return matrix[index[i]][index[j]] # Base case. if n \u0026lt;= 2: nums = sorted(A(i, j) for i in range(n) for j in range(n)) return nums[k1-1], nums[k2-1] # Solve the subproblem. index_ = index[::2] + index[n-1+n%2:] k1_ = (k1 + 2*n) / 4 + 1 if n % 2 else n + 1 + (k1 + 3) / 4 k2_ = (k2 + 3) / 4 a, b = biselect(index_, k1_, k2_) # Prepare ra_less, rb_more and L with saddleback search variants. ra_less = rb_more = 0 L = [] jb = n # jb is the first where A(i, jb) is larger than b. ja = n # ja is the first where A(i, ja) is larger than or equal to a. for i in range(n): while jb and A(i, jb - 1) \u0026gt; b: jb -= 1 while ja and A(i, ja - 1) \u0026gt;= a: ja -= 1 ra_less += ja rb_more += n - jb L.extend(A(i, j) for j in range(jb, ja)) # Compute and return x and y. x = a if ra_less \u0026lt;= k1 - 1 else \\ b if k1 + rb_more - n*n \u0026lt;= 0 else \\ pick(L, k1 + rb_more - n*n) y = a if ra_less \u0026lt;= k2 - 1 else \\ b if k2 + rb_more - n*n \u0026lt;= 0 else \\ pick(L, k2 + rb_more - n*n) return x, y # Set up and run the search. n = len(matrix) start = max(k - n*n + n-1, 0) k -= n*n - (n - start)**2 return biselect(range(start, min(n, start+k)), k, k)[0] class Solution { public: int kthSmallest(const std::vector\u0026lt;std::vector\u0026lt;int\u0026gt;\u0026gt; \u0026amp; matrix, int k) { if (k == 1) // guard for 1x1 matrix { return matrix.front().front(); } size_t n = matrix.size(); std::vector\u0026lt;size_t\u0026gt; indices(n); std::iota(indices.begin(), indices.end(), 0); std::array\u0026lt;size_t, 2\u0026gt; ks = { k - 1, k - 1 }; // use zero-based indices std::array\u0026lt;int, 2\u0026gt; results = biSelect(matrix, indices, ks); return results[0]; } private: // select two elements from four elements, recursively std::array\u0026lt;int, 2\u0026gt; biSelect( const std::vector\u0026lt;std::vector\u0026lt;int\u0026gt;\u0026gt; \u0026amp; matrix, const std::vector\u0026lt;size_t\u0026gt; \u0026amp; indices, const std::array\u0026lt;size_t, 2\u0026gt; \u0026amp; ks) // Select both ks[0]-th element and ks[1]-th element in the matrix, // where k0 = ks[0] and k1 = ks[1] and n = indices.size() satisfie // 0 \u0026lt;= k0 \u0026lt;= k1 \u0026lt; n*n and k1 - k0 \u0026lt;= 4n-4 = O(n) and n\u0026gt;=2 { size_t n = indices.size();\tif (n == 2u) // base case of resursion {\treturn biSelectNative(matrix, indices, ks); } // update indices std::vector\u0026lt;size_t\u0026gt; indices_; for (size_t idx = 0; idx \u0026lt; n; idx += 2) { indices_.push_back(indices[idx]); } if (n % 2 == 0) // ensure the last indice is included { indices_.push_back(indices.back()); } // update ks // the new interval [xs_[0], xs_[1]] should contain [xs[0], xs[1]] // but the length of the new interval should be as small as possible // therefore, ks_[0] is the largest possible index to ensure xs_[0] \u0026lt;= xs[0] // ks_[1] is the smallest possible index to ensure xs_[1] \u0026gt;= xs[1] std::array\u0026lt;size_t, 2\u0026gt; ks_ = { ks[0] / 4, 0 }; if (n % 2 == 0) // even { ks_[1] = ks[1] / 4 + n + 1; } else // odd { ks_[1] = (ks[1] + 2 * n + 1) / 4; } // call recursively std::array\u0026lt;int, 2\u0026gt; xs_ = biSelect(matrix, indices_, ks_); // Now we partipate all elements into three parts: // Part 1: {e : e \u0026lt; xs_[0]}. For this part, we only record its cardinality // Part 2: {e : xs_[0] \u0026lt;= e \u0026lt; xs_[1]}. We store the set elementsBetween // Part 3: {e : x \u0026gt;= xs_[1]}. No use. Discard. std::array\u0026lt;int, 2\u0026gt; numbersOfElementsLessThanX = { 0, 0 }; std::vector\u0026lt;int\u0026gt; elementsBetween; // [xs_[0], xs_[1]) std::array\u0026lt;size_t, 2\u0026gt; cols = { n, n }; // column index such that elem \u0026gt;= x // the first column where matrix(r, c) \u0026gt; b // the first column where matrix(r, c) \u0026gt;= a for (size_t row = 0; row \u0026lt; n; ++row) { size_t row_indice = indices[row]; for (size_t idx : {0, 1}) { while ((cols[idx] \u0026gt; 0) \u0026amp;\u0026amp; (matrix[row_indice][indices[cols[idx] - 1]] \u0026gt;= xs_[idx])) { --cols[idx]; } numbersOfElementsLessThanX[idx] += cols[idx]; } for (size_t col = cols[0]; col \u0026lt; cols[1]; ++col) { elementsBetween.push_back(matrix[row_indice][indices[col]]); } } std::array\u0026lt;int, 2\u0026gt; xs; // the return value for (size_t idx : {0, 1}) { size_t k = ks[idx]; if (k \u0026lt; numbersOfElementsLessThanX[0]) // in the Part 1 { xs[idx] = xs_[0]; } else if (k \u0026lt; numbersOfElementsLessThanX[1]) // in the Part 2 { size_t offset = k - numbersOfElementsLessThanX[0]; std::vector\u0026lt;int\u0026gt;::iterator nth = std::next(elementsBetween.begin(), offset); std::nth_element(elementsBetween.begin(), nth, elementsBetween.end()); xs[idx] = (*nth); } else // in the Part 3 { xs[idx] = xs_[1]; } } return xs; } // select two elements from four elements, using native way std::array\u0026lt;int, 2\u0026gt; biSelectNative( const std::vector\u0026lt;std::vector\u0026lt;int\u0026gt;\u0026gt; \u0026amp; matrix, const std::vector\u0026lt;size_t\u0026gt; \u0026amp; indices, const std::array\u0026lt;size_t, 2\u0026gt; \u0026amp; ks) { std::vector\u0026lt;int\u0026gt; allElements; for (size_t r : indices) { for (size_t c : indices) { allElements.push_back(matrix[r][c]); } } std::sort(allElements.begin(), allElements.end()); std::array\u0026lt;int, 2\u0026gt; results; for (size_t idx : {0, 1}) { results[idx] = allElements[ks[idx]]; } return results; } }; Min-Heap O(klgn) ç®—æ³• class Solution { struct Tuple { int x, y, val; Tuple(int x, int y, int val) : x(x), y(y), val(val) {} bool operator\u0026lt;(const Tuple\u0026amp; other) const { return val \u0026lt; other.val; } bool operator\u0026gt;(const Tuple\u0026amp; other) const { return val \u0026gt; other.val; } }; public: int kthSmallest(vector\u0026lt;vector\u0026lt;int\u0026gt;\u0026gt;\u0026amp; matrix, int k) { priority_queue\u0026lt;Tuple, vector\u0026lt;Tuple\u0026gt;, std::greater\u0026lt;Tuple\u0026gt;\u0026gt; min_heap; int n = matrix.size(); for (int i = 0; i \u0026lt; n; ++i) min_heap.push(Tuple(0, i, matrix[0][i])); for (int i = 0; i \u0026lt; k - 1; ++i) { auto t = min_heap.top(); min_heap.pop(); if (t.x == n - 1) continue; min_heap.push(Tuple(t.x + 1, t.y, matrix[t.x + 1][t.y])); } return min_heap.top().val; } }; ","date":"2017-08-02T20:58:55+08:00","permalink":"https://blog.crazyark.me/p/selection-in-x-y-or-sorted-matrices/","title":"æœ‰åºçŸ©é˜µä¸­çš„ç¬¬kå¤§æ•° (Selection in X+Y or Sorted Matrices)"},{"content":"è™½ç„¶åœ¨ä¸€å¹´å‰å°±çŸ¥é“äº† Proxy æ¨¡å¼ï¼Œä½†æ˜¯åŸºæœ¬æ²¡æœ‰å°è¯•ä½¿ç”¨è¿‡ï¼Œä»…åœ¨æ¡†æ¶é‡Œçœ‹åˆ°ä¸€äº›ä¾‹å­ã€‚æ˜¨å¤©ç¿»é˜…ã€Šå¤§å‹ç½‘ç«™ç³»ç»Ÿä¸Javaä¸­é—´ä»¶å®è·µã€‹æ—¶ï¼Œå¶ç„¶å‘ç°äº† Proxy æ¨¡å¼åœ¨ Java ä¸­çš„åº”ç”¨ â€”â€” åŠ¨æ€ä»£ç†ï¼Œé‚è®°å½•ä¸‹æ¥ï¼Œé¡ºä¾¿å¤ä¹ ä¸€ä¸‹ Proxy æ¨¡å¼ã€‚\nä»¥ä¸‹å†…å®¹å‚è€ƒè‡ª\nã€ŠDesign Patternsã€‹ ã€Šå¤§å‹ç½‘ç«™ç³»ç»Ÿä¸Javaä¸­é—´ä»¶å®è·µã€‹ã€‚ http://www.baeldung.com/java-dynamic-proxies Proxy æ¨¡å¼å›¾ç¤ºï¼š\nProxy Pattern Proxy æ¨¡å¼ åœ¨ã€ŠDesign Patternsã€‹ä¹¦ä¸­æåˆ°\u0005äº†ä½¿ç”¨ Proxy æ¨¡å¼çš„å››ç§å¸¸è§æƒ…å†µï¼š\nè¿œç¨‹ä»£ç† (Remote Proxy) ä¸ºä¸€ä¸ªå¯¹è±¡åœ¨ä¸åŒçš„åœ°å€ç©ºé—´æä¾›å±€éƒ¨ä»£è¡¨ã€‚ è™šä»£ç† (Virtual Proxy) æ ¹æ®éœ€è¦åˆ›å»ºå¼€é”€å¾ˆå¤§çš„å¯¹è±¡ã€‚ ä¿æŠ¤ä»£ç† (Protection Proxy) æ§åˆ¶å¯¹åŸå§‹å¯¹è±¡çš„è®¿é—®ã€‚ä¿æŠ¤ä»£ç†ç”¨äºå¯¹è±¡åº”è¯¥æœ‰ä¸åŒçš„è®¿é—®æƒé™çš„æ—¶å€™ã€‚ æ™ºèƒ½æŒ‡é’ˆ (Smart Reference) å¼•ç”¨è®¡æ•°ã€å®ç°çº¿ç¨‹å®‰å…¨ã€å»¶è¿Ÿåˆ›å»ºï¼Œç†Ÿæ‚‰ C++ çš„åŒå­¦åº”è¯¥çŸ¥é“ std::share_ptrã€ std::weak_ptrã€std::unique_ptr ç­‰ã€‚ Java ä¸­çš„é™æ€ä»£ç† è¿™é‡Œå€Ÿç”¨ ã€Šå¤§å‹ç½‘ç«™ç³»ç»Ÿä¸Javaä¸­é—´ä»¶å®è·µã€‹ä¸­çš„ä¾‹å­ï¼š\npublic interface Calculator { int add(int a, int b); } public class CalculatorImpl implements Calculator { int add(int a, int b) { return a + b; } } public class CalculatorProxy implements Calculator { private Calculator calculator; public CalculatorProxy(Calculator calculator) { this.calculator = calculator; } int add(int a, int b) { // We can do anything before and after real add is called, // such as logging return calculator.add(a, b); } } å¯ä»¥çœ‹åˆ°ï¼Œåœ¨ CalculatorProxy ä¸­æˆ‘ä»¬å¯ä»¥è°ƒç”¨äº†çœŸæ­£çš„addæ“ä½œï¼Œå¹¶å¯ä»¥åœ¨addå‰ååšå¾ˆå¤šé¢å¤–çš„å·¥ä½œï¼Œè¿™ç§æ–¹å¼çœ‹ä¸Šå»ååˆ†ç›´æ¥ï¼Œä½†æ˜¯å¦‚æœæˆ‘ä»¬æœ‰ä¸€æ‰¹ç±»éœ€è¦ä»£ç†ï¼Œå¹¶ä¸”ä»£ç†ç±»ä¸­å®ç°çš„åŠŸèƒ½æ˜¯ä¸€è‡´çš„ï¼Œé‚£ä¹ˆæˆ‘ä»¬å°±éœ€è¦ä¸ºæ¯ä¸€ä¸ªç±»éƒ½å®ç°ä¸€ä¸ª XxxProxy ç±»ï¼Œè¿™å°†ä¼šååˆ†éº»çƒ¦ã€‚\nJava ä¸­çš„åŠ¨æ€ä»£ç† Java ä¸­æä¾›äº†ä¸€ç§æ–¹å¼ä½¿æˆ‘ä»¬èƒ½å¤ŸåŠ¨æ€çš„ç”Ÿæˆä¸€ä¸ªç±»çš„ä»£ç†ï¼Œæˆ‘ä»¬æ¥çœ‹ä¸€ä¸ªä¾‹å­\npublic class DynamicProxyPlayground { public static void main(String[] args) { Map mapProxyInstance = (Map) Proxy .newProxyInstance(DynamicProxyPlayground.class.getClassLoader(), new Class[]{Map.class}, new TimingDynamicInvocationHandler(new HashMap\u0026lt;String, String\u0026gt;())); // DynamicProxyPlayground$TimingDynamicInvocationHandler invoke // INFO: Executing put finished in 74094 ns. mapProxyInstance.put(\u0026#34;hello\u0026#34;, \u0026#34;world\u0026#34;); CharSequence csProxyInstance = (CharSequence) Proxy.newProxyInstance( DynamicProxyPlayground.class.getClassLoader(), new Class[] { CharSequence.class }, new TimingDynamicInvocationHandler(\u0026#34;Hello World\u0026#34;)); // DynamicProxyPlayground$TimingDynamicInvocationHandler invoke // INFO: Executing length finished in 11720 ns. csProxyInstance.length(); } public static class TimingDynamicInvocationHandler implements InvocationHandler { private static Logger logger = Logger.getLogger(TimingDynamicInvocationHandler.class.getName()); private Object target; private TimingDynamicInvocationHandler(Object target) { this.target = target; } @Override public Object invoke(Object proxy, Method method, Object[] args) throws Throwable { long start = System.nanoTime(); Object result = method.invoke(target, args); long elapsed = System.nanoTime() - start; logger.info(String.format(\u0026#34;Executing %s finished in %d ns.\u0026#34;, method.getName(), elapsed)); return result; } } } åœ¨ä¸Šè¿°ä¾‹å­ä¸­ï¼Œé€šè¿‡å®ç°ä¸€ä¸ª InvocationHandlerï¼Œæˆ‘ä»¬å°±å¯ä»¥ä½¿ç”¨Proxy.newInstanceä¸ºä¸€æ‰¹ç±»åˆ›å»ºåŠŸèƒ½ç›¸åŒçš„åŠ¨æ€ä»£ç†ã€‚\n","date":"2017-07-29T22:44:24+08:00","permalink":"https://blog.crazyark.me/p/dynamic-proxy-java/","title":"Dynamic Proxy in Java"},{"content":"åˆ·leetcodeæ—¶ç¢°åˆ°çš„é—®é¢˜ï¼Œæœ¬ç¯‡ä»…åšç®€è¦æè¿°ï¼Œä»¥åŠè®°å½•æ€è€ƒã€‚\nå‚è€ƒè‡ª: https://gregable.com/2013/10/majority-vote-algorithm-find-majority.htmlï¼Œä¸€ç¯‡å†™çš„éå¸¸å¥½çš„åšå®¢\né—®é¢˜æè¿°ï¼šè€ƒè™‘ä½ æœ‰ä¸€ä¸ªé•¿åº¦ä¸ºnçš„æ— åºåˆ—è¡¨ï¼Œç°åœ¨ä½ æƒ³çŸ¥é“åˆ—è¡¨ä¸­æ˜¯å¦æœ‰ä¸€ä¸ªå€¼å æ®äº†åˆ—è¡¨çš„ä¸€åŠä»¥ä¸Š (majority)ï¼Œå¦‚æœæœ‰çš„è¯æ‰¾å‡ºè¿™ä¸ªæ•°ã€‚\nè¿™ä¸ªé—®é¢˜çš„ä¸€ä¸ªæ™®éçš„åº”ç”¨åœºæ™¯æ˜¯åœ¨å®¹é”™è®¡ç®— (fault-tolerant computing) ä¸­ï¼Œåœ¨è¿›è¡Œäº†å¤šæ¬¡å†—ä½™çš„è®¡ç®—åï¼Œè¾“å‡ºæœ€åå¤šæ•°è®¡ç®—å¾—åˆ°çš„å€¼ã€‚\næ˜¾è€Œæ˜“è§çš„åšæ³• å…ˆæ’åºï¼Œç„¶åéå†åˆ—è¡¨å¹¶è®¡æ•°å°±è¡Œã€‚è€—æ—¶ä¸º O(nlgn)ï¼Œä¸å¤Ÿå¿«ï¼å®é™…ä¸Šæˆ‘ä»¬å¯ä»¥åœ¨ O(n) çš„æ—¶é—´å†…ç»™å‡ºç»“æœã€‚\nBoyer-Moore Majority Algorithm è®ºæ–‡ä¾æ®ï¼šBoyer-Moore Majority Algorithm\nè¯¥ç®—æ³•æ—¶é—´å¼€é”€ä¸º O(2n), ç©ºé—´å¼€é”€ä¸º O(1)ï¼Œæ€»å…±éå†ä¸¤éåˆ—è¡¨ï¼Œæ€æƒ³éå¸¸ç®€å•ã€‚\næˆ‘ä»¬éœ€è¦ä»¥ä¸‹ä¸¤ä¸ªå€¼:\ncandidateï¼Œåˆå§‹åŒ–ä¸ºä»»æ„å€¼ countï¼Œåˆå§‹åŒ–ä¸º0 ç¬¬ä¸€ééå†ï¼Œä»¥ current ä»£è¡¨å½“å‰å€¼ï¼š\nIF count == 0, THEN candidate = current IF candiadate == current THEN count += 1 ELSE count -= 1 ç¬¬äºŒééå†ï¼Œå¯¹ä¸Šæ¬¡ç»“æœä¸­çš„ candidate è®¡æ•°ï¼Œè¶…è¿‡ä¸€åŠåˆ™å­˜åœ¨ majority ä¸º candidateï¼Œå¦åˆ™ä¸å­˜åœ¨\næ¥çœ‹ä¸€ä¸‹Pythonç‰ˆä»£ç å®ç°ï¼š\ndef boyer_moore_majority(input): candidate = 0 count = 0 for value in input: if count == 0: candidate = value if candidate == value count += 1 else: count -= 1 count = 0 for value in input: if candidate == value: count += 1 if count \u0026gt; len(input) / 2: return candidate else: return -1 # any value represents NOT FOUND ä¸€ä¸ªç®€å•çš„è¯æ˜ æˆ‘ä»¬åªéœ€è¦è€ƒè™‘åœ¨åŸåˆ—è¡¨ä¸­æœ‰ majority çš„æƒ…å†µï¼Œå› ä¸ºå¦‚æœæ²¡æœ‰ç¬¬äºŒééå†ä¼šç›´æ¥ rejectã€‚\næ‰€ä»¥å‡è®¾åˆ—è¡¨ L ä¸­å­˜åœ¨majorityï¼Œè®°ä¸º Mã€‚\nå¯ä»¥çœ‹åˆ°ï¼Œä¸Šé¢ candidate åœ¨ count ç­‰äº 0 çš„æ—¶å€™å˜æ›´ï¼Œå…¶å®å°†åˆ—è¡¨åˆ†æˆäº†ä¸€æ®µä¸€æ®µï¼Œæ¯ä¸€æ®µæœ‰ä¸€ä¸ª candidateã€‚\næ¯ä¸€æ®µæœ‰ä¸€ä¸ªé‡è¦çš„æ€§è´¨ï¼Œå³ candidate åœ¨è¿™ä¸€æ®µä¸­æ°å¥½å æ®äº†ä¸€åŠã€‚\næˆ‘ä»¬å½’çº³è¯æ˜ï¼šåœ¨æœ€åä¸€æ®µä¸­ candidate == M\né‚£ä¹ˆå½“æ‰«æåˆ°ç¬¬ä¸€æ®µSæ—¶ï¼Œæœ‰ä¸¤ç§æƒ…å†µï¼š\ncandidate == Mï¼Œé‚£ä¹ˆæ ¹æ® M æ˜¯ majorityï¼Œä»¥åŠæ ¹æ® count(M in S) = len(S) / 2ï¼Œåœ¨å­åˆ—è¡¨ L - S ä¸­ M è¿˜æ˜¯ majority candidate != Mï¼Œé‚£ä¹ˆ count(M in S) \u0026lt;= len(S) / 2, åŒä¸Šï¼ŒL - S ä¸­ M è¿˜æ˜¯ majority æœ€åä¸€æ®µå°±æ˜¯æœ€åä¸€ä¸ªå­åˆ—è¡¨ï¼Œæ‰€ä»¥ candidate == Mã€‚\næ›´å¿«æ›´å¥½ ğŸ˜ ä¸¤ééå†çš„ O(n) å·²ç»å¾ˆå¿«ï¼Œä½†æ˜¯å¤§å®¶è¿˜æ˜¯è§‰å¾—ä¸å¤Ÿå¿«ï¼Œäºæ˜¯\u0026hellip; O(3n / 2 -2) çš„ç®—æ³•è¯ç”Ÿäº†ã€‚\nè¿™ä¸ªç®—æ³•åªæ¯”è¾ƒ 3n/2 - 2 æ¬¡ï¼Œå·²ç»æ˜¯ç†è®ºä¸‹é™ã€‚ Here is the prover.Finding a majority among N votes\nè¿™ä¸ªç®—æ³•çš„åŸºæœ¬æƒ³æ³•æ˜¯ï¼šå°†åŸåˆ—è¡¨é‡æ–°æ’åˆ—ï¼Œä½¿å¾—æ²¡æœ‰ä¸¤ä¸ªç›¸é‚»çš„å€¼æ˜¯ç›¸åŒçš„ã€‚\nåœ¨è¿™é‡Œï¼Œæˆ‘ä»¬éœ€è¦ä¸€ä¸ªæ¡¶æ¥å­˜æ”¾é¢å¤–çš„å€¼ï¼Œæ‰€ä»¥ç©ºé—´æ¶ˆè€—ä¸º O(n)ï¼ŒåŒæ ·æ˜¯ä¸¤ééå†ã€‚\nç¬¬ä¸€ééå†ï¼Œcandidate ä¿æŒä¸ºåˆ—è¡¨çš„æœ€åä¸€ä¸ªå€¼ï¼Œcurrent ä¸ºå½“å‰å€¼\ncurrent == candidate, æŠŠ current æ”¾å…¥æ¡¶ä¸­ current != candidate, æŠŠ current æ”¾åˆ°åˆ—è¡¨çš„æœ€åï¼Œç„¶åä»æ¡¶ä¸­å–å‡ºä¸€ä¸ªæ”¾åˆ°åˆ—è¡¨æœ€å æ˜¾ç„¶åˆ—è¡¨ç›¸é‚»çš„ä¸¤ä¸ªç»ä¸å¯èƒ½ç›¸åŒ\nç¬¬äºŒééå†ä¸­ï¼Œæˆ‘ä»¬éœ€è¦å°† candidate ä¸æ–­çš„ä¸åˆ—è¡¨æœ€åä¸€ä¸ªå€¼æ¯”è¾ƒï¼š\nå¦‚æœç›¸åŒï¼Œä»åˆ—è¡¨æœ€åå»é™¤ä¸¤ä¸ªå…ƒç´  å¦åˆ™ï¼Œä»åˆ—è¡¨æœ€åå»é™¤ä¸€ä¸ªå…ƒç´ ï¼Œå¹¶ä»æ¡¶ä¸­å»é™¤ä¸€ä¸ªå…ƒç´  å¦‚æœæ¡¶ç©ºäº†ï¼Œé‚£ä¹ˆæ²¡æœ‰ majorityï¼Œå¦åˆ™ candidate å°±æ˜¯ majorityã€‚\nè¯æ˜ç•¥å»ï¼Œæœ‰å…´è¶£çš„åŒå­¦å¯ä»¥å‚è€ƒè®ºæ–‡ã€‚\nåˆ†å¸ƒå¼ Boyer-Moore æœ‰å…´è¶£çš„åŒå­¦å¯ä»¥é˜…è¯» Finding the Majority Element in Parallelã€‚\nä¸»è¦ç®—æ³•å¦‚ä¸‹ï¼š\ndef distributed_boyer_moore_majority(parallel_output): candidate = 0 count = 0 for candidate_i, count_i in parallel_output: if candidate_i = candidate: count += count_i else if count_i \u0026gt; count: count = count_i - count candidate = candidate_i else: count = count - count_i ... æ€»ç»“ åˆ· leetcode æ—¶é‡åˆ°çš„å¾ˆæœ‰æ„æ€çš„é¢˜ç›® https://leetcode.com/problems/majority-element-ii/tabs/descriptionï¼ŒçŸ¥é“è¿™ä¸ªç®—æ³•å°±éå¸¸å®¹æ˜“äº†ã€‚\n","date":"2017-07-28T21:08:02+08:00","permalink":"https://blog.crazyark.me/p/majority-voting/","title":"Boyer-Moore æŠ•ç¥¨ç®—æ³• (Boyer-Moore Majority Voting Algorithm)"},{"content":"ä»Šå¹´é˜¿é‡Œä¸­é—´ä»¶æ¯”èµ›çš„æ—¶å€™ä¸å·§åšä¸»å¿ƒæƒ…ä¸å¥½ï¼Œå¤–åŠ è¦å‡†å¤‡æœŸæœ«è€ƒè¯•ï¼Œå¹¶æ²¡æœ‰å‚åŠ ï¼Œéå¸¸é—æ†¾ã€‚ä¸è¿‡å¥½åœ¨å¥½åŸºå‹ Eric Fu å‚åŠ å¹¶è·å¾—äº†å† å†›ï¼ä»Šå¹´çš„ä¸»é¢˜æ˜¯åˆ†å¸ƒå¼æ•°æ®åº“ï¼Œå¦‚æœæƒ³äº†è§£è¯¦æƒ…åŠå¤èµ›çš„è§£é¢˜æ€è·¯è¯·è¯»è€…å‰å¾€ Eric çš„åšå®¢ã€‚\nåšä¸»æ²¡æœ‰å‚åŠ ç”šæ˜¯é—æ†¾ï¼Œå¤–åŠ çœ‹åˆ°é¢˜ç›®æ‰‹ç—’éš¾è€ï¼Œé‚é—®åŸºå‹è®¨äº†æœ€åçš„24hæå®¢èµ›æ¥ç©ä¸€ç©ã€‚\n24h TOPKN é¢˜ç›®æ˜¯åˆ†å¸ƒå¼æ•°æ®åº“ä¸Šçš„åˆ†é¡µæ’åºï¼Œå¯¹åº”çš„SQLæ‰§è¡Œä¸º order by id limit kï¼Œnï¼›ä¸»è¦çš„æŠ€æœ¯æŒ‘æˆ˜ä¸º\u0026quot;åˆ†å¸ƒå¼\u0026quot;çš„ç­–ç•¥ï¼Œèµ›é¢˜ä¸­ä½¿ç”¨å¤šä¸ªæ–‡ä»¶æ¨¡æ‹Ÿå¤šä¸ªæ•°æ®åˆ†ç‰‡ã€‚\nç®€ç§° top(k, n)ã€‚\nç»™å®šä¸€æ‰¹æ•°æ®ï¼Œæ±‚è§£æŒ‰é¡ºåºä»å°åˆ°å¤§ï¼Œé¡ºåºæ’åä»ç¬¬kä¸‹æ ‡åºå·ä¹‹åè¿ç»­çš„nä¸ªæ•°æ® (ç±»ä¼¼äºæ•°æ®åº“çš„order by asc + limit k,nè¯­ä¹‰)\ntop(k,3)ä»£è¡¨è·å–æ’ååºå·ä¸ºk+1,k+2,k+3çš„å†…å®¹,ä¾‹:top(10,3)ä»£è¡¨åºå·ä¸º11ã€12ã€13çš„å†…å®¹,top(0,3)ä»£è¡¨åºå·ä¸º1ã€2ã€3çš„å†…å®¹ éœ€è¦è€ƒè™‘kå€¼å‡ ç§æƒ…å†µï¼Œkå€¼æ¯”è¾ƒå°æˆ–è€…ç‰¹åˆ«å¤§çš„æƒ…å†µï¼Œæ¯”å¦‚k=1,000,000,000 å¯¹åº”k,nå–å€¼èŒƒå›´ï¼š 0 \u0026lt;= k \u0026lt; 2^63 å’Œ 0 \u0026lt; n \u0026lt; 100 æ•°æ®å…¨éƒ¨æ˜¯æ–‡æœ¬å’Œæ•°å­—ç»“åˆçš„æ•°æ®ï¼Œæ’åºçš„æ—¶å€™æŒ‰ç…§æ•´ä¸ªå­—ç¬¦ä¸²çš„é•¿åº¦æ¥æ’åºã€‚ä¾‹å¦‚ä¸€ä¸ªæœ‰åºçš„æ’åºå¦‚ä¸‹(ç›¸åŒé•¿åº¦æƒ…å†µä¸‹asciiç å°çš„æ’åœ¨å‰é¢)ï¼š ä¾‹ï¼š a ab abc def abc123\nä¾‹å¦‚ç»™å®šçš„k,nä¸º(2,2)ï¼Œåˆ™ä¸Šé¢çš„æ•°æ®éœ€è¦çš„ç­”æ¡ˆä¸º: abc def\nåŸé¢˜ç›®åœ¨ https://code.aliyun.com/wanshao/topkn_finalã€‚\nè¦æ±‚åœ¨24å°æ—¶å†…å®Œæˆï¼Œç„¶è€Œ \u0026hellip;\nCodes æ‰˜ç®¡åœ¨ github ä¸Š https://github.com/arkbriar/topKNï¼Œè¿™ä¸ªç‰ˆæœ¬ä»åŸºå‹çš„ç‰ˆæœ¬è½»åº¦ä¿®æ”¹è€Œæ¥ \u0026hellip;\nè§£é¢˜è¿‡ç¨‹ ä¸»è¦æ¡ä»¶ ä¸»è¦é™åˆ¶ 1. 3å°æœºå™¨: 2å°workerï¼Œ1å°master 2. è¾“å‡ºåœ¨masterä¸Š 1. Timeout: 5min 2. JVM heap size: 3G 3. ä¸å…è®¸ä½¿ç”¨å †å¤–å†…å­˜(FileChannel) å¦‚æœè¦å¯¹160000000æ¡æ•°æ®å…¨æ’åºJVMï¼Œç¬¬ä¸€å†…å­˜å¤ªå°ï¼Œç¬¬äºŒæ—¶é—´ä¸å¤Ÿã€‚å¯¹ 10000000 æ¡æ•°æ®è¿›è¡Œæ’åºå¤§çº¦è€—æ—¶ä¸º 1min13sï¼Œå‚è€ƒè‡ª https://codereview.stackexchange.com/questions/67387/quicksort-implementation-seems-too-slow-with-large-dataï¼›å¦‚æœè¦è¿›è¡Œå¤–æ’åºï¼Œç£ç›˜è¯»å†™å¯¼è‡´è€—æ—¶æ›´é•¿ï¼›ä»¥åŠè¿˜æœ‰æœ€åè¦è¾“å‡ºåˆ°masterä¸Šï¼Œè¿˜æœ‰ç½‘ç»œå¼€é”€ã€‚\nç¨å¾®äº†è§£ä¸€äº›æ•°æ®åº“çš„åŒå­¦éƒ½çŸ¥é“ï¼Œæ•°æ®åº“é‡Œæœ‰ä¸ªå«ç´¢å¼•(Index)çš„ä¸œè¥¿ï¼Œæ˜¯ç”¨æ¥åŠ é€ŸæŸ¥è¯¢çš„ã€‚é‚£æˆ‘ä»¬é¦–å…ˆæ¥çœ‹ä¸€ä¸‹ MySQL çš„ç´¢å¼•ã€‚\nMySQL çš„ç´¢å¼• ç´¢å¼•å¯¹æŸ¥è¯¢çš„é€Ÿåº¦æœ‰è‡³å…³é‡è¦çš„å½±å“ï¼Œç†è§£ç´¢å¼•ä¹Ÿæ˜¯è¿›è¡Œæ•°æ®åº“æ€§èƒ½è°ƒä¼˜çš„èµ·ç‚¹ã€‚å‡è®¾æ•°æ®åº“ä¸­ä¸€ä¸ªè¡¨æœ‰100000æ¡è®°å½•ï¼ŒDBMSçš„é¡µé¢å¤§å°ä¸º4Kï¼Œå¹¶å­˜å‚¨100æ¡è®°å½•ã€‚å¦‚æœæ²¡æœ‰ç´¢å¼•ï¼ŒæŸ¥è¯¢å°†å¯¹æ•´ä¸ªè¡¨è¿›è¡Œæ‰«æï¼Œæœ€åçš„æƒ…å†µä¸‹ï¼Œå¦‚æœæ‰€æœ‰æ•°æ®é¡µéƒ½ä¸åœ¨å†…å­˜ï¼Œéœ€è¦è¯»å–10000ä¸ªé¡µé¢ï¼Œå¦‚æœè¿™10000ä¸ªé¡µé¢åœ¨ç£ç›˜ä¸Šéšæœºåˆ†å¸ƒï¼Œéœ€è¦è¿›è¡Œ10000æ¬¡I/Oï¼Œå‡è®¾ç£ç›˜æ¯æ¬¡I/Oæ—¶é—´ä¸º10msï¼Œåˆ™æ€»å…±éœ€è¦100s(å®é™…è¿œä¸æ­¢)ã€‚ä½†æ˜¯å¦‚æœå»ºç«‹ B+ æ ‘ç´¢å¼•ï¼Œåˆ™åªéœ€è¦è¿›è¡Œ $log_{100}1000000 = 3$ æ¬¡é¡µé¢è¯»å–ï¼Œæœ€åæƒ…å†µä¸‹è€—æ—¶30msï¼Œè¿™å°±æ˜¯ç´¢å¼•å¸¦æ¥çš„æ•ˆæœã€‚\nMySQL æœ‰ä¸¤ç§ç´¢å¼•çš„ç±»å‹ï¼šB+æ ‘å’ŒHashç´¢å¼•ã€‚\nå‚è€ƒè‡ª http://www.cnblogs.com/hustcat/archive/2009/10/28/1591648.html\nB/B+ æ ‘ æˆ‘ä»¬éƒ½çŸ¥é“RB-Treeå’ŒAVL-Treeæ˜¯éƒ½æ˜¯è‡ªå¹³è¡¡çš„äºŒå‰æŸ¥æ‰¾æ ‘ï¼Œåœ¨è¿™æ ·çš„æ ‘ä¸Šè¿›è¡Œæ’å…¥ï¼Œåˆ é™¤å’ŒæŸ¥è¯¢æ“ä½œæœ€åæƒ…å†µéƒ½èƒ½åœ¨ $O(log_{2}n)$ çš„æ—¶é—´å†…å®Œæˆã€‚\nBæ ‘æ˜¯1972å¹´ç”± Rudolf Bayer å’Œ Edward M.McCreight æå‡ºçš„ï¼Œå®ƒæ˜¯ä¸€ç§æ³›åŒ–çš„è‡ªå¹³è¡¡æ ‘ï¼Œæ¯ä¸ªèŠ‚ç‚¹å¯ä»¥æœ‰å¤šäºä¸¤ä¸ªçš„å­èŠ‚ç‚¹ã€‚ä¸è‡ªå¹³è¡¡äºŒå‰æŸ¥æ‰¾æ ‘ä¸åŒçš„æ˜¯ï¼ŒBæ ‘ä¸ºç³»ç»Ÿå¤§å—æ•°æ®çš„è¯»å†™æ“ä½œåšäº†ä¼˜åŒ–ã€‚Bæ ‘å‡å°‘å®šä½è®°å½•æ—¶æ‰€ç»å†çš„ä¸­é—´è¿‡ç¨‹ï¼Œä»è€ŒåŠ å¿«å­˜å–é€Ÿåº¦ã€‚æ‰€ä»¥Bæ ‘å¸¸è¢«åº”ç”¨äºæ•°æ®åº“å’Œæ–‡ä»¶ç³»ç»Ÿçš„å®ç°ã€‚\nå‡è®¾Bæ ‘æ¯ä¸ªèŠ‚ç‚¹ä¸‹æœ‰bä¸ªå­èŠ‚ç‚¹(bä¸ªåˆ†å—)ï¼Œé‚£ä¹ˆæŸ¥æ‰¾å¯ä»¥åœ¨çº¦ä¸ºlogbNçš„ç£ç›˜è¯»å–å¼€é”€ä¸‹å®Œæˆã€‚\nå…³äº B/B+ æ ‘çš„å…¶ä»–ç‰¹å¾åœ¨ç»´åŸºå’Œå…¶ä»–èµ„æ–™ä¸Šæœ‰è¯¦ç»†è®²è§£ï¼Œåœ¨æ­¤ä¸å†èµ˜è¿°ã€‚\nç”±äºæ—¶é—´é™å®šçš„ç¼˜æ•…ï¼Œå®ç° B/B+ æ ‘çš„ç´¢å¼•æ˜¾å¾—ä¸å¤ªç°å®ï¼Œæ‰€ä»¥æˆ‘ä»¬å°†è€ƒè™‘ä¸€ç§é€€åŒ–çš„æ–¹å¼ â€”â€” æ¡¶æ’åºã€‚\nå‚è€ƒè‡ª\nhttps://zh.wikipedia.org/wiki/B%E6%A0%91 https://zh.wikipedia.org/wiki/B%2B%E6%A0%91 æ¡¶æ’åº å…ˆæ¥çœ‹ä¸€ä¸‹æ•°æ®çš„åˆ†å¸ƒæƒ…å†µï¼š\næ¯ä¸€è¡Œå­—ç¬¦ä¸²çš„é•¿åº¦ä¸º [1,128] ï¼ˆæ•°å­—åœ¨Longå€¼èŒƒå›´å†…å‡åŒ€åˆ†å¸ƒï¼‰\næ˜¾ç„¶ä»¥å­—ç¬¦ä¸²é•¿æ¥æ ‡è¯†æ¡¶æ˜¯å¯è¡Œçš„ï¼Œä½†æ˜¯æˆ‘ä»¬æœ‰160000000æ¡å­—ç¬¦ä¸²ï¼Œ128ä¸ªæ¡¶æ¯ä¸ªæ¡¶è¿˜æ˜¯æœ‰1250000æ¡ï¼Œè¿™æ ·çš„æ¡¶ç²’åº¦è¿˜æ˜¯å¤ªç²—ã€‚\nç”±äºæˆ‘ä»¬æ‰‹é‡Œæ²¡æœ‰å…¶ä»–åˆ†å¸ƒæƒ…å†µï¼Œä»¥åŠå­—ç¬¦ä¸²å¤§å°åœ¨åŒé•¿åº¦ä¸‹æ˜¯å­—å…¸åºï¼Œæ‰€ä»¥ä»¥å­—ç¬¦ä¸²é•¿åº¦+å‰2-3ä¸ªå­—ç¬¦ä½œä¸ºæ¡¶çš„æ ‡è¯†å°±å¯ä»¥äº†ã€‚\nåœ¨æœ¬é¢˜ä¸­ï¼Œç”±äºåªè¿›è¡Œ5è½®queryï¼Œå¹¶ä¸”å†™å¼€é”€éå¸¸å¤§ï¼Œæ•…ä»…å¯¹æ¡¶å†…å­—ç¬¦ä¸²çš„æ•°ç›®è¿›è¡Œç»Ÿè®¡ã€‚\nåŸºæœ¬æ€è·¯ Worker åˆ†åˆ«æ‰«æå¹¶å»ºç«‹æ‰€æœ‰æ¡¶çš„è®¡æ•° Master æ±‡æ€»æ‰€æœ‰æ¡¶ï¼Œå¹¶å»ºç«‹å…¨å±€æ¡¶ Master é€šè¿‡äºŒåˆ†æŸ¥æ‰¾ï¼Œæ‰¾åˆ°(k, n)æ‰€åœ¨çš„å‡ ä¸ªæ¡¶ Master å‘ Worker è¯·æ±‚è·å¾—è¿™äº›æ¡¶å†…çš„æ‰€æœ‰å­—ç¬¦ä¸² Master å¯¹è¿™äº›å­—ç¬¦ä¸²è¿›è¡Œæ’åºï¼Œå¹¶è¾“å‡ºæœ€ç»ˆç»“æœ å®ç°è¿‡ç¨‹ æœ¬é¢˜å®ç°çš„æœ€å¤§éš¾ç‚¹åœ¨äº I/O å’Œ GC è°ƒä¼˜ï¼Œè¿˜æœ‰å……åˆ†è°ƒåŠ¨ CPUã€‚\nGC è°ƒä¼˜æˆ‘ä»¬é€šè¿‡ä½¿ç”¨å›ºå®šçš„ buffer æ¥è¿›è¡Œæ“ä½œï¼ŒåŸºæœ¬é¿å…å‡ºç° GCã€‚ é€šè¿‡å¤šçº¿ç¨‹å¤„ç†æ¥ä¿è¯ CPU è°ƒåŠ¨ã€‚ ç½‘ç»œå¼€é”€åœ¨ä¸Šè¿°ç®—æ³•ä¸‹åŸºæœ¬å¿½ç•¥äº† ç„¶è€Œï¼Œå‰©ä¸‹çš„ I/O è°ƒä¼˜è®©äººéå¸¸å¤´å¤§ï¼Œå¹¶ä¼´éšç€å¯èƒ½å­˜åœ¨çš„åŒæ­¥é—®é¢˜ (è¯»å’Œå¤„ç†)\næˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹ç¡¬ä»¶æ¡ä»¶ï¼š\nCPU: 24 core, 2.2GHz å†…å­˜: 3G heap memory æ•°æ®ç£ç›˜ï¼šå†…å­˜æ–‡ä»¶ç³»ç»Ÿ ä¸´æ—¶ã€ç»“æœç£ç›˜ï¼šSSD Top 1 çš„æœ€ç»ˆç»“æœ ä»åŸºå‹é‚£å¾—çŸ¥ï¼Œtop 1 çš„å®ç°5è½®æ€»è€—æ—¶(JVMå¯åŠ¨ã€æš‚åœï¼Œä»¥åŠè®¡ç®—)å…±11så¤šï¼Œç”¨æ¥æ¨ç®—è‡ªå·±ç¦»æœ€ä¼˜è¿˜æœ‰å¤šè¿œã€‚\n(æˆ‘å®åœ¨æ²¡æƒ³é€šç¬¬ä¸€åæ€ä¹ˆè·‘åˆ°11sçš„ï¼Œå¤§æ¦‚æ˜¯æˆ‘å†…å­˜æ–‡ä»¶ç³»ç»Ÿå¼€çš„ä¸å¯¹ï¼Ÿ)\nä¸ç¨³å®šçš„I/Oå®ç° æ¯ä¸ªæ–‡ä»¶å•çº¿ç¨‹è¯»ï¼Œå›ºå®š4çº¿ç¨‹å¤„ç†ï¼Œé€šè¿‡é¢„å…ˆåˆ†é…çš„ buffer é¿å…å‡ºç° GCã€‚\nå°è£…æ–‡ä»¶æ“ä½œå¹¶è¡Œï¼Œ5ä¸ªæ–‡ä»¶å¹¶è¡Œæ€»å…±å ç”¨ 25 coreã€‚\nå®ç°ä¸‹æ¥ç”±äºè¯»å’Œæ“ä½œæ— æ³•æœ‰æ•ˆå¹³è¡¡ï¼Œå¾ˆéš¾åšåˆ°è¯»å®Œå°±æ“ä½œï¼Œå¤§é‡æ—¶é—´èŠ±è´¹åœ¨ç­‰å¾…è¯»çº¿ç¨‹æ–°äº§å‡ºä¸€ä¸ªbufferæˆ–æ˜¯å¤„ç†çº¿ç¨‹å¤„ç†å®Œä¸€ä¸ªbufferã€‚\nåœ¨æ¸…ç†ç³»ç»Ÿcacheçš„æƒ…å†µä¸‹ï¼Œå¤§çº¦8så¤„ç†å®Œæ‰€æœ‰å­—ç¬¦ä¸²ï¼Œä¸æ¸…ç†å¤§çº¦ä¸º4sã€‚\nè¿™ç§å®ç°æ— æ³•è°ƒä¼˜ï¼Œç­‰å¾…çš„æ—¶é—´å®Œå…¨çœ‹ OS å¿ƒæƒ…ã€‚\nç¨³å®šçš„I/Oå®ç° å…¶å®ä¹‹å‰æåˆ°è¿‡ï¼Œå•çº¿ç¨‹è¯»å¹¶ä¸æ˜¯ä¸€ä¸ªå¾ˆå¥½çš„æ€è·¯ï¼Œè€Œä¸”ä¸Šè¿°çš„å¤„ç†æ¶æ„å­˜åœ¨ç€ä¸ç¨³å®šçš„ç­‰å¾…é—®é¢˜ã€‚\né‚£ä¹ˆå¦‚ä½•ä½¿å¾—åœ¨ä¿æŒå¤šçº¿ç¨‹è¯»çš„åŒæ—¶èƒ½å¤Ÿå¤šçº¿ç¨‹å¤„ç†ï¼Œå¹¶ä¸”ä¸æµªè´¹æ—¶é—´åœ¨ç­‰å¾…ä¸Šå‘¢ï¼Ÿ\nç­”æ¡ˆæ˜¯æ¯ä¸€ä¸ªçº¿ç¨‹åœ¨è¯»å®Œä¸€ä»½æ•°æ®åï¼Œç›´æ¥è¿›è¡Œå¤„ç†ï¼Œç„¶åè¯»å–ä¸‹ä¸€ä»½ã€‚\nä½†æ˜¯å¦‚ä½•å®‰æ’æ¯ä¸€ä¸ªçº¿ç¨‹çš„é‚£ä»½æ•°æ®ï¼Œä¿è¯çº¿ç¨‹ä¹‹é—´ä¸ä¼šæœ‰é‡å¤è¯»å–ï¼Œä¹Ÿä¸ä¼šæœ‰æ¼è¯»çš„æ•°æ®å—ï¼Ÿ\nè¿™é‡Œé‡‡ç”¨ Eric åœ¨å¤èµ›é‡Œçš„å®ç°: FileSegment, é€šè¿‡å°†ä¸€ä¸ªæ–‡ä»¶åˆ†å‰²ä¸ºä¸€ä¸ªä¸€ä¸ª Segmentï¼Œè®©æ¯ä¸€ä¸ªçº¿ç¨‹è‡ªå·±è¯·æ±‚ä¸‹ä¸€ä¸ª Segmentï¼Œå¹¶é€šè¿‡ RandomAccessFile è¿›è¡Œè¯»å–ã€‚(ç”±äºä¸è®¸ç”¨ FileChannel)\npublic class FileSegment { private File file; private long offset; private long size; ... } public abstract class BufferedFileSegmentReadProcessor implements Runnable { private final int bufferMargin = 1024; private FileSegmentLoader fileSegmentLoader; private int bufferSize; private byte[] readBuffer; // Here bufferSize must be greater than segments\u0026#39; size got from fileSegmentLoader, // otherwise segment will not be fully read/processed! public BufferedFileSegmentReadProcessor(FileSegmentLoader fileSegmentLoader, int bufferSize) { this.bufferSize = bufferSize; this.fileSegmentLoader = fileSegmentLoader; } private int readSegment(FileSegment segment, byte[] readBuffer) throws IOException { int limit = 0; try (RandomAccessFile randomAccessFile = new RandomAccessFile(segment.getFile(), \u0026#34;r\u0026#34;)) { randomAccessFile.seek(segment.getOffset()); limit = randomAccessFile.read(readBuffer, 0, readBuffer.length); } return limit; } protected abstract void processSegment(FileSegment segment, byte[] readBuffer, int limit); @Override public void run() { readBuffer = new byte[bufferSize + bufferMargin]; try { FileSegment segment; while ((segment = fileSegmentLoader.nextFileSegment()) != null) { int limit = readSegment(segment, readBuffer); processSegment(segment, readBuffer, limit); } } catch (IOException e) { e.printStackTrace(); } } } è¿™æ ·æ¯ä¸€ä¸ªçº¿ç¨‹éƒ½åœ¨è¯»å’Œå¤„ç†ä¹‹é—´å¾ªç¯ï¼Œå…ˆå®Œæˆçš„çº¿ç¨‹ä¼šè¯·æ±‚ä¸‹ä¸€ä¸ª Segmentï¼Œä¿è¯ä»¥æœ€çŸ­çš„æ—¶é—´å®Œæˆè°ƒç”¨æ‰€æœ‰ Core è¿›è¡Œä¸€éæ•°æ®å¤„ç†ã€‚\nè¿™ä¸ªæ–¹æ³•ä¿è¯èƒ½å¤Ÿååˆ†ç¨³å®šçš„è¿›è¡Œè¯»å–å’Œå¤„ç†ï¼Œå¹¶ä¸”ä¸éœ€è¦ç­‰å¾… Reader å’Œ Processor é€šä¿¡ï¼Œåœ¨æˆ‘çš„å®éªŒç¯å¢ƒä¸­åŸºæœ¬å­˜ç€cache 3-4sèƒ½æ‰«æä¸€éï¼Œæ¸…ç†cacheä¹Ÿåœ¨ 7-8sã€‚\nå…¶å®åˆ°è¿™é‡Œæœ¬é¢˜å·²ç»å·®ä¸å¤šäº†ï¼Œæˆ‘è®°å¾— Eric åœ¨è¿™ç§å¤„ç†ä¸‹æ¯”èµ›çš„æœ€ç»ˆç»“æœæ˜¯ 14s å¤šã€‚\nTop 1 çš„ä¼˜åŒ– åœ¨å»ºç«‹æ¡¶çš„æ—¶å€™ï¼ŒåŒæ—¶å°†æ¯ä¸ªæ–‡ä»¶ä¸Šç¬¬iæ¡å­—ç¬¦ä¸²å¯¹åº”çš„offsetã€æ¡¶åºå·å­˜å…¥ä¸¤ä¸ªæ•°ç»„ï¼Œå¹¶å°†æ¡¶ä¿¡æ¯ä»¥åŠè¿™ä¸¤ä¸ªæ•°ç»„ä¸€èµ·å­˜å‚¨åˆ°æœ¬åœ°ï¼Œè¿™æ ·æ„æˆäº†ä¸€ä¸ªå¯ä»¥å¿«é€ŸæŸ¥è¯¢æ¡¶å†…æ‰€æœ‰å­—ç¬¦ä¸²çš„ç´¢å¼• è¿™äº›ä¿¡æ¯æ€»è®¡å¤§çº¦ 1G å·¦å³ï¼Œé€šè¿‡å»ºç«‹è¿™æ ·çš„ç´¢å¼•ï¼Œæ¯æ¬¡ä»…è®²ç´¢å¼•ä¿¡æ¯è¯»å…¥ï¼Œå¹¶è¿›è¡Œæœ‰é™æ¬¡çš„è¯»å–ï¼Œå°±å¯ä»¥è·å–åˆ°æ‰€æœ‰éœ€è¦çš„å­—ç¬¦ä¸² å¯¹æ¯”ä¹‹ä¸‹ï¼Œä¹‹å‰çš„æ–¹å¼æ˜¯ä»å†…å­˜æ–‡ä»¶ç³»ç»Ÿè¯»å–5Gçš„æ–‡ä»¶ï¼Œç°åœ¨æ˜¯ä»SSDè¯»å–1Gå·¦å³æ–‡ä»¶ï¼Œåªè¦å¹¶å‘è¯»é€Ÿåº¦å·®è·ä¸åœ¨5å€ä»¥ä¸Šï¼Œè¿™æ ·çš„ä¼˜åŒ–æ˜¯èƒ½èŠ‚çœä¸å°‘æ—¶é—´ï¼\næµ‹è¯• ä»…æµ‹è¯•äº†å»º Index\næ¸…ç† cache $ sysctl -w vm.drop_caches=3 vm.drop_caches = 3 $ time java ${JAVA_OPTS} -cp /exp/topkn/topkn.jar com.alibaba.middleware.topkn.TopknWorker localhost 5527 . [2017-07-27 14:24:27.512] INFO com.alibaba.middleware.topkn.TopknWorker Connecting to master at localhost:5527 [2017-07-27 14:24:27.519] INFO com.alibaba.middleware.topkn.TopknWorker Building index ... 0.673: [GC (Allocation Failure) 0.673: [ParNew: 809135K-\u0026gt;99738K(943744K), 0.1759305 secs] 809135K-\u0026gt;542134K(3040896K), 0.1761763 secs] [Times: user=3.15 sys=0.69, real=0.17 secs] [2017-07-27 14:24:32.330] INFO com.alibaba.middleware.topkn.TopknWorker Index built. Heap par new generation total 943744K, used 903716K [0x0000000700000000, 0x0000000740000000, 0x0000000740000000) eden space 838912K, 95% used [0x0000000700000000, 0x00000007311225e0, 0x0000000733340000) from space 104832K, 95% used [0x00000007399a0000, 0x000000073fb06b38, 0x0000000740000000) to space 104832K, 0% used [0x0000000733340000, 0x0000000733340000, 0x00000007399a0000) concurrent mark-sweep generation total 2097152K, used 442395K [0x0000000740000000, 0x00000007c0000000, 0x00000007c0000000) Metaspace used 3980K, capacity 4638K, committed 4864K, reserved 1056768K class space used 434K, capacity 462K, committed 512K, reserved 1048576K real 0m5.238s user 1m11.980s sys 0m26.324s ä¸æ¸…ç† cache $ time java ${JAVA_OPTS} -cp /exp/topkn/topkn.jar com.alibaba.middleware.topkn.TopknWorker localhost 5527 . [2017-07-27 14:25:39.986] INFO com.alibaba.middleware.topkn.TopknWorker Connecting to master at localhost:5527 [2017-07-27 14:25:39.992] INFO com.alibaba.middleware.topkn.TopknWorker Building index ... 0.590: [GC (Allocation Failure) 0.590: [ParNew: 838912K-\u0026gt;99751K(943744K), 0.1851592 secs] 838912K-\u0026gt;591302K(3040896K), 0.1855308 secs] [Times: user=3.03 sys=0.88, real=0.19 secs] [2017-07-27 14:25:44.449] INFO com.alibaba.middleware.topkn.TopknWorker Index built. Heap par new generation total 943744K, used 863664K [0x0000000700000000, 0x0000000740000000, 0x0000000740000000) eden space 838912K, 91% used [0x0000000700000000, 0x000000072ea02318, 0x0000000733340000) from space 104832K, 95% used [0x00000007399a0000, 0x000000073fb09e00, 0x0000000740000000) to space 104832K, 0% used [0x0000000733340000, 0x0000000733340000, 0x00000007399a0000) concurrent mark-sweep generation total 2097152K, used 491550K [0x0000000740000000, 0x00000007c0000000, 0x00000007c0000000) Metaspace used 3980K, capacity 4638K, committed 4864K, reserved 1056768K class space used 434K, capacity 462K, committed 512K, reserved 1048576K real 0m4.754s user 0m57.144s sys 0m30.568s UPDATE\nåœ¨æˆ‘çš„8æ ¸å°ç‰©ç†æœºä¸Šï¼Œè·‘ä¸€è¾¹å†…å­˜æ–‡ä»¶ç³»ç»Ÿé‡Œçš„æ•°æ®ä¸è¦1s\u0026hellip; çœ‹æ¥æ˜¯æœºå™¨çš„é—®é¢˜ï¼Œäº‘æœåŠ¡å™¨è¿˜æ˜¯ä¸ç»™åŠ›å•Š ğŸ¤£\næ€»ç»“ ä»Šå¹´çš„ä¸­é—´ä»¶æ¯”èµ›æ˜¯åœ¨å¾ˆæœ‰æ„æ€ï¼Œè¿™ä¸ªé¢˜ç›®å¯¹å‚èµ›é€‰æ‰‹æœ‰æ¯”è¾ƒé«˜çš„è¦æ±‚ï¼Œè§£é¢˜ä¸­æ¶‰åŠåˆ°å¤šçº¿ç¨‹å¹¶å‘è¯»å†™ã€åˆ†å¸ƒå¼æ’åºã€ç´¢å¼•ã€Socketç¼–ç¨‹ã€JVM è°ƒä¼˜ç­‰å¤šä¸ªæ–¹é¢ï¼Œæˆ‘è¿™ç§ä¸Šæ¥ç›´æ¥æŒ‘çš„æœæ–­æŒ‚äº†ä¸¤ä¸ªç‰ˆæœ¬çš„ä»£ç ï¼Œä¸œçœ‹è¥¿çœ‹å·¦é—®å³é—®ç»ˆäºæŠŠæœ€ç»ˆå½¢å¼ç»™å¼„æ¸…æ¥šäº†ã€‚\nè¯´æ˜¯æˆ‘åšçš„ä¸å¦‚è¯´æ˜¯æˆ‘åœ¨å­¦å¦‚ä½•åšï¼Œåœ¨æ­¤è¿‡ç¨‹ä¸­å‘ç°äº†å¾ˆå¤šæœ‰æ„ä¹‰çš„æŠ€æœ¯ç‚¹ï¼Œæ­£å‡†å¤‡æ¥ä¸‹æ¥ç»§ç»­å­¦ä¹ ã€‚\n","date":"2017-07-26T16:59:26+08:00","permalink":"https://blog.crazyark.me/p/awrace-topkn/","title":"2017 Alibaba Middleware 24h Final (Just for Fun ğŸ˜€)"}]